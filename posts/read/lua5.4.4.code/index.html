<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Lua5.4.4源码].指令集 | frog&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="lua源码指令集分析">
<meta name="author" content="
作者:&nbsp;frog">
<link rel="canonical" href="https://frog-game.github.io/posts/read/lua5.4.4.code/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8b75bf56d6fb0c429b5f3ce03bce19c9ef1e90cc024b64bd12ec321c68cca894.css" integrity="sha256-i3W/Vtb7DEKbXzzgO84Zye8ekMwCS2S9EuwyHGjMqJQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://frog-game.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="mask-icon" href="https://frog-game.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="[Lua5.4.4源码].指令集" />
<meta property="og:description" content="lua源码指令集分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://frog-game.github.io/posts/read/lua5.4.4.code/" />
<meta property="og:image" content="https://frog-game.github.io/posts/read/lua5.4.4.code/image-20230223204632470.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-28T01:30:29&#43;08:00" />
<meta property="article:modified_time" content="2023-02-28T01:30:29&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://frog-game.github.io/posts/read/lua5.4.4.code/image-20230223204632470.png" />
<meta name="twitter:title" content="[Lua5.4.4源码].指令集"/>
<meta name="twitter:description" content="lua源码指令集分析"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "https://frog-game.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📕 阅读",
      "item": "https://frog-game.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "[Lua5.4.4源码].指令集",
      "item": "https://frog-game.github.io/posts/read/lua5.4.4.code/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Lua5.4.4源码].指令集",
  "name": "[Lua5.4.4源码].指令集",
  "description": "lua源码指令集分析",
  "keywords": [
    ""
  ],
  "articleBody": "指令集简介 Lua虚拟机采用定长指令,每条指令占4个字节\nLua 5.4将操作码扩展到了第7位总共能够容纳128条指令,现在定义了83条\n操作数编码模式一共5中 enum OpMode {iABC, iABx, iAsBx, iAx, isJ}; 符号 作用 i instruction 指令的意思 A 指令1参数 一般用作目标寄存器索引 B 指令2参数 既可以是寄存器索引,也可以是常量池索引 C 指令3参数 既可以是寄存器索引,也可以是常量池索引 k 一bit标志位 比如 标志位k为1表示常量池索引,否则表示寄存器索引 x extended 扩展的意思 s signed 符号 该参数应该被解释为有符号整数 sJ 表示跳转的PC偏移量 sBx sbx表示的是一个有符号的数,也就是sbx可以是负数 bx bx是一个无符号整数 Ax 做参数扩展使用,只能和别的指令搭配使用,比如LOADKX指令 基于CPU寄存器架构\n从上面我们可以看出这些寄存器组件是和CPU捆绑在一块的,所以跨平台和兼容性就很差,但是因为是直接在CPU上直接对数据进行运算,所以速度很快\nLua虚拟机栈\n从上图中我们能看出Lua的寄存器是基于虚拟机的,但是这些寄存器和CPU寄存器是不一样的东西和CPU是没有任何关联,如果有关联的话,因为CPU的每个平台使用的架构不一样,会导致Lua失去移植和兼容性,所以Lua使用了一个栈来保存这些寄存器,同时每一个运行的函数都有自己的活动数据,单独的寄存器数量,同时在Lua5.4.4中也规定了每个函数最大的寄存器个数是255个\n也可以看出我们的指令其实都是存在了Proto结构体里面的code字段\n由于Lua有如此大量的寄存器,所以在预编译时能够将所有的局部变量存放到寄存器中,因为寄存器数据是在栈中,upvalue变量存放在链表中,global变量存放在全局的表中也可以说是在env表中\n效率从大到小:local \u003e upvalue \u003e global\n所以一般都会使用如下面的定义方式来提高效率,毕竟这样做省去调用时再去全局表中,上值链表中查找的开销,同时生成的指令也会减少很多\nlocal sin = math.sin local table_remove_f = table_t.remove local table_insert_f = table_t.insert local table_unpack_f = table_t.unpack 看指令前的一些符号解释 符号 解释 R(x) 一定是寄存器索引 一定会访问Lua栈 Kst(x) 一定是常量索引 一定会访问常量表 RK(x) 可能是常量索引也有可能是寄存器索引,取决于索引k的类型 立即数 立即数就是写在指令里的常数.用CPU架构下的mov指令举例子,mov 12, %rax\n那么这个 12 就在操作语句里.那么 12 相当于指令里的立即数,\nlua中的指令也类似,直接从指令参数中加载的整数和浮点数就是立即数 PC 程序指令计数器,主要是为了计算指令的相对位置用的 Upvalue[n] 下标索引为n的上值 iABC操作数模式 首先这个指令和lua5.4版本之前的lua表达方式不一样,lua5.4使用k位来表示B,C两位到底是寄存器索引[其实就是栈索引],还是常量池索引\nk:1表示常量池索引 0表示寄存器索引 B,C:上面的k值决定是寄存器索引[其实就是栈索引],还是常量池索引 A:目标索引 占用bit位范围\n操作 范围(单位bit) Op(7) 0~6 A(8) 7~14 k(1) 15 B(8) 16~23 C(8) 24~31 赋值加载指令 OP_MOVE 公式:A B R[A] := R[B] 将B寄存器的值赋值给A寄存器\nlua示例代码\nlocal B = 10 local A = B 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00CA2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADI 0 10 将整型立即数10加载到寄存器的0号位置 3 [2] MOVE 1 0 将(寄存器的0号位置)上面的局部变量B的值付给(寄存器的1号位置)上面局部变量A 4 [2] RETURN 2 1 1 ; 0 out 返回0个值 上面步骤大概意思是\n在编译过程,Lua会将每个local变量都分配到一个指定的寄存器中,比如局部变量B分配到寄存器0号位置,局部变量A分配到寄存器1号位置\n然后执行VARARGPREP指令查看下可变参数方式下的固定参数数量 调用LOADI执行将整型立即数10加载到寄存器0号位置 调用MOVE将寄存器的0号位置上面的局部变量B的值付给寄存器的1号位置上面局部变量A 0 out 的意思是返回0个值 OP_LOADFALSE 公式:A\tR[A] := false 加载false到寄存器\nlua示例代码\nlocal a = false 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 00F32290) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADFALSE 0 将false加载到寄存器的0号位置 3 [1] RETURN 1 1 1 ; 0 out OP_LFALSESKIP 公式:A\tR[A] := false; pc++\t(*) 加载false到寄存器,同时跳过下一条指令\nlua示例代码\nlocal a = 5 \u003e 2 执行luac54 -l Helloworld.lua结果\n0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADI 0 2 将立即整数2加载到寄存器0号位置 3 [1] LTI 0 5 1 比较大小 4 [1] JMP 1 ; to 6 进行跳转 5 [1] LFALSESKIP 0\t加载false到寄存器,同时跳过下一条指令 6 [1] LOADTRUE 0 加载true到寄存器 7 [1] RETURN 1 1 1 ; 0 out OP_LOADTRUE 公式:A\tR[A] := true 加载true到寄存器\nlua示例代码\nlocal a = true 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 014C2290) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADTRUE 0 将true加载到寄存器的0号位置 3 [1] RETURN 1 1 1 ; 0 out OP_LOADNIL 公式:A B\tR[A], R[A+1], ..., R[A+B] := nil 将序号[A,A+B]连续B+1个寄存器设置成nil值,用于加载nil到一批寄存器\nlua示例代码\nlocal a = nil local a1 = nil local a2 = nil local a3 = nil local a4 = nil 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 015422A0) 0+ params, 5 slots, 1 upvalue, 5 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADNIL 0 4 ; 5 out 将序号[A:0,A:0+B:4]连续B:4+1个寄存器设置成nil值 3 [5] RETURN 5 1 1 ; 0 out OP_GETUPVAL 公式:A B\tR[A] := UpValue[B] 读取一个上值到寄存器\nlua示例代码\nlocal a function test() a = 1 return a end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (5 instructions at 01542290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [1] LOADNIL 0 0 ; 1 out 3 [5] CLOSURE 1 0 ; 01543CB8 4 [2] SETTABUP 0 0 1 ; _ENV \"test\" 5 [5] RETURN 1 1 1k ; 0 out function \u003c.\\helloworld.lua:2,5\u003e (5 instructions at 01543CB8) 0 params, 2 slots, 1 upvalue, 0 locals, 0 constants, 0 functions 1 [3] LOADI 0 1 2 [3] SETUPVAL 0 0 ; a 3 [4] GETUPVAL 0 0 ; a 把当前闭包的B:0位置的值拷贝到目标寄存器A:0中 4 [4] RETURN1 0 5 [5] RETURN0 OP_SETUPVAL 公式:A B\tUpValue[B] := R[A] 写一个寄存器值到上值\nlua示例代码\nlocal a function test() a = 1 return a end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (5 instructions at 01542290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [1] LOADNIL 0 0 ; 1 out 3 [5] CLOSURE 1 0 ; 01543CB8 4 [2] SETTABUP 0 0 1 ; _ENV \"test\" 5 [5] RETURN 1 1 1k ; 0 out function \u003c.\\helloworld.lua:2,5\u003e (5 instructions at 01543CB8) 0 params, 2 slots, 1 upvalue, 0 locals, 0 constants, 0 functions 1 [3] LOADI 0 1 2 [3] SETUPVAL 0 0 ; a 把当前寄存器A:0位置的值设置到B:0位置并做为闭包的上值 3 [4] GETUPVAL 0 0 ; a 4 [4] RETURN1 0 5 [5] RETURN0 表操作 OP_GETTABUP 公式:A B C\tR[A] := UpValue[B][K[C]:string] 从表取值到寄存器,表在upvalue\nlua示例代码\nglobal_var = 40 local local_var = global_var 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 012C2290) 0+ params, 2 slots, 1 upvalue, 1 local, 2 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] SETTABUP 0 0 1k ; _ENV \"global_var\" 40 3 [2] GETTABUP 0 0 0 ; _ENV \"global_var\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:0的(即global_var),放到寄存器索引为A:0的地方 4 [2] RETURN 1 1 1 ; 0 out OP_GETTABUP和与OP_GETTABLE指令相似,只是表被引用为上值.这些指令用于访问全局变量,是通过名为_ENV的上值访问的\nOP_GETTABLE 公式:A B C\tR[A] := R[B][R[C]] 将寄存器B位置的表t,下标为key为C里面的内容拷贝到寄存器A上\nlua示例代码\nlocal k = \"a\" local ra = t[k] 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (5 instructions at 01202290) 0+ params, 2 slots, 1 upvalue, 2 locals, 2 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADK 0 0 ; \"a\" 3 [2] GETTABUP 1 0 1 ; _ENV \"t\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:1的(即t),放到寄存器索引为A:1的地方 4 [2] GETTABLE 1 1 0 将寄存器B:1位置的表t,下标为key为C:0里面的内容拷贝到寄存器A:1 5 [2] RETURN 2 1 1 ; 0 out OP_GETI 公式:A B C\tR[A] := R[B][C]\t从表取key为整型的内容给寄存器\nlua示例代码\nlocal a = t[2] 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 01492290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"t\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:0的(即t),放到寄存器索引为A:0的地方 3 [1] GETI 0 0 2 将寄存器B:0位置的表t,下标为key为立即整数2里面的内容拷贝到寄存器A:0 4 [1] RETURN 1 1 1 ; 0 out OP_GETFIELD 公式:A B C\tR[A] := R[B][K[C]:string] 从表取key为字符串的内容给寄存器\nlua示例代码\nlocal ra = t[\"11\"] 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00AC2290) 0+ params, 2 slots, 1 upvalue, 1 local, 2 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"t\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:0的(即t),放到寄存器索引为A:0的地方 3 [1] GETFIELD 0 0 1 ; \"11\" 将寄存器B:0位置的表t,下标为key为C:1的内容拷贝到寄存器A:0 4 [1] RETURN 1 1 1 ; 0 out OP_SETTABUP 公式:A B C\tUpValue[A][K[B]:string] := RK(C) 设置寄存器值给表元素,表在upvalue\nlua示例代码\nglobal_var = 40 local local_var = global_var 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 012C2290) 0+ params, 2 slots, 1 upvalue, 1 local, 2 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] SETTABUP 0 0 1k ; _ENV \"global_var\" 40 将常量表中Key为C:1上的值40 赋值给寄存器A:0上的上值表key为B:0的上值 3 [2] GETTABUP 0 0 0 ; _ENV \"global_var\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:0的(即global_var),放到寄存器索引为A:0的地方 4 [2] RETURN 1 1 1 ; 0 out OP_NEWTABLE 公式:A B C k\tR[A] := {} 新建一个表\nlua示例代码\nlocal t = {} 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00A522A8) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] NEWTABLE 0 0 0 ; 0 创建一个空表,并将空表放到寄存器A:0位置 3 [1] EXTRAARG 0 4 [1] RETURN 1 1 1 ; 0 out OP_SELF 公式:A B C\tR[A+1] := R[B]; R[A] := R[B][RK(C):string] 准备一个对象方法的调用\nlua示例代码\nfoo:getLua(\"lua\") 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 012E2290) 0+ params, 3 slots, 1 upvalue, 0 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"foo\" 3 [1] SELF 0 0 1k ; \"getLua\" 把寄存器中对象B:0(即foo)和常量表中方法C:1(即getLua)拷贝到相邻的两个目标寄存器中,相邻目标的其实位置由A:0决定 4 [1] LOADK 2 2 ; \"lua\" 5 [1] CALL 0 3 1 ; 2 in 0 out 6 [1] RETURN 0 1 1 ; 0 out 上面方法foo:getLua(\"lua\")调用相当于foo.getLua(foo,\"lua\"),让全局foo只被查找一次,下面在介绍下没有self指令情况下的情况\nlua示例代码\nfoo.getLua(foo,\"lua\") luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 008F2290) 0+ params, 3 slots, 1 upvalue, 0 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"foo\" 3 [1] GETFIELD 0 0 1 ; \"getLua\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:1的(即getLua),放到寄存器索引为A:0的地方 4 [1] GETTABUP 1 0 0 ; _ENV \"foo\" 将upvalues表索引为B:0的upvalue(即：_ENV)中key为常量表索引为C:0的(即\"foo\"),放到寄存器索引为A:1的地方 5 [1] LOADK 2 2 ; \"lua\" 6 [1] CALL 0 3 1 ; 2 in 0 out 7 [1] RETURN 0 1 1 ; 0 out 从对两个函数进行指令集对比以后我们可以看出foo:getLua(\"lua\")函数的第3行的\n3 [1] SELF 0 0 1k ; \"getLua\"\n和\nfoo.getLua(foo,\"lua\")函数第3,4行\n3 [1] GETFIELD 0 0 1 ; \"getLua\"\n4 [1] GETTABUP 1 0 0 ; _ENV \"foo\"\n等价\n所以综合来说SELF指令节省了额外的指令,并加快了面向对象编程中方法的调用.但是它只为使用冒号语法的方法调用生成服务\nOP_SETLIST 公式:A B C k R[A][C+i] := R[A+i], 1 \u003c= i \u003c= B 给表设置一批数组元素\nlua示例代码\nlocal q = {1,2,3,4,5} 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (10 instructions at 01572290) 0+ params, 6 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] NEWTABLE 0 0 5 ; 5 3 [1] EXTRAARG 0 4 [1] LOADI 1 1 5 [1] LOADI 2 2 6 [1] LOADI 3 3 7 [1] LOADI 4 4 8 [1] LOADI 5 5 9 [1] SETLIST 0 5 0 这里的5就是数组数量 10 [1] RETURN 1 1 1 ; 0 out 如果需要写入数组的一系列值并且是紧挨着数组则数量由操作数B指定,数组起始索引则由操作C指定\n其实这么做也是为了省指令条数,只需要一条指令OP_SETLIST就够了\n算术和位运算 OP_ADDI 公式:A B sC\tR[A] := R[B] + sC 立即数加\nlua示例代码\nlocal a,b = 1,2 a = a + 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00812290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] ADDI 0 0 5 立即数相加 5 [2] MMBINI 0 5 6 0 ; __add 6 [2] RETURN 2 1 1 ; 0 out OP_ADDK 公式:A B C\tR[A] := R[B] + K[C]:number 常量加\nlua示例代码\nlocal a,b = 1,2 a = a + 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 007B2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] ADDK 0 0 0 ; 5.0 常量加 5 [2] MMBINK 0 0 6 0 ; __add 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_SUBK 公式:A B C\tR[A] := R[B] - K[C]:number 常量减\nlua示例代码\nlocal a,b = 1,2 a = a - 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00DB2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] SUBK 0 0 0 ; 5.0 常量减 5 [2] MMBINK 0 0 7 0 ; __sub 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_MULK 公式:A B C\tR[A] := R[B] * K[C]:number 常量乘\nlua示例代码\nlocal a,b = 1,2 a = a * 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 015D2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] MULK 0 0 0 ; 5.0 常量乘 5 [2] MMBINK 0 0 8 0 ; __mul 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_MODK 公式:A B C\tR[A] := R[B] % K[C]:number 常量模\nlua示例代码\nlocal a,b = 1,2 a = a % 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 01732290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] MODK 0 0 0 ; 5.0 常量模 5 [2] MMBINK 0 0 9 0 ; __mod 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_DIVK 公式:A B C\tR[A] := R[B] / K[C]:number 常量除\nlua示例代码\nlocal a,b = 1,2 a = a / 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 008E2298) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] DIVK 0 0 0 ; 5.0 常量除 5 [2] MMBINK 0 0 11 0 ; __div 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_IDIVK 公式:A B C\tR[A] := R[B] // K[C]:number 常量整除\nlua示例代码\nlocal a,b = 1,2 a = a // 5.0 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00BB2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] IDIVK 0 0 0 ; 5.0 常量整除 5 [2] MMBINK 0 0 12 0 ; __idiv 5.0 6 [2] RETURN 2 1 1 ; 0 out OP_BANDK 公式:A B C\tR[A] := R[B] \u0026 K[C]:integer 常量与\nlua示例代码\nlocal a,b = 1,2 a = a \u0026 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00C22290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] BANDK 0 0 0 ; 5 常量与 5 [2] MMBINK 0 0 13 0 ; __band 5 6 [2] RETURN 2 1 1 ; 0 out OP_BORK 公式:A B C\tR[A] := R[B] | K[C]:integer 常量或\nlua示例代码\nlocal a,b = 1,2 a = a | 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00832428) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] BORK 0 0 0 ; 5 常量或 5 [2] MMBINK 0 0 14 0 ; __bor 5 6 [2] RETURN 2 1 1 ; 0 out OP_BXORK 公式:A B C\tR[A] := R[B] ~ K[C]:integer\t常量异或\nlua示例代码\nlocal a,b = 1,2 a = a ~ 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 009E2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] BXORK 0 0 0 ; 5 常量异或 5 [2] MMBINK 0 0 15 0 ; __bxor 5 6 [2] RETURN 2 1 1 ; 0 out OP_SHRI 公式:A B sC\tR[A] := R[B] \u003e\u003e sC\t立即数右移\nlua示例代码\nlocal a,b = 1,2 a = a \u003e\u003e 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 007625B8) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] SHRI 0 0 5 立即数右移 5 [2] MMBINI 0 5 17 0 ; __shr 6 [2] RETURN 2 1 1 ; 0 out OP_SHLI 公式:A B sC\tR[A] := sC \u003c\u003c R[B]\t立即数左移\nlua示例代码\nlocal a = 1 local b = 2 local a = a + b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00A22290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] SHLI 0 0 5 立即数左移 5 [2] MMBINI 0 5 16 1 ; __shl flip 6 [2] RETURN 2 1 1 ; 0 out OP_ADD 公式:A B C\tR[A] := R[B] + R[C]\t加\nlua示例代码\nlocal a = 1 local b = 2 local a = a + b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00ED22A0) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] ADD 2 0 1 加 5 [3] MMBIN 0 1 6 ; __add 6 [3] RETURN 3 1 1 ; 0 out OP_SUB 公式:A B C\tR[A] := R[B] - R[C]\t减\nlua示例代码\nlocal a = 1 local b = 2 local a = a - b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00FC22A0) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] SUB 2 0 1 减 5 [3] MMBIN 0 1 7 ; __sub 6 [3] RETURN 3 1 1 ; 0 out OP_MUL 公式:A B C\tR[A] := R[B] * R[C]\t乘\nlua示例代码\nlocal a = 1 local b = 2 local a = a * b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00EF2290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] MUL 2 0 1 乘 5 [3] MMBIN 0 1 8 ; __mul 6 [3] RETURN 3 1 1 ; 0 out OP_MOD 公式:A B C\tR[A] := R[B] % R[C]\t模\nlua示例代码\nlocal a = 1 local b = 2 local a = a % b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 01102290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] MOD 2 0 1 模 5 [3] MMBIN 0 1 9 ; __mod 6 [3] RETURN 3 1 1 ; 0 out OP_POW 公式:A B C\tR[A] := R[B] ^ R[C]\t幂\nlua示例代码\nlocal a = 1 local b = 2 local a = a ^ b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 006F2290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] POW 2 0 1 幂 5 [3] MMBIN 0 1 10 ; __pow 6 [3] RETURN 3 1 1 ; 0 out OP_DIV 公式:A B C\tR[A] := R[B] / R[C]\t浮点除\nlua示例代码\nlocal a = 1 local b = 2 local a = a / b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 008B2290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] DIV 2 0 1 浮点除 5 [3] MMBIN 0 1 11 ; __div 6 [3] RETURN 3 1 1 ; 0 out OP_IDIV 公式:A B C\tR[A] := R[B] // R[C]\t整除\nlua示例代码\nlocal a = 1 local b = 2 local a = a // b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 011A22A8) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] IDIV 2 0 1 整除 5 [3] MMBIN 0 1 12 ; __idiv 6 [3] RETURN 3 1 1 ; 0 out OP_BAND 公式:A B C\tR[A] := R[B] \u0026 R[C]\t位与\nlua示例代码\nlocal a = 1 local b = 2 local a = a \u0026 b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00C32290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] BAND 2 0 1 位与 5 [3] MMBIN 0 1 13 ; __band 6 [3] RETURN 3 1 1 ; 0 out OP_BOR 公式:A B C\tR[A] := R[B] | R[C]\t位或\nlua示例代码\nlocal a = 1 local b = 2 local a = a | b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00D422A8) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] BOR 2 0 1 位或 5 [3] MMBIN 0 1 14 ; __bor 6 [3] RETURN 3 1 1 ; 0 out OP_BXOR 公式:A B C\tR[A] := R[B] ~ R[C]\t位异或\nlua示例代码\nlocal a = 1 local b = 2 local a = a ~ b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 01592748) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] BXOR 2 0 1 位异或 5 [3] MMBIN 0 1 15 ; __bxor 6 [3] RETURN 3 1 1 ; 0 out OP_SHL 公式:A B C\tR[A] := R[B] \u003c\u003c R[C]\t左移\nlua示例代码\nlocal a = 1 local b = 2 local a = a \u003c\u003c b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 015F2280) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] SHL 2 0 1 左移 5 [3] MMBIN 0 1 16 ; __shl 6 [3] RETURN 3 1 1 ; 0 out OP_SHL 公式:A B C\tR[A] := R[B] \u003e\u003e R[C]\t右移\nlua示例代码\nlocal a = 1 local b = 2 local a = a \u003e\u003e b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00D72290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] SHR 2 0 1 右移 5 [3] MMBIN 0 1 17 ; __shr 6 [3] RETURN 3 1 1 ; 0 out 前面算术和位运算失败尝试调用C层元方法 OP_MMBIN 公式:A B C\tcall C metamethod over R[A] and R[B]\t(*) 位异或失败以后调用C元方法\nlua示例代码\nlocal a = 1 local b = 2 local a = a ~ b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 01592748) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LOADI 1 2 4 [3] BXOR 2 0 1 位异或 5 [3] MMBIN 0 1 15 ; __bxor 位异或失败了就会去调用__bxor元方法 6 [3] RETURN 3 1 1 ; 0 out OP_MMBINI 公式:A B sC\tR[A] := sC \u003c\u003c R[B]\t立即数左移失败以后调用C元方法\nlua示例代码\nlocal a = 1 local b = 2 local a = a + b luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00A22290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] SHLI 0 0 5 立即数左移 5 [2] MMBINI 0 5 16 1 ; __shl flip 立即数左移失败了就会去调用__shl元方法 6 [2] RETURN 2 1 1 ; 0 out OP_MMBINK 公式:A B C k call C metamethod over R[A] and K[B] 常量异或失败以后调用C元方法\nlua示例代码\nlocal a,b = 1,2 a = a ~ 5 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 009E2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 2 4 [2] BXORK 0 0 0 ; 5 常量异或 5 [2] MMBINK 0 0 15 0 ; __bxor 5 常量异或失败了就会去调用__bxor元方法 6 [2] RETURN 2 1 1 ; 0 out 一元运算 OP_UNM 公式:A B\tR[A] := -R[B] 一元减\nlua示例代码\nlocal a = 1 local b = -a luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 009722B8) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] UNM 1 0 一元减 4 [2] RETURN 2 1 1 ; 0 out OP_BNOT 公式:A B\tR[A] := ~R[B] 位非\nlua示例代码\nlocal a = 1 local b = ~a luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00CB2290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] BNOT 1 0 位非 4 [2] RETURN 2 1 1 ; 0 out 逻辑运算 OP_NOT 公式:A B\tR[A] := not R[B] 逻辑取反\nlua示例代码\nlocal a = 1 local b = not(a) luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00A12290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] NOT 1 0 逻辑取反 4 [2] RETURN 2 1 1 ; 0 out 周边操作 OP_LEN 公式:A B\tR[A] := #R[B] (length operator) 取长度\nlua示例代码\nlocal a = 1 local b = #a luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00952290) 0+ params, 2 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] LEN 1 0 取长度 4 [2] RETURN 2 1 1 ; 0 out OP_CONCAT 公式:A B\tR[A] := R[A].. ... ..R[A + B - 1] 拼接对象\nlua示例代码\nlocal a = 1 local b = a .. 22 luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00D122A8) 0+ params, 3 slots, 1 upvalue, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [2] MOVE 1 0 4 [2] LOADI 2 22 5 [2] CONCAT 1 2 拼接对象 6 [2] RETURN 2 1 1 ; 0 out 关闭上值 OP_CLOSE 公式:A\tclose all upvalues \u003e= R[A] 关闭上值\nlua示例代码\ndo local testvar function fun( ... ) testvar = 22222 end end luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 01172290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [2] LOADNIL 0 0 ; 1 out 3 [5] CLOSURE 1 0 ; 01173D38 4 [3] SETTABUP 0 0 1 ; _ENV \"fun\" 5 [5] CLOSE 0 关闭上值 6 [7] RETURN 0 1 1k ; 0 out function \u003c.\\helloworld.lua:3,5\u003e (4 instructions at 01173D38) 0+ params, 2 slots, 1 upvalue, 0 locals, 0 constants, 0 functions 1 [3] VARARGPREP 0 2 [4] LOADI 0 22222 3 [4] SETUPVAL 0 0 ; testvar 4 [5] RETURN 0 1 1 ; 0 out tbc变量 OP_TBC 公式:A\tmark variable A \"to be closed\" 标记寄存器为tbc\nlua示例代码\nlocal tt\u003cclose\u003e = t; luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 011C2428) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"t\" 3 [1] TBC 0 标记寄存器为tbc 4 [1] RETURN 1 1 1k ; 0 out 分支与跳转 OP_EQ OP_EQ分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A B k\tif ((R[A] == R[B]) ~= k) then pc++ 相等测试,条件跳转\nlua示例代码\nlocal a = 5 local b = 1 local c = a==b 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (8 instructions at 016F2290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 5 3 [2] LOADI 1 1 4 [3] EQ 0 1 1 比较相等 5 [3] JMP 1 ; to 7 不满足条件跳转 6 [3] LFALSESKIP 2 7 [3] LOADTRUE 2 8 [3] RETURN 3 1 1 ; 0 out OP_LT OP_LT分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A B k\tif ((R[A] \u003c R[B]) ~= k) then pc++ 小于测试,条件跳转\nlua示例代码\nlocal a = 5 local b = 1 local c = a \u003c b 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (8 instructions at 00782290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 5 3 [2] LOADI 1 1 4 [3] LT 0 1 1 比较小于 5 [3] JMP 1 ; to 7 不满足条件跳转 6 [3] LFALSESKIP 2 7 [3] LOADTRUE 2 8 [3] RETURN 3 1 1 ; 0 out OP_LE OP_LE分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A B k\tif ((R[A] \u003c= R[B]) ~= k) then pc++ 小于等于测试,条件跳转\nlua示例代码\nlocal a = 5 local b = 1 local c = a \u003c= b 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (8 instructions at 00BA2290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 5 3 [2] LOADI 1 1 4 [3] LE 0 1 1 比较小于等于 5 [3] JMP 1 ; to 7 不满足条件跳转 6 [3] LFALSESKIP 2 7 [3] LOADTRUE 2 8 [3] RETURN 3 1 1 ; 0 out OP_EQK OP_EQK分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A B k\tif ((R[A] == K[B]) ~= k) then pc++ 常量相等测试,条件跳转\nlua示例代码\nlocal c = a == \"1\" 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 01622290) 0+ params, 2 slots, 1 upvalue, 1 local, 2 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] EQK 0 1 1 ; \"1\" 4 [1] JMP 1 ; to 6 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_EQI OP_EQI分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A sB k\tif ((R[A] == sB) ~= k) then pc++ 立即数相等测试,条件跳转\nlua示例代码\nlocal c = a == 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00802290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] EQI 0 1 1 立即数相等测试 4 [1] JMP 1 ; to 6 不相等跳转 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_LTI OP_LTI分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A sB k\tif ((R[A] \u003c sB) ~= k) then pc++ 立即数小于测试,条件跳转\nlua示例代码\nlocal c = a \u003c 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00FF2290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] LTI 0 1 1 立即数小于测试 4 [1] JMP 1 ; to 6 不符合条件跳转 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_LEI OP_LEI分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A sB k\tif ((R[A] \u003c= sB) ~= k) then pc++ 立即数小于等于测试,条件跳转\nlua示例代码\nlocal c = a \u003c= 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00CE2290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] LEI 0 1 1 立即数小于等于测试 4 [1] JMP 1 ; to 6 不符合条件跳转 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_GTI OP_GTI分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A sB k\tif ((R[A] \u003e sB) ~= k) then pc++ 立即数大于测试,条件跳转\nlua示例代码\nlocal c = a \u003e 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 01142290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] GTI 0 1 1 立即数大于测试,条件跳转 4 [1] JMP 1 ; to 6 不符合条件跳转 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_GEI OP_GEI分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A sB k\tif ((R[A] \u003e= sB) ~= k) then pc++ 立即数大于等于测试,条件跳转\nlua示例代码\nlocal c = a \u003e= 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00C72290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] GEI 0 1 1 立即数大于等于测试,条件跳转 4 [1] JMP 1 ; to 6 不符合条件跳转 5 [1] LFALSESKIP 0 6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out OP_TEST OP_TEST分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\nOP_TEST逻辑指令用于实现 and 和 or 逻辑运算符 如果相等则将寄存器B的值 赋给寄存器 A,然后继续执行,反之如果不相等,则跳过后面的 JMP指令\n公式:A k\tif (not R[A] == k) then pc++ bool测试,条件跳转\nlua示例代码\nlocal c = a and 1 local c = a or 1 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (10 instructions at 00B82290) 0+ params, 2 slots, 1 upvalue, 2 locals, 1 constant, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"a\" 3 [1] TEST 0 0 and运算符的测试 4 [1] JMP 1 ; to 6 不满足条件跳转 5 [1] LOADI 0 1 6 [2] GETTABUP 1 0 0 ; _ENV \"a\" 7 [2] TEST 1 1 or运算符的测试 8 [2] JMP 1 ; to 10 不满足条件跳转 9 [2] LOADI 1 1 10 [2] RETURN 2 1 1 ; 0 out OP_TESTSET OP_TESTSET分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:A B k\tif (not R[B] == k) then pc++ else R[A] := R[B] (*) bool测试,条件跳转和赋值\nlua示例代码\nlocal a local b local c = a and b 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00A42290) 0+ params, 3 slots, 1 upvalue, 3 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADNIL 0 1 ; 2 out 3 [3] TESTSET 2 0 0 判断寄存器B:0上面的值转成bool值后,是否和寄存器C:0表示的bool值相等 如果结果一致,将寄存器B:0上面的值复制到寄存器A:2上面,否则条件跳转 4 [3] JMP 1 ; to 6 不符合条件跳转 5 [3] MOVE 2 1 6 [3] RETURN 3 1 1 ; 0 out 判断寄存器B:0上面的值转成bool值后,是否和寄存器C:0表示的bool值相等 如果结果一致,将寄存器B:0上面的值复制到寄存器A:2上面,否则条件跳转\n不符合条件跳转\n函数调用 OP_CALL 公式:A B C\tR[A], ... ,R[A+C-2] := R[A](R[A+1], ... ,R[A+B-1]) 函数调用\nlua示例代码\nfunction fun() end fun() luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00802290) 0+ params, 2 slots, 1 upvalue, 0 locals, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00803BE8 3 [1] SETTABUP 0 0 0 ; _ENV \"fun\" 4 [5] GETTABUP 0 0 0 ; _ENV \"fun\" 5 [5] CALL 0 1 1 ; 0 in 0 out 函数调用 6 [5] RETURN 0 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (1 instruction at 00803BE8) 0 params, 2 slots, 0 upvalues, 0 locals, 0 constants, 0 functions 1 [3] RETURN0 OP_TAILCALL 公式:A B C k\treturn R[A](R[A+1], ... ,R[A+B-1]) 尾调用\nlua示例代码\nfunction fun1() return fun2(111, 222) end luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00E82290) 0+ params, 2 slots, 1 upvalue, 0 locals, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00E83BE8 3 [1] SETTABUP 0 0 0 ; _ENV \"fun1\" 4 [3] RETURN 0 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (6 instructions at 00E83BE8) 0 params, 3 slots, 1 upvalue, 0 locals, 1 constant, 0 functions 1 [2] GETTABUP 0 0 0 ; _ENV \"fun2\" 2 [2] LOADI 1 111 3 [2] LOADI 2 222 4 [2] TAILCALL 0 3 0 ; 2 in 尾调用 5 [2] RETURN 0 0 0 ; all out 6 [3] RETURN0 因为调用fun2后,fun1中不再执行任何代码,所以不需要保留fun1的调用栈信息,Lua做了这样的优化,称为尾调用消除,fun2返回后,控制点直接返回到调用fun1的地方,有点类似c语言的goto语句,这样做能减少栈的空间消耗,非常nice\nOP_RETURN 公式:A B C k\treturn R[A], ... ,R[A+B-2]\t(see note) 从函数调用返回\nlua示例代码\nfunction fun1() return 1,2,3,4 end local x,y,z = fun1() luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00E22280) 0+ params, 3 slots, 1 upvalue, 3 locals, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00E23BD8 3 [1] SETTABUP 0 0 0 ; _ENV \"fun1\" 4 [5] GETTABUP 0 0 0 ; _ENV \"fun1\" 5 [5] CALL 0 1 4 ; 0 in 3 out 6 [5] RETURN 3 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (6 instructions at 00E23BD8) 0 params, 4 slots, 0 upvalues, 0 locals, 0 constants, 0 functions 1 [2] LOADI 0 1 2 [2] LOADI 1 2 3 [2] LOADI 2 3 4 [2] LOADI 3 4 5 [2] RETURN 0 5 0 ; 4 out 返回4个参数 6 [3] RETURN0 如果寄存器B==0 输出all out 如果寄存器B\u003e0 输入B-1个返回值 OP_RETURN0 公式:return 返回无结果\nlua示例代码\nfunction fun1() return end local x = fun1() luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00C32290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00C33BE8 3 [1] SETTABUP 0 0 0 ; _ENV \"fun1\" 4 [5] GETTABUP 0 0 0 ; _ENV \"fun1\" 5 [5] CALL 0 1 2 ; 0 in 1 out 6 [5] RETURN 1 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (2 instructions at 00C33BE8) 0 params, 2 slots, 0 upvalues, 0 locals, 0 constants, 0 functions 1 [2] RETURN0 返回无结果 2 [3] RETURN0 返回无结果 OP_RETURN1 公式:A\treturn R[A] 返回一个参数\nlua示例代码\nfunction fun1() return 1 end local x = fun1() luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (6 instructions at 00BA2290) 0+ params, 2 slots, 1 upvalue, 1 local, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00BA3BE8 3 [1] SETTABUP 0 0 0 ; _ENV \"fun1\" 4 [5] GETTABUP 0 0 0 ; _ENV \"fun1\" 5 [5] CALL 0 1 2 ; 0 in 1 out 6 [5] RETURN 1 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (3 instructions at 00BA3BE8) 0 params, 2 slots, 0 upvalues, 0 locals, 0 constants, 0 functions 1 [2] LOADI 0 1 2 [2] RETURN1 0 返回1个值 3 [3] RETURN0 OP_VARARG 公式:A C\tR[A], R[A+1], ..., R[A+C-2] = vararg 将函数的可变参数拷贝给寄存器\nlua示例代码\nlocal a = ... 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 00A92290) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] VARARG 0 2 ; 1 out 3 [1] RETURN 1 1 1 ; 0 out ​\t如果寄存器C等于0那么就输出all out 否则输出 c-1 out\n​\t这个C里面的值就是local a = ... 等号前面局部变量的个数,比如现在只有一个局部变量a那么就是1\nOP_VARARGPREP 公式:A\t(adjust vararg parameters) 查看可变参数方式下固定参数个数\nlua示例代码\nfunction func(a,b, ...) end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00F52290) 0+ params, 2 slots, 1 upvalue, 0 locals, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00F53BE8 3 [1] SETTABUP 0 0 0 ; _ENV \"func\" 4 [3] RETURN 0 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (2 instructions at 00F53BE8) 2+ params, 2 slots, 0 upvalues, 2 locals, 0 constants, 0 functions 1 [1] VARARGPREP 2 查看可变参数方式下固定参数个数 2 [3] RETURN 2 1 3 ; 0 out ​\t因为func函数里面有a,b固定的两个固定变量,所以指令哪里可以看到是2\niABx操作数模式 占用bit位范围\n操作 范围(单位bit) Op(7) 0~6 A(8) 7~14 Bx(17) 15~31 OP_LOADK 公式:A Bx\tR[A] := K[Bx] 加载常量立即数到寄存器\nlua会将\n常量表达式 字符串 整型,浮点型超出寄存器sBx操作数值范围的数 等等 都放到常量表中\nlua示例代码\nlocal a = \"lllllll\" 字符串 local b = 333333333333333333333333333333333333333333333 整型超出寄存器sBx操作数值 local c = 111111111111111111111111.111111111111111111111 浮点数超出寄存器sBx操作数值 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (5 instructions at 00F822A8) 0+ params, 3 slots, 1 upvalue, 3 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADK 0 0 ; \"lllllll\" 从常量表0号位置中将\"lllllll\"加载到寄存器的0号位置 3 [2] LOADK 1 1 ; 3.3333333333333e+44 从常量表1号位置将3.3333333333333e+44加载到寄存器的1号位置 4 [3] LOADK 2 2 ; 1.1111111111111e+23 从常量表2号位置将1.1111111111111e+23加载到寄存器的2号位置 5 [3] RETURN 3 1 1 ; 0 out OP_LOADKX 公式:A\tR[A] := K[extra arg] 加载常量,常量从下一条OP_EXTRAARG指令得到\n当需要生成LOADK指令时,如果需要索引的常量id超出了Bx所能表示的有效范围,那么就生成一个LOADKX指令,取代LOADK指令,并且接下来立即生成一个EXTRAARG指令,并用其Ax来存放这个id\nBx的位数是17位,那么能标识的无符号最大值是17个1 也就是2^17-1 = 262143个索引 Ax的位数是25位,那么能标识的无符号最大值是25个1 也就是2^25-1 = 67108863个索引 所以我们能得出结论lua常量表的索引能达到惊人的 262143 + 67108863 = 67371006个索引 鉴于超级大的索引范围,这个就不弄lua示例代码了,大家知道只要超过262143的索引,就会触发OP_LOADKX指令,并用其Ax来存放这个超出范围的id就好了\nfor循环 OP_FORLOOP 公式:A Bx\tupdate counters; if loop continues then pc-=Bx; 数值for循环\nlua示例代码\nfor i=1,100,10 do //初始值为1,步长为10,上限为100 end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00A022A8) 0+ params, 4 slots, 1 upvalue, 4 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 100 4 [1] LOADI 2 10 5 [1] FORPREP 0 0 ; exit to 7 数值for循环 6 [1] FORLOOP 0 1 ; to 6 数值for循环 7 [3] RETURN 0 1 1 ; 0 out 该指令先给i加上步长,然后判断i是否在范围之内.若已经超出范围,则循环结束\n若没超出范围,则将数值拷贝给用户定义的局部变量\n然后跳转到循环体内部开始执行具体的代码块\nOP_FORPREP 公式:A Bx\t; if not to run then pc+=Bx+1; 数值for循环\nlua示例代码\nfor i=1,100,10 do //初始值为1,步长为10,上限为100 end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (7 instructions at 00A022A8) 0+ params, 4 slots, 1 upvalue, 4 locals, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 1 3 [1] LOADI 1 100 4 [1] LOADI 2 10 5 [1] FORPREP 0 0 ; exit to 7 数值for循环 6 [1] FORLOOP 0 1 ; to 6 数值for循环 7 [3] RETURN 0 1 1 ; 0 out 该指令的目的是在循环之前预先将i减去步长得到-1,然后跳转到FORLOOP指令正式开始循环\nOP_TFORPREP 公式:A Bx\tcreate upvalue for R[A + 3]; pc+=Bx 除了通用for循环作用还兼顾关闭upvalue值\nlua示例代码\nfor k,v in pairs(t) do print(k,v) end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (13 instructions at 00C22290) 0+ params, 9 slots, 1 upvalue, 6 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"pairs\" 3 [1] GETTABUP 1 0 1 ; _ENV \"t\" 4 [1] CALL 0 2 5 ; 1 in 4 out 5 [1] TFORPREP 0 4 ; to 10 除了通用for循环作用还兼顾关闭`upvalue`值 6 [2] GETTABUP 6 0 2 ; _ENV \"print\" 7 [2] MOVE 7 4 8 [2] MOVE 8 5 9 [2] CALL 6 3 1 ; 2 in 0 out 10 [1] TFORCALL 0 2 11 [1] TFORLOOP 0 6 ; to 6 12 [3] CLOSE 0 13 [3] RETURN 0 1 1k ; 0 out OP_TFORCALL 公式:A C\tR[A+4], ... ,R[A+3+C] := R[A](R[A+1], R[A+2]); 通用for循环\nlua示例代码\nfor k,v in pairs(t) do print(k,v) end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (13 instructions at 00C22290) 0+ params, 9 slots, 1 upvalue, 6 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"pairs\" 3 [1] GETTABUP 1 0 1 ; _ENV \"t\" 4 [1] CALL 0 2 5 ; 1 in 4 out 5 [1] TFORPREP 0 4 ; to 10 6 [2] GETTABUP 6 0 2 ; _ENV \"print\" 7 [2] MOVE 7 4 8 [2] MOVE 8 5 9 [2] CALL 6 3 1 ; 2 in 0 out 10 [1] TFORCALL 0 2 通用for循环 11 [1] TFORLOOP 0 6 ; to 6 12 [3] CLOSE 0 13 [3] RETURN 0 1 1k ; 0 out 编译器使用的第一个特殊变量(generator):f存放的是迭代器,其他两个特殊变量(state):s (control):var来调用迭代器\n把结果保存在用户定义的变量k,v中\nOP_TFORLOOP 公式:A Bx\tif R[A+2] ~= nil then { R[A]=R[A+2]; pc -= Bx } 通用for循环\nlua示例代码\nfor k,v in pairs(t) do print(k,v) end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (13 instructions at 00C22290) 0+ params, 9 slots, 1 upvalue, 6 locals, 3 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] GETTABUP 0 0 0 ; _ENV \"pairs\" 3 [1] GETTABUP 1 0 1 ; _ENV \"t\" 4 [1] CALL 0 2 5 ; 1 in 4 out 5 [1] TFORPREP 0 4 ; to 10 6 [2] GETTABUP 6 0 2 ; _ENV \"print\" 7 [2] MOVE 7 4 8 [2] MOVE 8 5 9 [2] CALL 6 3 1 ; 2 in 0 out 10 [1] TFORCALL 0 2 11 [1] TFORLOOP 0 6 ; to 6 通用for循环 12 [3] CLOSE 0 13 [3] RETURN 0 1 1k ; 0 out 若迭代器返回的k值不是nil，则把该值拷贝到(control):var,然后跳转到循环体 否则若为nil,则循环结束\n函数调用 OP_CLOSURE 公式:A Bx\tR[A] := closure(KPROTO[Bx]) 根据函数原型新建一个闭包\nlua示例代码\nfunction x() end 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (4 instructions at 00BD22A8) 0+ params, 2 slots, 1 upvalue, 0 locals, 1 constant, 1 function 1 [1] VARARGPREP 0 2 [3] CLOSURE 0 0 ; 00BD3C08 根据函数原型新建一个闭包 3 [1] SETTABUP 0 0 0 ; _ENV \"x\" 4 [3] RETURN 0 1 1 ; 0 out function \u003c.\\helloworld.lua:1,3\u003e (1 instruction at 00BD3C08) 0 params, 2 slots, 0 upvalues, 0 locals, 0 constants, 0 functions 1 [3] RETURN0 ​\t把当前Lua函数的子函数原型实例化为闭包\niAsBx操作数模式 占用bit位范围\n操作 范围(单位bit) Op(7) 0~6 A(8) 7~14 sBx(17) 15~31 加载 OP_LOADI 公式:A sBx R[A] := sBx 加载整型立即数到寄存器\nlua示例代码\nlocal B = 10 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 010F2290) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADI 0 10 将整型立即数10加载到寄存器的0号位置 3 [1] RETURN 1 1 1 ; 0 out 返回0个值 上面步骤大概意思\n将局部变量B分配到寄存器0号位置\n然后执行VARARGPREP指令查看下可变参数方式下的固定参数数量 将整型立即数10加载到寄存器的0号位置 0 out 的意思是返回0个值 OP_LOADF 公式:A sBx\tR[A] := (lua_Number)sBx 加载浮点立即数到寄存器\nlua示例代码\nlocal B = 10.0 执行luac54 -l Helloworld.lua结果\nmain \u003c.\\helloworld.lua:0,0\u003e (3 instructions at 010F2290) 0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 查看可变参数方式下固定参数个数 2 [1] LOADF 0 10 将浮点立即数10加载到寄存器的0号位置 3 [1] RETURN 1 1 1 ; 0 out 返回0个值 上面步骤大概意思\n将局部变量B分配到寄存器0号位置\n然后执行VARARGPREP指令查看下可变参数方式下的固定参数数量 将立即数10加载到寄存器的0号位置 0 out 的意思是返回0个值 iAx操作数模式 占用bit位范围\n操作 范围(单位bit) Op(7) 0~6 Ax(25) 7~31 额外参数 OP_EXTRAARG Ax的位数是25位,那么能标识的无符号最大值是25个1 也就是2^25-1 = 67108863个索引\n所以当OP_LOADKX指令索引不够的时候,也用这个指令续索引,OP_LOADKX开辟的指令索引加载这个额外扩展的索引足够使用了\nisJ操作数模式 占用bit位范围\n操作 范围(单位bit) Op(7) 0~6 sJ(25) 7~31 分支与跳转 OP_JMP OP_EQ OP_LT OP_LE OP_EQK OP_EQI OP_LTI OP_LEI OP_GTI OP_GEI OP_TEST OP_TESTSET 11个分支指令必须与后面的紧挨的JMP指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置\n公式:sJ\tpc += sJ 无条件跳转\nlua示例代码\nlocal a = 5 \u003c 2 执行luac54 -l Helloworld.lua结果\n0+ params, 2 slots, 1 upvalue, 1 local, 0 constants, 0 functions 1 [1] VARARGPREP 0 2 [1] LOADI 0 2 3 [1] LTI 0 5 1 比较大小 4 [1] JMP 1 ; to 6 进行跳转 5 [1] LFALSESKIP 0\t6 [1] LOADTRUE 0 7 [1] RETURN 1 1 1 ; 0 out 指令属性的掩码 bit位 作用 0~2 指令的类型 也就是这些 {iABC, iABx, iAsBx, iAx, isJ} 3 指令是否修改了寄存器A 4 判断当前指令是否涉及一次条件跳转 增加这个标记可以用来检测分支指令这一个打的类别,\n这样简化了指令集,当遇到跳转指令的时候,\n可以回到前一条指令来看看那是否是条件跳转 5 使用前一条指令设置的栈顶值（当 B == 0 时） 6 将值放到栈顶,供后面的指令使用（当C == 0时） 7 指令是MM指令（调用元方法） 指令的创建 创建ABCK指令 #define CREATE_ABCk(o,a,b,c,k)\t((cast(Instruction, o)\u003c",
  "wordCount" : "16513",
  "inLanguage": "en",
  "image":"https://frog-game.github.io/posts/read/lua5.4.4.code/image-20230223204632470.png","datePublished": "2023-02-28T01:30:29+08:00",
  "dateModified": "2023-02-28T01:30:29+08:00",
  "author":[{
    "@type": "Person",
    "name": "frog"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frog-game.github.io/posts/read/lua5.4.4.code/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "frog's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frog-game.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://frog-game.github.io/" accesskey="h" title="frog&#39;s Blog (Alt + H)">
            <img src="https://frog-game.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">frog&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://frog-game.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/archives/" title="⏱ 时间轴">
                <span>⏱ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://frog-game.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://frog-game.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://frog-game.github.io/posts/read/">📕 阅读</a></div>
            <h1 class="post-title">
                [Lua5.4.4源码].指令集
            </h1>
            <div class="post-description">
                lua源码指令集分析
            </div>
            <div class="post-meta">创建:&nbsp;<span title='2023-02-28 01:30:29 +0800 CST'>2023-02-28</span>&nbsp;|&nbsp;更新:&nbsp;2023-02-28&nbsp;|&nbsp;字数:&nbsp;16513字&nbsp;|&nbsp;时长:&nbsp;33分钟&nbsp;|&nbsp;
作者:&nbsp;frog



                &nbsp;|&nbsp;标签: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://frog-game.github.io/tags/lua5.4.4%E6%BA%90%E7%A0%81/">Lua5.4.4源码</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://frog-game.github.io/posts/read/lua5.4.4.code/image-20230223204632470.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8c%87%e4%bb%a4%e9%9b%86%e7%ae%80%e4%bb%8b" aria-label="指令集简介">指令集简介</a></li>
                <li>
                    <a href="#%e6%93%8d%e4%bd%9c%e6%95%b0%e7%bc%96%e7%a0%81%e6%a8%a1%e5%bc%8f%e4%b8%80%e5%85%b15%e4%b8%ad" aria-label="操作数编码模式一共5中">操作数编码模式一共5中</a><ul>
                        
                <li>
                    <a href="#%e7%9c%8b%e6%8c%87%e4%bb%a4%e5%89%8d%e7%9a%84%e4%b8%80%e4%ba%9b%e7%ac%a6%e5%8f%b7%e8%a7%a3%e9%87%8a" aria-label="看指令前的一些符号解释">看指令前的一些符号解释</a></li>
                <li>
                    <a href="#iabc%e6%93%8d%e4%bd%9c%e6%95%b0%e6%a8%a1%e5%bc%8f" aria-label="iABC操作数模式">iABC操作数模式</a><ul>
                        
                <li>
                    <a href="#%e8%b5%8b%e5%80%bc%e5%8a%a0%e8%bd%bd%e6%8c%87%e4%bb%a4" aria-label="赋值加载指令">赋值加载指令</a><ul>
                        
                <li>
                    <a href="#op_move" aria-label="OP_MOVE">OP_MOVE</a></li>
                <li>
                    <a href="#op_loadfalse" aria-label="OP_LOADFALSE">OP_LOADFALSE</a></li>
                <li>
                    <a href="#op_lfalseskip" aria-label="OP_LFALSESKIP">OP_LFALSESKIP</a></li>
                <li>
                    <a href="#op_loadtrue" aria-label="OP_LOADTRUE">OP_LOADTRUE</a></li>
                <li>
                    <a href="#op_loadnil" aria-label="OP_LOADNIL">OP_LOADNIL</a></li>
                <li>
                    <a href="#op_getupval" aria-label="OP_GETUPVAL">OP_GETUPVAL</a></li>
                <li>
                    <a href="#op_setupval" aria-label="OP_SETUPVAL">OP_SETUPVAL</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%a1%a8%e6%93%8d%e4%bd%9c" aria-label="表操作">表操作</a><ul>
                        
                <li>
                    <a href="#op_gettabup" aria-label="OP_GETTABUP">OP_GETTABUP</a></li>
                <li>
                    <a href="#op_gettable" aria-label="OP_GETTABLE">OP_GETTABLE</a></li>
                <li>
                    <a href="#op_geti" aria-label="OP_GETI">OP_GETI</a></li>
                <li>
                    <a href="#op_getfield" aria-label="OP_GETFIELD">OP_GETFIELD</a></li>
                <li>
                    <a href="#op_settabup" aria-label="OP_SETTABUP">OP_SETTABUP</a></li>
                <li>
                    <a href="#op_newtable" aria-label="OP_NEWTABLE">OP_NEWTABLE</a></li>
                <li>
                    <a href="#op_self" aria-label="OP_SELF">OP_SELF</a></li>
                <li>
                    <a href="#op_setlist" aria-label="OP_SETLIST">OP_SETLIST</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ae%97%e6%9c%af%e5%92%8c%e4%bd%8d%e8%bf%90%e7%ae%97" aria-label="算术和位运算">算术和位运算</a><ul>
                        
                <li>
                    <a href="#op_addi" aria-label="OP_ADDI">OP_ADDI</a></li>
                <li>
                    <a href="#op_addk" aria-label="OP_ADDK">OP_ADDK</a></li>
                <li>
                    <a href="#op_subk" aria-label="OP_SUBK">OP_SUBK</a></li>
                <li>
                    <a href="#op_mulk" aria-label="OP_MULK">OP_MULK</a></li>
                <li>
                    <a href="#op_modk" aria-label="OP_MODK">OP_MODK</a></li>
                <li>
                    <a href="#op_divk" aria-label="OP_DIVK">OP_DIVK</a></li>
                <li>
                    <a href="#op_idivk" aria-label="OP_IDIVK">OP_IDIVK</a></li>
                <li>
                    <a href="#op_bandk" aria-label="OP_BANDK">OP_BANDK</a></li>
                <li>
                    <a href="#op_bork" aria-label="OP_BORK">OP_BORK</a></li>
                <li>
                    <a href="#op_bxork" aria-label="OP_BXORK">OP_BXORK</a></li>
                <li>
                    <a href="#op_shri" aria-label="OP_SHRI">OP_SHRI</a></li>
                <li>
                    <a href="#op_shli" aria-label="OP_SHLI">OP_SHLI</a></li>
                <li>
                    <a href="#op_add" aria-label="OP_ADD">OP_ADD</a></li>
                <li>
                    <a href="#op_sub" aria-label="OP_SUB">OP_SUB</a></li>
                <li>
                    <a href="#op_mul" aria-label="OP_MUL">OP_MUL</a></li>
                <li>
                    <a href="#op_mod" aria-label="OP_MOD">OP_MOD</a></li>
                <li>
                    <a href="#op_pow" aria-label="OP_POW">OP_POW</a></li>
                <li>
                    <a href="#op_div" aria-label="OP_DIV">OP_DIV</a></li>
                <li>
                    <a href="#op_idiv" aria-label="OP_IDIV">OP_IDIV</a></li>
                <li>
                    <a href="#op_band" aria-label="OP_BAND">OP_BAND</a></li>
                <li>
                    <a href="#op_bor" aria-label="OP_BOR">OP_BOR</a></li>
                <li>
                    <a href="#op_bxor" aria-label="OP_BXOR">OP_BXOR</a></li>
                <li>
                    <a href="#op_shl" aria-label="OP_SHL">OP_SHL</a></li>
                <li>
                    <a href="#op_shl-1" aria-label="OP_SHL">OP_SHL</a></li>
                <li>
                    <a href="#%e5%89%8d%e9%9d%a2%e7%ae%97%e6%9c%af%e5%92%8c%e4%bd%8d%e8%bf%90%e7%ae%97%e5%a4%b1%e8%b4%a5%e5%b0%9d%e8%af%95%e8%b0%83%e7%94%a8c%e5%b1%82%e5%85%83%e6%96%b9%e6%b3%95" aria-label="前面算术和位运算失败尝试调用C层元方法">前面算术和位运算失败尝试调用C层元方法</a><ul>
                        
                <li>
                    <a href="#op_mmbin" aria-label="OP_MMBIN">OP_MMBIN</a></li>
                <li>
                    <a href="#op_mmbini" aria-label="OP_MMBINI">OP_MMBINI</a></li>
                <li>
                    <a href="#op_mmbink" aria-label="OP_MMBINK">OP_MMBINK</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%80%e5%85%83%e8%bf%90%e7%ae%97" aria-label="一元运算">一元运算</a><ul>
                        
                <li>
                    <a href="#op_unm" aria-label="OP_UNM">OP_UNM</a></li>
                <li>
                    <a href="#op_bnot" aria-label="OP_BNOT">OP_BNOT</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%bb%e8%be%91%e8%bf%90%e7%ae%97" aria-label="逻辑运算">逻辑运算</a><ul>
                        
                <li>
                    <a href="#op_not" aria-label="OP_NOT">OP_NOT</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%91%a8%e8%be%b9%e6%93%8d%e4%bd%9c" aria-label="周边操作">周边操作</a><ul>
                        
                <li>
                    <a href="#op_len" aria-label="OP_LEN">OP_LEN</a></li>
                <li>
                    <a href="#op_concat" aria-label="OP_CONCAT">OP_CONCAT</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b3%e9%97%ad%e4%b8%8a%e5%80%bc" aria-label="关闭上值">关闭上值</a><ul>
                        
                <li>
                    <a href="#op_close" aria-label="OP_CLOSE">OP_CLOSE</a></li></ul>
                </li>
                <li>
                    <a href="#tbc%e5%8f%98%e9%87%8f" aria-label="tbc变量">tbc变量</a><ul>
                        
                <li>
                    <a href="#op_tbc" aria-label="OP_TBC">OP_TBC</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e6%94%af%e4%b8%8e%e8%b7%b3%e8%bd%ac" aria-label="分支与跳转">分支与跳转</a><ul>
                        
                <li>
                    <a href="#op_eq" aria-label="OP_EQ">OP_EQ</a></li>
                <li>
                    <a href="#op_lt" aria-label="OP_LT">OP_LT</a></li>
                <li>
                    <a href="#op_le" aria-label="OP_LE">OP_LE</a></li>
                <li>
                    <a href="#op_eqk" aria-label="OP_EQK">OP_EQK</a></li>
                <li>
                    <a href="#op_eqi" aria-label="OP_EQI">OP_EQI</a></li>
                <li>
                    <a href="#op_lti" aria-label="OP_LTI">OP_LTI</a></li>
                <li>
                    <a href="#op_lei" aria-label="OP_LEI">OP_LEI</a></li>
                <li>
                    <a href="#op_gti" aria-label="OP_GTI">OP_GTI</a></li>
                <li>
                    <a href="#op_gei" aria-label="OP_GEI">OP_GEI</a></li>
                <li>
                    <a href="#op_test" aria-label="OP_TEST">OP_TEST</a></li>
                <li>
                    <a href="#op_testset" aria-label="OP_TESTSET">OP_TESTSET</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8" aria-label="函数调用">函数调用</a><ul>
                        
                <li>
                    <a href="#op_call" aria-label="OP_CALL">OP_CALL</a></li>
                <li>
                    <a href="#op_tailcall" aria-label="OP_TAILCALL">OP_TAILCALL</a></li>
                <li>
                    <a href="#op_return" aria-label="OP_RETURN">OP_RETURN</a></li>
                <li>
                    <a href="#op_return0" aria-label="OP_RETURN0">OP_RETURN0</a></li>
                <li>
                    <a href="#op_return1" aria-label="OP_RETURN1">OP_RETURN1</a></li>
                <li>
                    <a href="#op_vararg" aria-label="OP_VARARG">OP_VARARG</a></li>
                <li>
                    <a href="#op_varargprep" aria-label="OP_VARARGPREP">OP_VARARGPREP</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#iabx%e6%93%8d%e4%bd%9c%e6%95%b0%e6%a8%a1%e5%bc%8f" aria-label="iABx操作数模式">iABx操作数模式</a><ul>
                        
                <li>
                    <a href="#op_loadk" aria-label="OP_LOADK">OP_LOADK</a></li>
                <li>
                    <a href="#op_loadkx" aria-label="OP_LOADKX">OP_LOADKX</a></li>
                <li>
                    <a href="#for%e5%be%aa%e7%8e%af" aria-label="for循环">for循环</a><ul>
                        
                <li>
                    <a href="#op_forloop" aria-label="OP_FORLOOP">OP_FORLOOP</a></li>
                <li>
                    <a href="#op_forprep" aria-label="OP_FORPREP">OP_FORPREP</a></li>
                <li>
                    <a href="#op_tforprep" aria-label="OP_TFORPREP">OP_TFORPREP</a></li>
                <li>
                    <a href="#op_tforcall" aria-label="OP_TFORCALL">OP_TFORCALL</a></li>
                <li>
                    <a href="#op_tforloop" aria-label="OP_TFORLOOP">OP_TFORLOOP</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8-1" aria-label="函数调用">函数调用</a><ul>
                        
                <li>
                    <a href="#op_closure" aria-label="OP_CLOSURE">OP_CLOSURE</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#iasbx%e6%93%8d%e4%bd%9c%e6%95%b0%e6%a8%a1%e5%bc%8f" aria-label="iAsBx操作数模式">iAsBx操作数模式</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e8%bd%bd" aria-label="加载">加载</a><ul>
                        
                <li>
                    <a href="#op_loadi" aria-label="OP_LOADI">OP_LOADI</a></li>
                <li>
                    <a href="#op_loadf" aria-label="OP_LOADF">OP_LOADF</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#iax%e6%93%8d%e4%bd%9c%e6%95%b0%e6%a8%a1%e5%bc%8f" aria-label="iAx操作数模式">iAx操作数模式</a><ul>
                        
                <li>
                    <a href="#%e9%a2%9d%e5%a4%96%e5%8f%82%e6%95%b0" aria-label="额外参数">额外参数</a><ul>
                        
                <li>
                    <a href="#op_extraarg" aria-label="OP_EXTRAARG">OP_EXTRAARG</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#isj%e6%93%8d%e4%bd%9c%e6%95%b0%e6%a8%a1%e5%bc%8f" aria-label="isJ操作数模式">isJ操作数模式</a><ul>
                        
                <li>
                    <a href="#%e5%88%86%e6%94%af%e4%b8%8e%e8%b7%b3%e8%bd%ac-1" aria-label="分支与跳转">分支与跳转</a><ul>
                        
                <li>
                    <a href="#op_jmp" aria-label="OP_JMP">OP_JMP</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%8c%87%e4%bb%a4%e5%b1%9e%e6%80%a7%e7%9a%84%e6%8e%a9%e7%a0%81" aria-label="指令属性的掩码">指令属性的掩码</a></li>
                <li>
                    <a href="#%e6%8c%87%e4%bb%a4%e7%9a%84%e5%88%9b%e5%bb%ba" aria-label="指令的创建">指令的创建</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%baabck%e6%8c%87%e4%bb%a4" aria-label="创建ABCK指令">创建ABCK指令</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%baabx%e6%8c%87%e4%bb%a4" aria-label="创建ABx指令">创建ABx指令</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%baax%e6%8c%87%e4%bb%a4" aria-label="创建Ax指令">创建Ax指令</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%basj%e6%8c%87%e4%bb%a4" aria-label="创建sJ指令">创建sJ指令</a></li></ul>
                </li>
                <li>
                    <a href="#luac%e5%91%bd%e4%bb%a4" aria-label="luac命令">luac命令</a><ul>
                        
                <li>
                    <a href="#luac54--l-helloworldlua%e5%91%bd%e4%bb%a4" aria-label="luac54 -l Helloworld.lua命令">luac54 -l Helloworld.lua命令</a></li>
                <li>
                    <a href="#luac54--l--l-helloworldlua" aria-label="luac54 -l -l Helloworld.lua">luac54 -l -l Helloworld.lua</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="指令集简介"><span>指令集简介</span></h2>
<ul>
<li>
<p><code>Lua</code>虚拟机采用定长指令,每条指令占<code>4</code>个字节</p>
</li>
<li>
<p><code>Lua 5.4</code>将操作码扩展到了第<code>7</code>位总共能够容纳<code>128</code>条指令,现在定义了<code>83</code>条</p>
<p><img loading="lazy" src="image-20230226165405507.png" alt="image-20230226165405507"  />
</p>
</li>
</ul>
<h2 id="操作数编码模式一共5中"><span>操作数编码模式一共5中</span></h2>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#cdcd00">enum</span> OpMode {iABC, iABx, iAsBx, iAx, isJ};
</span></span></code></pre></div><p><img loading="lazy" src="image-20230223204632470.png" alt="image-20230223204632470"  />
</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>i</td>
<td>instruction 指令的意思</td>
</tr>
<tr>
<td>A</td>
<td>指令1参数 一般用作目标寄存器索引</td>
</tr>
<tr>
<td>B</td>
<td>指令2参数 既可以是寄存器索引,也可以是常量池索引</td>
</tr>
<tr>
<td>C</td>
<td>指令3参数 既可以是寄存器索引,也可以是常量池索引</td>
</tr>
<tr>
<td>k</td>
<td>一bit标志位 比如 标志位k为1表示常量池索引,否则表示寄存器索引</td>
</tr>
<tr>
<td>x</td>
<td>extended 扩展的意思</td>
</tr>
<tr>
<td>s</td>
<td>signed 符号 该参数应该被解释为有符号整数</td>
</tr>
<tr>
<td>sJ</td>
<td>表示跳转的PC偏移量</td>
</tr>
<tr>
<td>sBx</td>
<td>sbx表示的是一个有符号的数,也就是sbx可以是负数</td>
</tr>
<tr>
<td>bx</td>
<td>bx是一个无符号整数</td>
</tr>
<tr>
<td>Ax</td>
<td>做参数扩展使用,只能和别的指令搭配使用,比如LOADKX指令</td>
</tr>
</tbody>
</table>
<p><strong>基于CPU寄存器架构</strong></p>
<p><img loading="lazy" src="image-20230223215246031.png" alt="image-20230223215246031"  />
</p>
<p>从上面我们可以看出这些寄存器组件是和<code>CPU</code>捆绑在一块的,所以跨平台和兼容性就很差,但是因为是直接在<code>CPU</code>上直接对数据进行运算,所以速度很快</p>
<p><strong>Lua虚拟机栈</strong></p>
<p><img loading="lazy" src="image-20230226001738964.png" alt="image-20230226001738964"  />
</p>
<p><img loading="lazy" src="image-20230224114012173.png" alt="image-20230224114012173"  />
</p>
<ul>
<li>
<p>从上图中我们能看出<code>Lua</code>的寄存器是基于虚拟机的,但是这些寄存器和CPU寄存器是不一样的东西和<code>CPU</code>是没有任何关联,如果有关联的话,因为<code>CPU</code>的每个平台使用的架构不一样,会导致<code>Lua</code>失去移植和兼容性,所以<code>Lua</code>使用了一个栈来保存这些寄存器,同时每一个运行的函数都有自己的活动数据,单独的寄存器数量,同时在<code>Lua5.4.4</code>中也规定了每个函数最大的寄存器个数是<code>255</code>个</p>
</li>
<li>
<p>也可以看出我们的指令其实都是存在了<code>Proto</code>结构体里面的<code>code</code>字段</p>
</li>
<li>
<p>由于<code>Lua</code>有如此大量的寄存器,所以在预编译时能够将所有的<code>局部变量</code>存放到寄存器中,因为寄存器数据是在栈中,<code>upvalue</code>变量存放在链表中,<code>global</code>变量存放在全局的表中也可以说是在<code>env</code>表中</p>
<p>效率从大到小:<code>local &gt; upvalue &gt; global</code></p>
</li>
<li>
<p>所以一般都会使用如下面的定义方式来提高效率,毕竟这样做省去调用时再去全局表中,上值链表中查找的开销,同时生成的指令也会减少很多</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> sin <span style="color:#39c">=</span> math.sin  
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> table_remove_f <span style="color:#39c">=</span> table_t.remove
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> table_insert_f <span style="color:#39c">=</span> table_t.insert
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> table_unpack_f <span style="color:#39c">=</span> table_t.unpack
</span></span></code></pre></div></li>
</ul>
<h3 id="看指令前的一些符号解释"><span>看指令前的一些符号解释</span></h3>
<table>
<thead>
<tr>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>R(x)</td>
<td>一定是寄存器索引 一定会访问<code>Lua</code>栈</td>
</tr>
<tr>
<td>Kst(x)</td>
<td>一定是常量索引 一定会访问常量表</td>
</tr>
<tr>
<td>RK(x)</td>
<td>可能是常量索引也有可能是寄存器索引,取决于索引<code>k</code>的类型</td>
</tr>
<tr>
<td>立即数</td>
<td>立即数就是写在指令里的常数.用<code>CPU架构</code>下的<code>mov</code>指令举例子,<code>mov 12, %rax</code><br />那么这个 <code>12</code> 就在操作语句里.那么 <code>12</code> 相当于指令里的立即数,<br /><code>lua</code>中的指令也类似,直接从指令参数中加载的整数和浮点数就是立即数</td>
</tr>
<tr>
<td>PC</td>
<td>程序指令计数器,主要是为了计算指令的相对位置用的</td>
</tr>
<tr>
<td>Upvalue[n]</td>
<td>下标索引为n的上值</td>
</tr>
</tbody>
</table>
<h3 id="iabc操作数模式"><span>iABC操作数模式</span></h3>
<p><img loading="lazy" src="image-20230225184020461.png" alt="image-20230225184020461"  />
</p>
<p>首先这个指令和<code>lua5.4</code>版本之前的<code>lua</code>表达方式不一样<code>,lua5.4</code>使用<code>k</code>位来表示<code>B,C</code>两位到底是寄存器索引[其实就是栈索引],还是常量池索引</p>
<ul>
<li><code>k</code>:<code>1</code>表示常量池索引 <code>0</code>表示寄存器索引</li>
<li><code>B,C</code>:上面的<code>k</code>值决定是寄存器索引[其实就是栈索引],还是常量池索引</li>
<li><code>A</code>:目标索引</li>
</ul>
<p>占用<code>bit</code>位范围</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>范围(单位bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Op(7)</td>
<td>0~6</td>
</tr>
<tr>
<td>A(8)</td>
<td>7~14</td>
</tr>
<tr>
<td>k(1)</td>
<td>15</td>
</tr>
<tr>
<td>B(8)</td>
<td>16~23</td>
</tr>
<tr>
<td>C(8)</td>
<td>24~31</td>
</tr>
</tbody>
</table>
<h4 id="赋值加载指令"><span>赋值加载指令</span></h4>
<h5 id="op_move"><span>OP_MOVE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B  R[A] := R[B]</code> <code>将B寄存器的值赋值给A寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> B <span style="color:#39c">=</span> <span style="color:#cd00cd">10</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> A <span style="color:#39c">=</span> B
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>CA2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>    <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">10</span> <span style="">将整型立即数</span><span style="color:#cd00cd">10</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>  <span style="">将</span>(<span style="">寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>)<span style="">上面的局部变量</span>B<span style="">的值付给</span>(<span style="">寄存器的</span><span style="color:#cd00cd">1</span><span style="">号位置</span>)<span style="">上面局部变量</span>A
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out <span style="">返回</span><span style="color:#cd00cd">0</span><span style="">个值</span>
</span></span></code></pre></div><p>上面步骤大概意思是</p>
<p>在编译过程,<code>Lua</code>会将每个<code>local</code>变量都分配到一个指定的寄存器中,比如局部变量<code>B</code>分配到寄存器<code>0</code>号位置,局部变量<code>A</code>分配到寄存器<code>1</code>号位置</p>
<ol>
<li>然后执行<code>VARARGPREP</code>指令查看下可变参数方式下的固定参数数量</li>
<li>调用<code>LOADI</code>执行将整型立即数<code>10</code>加载到寄存器<code>0</code>号位置</li>
<li>调用<code>MOVE</code>将<code>寄存器的0号位置</code>上面的局部变量B的值付给<code>寄存器的1号位置</code>上面局部变量<code>A</code></li>
<li><code>0 out</code> 的意思是返回<code>0</code>个值</li>
</ol>
</li>
</ul>
<h5 id="op_loadfalse"><span>OP_LOADFALSE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A	R[A] := false</code> <code>加载false到寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cdcd00">false</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">00</span>F32290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span> <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADFALSE       <span style="color:#cd00cd">0</span> <span style="">将</span>false<span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_lfalseskip"><span>OP_LFALSESKIP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A	R[A] := false; pc++	(*)</code> <code>加载false到寄存器,同时跳过下一条指令</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span> <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">2</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span> <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="">将立即整数</span><span style="color:#cd00cd">2</span><span style="">加载到寄存器</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LTI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">1</span> <span style="">比较大小</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">进行跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>	<span style="">加载</span>false<span style="">到寄存器</span>,<span style="">同时跳过下一条指令</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span> 	<span style="">加载</span>true<span style="">到寄存器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_loadtrue"><span>OP_LOADTRUE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A	R[A] := true</code> <code>加载true到寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cdcd00">true</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">014</span>C2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>  <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>  <span style="">将</span>true<span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_loadnil"><span>OP_LOADNIL</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B	R[A], R[A+1], ..., R[A+B] := nil</code> <code>将序号[A,A+B]连续B+1个寄存器设置成nil值,用于加载nil到一批寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a1 <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a2 <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a3 <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a4 <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">015422</span>A0)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">5</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">5</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADNIL         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">4</span>     ; <span style="color:#cd00cd">5</span> out <span style="">将序号</span>[A:<span style="color:#cd00cd">0</span>,A:<span style="color:#cd00cd">0</span><span style="color:#39c">+</span>B:<span style="color:#cd00cd">4</span>]<span style="">连续</span>B:<span style="color:#cd00cd">4</span><span style="color:#39c">+</span><span style="color:#cd00cd">1</span><span style="">个寄存器设置成</span>nil<span style="">值</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_getupval"><span>OP_GETUPVAL</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B	R[A] := UpValue[B]</code> <code>读取一个上值到寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> test() 
</span></span><span style="display:flex;"><span>	a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> a 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">01542290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADNIL         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">5</span>]     CLOSURE         <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">01543</span>CB8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">2,5&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">01543</span>CB8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">3</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     SETUPVAL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; a
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">4</span>]     GETUPVAL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; a <span style="">把当前闭包的</span>B:<span style="color:#cd00cd">0</span><span style="">位置的值拷贝到目标寄存器</span>A:<span style="color:#cd00cd">0</span><span style="">中</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">4</span>]     RETURN1         <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<h5 id="op_setupval"><span>OP_SETUPVAL</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B	UpValue[B] := R[A]</code> <code>写一个寄存器值到上值</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> test() 
</span></span><span style="display:flex;"><span>	a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> a 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">01542290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADNIL         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">5</span>]     CLOSURE         <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">01543</span>CB8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">2,5&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">01543</span>CB8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">3</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     SETUPVAL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; a <span style="">把当前寄存器</span>A:<span style="color:#cd00cd">0</span><span style="">位置的值设置到</span>B:<span style="color:#cd00cd">0</span><span style="">位置并做为闭包的上值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">4</span>]     GETUPVAL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; a 
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">4</span>]     RETURN1         <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<h4 id="表操作"><span>表操作</span></h4>
<h5 id="op_gettabup"><span>OP_GETTABUP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	R[A] := UpValue[B][K[C]:string]</code> <code>从表取值到寄存器,表在upvalue</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>global_var <span style="color:#39c">=</span> <span style="color:#cd00cd">40</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> local_var <span style="color:#39c">=</span> global_var
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">012</span>C2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">2</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>k  ; _ENV <span style="color:#cd0000">&#34;global_var&#34;</span> <span style="color:#cd00cd">40</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;global_var&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">0</span><span style="">的</span>(<span style="">即</span>global_var),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">0</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p><code>OP_GETTABUP</code>和与<code>OP_GETTABLE</code>指令相似,只是表被引用为上值.这些指令用于访问全局变量,是通过名为<code>_ENV</code>的上值访问的</p>
</li>
</ul>
<h5 id="op_gettable"><span>OP_GETTABLE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	R[A] := R[B][R[C]]</code> <code>将寄存器B位置的表t,下标为key为C里面的内容拷贝到寄存器A上</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> k <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> ra <span style="color:#39c">=</span> t[k]
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">01202290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">2</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">1</span><span style="">的</span>(<span style="">即</span>t),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">1</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     GETTABLE        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>    <span style="">将寄存器</span>B:<span style="color:#cd00cd">1</span><span style="">位置的表</span>t,<span style="">下标为</span>key<span style="">为</span>C:<span style="color:#cd00cd">0</span><span style="">里面的内容拷贝到寄存器</span>A:<span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_geti"><span>OP_GETI</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	R[A] := R[B][C]	</code> <code>从表取key为整型的内容给寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> t[<span style="color:#cd00cd">2</span>]
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">01492290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">0</span><span style="">的</span>(<span style="">即</span>t),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">0</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="">将寄存器</span>B:<span style="color:#cd00cd">0</span><span style="">位置的表</span>t,<span style="">下标为</span>key<span style="">为立即整数</span><span style="color:#cd00cd">2</span><span style="">里面的内容拷贝到寄存器</span>A:<span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_getfield"><span>OP_GETFIELD</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	R[A] := R[B][K[C]:string]</code> <code>从表取key为字符串的内容给寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> ra <span style="color:#39c">=</span> t[<span style="color:#cd0000">&#34;11&#34;</span>]
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>AC2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">2</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span>  <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">0</span><span style="">的</span>(<span style="">即</span>t),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">0</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETFIELD        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd0000">&#34;11&#34;</span> <span style="">将寄存器</span>B:<span style="color:#cd00cd">0</span><span style="">位置的表</span>t,<span style="">下标为</span>key<span style="">为</span>C:<span style="color:#cd00cd">1</span><span style="">的内容拷贝到寄存器</span>A:<span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_settabup"><span>OP_SETTABUP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	UpValue[A][K[B]:string] := RK(C)</code> <code>设置寄存器值给表元素,表在upvalue</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>global_var <span style="color:#39c">=</span> <span style="color:#cd00cd">40</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> local_var <span style="color:#39c">=</span> global_var
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">012</span>C2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">2</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>k  ; _ENV <span style="color:#cd0000">&#34;global_var&#34;</span> <span style="color:#cd00cd">40</span> <span style="">将常量表中</span>Key<span style="">为</span>C:<span style="color:#cd00cd">1</span><span style="">上的值</span><span style="color:#cd00cd">40</span>  <span style="">赋值给寄存器</span>A:<span style="color:#cd00cd">0</span><span style="">上的上值表</span>key<span style="">为</span>B:<span style="color:#cd00cd">0</span><span style="">的上值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;global_var&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">0</span><span style="">的</span>(<span style="">即</span>global_var),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">0</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_newtable"><span>OP_NEWTABLE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C k	R[A] := {}</code> <code>新建一个表</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> t <span style="color:#39c">=</span> {}
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>A522A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     NEWTABLE        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">0</span> <span style="">创建一个空表</span>,<span style="">并将空表放到寄存器</span>A:<span style="color:#cd00cd">0</span><span style="">位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     EXTRAARG        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_self"><span>OP_SELF</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C	R[A+1] := R[B]; R[A] := R[B][RK(C):string]</code> <code>准备一个对象方法的调用</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>foo:getLua(<span style="color:#cd0000">&#34;lua&#34;</span>)
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">012E2290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SELF            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd0000">&#34;getLua&#34;</span> <span style="">把寄存器中对象</span>B:<span style="color:#cd00cd">0</span>(<span style="">即</span>foo)<span style="">和常量表中方法</span>C:<span style="color:#cd00cd">1</span>(<span style="">即</span>getLua)<span style="">拷贝到相邻的两个目标寄存器中</span>,<span style="">相邻目标的其实位置由</span>A:<span style="color:#cd00cd">0</span><span style="">决定</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     LOADK           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span>     ; <span style="color:#cd0000">&#34;lua&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><ul>
<li>
<p>上面方法<code>foo:getLua(&quot;lua&quot;)</code>调用相当于<code>foo.getLua(foo,&quot;lua&quot;)</code>,让全局<code>foo</code>只被查找一次,下面在介绍下没有<code>self</code>指令情况下的情况</p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>foo.getLua(foo,<span style="color:#cd0000">&#34;lua&#34;</span>)
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">008</span>F2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETFIELD        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd0000">&#34;getLua&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">1</span><span style="">的</span>(<span style="">即</span>getLua),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">0</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;foo&#34;</span> <span style="">将</span>upvalues<span style="">表索引为</span>B:<span style="color:#cd00cd">0</span><span style="">的</span>upvalue(<span style="">即：</span>_ENV)<span style="">中</span>key<span style="">为常量表索引为</span>C:<span style="color:#cd00cd">0</span><span style="">的</span>(<span style="">即</span><span style="color:#cd0000">&#34;foo&#34;</span>),<span style="">放到寄存器索引为</span>A:<span style="color:#cd00cd">1</span><span style="">的地方</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LOADK           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span>     ; <span style="color:#cd0000">&#34;lua&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>从对两个函数进行指令集对比以后我们可以看出<code>foo:getLua(&quot;lua&quot;)</code>函数的第3行的</p>
<p><code>   3       [1]     SELF            0 0 1k  ; &quot;getLua&quot;</code></p>
<p>和</p>
<p><code>foo.getLua(foo,&quot;lua&quot;)</code>函数第<code>3,4</code>行</p>
<p><code> 3       [1]     GETFIELD        0 0 1   ; &quot;getLua&quot;</code></p>
<p><code> 4       [1]     GETTABUP        1 0 0   ; _ENV &quot;foo&quot;</code></p>
<p>等价</p>
</li>
<li>
<p>所以综合来说<code>SELF</code>指令节省了额外的指令,并加快了面向对象编程中方法的调用.但是它只为使用冒号语法的方法调用生成服务</p>
</li>
</ul>
</li>
</ul>
<h5 id="op_setlist"><span>OP_SETLIST</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A B C k R[A][C+i] := R[A+i], 1 &lt;= i &lt;= B</code> <code>给表设置一批数组元素</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> q <span style="color:#39c">=</span> {<span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>,<span style="color:#cd00cd">3</span>,<span style="color:#cd00cd">4</span>,<span style="color:#cd00cd">5</span>}
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">10</span> instructions at <span style="color:#cd00cd">01572290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">6</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     NEWTABLE        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     EXTRAARG        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">4</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">1</span>]     SETLIST         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">0</span> <span style="">这里的</span><span style="color:#cd00cd">5</span><span style="">就是数组数量</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>如果需要写入数组的一系列值并且是紧挨着数组则数量由操作数<code>B</code>指定,数组起始索引则由操作<code>C</code>指定</p>
<p>其实这么做也是为了省指令条数,只需要一条指令<code>OP_SETLIST</code>就够了</p>
</li>
</ul>
<h4 id="算术和位运算"><span>算术和位运算</span></h4>
<h5 id="op_addi"><span>OP_ADDI</span></h5>
<p><code>公式</code>:<code>A B sC	R[A] := R[B] + sC</code> <code>立即数加</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">+</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00812290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     ADDI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="">立即数相加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINI          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">0</span> ; __add
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_addk"><span>OP_ADDK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] + K[C]:number</code> <code>常量加</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">+</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">007</span>B2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     ADDK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">0</span> ; __add <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_subk"><span>OP_SUBK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] - K[C]:number</code> <code>常量减</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">-</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>DB2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SUBK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量减</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">0</span> ; __sub <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_mulk"><span>OP_MULK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] * K[C]:number</code> <code>常量乘</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">*</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">015</span>D2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     MULK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量乘</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">0</span> ; __mul <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_modk"><span>OP_MODK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] % K[C]:number</code> <code>常量模</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">%</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">01732290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     MODK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量模</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">9</span> <span style="color:#cd00cd">0</span> ; __mod <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_divk"><span>OP_DIVK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] / K[C]:number</code> <code>常量除</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">/</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">008E2298</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     DIVK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量除</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">11</span> <span style="color:#cd00cd">0</span>        ; __div <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_idivk"><span>OP_IDIVK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] // K[C]:number</code> <code>常量整除</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">//</span> <span style="color:#cd00cd">5.0</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>BB2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     IDIVK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5.0</span> <span style="">常量整除</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">12</span> <span style="color:#cd00cd">0</span>        ; __idiv <span style="color:#cd00cd">5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bandk"><span>OP_BANDK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] &amp; K[C]:integer</code> <code>常量与</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">&amp;</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>C22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     BANDK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5</span> <span style="">常量与</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">13</span> <span style="color:#cd00cd">0</span>        ; __band <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bork"><span>OP_BORK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] | K[C]:integer</code> <code>常量或</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">|</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00832428</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     BORK            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5</span> <span style="">常量或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">14</span> <span style="color:#cd00cd">0</span>        ; __bor <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bxork"><span>OP_BXORK</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] ~ K[C]:integer	</code> <code>常量异或</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">~</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">009E2290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     BXORK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5</span> <span style="">常量异或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">15</span> <span style="color:#cd00cd">0</span>        ; __bxor <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_shri"><span>OP_SHRI</span></h5>
<p><code>公式</code>:<code>A B sC	R[A] := R[B] &gt;&gt; sC	</code> <code>立即数右移</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">&gt;&gt;</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">007625</span>B8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SHRI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="">立即数右移</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINI          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">17</span> <span style="color:#cd00cd">0</span>        ; __shr
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_shli"><span>OP_SHLI</span></h5>
<p><code>公式</code>:<code>A B sC	R[A] := sC &lt;&lt; R[B]	</code> <code>立即数左移</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">+</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>A22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SHLI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="">立即数左移</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINI          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">16</span> <span style="color:#cd00cd">1</span>        ; __shl flip
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_add"><span>OP_ADD</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] + R[C]	</code> <code>加</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">+</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>ED22A0)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     ADD             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">6</span>   ; __add
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_sub"><span>OP_SUB</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] - R[C]	</code> <code>减</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">-</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>FC22A0)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     SUB             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">减</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">7</span>   ; __sub
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_mul"><span>OP_MUL</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] * R[C]	</code> <code>乘</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">*</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>EF2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     MUL             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">乘</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">8</span>   ; __mul
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_mod"><span>OP_MOD</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] % R[C]	</code> <code>模</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">%</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">01102290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     MOD             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">模</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">9</span>   ; __mod
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_pow"><span>OP_POW</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] ^ R[C]	</code> <code>幂</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">^</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">006</span>F2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     POW             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">幂</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">10</span>  ; __pow
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_div"><span>OP_DIV</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] / R[C]	</code> <code>浮点除</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">/</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">008</span>B2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     DIV             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">浮点除</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">11</span>  ; __div
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_idiv"><span>OP_IDIV</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] // R[C]	</code> <code>整除</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">//</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">011</span>A22A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     IDIV            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">整除</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">12</span>  ; __idiv
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_band"><span>OP_BAND</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] &amp; R[C]	</code> <code>位与</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">&amp;</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>C32290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     BAND            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">位与</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">13</span>  ; __band
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bor"><span>OP_BOR</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] | R[C]	</code> <code>位或</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">|</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>D422A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     BOR             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">位或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">14</span>  ; __bor
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bxor"><span>OP_BXOR</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] ~ R[C]	</code> <code>位异或</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">~</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">01592748</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     BXOR            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">位异或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">15</span>  ; __bxor
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_shl"><span>OP_SHL</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] &lt;&lt; R[C]	</code> <code>左移</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">&lt;&lt;</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">015</span>F2280)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     SHL             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">左移</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">16</span>  ; __shl
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_shl-1"><span>OP_SHL</span></h5>
<p><code>公式</code>:<code>A B C	R[A] := R[B] &gt;&gt; R[C]	</code> <code>右移</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">&gt;&gt;</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>D72290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     SHR             <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">右移</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">17</span>  ; __shr
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="前面算术和位运算失败尝试调用c层元方法"><span>前面算术和位运算失败尝试调用C层元方法</span></h5>
<h6 id="op_mmbin"><span>OP_MMBIN</span></h6>
<p><code>公式</code>:<code>A B C	call C metamethod over R[A] and R[B]	(*)</code> <code>位异或失败以后调用C元方法</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">~</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">01592748</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     BXOR            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="">位异或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MMBIN           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">15</span>  ; __bxor <span style="">位异或失败了就会去调用</span>__bxor<span style="">元方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h6 id="op_mmbini"><span>OP_MMBINI</span></h6>
<p><code>公式</code>:<code>A B sC	R[A] := sC &lt;&lt; R[B]	</code> <code>立即数左移失败以后调用C元方法</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> a <span style="color:#39c">+</span> b
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>A22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SHLI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="">立即数左移</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINI          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">16</span> <span style="color:#cd00cd">1</span>        ; __shl flip <span style="">立即数左移失败了就会去调用</span>__shl<span style="">元方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h6 id="op_mmbink"><span>OP_MMBINK</span></h6>
<p><code>公式</code>:<code>A B C k   call C metamethod over R[A] and K[B]</code> <code>常量异或失败以后调用C元方法</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a,b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span> a <span style="color:#39c">=</span> a <span style="color:#39c">~</span> <span style="color:#cd00cd">5</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">009E2290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     BXORK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">5</span> <span style="">常量异或</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     MMBINK          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">15</span> <span style="color:#cd00cd">0</span>        ; __bxor <span style="color:#cd00cd">5</span> <span style="">常量异或失败了就会去调用</span>__bxor<span style="">元方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="一元运算"><span>一元运算</span></h4>
<h5 id="op_unm"><span>OP_UNM</span></h5>
<p><code>公式</code>:<code>A B	R[A] := -R[B]</code> <code>一元减</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#39c">-</span>a
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">009722</span>B8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     UNM             <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="">一元减</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_bnot"><span>OP_BNOT</span></h5>
<p><code>公式</code>:<code>A B	R[A] := ~R[B]</code> <code>位非</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#39c">~</span>a
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>CB2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     BNOT            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="">位非</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="逻辑运算"><span>逻辑运算</span></h4>
<h5 id="op_not"><span>OP_NOT</span></h5>
<p><code>公式</code>:<code>A B	R[A] := not R[B]</code> <code>逻辑取反</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cdcd00">not</span>(a)
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>A12290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     NOT             <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="">逻辑取反</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="周边操作"><span>周边操作</span></h4>
<h5 id="op_len"><span>OP_LEN</span></h5>
<p><code>公式</code>:<code>A B	R[A] := #R[B] (length operator)</code> <code>取长度</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#39c">#</span>a
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00952290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LEN             <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="">取长度</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_concat"><span>OP_CONCAT</span></h5>
<p><code>公式</code>:<code>A B	R[A] := R[A].. ... ..R[A + B - 1]</code> <code>拼接对象</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> a <span style="color:#39c">..</span> <span style="color:#cd00cd">22</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>D122A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">22</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     CONCAT          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span> <span style="">拼接对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="关闭上值"><span>关闭上值</span></h4>
<h5 id="op_close"><span>OP_CLOSE</span></h5>
<p><code>公式</code>:<code>A	close all upvalues &gt;= R[A]</code> <code>关闭上值</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> testvar
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">function</span> fun( ... )
</span></span><span style="display:flex;"><span>		testvar <span style="color:#39c">=</span> <span style="color:#cd00cd">22222</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">01172290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">2</span>]     LOADNIL         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">5</span>]     CLOSURE         <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">01173</span>D38
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;fun&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     CLOSE           <span style="color:#cd00cd">0</span>    <span style="">关闭上值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">7</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">3,5&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">01173</span>D38)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">3</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">4</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">22222</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">4</span>]     SETUPVAL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; testvar
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="tbc变量"><span>tbc变量</span></h4>
<h5 id="op_tbc"><span>OP_TBC</span></h5>
<p><code>公式</code>:<code>A	mark variable A &quot;to be closed&quot;</code> <code>标记寄存器为tbc</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span> <span style="color:#00cd00">local</span> tt<span style="color:#39c">&lt;</span>close<span style="color:#39c">&gt;</span> <span style="color:#39c">=</span> t;
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">011</span>C2428)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     TBC             <span style="color:#cd00cd">0</span>  <span style="">标记寄存器为</span>tbc
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="分支与跳转"><span>分支与跳转</span></h4>
<h5 id="op_eq"><span>OP_EQ</span></h5>
<ul>
<li>
<p><code>OP_EQ</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A B k	if ((R[A] == R[B]) ~= k) then pc++</code> <code>相等测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a<span style="color:#39c">==</span>b
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">8</span> instructions at <span style="color:#cd00cd">016</span>F2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     EQ              <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">比较相等</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">7</span> <span style="">不满足条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     LFALSESKIP      <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">3</span>]     LOADTRUE        <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_lt"><span>OP_LT</span></h5>
<ul>
<li>
<p><code>OP_LT</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A B k	if ((R[A] &lt;  R[B]) ~= k) then pc++</code> <code>小于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&lt;</span> b
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">8</span> instructions at <span style="color:#cd00cd">00782290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     LT              <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">比较小于</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">7</span> <span style="">不满足条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     LFALSESKIP      <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">3</span>]     LOADTRUE        <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_le"><span>OP_LE</span></h5>
<ul>
<li>
<p><code>OP_LE</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A B k	if ((R[A] &lt;= R[B]) ~= k) then pc++</code> <code>小于等于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&lt;=</span> b
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">8</span> instructions at <span style="color:#cd00cd">00</span>BA2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     LE              <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">比较小于等于</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">7</span> <span style="">不满足条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     LFALSESKIP      <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">3</span>]     LOADTRUE        <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_eqk"><span>OP_EQK</span></h5>
<ul>
<li>
<p><code>OP_EQK</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A B k	if ((R[A] == K[B]) ~= k) then pc++</code> <code>常量相等测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">==</span> <span style="color:#cd0000">&#34;1&#34;</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">01622290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">2</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     EQK             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd0000">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_eqi"><span>OP_EQI</span></h5>
<ul>
<li>
<p><code>OP_EQI</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A sB k	if ((R[A] == sB) ~= k) then pc++</code> <code>立即数相等测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">==</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00802290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     EQI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">立即数相等测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不相等跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_lti"><span>OP_LTI</span></h5>
<ul>
<li>
<p><code>OP_LTI</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A sB k	if ((R[A] &lt; sB) ~= k) then pc++</code> <code>立即数小于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&lt;</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00</span>FF2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LTI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">立即数小于测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不符合条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_lei"><span>OP_LEI</span></h5>
<ul>
<li>
<p><code>OP_LEI</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A sB k	if ((R[A] &lt;= sB) ~= k) then pc++</code> <code>立即数小于等于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&lt;=</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00</span>CE2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LEI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">立即数小于等于测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不符合条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_gti"><span>OP_GTI</span></h5>
<ul>
<li>
<p><code>OP_GTI</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A sB k	if ((R[A] &gt; sB) ~= k) then pc++</code> <code>立即数大于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">01142290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GTI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">立即数大于测试</span>,<span style="">条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不符合条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_gei"><span>OP_GEI</span></h5>
<ul>
<li>
<p><code>OP_GEI</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A sB k	if ((R[A] &gt;= sB) ~= k) then pc++</code> <code>立即数大于等于测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#39c">&gt;=</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00</span>C72290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GEI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="">立即数大于等于测试</span>,<span style="">条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不符合条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_test"><span>OP_TEST</span></h5>
<ul>
<li>
<p><code>OP_TEST</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>OP_TEST</code>逻辑指令用于实现 <code>and</code> 和 <code>or </code>逻辑运算符
如果相等则将<code>寄存器B</code>的值 赋给<code>寄存器 A</code>,然后继续执行,反之如果不相等,则跳过后面的 <code>JMP</code>指令</p>
</li>
<li>
<p><code>公式</code>:<code>A k	if (not R[A] == k) then pc++</code> <code>bool测试,条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#cdcd00">and</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#cdcd00">or</span> <span style="color:#cd00cd">1</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">10</span> instructions at <span style="color:#cd00cd">00</span>B82290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     TEST            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> and<span style="">运算符的测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不满足条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;a&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">2</span>]     TEST            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> or<span style="">运算符的测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">2</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">10</span> <span style="">不满足条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_testset"><span>OP_TESTSET</span></h5>
<ul>
<li>
<p><code>OP_TESTSET</code>分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>A B k	if (not R[B] == k) then pc++ else R[A] := R[B] (*)</code> <code>bool测试,条件跳转和赋值</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> a <span style="color:#cdcd00">and</span> b
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>A42290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADNIL         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>     ; <span style="color:#cd00cd">2</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">3</span>]     TESTSET         <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="">判断寄存器</span>B:<span style="color:#cd00cd">0</span><span style="">上面的值转成</span>bool<span style="">值后</span>,<span style="">是否和寄存器</span>C:<span style="color:#cd00cd">0</span><span style="">表示的</span>bool<span style="">值相等</span>
</span></span><span style="display:flex;"><span><span style="">如果结果一致</span>,<span style="">将寄存器</span>B:<span style="color:#cd00cd">0</span><span style="">上面的值复制到寄存器</span>A:<span style="color:#cd00cd">2</span><span style="">上面</span>,<span style="">否则条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">不符合条件跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     MOVE            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
<li>
<p>判断寄存器<code>B:0</code>上面的值转成<code>bool</code>值后,是否和寄存器<code>C:0</code>表示的<code>bool</code>值相等
如果结果一致,将寄存器<code>B:0</code>上面的值复制到寄存器<code>A:2</code>上面,否则条件跳转</p>
</li>
<li>
<p>不符合条件跳转</p>
</li>
</ul>
<h4 id="函数调用"><span>函数调用</span></h4>
<h5 id="op_call"><span>OP_CALL</span></h5>
<p><code>公式</code>:<code>A B C	R[A], ... ,R[A+C-2] := R[A](R[A+1], ... ,R[A+B-1]) </code> <code>函数调用</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> fun()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fun()
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00802290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00803</span>BE8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">5</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out <span style="">函数调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">1</span> instruction at <span style="color:#cd00cd">00803</span>BE8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">3</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<h5 id="op_tailcall"><span>OP_TAILCALL</span></h5>
<p><code>公式</code>:<code>A B C k	return R[A](R[A+1], ... ,R[A+B-1]) </code> <code>尾调用</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> fun1() 
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> fun2(<span style="color:#cd00cd">111</span>, <span style="color:#cd00cd">222</span>)
</span></span><span style="display:flex;"><span> <span style="color:#cdcd00">end</span>
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00E82290</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00E83</span>BE8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00E83</span>BE8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">111</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">222</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     TAILCALL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="">尾调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; all out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<p>因为调用<code>fun2</code>后,<code>fun1</code>中不再执行任何代码,所以不需要保留<code>fun1</code>的调用栈信息,<code>Lua</code>做了这样的优化,称为<code>尾调用消除</code>,<code>fun2</code>返回后,控制点直接返回到调用<code>fun1</code>的地方,有点类似<code>c</code>语言的<code>goto</code>语句,这样做能减少栈的空间消耗,非常<code>nice</code></p>
<h5 id="op_return"><span>OP_RETURN</span></h5>
<p><code>公式</code>:<code>A B C k	return R[A], ... ,R[A+B-2]	(see note) </code> <code>从函数调用返回</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> fun1() 
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">2</span>,<span style="color:#cd00cd">3</span>,<span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span> <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> x,y,z <span style="color:#39c">=</span> fun1()
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00E22280</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00E23</span>BD8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">5</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">4</span>   ; <span style="color:#cd00cd">0</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">3</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00E23</span>BD8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">4</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">2</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">0</span>   ; <span style="color:#cd00cd">4</span> out <span style="">返回</span><span style="color:#cd00cd">4</span><span style="">个参数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">3</span>]     RETURN0
</span></span></code></pre></div><ul>
<li>如果寄存器<code>B==0</code> 输出<code>all out</code></li>
<li>如果寄存器<code>B&gt;0</code> 输入<code>B-1</code>个返回值</li>
</ul>
</li>
</ul>
<h5 id="op_return0"><span>OP_RETURN0</span></h5>
<p><code>公式</code>:<code>return</code> <code>返回无结果</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> fun1() 
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span>
</span></span><span style="display:flex;"><span> <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> x <span style="color:#39c">=</span> fun1()
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>C32290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00</span>C33BE8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">5</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>   ; <span style="color:#cd00cd">0</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">2</span> instructions at <span style="color:#cd00cd">00</span>C33BE8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">2</span>]     RETURN0 <span style="">返回无结果</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     RETURN0 <span style="">返回无结果</span>
</span></span></code></pre></div></li>
</ul>
<h5 id="op_return1"><span>OP_RETURN1</span></h5>
<p><code>公式</code>:<code>A	return R[A]</code> <code>返回一个参数</code></p>
<ul>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> fun1() 
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span> <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> x <span style="color:#39c">=</span> fun1()
</span></span></code></pre></div></li>
<li>
<p><code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">6</span> instructions at <span style="color:#cd00cd">00</span>BA2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00</span>BA3BE8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">5</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;fun1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>   ; <span style="color:#cd00cd">0</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">5</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">00</span>BA3BE8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">2</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">2</span>]     RETURN1         <span style="color:#cd00cd">0</span> <span style="">返回</span><span style="color:#cd00cd">1</span><span style="">个值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">3</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<h5 id="op_vararg"><span>OP_VARARG</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A C	R[A], R[A+1], ..., R[A+C-2] = vararg</code> <code>将函数的可变参数拷贝给寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> ...
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">00</span>A92290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     VARARG          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>     ; <span style="color:#cd00cd">1</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<p>​		如果<code>寄存器C等于0</code>那么就输出<code>all out </code>否则输出 <code>c-1</code> <code>out</code></p>
<p>​		这个C里面的值就是<code>local a = ...</code> 等号前面局部变量的个数,比如现在只有一个局部变量<code>a</code>那么就是<code>1</code></p>
<h5 id="op_varargprep"><span>OP_VARARGPREP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A	(adjust vararg parameters)</code> <code>查看可变参数方式下固定参数个数</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> func(a,b, ...)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>F52290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00</span>F53BE8
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;func&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">2</span> instructions at <span style="color:#cd00cd">00</span>F53BE8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">2</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">2</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">2</span> <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">3</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<p>​	  因为<code>func</code>函数里面有<code>a,b</code>固定的两个固定变量,所以指令哪里可以看到是<code>2</code></p>
<h3 id="iabx操作数模式"><span>iABx操作数模式</span></h3>
<p><img loading="lazy" src="image-20230226110849907.png" alt="image-20230226110849907"  />
</p>
<p>占用<code>bit</code>位范围</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>范围(单位bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Op(7)</td>
<td>0~6</td>
</tr>
<tr>
<td>A(8)</td>
<td>7~14</td>
</tr>
<tr>
<td>Bx(17)</td>
<td>15~31</td>
</tr>
</tbody>
</table>
<h4 id="op_loadk"><span>OP_LOADK</span></h4>
<p><code>公式</code>:<code>A Bx	R[A] := K[Bx]</code> <code>加载常量立即数到寄存器</code></p>
<ul>
<li>
<p><code>lua</code>会将</p>
<ul>
<li>常量表达式</li>
<li>字符串</li>
<li>整型,浮点型超出寄存器<code>sBx</code>操作数值范围的数</li>
<li>等等</li>
</ul>
<p>都放到常量表中</p>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;lllllll&#34;</span> <span style="">字符串</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> b <span style="color:#39c">=</span> <span style="color:#cd00cd">333333333333333333333333333333333333333333333</span> <span style="">整型超出寄存器</span>sBx<span style="">操作数值</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> c <span style="color:#39c">=</span> <span style="color:#cd00cd">111111111111111111111111.111111111111111111111</span> <span style="">浮点数超出寄存器</span>sBx<span style="">操作数值</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">5</span> instructions at <span style="color:#cd00cd">00</span>F822A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">3</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">3</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADK           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd0000">&#34;lllllll&#34;</span> <span style="">从常量表</span><span style="color:#cd00cd">0</span><span style="">号位置中将</span><span style="color:#cd0000">&#34;lllllll&#34;</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     LOADK           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>     ; <span style="color:#cd00cd">3.3333333333333e+44</span> <span style="">从常量表</span><span style="color:#cd00cd">1</span><span style="">号位置将</span><span style="color:#cd00cd">3.3333333333333e+44</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">1</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     LOADK           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span>     ; <span style="color:#cd00cd">1.1111111111111e+23</span> <span style="">从常量表</span><span style="color:#cd00cd">2</span><span style="">号位置将</span><span style="color:#cd00cd">1.1111111111111e+23</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">2</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h4 id="op_loadkx"><span>OP_LOADKX</span></h4>
<p><code>公式</code>:<code>A	R[A] := K[extra arg]</code> <code>加载常量,常量从下一条OP_EXTRAARG指令得到</code></p>
<p>当需要生成<code>LOADK</code>指令时,如果需要索引的常量<code>id</code>超出了<code>Bx</code>所能表示的有效范围,那么就生成一个<code>LOADKX</code>指令,取代<code>LOADK</code>指令,并且接下来立即生成一个<code>EXTRAARG</code>指令,并用其<code>Ax</code>来存放这个<code>id</code></p>
<ul>
<li><code>Bx</code>的位数是<code>17</code>位,那么能标识的无符号最大值是<code>17</code>个<code>1</code> 也就是<code>2^17-1</code> = <code>262143</code>个索引</li>
<li><code>Ax</code>的位数是<code>25</code>位,那么能标识的无符号最大值是<code>25</code>个<code>1</code> 也就是<code>2^25-1</code> = <code>67108863</code>个索引</li>
<li>所以我们能得出结论<code>lua</code>常量表的索引能达到惊人的 <code>262143 + 67108863</code> = <code>67371006</code>个索引</li>
</ul>
<p>鉴于超级大的索引范围,这个就不弄lua示例代码了,大家知道只要超过262143的索引,就会触发<code>OP_LOADKX</code>指令,并用其<code>Ax</code>来存放这个超出范围的<code>id</code>就好了</p>
<h4 id="for循环"><span>for循环</span></h4>
<h5 id="op_forloop"><span>OP_FORLOOP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A Bx	update counters; if loop continues then pc-=Bx;</code> <code>数值for循环</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">for</span> i<span style="color:#39c">=</span><span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">100</span>,<span style="color:#cd00cd">10</span> <span style="color:#cdcd00">do</span>  <span style="color:#39c">//</span><span style="">初始值为</span><span style="color:#cd00cd">1</span>,<span style="">步长为</span><span style="color:#cd00cd">10</span>,<span style="">上限为</span><span style="color:#cd00cd">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00</span>A022A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">4</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">4</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     FORPREP         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; exit to <span style="color:#cd00cd">7</span> <span style="">数值</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     FORLOOP         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>     ; to <span style="color:#cd00cd">6</span> <span style="">数值</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><ol>
<li>
<p>该指令先给<code>i</code>加上步长,然后判断<code>i</code>是否在范围之内.若已经超出范围,则循环结束</p>
</li>
<li>
<p>若没超出范围,则将数值拷贝给用户定义的局部变量</p>
</li>
<li>
<p>然后跳转到循环体内部开始执行具体的代码块</p>
</li>
</ol>
</li>
</ul>
<h5 id="op_forprep"><span>OP_FORPREP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A Bx	&lt;check values and prepare counters&gt;; if not to run then pc+=Bx+1;</code>  数值for循环</p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">for</span> i<span style="color:#39c">=</span><span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">100</span>,<span style="color:#cd00cd">10</span> <span style="color:#cdcd00">do</span>  <span style="color:#39c">//</span><span style="">初始值为</span><span style="color:#cd00cd">1</span>,<span style="">步长为</span><span style="color:#cd00cd">10</span>,<span style="">上限为</span><span style="color:#cd00cd">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">7</span> instructions at <span style="color:#cd00cd">00</span>A022A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">4</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">4</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     FORPREP         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; exit to <span style="color:#cd00cd">7</span> <span style="">数值</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     FORLOOP         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>     ; to <span style="color:#cd00cd">6</span> <span style="">数值</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>该指令的目的是在循环之前预先将<code>i</code>减去步长得到<code>-1</code>,然后跳转到<code>FORLOOP</code>指令正式开始循环</p>
</li>
</ul>
<h5 id="op_tforprep"><span>OP_TFORPREP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A Bx	create upvalue for R[A + 3]; pc+=Bx</code> 除了通用for循环作用还兼顾关闭<code>upvalue</code>值</p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(t) <span style="color:#cdcd00">do</span> 
</span></span><span style="display:flex;"><span>    print(k,v) 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">13</span> instructions at <span style="color:#cd00cd">00</span>C22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">9</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">6</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;pairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">4</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     TFORPREP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">4</span>     ; to <span style="color:#cd00cd">10</span> <span style="">除了通用</span>for<span style="">循环作用还兼顾关闭`</span>upvalue<span style="">`值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>   ; _ENV <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">2</span>]     CALL            <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">1</span>]     TFORCALL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">11</span>      [<span style="color:#cd00cd">1</span>]     TFORLOOP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">6</span>     ; to <span style="color:#cd00cd">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">12</span>      [<span style="color:#cd00cd">3</span>]     CLOSE           <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">13</span>      [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h5 id="op_tforcall"><span>OP_TFORCALL</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A C	R[A+4], ... ,R[A+3+C] := R[A](R[A+1], R[A+2]);</code> 通用for循环</p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(t) <span style="color:#cdcd00">do</span> 
</span></span><span style="display:flex;"><span>    print(k,v) 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">13</span> instructions at <span style="color:#cd00cd">00</span>C22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">9</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">6</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;pairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">4</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     TFORPREP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">4</span>     ; to <span style="color:#cd00cd">10</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>   ; _ENV <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">2</span>]     CALL            <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">1</span>]     TFORCALL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>  <span style="">通用</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">11</span>      [<span style="color:#cd00cd">1</span>]     TFORLOOP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">6</span>     ; to <span style="color:#cd00cd">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">12</span>      [<span style="color:#cd00cd">3</span>]     CLOSE           <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">13</span>      [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>编译器使用的第一个特殊变量<code>(generator):f</code>存放的是迭代器,其他两个特殊变量<code>(state):s</code> <code>(control):var</code>来调用迭代器</p>
<p>把结果保存在用户定义的变量<code>k,v</code>中</p>
</li>
</ul>
<h5 id="op_tforloop"><span>OP_TFORLOOP</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A Bx	if R[A+2] ~= nil then { R[A]=R[A+2]; pc -= Bx }</code> 通用for循环</p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(t) <span style="color:#cdcd00">do</span> 
</span></span><span style="display:flex;"><span>    print(k,v) 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">13</span> instructions at <span style="color:#cd00cd">00</span>C22290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">9</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">6</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;pairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;t&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     CALL            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">4</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     TFORPREP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">4</span>     ; to <span style="color:#cd00cd">10</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">2</span>]     GETTABUP        <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>   ; _ENV <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">2</span>]     MOVE            <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">2</span>]     CALL            <span style="color:#cd00cd">6</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">1</span>]     TFORCALL        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">11</span>      [<span style="color:#cd00cd">1</span>]     TFORLOOP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">6</span>     ; to <span style="color:#cd00cd">6</span> <span style="">通用</span>for<span style="">循环</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">12</span>      [<span style="color:#cd00cd">3</span>]     CLOSE           <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">13</span>      [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>若迭代器返回的k值不是<code>nil</code>，则把该值拷贝到<code>(control):var</code>,然后跳转到循环体 否则若为<code>nil</code>,则循环结束</p>
</li>
</ul>
<h4 id="函数调用-1"><span>函数调用</span></h4>
<h5 id="op_closure"><span>OP_CLOSURE</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A Bx	R[A] := closure(KPROTO[Bx])</code> <code>根据函数原型新建一个闭包</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>	x() 
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">00</span>BD22A8)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00</span>BD3C08 <span style="">根据函数原型新建一个闭包</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;x&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">3</span>]     RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">1,3&gt;</span> (<span style="color:#cd00cd">1</span> instruction at <span style="color:#cd00cd">00</span>BD3C08)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">0</span> upvalues, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">3</span>]     RETURN0
</span></span></code></pre></div></li>
</ul>
<p>​		把当前<code>Lua</code>函数的子函数原型实例化为闭包</p>
<h3 id="iasbx操作数模式"><span>iAsBx操作数模式</span></h3>
<p><img loading="lazy" src="image-20230226110806698.png" alt="image-20230226110806698"  />
</p>
<p>占用<code>bit</code>位范围</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>范围(单位bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Op(7)</td>
<td>0~6</td>
</tr>
<tr>
<td>A(8)</td>
<td>7~14</td>
</tr>
<tr>
<td>sBx(17)</td>
<td>15~31</td>
</tr>
</tbody>
</table>
<h4 id="加载"><span>加载</span></h4>
<h5 id="op_loadi"><span>OP_LOADI</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A sBx R[A] := sBx</code> <code>加载整型立即数到寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> B <span style="color:#39c">=</span> <span style="color:#cd00cd">10</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">010</span>F2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span> <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">10</span>  <span style="">将整型立即数</span><span style="color:#cd00cd">10</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out <span style="">返回</span><span style="color:#cd00cd">0</span><span style="">个值</span>
</span></span></code></pre></div><p>上面步骤大概意思</p>
<p>将局部变量<code>B</code>分配到寄存器<code>0</code>号位置</p>
<ol>
<li>然后执行<code>VARARGPREP</code>指令查看下可变参数方式下的固定参数数量</li>
<li>将整型立即数<code>10</code>加载到寄存器的<code>0</code>号位置</li>
<li><code>0 out</code> 的意思是返回<code>0</code>个值</li>
</ol>
</li>
</ul>
<h5 id="op_loadf"><span>OP_LOADF</span></h5>
<ul>
<li>
<p><code>公式</code>:<code>A sBx	R[A] := (lua_Number)sBx</code> <code>加载浮点立即数到寄存器</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> B <span style="color:#39c">=</span> <span style="color:#cd00cd">10.0</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">3</span> instructions at <span style="color:#cd00cd">010</span>F2290)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span> <span style="">查看可变参数方式下固定参数个数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADF           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">10</span>  <span style="">将浮点立即数</span><span style="color:#cd00cd">10</span><span style="">加载到寄存器的</span><span style="color:#cd00cd">0</span><span style="">号位置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out <span style="">返回</span><span style="color:#cd00cd">0</span><span style="">个值</span>
</span></span></code></pre></div><p>上面步骤大概意思</p>
<p>将局部变量<code>B</code>分配到寄存器<code>0</code>号位置</p>
<ol>
<li>然后执行<code>VARARGPREP</code>指令查看下可变参数方式下的固定参数数量</li>
<li>将立即数<code>10</code>加载到寄存器的<code>0</code>号位置</li>
<li><code>0 out</code> 的意思是返回<code>0</code>个值</li>
</ol>
</li>
</ul>
<h3 id="iax操作数模式"><span>iAx操作数模式</span></h3>
<p><img loading="lazy" src="image-20230228101415667.png" alt="image-20230228101415667"  />
</p>
<p>占用<code>bit</code>位范围</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>范围(单位bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Op(7)</td>
<td>0~6</td>
</tr>
<tr>
<td>Ax(25)</td>
<td>7~31</td>
</tr>
</tbody>
</table>
<h4 id="额外参数"><span>额外参数</span></h4>
<h5 id="op_extraarg"><span>OP_EXTRAARG</span></h5>
<p><code>Ax</code>的位数是<code>25</code>位,那么能标识的无符号最大值是<code>25</code>个<code>1</code> 也就是<code>2^25-1</code> = <code>67108863</code>个索引</p>
<p>所以当<code>OP_LOADKX</code>指令索引不够的时候,也用这个指令续索引,OP_LOADKX开辟的指令索引加载这个额外扩展的索引足够使用了</p>
<h3 id="isj操作数模式"><span>isJ操作数模式</span></h3>
<p><img loading="lazy" src="image-20230227200602942.png" alt="image-20230227200602942"  />
</p>
<p>占用<code>bit</code>位范围</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>范围(单位bit)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Op(7)</td>
<td>0~6</td>
</tr>
<tr>
<td>sJ(25)</td>
<td>7~31</td>
</tr>
</tbody>
</table>
<h4 id="分支与跳转-1"><span>分支与跳转</span></h4>
<h5 id="op_jmp"><span>OP_JMP</span></h5>
<ul>
<li>
<p><code>OP_EQ</code> <code>OP_LT</code> <code>OP_LE</code>  <code>OP_EQK</code> <code>OP_EQI</code> <code>OP_LTI</code> <code>OP_LEI</code> <code>OP_GTI</code>  <code>OP_GEI</code> <code>OP_TEST</code>  <code>OP_TESTSET</code>  11个分支指令必须与后面的紧挨的<code>JMP</code>指令看做一体.当条件成立时,继续运行,条件不成立时,跳转到指定位置</p>
</li>
<li>
<p><code>公式</code>:<code>sJ	pc += sJ</code> <code>无条件跳转</code></p>
</li>
<li>
<p><code>lua</code>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> a <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span> <span style="color:#39c">&lt;</span> <span style="color:#cd00cd">2</span>
</span></span></code></pre></div><p>执行<code>luac54 -l Helloworld.lua</code>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">1</span> <span style="color:#00cd00">local</span>, <span style="color:#cd00cd">0</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     LOADI           <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     LTI             <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">5</span> <span style="color:#cd00cd">1</span> <span style="">比较大小</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">1</span>]     JMP             <span style="color:#cd00cd">1</span>       ; to <span style="color:#cd00cd">6</span> <span style="">进行跳转</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">1</span>]     LFALSESKIP      <span style="color:#cd00cd">0</span>	
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">1</span>]     LOADTRUE        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">1</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div></li>
</ul>
<h2 id="指令属性的掩码"><span>指令属性的掩码</span></h2>
<p><img loading="lazy" src="image-20230226165711463.png" alt="image-20230226165711463"  />
</p>
<table>
<thead>
<tr>
<th>bit位</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>0~2</td>
<td>指令的类型 也就是这些 {iABC, iABx, iAsBx, iAx, isJ}</td>
</tr>
<tr>
<td>3</td>
<td>指令是否修改了寄存器A</td>
</tr>
<tr>
<td>4</td>
<td>判断当前指令是否涉及一次条件跳转 <br />增加这个标记可以用来检测分支指令这一个打的类别,<br />这样简化了指令集,当遇到跳转指令的时候,<br />可以回到前一条指令来看看那是否是条件跳转</td>
</tr>
<tr>
<td>5</td>
<td>使用前一条指令设置的栈顶值（当 B == 0 时）</td>
</tr>
<tr>
<td>6</td>
<td>将值放到栈顶,供后面的指令使用（当C == 0时）</td>
</tr>
<tr>
<td>7</td>
<td>指令是MM指令（调用元方法）</td>
</tr>
</tbody>
</table>
<h2 id="指令的创建"><span>指令的创建</span></h2>
<h3 id="创建abck指令"><span>创建ABCK指令</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define CREATE_ABCk(o,a,b,c,k)	((cast(Instruction, o)&lt;&lt;POS_OP) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, a)&lt;&lt;POS_A) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, b)&lt;&lt;POS_B) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, c)&lt;&lt;POS_C) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, k)&lt;&lt;POS_k))
</span></span></span></code></pre></div><h3 id="创建abx指令"><span>创建ABx指令</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define CREATE_ABx(o,a,bc)	((cast(Instruction, o)&lt;&lt;POS_OP) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, a)&lt;&lt;POS_A) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, bc)&lt;&lt;POS_Bx))
</span></span></span></code></pre></div><h3 id="创建ax指令"><span>创建Ax指令</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define CREATE_Ax(o,a)		((cast(Instruction, o)&lt;&lt;POS_OP) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, a)&lt;&lt;POS_Ax))
</span></span></span></code></pre></div><h3 id="创建sj指令"><span>创建sJ指令</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define CREATE_sJ(o,j,k)	((cast(Instruction, o) &lt;&lt; POS_OP) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, j) &lt;&lt; POS_sJ) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">			| (cast(Instruction, k) &lt;&lt; POS_k))
</span></span></span></code></pre></div><p>可以发现其实指令的创建都是使用的宏和或运算进行组合,而且也是严格按照如下图编码方式创建的</p>
<p><img loading="lazy" src="image-20230223204632470.png" alt="image-20230223204632470"  />
</p>
<h2 id="luac命令"><span>luac命令</span></h2>
<h3 id="luac54--l-helloworldlua命令"><span>luac54 -l Helloworld.lua命令</span></h3>
<p><img loading="lazy" src="image-20230224175942244.png" alt="image-20230224175942244"  />
</p>
<p>比如我们对这个<code>helloworld.lua</code>使用<code>luac54 -l Helloworld.lua</code>查看指令集命令,可以得到如下信息</p>
<p><img loading="lazy" src="image-20230224215319200.png" alt="image-20230224215319200"  />
</p>
<ul>
<li>
<p><code>1</code>号位置</p>
<ul>
<li>
<p>第一行如果是<code>main</code>,说明是编译器给我们添加的主函数,对于主函数起止都是<code>0</code>,对于<code>普通函数</code>就是文件内部的起止行号</p>
</li>
<li>
<p>如果是<code>function</code>,那就说明是我们自己的定义的普通函数,比如下面写法</p>
<p><img loading="lazy" src="image-20230225144230820.png" alt="image-20230225144230820"  />
</p>
<p><img loading="lazy" src="image-20230225144316846.png" alt="image-20230225144316846"  />
</p>
</li>
<li>
<p><img loading="lazy" src="image-20230225143326441.png" alt="image-20230225143326441"  />
这个表示带文件路径的源文件名,和函数在文件中的起止行号</p>
</li>
<li>
<p><img loading="lazy" src="image-20230225143359633.png" alt="image-20230225143359633"  />
表示当前函数的指令个数,函数地址</p>
</li>
</ul>
</li>
<li>
<p><code>2</code>号位置</p>
<ul>
<li><img loading="lazy" src="image-20230225144747738.png" alt="image-20230225144747738"  />
表示是固定参数数量,如果有<code>+</code>号代表是个可变参数函数</li>
<li><img loading="lazy" src="image-20230225145002452.png" alt="image-20230225145002452"  />
寄存器数量</li>
<li><img loading="lazy" src="image-20230225145302707.png" alt="image-20230225145302707"  />
上值数量</li>
<li><img loading="lazy" src="image-20230225145316817.png" alt="image-20230225145316817"  />
局部变量数量</li>
<li><img loading="lazy" src="image-20230225145327832.png" alt="image-20230225145327832"  />
常量数量</li>
<li><img loading="lazy" src="image-20230225145340303.png" alt="image-20230225145340303"  />
子函数数量</li>
</ul>
</li>
<li>
<p><code>3</code>号位置</p>
<p>下面把每列做什么的都写出来</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="">序号</span>     <span style="">代码行号</span>  <span style="">操作码</span>          <span style="">操作数</span>   <span style="">注释</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">1</span>]     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">1</span>]     NEWTABLE        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>   ; <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">1</span>]     EXTRAARG        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">2</span>]     SETI            <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">0</span>k  ; <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">3</span>]     LOADI           <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">5</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">5</span>]     SETLIST         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">7</span>]     GETTABUP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;ipairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">7</span>]     MOVE            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">7</span>]     CALL            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">4</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">11</span>      [<span style="color:#cd00cd">7</span>]     TFORPREP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">4</span>     ; to <span style="color:#cd00cd">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">12</span>      [<span style="color:#cd00cd">8</span>]     GETTABUP        <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>   ; _ENV <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">13</span>      [<span style="color:#cd00cd">8</span>]     MOVE            <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">14</span>      [<span style="color:#cd00cd">8</span>]     MOVE            <span style="color:#cd00cd">9</span> <span style="color:#cd00cd">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">15</span>      [<span style="color:#cd00cd">8</span>]     CALL            <span style="color:#cd00cd">7</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">16</span>      [<span style="color:#cd00cd">7</span>]     TFORCALL        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">17</span>      [<span style="color:#cd00cd">7</span>]     TFORLOOP        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">6</span>     ; to <span style="color:#cd00cd">12</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">18</span>      [<span style="color:#cd00cd">9</span>]     CLOSE           <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">19</span>      [<span style="color:#cd00cd">9</span>]     RETURN          <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span></code></pre></div><p>操作数那一列中的每一小列就是如下图除开<code>0p(7)</code>剩下的对应操作模式<code>bit</code>位的分布</p>
<p><img loading="lazy" src="image-20230223204632470.png" alt="image-20230223204632470"  />
</p>
<p>比如上面的第一行<code> 1       [1]     VARARGPREP      0</code>指令对应的是<code>iAx</code>操作数模式,所以他只有一个参数<code>0</code></p>
</li>
</ul>
<h3 id="luac54--l--l-helloworldlua"><span>luac54 -l -l Helloworld.lua</span></h3>
<p>通过这个命令除了<code>luac54 -l Helloworld.lua</code>命令内容外,还能把<code>常量表</code>,<code>局部变量表</code>和 <code>upvalue 表</code>的信息打印出来</p>
<p><img loading="lazy" src="image-20230225160444424.png" alt="image-20230225160444424"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>main <span style="color:#39c">&lt;</span>.<span style="">\</span>helloworld.lua:<span style="color:#cd00cd">0</span>,<span style="color:#cd00cd">0</span><span style="color:#39c">&gt;</span> (<span style="color:#cd00cd">4</span> instructions at <span style="color:#cd00cd">008422E8</span>)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">0</span><span style="color:#39c">+</span> params, <span style="color:#cd00cd">2</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">0</span> locals, <span style="color:#cd00cd">1</span> constant, <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">function</span>
</span></span><span style="display:flex;"><span>        <span style="">1</span>       <span style="">[1]</span>     VARARGPREP      <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">12</span>]    CLOSURE         <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>     ; <span style="color:#cd00cd">00843</span>C48
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">2</span>]     SETTABUP        <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">0</span>   ; _ENV <span style="color:#cd0000">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">12</span>]    RETURN          <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>constants (<span style="color:#cd00cd">1</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">008422E8</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">0</span>       S       <span style="color:#cd0000">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>locals (<span style="color:#cd00cd">0</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">008422E8</span>:
</span></span><span style="display:flex;"><span>upvalues (<span style="color:#cd00cd">1</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">008422E8</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">0</span>       _ENV    <span style="color:#cd00cd">1</span>       <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="">&lt;</span>.<span style="">\</span><span style="color:#00cdcd">helloworld</span>.<span style="color:#00cdcd">lua</span>:<span style="">2,12&gt;</span> (<span style="color:#cd00cd">19</span> instructions at <span style="color:#cd00cd">00843</span>C48)
</span></span><span style="display:flex;"><span><span style="color:#cd00cd">1</span><span style="color:#39c">+</span> param, <span style="color:#cd00cd">11</span> slots, <span style="color:#cd00cd">1</span> upvalue, <span style="color:#cd00cd">8</span> locals, <span style="color:#cd00cd">3</span> constants, <span style="color:#cd00cd">0</span> functions
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       [<span style="color:#cd00cd">2</span>]     VARARGPREP      <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       [<span style="color:#cd00cd">3</span>]     NEWTABLE        <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>   ; <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       [<span style="color:#cd00cd">3</span>]     EXTRAARG        <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       [<span style="color:#cd00cd">4</span>]     SETI            <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">0</span>k  ; <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       [<span style="color:#cd00cd">5</span>]     LOADI           <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       [<span style="color:#cd00cd">7</span>]     LOADI           <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       [<span style="color:#cd00cd">7</span>]     SETLIST         <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">8</span>       [<span style="color:#cd00cd">9</span>]     GETTABUP        <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">1</span>   ; _ENV <span style="color:#cd0000">&#34;ipairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">9</span>       [<span style="color:#cd00cd">9</span>]     MOVE            <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">10</span>      [<span style="color:#cd00cd">9</span>]     CALL            <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">5</span>   ; <span style="color:#cd00cd">1</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">4</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">11</span>      [<span style="color:#cd00cd">9</span>]     TFORPREP        <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">4</span>     ; to <span style="color:#cd00cd">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">12</span>      [<span style="color:#cd00cd">10</span>]    GETTABUP        <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">0</span> <span style="color:#cd00cd">2</span>   ; _ENV <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">13</span>      [<span style="color:#cd00cd">10</span>]    MOVE            <span style="color:#cd00cd">9</span> <span style="color:#cd00cd">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">14</span>      [<span style="color:#cd00cd">10</span>]    MOVE            <span style="color:#cd00cd">10</span> <span style="color:#cd00cd">7</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">15</span>      [<span style="color:#cd00cd">10</span>]    CALL            <span style="color:#cd00cd">8</span> <span style="color:#cd00cd">3</span> <span style="color:#cd00cd">1</span>   ; <span style="color:#cd00cd">2</span> <span style="color:#cdcd00">in</span> <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">16</span>      [<span style="color:#cd00cd">9</span>]     TFORCALL        <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">17</span>      [<span style="color:#cd00cd">9</span>]     TFORLOOP        <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">6</span>     ; to <span style="color:#cd00cd">12</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">18</span>      [<span style="color:#cd00cd">11</span>]    CLOSE           <span style="color:#cd00cd">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">19</span>      [<span style="color:#cd00cd">12</span>]    RETURN          <span style="color:#cd00cd">2</span> <span style="color:#cd00cd">1</span> <span style="color:#cd00cd">2</span>k  ; <span style="color:#cd00cd">0</span> out
</span></span><span style="display:flex;"><span>constants (<span style="color:#cd00cd">3</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">00843</span>C48:
</span></span><span style="display:flex;"><span>       <span style="">序号</span>     <span style="">常量名类型</span>    <span style="">常量名</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">0</span>       I       <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       S       <span style="color:#cd0000">&#34;ipairs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       S       <span style="color:#cd0000">&#34;print&#34;</span>
</span></span><span style="display:flex;"><span>locals (<span style="color:#cd00cd">8</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">00843</span>C48:
</span></span><span style="display:flex;"><span>       <span style="">序号</span>     <span style="">变量名字</span>  <span style="">起始指令序号</span>      <span style="">终止指令序号</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">0</span>       var1    	    <span style="color:#cd00cd">1</span>           <span style="color:#cd00cd">20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">1</span>       reward  	    <span style="color:#cd00cd">8</span>           <span style="color:#cd00cd">20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">2</span>       (<span style="color:#cdcd00">for</span> state)     <span style="color:#cd00cd">11</span>           <span style="color:#cd00cd">19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">3</span>       (<span style="color:#cdcd00">for</span> state)     <span style="color:#cd00cd">11</span>           <span style="color:#cd00cd">19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">4</span>       (<span style="color:#cdcd00">for</span> state)     <span style="color:#cd00cd">11</span>           <span style="color:#cd00cd">19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">5</span>       (<span style="color:#cdcd00">for</span> state)     <span style="color:#cd00cd">11</span>           <span style="color:#cd00cd">19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">6</span>       k       	    <span style="color:#cd00cd">12</span>           <span style="color:#cd00cd">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">7</span>       v       	    <span style="color:#cd00cd">12</span>           <span style="color:#cd00cd">16</span>
</span></span><span style="display:flex;"><span>upvalues (<span style="color:#cd00cd">1</span>) <span style="color:#cdcd00">for</span> <span style="color:#cd00cd">00843</span>C48:
</span></span><span style="display:flex;"><span>        <span style="">序号</span>    upvalue<span style="">名</span>     <span style="">指明这个上值存在哪里</span>                  	     <span style="">指明这个上值存在位置的索引</span>
</span></span><span style="display:flex;"><span>        				    <span style="color:#cd00cd">1</span>:<span style="">表示在栈中创建存在上层函数的局部变量表中</span>    <span style="">如果位置是在栈中在上层函数的局部变量表中的索引</span>
</span></span><span style="display:flex;"><span>        				    <span style="color:#cd00cd">0</span>:<span style="">表述不在栈中在上层函数的</span>upvalues<span style="">列表中</span>     <span style="">如果不是栈中</span>,<span style="">那么就在上层函数的</span>upvalues<span style="">表中的索引</span>	
</span></span><span style="display:flex;"><span>        <span style="color:#cd00cd">0</span>       _ENV    		<span style="color:#cd00cd">0</span>       						 					<span style="color:#cd00cd">0</span>
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://frog-game.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>微信</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://frog-game.github.io/img/alipay_pay.png" alt="alipay"></a>
                        <p>支付宝</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>🧧 鼓励</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://frog-game.github.io/posts/read/lua5.4.4.matatable/">
    <span class="title">« 上一页</span>
    <br>
    <span>[Lua5.4.4源码].元表</span>
  </a>
  <a class="next" href="https://frog-game.github.io/posts/read/lua5.4.4.gc/">
    <span class="title">下一页 »</span>
    <br>
    <span>[Lua5.4.4源码].GC</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">💬评论</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://www.frog-game.work/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: "ap-beijing",
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2023 
        <a href="https://frog-game.github.io/" style="color:#939393;">frog&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">备案号</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="https://frog-game.github.io/img/beian.png" style="float:left;margin: 0px 5px 0px 0px;"/>
            公网安备
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        总访客数: <span id="busuanzi_value_site_uv"></span>
        总访问量: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
