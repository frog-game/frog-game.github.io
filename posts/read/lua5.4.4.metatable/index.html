<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Lua5.4.4æºç ].å…ƒè¡¨ | frog&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="luaæºç å…ƒè¡¨åˆ†æ">
<meta name="author" content="
ä½œè€…:&nbsp;frog">
<link rel="canonical" href="https://frog-game.github.io/posts/read/lua5.4.4.metatable/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8b75bf56d6fb0c429b5f3ce03bce19c9ef1e90cc024b64bd12ec321c68cca894.css" integrity="sha256-i3W/Vtb7DEKbXzzgO84Zye8ekMwCS2S9EuwyHGjMqJQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://frog-game.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="mask-icon" href="https://frog-game.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="[Lua5.4.4æºç ].å…ƒè¡¨" />
<meta property="og:description" content="luaæºç å…ƒè¡¨åˆ†æ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/" />
<meta property="og:image" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T01:30:29&#43;08:00" />
<meta property="article:modified_time" content="2023-03-07T01:30:29&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" />
<meta name="twitter:title" content="[Lua5.4.4æºç ].å…ƒè¡¨"/>
<meta name="twitter:description" content="luaæºç å…ƒè¡¨åˆ†æ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://frog-game.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• é˜…è¯»",
      "item": "https://frog-game.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "[Lua5.4.4æºç ].å…ƒè¡¨",
      "item": "https://frog-game.github.io/posts/read/lua5.4.4.metatable/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Lua5.4.4æºç ].å…ƒè¡¨",
  "name": "[Lua5.4.4æºç ].å…ƒè¡¨",
  "description": "luaæºç å…ƒè¡¨åˆ†æ",
  "keywords": [
    ""
  ],
  "articleBody": "å‰è¨€ lua5.4.4å…ƒè¡¨ç°åœ¨å·²ç»åŠ åˆ°äº†25ä¸ªç±»å‹\nç®€å•æ¥è¯´å…ƒæ–¹æ³•çš„ä½œç”¨æ˜¯å› ä¸ºä½¿ç”¨luaåŸå§‹è¯­æ³•ä¸èƒ½åšåˆ°æ‰€éœ€çš„è¦æ±‚æ¯”å¦‚å¯¹ä¸¤ä¸ªtableè¿›è¡ŒåŠ å‡ä¹˜é™¤,æˆ–è€…æˆ‘åœ¨é€€å‡ºä½œç”¨åŸŸçš„æ—¶å€™æƒ³è¦å¿«é€Ÿçš„æ¸…é™¤è‡ªå·±è‡ªå®šä¹‰çš„ä¸€äº›æ•°æ®,ç­‰ç­‰å…¶ä»–ä¸€äº›ç‰¹æ®Šéœ€æ±‚\nå¦‚æœå¤§å®¶å¯¹C++çš„é‡è½½è¿ç®—ç¬¦æ¯”è¾ƒç†Ÿæ‚‰,æˆ–è®¸èƒ½å¤Ÿæ›´åŠ æ¸…æ™°çš„äº†è§£å…ƒè¡¨çš„ä½œç”¨,å…¶å®ä¸¤è€…æœ‰å¼‚æ›²åŒå·¥çš„ä½œç”¨\nä»ä¸Šé¢çš„æºä»£ç æˆ‘ä»¬å¯ä»¥åˆ†æå‡º\nluaä¸­çš„æ¯ä¸ªå€¼éƒ½å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªå…ƒè¡¨ tableå’Œuserdataå„è‡ªæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å…ƒè¡¨ étableå’Œuserdataçš„å…ƒè¡¨ç»Ÿç»Ÿæ”¾åˆ°äº†global_Stateçš„mtæ•°ç»„å½“ä¸­ ä»å¯¹å¤–luaå±‚çš„APIæ¥å£æ¥çœ‹,æˆ‘ä»¬èƒ½çœ‹åˆ°åœ¨luaå±‚åªèƒ½æŒ‰è®¾ç½®tableçš„å…ƒè¡¨,è€Œå…¶ä»–ç±»å‹çš„å…ƒè¡¨è®¾ç½®å¹¶æ²¡æœ‰å¯¹å¤–çš„luaå±‚APIæ¥å£,luaä¸­æä¾›çš„ä¸¤ä¸ªå‚æ•°å¦‚ä¸‹ setmetatable(table,metatable) getmetatable(table) å…¶ä»–ç±»å‹è®¾ç½®å…ƒè¡¨åªèƒ½é€šè¿‡cä»£ç æä¾›çš„APIæ¥å£åˆ›å»ºå…ƒè¡¨,æ¯”å¦‚luaL_newmetatable luaå±‚setmetatableå’Œgetmetatableä½¿ç”¨æ–¹æ³• é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹Cä»£ç æ˜¯æ€ä¹ˆå®ç°çš„\nstatic const luaL_Reg base_funcs[] = { {\"getmetatable\", luaB_getmetatable}, {\"setmetatable\", luaB_setmetatable}, }; /// @brief // lua_getmetatableï¼šå¦‚æœè¯¥ç´¢å¼•å¤„çš„å€¼æœ‰å…ƒè¡¨,åˆ™å°†å…¶å…ƒè¡¨å‹æ ˆ,è¿”å› 1 ã€‚ å¦åˆ™ä¸ä¼šå°†ä»»ä½•ä¸œè¥¿å…¥æ ˆ,è¿”å› 0 ã€‚ // luaL_getmetafieldï¼šå°†ç´¢å¼• obj å¤„å¯¹è±¡çš„å…ƒè¡¨ä¸­ __metatable åŸŸçš„å€¼å‹æ ˆã€‚ // å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰å…ƒè¡¨,æˆ–æ˜¯è¯¥å…ƒè¡¨æ²¡æœ‰ç›¸å…³åŸŸ, æ­¤å‡½æ•°ä»€ä¹ˆä¹Ÿä¸ä¼šå‹æ ˆå¹¶è¿”å› LUA_TNILã€‚ /// @param L /// @return static int luaB_getmetatable (lua_State *L) { luaL_checkany(L, 1); if (!lua_getmetatable(L, 1)) { lua_pushnil(L); return 1; /* no metatable */ } luaL_getmetafield(L, 1, \"__metatable\"); return 1; /* returns either __metatable field (if present) or metatable */ } // LUA_TNILå®šä¹‰åœ¨lua.hä¸­ æ˜¯0 // lua_setmetatableï¼šæŠŠä¸€å¼ è¡¨å¼¹å‡ºæ ˆ,å¹¶å°†å…¶è®¾ä¸ºç»™å®šç´¢å¼•å¤„çš„å€¼çš„å…ƒè¡¨ã€‚ // a = {} // setmetatable(a,{__metatable = \"hello\"}) // setmetatable(a,{__metatable = \"world\"}) // è¿™ç§æƒ…å†µå°±ä¼šæŠ¥é”™ // ä¹Ÿå°±æ˜¯è¯´ __metatableè¿™ä¸ªæ˜¯ä¿æŠ¤å…ƒè¡¨,ä¸å¯è¯»å†™ static int luaB_setmetatable (lua_State *L) { int t = lua_type(L, 2); luaL_checktype(L, 1, LUA_TTABLE); luaL_argexpected(L, t == LUA_TNIL || t == LUA_TTABLE, 2, \"nil or table\"); if (l_unlikely(luaL_getmetafield(L, 1, \"__metatable\") != LUA_TNIL)) return luaL_error(L, \"cannot change a protected metatable\"); lua_settop(L, 2); lua_setmetatable(L, 1); return 1; } ä»æºç çœ‹å‡ºå½“æˆ‘ä»¬åœ¨luaå±‚ç¬¬ä¸€æ¬¡è°ƒç”¨getmetatable(table)çš„æ—¶å€™å¦‚æœtableæ²¡æœ‰è®¾ç½®å…ƒè¡¨å°±ä¼šè¿”å›ä¸€ä¸ªnil\nlocal t = getmetatable({}) print(t) å¦‚æœè®¾ç½®çš„æ˜¯æ™®é€šå…ƒè¡¨,é‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›æ™®é€šå…ƒè¡¨\nlocal tt = { } local t2 = { } print(\"m1 table addr:\", t2) setmetatable(tt, t2) print(\"getmetatable addr:\", getmetatable(tt)) ä»è¿™ä¸ªç¤ºä¾‹çš„luaä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºt2 tableçš„åœ°å€æ˜¯0000018860667A90 è€Œ getmetatable(tt)çš„åœ°å€ä¹Ÿæ˜¯0000018860667A90 æ‰€ä»¥ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…¶å®è¿™ä»£ç æ˜¯lua tt tableè¡¨é‡Œé¢çš„cç»“æ„ä½“Tableé‡Œé¢çš„metatableæŒ‡é’ˆæŒ‡å‘äº†lua t2 table\ntypedef struct Table { struct Table *metatable;//è¿™ä¸ªåœ°æ–¹å¦‚æœè®¾ç½®äº†å…ƒè¡¨å°±ä¼šé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘è®¾ç½®çš„å…ƒè¡¨ } Table; ç¤ºæ„å›¾å¦‚ä¸‹\nå¦‚æœè®¾ç½®äº†__metatableå­—æ®µé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›äºè¿™ä¸ªå­—æ®µç›¸å…³çš„å€¼\nlocal tt = { } local t2 = { [\"__metatable\"] = \"hello world!!!\" } setmetatable(tt, t2) print(\"getmetatable:\", getmetatable(tt)) ä»ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚æœt2è¡¨é‡Œé¢çš„__metatableçš„å­—æ®µè®¾ç½®å†…å®¹é‚£ä¹ˆå°±ä¼šç›´æ¥è¾“å‡º__metatableçš„å­—æ®µå†…å®¹\nç¤ºæ„å›¾å¦‚ä¸‹\nå½“ç„¶é™¤äº†è¿™ä¸ªæˆ‘ä»¬è¿˜è¦æ³¨æ„çš„æ˜¯__metatableå­—æ®µæ˜¯æœ‰ä¿æŠ¤æœºåˆ¶çš„ä¸å¯é‡å†™\na = {} setmetatable(a,{__metatable = \"hello\"}) setmetatable(a,{__metatable = \"world\"}) æ‰§è¡Œç»“æœ\nå¯ä»¥çœ‹åˆ°æ­¤å¤„æŠ¥é”™äº†è¾“å‡ºäº†cannot change a protected metatableé”™è¯¯æç¤º\nè¿˜æœ‰ä¸€ç‚¹æ˜¯å…ƒè¡¨å…¶å®æ˜¯å¯ä»¥å…±äº«çš„æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­\nlocal tt = { } local tt2 = { } local t2 = { [\"__metatable\"] = \"hello world\" } setmetatable(tt, t2) setmetatable(tt2, t2) print(\"get tt metatable :\", getmetatable(tt)) print(\"get tt2 metatable :\", getmetatable(tt2)) å¯ä»¥çœ‹åˆ°ttå’Œtt2æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå…ƒè¡¨t2,ç„¶ååŒæ—¶è¾“å‡ºäº†ç›¸åŒçš„å†…å®¹hello world\nå¤§æ¦‚ç¤ºæ„å›¾å¦‚ä¸‹\nCå±‚è°ƒç”¨å…ƒè¡¨ å…¶å®åœ¨ä¹‹å‰è§£é‡Šluaæºç ç±»å‹ä¸­çš„full userdataçš„æ—¶å€™å…¶å®å°±æè¿°è¿‡äº†Cæ˜¯æ€ä¹ˆä½¿ç”¨luaL_newmetatable luaL_getmetatable lua_setmetatable æ¥æ˜¯full userdataèµ·ä½œç”¨çš„\n//cæ–‡ä»¶ //#include extern \"C\" { #include \"lua.h\" #include \"lauxlib.h\" #include \"lualib.h\" } #include using namespace std; static struct StudentTag { char* strName; // å­¦ç”Ÿå§“å }T; static int CFunStudent(lua_State* L) { size_t iBytes = sizeof(struct StudentTag); struct StudentTag* pStudent; pStudent = (struct StudentTag*)lua_newuserdata(L, iBytes); //è®¾ç½®å…ƒè¡¨ luaL_getmetatable(L, \"StudentMetatable\"); lua_setmetatable(L, -2); return 1; } static int GetName(lua_State* L) { struct StudentTag* pStudent = (struct StudentTag*)luaL_checkudata(L, 1, \"StudentMetatable\"); lua_pushstring(L, pStudent-\u003estrName); return 1; } static int SetName(lua_State* L) { // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯userdata struct StudentTag* pStudent = (struct StudentTag*)luaL_checkudata(L, 1, \"StudentMetatable\"); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² const char* pName = luaL_checkstring(L, 2); luaL_argcheck(L, pName != NULL \u0026\u0026 pName != \"\", 2, \"Wrong Parameter\"); pStudent-\u003estrName = (char*)pName; return 0; } static luaL_Reg arrayFunc_meta[] = { { \"getName\", GetName }, { \"setName\", SetName }, { NULL, NULL } }; static luaL_Reg arrayFunc[] = { { \"new\", Student}, { NULL, NULL } }; extern \"C\" _declspec(dllexport) int luaopen_mytestlib(lua_State *L) { // åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨ luaL_newmetatable(L, \"StudentMetatable\"); // å…ƒè¡¨.__index = å…ƒè¡¨ lua_pushvalue(L, -1); lua_setfield(L, -2, \"__index\"); luaL_setfuncs(L, arrayFunc_meta, 0); luaL_newlib(L, arrayFunc); lua_pushvalue(L, -1); lua_setglobal(L, \"StudentModule\"); return 1; } -- lua æ–‡ä»¶ require \"mytestlib\" local objStudent = StudentModule.new() objStudent:setName(\"11111\") local strName = objStudent:getName() print(strName) for k,v in pairs(getmetatable(objStudent)) do print(tostring(k),tostring(v)) end å¤§æ¦‚æµç¨‹å›¾å¦‚ä¸‹\né¦–å…ˆåœ¨ENVé‡Œé¢æ³¨å†Œäº†æ¨¡å—studentModule,ç­‰ä»·äº_ENV[\"studentModule\"] = table ç„¶åè¿™ä¸ªtableé‡Œé¢å­˜æœ‰luaçš„æ¥å£newå’ŒæŒ‡å‘cå±‚å‡½æ•°æŒ‡é’ˆçš„CFunstudent é€šè¿‡å‡½æ•°æŒ‡é’ˆçš„CFunstudentæŒ‡å‘çš„CFunstudentå‡½æ•°æˆ‘ä»¬åˆ›å»ºäº†ä¸€å—å†…å­˜åŒºåŸŸ å› ä¸ºuserdataä¹Ÿå’Œtableç»“æ„ä¸€æ ·éƒ½èƒ½è®¾ç½®å…ƒè¡¨,ä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡å…ƒè¡¨,èƒ½ç»™luaå±‚æä¾›æ¥å£æ¥æ“ä½œè¿™å—userdata æ‰€ä»¥åé¢è¿™éƒ¨åˆ†å°±æ˜¯åˆ›å»ºå…ƒè¡¨,å¹¶é€šè¿‡å…ƒè¡¨å†…éƒ¨çš„setNameå’ŒgetNameå‡½æ•°å¯¹userdataè¿›è¡Œäº†æ“ä½œ,æœ‰ç‚¹åƒæˆ‘ä»¬ä¸èƒ½å¾ˆæ–¹ä¾¿å»ç›´æ¥æ§åˆ¶ç”µè§†æœºçš„ç”µè·¯æ¿[userdata],æ‰€ä»¥å‘æ˜äº†é¥æ§å™¨[å…ƒè¡¨],æ–¹ä¾¿ç”¨æˆ·[luaå±‚]é€šè¿‡é¥æ§å™¨æ§åˆ¶ç”µè§†æœºæ¢å°ä»€ä¹ˆçš„æ“ä½œ è®¾ç½®å…ƒæ–¹æ³• Cæšä¸¾ å…ƒæ–¹æ³•åå­— è§£é‡Š TM_INDEX __index ç´¢å¼•table[key] è®¿é—®è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼ TM_NEWINDEX __newindex ç´¢å¼•èµ‹å€¼ table[key] = value å¯¹è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼è¿›è¡Œèµ‹å€¼ TM_GC __gc å½“å¯¹è±¡è¢«gcå›æ”¶æ—¶å°†ä¼šè°ƒç”¨gcå…ƒæ–¹æ³• TM_MODE __mode å¼±å¼•ç”¨è¡¨ TM_LEN __len å¯¹åº”è¿ç®—ç¬¦\"#\" å–å¯¹è±¡é•¿åº¦ TM_EQ __eq å¯¹åº”è¿ç®—ç¬¦\"==â€œæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ TM_ADD __add å¯¹åº”è¿ç®—ç¬¦â€+\"ï¼ˆåŠ æ³•ï¼‰æ“ä½œ TM_SUB __sub å¯¹åº”çš„è¿ç®—ç¬¦ â€˜-â€™ï¼ˆå‡æ³•ï¼‰æ“ä½œ TM_MUL __mul å¯¹åº”è¿ç®—ç¬¦\"*\"ï¼ˆä¹˜æ³•ï¼‰æ“ä½œ TM_MOD __mod å¯¹åº”è¿ç®—ç¬¦\"%\"ï¼ˆå–æ¨¡ï¼‰æ“ä½œ TM_POW __pow å¯¹åº”è¿ç®—ç¬¦\"^\"ï¼ˆæ¬¡æ–¹ï¼‰æ“ä½œ TM_DIV __div å¯¹åº”è¿ç®—ç¬¦\"/\"ï¼ˆé™¤æ³•ï¼‰æ“ä½œ TM_IDIV __idiv å¯¹åº”è¿ç®—ç¬¦\"//\"ï¼ˆå‘ä¸‹å–æ•´é™¤æ³•ï¼‰æ“ä½œ TM_BAND __band å¯¹åº”è¿ç®—ç¬¦\"\u0026\"ï¼ˆæŒ‰ä½ä¸ï¼‰æ“ä½œ TM_BOR __bor å¯¹åº”è¿ç®—ç¬¦\"|\"ï¼ˆæŒ‰ä½æˆ–ï¼‰æ“ä½œ TM_BXOR __bxor å¯¹åº”è¿ç®—ç¬¦\"^\"ï¼ˆæŒ‰ä½å¼‚æˆ–ï¼‰æ“ä½œ TM_SHL __shl å¯¹åº”è¿ç®—ç¬¦\"Â«\"ï¼ˆå·¦ç§»ï¼‰æ“ä½œ TM_SHR __shr å¯¹åº”è¿ç®—ç¬¦\"Â»\"ï¼ˆå³ç§»ï¼‰æ“ä½œ TM_UNM __unm å¯¹åº”çš„è¿ç®—ç¬¦ â€˜-â€™ï¼ˆå–è´Ÿï¼‰æ“ä½œ TM_BNOT __bnot å¯¹åº”è¿ç®—ç¬¦\"~\"ï¼ˆæŒ‰ä½éï¼‰æ“ä½œ TM_LT __lt å¯¹åº”çš„è¿ç®—ç¬¦ â€˜\u003câ€™ï¼ˆå°äºï¼‰æ“ä½œ TM_LE __le å¯¹åº”çš„è¿ç®—ç¬¦ â€˜\u003c=â€™ï¼ˆå°äºç­‰äºï¼‰æ“ä½œ TM_CONCAT __concat å¯¹åº”çš„è¿ç®—ç¬¦ â€˜..â€™(è¿æ¥ï¼‰æ“ä½œ TM_CALL __call å‡½æ•°è°ƒç”¨æ“ä½œ func(args) TM_CLOSE __close è¢«æ ‡è®°ä¸ºto-be-closedçš„å±€éƒ¨å˜é‡\nä¼šåœ¨è¶…å‡ºå®ƒçš„ä½œç”¨åŸŸæ—¶,è°ƒç”¨å®ƒçš„__closedå…ƒæ–¹æ³• __index ä¸¾ä¸ªç°å®ä¸­çš„ä¾‹å­,æ¯”å¦‚ä½ ç°åœ¨å»è¡—ä¸Šä¹°é‹å­,æ¥åˆ°äº†é‹æŸœ,ä½ éå¸¸å–œæ¬¢è¿™åŒé‹å­,ä½†æ˜¯è¿™å®¶åº—é‡Œé¢æ²¡æœ‰è¿™åŒæ¬¾å¼çš„é‹å­äº†,ä¸€èˆ¬æ¥è¯´åº—å®¶éƒ½ä¼šè¯´,ä¸ç€æ€¥ä½ ç­‰ç­‰,æˆ‘å»å…¶ä»–åˆ†åº—å¸®ä½ è°ƒé…ä¸€ä¸‹é‹å­,æ‚¨æ˜¯ç­‰ç­‰è¿˜æ˜¯æˆ‘é‚®å¯„ç»™ä½ è¿‡å»å‘¢\nå…¶å®è¿™å¿«,å½“åº—å®¶æ²¡æœ‰é‹å­çš„æ—¶å€™,å»å…¶ä»–åˆ†åº—è°ƒé…å’Œluaçš„__indexå¾ˆåƒ\né¦–å…ˆæˆ‘ä½œä¸ºåº—å®¶ä»Šå¤©åº“å­˜åªæœ‰12å·å’Œ13å·æ¬¾å¼çš„é‹å­,luaä¼ªä»£ç å¦‚ä¸‹ local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } è¿™ä¸ªæ—¶å€™æ¥äº†ä¸ªå°çº¢é—®é—®æœ‰æ²¡æœ‰20å·æ¬¾å¼çš„é‹å­,è¯´éå¸¸å–œæ¬¢è¿™æ ·æ¬¾å¼çš„,ä½œä¸ºåº—ä¸»é¦–å…ˆä½ æŸ¥äº†ä¸‹è‡ªå·±çš„åº“å­˜\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } print(myShoeStore.num20_shoe) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿”å›äº†nil,è¯´æ˜æˆ‘ç°åœ¨çš„åº—é“ºå·²ç»æ²¡æœ‰20å·é‹å­çš„åº“å­˜äº†,ä¸ºäº†ç•™ä½é¡¾å®¢,ä½ åªèƒ½å»åˆ†åº—æŸ¥æ‰¾,æ¯•ç«Ÿä¸€å•ç”Ÿæ„ä¸€ä»½æ”¶å…¥,æŒ£é’±å˜›ä¸å¯’ç¢œ,é‚£æ€ä¹ˆæ ·æ‰èƒ½å’Œåˆ†åº—æŒ‚é’©èµ·æ¥,è®©æˆ‘èƒ½æ–¹ä¾¿çš„æŸ¥æ‰¾å‘¢,ç›¸ä¿¡èªæ˜çš„ä½ è‚¯å®šæƒ³åˆ°äº†__indexå…ƒæ–¹æ³•,æ²¡é”™å°±æ˜¯å®ƒ\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { __index = {--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__indexæ¥è¿›è¡Œå…³è”æŸ¥æ‰¾ num20_shoe = \"Size 20 shoes\",--20å·é‹å­ } } setmetatable(myShoeStore,myBranchShoeStore);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† print(myShoeStore.num20_shoe) å¯ä»¥çœ‹åˆ°ä¸Šå›¾çš„è¾“å‡º,å®Œç¾æ‰¾åˆ°äº†20å·çš„é‹å­,ç•™ä¸‹äº†è¿™ç¬”ç”Ÿæ„,å½“ç„¶å¦‚æœä½ åˆ†åº—æ›´å¤š,é‚£ä¹ˆä½ å¯ä»¥ä¸€ç›´ç”¨__indexå…ƒæ–¹æ³•ä¸²è¿ä¸‹å»,ç›´åˆ°ä½ æ‰¾åˆ°ä½ æƒ³è¦çš„æ•°æ®\næ€»ç»“:å®šä¹‰äº†åœ¨tableä¸­é€šè¿‡ç»™å®šçš„keyæ‰¾åˆ°çš„valueä¸ºnilæ—¶æ€ä¹ˆåŠçš„è¡Œä¸º\nä¸‹é¢æˆ‘ä»¬åœ¨è¿›è¡Œä¸€ä¸‹å…³é”®æºç ç‚¹åˆ†æ\nä¸Šé¢çš„æºç å°±æ˜¯è®¾ç½®__indexå…ƒæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘åœ°æ–¹\né¦–å…ˆç¬¬ä¸€æ­¥ä¼šåˆ¤æ–­slotæ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯é‚£ä¹ˆå°±è¯´æ˜tå˜é‡ä¸æ˜¯table,å°±ç›´æ¥æŠ¥é”™è·³è¿‡ ç¬¬äºŒæ­¥å¦‚æœslotä¸æ˜¯nullé‚£è¯´æ˜tæ˜¯ä¸€ä¸ªtable,è¿™ä¸ªæ—¶å€™æˆ‘ä»¬é€šè¿‡TM_INDEXç´¢å¼•æ‰¾åˆ°tableå¯¹åº”çš„metatableå…ƒæ–¹æ³• å¾—åˆ°äº†å…ƒæ–¹æ³•æŒ‡é’ˆä»¥å,æˆ‘ä»¬åœ¨åˆ¤æ–­ä¸€ä¸‹å¦‚æœæŒ‡é’ˆæ˜¯nullé‚£ä¹ˆå°±è¯´æ˜æ²¡æœ‰è®¾ç½®å…ƒæ–¹æ³•,é‚£ä¹ˆåªè¦ç›´æ¥è¿”å›nilå°±å¯ä»¥äº† èµ°åˆ°äº†è¿™ä¸€æ­¥äº†,é‚£ä¹ˆè¯´æ˜æˆ‘ä»¬æ‰¾åˆ°äº†TM_INDEXå¯¹åº”çš„å…ƒæ–¹æ³•äº†,æ³¨æ„å“ˆ,é‡ç‚¹æ¥äº† å¦‚æœå…ƒæ–¹æ³•æ˜¯ä¸ªå‡½æ•°,é‚£ä¹ˆå°±ä¼šè°ƒç”¨luaT_callTMresæŠŠå‡½æ•°å…¥æ ˆ,å¹¶ä¸”æŠŠç»“æœæ±‚å‡ºæ¥,å½“åšæŸ¥è¯¢ç»“æœ å¦‚æœå…ƒæ–¹æ³•æ˜¯ä¸ªtable,é‚£ä¹ˆå°±ç›´æ¥æ±‚å…ƒç´ ä¸‹æ ‡ä¸ºkeyçš„tableå†…å®¹,ä¹Ÿå°±æ˜¯tm[key]æŒ‡å‘çš„å†…å®¹ å¦‚æœä¸Šé¢éƒ½ä¸æ»¡è¶³,æ—¢ä¸æ˜¯è¡¨,åˆä¸æ˜¯å‡½æ•°,å°±ç›´æ¥è¿”å›slotä¸ºnull,ç»“æœä¸º0 ç»¼åˆæ€»ç»“\nluaä»£ç ä»è¡¨tä¸­æŸ¥æ‰¾é”®kæ—¶,luaå¤„ç†æµç¨‹å¦‚ä¸‹:\ntä¸­æ˜¯å¦æœ‰k,æœ‰åˆ™ç›´æ¥è¿”å›å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥\ntæ˜¯å¦æœ‰å…ƒè¡¨, æ— åˆ™è¿”å›nil, æœ‰åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥\ntçš„å…ƒè¡¨æ˜¯å¦æœ‰__indexå…ƒæ–¹æ³•,æ²¡æœ‰ç›´æ¥è¿”å›nil, æœ‰åˆ™æŸ¥æ‰¾__indexæŒ‡å‘çš„è¡¨æˆ–å¯¹åº”çš„å‡½æ•°,æŠŠè¡¨ä¸­æˆ–è€…å‡½æ•°çš„è¿”å›å€¼å½“åšç»“æœ\nåˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬é€šè¿‡æºç çŸ¥é“äº†__indexå†…å¹•åˆ°åº•åšäº†å•¥,é‚£ä¸ºäº†æ­£ç¡®æ€§,æˆ‘ä»¬å†™ç‚¹luaæºç éªŒè¯ä¸€ä¸‹\n__indexå…ƒæ–¹æ³•è®¾ç½®çš„ä¸æ˜¯table,æˆ–è€…å‡½æ•°æ—¶å€™ local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { __index = 11111 -- æ³¨æ„è¿™ä¸ªåœ°æ–¹çš„å†™æ³• } setmetatable(myShoeStore,myBranchShoeStore);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† print(myShoeStore.num20_shoe) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“æ²¡æœ‰æŠŠ__indexçš„å…ƒæ–¹æ³•è®¾ç½®æˆtable,æˆ–è€…å‡½æ•°çš„æ—¶å€™,å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¯ç›´æ¥æŠ¥é”™çš„\n__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯table local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { __index = {--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__indexæ¥è¿›è¡Œå…³è”æŸ¥æ‰¾ num20_shoe = \"Size 20 shoes\",--20å·é‹å­ } } setmetatable(myShoeStore,myBranchShoeStore);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† print(myShoeStore.num20_shoe) __indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯å‡½æ•° local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { __index = function(table,key,key) print(table) print(key) return \"Size 20 shoes\" end } setmetatable(myShoeStore,myBranchShoeStore);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† print(myShoeStore.num20_shoe) ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚æœåœ¨myShoeStoreä¸­æ‰¾ä¸åˆ°num20_shoe,é‚£ä¹ˆå°±ä¼šä»ä»–çš„å…ƒè¡¨myBranchShoeStoreä¸­å»æŸ¥æ‰¾æ˜¯ä¸æ˜¯æœ‰è®¾ç½®å…ƒæ–¹æ³•__index,å‘ç°__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯ä¸ªå‡½æ•°,è¿˜æœ‰èƒ½çœ‹åˆ°è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå½¢å‚,ä¸€ä¸ªæ˜¯table,ä¸€ä¸ªæ˜¯keyæ­£å¥½å¯¹åº”çš„æ˜¯myShoeStoreå’Œnum20_shoeå­—æ®µ,æœ€åè¿˜èƒ½çœ‹åˆ°è¿”å›å€¼\"Size 20 shoes\"ä¹Ÿä½œä¸ºäº†ç»“æœè¿”å›\nä¸ºä»€ä¹ˆæœ‰äº›åœ°æ–¹__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·± åœ¨è®²è§£å‰è¯·å…ˆç†Ÿæ‚‰è¿™ä¸ªæµç¨‹\nluaä»£ç ä»è¡¨tä¸­æŸ¥æ‰¾é”®kæ—¶,luaå¤„ç†æµç¨‹å¦‚ä¸‹:\ntä¸­æ˜¯å¦æœ‰k,æœ‰åˆ™ç›´æ¥è¿”å›å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥\ntæ˜¯å¦æœ‰å…ƒè¡¨, æ— åˆ™è¿”å›nil, æœ‰åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥\ntçš„å…ƒè¡¨æ˜¯å¦æœ‰__indexå…ƒæ–¹æ³•,æ²¡æœ‰ç›´æ¥è¿”å›nil, æœ‰åˆ™æŸ¥æ‰¾__indexæŒ‡å‘çš„è¡¨æˆ–å¯¹åº”çš„å‡½æ•°,æŠŠè¡¨ä¸­æˆ–è€…å‡½æ•°çš„è¿”å›å€¼å½“åšç»“æœ\na. å½“æˆ‘ä»¬ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™\n---å½“æˆ‘ä»¬ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™ local class = {} function class:new() self.__index = self return setmetatable( {}, self ) end function class:get_num20_shoe() print(\"Size 20 shoes\") end --å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡new classçš„æ—¶å€™,å‘ç°å¯ä»¥è¾“å‡ºget_num20_shoeå‡½æ•°çš„å†…å®¹ local myshoestrore = class:new() myshoestrore.get_num20_shoe() -- å½“æˆ‘ä»¬åœ¨æ­¤è°ƒç”¨é€šè¿‡myshoestroe new classçš„æ—¶å€™,å‘ç°è¿˜æ˜¯èƒ½ç»§ç»­è¾“å‡ºget_num20_shoeå‡½æ•°é‡Œé¢çš„å†…å®¹ local myBranchShoeStore = myshoestrore:new() myBranchShoeStore.get_num20_shoe() b. å½“æˆ‘ä»¬ä¸ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶\n---å½“æˆ‘ä»¬ä¸ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™ local class = {} class.__index = class function class:new() return setmetatable( {}, self ) end function class:get_num20_shoe() print(\"Size 20 shoes\") end --å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡new classçš„æ—¶å€™,å‘ç°å¯ä»¥è¾“å‡ºget_num20_shoeå‡½æ•°çš„å†…å®¹ local myshoestrore = class:new() myshoestrore.get_num20_shoe() -- å½“æˆ‘ä»¬åœ¨æ­¤è°ƒç”¨é€šè¿‡myshoestroe new classçš„æ—¶å€™,å‘ç°å°±ä¸èƒ½åœ¨ç»§ç»­è¾“å‡ºget_num20_shoeå‡½æ•°é‡Œé¢çš„å†…å®¹äº†,ä¸»è¦åŸå› è¿˜æ˜¯ -- myshoestroreé‡Œé¢æ˜¯æ²¡æœ‰__indexå…ƒæ–¹æ³•çš„,å¯¼è‡´ç»§æ‰¿é“¾æ–­äº† local myBranchShoeStore = myshoestrore:new() myBranchShoeStore.get_num20_shoe() __indexå®ç°çš„é¢å‘å¯¹è±¡ è¿™é‡Œè´´ä¸€ä¸‹äº‘é£å¤§ç¥å†™çš„ä¸€ä¸ªluaé¢å‘å¯¹è±¡å®ç°çš„ä»£ç \nlocal _class = {} -- super ä¸ºåŸºç±» function class(super) local class_type = {} --ç±»æ¨¡æ¿ class_type.ctor = false -- æ„é€ å‡½æ•° class_type.super = super --èµ‹å€¼åŸºç±» class_type.staticFun = {} --é™æ€å‡½æ•° class_type.new = function(...) -- newæ–¹æ³•æˆå‘˜ local obj = {} do local create --åµŒå¥—è°ƒç”¨ä¸»è¦æ˜¯ä¸ºäº†èƒ½æ‰åˆ°åŸºç±»ctor create = function(c, ...) if c.super then create(c.super, ...) --è°ƒç”¨åŸºç±»ctor end if c.ctor then c.ctor(obj, ...) --è°ƒç”¨æ„é€  end end create(class_type, ...) end setmetatable(obj, {__index = _class[class_type]}) --åˆ©ç”¨å…ƒè¡¨__indexè®¾ç½®ä¿è¯ objç»§æ‰¿è‡ª_class[class_type] return obj end local vtbl = {} --vtblç†è§£ä¸ºç±»å®¹å™¨ä¹Ÿå°±æ˜¯å­˜ç±»çš„æˆå‘˜,å‡½æ•°ç­‰ç­‰ vtbl.super = _class[super] _class[class_type] = vtbl setmetatable( -- æœ‰æ–°çš„æˆå‘˜å­˜åˆ°vtblä¸­ class_type, { __newindex = function(t, k, v) vtbl[k] = v end } ) if super then setmetatable( -- å¦‚æœå­ç±»æœ‰æˆå‘˜ç›´æ¥è¿”å›,å­ç±»æ²¡æœ‰è¿”å›åŸºç±»çš„æˆå‘˜ vtbl, { __index = function(t, k) local ret = _class[super][k] vtbl[k] = ret return ret end } ) end return class_type end å…·ä½“å®ç°åŸç†è¯·ä»”ç»†æŸ¥çœ‹æºç æ³¨é‡Šå§,è¿™é‡Œå°±ä¸è¯¦ç»†è§£é‡Šäº†,ç›¸ä¿¡èªæ˜çš„ä½ ä¸€å®šèƒ½çœ‹å‡ºåå ‚\nå¦‚æœæƒ³æ›´å¤æ‚çš„luaå®ç°classé¢å‘å¯¹è±¡çš„ä»£ç æ–¹æ³•,å¯ä»¥å»è¿™ä¸ªåœ°å€å–µå–µ,è¿™ä¸ªå†™çš„è¿˜æ˜¯å¾ˆä¸é”™çš„,é‡Œé¢æœ‰å¼ºå¼±è¡¨ç›¸å…³,ä¸åˆ°200è¡Œä»£ç å°±å®ç°äº†,ç±»,ç»§æ‰¿,è™šå‡½æ•°,ç§æœ‰å˜é‡,tableæ··åˆä½¿ç”¨ç­‰ç­‰åŠŸèƒ½\nmiddleclass\n__newindex å¦‚æœè¯´__indexå­—æ®µæ˜¯åœ¨è®¿é—®è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼æ˜¯æ‰§è¡Œçš„æŸ¥æ‰¾æ“ä½œçš„è¯[get]\né‚£ä¹ˆ__nexindexå­—æ®µåˆ™æ˜¯åœ¨å¯¹è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼è¿›è¡Œçš„èµ‹å€¼æ“ä½œ[set]\nå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç»™ä½ çš„tableå»ä¸€ä¸ªçš„èµ‹å€¼åˆ›å»ºå˜é‡æ¯”å¦‚åƒä¸‹é¢luaä»£ç ä¸€æ ·,ä¸ºäº†èƒ½å¤Ÿç•™ä½é¡¾å®¢æˆ‘è´¹åŠ²é€šè¿‡å„ç§æ–¹æ³•åœ¨æˆ‘çš„åº—é“ºåˆ›å»ºå‡ºæ¥äº†ä¸€åŒ20å·çš„é‹å­\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } myShoeStore.num20_shoe = \"Size 20 shoes\" --è´¹åŠ²å·´æ‹‰çš„åœ¨è‡ªå·±åº—é“ºå¼„å‡ºäº†ä¸€åŒ20å·æ¬¾å¼çš„é‹å­ è™½ç„¶20å·é‹å­åˆ›å»ºå‡ºæ¥äº†,ä½†æ˜¯å¤§å®¶å‘ç°æ²¡æœ‰æˆ‘æ˜¯æ€»åº—æŒ‰é“ç†æ¥è¯´æ€»åº—ä¸æ˜¯å·¥å‚,è€Œåº”è¯¥è®©å·¥å‚å»å±¥è¡Œè¿™ä¸ªèŒè´£,è¿™æ ·ä¸“äººåšè½¬äº‹,ä¿å€¼ä¿é‡,åˆå¿«åˆå¥½,æ‰€ä»¥æˆ‘ä»¬åˆå¯¹ä»£ç åšäº†å¦‚ä¸‹å¤„ç†\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myShoeFactory = { __newindex = function(table, key, value) --å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__newindexæ¥è¿›è¡Œé‹å­çš„åˆ›å»º rawset(table, key, value); end } setmetatable(myShoeStore,myShoeFactory);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† --- æœ‰å…ƒè¡¨çš„æƒ…å†µä¸‹è®¾ç½®å€¼,è¿™æ ·ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º20å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚å»å¤„ç†äº† myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) é€šè¿‡ä¸Šé¢çš„å¤„ç†ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º20å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚myShoeFactoryå»å¤„ç†äº†\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æºç \næˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§æ¦‚æµç¨‹å¦‚ä¸‹\ntä¸­æ˜¯å¦æœ‰å…ƒæ–¹æ³•,æ²¡æœ‰çš„è¯ç›´æ¥è®¾ç½®å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥ å…ƒæ–¹æ³•æŒ‡å‘çš„å‡½æ•°,ç›´æ¥é€šè¿‡luaT_callTMå‡½æ•°æ¥å£è¿›è¡Œè®¾ç½®,å¦åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥ å¦‚æœå…ƒæ–¹æ³•æŒ‡å‘æ˜¯ä¸ªtable,é‚£ä¹ˆå°±ç›´æ¥å›å»tableå¯¹åº”çš„å€¼,è¿›è¡Œè®¾ç½®,å¦åˆ™è¿›è¡Œç¬¬å››æ­¥ å¦‚æœå…ƒæ–¹æ³•æŒ‡å‘ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°,é‚£ä¹ˆå°±ç›´æ¥æŠ¥é”™ __newindexè®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™ local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myShoeFactory = { __newindex = 11111 } setmetatable(myShoeStore,myShoeFactory);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† --- è®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™ myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) _å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™ local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myShoeFactory = { } setmetatable(myShoeStore,myShoeFactory);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† --- _å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™ myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) å¯ä»¥çœ‹åˆ°ç›´æ¥èµ‹å€¼äº†,è¿˜æ˜¯æœ‰æƒ³è¦çš„ç»“æœè¾“å‡º\n__newindexè®¾ç½®çš„æ˜¯table local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myShoeFactoryItem = { num20_shoe = \"Size 21 shoes\" } local myShoeFactory = { __newindex = myShoeFactoryItem } setmetatable(myShoeStore,myShoeFactory);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† print(\"set num20_shoe before myShoeFactoryItem.num20_shoe:\",myShoeFactoryItem.num20_shoe) myShoeStore.num20_shoe = \"Size 20 shoes\" print(\"set num20_shoe after myShoeFactoryItem.num20_shoe:\",myShoeFactoryItem.num20_shoe) print(myShoeStore.num20_shoe) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ä¿®æ”¹myShoeFactoryItemä¸­num20_shoeå­—æ®µçš„ä¹‹å‰ä»–çš„å€¼æ˜¯\"Size 21 shoes\"\nå½“è°ƒç”¨ myShoeStore.num20_shoe = \"Size 20 shoes\"è¿›è¡Œè®¾ç½®çš„æ—¶å€™\nmyShoeFactoryItemä¸­num20_shoeå­—æ®µçš„ä¹‹å‰ä»–çš„å€¼å˜æˆäº†\"Size 20 shoes\"\nè€Œå†æ¬¡è¾“å‡ºmyShoeStore.num20_shoeçš„æ—¶å€™çœ‹åˆ°çš„å€¼æ˜¯nil\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸œè¥¿æœ‰ç‚¹åƒæˆ‘çš„å·¥å‚æ­£åœ¨äº§21å·çš„é‹å­,ä½†æ˜¯æˆ‘è¿™ä¸ªæ—¶å€™ç´§æ€¥éœ€è¦20å·é‹å­,æˆ‘å°±éš”ç©ºé€šè¿‡ä¸»åº—å¯¹å·¥å‚å‘å‡ºäº†åˆ›å»º20å·é‹å­çš„å‘½ä»¤,ä½†æ˜¯ä¸»åº—å´ä¸ä¼šå»åˆ›å»º20å·é‹å­,è¿™æ ·éå¸¸niceæœ‰ç‚¹éš”ç©ºæ‰“ç‰›,ä½†æ˜¯ä¸å½±å“ä¸»åº—çš„æ„æ€åœ¨é‡Œé¢\n__newindexè®¾ç½®çš„æ˜¯å‡½æ•° local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myShoeFactory = { __newindex = function(table, key, value) --å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__newindexæ¥è¿›è¡Œé‹å­çš„åˆ›å»º rawset(table, key, value);--ä½¿ç”¨rawsetæ¥è¿›è¡Œè®¾ç½®,å› ä¸ºä¸ä¼šå»è°ƒç”¨å…ƒæ–¹æ³•å¯¹tableè¿›è¡Œè®¾ç½®,æ‰€ä»¥èƒ½å¾—åˆ°æ›´å¥½çš„æ€§èƒ½å’Œé¿å…å…ƒæ–¹æ³•çš„æ— é™é€’å½’è°ƒç”¨ end } setmetatable(myShoeStore,myShoeFactory);--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº† --- æœ‰å…ƒè¡¨çš„æƒ…å†µä¸‹è®¾ç½®å€¼,è¿™æ ·ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º20å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚å»å¤„ç†äº† myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) è¿™å—åœ°æ–¹åºŸè¯å°±ä¸å¤šè¯´äº†,å¯ä»¥è‡ªå·±å¯¹ç€æ³¨é‡Šæ‹ä¸€ä¸‹å°±æ˜ç™½äº†,å…¶å®__newindexå¼€åœºç™½çš„æ—¶å€™ä¹Ÿè¿›è¡Œäº†ä»‹ç»\n__gc ä¸»è¦ç”¨æ¥å½“å¯¹è±¡è¢«é”€æ¯æ—¶,è¯¥å…ƒæ–¹æ³•å°†ä»¥å¯¹è±¡ä½œä¸ºå‚æ•°è¿›è¡Œè°ƒç”¨,å¹¶å¯¹ä¸€äº›è‡ªå®šä¹‰çš„èµ„æºé‡Šæ”¾,å¯ä»¥å°†æ­¤å…ƒæ–¹æ³•è®¤ä¸ºæ˜¯ä¸€ç§ææ„å‡½æ•°ä¹Ÿè¡Œ,è¿™ä¸ªå…ƒæ–¹æ³•æŒ‡å‘çš„å†…å®¹å¿…é¡»çš„æ˜¯ä¸ªå‡½æ•°\nå…ˆæ¥å–µå–µæºä»£ç \n1å·ä½ç½®è·å–å…ƒæ–¹æ³• 2å·ä½ç½®è°ƒç”¨ä½ æŒ‡å‘çš„å‡½æ•°,ä»è°ƒç”¨çš„æ˜¯luaD_pcallå‡½æ•°ä¸­å¯ä»¥çœ‹å‡º,__gcå…ƒæ–¹æ³•æŒ‡å‘çš„å¿…é¡»æ˜¯ä¸ªå‡½æ•° __gcæŒ‡å‘çš„ä¸æ˜¯å‡½æ•° local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } print(\"myShoeStore addr:\",myShoeStore)--å…ˆæ‰“å°ä¸‹myShoeStore tableåœ°å€ local myShoeFactoryGC = { __gc =1111 } setmetatable(myShoeStore,myShoeFactoryGC); myShoeStore = nil --è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶ collectgarbage()-- è¿›è¡Œgcå›æ”¶ å¯ä»¥çœ‹åˆ°ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿ\n__gcæŒ‡å‘çš„æ˜¯å‡½æ•° local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } print(\"myShoeStore addr:\",myShoeStore)--å…ˆæ‰“å°ä¸‹myShoeStore tableåœ°å€ local myShoeFactoryGC = { __gc =function( table ) print(\"myShoeFactoryGC released table addr:\",table) -- myShoeStore tableè¢«å›æ”¶äº† end } setmetatable(myShoeStore,myShoeFactoryGC); myShoeStore = nil --è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶ collectgarbage()-- è¿›è¡Œgcå›æ”¶ ä»ä¸Šé¢æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºå½“myShoeStore tableè¢«å›æ”¶çš„æ—¶å€™,ä¹Ÿä¼šè§¦å‘__gcçš„å…ƒæ–¹æ³•,å¤§ç™½è¯æ¥è¯´å°±æœ‰ç‚¹åƒæˆ‘çš„ä¸»åº—å€’é—­äº†,é‚£ä¹ˆå’Œæˆ‘å…³è”çš„å·¥å‚ä¹Ÿæ²¡æœ‰å¿…è¦åœ¨ç»™æˆ‘è¿›è¡Œå…³è”,ç»™æˆ‘å‘é‹å­ä»€ä¹ˆçš„æ¥æˆ‘è¿™å–äº†.\n__mode å‡è®¾å¦‚æœä½ çš„ä¸»åº—å’Œä½ åä¸‹çš„åˆ†åº—æœ‰å¼ºå¼•ç”¨å…³ç³»,æ¯”å¦‚ä½ æ¬ äº†åˆ†åº—çš„é¢„ä»˜æ¬¾ä»€ä¹ˆçš„,è¿™ä¸ªæ—¶å€™åˆ†åº—ä¸æƒ³å’Œä½ å¹²äº†,æŒ‰ç…§æ³•å¾‹æ¥è¯´åŠæ—¶åˆ†åº—è‡ªå·±å…³é—­äº†,åˆ†åº—å’Œä½ çš„åŠ³åŠ¨çº çº·è¿˜æ˜¯å­˜åœ¨,ä½ è¿˜æ˜¯è·‘ä¸äº†,æ¯•ç«Ÿå¼ºå¼•ç”¨å…³ç³»å†æ¬¡,ä½†æ˜¯å¦‚æœä½ å’Œåˆ†åº—åœ¨ç­¾è®¢åŠ ç›ŸåˆåŒçš„æ—¶å€™,è¯´çš„æ˜¯è‡ªè´Ÿç›ˆäº,å¦‚æœä¸»åº—ä»˜ä¸å‡ºåˆ©æ¶¦é’±äº†,ä¸¤ä¸ªäººä¹Ÿæ‰¯ä¸ä¸Šä»»ä½•æ³•å¾‹ä¸Šçš„å…³ç³»,è¿™æ ·åˆ†åº—è‡ªå·±å…³é—­äº†,ä½ ä¹Ÿä¸ç”¨åœ¨è´Ÿè´£ä»»,è¿™å°±æœ‰ç‚¹åƒå¼±å¼•ç”¨çš„å…³ç³»\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { num20_shoe = \"Size 20 shoes\",--20å·é‹å­ num21_shoe = \"Size 21 shoes\",--21å·é‹å­ } local contract = {} --ä¸¤äººåœ¨æ­¤å»ºç«‹åˆåŒ contract[1] = myShoeStore contract[2] = myBranchShoeStore myBranchShoeStore = nil --è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶ collectgarbage()-- è¿›è¡Œgcå›æ”¶ for k,v in pairs(contract) do print(k,v) end å¯ä»¥çœ‹åˆ°å½“ä¸¤è€…å»ºç«‹åˆåŒå¹¶ä¸”æ²¡æœ‰è®¾ç½®å¼±å¼•ç”¨çš„æ—¶å€™,myBranchShoeStoreåˆ†åº—å“ªæ€•ä¸»åŠ¨å›æ”¶äº†,æœ€åå‘ç°å’ŒmyShoeStoreä¸»åº—æœ‰å¼•ç”¨å…³ç³»åœ¨,è¿˜æ˜¯æ²¡æœ‰è¢«å›æ”¶\né‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ç§æƒ…å†µå‘¢,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨__modeæ¥è§£å†³è¿™ä¸ªé—®é¢˜,\næ“ä½œç¬¦ è¯´æ˜ k è¡¨çš„keyä¸ºå¼±å¼•ç”¨ v è¡¨çš„valueä¸ºå¼±å¼•ç”¨ kv è¡¨çš„key,valueéƒ½ä¸ºå¼±å¼•ç”¨ local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12å·é‹å­ num13_shoe = \"Size 13 shoes\",--13å·é‹å­ } local myBranchShoeStore = { num20_shoe = \"Size 20 shoes\",--20å·é‹å­ num21_shoe = \"Size 21 shoes\",--21å·é‹å­ } local contract = {} --ä¸¤äººåœ¨æ­¤å»ºç«‹åˆåŒ contract[1] = myShoeStore contract[2] = myBranchShoeStore for k,v in pairs(contract) do print(k,v) end print(\"\\n-------------collectgarbage after-----------------\") setmetatable(contract,{__mode=\"v\"})--è¿™ä¸ªåœ°æ–¹æŠŠvalueè®¾ç½®æˆäº†å¼±å¼•ç”¨ myBranchShoeStore = nil --è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶ collectgarbage()-- è¿›è¡Œgcå›æ”¶ for k,v in pairs(contract) do print(k,v) end æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å›æ”¶ä¹‹å‰æ˜¯2ä¸ªtable,è€Œå½“è°ƒç”¨myBranchShoeStore = nil ,collectgarbage()çš„æ—¶å€™,å‘ç°myBranchShoeStore è¢«å›æ”¶äº†\nå…¥å£æºç å‰–æ 1å·ä½ç½®æ˜¯ä»å…ƒè¡¨ä¸­è·å–å…ƒæ–¹æ³• 2å·ä½ç½®æ˜¯æ ¹æ®è®¾ç½®çš„æ“ä½œç¬¦æ˜¯ä»€ä¹ˆè¿›è¡Œå¯¹åº”çš„gcå›æ”¶ å¼±è¡¨åŸç†å‰–æ ä¸Šé¢æ˜¯å¼±è¡¨çš„åŸç†å‰–æ,å¤§å®¶å¯ä»¥æŠŠå›¾ç‰‡æ”¾å¤§æˆ–è€…ä¸‹è½½ä¸‹æ¥è§‚çœ‹\nå¼±è¡¨å…·ä½“çš„ç›¸å…³æºç å¤ªå¤šäº†,è¿™é‡Œå°±ä¸ä¸€ä¸€å±•ç¤ºäº†,æ„Ÿå…´è¶£çš„å¯ä»¥å»ä¸‹é¢è¿æ¥æŸ¥æ‰¾traverseweakvalue,traverseephemeron,traverseephemeron,traversetableå››ä¸ªä¸»è¦å‡½æ•°è¿›è¡Œè§‚çœ‹,å‡½æ•°å¤„ä¹Ÿå†™äº†ä¸å°‘æ³¨é‡Š\nå¼±è¡¨ç›¸å…³çš„gcéƒ¨åˆ† __len è¿™ä¸ªæ˜¯ç”¨æ¥æ±‚è‡ªå®šä¹‰é•¿åº¦ä½¿ç”¨çš„\nä¾‹å­ å‡å¦‚è¿™ä¸ªæ—¶å€™æ¥äº†ä¸ªé¡¾å®¢,é¡¾å®¢è¯´ä½ è¿™æœ‰20ç ä»¥ä¸Šçš„é‹å­å—,æˆ‘çš„è„šæ¯”è¾ƒç‰¹æ®Šéœ€è¦éƒ½è¯•è¯•,å¦‚æœä½ æ˜¯åº—å®¶ä½†æ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨ä¿¡æ¯åŒ–å¤„ç†,çœ‹ç€æ»¡ä¸»åº—ä»“åº“å †æ»¡çš„é‹å­,ä½ æ˜¯ä¸æ˜¯ä¼šå¾ˆç»æœ›,ç­‰ä½ ä»ä»“åº“ä¸­ç¿»å‡ºé‚£äº›é‹å­,ä¼°è®¡é¡¾å®¢éƒ½è·‘æ‰äº†,æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨_lenå…ƒæ–¹æ³•æ¥å¤„ç†è¿™ä¸ªçª˜è¿«çš„é—®é¢˜\nlocal myShoeStore = { num12_shoe = {12,\"Size 12 shoes\"},--12å·é‹å­ num13_shoe = {13,\"Size 13 shoes\"},--13å·é‹å­ num20_shoe = {20,\"Size 20 shoes\"},--20å·é‹å­ num21_shoe = {21,\"Size 21 shoes\"},--21å·é‹å­ num22_shoe = {22,\"Size 22 shoes\"},--22å·é‹å­ num23_shoe = {23,\"Size 23 shoes\"},--23å·é‹å­ } local myShoeStoreLen ={ __len = function (table) --é€šè¿‡æ­¤å¤„çš„è®¡ç®—ç›´æ¥æŠŠ20å·ä»¥ä¸Šçš„é‹å­éƒ½ç»™ç»Ÿè®¡å‡ºæ¥ local len = 0 for k,v in pairs(table) do if( 20 \u003c= v[1]) then len= len+ 1 end end return len; end } setmetatable(myShoeStore, myShoeStoreLen); print(#myShoeStore)--è¿™ä¸ªåœ°æ–¹å¾—åˆ°__lenå…ƒæ–¹æ³•ç»Ÿè®¡çš„æ•°æ®é‡å¤§å° ä»ä¸Šé¢ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡º,å®Œç¾çš„å¾—åˆ°äº†æƒ³è¦çš„æ•°æ®\næºç è®²è§£ ä¸Šé¢æ˜¯å½“ä½ æ˜¯ç”¨#å»æ±‚å¤§å°çš„æ—¶å€™,ä¼šæ›´åŠ ä½ #åé¢è·Ÿçš„æ•°æ®ç±»å‹æ¥åˆ¤æ–­æ€ä¹ˆæ±‚å¤§å°\nå¦‚æœæ˜¯#table,é‚£ä¹ˆå°±çœ‹ä¸€ä¸‹æ˜¯å¦è®¾ç½®äº†å…ƒæ–¹æ³•,å¦‚æœè®¾ç½®äº†èµ°luaT_callTMreså‡½æ•°è°ƒç”¨å…ƒæ–¹æ³•æ±‚å¤§å°,å¦åˆ™é€šè¿‡luaH_getnå‡½æ•°æ±‚å¤§å° å¦‚æœæ˜¯#çŸ­å­—ç¬¦ä¸²,ç›´æ¥é€šè¿‡tsvalue(rb)-\u003eshrlenè¿”å›å¤§å° å¦‚æœæ˜¯#é•¿å­—ç¬¦ä¸²,ç›´æ¥é€šè¿‡tsvalue(rb)-\u003eu.lnglenè¿”å›å¤§å° å¦‚æœæ˜¯#å…¶ä»–,é‚£ä¹ˆå°±åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å…ƒè¡¨å¦‚æœè®¾ç½®äº†å°±é€šè¿‡luaT_callTMreså‡½æ•°è°ƒç”¨å…ƒæ–¹æ³•æ±‚å¤§å°,å¦åˆ™æŠ¥é”™,è¿™ä¸ªå…¶ä»–æ¯”å¦‚æ˜¯userdataç­‰ç­‰ å·²ç»è¯´é“äº†è¿™é‡Œé‚£ä¹ˆå°±å¥½å¥½è¯´ä¸‹#tableçš„æ—¶å€™é€šè¿‡luaH_getnå‡½æ•°æ±‚å¤§å°\nå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å†…å®¹è¿˜æ˜¯æŒºè›‹ç–¼çš„,åˆæ˜¯äºŒåˆ†,åˆæ˜¯è¾¹ç•Œä»€ä¹ˆä»€ä¹ˆçš„,ä¸ç€æ€¥,æˆ‘ä»¬æ…¢æ…¢åš¼ç¢å®ƒ\né¦–å…ˆæˆ‘ä»¬çŸ¥é“luaçš„tableæ˜¯åˆ†ä¸ºæ•°ç»„å’Œhashéƒ¨åˆ†çš„\næ‰€ä»¥ä¸ºäº†æ±‚å‡ºåˆé€‚çš„å¤§å°luaä¼šæŒ‰å¦‚ä¸‹è§„åˆ™æ¥æ±‚å¤§å°,æˆ–è€…æ›´ç®€å•ç‚¹æ¥è¯´,luaç”¨#æ±‚å¤§å°å°±æ˜¯æ±‚tableçš„è¾¹ç•Œ\né‚£ä¹ˆæ€ä¹ˆæ±‚è¾¹ç•Œå‘¢,è¾¹ç•Œåˆæ˜¯é’ˆå¯¹ä»€ä¹ˆçš„å‘¢\nè¾¹ç•Œæ˜¯é’ˆå¯¹tableçš„æ•°ç»„éƒ¨åˆ†çš„,ä½†è‹¥å“ˆå¸Œéƒ¨åˆ†çš„keyä¸ºæ•´æ•°ä¸”åˆšå¥½è¿ç€æ•°ç»„éƒ¨åˆ†,åˆ™ä¹Ÿä¼šä¸€å¹¶å‚ä¸è®¡ç®—\nè‹¥æŸä¸ªæ•´æ•°ä¸‹æ ‡n,æ»¡è¶³table[boundary]ä¸ä¸ºç©º,è€Œtable[boundary+1]ä¸ºç©º,åˆ™nä¸ºtableçš„è¾¹ç•Œ\ntable[boundary] != nil table[boundary+1] == nil\nä¸ºäº†æé«˜éå†æŸ¥æ‰¾è¾¹ç•Œçš„æ•ˆç‡,luaæºç å¹¶æ²¡æœ‰è¿›è¡Œéå†æŸ¥æ‰¾,è€Œæ˜¯é€šè¿‡äºŒåˆ†æŸ¥æ‰¾\nå¦‚æœtableæ•°ç»„éƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸ºnil,é‚£ä¹ˆå°†åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾\né’ˆå¯¹tableçš„æ•°ç»„éƒ¨åˆ†çš„,ä½†è‹¥å“ˆå¸Œéƒ¨åˆ†çš„keyä¸ºæ•´æ•°ä¸”åˆšå¥½è¿ç€æ•°ç»„éƒ¨åˆ†,åˆ™ä¹Ÿä¼šä¸€å¹¶å‚ä¸è®¡ç®—\næœ€åä¸€ç§æƒ…å†µæ˜¯æ•°ç»„éƒ¨åˆ†ä¸­æ²¡æœ‰å…ƒç´  æˆ–å¦‚æœtableæ•°ç»„éƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸ºnil,é‚£ä¹ˆå°†åœ¨hashéƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾\nç”¨#æ±‚tableé•¿åº¦çš„ä¸€äº›æƒ…å†µ å…¨éƒ¨ä¸ºæ•°ç»„,æ²¡æœ‰hashéƒ¨åˆ† tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯nil ä¾‹å­1\nlocal myShoeStore = {12,13,14,15,16,17} print(#myShoeStore) ä¾‹å­2\nlocal myShoeStore = {12,nil,nil,nil,nil,17} print(#myShoeStore) ä¾‹å­3\nlocal myShoeStore = {nil,nil,nil,nil,nil,17} print(#myShoeStore) å› ä¸ºtableæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä½ä¸æ˜¯nilæ‰€ä»¥ä¼šè·‘åˆ°luaH_getnå‡½æ•°çš„è¿™ä¸ªåœ°æ–¹,ç›´æ¥è¿”å›Tableç»“æ„ä½“é‡Œé¢çš„alimitå­—æ®µå¤§å° tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil ä¾‹å­1\nlocal myShoeStore = {12,13,14,15,16,nil} print(#myShoeStore) ä¾‹å­2\nlocal myShoeStore = {12,nil,nil,nil,16,nil} print(#myShoeStore) ä¾‹å­3\nlocal myShoeStore = {nil,nil,nil,nil,16,nil} print(#myShoeStore) å› ä¸ºæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸ºnil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil,é‚£ä¹ˆå°±ç›´æ¥è¿”å›Tableç»“æ„ä½“é‡Œé¢çš„alimitå­—æ®µå¤§å°å‡1 tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nil å…³é”®æºç éƒ¨åˆ†\nä¾‹å­1\nlocal myShoeStore = {12,13,14,15,nil,nil} print(#myShoeStore) ç®€å•è¯´ä¸‹ä¾‹å­1è¿›å…¥äºŒåˆ†æŸ¥æ‰¾çš„è¿ç®—è¿‡ç¨‹\nç¬¬ä¸€è½® i = 0ï¼›j = 6ï¼›åˆ¤æ–­j - i \u003e 1ï¼›è¿›å…¥whiteå¾ªç¯ ç¬¬äºŒè½® i = 0ï¼›j = 6ï¼›m = (i + j) / 2 = 3ï¼›åˆ¤æ–­array[m - 1]æ˜¯ä¸æ˜¯ç©º,ä¸ä¸ºç©º; i=m=3ï¼›åˆ¤æ–­j - i \u003e 1ï¼›è¿›å…¥whiteå¾ªç¯ ç¬¬ä¸‰è½® i = 3ï¼›j = 6ï¼›m = (i + j) / 2 = 4ï¼›åˆ¤æ–­array[m - 1]æ˜¯ä¸æ˜¯ç©º,ä¸ä¸ºç©º; i=m=4ï¼›åˆ¤æ–­j - i \u003e 1ï¼›è¿›å…¥whiteå¾ªç¯ ç¬¬å››è½® i = 4ï¼›j = 6ï¼›m = (i + j) / 2 = 5ï¼›åˆ¤æ–­array[m - 1]æ˜¯ä¸æ˜¯ç©º,ä¸ºç©º; j=m=5ï¼›åˆ¤æ–­j - i ä¸å¤§äº1ï¼›é€€å‡ºå¾ªç¯,å¹¶è¿”å›iå€¼ ä¾‹å­2\nlocal myShoeStore = {12,13,nil,nil,nil,nil} print(#myShoeStore) ä¾‹å­3\nlocal myShoeStore = {12,13,nil,nil,nil,nil} print(#myShoeStore) å› ä¸ºæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸ºnil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nilæ‰€ä»¥ç›´æ¥è°ƒç”¨binsearchå‡½æ•°åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾å¾—åˆ°tableå¤§å° â€‹\té€šè¿‡ä¸Šé¢ä¸¤ä¸ªæç«¯çš„ä¾‹å­,æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°tableåªçœ‹æ•°ç»„éƒ¨åˆ†æœ€åä¸¤ä½çš„æƒ…å†µæ¥å†³å®šä»€ä¹ˆæ ·çš„é€»è¾‘å¤„ç†\n1. å¦‚æœæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä½ä¸æ˜¯`nil`,é‚£ä¹ˆå°±ç›´æ¥è¿”å›`Table`ç»“æ„ä½“é‡Œé¢çš„`alimit`å­—æ®µå¤§å° 1. å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯`nil`,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯`nil`,é‚£ä¹ˆå°±ç›´æ¥è¿”å›`Table`ç»“æ„ä½“é‡Œé¢çš„`alimit`å­—æ®µå¤§å°å‡`1` 1. å¦‚æœæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸º`nil`,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯`nil`æ‰€ä»¥ç›´æ¥è°ƒç”¨`binsearch`å‡½æ•°åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾,å¾—åˆ°`table`å¤§å° å…¨éƒ¨ä¸ºhash,æ²¡æœ‰æ•°ç»„ local myShoeStore = { [1] = \"Size 12 shoes\",--12å·é‹å­ [3] = \"Size 20 shoes\",--20å·é‹å­ [4] = \"Size 21 shoes\",--21å·é‹å­ [5] = \"Size 22 shoes\",--22å·é‹å­ [6] = \"Size 23 shoes\",--23å·é‹å­ } print(#myShoeStore) å…³é”®æºç éƒ¨åˆ†\ntæ²¡æœ‰æ•°ç»„å…ƒç´ ,è°ƒç”¨ hash_search å‡½æ•°,hashéƒ¨åˆ†ä» j = 1 å¼€å§‹éå†, iè®°å½•çš„æ˜¯ä¸Šä¸€ä¸ª jçš„å€¼ ç¬¬ä¸€è½® i = 1; j = 2; t[2] ä¸ºnil ç„¶åj - i ä¸å¤§äº1 æ‰€ä»¥ç›´æ¥è¿”å›iä¹Ÿå°±æ˜¯å¤§å°1 åœ¨ä¸¾ä¸ªè§¦å‘äºŒåˆ†æŸ¥æ‰¾çš„ä¾‹å­\nlocal myShoeStore = { [1] = \"Size 12 shoes\",--12å·é‹å­ [2] = \"Size 13 shoes\",--13å·é‹å­ [3] = \"Size 20 shoes\",--20å·é‹å­ [4] = \"Size 21 shoes\",--21å·é‹å­ [6] = \"Size 23 shoes\",--23å·é‹å­ } print(#myShoeStore) tæ²¡æœ‰æ•°ç»„å…ƒç´ ,è°ƒç”¨ hash_search å‡½æ•°,hashéƒ¨åˆ†ä» j = 1 å¼€å§‹éå†, iè®°å½•çš„æ˜¯ä¸Šä¸€ä¸ª jçš„å€¼ ç¬¬ä¸€è½® i = 1; j = 2; t[2]ä¸ä¸ºnilï¼›ç»§ç»­ä¸‹ä¸€è½®whiteå¾ªç¯ ç¬¬äºŒè½® i = 2; j = 4; t[4]ä¸ä¸ºnilï¼›ç»§ç»­ä¸‹ä¸€è½®whiteå¾ªç¯ ç¬¬ä¸‰è½® i = 4; j = 8; t[8]ä¸ºnilå¹¶ä¸”j - i \u003e 1ï¼› è¿›å…¥äºŒåˆ†æŸ¥æ‰¾é˜¶æ®µ ç¬¬å››è½® i = 4; j = 8; m = (i + j) / 2 = 6; t[m]ä¸ä¸ºç©ºè®¾ç½®i = 6ï¼›åˆ¤æ–­j - i \u003e 1;ç»§ç»­ä¸‹ä¸€è½®äºŒåˆ†æŸ¥æ‰¾ ç¬¬äº”è½® i = 6; j = 8ï¼›m = (i + j) / 2 = 7; t[m]ä¸ºç©ºè®¾ç½®j = 7; åˆ¤æ–­j - i ä¸å¤§äº1 ç»“æŸäºŒåˆ†æŸ¥æ‰¾è¿”å›içš„å€¼ä¸º6 æœ‰hashæœ‰æ•°ç»„çš„æƒ…å†µ æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡è¿è´¯çš„ local myShoeStore = { \"Size 12 shoes\",--12å·é‹å­ \"Size 13 shoes\",--13å·é‹å­ [3] = \"Size 20 shoes\",--20å·é‹å­ [4] = \"Size 21 shoes\",--21å·é‹å­ [5] = \"Size 23 shoes\",--23å·é‹å­ } print(#myShoeStore) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§å°å°±æ˜¯æ•°ç»„éƒ¨åˆ†çš„å¤§å°2åŠ ä¸Šhashéƒ¨åˆ†çš„å¤§å°3æ€»å…±ä¸º5\næ¨¡æ‹Ÿä¸€ä¸‹è¿‡ç¨‹å› ä¸ºæ•°ç»„éƒ¨åˆ†å¤§å°æ˜¯2,æ‰€ä»¥jç­‰äº2\nç¬¬ä¸€è½® i = 2; j = 4; t[4]ä¸ä¸ºnilï¼›ç»§ç»­ä¸‹ä¸€è½®whiteå¾ªç¯ ç¬¬äºŒè½® i = 4; j = 8; t[8]ä¸ºnilï¼›è·³å‡ºwhiteå¾ªç¯;åˆ¤æ–­j - i æ˜¯å¦å¤§äº1;å‘ç°å¤§äº;è¿›å…¥äºŒåˆ†æŸ¥æ‰¾ ç¬¬ä¸‰è½® i = 4; j = 8; m = (i + j) / 2 = 6ï¼›t[m]ä¸ºnilï¼›j=m=6ï¼›åˆ¤æ–­j - i æ˜¯å¦å¤§äº1 å‘ç°å¤§äº,ç»§ç»­ä¸‹ä¸€è½®äºŒåˆ†æŸ¥æ‰¾ ç¬¬å››è½® i = 4; j = 6ï¼›m = (i + j) / 2 = 5; t[m]ä¸ä¸ºnil i=m=5; åˆ¤æ–­j - i æ˜¯å¦å¤§äº1 å‘ç°æ˜¯ç­‰äº1ä¸ç¬¦åˆæ¡ä»¶,è·³å‡ºå¾ªç¯,è¿”å›i,ä¹Ÿå°±æ˜¯5 æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡ä¸è¿è´¯çš„ local myShoeStore = { \"Size 12 shoes\",--12å·é‹å­ \"Size 13 shoes\",--13å·é‹å­ [4] = \"Size 21 shoes\",--21å·é‹å­ [5] = \"Size 23 shoes\",--23å·é‹å­ } print(#myShoeStore) å¯ä»¥çœ‹åˆ°ä¸Šé¢å› ä¸ºä¸è¿è´¯ç›´æ¥å€¼è¿”å›äº†æ•°ç»„çš„é•¿åº¦,å¹¶æ²¡æœ‰åŠ ä¸Šhashçš„é•¿åº¦,ä¸»è¦åŸå› è¿˜æ˜¯æºç çš„è¿™ä¸ªåœ°æ–¹è°ƒç”¨luaH_getintå‡½æ•°è¿”å›äº†absentkey\n#tableæ±‚å¤§å°æ€»ç»“ æ‰€ä»¥ä»ä¸Šé¢çš„å„ç§åˆ†æèƒ½çœ‹å‡ºæ¥,ä¸€èˆ¬çš„æƒ…å†µä¸‹,å¦‚æœè¿™ä¸ªè¡¨ç»“æ„å¹¶ä¸æ˜¯æŒ‰æ•°å­—1~Né¡ºåºé€’å¢çš„ï¼Œé‚£ä¹ˆ#tableå–å‡ºæ¥çš„å¤§å°å¯èƒ½ä¼šæ˜¯ä¸€äº›å¥‡æ€ªçš„å€¼,æ‰€ä»¥å»ºè®®ç”¨å¦‚ä¸‹APIæ¥å£æ¥æ±‚å¤§å°\nfunction table.length(t) local i = 0 for k, v in pairs(t) do i = i + 1 end return i end è¿ç®—ç¬¦é‡è½½ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰18ä¸­ç¬¦å·èƒ½å¤Ÿå‚ä¸è¿ç®—ç¬¦é‡è½½\nCæšä¸¾ å…ƒæ–¹æ³•åå­— è§£é‡Š TM_EQ __eq å¯¹åº”è¿ç®—ç¬¦\"==â€œæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ TM_ADD __add å¯¹åº”è¿ç®—ç¬¦â€+\"ï¼ˆåŠ æ³•ï¼‰æ“ä½œ TM_SUB __sub å¯¹åº”çš„è¿ç®—ç¬¦ â€˜-â€™ï¼ˆå‡æ³•ï¼‰æ“ä½œ TM_MUL __mul å¯¹åº”è¿ç®—ç¬¦\"*\"ï¼ˆä¹˜æ³•ï¼‰æ“ä½œ TM_MOD __mod å¯¹åº”è¿ç®—ç¬¦\"%\"ï¼ˆå–æ¨¡ï¼‰æ“ä½œ TM_POW __pow å¯¹åº”è¿ç®—ç¬¦\"^\"ï¼ˆæ¬¡æ–¹ï¼‰æ“ä½œ TM_DIV __div å¯¹åº”è¿ç®—ç¬¦\"/\"ï¼ˆé™¤æ³•ï¼‰æ“ä½œ TM_IDIV __idiv å¯¹åº”è¿ç®—ç¬¦\"//\"ï¼ˆå‘ä¸‹å–æ•´é™¤æ³•ï¼‰æ“ä½œ TM_BAND __band å¯¹åº”è¿ç®—ç¬¦\"\u0026\"ï¼ˆæŒ‰ä½ä¸ï¼‰æ“ä½œ TM_BOR __bor å¯¹åº”è¿ç®—ç¬¦\"|\"ï¼ˆæŒ‰ä½æˆ–ï¼‰æ“ä½œ TM_BXOR __bxor å¯¹åº”è¿ç®—ç¬¦\"^\"ï¼ˆæŒ‰ä½å¼‚æˆ–ï¼‰æ“ä½œ TM_SHL __shl å¯¹åº”è¿ç®—ç¬¦\"Â«\"ï¼ˆå·¦ç§»ï¼‰æ“ä½œ TM_SHR __shr å¯¹åº”è¿ç®—ç¬¦\"Â»\"ï¼ˆå³ç§»ï¼‰æ“ä½œ TM_UNM __unm å¯¹åº”çš„è¿ç®—ç¬¦ â€˜-â€™ï¼ˆå–è´Ÿï¼‰æ“ä½œ TM_BNOT __bnot å¯¹åº”è¿ç®—ç¬¦\"~\"ï¼ˆæŒ‰ä½éï¼‰æ“ä½œ TM_LT __lt å¯¹åº”çš„è¿ç®—ç¬¦ â€˜\u003câ€™ï¼ˆå°äºï¼‰æ“ä½œ TM_LE __le å¯¹åº”çš„è¿ç®—ç¬¦ â€˜\u003c=â€™ï¼ˆå°äºç­‰äºï¼‰æ“ä½œ TM_CONCAT __concat å¯¹åº”çš„è¿ç®—ç¬¦ â€˜..â€™(è¿æ¥ï¼‰æ“ä½œ ç»ˆäºåˆ°äº†æœˆåº•ç›˜ç‚¹çš„æ—¥å­äº†,ä¸ºäº†èƒ½æ›´å¥½çš„ç®¡ç†åº—é¢è¿›è¡Œç›˜ç‚¹,éœ€è¦å¯¹å¾ˆå¤šæ•°æ®è¿›è¡ŒåŠ åŠ å‡å‡,å–æ¨¡,ç­‰ç­‰,è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨ä¸Šæˆ‘ä»¬çš„luaçš„18ä¸ªå…ƒæ–¹æ³•,è¿›è¡Œè¿ç®—ç¬¦é‡è½½\n__eq ä½œç”¨:æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰\nä¸‹é¢ä¾‹å­æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®è®°å½•é‡æ˜¯ä¸æ˜¯ä¸€æ ·\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 13 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 14 shoes\",80,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 21 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } --ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable inventoryOpe = {} --å®šä¹‰ç›¸ç­‰æ“ä½œæ¥æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®é‡æ˜¯ä¸æ˜¯ä¸€æ · inventoryOpe.__eq = function(table1, table2) return #table1 == #table2 end setmetatable(myShoeStore, inventoryOpe) --æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®é‡æ˜¯ä¸æ˜¯ä¸€æ · local isSame = myShoeStore == myBranchShoeStore print(isSame) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿”å›äº†falseè¯´æ˜ä¸¤å®¶åº—é”€å”®è®°å½•é‡ä¸ä¸€æ ·\n__mul ä½œç”¨:åšä¹˜æ³•æ“ä½œ\nç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’±\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 13 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 14 shoes\",80,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 21 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } --ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable inventoryOpe = {} --å®šä¹‰ä¹˜æ³•æ“ä½œæ¥ç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’± inventoryOpe.__mul = function(table1, table2) local money = 0 for _,v in pairs(table1) do money = money + (v[2] * v[3]) end for _,v in pairs(table2) do money = money + (v[2] * v[3]) end return money end setmetatable(myShoeStore, inventoryOpe) --ç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’± local money = myShoeStore * myBranchShoeStore print(money) å¯ä»¥çœ‹åˆ°æ€»çš„moneyç®—å‡ºæ¥äº†ä¸€å…±17400å…ƒ\n__add ä½œç”¨:ç”¨æ¥è¿›è¡ŒåŠ æ³•æ“ä½œ\nä¸¾ä¸ªæ —å­æ¯”å¦‚ä¸‹é¢ç”¨æ¥ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—æ€»çš„é”€å”®ç‰©å“ä¿¡æ¯\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 13 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 14 shoes\",80,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 21 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } --ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable inventoryOpe = {} --å®šä¹‰åŠ æ³•æ“ä½œç”¨æ¥ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—çš„é”€å”®æ•°æ® inventoryOpe.__add = function(table1, table2) for _, value in pairs(table2) do table.insert(table1, value) end return table1 end setmetatable(myShoeStore, inventoryOpe) --ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—æ€»çš„é”€å”®æ•°æ® local totalShoeInfo = myShoeStore + myBranchShoeStore --è¾“å‡ºä¸€ä¸‹ç»“æœ for k,v in pairs(totalShoeInfo) do local item = \"\" for i=1,3 do if i ~= 3 then item = item .. v[i] .. \",\" else item = item .. v[i] end end print(\"{\" .. item .. \"}\") end ä»ç»“æœä¸Šçœ‹,æˆ‘ä»¬å·²ç»å®Œç¾çš„æŠŠä¸¤å®¶åº—çš„æ•°æ®éƒ½ç»Ÿè®¡åˆåœ¨ä¸€å—äº†\nå…¶ä»–çš„è¿ç®—ç¬¦é‡è½½å°±ä¸åœ¨ä¸¾ä¾‹äº†,å’Œä¸Šé¢åˆ—å‡ºæ¥çš„3ä¸ªä¾‹å­éå¸¸é›·åŒ\n__call ä½œç”¨:å½“tableåå­—åšä¸ºå‡½æ•°åå­—çš„å½¢å¼è¢«è°ƒç”¨çš„æ—¶å€™,ä¼šè°ƒç”¨__callå‡½æ•°\næŸ¥çœ‹ä¸‹ä¸»åº—æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è·\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 13 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 14 shoes\",80,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ } --ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable inventoryOpe = {} --å®šä¹‰å‡½æ•°è°ƒç”¨æ“ä½œæ¥æŸ¥çœ‹ä¸‹æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è· inventoryOpe.__call = function(self,target) local num14 = 0 for _,v in pairs(self) do num14 = num14 + (v[2] * v[3]) end return target - num14 end setmetatable(myShoeStore, inventoryOpe) --æŸ¥çœ‹ä¸‹ä¸»åº—æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è· print(myShoeStore(10000))--å‡è®¾éœ€è¦æ¯æ—¥å®Œæˆ10000é‡‘é¢çš„é”€å”®é‡ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯æ—¥ç›®æ ‡é‡‘é¢å·²ç»è¶…é¢å®Œæˆ,å¹¶ä¸”è¶…äº†1400å—\n__close ä¾‹å­ ä½œç”¨:è¢«æ ‡è®°ä¸ºto-be-closedçš„å±€éƒ¨å˜é‡ä¼šåœ¨è¶…å‡ºå®ƒçš„ä½œç”¨åŸŸæ—¶,è°ƒç”¨å®ƒçš„__closedå…ƒæ–¹æ³•\ncloseå˜é‡To-be-closed Variableséœ€è¦å’Œcloseå…ƒæ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œåœ¨å˜é‡è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œä¼šè°ƒç”¨å˜é‡çš„closeå…ƒæ–¹æ³•__close,closeå˜é‡ä¸€èˆ¬ç”¨äºéœ€è¦åŠæ—¶é‡Šæ”¾çš„èµ„æºçš„æƒ…å†µ,å¤šç”¨è¿™ä¸ªå…¶å®ä¹Ÿèƒ½å‡è½»gcçš„è´Ÿæ‹…\nå½“åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 13 shoes\",50,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ {\"Size 14 shoes\",80,80},--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡ light = true, --ç¯å¼€ç€ } --ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable inventoryOpe = {} --å®šä¹‰__closeæ“ä½œå½“åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­ inventoryOpe.__close = function(self) self.light = false end setmetatable(myShoeStore, inventoryOpe) --å½“ä¸»åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­ do local closeStore \u003cclose\u003e = myShoeStore end print(myShoeStore.light) æºç åˆ†æ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ä¸€ä¸ªæ˜¯callclosemethodå’Œcheckclosemth\ncallclosemethod ä¸»è¦å°±æ˜¯ç”¨æ¥è°ƒç”¨è®¾ç½®çš„å…ƒæ–¹æ³• checkclosemth è¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥æ£€æµ‹æ˜¯å¦è®¾ç½®å¥½äº†å…ƒæ–¹æ³•,å¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯å°±ä¼šæŠ¥é”™ æ›´è¯¦ç»†çš„æ³¨é‡Šè¯·å»æˆ‘çš„GitHubåœ°å€ ä»¥ä¸‹æ˜¯æˆ‘å‡ ä¹æ¯è¡Œéƒ½åŠ äº†æ³¨é‡Šçš„GitHubåœ°å€\nltm.cæ³¨é‡Šåœ°å€\nltm.cæ³¨é‡Š\nltm.hæ³¨é‡Šåœ°å€\nltm.hæ³¨é‡Š\n",
  "wordCount" : "15296",
  "inLanguage": "en",
  "image":"https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png","datePublished": "2023-03-07T01:30:29+08:00",
  "dateModified": "2023-03-07T01:30:29+08:00",
  "author":[{
    "@type": "Person",
    "name": "frog"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frog-game.github.io/posts/read/lua5.4.4.metatable/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "frog's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frog-game.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://frog-game.github.io/" accesskey="h" title="frog&#39;s Blog (Alt + H)">
            <img src="https://frog-game.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">frog&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://frog-game.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://frog-game.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/read/">ğŸ“• é˜…è¯»</a></div>
            <h1 class="post-title">
                [Lua5.4.4æºç ].å…ƒè¡¨
            </h1>
            <div class="post-description">
                luaæºç å…ƒè¡¨åˆ†æ
            </div>
            <div class="post-meta">åˆ›å»º:&nbsp;<span title='2023-03-07 01:30:29 +0800 CST'>2023-03-07</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2023-03-07&nbsp;|&nbsp;å­—æ•°:&nbsp;15296å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;31åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;frog



                &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://frog-game.github.io/tags/lua5.4.4%E6%BA%90%E7%A0%81/">Lua5.4.4æºç </a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                <li>
                    <a href="#lua%e5%b1%82setmetatable%e5%92%8cgetmetatable%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="luaå±‚setmetatableå’Œgetmetatableä½¿ç”¨æ–¹æ³•">luaå±‚setmetatableå’Œgetmetatableä½¿ç”¨æ–¹æ³•</a></li>
                <li>
                    <a href="#c%e5%b1%82%e8%b0%83%e7%94%a8%e5%85%83%e8%a1%a8" aria-label="Cå±‚è°ƒç”¨å…ƒè¡¨">Cå±‚è°ƒç”¨å…ƒè¡¨</a></li>
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e5%85%83%e6%96%b9%e6%b3%95" aria-label="è®¾ç½®å…ƒæ–¹æ³•">è®¾ç½®å…ƒæ–¹æ³•</a><ul>
                        
                <li>
                    <a href="#__index" aria-label="__index">__index</a><ul>
                        
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e4%b8%8d%e6%98%aftable%e6%88%96%e8%80%85%e5%87%bd%e6%95%b0%e6%97%b6%e5%80%99" aria-label="__indexå…ƒæ–¹æ³•è®¾ç½®çš„ä¸æ˜¯table,æˆ–è€…å‡½æ•°æ—¶å€™"><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„ä¸æ˜¯table,æˆ–è€…å‡½æ•°æ—¶å€™</a></li>
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%aftable" aria-label="__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯table"><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯table</a></li>
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯å‡½æ•°"><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯å‡½æ•°</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%9c%89%e4%ba%9b%e5%9c%b0%e6%96%b9__index%e5%85%83%e6%96%b9%e6%b3%95%e8%a6%81%e6%8c%87%e5%90%91%e8%87%aa%e5%b7%b1" aria-label="ä¸ºä»€ä¹ˆæœ‰äº›åœ°æ–¹__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±">ä¸ºä»€ä¹ˆæœ‰äº›åœ°æ–¹<code>__index</code>å…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±</a></li>
                <li>
                    <a href="#__index%e5%ae%9e%e7%8e%b0%e7%9a%84%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1" aria-label="__indexå®ç°çš„é¢å‘å¯¹è±¡">__indexå®ç°çš„é¢å‘å¯¹è±¡</a></li></ul>
                </li>
                <li>
                    <a href="#__newindex" aria-label="__newindex">__newindex</a><ul>
                        
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e4%b8%8d%e6%98%aftable%e4%b9%9f%e4%b8%8d%e6%98%af%e5%87%bd%e6%95%b0%e7%9a%84%e6%97%b6%e5%80%99" aria-label="__newindexè®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™">__newindexè®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™</a></li>
                <li>
                    <a href="#_%e5%85%83%e8%a1%a8%e6%b2%a1%e6%9c%89_%e8%ae%be%e7%bd%aenewindex%e7%9a%84%e6%97%b6%e5%80%99" aria-label="_å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™">_å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™</a></li>
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%aftable" aria-label="__newindexè®¾ç½®çš„æ˜¯table">__newindexè®¾ç½®çš„æ˜¯table</a></li>
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__newindexè®¾ç½®çš„æ˜¯å‡½æ•°">__newindexè®¾ç½®çš„æ˜¯å‡½æ•°</a></li></ul>
                </li>
                <li>
                    <a href="#__gc" aria-label="__gc">__gc</a><ul>
                        
                <li>
                    <a href="#__gc%e6%8c%87%e5%90%91%e7%9a%84%e4%b8%8d%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__gcæŒ‡å‘çš„ä¸æ˜¯å‡½æ•°">__gcæŒ‡å‘çš„ä¸æ˜¯å‡½æ•°</a></li>
                <li>
                    <a href="#__gc%e6%8c%87%e5%90%91%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__gcæŒ‡å‘çš„æ˜¯å‡½æ•°">__gcæŒ‡å‘çš„æ˜¯å‡½æ•°</a></li></ul>
                </li>
                <li>
                    <a href="#__mode" aria-label="__mode">__mode</a><ul>
                        
                <li>
                    <a href="#%e5%85%a5%e5%8f%a3%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90" aria-label="å…¥å£æºç å‰–æ">å…¥å£æºç å‰–æ</a></li>
                <li>
                    <a href="#%e5%bc%b1%e8%a1%a8%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90" aria-label="å¼±è¡¨åŸç†å‰–æ">å¼±è¡¨åŸç†å‰–æ</a></li></ul>
                </li>
                <li>
                    <a href="#__len" aria-label="__len">__len</a><ul>
                        
                <li>
                    <a href="#%e4%be%8b%e5%ad%90" aria-label="ä¾‹å­">ä¾‹å­</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3" aria-label="æºç è®²è§£">æºç è®²è§£</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%b1%82table%e9%95%bf%e5%ba%a6%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%85%e5%86%b5" aria-label="ç”¨#æ±‚tableé•¿åº¦çš„ä¸€äº›æƒ…å†µ">ç”¨#æ±‚tableé•¿åº¦çš„ä¸€äº›æƒ…å†µ</a><ul>
                        
                <li>
                    <a href="#%e5%85%a8%e9%83%a8%e4%b8%ba%e6%95%b0%e7%bb%84%e6%b2%a1%e6%9c%89hash%e9%83%a8%e5%88%86" aria-label="å…¨éƒ¨ä¸ºæ•°ç»„,æ²¡æœ‰hashéƒ¨åˆ†">å…¨éƒ¨ä¸ºæ•°ç»„,æ²¡æœ‰<code>hash</code>éƒ¨åˆ†</a><ul>
                        
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e4%b8%8d%e6%98%afnil" aria-label="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯nil">tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯nil</a></li>
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e6%98%afnil%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%80%92%e6%95%b0%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%b8%8d%e6%98%afnil" aria-label="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil">tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil</a></li>
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e6%98%afnil%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%80%92%e6%95%b0%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%b9%9f%e6%98%afnil" aria-label="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nil">tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nil</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%a8%e9%83%a8%e4%b8%bahash%e6%b2%a1%e6%9c%89%e6%95%b0%e7%bb%84" aria-label="å…¨éƒ¨ä¸ºhash,æ²¡æœ‰æ•°ç»„">å…¨éƒ¨ä¸º<code>hash</code>,æ²¡æœ‰æ•°ç»„</a></li>
                <li>
                    <a href="#%e6%9c%89hash%e6%9c%89%e6%95%b0%e7%bb%84%e7%9a%84%e6%83%85%e5%86%b5" aria-label="æœ‰hashæœ‰æ•°ç»„çš„æƒ…å†µ">æœ‰hashæœ‰æ•°ç»„çš„æƒ…å†µ</a><ul>
                        
                <li>
                    <a href="#%e6%9c%89%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%b9%b6%e4%b8%94%e5%92%8chash%e9%83%a8%e5%88%86%e4%b8%8b%e6%a0%87%e8%bf%9e%e8%b4%af%e7%9a%84" aria-label="æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡è¿è´¯çš„">æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡è¿è´¯çš„</a></li>
                <li>
                    <a href="#%e6%9c%89%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%b9%b6%e4%b8%94%e5%92%8chash%e9%83%a8%e5%88%86%e4%b8%8b%e6%a0%87%e4%b8%8d%e8%bf%9e%e8%b4%af%e7%9a%84" aria-label="æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡ä¸è¿è´¯çš„">æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡ä¸è¿è´¯çš„</a></li></ul>
                </li>
                <li>
                    <a href="#table%e6%b1%82%e5%a4%a7%e5%b0%8f%e6%80%bb%e7%bb%93" aria-label="#tableæ±‚å¤§å°æ€»ç»“">#tableæ±‚å¤§å°æ€»ç»“</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%90%e7%ae%97%e7%ac%a6%e9%87%8d%e8%bd%bd" aria-label="è¿ç®—ç¬¦é‡è½½">è¿ç®—ç¬¦é‡è½½</a><ul>
                        
                <li>
                    <a href="#__eq" aria-label="__eq">__eq</a></li>
                <li>
                    <a href="#__mul" aria-label="__mul">__mul</a></li>
                <li>
                    <a href="#__add" aria-label="__add">__add</a></li></ul>
                </li>
                <li>
                    <a href="#__call" aria-label="__call">__call</a></li>
                <li>
                    <a href="#__close" aria-label="__close">__close</a><ul>
                        
                <li>
                    <a href="#%e4%be%8b%e5%ad%90-1" aria-label="ä¾‹å­">ä¾‹å­</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="æºç åˆ†æ">æºç åˆ†æ</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%9b%b4%e8%af%a6%e7%bb%86%e7%9a%84%e6%b3%a8%e9%87%8a%e8%af%b7%e5%8e%bb%e6%88%91%e7%9a%84github%e5%9c%b0%e5%9d%80" aria-label="æ›´è¯¦ç»†çš„æ³¨é‡Šè¯·å»æˆ‘çš„GitHubåœ°å€">æ›´è¯¦ç»†çš„æ³¨é‡Šè¯·å»æˆ‘çš„GitHubåœ°å€</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="å‰è¨€"><span>å‰è¨€</span></h2>
<p><code>lua5.4.4</code>å…ƒè¡¨ç°åœ¨å·²ç»åŠ åˆ°äº†<code>25</code>ä¸ªç±»å‹</p>
<p>ç®€å•æ¥è¯´å…ƒæ–¹æ³•çš„ä½œç”¨æ˜¯å› ä¸ºä½¿ç”¨<code>lua</code>åŸå§‹è¯­æ³•ä¸èƒ½åšåˆ°æ‰€éœ€çš„è¦æ±‚æ¯”å¦‚å¯¹ä¸¤ä¸ª<code>table</code>è¿›è¡ŒåŠ å‡ä¹˜é™¤,æˆ–è€…æˆ‘åœ¨é€€å‡ºä½œç”¨åŸŸçš„æ—¶å€™æƒ³è¦å¿«é€Ÿçš„æ¸…é™¤è‡ªå·±è‡ªå®šä¹‰çš„ä¸€äº›æ•°æ®,ç­‰ç­‰å…¶ä»–ä¸€äº›ç‰¹æ®Šéœ€æ±‚</p>
<p>å¦‚æœå¤§å®¶å¯¹<code>C++</code>çš„é‡è½½è¿ç®—ç¬¦æ¯”è¾ƒç†Ÿæ‚‰,æˆ–è®¸èƒ½å¤Ÿæ›´åŠ æ¸…æ™°çš„äº†è§£å…ƒè¡¨çš„ä½œç”¨,å…¶å®ä¸¤è€…æœ‰å¼‚æ›²åŒå·¥çš„ä½œç”¨</p>
<p><img loading="lazy" src="image-20230304172037144.png" alt="image-20230304172037144"  />
</p>
<p><img loading="lazy" src="image-20230304163913227.png" alt="image-20230304163913227"  />
</p>
<p><img loading="lazy" src="image-20230304163930013.png" alt="image-20230304163930013"  />
</p>
<p><img loading="lazy" src="image-20230304164027724.png" alt="image-20230304164027724"  />
</p>
<p>ä»ä¸Šé¢çš„æºä»£ç æˆ‘ä»¬å¯ä»¥åˆ†æå‡º</p>
<ul>
<li><code>lua</code>ä¸­çš„æ¯ä¸ªå€¼éƒ½å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªå…ƒè¡¨</li>
<li><code>table</code>å’Œ<code>userdata</code>å„è‡ªæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å…ƒè¡¨</li>
<li>é<code>table</code>å’Œ<code>userdata</code>çš„å…ƒè¡¨ç»Ÿç»Ÿæ”¾åˆ°äº†<code>global_State</code>çš„<code>mt</code>æ•°ç»„å½“ä¸­</li>
</ul>
<p><img loading="lazy" src="image-20230304172328493.png" alt="image-20230304172328493"  />
</p>
<p><img loading="lazy" src="image-20230304164703349.png" alt="image-20230304164703349"  />
</p>
<ul>
<li>ä»å¯¹å¤–<code>lua</code>å±‚çš„<code>API</code>æ¥å£æ¥çœ‹,æˆ‘ä»¬èƒ½çœ‹åˆ°åœ¨<code>lua</code>å±‚åªèƒ½æŒ‰è®¾ç½®<code>table</code>çš„å…ƒè¡¨,è€Œå…¶ä»–ç±»å‹çš„å…ƒè¡¨è®¾ç½®å¹¶æ²¡æœ‰å¯¹å¤–çš„<code>lua</code>å±‚<code>API</code>æ¥å£,luaä¸­æä¾›çš„ä¸¤ä¸ªå‚æ•°å¦‚ä¸‹</li>
<li><strong>setmetatable(table,metatable)</strong></li>
<li><strong>getmetatable(table)</strong></li>
<li>å…¶ä»–ç±»å‹è®¾ç½®å…ƒè¡¨åªèƒ½é€šè¿‡cä»£ç æä¾›çš„<code>API</code>æ¥å£åˆ›å»ºå…ƒè¡¨,æ¯”å¦‚<code>luaL_newmetatable</code></li>
</ul>
<h2 id="luaå±‚setmetatableå’Œgetmetatableä½¿ç”¨æ–¹æ³•"><span>luaå±‚setmetatableå’Œgetmetatableä½¿ç”¨æ–¹æ³•</span></h2>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>C</code>ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#cdcd00">const</span> luaL_Reg base_funcs[] <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>  {<span style="color:#cd0000">&#34;getmetatable&#34;</span>, luaB_getmetatable},
</span></span><span style="display:flex;"><span>  {<span style="color:#cd0000">&#34;setmetatable&#34;</span>, luaB_setmetatable},
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">/// @brief 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// lua_getmetatableï¼šå¦‚æœè¯¥ç´¢å¼•å¤„çš„å€¼æœ‰å…ƒè¡¨,åˆ™å°†å…¶å…ƒè¡¨å‹æ ˆ,è¿”å› 1 ã€‚ å¦åˆ™ä¸ä¼šå°†ä»»ä½•ä¸œè¥¿å…¥æ ˆ,è¿”å› 0 ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// luaL_getmetafieldï¼šå°†ç´¢å¼• obj å¤„å¯¹è±¡çš„å…ƒè¡¨ä¸­ __metatable åŸŸçš„å€¼å‹æ ˆã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰å…ƒè¡¨,æˆ–æ˜¯è¯¥å…ƒè¡¨æ²¡æœ‰ç›¸å…³åŸŸ, æ­¤å‡½æ•°ä»€ä¹ˆä¹Ÿä¸ä¼šå‹æ ˆå¹¶è¿”å› LUA_TNILã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#000080">/// @param L 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">/// @return 
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> luaB_getmetatable (lua_State <span style="color:#39c">*</span>L) {
</span></span><span style="display:flex;"><span>  luaL_checkany(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">if</span> (<span style="color:#39c">!</span>lua_getmetatable(L, <span style="color:#cd00cd">1</span>)) {
</span></span><span style="display:flex;"><span>    lua_pushnil(L);
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;  <span style="color:#000080">/* no metatable */</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  luaL_getmetafield(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;__metatable&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;  <span style="color:#000080">/* returns either __metatable field (if present) or metatable */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">// LUA_TNILå®šä¹‰åœ¨lua.hä¸­ æ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// lua_setmetatableï¼šæŠŠä¸€å¼ è¡¨å¼¹å‡ºæ ˆ,å¹¶å°†å…¶è®¾ä¸ºç»™å®šç´¢å¼•å¤„çš„å€¼çš„å…ƒè¡¨ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// a = {}
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// setmetatable(a,{__metatable = &#34;hello&#34;})
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// setmetatable(a,{__metatable = &#34;world&#34;})
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// è¿™ç§æƒ…å†µå°±ä¼šæŠ¥é”™
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// ä¹Ÿå°±æ˜¯è¯´ __metatableè¿™ä¸ªæ˜¯ä¿æŠ¤å…ƒè¡¨,ä¸å¯è¯»å†™
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> luaB_setmetatable (lua_State <span style="color:#39c">*</span>L) {
</span></span><span style="display:flex;"><span>  <span style="color:#00cd00">int</span> t <span style="color:#39c">=</span> lua_type(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>  luaL_checktype(L, <span style="color:#cd00cd">1</span>, LUA_TTABLE);
</span></span><span style="display:flex;"><span>  luaL_argexpected(L, t <span style="color:#39c">==</span> LUA_TNIL <span style="color:#39c">||</span> t <span style="color:#39c">==</span> LUA_TTABLE, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;nil or table&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">if</span> (l_unlikely(luaL_getmetafield(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;__metatable&#34;</span>) <span style="color:#39c">!=</span> LUA_TNIL))
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> luaL_error(L, <span style="color:#cd0000">&#34;cannot change a protected metatable&#34;</span>);
</span></span><span style="display:flex;"><span>  lua_settop(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>  lua_setmetatable(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>ä»æºç çœ‹å‡ºå½“æˆ‘ä»¬åœ¨<code>lua</code>å±‚ç¬¬ä¸€æ¬¡è°ƒç”¨<code>getmetatable(table)</code>çš„æ—¶å€™å¦‚æœ<code>table</code>æ²¡æœ‰è®¾ç½®å…ƒè¡¨å°±ä¼šè¿”å›ä¸€ä¸ª<code>nil</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> t <span style="color:#39c">=</span> getmetatable({})
</span></span><span style="display:flex;"><span>print(t)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304210228115.png" alt="image-20230304210228115"  />
</p>
</li>
<li>
<p>å¦‚æœè®¾ç½®çš„æ˜¯æ™®é€šå…ƒè¡¨,é‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›æ™®é€šå…ƒè¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> { 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> { }
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;m1 table addr:&#34;</span>, t2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;getmetatable addr:&#34;</span>, getmetatable(tt))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304213851676.png" alt="image-20230304213851676"  />
</p>
<p>ä»è¿™ä¸ªç¤ºä¾‹çš„<code>lua</code>ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>t2 table</code>çš„åœ°å€æ˜¯<code>0000018860667A90</code> è€Œ <code>getmetatable(tt)</code>çš„åœ°å€ä¹Ÿæ˜¯<code>0000018860667A90</code> æ‰€ä»¥ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…¶å®è¿™ä»£ç æ˜¯<code>lua tt table</code>è¡¨é‡Œé¢çš„<code>c</code>ç»“æ„ä½“<code>Table</code>é‡Œé¢çš„<code>metatable</code>æŒ‡é’ˆæŒ‡å‘äº†<code>lua t2 table</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>typedef struct Table {
</span></span><span style="display:flex;"><span>  struct Table <span style="color:#39c">*</span>metatable;<span style="color:#39c">//</span><span style="">è¿™ä¸ªåœ°æ–¹å¦‚æœè®¾ç½®äº†å…ƒè¡¨å°±ä¼šé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘è®¾ç½®çš„å…ƒè¡¨</span>
</span></span><span style="display:flex;"><span>} Table;
</span></span></code></pre></div><p>ç¤ºæ„å›¾å¦‚ä¸‹</p>
<p><img loading="lazy" src="image-20230304214800149.png" alt="image-20230304214800149"  />
</p>
</li>
<li>
<p>å¦‚æœè®¾ç½®äº†<code>__metatable</code>å­—æ®µé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›äºè¿™ä¸ªå­—æ®µç›¸å…³çš„å€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> { 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span> [<span style="color:#cd0000">&#34;__metatable&#34;</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello world!!!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;getmetatable:&#34;</span>, getmetatable(tt))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304215106783.png" alt="image-20230304215106783"  />
</p>
<p>ä»ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚æœ<code>t2</code>è¡¨é‡Œé¢çš„<code>__metatable</code>çš„å­—æ®µè®¾ç½®å†…å®¹é‚£ä¹ˆå°±ä¼šç›´æ¥è¾“å‡º__<code>metatable</code>çš„å­—æ®µå†…å®¹</p>
<p>ç¤ºæ„å›¾å¦‚ä¸‹</p>
<p><img loading="lazy" src="image-20230304215439196.png" alt="image-20230304215439196"  />
</p>
</li>
<li>
<p>å½“ç„¶é™¤äº†è¿™ä¸ªæˆ‘ä»¬è¿˜è¦æ³¨æ„çš„æ˜¯<code>__metatable</code>å­—æ®µæ˜¯æœ‰ä¿æŠ¤æœºåˆ¶çš„ä¸å¯é‡å†™</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>a <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>setmetatable(a,{__metatable <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello&#34;</span>})
</span></span><span style="display:flex;"><span>setmetatable(a,{__metatable <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;world&#34;</span>})
</span></span></code></pre></div><p>æ‰§è¡Œç»“æœ</p>
<p><img loading="lazy" src="image-20230304221727712.png" alt="image-20230304221727712"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æ­¤å¤„æŠ¥é”™äº†è¾“å‡ºäº†<code>cannot change a protected metatable</code>é”™è¯¯æç¤º</p>
</li>
<li>
<p>è¿˜æœ‰ä¸€ç‚¹æ˜¯å…ƒè¡¨å…¶å®æ˜¯å¯ä»¥å…±äº«çš„æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> {    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt2 <span style="color:#39c">=</span> {    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span> [<span style="color:#cd0000">&#34;__metatable&#34;</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>setmetatable(tt2, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;get tt metatable :&#34;</span>, getmetatable(tt))
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;get tt2 metatable :&#34;</span>, getmetatable(tt2))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304222254722.png" alt="image-20230304222254722"  />
</p>
<p>å¯ä»¥çœ‹åˆ°<code>ttå’Œtt2</code>æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå…ƒè¡¨t2,ç„¶ååŒæ—¶è¾“å‡ºäº†ç›¸åŒçš„å†…å®¹<code>hello world</code></p>
<p>å¤§æ¦‚ç¤ºæ„å›¾å¦‚ä¸‹</p>
<p><img loading="lazy" src="image-20230304222520657.png" alt="image-20230304222520657"  />
</p>
</li>
</ul>
<h2 id="cå±‚è°ƒç”¨å…ƒè¡¨"><span>Cå±‚è°ƒç”¨å…ƒè¡¨</span></h2>
<p>å…¶å®åœ¨ä¹‹å‰è§£é‡Š<code>lua</code>æºç ç±»å‹ä¸­çš„<code>full userdata</code>çš„æ—¶å€™å…¶å®å°±æè¿°è¿‡äº†<code>C</code>æ˜¯æ€ä¹ˆä½¿ç”¨<code>luaL_newmetatable</code> <code>luaL_getmetatable</code> <code>lua_setmetatable</code> æ¥æ˜¯<code>full userdata</code>èµ·ä½œç”¨çš„</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">//cæ–‡ä»¶ 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">//#include &lt;string.h&gt;  
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lua.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lauxlib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lualib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;iostream&gt;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#cdcd00">struct</span> StudentTag
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">char</span><span style="color:#39c">*</span> strName; <span style="color:#000080">// å­¦ç”Ÿå§“å
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> CFunStudent(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">size_t</span> iBytes <span style="color:#39c">=</span> <span style="color:#cdcd00">sizeof</span>(<span style="color:#cdcd00">struct</span> StudentTag);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent;
</span></span><span style="display:flex;"><span>	pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)lua_newuserdata(L, iBytes);
</span></span><span style="display:flex;"><span>	<span style="color:#000080">//è®¾ç½®å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_getmetatable(L, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_setmetatable(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetName(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_pushstring(L, pStudent<span style="color:#39c">-&gt;</span>strName);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetName(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯userdata
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">const</span> <span style="color:#00cd00">char</span><span style="color:#39c">*</span> pName <span style="color:#39c">=</span> luaL_checkstring(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	luaL_argcheck(L, pName <span style="color:#39c">!=</span> <span style="color:#cd00cd">NULL</span> <span style="color:#39c">&amp;&amp;</span> pName <span style="color:#39c">!=</span> <span style="color:#cd0000">&#34;&#34;</span>, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;Wrong Parameter&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pStudent<span style="color:#39c">-&gt;</span>strName <span style="color:#39c">=</span> (<span style="color:#00cd00">char</span><span style="color:#39c">*</span>)pName;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span>  luaL_Reg arrayFunc_meta[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getName&#34;</span>, GetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setName&#34;</span>, SetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> luaL_Reg arrayFunc[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;new&#34;</span>, Student},
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span>  _declspec(dllexport) <span style="color:#00cd00">int</span> luaopen_mytestlib(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#000080">// åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_newmetatable(L, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// å…ƒè¡¨.__index = å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setfield(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;__index&#34;</span>);
</span></span><span style="display:flex;"><span>	luaL_setfuncs(L, arrayFunc_meta, <span style="color:#cd00cd">0</span>);
</span></span><span style="display:flex;"><span>	luaL_newlib(L, arrayFunc);
</span></span><span style="display:flex;"><span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setglobal(L, <span style="color:#cd0000">&#34;StudentModule&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">-- lua æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>require <span style="color:#cd0000">&#34;mytestlib&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> objStudent <span style="color:#39c">=</span> StudentModule.new()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objStudent:setName(<span style="color:#cd0000">&#34;11111&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> strName <span style="color:#39c">=</span> objStudent:getName()
</span></span><span style="display:flex;"><span>print(strName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(getmetatable(objStudent)) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(tostring(k),tostring(v))
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>å¤§æ¦‚æµç¨‹å›¾å¦‚ä¸‹</p>
<p><img loading="lazy" src="image-20230305135151916.png" alt="image-20230305135151916"  />
</p>
<ul>
<li>é¦–å…ˆåœ¨<code>ENV</code>é‡Œé¢æ³¨å†Œäº†æ¨¡å—<code>studentModule</code>,ç­‰ä»·äº_<code>ENV[&quot;studentModule&quot;] = table</code></li>
<li>ç„¶åè¿™ä¸ª<code>table</code>é‡Œé¢å­˜æœ‰<code>lua</code>çš„æ¥å£<code>new</code>å’ŒæŒ‡å‘<code>c</code>å±‚å‡½æ•°æŒ‡é’ˆçš„<code>CFunstudent</code></li>
<li>é€šè¿‡å‡½æ•°æŒ‡é’ˆçš„<code>CFunstudent</code>æŒ‡å‘çš„<code>CFunstudent</code>å‡½æ•°æˆ‘ä»¬åˆ›å»ºäº†ä¸€å—å†…å­˜åŒºåŸŸ</li>
<li>å› ä¸º<code>userdata</code>ä¹Ÿå’Œ<code>table</code>ç»“æ„ä¸€æ ·éƒ½èƒ½è®¾ç½®å…ƒè¡¨,ä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡å…ƒè¡¨,èƒ½ç»™<code>lua</code>å±‚æä¾›æ¥å£æ¥æ“ä½œè¿™å—<code>userdata</code></li>
<li>æ‰€ä»¥åé¢è¿™éƒ¨åˆ†å°±æ˜¯åˆ›å»ºå…ƒè¡¨,å¹¶é€šè¿‡å…ƒè¡¨å†…éƒ¨çš„<code>setName</code>å’Œ<code>getName</code>å‡½æ•°å¯¹<code>userdata</code>è¿›è¡Œäº†æ“ä½œ,æœ‰ç‚¹åƒæˆ‘ä»¬ä¸èƒ½å¾ˆæ–¹ä¾¿å»ç›´æ¥æ§åˆ¶ç”µè§†æœºçš„ç”µè·¯æ¿[<code>userdata</code>],æ‰€ä»¥å‘æ˜äº†é¥æ§å™¨[<code>å…ƒè¡¨</code>],æ–¹ä¾¿ç”¨æˆ·[<code>luaå±‚</code>]é€šè¿‡é¥æ§å™¨æ§åˆ¶ç”µè§†æœºæ¢å°ä»€ä¹ˆçš„æ“ä½œ</li>
</ul>
<h2 id="è®¾ç½®å…ƒæ–¹æ³•"><span>è®¾ç½®å…ƒæ–¹æ³•</span></h2>
<table>
<thead>
<tr>
<th>Cæšä¸¾</th>
<th>å…ƒæ–¹æ³•åå­—</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>TM_INDEX</td>
<td>__index</td>
<td>ç´¢å¼•table[key] è®¿é—®è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼</td>
</tr>
<tr>
<td>TM_NEWINDEX</td>
<td>__newindex</td>
<td>ç´¢å¼•èµ‹å€¼ table[key] = value å¯¹è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼è¿›è¡Œèµ‹å€¼</td>
</tr>
<tr>
<td>TM_GC</td>
<td>__gc</td>
<td>å½“å¯¹è±¡è¢«gcå›æ”¶æ—¶å°†ä¼šè°ƒç”¨gcå…ƒæ–¹æ³•</td>
</tr>
<tr>
<td>TM_MODE</td>
<td>__mode</td>
<td>å¼±å¼•ç”¨è¡¨</td>
</tr>
<tr>
<td>TM_LEN</td>
<td>__len</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;#&quot; å–å¯¹è±¡é•¿åº¦</td>
</tr>
<tr>
<td>TM_EQ</td>
<td>__eq</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;==&ldquo;æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰</td>
</tr>
<tr>
<td>TM_ADD</td>
<td>__add</td>
<td>å¯¹åº”è¿ç®—ç¬¦&rdquo;+&quot;ï¼ˆåŠ æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SUB</td>
<td>__sub</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;-&rsquo;ï¼ˆå‡æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_MUL</td>
<td>__mul</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;*&quot;ï¼ˆä¹˜æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_MOD</td>
<td>__mod</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;%&quot;ï¼ˆå–æ¨¡ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_POW</td>
<td>__pow</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;^&quot;ï¼ˆæ¬¡æ–¹ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_DIV</td>
<td>__div</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;/&quot;ï¼ˆé™¤æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_IDIV</td>
<td>__idiv</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;//&quot;ï¼ˆå‘ä¸‹å–æ•´é™¤æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BAND</td>
<td>__band</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&amp;&quot;ï¼ˆæŒ‰ä½ä¸ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BOR</td>
<td>__bor</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;|&quot;ï¼ˆæŒ‰ä½æˆ–ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BXOR</td>
<td>__bxor</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;^&quot;ï¼ˆæŒ‰ä½å¼‚æˆ–ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SHL</td>
<td>__shl</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&laquo;&quot;ï¼ˆå·¦ç§»ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SHR</td>
<td>__shr</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&raquo;&quot;ï¼ˆå³ç§»ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_UNM</td>
<td>__unm</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;-&rsquo;ï¼ˆå–è´Ÿï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BNOT</td>
<td>__bnot</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;~&quot;ï¼ˆæŒ‰ä½éï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_LT</td>
<td>__lt</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;&lt;&rsquo;ï¼ˆå°äºï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_LE</td>
<td>__le</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;&lt;=&rsquo;ï¼ˆå°äºç­‰äºï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_CONCAT</td>
<td>__concat</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;..&rsquo;(è¿æ¥ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_CALL</td>
<td>__call</td>
<td>å‡½æ•°è°ƒç”¨æ“ä½œ func(args)</td>
</tr>
<tr>
<td>TM_CLOSE</td>
<td>__close</td>
<td>è¢«æ ‡è®°ä¸ºto-be-closedçš„å±€éƒ¨å˜é‡<br />ä¼šåœ¨è¶…å‡ºå®ƒçš„ä½œç”¨åŸŸæ—¶,è°ƒç”¨å®ƒçš„__closedå…ƒæ–¹æ³•</td>
</tr>
</tbody>
</table>
<h3 id="__index"><span>__index</span></h3>
<p>ä¸¾ä¸ªç°å®ä¸­çš„ä¾‹å­,æ¯”å¦‚ä½ ç°åœ¨å»è¡—ä¸Šä¹°é‹å­,æ¥åˆ°äº†é‹æŸœ,ä½ éå¸¸å–œæ¬¢è¿™åŒé‹å­,ä½†æ˜¯è¿™å®¶åº—é‡Œé¢æ²¡æœ‰è¿™åŒæ¬¾å¼çš„é‹å­äº†,ä¸€èˆ¬æ¥è¯´åº—å®¶éƒ½ä¼šè¯´,ä¸ç€æ€¥ä½ ç­‰ç­‰,æˆ‘å»å…¶ä»–åˆ†åº—å¸®ä½ è°ƒé…ä¸€ä¸‹é‹å­,æ‚¨æ˜¯ç­‰ç­‰è¿˜æ˜¯æˆ‘é‚®å¯„ç»™ä½ è¿‡å»å‘¢</p>
<p>å…¶å®è¿™å¿«,å½“åº—å®¶æ²¡æœ‰é‹å­çš„æ—¶å€™,å»å…¶ä»–åˆ†åº—è°ƒé…å’Œ<code>lua</code>çš„<code>__index</code>å¾ˆåƒ</p>
<ol>
<li>é¦–å…ˆæˆ‘ä½œä¸ºåº—å®¶ä»Šå¤©åº“å­˜åªæœ‰<code>12</code>å·å’Œ<code>13</code>å·æ¬¾å¼çš„é‹å­,<code>lua</code>ä¼ªä»£ç å¦‚ä¸‹</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ä¸ªæ—¶å€™æ¥äº†ä¸ªå°çº¢é—®é—®æœ‰æ²¡æœ‰<code>20</code>å·æ¬¾å¼çš„é‹å­,è¯´éå¸¸å–œæ¬¢è¿™æ ·æ¬¾å¼çš„,ä½œä¸ºåº—ä¸»é¦–å…ˆä½ æŸ¥äº†ä¸‹è‡ªå·±çš„åº“å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306144628009.png" alt="image-20230306144628009"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿”å›äº†nil,è¯´æ˜æˆ‘ç°åœ¨çš„åº—é“ºå·²ç»æ²¡æœ‰20å·é‹å­çš„åº“å­˜äº†,ä¸ºäº†ç•™ä½é¡¾å®¢,ä½ åªèƒ½å»åˆ†åº—æŸ¥æ‰¾,æ¯•ç«Ÿä¸€å•ç”Ÿæ„ä¸€ä»½æ”¶å…¥,æŒ£é’±å˜›ä¸å¯’ç¢œ,é‚£æ€ä¹ˆæ ·æ‰èƒ½å’Œåˆ†åº—æŒ‚é’©èµ·æ¥,è®©æˆ‘èƒ½æ–¹ä¾¿çš„æŸ¥æ‰¾å‘¢,ç›¸ä¿¡èªæ˜çš„ä½ è‚¯å®šæƒ³åˆ°äº†__indexå…ƒæ–¹æ³•,æ²¡é”™å°±æ˜¯å®ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> {<span style="color:#000080">--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__indexæ¥è¿›è¡Œå…³è”æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span>           num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306151356327.png" alt="image-20230306151356327"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šå›¾çš„è¾“å‡º,å®Œç¾æ‰¾åˆ°äº†<code>20</code>å·çš„é‹å­,ç•™ä¸‹äº†è¿™ç¬”ç”Ÿæ„,å½“ç„¶å¦‚æœä½ åˆ†åº—æ›´å¤š,é‚£ä¹ˆä½ å¯ä»¥ä¸€ç›´ç”¨<code>__index</code>å…ƒæ–¹æ³•ä¸²è¿ä¸‹å»,ç›´åˆ°ä½ æ‰¾åˆ°ä½ æƒ³è¦çš„æ•°æ®</p>
<p><strong>æ€»ç»“:</strong><code>å®šä¹‰äº†åœ¨tableä¸­é€šè¿‡ç»™å®šçš„keyæ‰¾åˆ°çš„valueä¸ºnilæ—¶æ€ä¹ˆåŠçš„è¡Œä¸º</code></p>
<p>ä¸‹é¢æˆ‘ä»¬åœ¨è¿›è¡Œä¸€ä¸‹å…³é”®æºç ç‚¹åˆ†æ</p>
<p><img loading="lazy" src="image-20230305181819971.png" alt="image-20230305181819971"  />
</p>
<p>ä¸Šé¢çš„æºç å°±æ˜¯è®¾ç½®<code>__index</code>å…ƒæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘åœ°æ–¹</p>
<ul>
<li>é¦–å…ˆç¬¬ä¸€æ­¥ä¼šåˆ¤æ–­<code>slot</code>æ˜¯ä¸æ˜¯<code>null</code>,å¦‚æœæ˜¯é‚£ä¹ˆå°±è¯´æ˜<code>t</code>å˜é‡ä¸æ˜¯<code>table</code>,å°±ç›´æ¥æŠ¥é”™è·³è¿‡</li>
<li>ç¬¬äºŒæ­¥å¦‚æœ<code>slot</code>ä¸æ˜¯<code>null</code>é‚£è¯´æ˜<code>t</code>æ˜¯ä¸€ä¸ª<code>table</code>,è¿™ä¸ªæ—¶å€™æˆ‘ä»¬é€šè¿‡<code>TM_INDEX</code>ç´¢å¼•æ‰¾åˆ°<code>table</code>å¯¹åº”çš„<code>metatable</code>å…ƒæ–¹æ³•</li>
<li>å¾—åˆ°äº†å…ƒæ–¹æ³•æŒ‡é’ˆä»¥å,æˆ‘ä»¬åœ¨åˆ¤æ–­ä¸€ä¸‹å¦‚æœæŒ‡é’ˆæ˜¯<code>null</code>é‚£ä¹ˆå°±è¯´æ˜æ²¡æœ‰è®¾ç½®å…ƒæ–¹æ³•,é‚£ä¹ˆåªè¦ç›´æ¥è¿”å›<code>nil</code>å°±å¯ä»¥äº†</li>
<li>èµ°åˆ°äº†è¿™ä¸€æ­¥äº†,é‚£ä¹ˆè¯´æ˜æˆ‘ä»¬æ‰¾åˆ°äº†<code>TM_INDEX</code>å¯¹åº”çš„å…ƒæ–¹æ³•äº†,æ³¨æ„å“ˆ,é‡ç‚¹æ¥äº†
<ul>
<li>å¦‚æœå…ƒæ–¹æ³•æ˜¯ä¸ªå‡½æ•°,é‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>luaT_callTMres</code>æŠŠå‡½æ•°å…¥æ ˆ,å¹¶ä¸”æŠŠç»“æœæ±‚å‡ºæ¥,å½“åšæŸ¥è¯¢ç»“æœ</li>
<li>å¦‚æœå…ƒæ–¹æ³•æ˜¯ä¸ª<code>table</code>,é‚£ä¹ˆå°±ç›´æ¥æ±‚å…ƒç´ ä¸‹æ ‡ä¸º<code>key</code>çš„<code>table</code>å†…å®¹,ä¹Ÿå°±æ˜¯<code>tm[key]</code>æŒ‡å‘çš„å†…å®¹</li>
<li>å¦‚æœä¸Šé¢éƒ½ä¸æ»¡è¶³,æ—¢ä¸æ˜¯è¡¨,åˆä¸æ˜¯å‡½æ•°,å°±ç›´æ¥è¿”å›<code>slot</code>ä¸º<code>null</code>,ç»“æœä¸º<code>0</code></li>
</ul>
</li>
</ul>
<p><strong>ç»¼åˆæ€»ç»“</strong></p>
<p><code>luaä»£ç ä»è¡¨tä¸­æŸ¥æ‰¾é”®kæ—¶,luaå¤„ç†æµç¨‹å¦‚ä¸‹:</code></p>
<ol>
<li>
<p><code>t</code>ä¸­æ˜¯å¦æœ‰<code>k</code>,æœ‰åˆ™ç›´æ¥è¿”å›å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥</p>
</li>
<li>
<p><code>t</code>æ˜¯å¦æœ‰å…ƒè¡¨, æ— åˆ™è¿”å›<code>nil</code>, æœ‰åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥</p>
</li>
<li>
<p><code>t</code>çš„å…ƒè¡¨æ˜¯å¦æœ‰<code>__indexå…ƒæ–¹æ³•</code>,æ²¡æœ‰ç›´æ¥è¿”å›<code>nil,</code> æœ‰åˆ™æŸ¥æ‰¾<code>__index</code>æŒ‡å‘çš„è¡¨æˆ–å¯¹åº”çš„å‡½æ•°,æŠŠè¡¨ä¸­æˆ–è€…å‡½æ•°çš„è¿”å›å€¼å½“åšç»“æœ</p>
</li>
</ol>
<p>åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬é€šè¿‡æºç çŸ¥é“äº†<code>__index</code>å†…å¹•åˆ°åº•åšäº†å•¥,é‚£ä¸ºäº†æ­£ç¡®æ€§,æˆ‘ä»¬å†™ç‚¹<code>lua</code>æºç éªŒè¯ä¸€ä¸‹</p>
<h4 id="__indexå…ƒæ–¹æ³•è®¾ç½®çš„ä¸æ˜¯tableæˆ–è€…å‡½æ•°æ—¶å€™"><span><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„ä¸æ˜¯table,æˆ–è€…å‡½æ•°æ—¶å€™</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	 __index <span style="color:#39c">=</span> <span style="color:#cd00cd">11111</span> <span style="color:#000080">-- æ³¨æ„è¿™ä¸ªåœ°æ–¹çš„å†™æ³•</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306155606613.png" alt="image-20230306155606613"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“æ²¡æœ‰æŠŠ<code>__index</code>çš„å…ƒæ–¹æ³•è®¾ç½®æˆ<code>table</code>,æˆ–è€…å‡½æ•°çš„æ—¶å€™,å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¯ç›´æ¥æŠ¥é”™çš„</p>
<h4 id="__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯table"><span><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯table</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> {<span style="color:#000080">--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__indexæ¥è¿›è¡Œå…³è”æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span>           num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306151356327.png" alt="image-20230306151356327"  />
</p>
<h4 id="__indexå…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯å‡½æ•°"><span><code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯å‡½æ•°</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table,key,key)
</span></span><span style="display:flex;"><span>            print(table)
</span></span><span style="display:flex;"><span>            print(key)
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306162910669.png" alt="image-20230306162910669"  />
</p>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚æœåœ¨<code>myShoeStore</code>ä¸­æ‰¾ä¸åˆ°<code>num20_shoe</code>,é‚£ä¹ˆå°±ä¼šä»ä»–çš„å…ƒè¡¨<code>myBranchShoeStore</code>ä¸­å»æŸ¥æ‰¾æ˜¯ä¸æ˜¯æœ‰è®¾ç½®å…ƒæ–¹æ³•<code>__index</code>,å‘ç°<code>__index</code>å…ƒæ–¹æ³•è®¾ç½®çš„æ˜¯ä¸ªå‡½æ•°,è¿˜æœ‰èƒ½çœ‹åˆ°è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå½¢å‚,ä¸€ä¸ªæ˜¯<code>table</code>,ä¸€ä¸ªæ˜¯<code>key</code>æ­£å¥½å¯¹åº”çš„æ˜¯<code>myShoeStore</code>å’Œ<code>num20_shoe</code>å­—æ®µ,æœ€åè¿˜èƒ½çœ‹åˆ°è¿”å›å€¼<code>&quot;Size 20 shoes&quot;</code>ä¹Ÿä½œä¸ºäº†ç»“æœè¿”å›</p>
<h4 id="ä¸ºä»€ä¹ˆæœ‰äº›åœ°æ–¹__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±"><span>ä¸ºä»€ä¹ˆæœ‰äº›åœ°æ–¹<code>__index</code>å…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±</span></h4>
<p>åœ¨è®²è§£å‰è¯·å…ˆç†Ÿæ‚‰è¿™ä¸ªæµç¨‹</p>
<p><code>luaä»£ç ä»è¡¨tä¸­æŸ¥æ‰¾é”®kæ—¶,luaå¤„ç†æµç¨‹å¦‚ä¸‹:</code></p>
<ol>
<li>
<p><code>t</code>ä¸­æ˜¯å¦æœ‰<code>k</code>,æœ‰åˆ™ç›´æ¥è¿”å›å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥</p>
</li>
<li>
<p><code>t</code>æ˜¯å¦æœ‰å…ƒè¡¨, æ— åˆ™è¿”å›<code>nil</code>, æœ‰åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥</p>
</li>
<li>
<p><code>t</code>çš„å…ƒè¡¨æ˜¯å¦æœ‰<code>__indexå…ƒæ–¹æ³•</code>,æ²¡æœ‰ç›´æ¥è¿”å›<code>nil,</code> æœ‰åˆ™æŸ¥æ‰¾<code>__index</code>æŒ‡å‘çš„è¡¨æˆ–å¯¹åº”çš„å‡½æ•°,æŠŠè¡¨ä¸­æˆ–è€…å‡½æ•°çš„è¿”å›å€¼å½“åšç»“æœ</p>
</li>
</ol>
<p><strong>a. å½“æˆ‘ä»¬ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">---å½“æˆ‘ä»¬ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:new()
</span></span><span style="display:flex;"><span>    self.__index <span style="color:#39c">=</span> self
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> setmetatable( {}, self )
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:get_num20_shoe()
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡new classçš„æ—¶å€™,å‘ç°å¯ä»¥è¾“å‡ºget_num20_shoeå‡½æ•°çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myshoestrore <span style="color:#39c">=</span> class:new()
</span></span><span style="display:flex;"><span>myshoestrore.get_num20_shoe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- å½“æˆ‘ä»¬åœ¨æ­¤è°ƒç”¨é€šè¿‡myshoestroe new classçš„æ—¶å€™,å‘ç°è¿˜æ˜¯èƒ½ç»§ç»­è¾“å‡ºget_num20_shoeå‡½æ•°é‡Œé¢çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> myshoestrore:new()
</span></span><span style="display:flex;"><span>myBranchShoeStore.get_num20_shoe()
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306172552872.png" alt="image-20230306172552872"  />
</p>
<p><strong>b. å½“æˆ‘ä»¬ä¸ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">---å½“æˆ‘ä»¬ä¸ä½¿ç”¨__indexå…ƒæ–¹æ³•è¦æŒ‡å‘è‡ªå·±çš„æ–¹æ³•æ—¶å€™</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>class.__index <span style="color:#39c">=</span> class
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:new()
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> setmetatable( {}, self )
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:get_num20_shoe()
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡new classçš„æ—¶å€™,å‘ç°å¯ä»¥è¾“å‡ºget_num20_shoeå‡½æ•°çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myshoestrore <span style="color:#39c">=</span> class:new()
</span></span><span style="display:flex;"><span>myshoestrore.get_num20_shoe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- å½“æˆ‘ä»¬åœ¨æ­¤è°ƒç”¨é€šè¿‡myshoestroe new classçš„æ—¶å€™,å‘ç°å°±ä¸èƒ½åœ¨ç»§ç»­è¾“å‡ºget_num20_shoeå‡½æ•°é‡Œé¢çš„å†…å®¹äº†,ä¸»è¦åŸå› è¿˜æ˜¯</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- myshoestroreé‡Œé¢æ˜¯æ²¡æœ‰__indexå…ƒæ–¹æ³•çš„,å¯¼è‡´ç»§æ‰¿é“¾æ–­äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> myshoestrore:new()
</span></span><span style="display:flex;"><span>myBranchShoeStore.get_num20_shoe()
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306173033789.png" alt="image-20230306173033789"  />
</p>
<h4 id="__indexå®ç°çš„é¢å‘å¯¹è±¡"><span>__indexå®ç°çš„é¢å‘å¯¹è±¡</span></h4>
<p>è¿™é‡Œè´´ä¸€ä¸‹äº‘é£å¤§ç¥å†™çš„ä¸€ä¸ª<code>lua</code>é¢å‘å¯¹è±¡å®ç°çš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> _class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#000080">-- super ä¸ºåŸºç±»</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> class(super)
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> class_type <span style="color:#39c">=</span> {} <span style="color:#000080">--ç±»æ¨¡æ¿</span>
</span></span><span style="display:flex;"><span>    class_type.ctor <span style="color:#39c">=</span> <span style="color:#cdcd00">false</span> <span style="color:#000080">-- æ„é€ å‡½æ•°</span>
</span></span><span style="display:flex;"><span>    class_type.super <span style="color:#39c">=</span> super <span style="color:#000080">--èµ‹å€¼åŸºç±»</span>
</span></span><span style="display:flex;"><span>    class_type.staticFun <span style="color:#39c">=</span> {} <span style="color:#000080">--é™æ€å‡½æ•°</span>
</span></span><span style="display:flex;"><span>    class_type.new <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(...) <span style="color:#000080">-- newæ–¹æ³•æˆå‘˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00cd00">local</span> obj <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00cd00">local</span> create  <span style="color:#000080">--åµŒå¥—è°ƒç”¨ä¸»è¦æ˜¯ä¸ºäº†èƒ½æ‰åˆ°åŸºç±»ctor</span>
</span></span><span style="display:flex;"><span>            create <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(c, ...)
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">if</span> c.super <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>                    create(c.super, ...) <span style="color:#000080">--è°ƒç”¨åŸºç±»ctor</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">if</span> c.ctor <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>                    c.ctor(obj, ...) <span style="color:#000080">--è°ƒç”¨æ„é€ </span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            create(class_type, ...)
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>        setmetatable(obj, {__index <span style="color:#39c">=</span> _class[class_type]}) <span style="color:#000080">--åˆ©ç”¨å…ƒè¡¨__indexè®¾ç½®ä¿è¯ objç»§æ‰¿è‡ª_class[class_type]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">return</span> obj
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> vtbl <span style="color:#39c">=</span> {} <span style="color:#000080">--vtblç†è§£ä¸ºç±»å®¹å™¨ä¹Ÿå°±æ˜¯å­˜ç±»çš„æˆå‘˜,å‡½æ•°ç­‰ç­‰</span>
</span></span><span style="display:flex;"><span>    vtbl.super <span style="color:#39c">=</span> _class[super] 
</span></span><span style="display:flex;"><span>    _class[class_type] <span style="color:#39c">=</span> vtbl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    setmetatable( <span style="color:#000080">-- æœ‰æ–°çš„æˆå‘˜å­˜åˆ°vtblä¸­</span>
</span></span><span style="display:flex;"><span>        class_type,
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(t, k, v)
</span></span><span style="display:flex;"><span>                vtbl[k] <span style="color:#39c">=</span> v
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">if</span> super <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>        setmetatable( <span style="color:#000080">-- å¦‚æœå­ç±»æœ‰æˆå‘˜ç›´æ¥è¿”å›,å­ç±»æ²¡æœ‰è¿”å›åŸºç±»çš„æˆå‘˜</span>
</span></span><span style="display:flex;"><span>            vtbl,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                __index <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(t, k)
</span></span><span style="display:flex;"><span>                    <span style="color:#00cd00">local</span> ret <span style="color:#39c">=</span> _class[super][k]
</span></span><span style="display:flex;"><span>                    vtbl[k] <span style="color:#39c">=</span> ret
</span></span><span style="display:flex;"><span>                    <span style="color:#cdcd00">return</span> ret
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> class_type
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>å…·ä½“å®ç°åŸç†è¯·ä»”ç»†æŸ¥çœ‹æºç æ³¨é‡Šå§,è¿™é‡Œå°±ä¸è¯¦ç»†è§£é‡Šäº†,ç›¸ä¿¡èªæ˜çš„ä½ ä¸€å®šèƒ½çœ‹å‡ºåå ‚</p>
<p>å¦‚æœæƒ³æ›´å¤æ‚çš„<code>lua</code>å®ç°<code>class</code>é¢å‘å¯¹è±¡çš„ä»£ç æ–¹æ³•,å¯ä»¥å»è¿™ä¸ªåœ°å€å–µå–µ,è¿™ä¸ªå†™çš„è¿˜æ˜¯å¾ˆä¸é”™çš„,é‡Œé¢æœ‰å¼ºå¼±è¡¨ç›¸å…³,ä¸åˆ°<code>200</code>è¡Œä»£ç å°±å®ç°äº†,ç±»,ç»§æ‰¿,è™šå‡½æ•°,ç§æœ‰å˜é‡,<code>table</code>æ··åˆä½¿ç”¨ç­‰ç­‰åŠŸèƒ½</p>
<p><a href="https://github.com/kikito/middleclass/blob/master/middleclass.lua">middleclass</a></p>
<h3 id="__newindex"><span>__newindex</span></h3>
<p>å¦‚æœè¯´<code>__index</code>å­—æ®µæ˜¯åœ¨è®¿é—®è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼æ˜¯æ‰§è¡Œçš„æŸ¥æ‰¾æ“ä½œçš„è¯[<code>get</code>]</p>
<p>é‚£ä¹ˆ<code>__nexindex</code>å­—æ®µåˆ™æ˜¯åœ¨å¯¹è¡¨ä¸­ä¸å­˜åœ¨çš„å€¼è¿›è¡Œçš„èµ‹å€¼æ“ä½œ[<code>set</code>]</p>
<p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç»™ä½ çš„<code>table</code>å»ä¸€ä¸ªçš„èµ‹å€¼åˆ›å»ºå˜é‡æ¯”å¦‚åƒä¸‹é¢<code>lua</code>ä»£ç ä¸€æ ·,ä¸ºäº†èƒ½å¤Ÿç•™ä½é¡¾å®¢æˆ‘è´¹åŠ²é€šè¿‡å„ç§æ–¹æ³•åœ¨æˆ‘çš„åº—é“ºåˆ›å»ºå‡ºæ¥äº†ä¸€åŒ<code>20</code>å·çš„é‹å­</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span> <span style="color:#000080">--è´¹åŠ²å·´æ‹‰çš„åœ¨è‡ªå·±åº—é“ºå¼„å‡ºäº†ä¸€åŒ20å·æ¬¾å¼çš„é‹å­</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306174922398.png" alt="image-20230306174922398"  />
</p>
<p>è™½ç„¶20å·é‹å­åˆ›å»ºå‡ºæ¥äº†,ä½†æ˜¯å¤§å®¶å‘ç°æ²¡æœ‰æˆ‘æ˜¯æ€»åº—æŒ‰é“ç†æ¥è¯´æ€»åº—ä¸æ˜¯å·¥å‚,è€Œåº”è¯¥è®©å·¥å‚å»å±¥è¡Œè¿™ä¸ªèŒè´£,è¿™æ ·ä¸“äººåšè½¬äº‹,ä¿å€¼ä¿é‡,åˆå¿«åˆå¥½,æ‰€ä»¥æˆ‘ä»¬åˆå¯¹ä»£ç åšäº†å¦‚ä¸‹å¤„ç†</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table, key, value) <span style="color:#000080">--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__newindexæ¥è¿›è¡Œé‹å­çš„åˆ›å»º</span>
</span></span><span style="display:flex;"><span>          rawset(table, key, value);
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- æœ‰å…ƒè¡¨çš„æƒ…å†µä¸‹è®¾ç½®å€¼,è¿™æ ·ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º20å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚å»å¤„ç†äº†</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306193334378.png" alt="image-20230306193334378"  />
</p>
<p>é€šè¿‡ä¸Šé¢çš„å¤„ç†ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º<code>20</code>å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚<code>myShoeFactory</code>å»å¤„ç†äº†</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æºç </p>
<p><img loading="lazy" src="image-20230306194200024.png" alt="image-20230306194200024"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§æ¦‚æµç¨‹å¦‚ä¸‹</p>
<ol>
<li>tä¸­æ˜¯å¦æœ‰å…ƒæ–¹æ³•,æ²¡æœ‰çš„è¯ç›´æ¥è®¾ç½®å€¼,å¦åˆ™è¿›è¡Œç¬¬äºŒæ­¥</li>
<li>å…ƒæ–¹æ³•æŒ‡å‘çš„å‡½æ•°,ç›´æ¥é€šè¿‡<code>luaT_callTM</code>å‡½æ•°æ¥å£è¿›è¡Œè®¾ç½®,å¦åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥</li>
<li>å¦‚æœå…ƒæ–¹æ³•æŒ‡å‘æ˜¯ä¸ª<code>table</code>,é‚£ä¹ˆå°±ç›´æ¥å›å»<code>table</code>å¯¹åº”çš„å€¼,è¿›è¡Œè®¾ç½®,å¦åˆ™è¿›è¡Œç¬¬å››æ­¥</li>
<li>å¦‚æœå…ƒæ–¹æ³•æŒ‡å‘ä¸æ˜¯<code>table</code>ä¹Ÿä¸æ˜¯å‡½æ•°,é‚£ä¹ˆå°±ç›´æ¥æŠ¥é”™</li>
</ol>
<h4 id="__newindexè®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™"><span>__newindexè®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cd00cd">11111</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- è®¾ç½®çš„ä¸æ˜¯tableä¹Ÿä¸æ˜¯å‡½æ•°çš„æ—¶å€™</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306194930423.png" alt="image-20230306194930423"  />
</p>
<h4 id="_å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™"><span>_å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- _å…ƒè¡¨æ²¡æœ‰_è®¾ç½®newindexçš„æ—¶å€™ </span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306195129247.png" alt="image-20230306195129247"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ç›´æ¥èµ‹å€¼äº†,è¿˜æ˜¯æœ‰æƒ³è¦çš„ç»“æœè¾“å‡º</p>
<h4 id="__newindexè®¾ç½®çš„æ˜¯table"><span>__newindexè®¾ç½®çš„æ˜¯table</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryItem <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> myShoeFactoryItem
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> print(<span style="color:#cd0000">&#34;set num20_shoe before myShoeFactoryItem.num20_shoe:&#34;</span>,myShoeFactoryItem.num20_shoe)
</span></span><span style="display:flex;"><span> myShoeStore.num20_shoe <span style="color:#39c">=</span>  <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span> print(<span style="color:#cd0000">&#34;set num20_shoe after myShoeFactoryItem.num20_shoe:&#34;</span>,myShoeFactoryItem.num20_shoe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306200454139.png" alt="image-20230306200454139"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ä¿®æ”¹<code>myShoeFactoryItem</code>ä¸­<code>num20_shoe</code>å­—æ®µçš„ä¹‹å‰ä»–çš„å€¼æ˜¯<code>&quot;Size 21 shoes&quot;</code></p>
<p>å½“è°ƒç”¨ <code>myShoeStore.num20_shoe =  &quot;Size 20 shoes&quot;</code>è¿›è¡Œè®¾ç½®çš„æ—¶å€™</p>
<p><code>myShoeFactoryItem</code>ä¸­<code>num20_shoe</code>å­—æ®µçš„ä¹‹å‰ä»–çš„å€¼å˜æˆäº†<code>&quot;Size 20 shoes&quot;</code></p>
<p>è€Œå†æ¬¡è¾“å‡º<code>myShoeStore.num20_shoe</code>çš„æ—¶å€™çœ‹åˆ°çš„å€¼æ˜¯<code>nil</code></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸œè¥¿æœ‰ç‚¹åƒæˆ‘çš„å·¥å‚æ­£åœ¨äº§<code>21</code>å·çš„é‹å­,ä½†æ˜¯æˆ‘è¿™ä¸ªæ—¶å€™ç´§æ€¥éœ€è¦<code>20</code>å·é‹å­,æˆ‘å°±éš”ç©ºé€šè¿‡ä¸»åº—å¯¹å·¥å‚å‘å‡ºäº†åˆ›å»º<code>20</code>å·é‹å­çš„å‘½ä»¤,ä½†æ˜¯ä¸»åº—å´ä¸ä¼šå»åˆ›å»º<code>20</code>å·é‹å­,è¿™æ ·éå¸¸<code>nice</code>æœ‰ç‚¹éš”ç©ºæ‰“ç‰›,ä½†æ˜¯ä¸å½±å“ä¸»åº—çš„æ„æ€åœ¨é‡Œé¢</p>
<h4 id="__newindexè®¾ç½®çš„æ˜¯å‡½æ•°"><span>__newindexè®¾ç½®çš„æ˜¯å‡½æ•°</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table, key, value) <span style="color:#000080">--å…³é”®åœ°æ–¹,é çš„å°±æ˜¯__newindexæ¥è¿›è¡Œé‹å­çš„åˆ›å»º</span>
</span></span><span style="display:flex;"><span>          rawset(table, key, value);<span style="color:#000080">--ä½¿ç”¨rawsetæ¥è¿›è¡Œè®¾ç½®,å› ä¸ºä¸ä¼šå»è°ƒç”¨å…ƒæ–¹æ³•å¯¹tableè¿›è¡Œè®¾ç½®,æ‰€ä»¥èƒ½å¾—åˆ°æ›´å¥½çš„æ€§èƒ½å’Œé¿å…å…ƒæ–¹æ³•çš„æ— é™é€’å½’è°ƒç”¨</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--å…³é”®åœ°æ–¹,è¿™é‡Œç­‰ä»·äºæŠŠä¸¤å®¶åº—ç»™ä¸²è¿èµ·æ¥äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- æœ‰å…ƒè¡¨çš„æƒ…å†µä¸‹è®¾ç½®å€¼,è¿™æ ·ç­‰ä»·äºæˆ‘æŠŠæœ¬æ¥è¦åœ¨ä¸»åº—åˆ›å»º20å·é‹å­çš„ä»»åŠ¡,ä¸¢ç»™æˆ‘çš„é‹å­å·¥å‚å»å¤„ç†äº†</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306193334378.png" alt="image-20230306193334378"  />
</p>
<p>è¿™å—åœ°æ–¹åºŸè¯å°±ä¸å¤šè¯´äº†,å¯ä»¥è‡ªå·±å¯¹ç€æ³¨é‡Šæ‹ä¸€ä¸‹å°±æ˜ç™½äº†,å…¶å®<code>__newindex</code>å¼€åœºç™½çš„æ—¶å€™ä¹Ÿè¿›è¡Œäº†ä»‹ç»</p>
<h3 id="__gc"><span>__gc</span></h3>
<p>ä¸»è¦ç”¨æ¥å½“å¯¹è±¡è¢«é”€æ¯æ—¶,è¯¥å…ƒæ–¹æ³•å°†ä»¥å¯¹è±¡ä½œä¸ºå‚æ•°è¿›è¡Œè°ƒç”¨,å¹¶å¯¹ä¸€äº›è‡ªå®šä¹‰çš„èµ„æºé‡Šæ”¾,å¯ä»¥å°†æ­¤å…ƒæ–¹æ³•è®¤ä¸ºæ˜¯ä¸€ç§ææ„å‡½æ•°ä¹Ÿè¡Œ,è¿™ä¸ªå…ƒæ–¹æ³•æŒ‡å‘çš„å†…å®¹å¿…é¡»çš„æ˜¯ä¸ªå‡½æ•°</p>
<p>å…ˆæ¥å–µå–µæºä»£ç </p>
<p><img loading="lazy" src="image-20230306203628536.png" alt="image-20230306203628536"  />
</p>
<ul>
<li><code>1</code>å·ä½ç½®è·å–å…ƒæ–¹æ³•</li>
<li><code>2</code>å·ä½ç½®è°ƒç”¨ä½ æŒ‡å‘çš„å‡½æ•°,ä»è°ƒç”¨çš„æ˜¯<code>luaD_pcall</code>å‡½æ•°ä¸­å¯ä»¥çœ‹å‡º,<code>__gc</code>å…ƒæ–¹æ³•æŒ‡å‘çš„å¿…é¡»æ˜¯ä¸ªå‡½æ•°</li>
</ul>
<h4 id="__gcæŒ‡å‘çš„ä¸æ˜¯å‡½æ•°"><span>__gcæŒ‡å‘çš„ä¸æ˜¯å‡½æ•°</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;myShoeStore addr:&#34;</span>,myShoeStore)<span style="color:#000080">--å…ˆæ‰“å°ä¸‹myShoeStore tableåœ°å€</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryGC <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	__gc <span style="color:#39c">=</span><span style="color:#cd00cd">1111</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore,myShoeFactoryGC);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- è¿›è¡Œgcå›æ”¶</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306205437394.png" alt="image-20230306205437394"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿ</p>
<h4 id="__gcæŒ‡å‘çš„æ˜¯å‡½æ•°"><span>__gcæŒ‡å‘çš„æ˜¯å‡½æ•°</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;myShoeStore addr:&#34;</span>,myShoeStore)<span style="color:#000080">--å…ˆæ‰“å°ä¸‹myShoeStore tableåœ°å€</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryGC <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	__gc <span style="color:#39c">=</span><span style="color:#cdcd00">function</span>( table )
</span></span><span style="display:flex;"><span>		print(<span style="color:#cd0000">&#34;myShoeFactoryGC released table addr:&#34;</span>,table) <span style="color:#000080">-- myShoeStore tableè¢«å›æ”¶äº†</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore,myShoeFactoryGC);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- è¿›è¡Œgcå›æ”¶</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306205237891.png" alt="image-20230306205237891"  />
</p>
<p>ä»ä¸Šé¢æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºå½“<code>myShoeStore table</code>è¢«å›æ”¶çš„æ—¶å€™,ä¹Ÿä¼šè§¦å‘<code>__gc</code>çš„å…ƒæ–¹æ³•,å¤§ç™½è¯æ¥è¯´å°±æœ‰ç‚¹åƒæˆ‘çš„ä¸»åº—å€’é—­äº†,é‚£ä¹ˆå’Œæˆ‘å…³è”çš„å·¥å‚ä¹Ÿæ²¡æœ‰å¿…è¦åœ¨ç»™æˆ‘è¿›è¡Œå…³è”,ç»™æˆ‘å‘é‹å­ä»€ä¹ˆçš„æ¥æˆ‘è¿™å–äº†.</p>
<h3 id="__mode"><span>__mode</span></h3>
<p>å‡è®¾å¦‚æœä½ çš„ä¸»åº—å’Œä½ åä¸‹çš„åˆ†åº—æœ‰å¼ºå¼•ç”¨å…³ç³»,æ¯”å¦‚ä½ æ¬ äº†åˆ†åº—çš„é¢„ä»˜æ¬¾ä»€ä¹ˆçš„,è¿™ä¸ªæ—¶å€™åˆ†åº—ä¸æƒ³å’Œä½ å¹²äº†,æŒ‰ç…§æ³•å¾‹æ¥è¯´åŠæ—¶åˆ†åº—è‡ªå·±å…³é—­äº†,åˆ†åº—å’Œä½ çš„åŠ³åŠ¨çº çº·è¿˜æ˜¯å­˜åœ¨,ä½ è¿˜æ˜¯è·‘ä¸äº†,æ¯•ç«Ÿå¼ºå¼•ç”¨å…³ç³»å†æ¬¡,ä½†æ˜¯å¦‚æœä½ å’Œåˆ†åº—åœ¨ç­¾è®¢åŠ ç›ŸåˆåŒçš„æ—¶å€™,è¯´çš„æ˜¯è‡ªè´Ÿç›ˆäº,å¦‚æœä¸»åº—ä»˜ä¸å‡ºåˆ©æ¶¦é’±äº†,ä¸¤ä¸ªäººä¹Ÿæ‰¯ä¸ä¸Šä»»ä½•æ³•å¾‹ä¸Šçš„å…³ç³»,è¿™æ ·åˆ†åº—è‡ªå·±å…³é—­äº†,ä½ ä¹Ÿä¸ç”¨åœ¨è´Ÿè´£ä»»,è¿™å°±æœ‰ç‚¹åƒå¼±å¼•ç”¨çš„å…³ç³»</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>		num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>		num21_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> contract <span style="color:#39c">=</span> {} <span style="color:#000080">--ä¸¤äººåœ¨æ­¤å»ºç«‹åˆåŒ</span>
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myBranchShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- è¿›è¡Œgcå›æ”¶</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306213441302.png" alt="image-20230306213441302"  />
</p>
<p>å¯ä»¥çœ‹åˆ°å½“ä¸¤è€…å»ºç«‹åˆåŒå¹¶ä¸”æ²¡æœ‰è®¾ç½®å¼±å¼•ç”¨çš„æ—¶å€™<code>,myBranchShoeStore</code>åˆ†åº—å“ªæ€•ä¸»åŠ¨å›æ”¶äº†,æœ€åå‘ç°å’Œ<code>myShoeStore</code>ä¸»åº—æœ‰å¼•ç”¨å…³ç³»åœ¨,è¿˜æ˜¯æ²¡æœ‰è¢«å›æ”¶</p>
<p>é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ç§æƒ…å†µå‘¢,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>__mode</code>æ¥è§£å†³è¿™ä¸ªé—®é¢˜,</p>
<table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>k</td>
<td>è¡¨çš„keyä¸ºå¼±å¼•ç”¨</td>
</tr>
<tr>
<td>v</td>
<td>è¡¨çš„valueä¸ºå¼±å¼•ç”¨</td>
</tr>
<tr>
<td>kv</td>
<td>è¡¨çš„key,valueéƒ½ä¸ºå¼±å¼•ç”¨</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>		num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>		num21_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> contract <span style="color:#39c">=</span> {} <span style="color:#000080">--ä¸¤äººåœ¨æ­¤å»ºç«‹åˆåŒ</span>
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;</span><span style="color:#cd0000">\n</span><span style="color:#cd0000">-------------collectgarbage after-----------------&#34;</span>)
</span></span><span style="display:flex;"><span>setmetatable(contract,{__mode<span style="color:#39c">=</span><span style="color:#cd0000">&#34;v&#34;</span>})<span style="color:#000080">--è¿™ä¸ªåœ°æ–¹æŠŠvalueè®¾ç½®æˆäº†å¼±å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myBranchShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--è®¾ç½®æˆnil,ä¸‹é¢è°ƒç”¨collectgarbageæ‰ä¼šè¢«å›æ”¶</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- è¿›è¡Œgcå›æ”¶</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306214108485.png" alt="image-20230306214108485"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å›æ”¶ä¹‹å‰æ˜¯<code>2ä¸ªtable</code>,è€Œå½“è°ƒç”¨<code>myBranchShoeStore = nil ,collectgarbage()</code>çš„æ—¶å€™,å‘ç°<code>myBranchShoeStore</code> è¢«å›æ”¶äº†</p>
<h4 id="å…¥å£æºç å‰–æ"><span>å…¥å£æºç å‰–æ</span></h4>
<p><img loading="lazy" src="image-20230306215333685.png" alt="image-20230306215333685"  />
</p>
<ul>
<li><code>1</code>å·ä½ç½®æ˜¯ä»å…ƒè¡¨ä¸­è·å–å…ƒæ–¹æ³•</li>
<li><code>2</code>å·ä½ç½®æ˜¯æ ¹æ®è®¾ç½®çš„æ“ä½œç¬¦æ˜¯ä»€ä¹ˆè¿›è¡Œå¯¹åº”çš„<code>gc</code>å›æ”¶</li>
</ul>
<h4 id="å¼±è¡¨åŸç†å‰–æ"><span>å¼±è¡¨åŸç†å‰–æ</span></h4>
<p><img loading="lazy" src="weaktable.png" alt="image-20230306214108485"  />
</p>
<p>ä¸Šé¢æ˜¯å¼±è¡¨çš„åŸç†å‰–æ,å¤§å®¶å¯ä»¥æŠŠå›¾ç‰‡æ”¾å¤§æˆ–è€…ä¸‹è½½ä¸‹æ¥è§‚çœ‹</p>
<p>å¼±è¡¨å…·ä½“çš„ç›¸å…³æºç å¤ªå¤šäº†,è¿™é‡Œå°±ä¸ä¸€ä¸€å±•ç¤ºäº†,æ„Ÿå…´è¶£çš„å¯ä»¥å»ä¸‹é¢è¿æ¥æŸ¥æ‰¾<code>traverseweakvalue,traverseephemeron,traverseephemeron,traversetable</code>å››ä¸ªä¸»è¦å‡½æ•°è¿›è¡Œè§‚çœ‹,å‡½æ•°å¤„ä¹Ÿå†™äº†ä¸å°‘æ³¨é‡Š</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/lgc.c">å¼±è¡¨ç›¸å…³çš„gcéƒ¨åˆ† </a></p>
<h3 id="__len"><span>__len</span></h3>
<p><code>è¿™ä¸ªæ˜¯ç”¨æ¥æ±‚è‡ªå®šä¹‰é•¿åº¦ä½¿ç”¨çš„</code></p>
<h4 id="ä¾‹å­"><span>ä¾‹å­</span></h4>
<p>å‡å¦‚è¿™ä¸ªæ—¶å€™æ¥äº†ä¸ªé¡¾å®¢,é¡¾å®¢è¯´ä½ è¿™æœ‰<code>20</code>ç ä»¥ä¸Šçš„é‹å­å—,æˆ‘çš„è„šæ¯”è¾ƒç‰¹æ®Šéœ€è¦éƒ½è¯•è¯•,å¦‚æœä½ æ˜¯åº—å®¶ä½†æ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨ä¿¡æ¯åŒ–å¤„ç†,çœ‹ç€æ»¡ä¸»åº—ä»“åº“å †æ»¡çš„é‹å­,ä½ æ˜¯ä¸æ˜¯ä¼šå¾ˆç»æœ›,ç­‰ä½ ä»ä»“åº“ä¸­ç¿»å‡ºé‚£äº›é‹å­,ä¼°è®¡é¡¾å®¢éƒ½è·‘æ‰äº†,æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>_len</code>å…ƒæ–¹æ³•æ¥å¤„ç†è¿™ä¸ªçª˜è¿«çš„é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>},<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">13</span>,<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>},<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num20_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">20</span>,<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>},<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num21_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">21</span>,<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>},<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num22_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">22</span>,<span style="color:#cd0000">&#34;Size 22 shoes&#34;</span>},<span style="color:#000080">--22å·é‹å­</span>
</span></span><span style="display:flex;"><span>	num23_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">23</span>,<span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>},<span style="color:#000080">--23å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStoreLen <span style="color:#39c">=</span>{
</span></span><span style="display:flex;"><span>	__len <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span> (table) <span style="color:#000080">--é€šè¿‡æ­¤å¤„çš„è®¡ç®—ç›´æ¥æŠŠ20å·ä»¥ä¸Šçš„é‹å­éƒ½ç»™ç»Ÿè®¡å‡ºæ¥</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> len <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(table) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">if</span>( <span style="color:#cd00cd">20</span> <span style="color:#39c">&lt;=</span> v[<span style="color:#cd00cd">1</span>]) <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>			len<span style="color:#39c">=</span> len<span style="color:#39c">+</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> len;
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, myShoeStoreLen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)<span style="color:#000080">--è¿™ä¸ªåœ°æ–¹å¾—åˆ°__lenå…ƒæ–¹æ³•ç»Ÿè®¡çš„æ•°æ®é‡å¤§å°</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307102631783.png" alt="image-20230307102631783"  />
</p>
<p>ä»ä¸Šé¢ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡º,å®Œç¾çš„å¾—åˆ°äº†æƒ³è¦çš„æ•°æ®</p>
<h4 id="æºç è®²è§£"><span>æºç è®²è§£</span></h4>
<p><img loading="lazy" src="image-20230307102824259.png" alt="image-20230307102824259"  />
</p>
<p>ä¸Šé¢æ˜¯å½“ä½ æ˜¯ç”¨<code>#</code>å»æ±‚å¤§å°çš„æ—¶å€™,ä¼šæ›´åŠ ä½ #åé¢è·Ÿçš„æ•°æ®ç±»å‹æ¥åˆ¤æ–­æ€ä¹ˆæ±‚å¤§å°</p>
<ul>
<li>å¦‚æœæ˜¯<code>#table</code>,é‚£ä¹ˆå°±çœ‹ä¸€ä¸‹æ˜¯å¦è®¾ç½®äº†å…ƒæ–¹æ³•,å¦‚æœè®¾ç½®äº†èµ°<code>luaT_callTMres</code>å‡½æ•°è°ƒç”¨å…ƒæ–¹æ³•æ±‚å¤§å°,å¦åˆ™é€šè¿‡<code>luaH_getn</code>å‡½æ•°æ±‚å¤§å°</li>
<li>å¦‚æœæ˜¯<code>#çŸ­å­—ç¬¦ä¸²</code>,ç›´æ¥é€šè¿‡<code>tsvalue(rb)-&gt;shrlen</code>è¿”å›å¤§å°</li>
<li>å¦‚æœæ˜¯<code>#é•¿å­—ç¬¦ä¸²</code>,ç›´æ¥é€šè¿‡<code>tsvalue(rb)-&gt;u.lnglen</code>è¿”å›å¤§å°</li>
<li>å¦‚æœæ˜¯<code>#å…¶ä»–</code>,é‚£ä¹ˆå°±åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å…ƒè¡¨å¦‚æœè®¾ç½®äº†å°±é€šè¿‡<code>luaT_callTMres</code>å‡½æ•°è°ƒç”¨å…ƒæ–¹æ³•æ±‚å¤§å°,å¦åˆ™æŠ¥é”™,è¿™ä¸ªå…¶ä»–æ¯”å¦‚æ˜¯<code>userdata</code>ç­‰ç­‰</li>
</ul>
<p>å·²ç»è¯´é“äº†è¿™é‡Œé‚£ä¹ˆå°±å¥½å¥½è¯´ä¸‹<code>#table</code>çš„æ—¶å€™é€šè¿‡<code>luaH_getn</code>å‡½æ•°æ±‚å¤§å°</p>
<p><img loading="lazy" src="image-20230307103807433.png" alt="image-20230307103807433"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å†…å®¹è¿˜æ˜¯æŒºè›‹ç–¼çš„,åˆæ˜¯äºŒåˆ†,åˆæ˜¯è¾¹ç•Œä»€ä¹ˆä»€ä¹ˆçš„,ä¸ç€æ€¥,æˆ‘ä»¬æ…¢æ…¢åš¼ç¢å®ƒ</p>
<p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“<code>lua</code>çš„<code>table</code>æ˜¯åˆ†ä¸º<code>æ•°ç»„</code>å’Œ<code>hash</code>éƒ¨åˆ†çš„</p>
<p>æ‰€ä»¥ä¸ºäº†æ±‚å‡ºåˆé€‚çš„å¤§å°<code>lua</code>ä¼šæŒ‰å¦‚ä¸‹è§„åˆ™æ¥æ±‚å¤§å°,æˆ–è€…æ›´ç®€å•ç‚¹æ¥è¯´,<code>luaç”¨#æ±‚å¤§å°å°±æ˜¯æ±‚tableçš„è¾¹ç•Œ</code></p>
<p>é‚£ä¹ˆæ€ä¹ˆæ±‚è¾¹ç•Œå‘¢,è¾¹ç•Œåˆæ˜¯é’ˆå¯¹ä»€ä¹ˆçš„å‘¢</p>
<ul>
<li>
<p>è¾¹ç•Œæ˜¯é’ˆå¯¹<code>table</code>çš„æ•°ç»„éƒ¨åˆ†çš„,ä½†è‹¥å“ˆå¸Œéƒ¨åˆ†çš„<code>key</code>ä¸ºæ•´æ•°ä¸”åˆšå¥½è¿ç€æ•°ç»„éƒ¨åˆ†,åˆ™ä¹Ÿä¼šä¸€å¹¶å‚ä¸è®¡ç®—</p>
</li>
<li>
<p>è‹¥æŸä¸ªæ•´æ•°ä¸‹æ ‡<code>n</code>,æ»¡è¶³<code>table[boundary]</code>ä¸ä¸ºç©º,è€Œ<code>table[boundary+1]</code>ä¸ºç©º,åˆ™<code>n</code>ä¸º<code>table</code>çš„è¾¹ç•Œ</p>
<blockquote>
<p>table[boundary] != nil
table[boundary+1] == nil</p>
</blockquote>
</li>
</ul>
<p>ä¸ºäº†æé«˜éå†æŸ¥æ‰¾è¾¹ç•Œçš„æ•ˆç‡,<code>lua</code>æºç å¹¶æ²¡æœ‰è¿›è¡Œéå†æŸ¥æ‰¾,è€Œæ˜¯é€šè¿‡äºŒåˆ†æŸ¥æ‰¾</p>
<ol>
<li>
<p>å¦‚æœ<code>table</code>æ•°ç»„éƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸º<code>nil</code>,é‚£ä¹ˆå°†åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾</p>
</li>
<li>
<p>é’ˆå¯¹<code>table</code>çš„æ•°ç»„éƒ¨åˆ†çš„,ä½†è‹¥å“ˆå¸Œéƒ¨åˆ†çš„<code>key</code>ä¸ºæ•´æ•°ä¸”åˆšå¥½è¿ç€æ•°ç»„éƒ¨åˆ†,åˆ™ä¹Ÿä¼šä¸€å¹¶å‚ä¸è®¡ç®—</p>
</li>
<li></li>
<li>
<p>æœ€åä¸€ç§æƒ…å†µæ˜¯æ•°ç»„éƒ¨åˆ†ä¸­æ²¡æœ‰å…ƒç´  æˆ–å¦‚æœ<code>table</code>æ•°ç»„éƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸º<code>nil</code>,é‚£ä¹ˆå°†åœ¨<code>hash</code>éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾</p>
</li>
</ol>
<hr>
<h4 id="ç”¨æ±‚tableé•¿åº¦çš„ä¸€äº›æƒ…å†µ"><span>ç”¨#æ±‚tableé•¿åº¦çš„ä¸€äº›æƒ…å†µ</span></h4>
<h5 id="å…¨éƒ¨ä¸ºæ•°ç»„æ²¡æœ‰hashéƒ¨åˆ†"><span>å…¨éƒ¨ä¸ºæ•°ç»„,æ²¡æœ‰<code>hash</code>éƒ¨åˆ†</span></h5>
<h6 id="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯nil"><span>tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯nil</span></h6>
<p><code>ä¾‹å­1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307141320810.png" alt="image-20230307141320810"  />
</p>
<p><code>ä¾‹å­2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153017370.png" alt="image-20230307153017370"  />
</p>
<p><code>ä¾‹å­3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153050144.png" alt="image-20230307153050144"  />
</p>
<ul>
<li>å› ä¸º<code>table</code>æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä½ä¸æ˜¯<code>nil</code>æ‰€ä»¥ä¼šè·‘åˆ°<code>luaH_getn</code>å‡½æ•°çš„è¿™ä¸ªåœ°æ–¹,ç›´æ¥è¿”å›<code>Table</code>ç»“æ„ä½“é‡Œé¢çš„<code>alimit</code>å­—æ®µå¤§å°</li>
</ul>
<p><img loading="lazy" src="image-20230307141624175.png" alt="image-20230307141624175"  />
</p>
<h6 id="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nilæ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil"><span>tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯nil</span></h6>
<p><code>ä¾‹å­1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307142944522.png" alt="image-20230307142944522"  />
</p>
<p><code>ä¾‹å­2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307152702572.png" alt="image-20230307152702572"  />
</p>
<p><code>ä¾‹å­3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153146377.png" alt="image-20230307153146377"  />
</p>
<ul>
<li>å› ä¸ºæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸º<code>nil</code>,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯<code>nil</code>,é‚£ä¹ˆå°±ç›´æ¥è¿”å›<code>Table</code>ç»“æ„ä½“é‡Œé¢çš„<code>alimit</code>å­—æ®µå¤§å°å‡<code>1</code></li>
</ul>
<p><img loading="lazy" src="image-20230307142908113.png" alt="image-20230307142908113"  />
</p>
<h6 id="tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nilæ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nil"><span>tableçš„æ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ æ˜¯nil,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯nil</span></h6>
<p><strong>å…³é”®æºç éƒ¨åˆ†</strong></p>
<p><img loading="lazy" src="image-20230307151703174.png" alt="image-20230307151703174"  />
</p>
<p><img loading="lazy" src="image-20230307165132582.png" alt="image-20230307165132582"  />
</p>
<p><code>ä¾‹å­1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307152222070.png" alt="image-20230307152222070"  />
</p>
<p>ç®€å•è¯´ä¸‹<code>ä¾‹å­1</code>è¿›å…¥äºŒåˆ†æŸ¥æ‰¾çš„è¿ç®—è¿‡ç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">ç¬¬ä¸€è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span><span style="">ï¼›</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">ï¼›è¿›å…¥</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬äºŒè½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span><span style="">ï¼›</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">3</span><span style="">ï¼›åˆ¤æ–­</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">æ˜¯ä¸æ˜¯ç©º</span>,<span style="">ä¸ä¸ºç©º</span>; i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">3</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">ï¼›è¿›å…¥</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬ä¸‰è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">3</span><span style="">ï¼›</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span><span style="">ï¼›åˆ¤æ–­</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">æ˜¯ä¸æ˜¯ç©º</span>,<span style="">ä¸ä¸ºç©º</span>; i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">4</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">ï¼›è¿›å…¥</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬å››è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span><span style="">ï¼›</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span><span style="">ï¼›åˆ¤æ–­</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">æ˜¯ä¸æ˜¯ç©º</span>,<span style="">ä¸ºç©º</span>; j<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">5</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="">ä¸å¤§äº</span><span style="color:#cd00cd">1</span><span style="">ï¼›é€€å‡ºå¾ªç¯</span>,<span style="">å¹¶è¿”å›</span>i<span style="">å€¼</span>
</span></span></code></pre></div><p><code>ä¾‹å­2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153326096.png" alt="image-20230307153326096"  />
</p>
<p><code>ä¾‹å­3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153238458.png" alt="image-20230307153238458"  />
</p>
<ul>
<li>å› ä¸ºæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸º<code>nil</code>,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯<code>nil</code>æ‰€ä»¥ç›´æ¥è°ƒç”¨<code>binsearch</code>å‡½æ•°åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾å¾—åˆ°<code>table</code>å¤§å°</li>
</ul>
<p>â€‹	<strong>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæç«¯çš„ä¾‹å­,æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°<code>table</code>åªçœ‹æ•°ç»„éƒ¨åˆ†æœ€åä¸¤ä½çš„æƒ…å†µæ¥å†³å®šä»€ä¹ˆæ ·çš„é€»è¾‘å¤„ç†</strong></p>
<pre><code>1. å¦‚æœæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä½ä¸æ˜¯`nil`,é‚£ä¹ˆå°±ç›´æ¥è¿”å›`Table`ç»“æ„ä½“é‡Œé¢çš„`alimit`å­—æ®µå¤§å°
1. å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯`nil`,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¸æ˜¯`nil`,é‚£ä¹ˆå°±ç›´æ¥è¿”å›`Table`ç»“æ„ä½“é‡Œé¢çš„`alimit`å­—æ®µå¤§å°å‡`1`
1. å¦‚æœæ•°ç»„éƒ¨åˆ†æœ€åä¸€ä¸ªå…ƒç´ ä¸º`nil`,æ•°ç»„éƒ¨åˆ†å€’æ•°ç¬¬äºŒä¸ªä¹Ÿæ˜¯`nil`æ‰€ä»¥ç›´æ¥è°ƒç”¨`binsearch`å‡½æ•°åœ¨æ•°ç»„éƒ¨åˆ†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾,å¾—åˆ°`table`å¤§å°
</code></pre>
<h5 id="å…¨éƒ¨ä¸ºhashæ²¡æœ‰æ•°ç»„"><span>å…¨éƒ¨ä¸º<code>hash</code>,æ²¡æœ‰æ•°ç»„</span></h5>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 22 shoes&#34;</span>,<span style="color:#000080">--22å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">6</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307155918239.png" alt="image-20230307155918239"  />
</p>
<p><strong>å…³é”®æºç éƒ¨åˆ†</strong></p>
<p><img loading="lazy" src="image-20230307155954243.png" alt="image-20230307155954243"  />
</p>
<p><img loading="lazy" src="image-20230307160109188.png" alt="image-20230307160109188"  />
</p>
<ul>
<li><code>t</code>æ²¡æœ‰æ•°ç»„å…ƒç´ ,è°ƒç”¨ <code>hash_search</code> å‡½æ•°,<code>hash</code>éƒ¨åˆ†ä» <code>j = 1</code> å¼€å§‹éå†, <code>i</code>è®°å½•çš„æ˜¯ä¸Šä¸€ä¸ª <code>j</code>çš„å€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">ç¬¬ä¸€è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; t[<span style="color:#cd00cd">2</span>] <span style="">ä¸º</span><span style="color:#cdcd00">nil</span> <span style="">ç„¶å</span>j <span style="color:#39c">-</span> i <span style="">ä¸å¤§äº</span><span style="color:#cd00cd">1</span> <span style="">æ‰€ä»¥ç›´æ¥è¿”å›</span>i<span style="">ä¹Ÿå°±æ˜¯å¤§å°</span><span style="color:#cd00cd">1</span>  
</span></span></code></pre></div><p>åœ¨ä¸¾ä¸ªè§¦å‘äºŒåˆ†æŸ¥æ‰¾çš„ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">6</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307160807187.png" alt="image-20230307160807187"  />
</p>
<ul>
<li><code>t</code>æ²¡æœ‰æ•°ç»„å…ƒç´ ,è°ƒç”¨ <code>hash_search</code> å‡½æ•°,<code>hash</code>éƒ¨åˆ†ä» <code>j = 1</code> å¼€å§‹éå†, <code>i</code>è®°å½•çš„æ˜¯ä¸Šä¸€ä¸ª <code>j</code>çš„å€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">ç¬¬ä¸€è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; t[<span style="color:#cd00cd">2</span>]<span style="">ä¸ä¸º</span><span style="color:#cdcd00">nil</span><span style="">ï¼›ç»§ç»­ä¸‹ä¸€è½®</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬äºŒè½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; t[<span style="color:#cd00cd">4</span>]<span style="">ä¸ä¸º</span><span style="color:#cdcd00">nil</span><span style="">ï¼›ç»§ç»­ä¸‹ä¸€è½®</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬ä¸‰è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; t[<span style="color:#cd00cd">8</span>]<span style="">ä¸º</span>nil<span style="">å¹¶ä¸”</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">ï¼›</span> <span style="">è¿›å…¥äºŒåˆ†æŸ¥æ‰¾é˜¶æ®µ</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬å››è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span>; t[m]<span style="">ä¸ä¸ºç©ºè®¾ç½®</span>i <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span>;<span style="">ç»§ç»­ä¸‹ä¸€è½®äºŒåˆ†æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬äº”è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span><span style="">ï¼›</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">7</span>; t[m]<span style="">ä¸ºç©ºè®¾ç½®</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">7</span>; <span style="">åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="">ä¸å¤§äº</span><span style="color:#cd00cd">1</span> <span style="">ç»“æŸäºŒåˆ†æŸ¥æ‰¾è¿”å›</span>i<span style="">çš„å€¼ä¸º</span><span style="color:#cd00cd">6</span>
</span></span></code></pre></div><h5 id="æœ‰hashæœ‰æ•°ç»„çš„æƒ…å†µ"><span>æœ‰hashæœ‰æ•°ç»„çš„æƒ…å†µ</span></h5>
<h6 id="æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡è¿è´¯çš„"><span>æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡è¿è´¯çš„</span></h6>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307194943203.png" alt="image-20230307194943203"  />
</p>
<p><img loading="lazy" src="image-20230307160109188.png" alt="image-20230307160109188"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§å°å°±æ˜¯æ•°ç»„éƒ¨åˆ†çš„å¤§å°<code>2</code>åŠ ä¸Š<code>hash</code>éƒ¨åˆ†çš„å¤§å°<code>3</code>æ€»å…±ä¸º<code>5</code></p>
<p>æ¨¡æ‹Ÿä¸€ä¸‹è¿‡ç¨‹å› ä¸ºæ•°ç»„éƒ¨åˆ†å¤§å°æ˜¯<code>2</code>,æ‰€ä»¥jç­‰äº<code>2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">ç¬¬ä¸€è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; t[<span style="color:#cd00cd">4</span>]<span style="">ä¸ä¸º</span><span style="color:#cdcd00">nil</span><span style="">ï¼›ç»§ç»­ä¸‹ä¸€è½®</span>white<span style="">å¾ªç¯</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬äºŒè½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; t[<span style="color:#cd00cd">8</span>]<span style="">ä¸º</span><span style="color:#cdcd00">nil</span><span style="">ï¼›è·³å‡º</span>white<span style="">å¾ªç¯</span>;<span style="">åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="">æ˜¯å¦å¤§äº</span><span style="color:#cd00cd">1</span>;<span style="">å‘ç°å¤§äº</span>;<span style="">è¿›å…¥äºŒåˆ†æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬ä¸‰è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›</span>t[m]<span style="">ä¸º</span><span style="color:#cdcd00">nil</span><span style="">ï¼›</span>j<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">6</span><span style="">ï¼›åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="">æ˜¯å¦å¤§äº</span><span style="color:#cd00cd">1</span> <span style="">å‘ç°å¤§äº</span>,<span style="">ç»§ç»­ä¸‹ä¸€è½®äºŒåˆ†æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span><span style="">ç¬¬å››è½®</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">ï¼›</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span>; t[m]<span style="">ä¸ä¸º</span><span style="color:#cdcd00">nil</span> i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">5</span>; <span style="">åˆ¤æ–­</span>j <span style="color:#39c">-</span> i <span style="">æ˜¯å¦å¤§äº</span><span style="color:#cd00cd">1</span> <span style="">å‘ç°æ˜¯ç­‰äº</span><span style="color:#cd00cd">1</span><span style="">ä¸ç¬¦åˆæ¡ä»¶</span>,<span style="">è·³å‡ºå¾ªç¯</span>,<span style="">è¿”å›</span>i,<span style="">ä¹Ÿå°±æ˜¯</span><span style="color:#cd00cd">5</span>
</span></span></code></pre></div><h6 id="æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡ä¸è¿è´¯çš„"><span>æœ‰æ•°ç»„éƒ¨åˆ†å¹¶ä¸”å’Œhashéƒ¨åˆ†ä¸‹æ ‡ä¸è¿è´¯çš„</span></h6>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12å·é‹å­</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21å·é‹å­</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23å·é‹å­</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307200545253.png" alt="image-20230307200545253"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å› ä¸ºä¸è¿è´¯ç›´æ¥å€¼è¿”å›äº†æ•°ç»„çš„é•¿åº¦,å¹¶æ²¡æœ‰åŠ ä¸Šhashçš„é•¿åº¦,ä¸»è¦åŸå› è¿˜æ˜¯æºç çš„è¿™ä¸ªåœ°æ–¹è°ƒç”¨<code>luaH_getint</code>å‡½æ•°è¿”å›äº†<code>absentkey</code></p>
<p><img loading="lazy" src="image-20230307200703891.png" alt="image-20230307200703891"  />
</p>
<h5 id="tableæ±‚å¤§å°æ€»ç»“"><span>#tableæ±‚å¤§å°æ€»ç»“</span></h5>
<p>æ‰€ä»¥ä»ä¸Šé¢çš„å„ç§åˆ†æèƒ½çœ‹å‡ºæ¥,ä¸€èˆ¬çš„æƒ…å†µä¸‹,å¦‚æœè¿™ä¸ªè¡¨ç»“æ„å¹¶ä¸æ˜¯æŒ‰æ•°å­—<code>1~N</code>é¡ºåºé€’å¢çš„ï¼Œé‚£ä¹ˆ<code>#table</code>å–å‡ºæ¥çš„å¤§å°å¯èƒ½ä¼šæ˜¯ä¸€äº›å¥‡æ€ªçš„å€¼,æ‰€ä»¥å»ºè®®ç”¨å¦‚ä¸‹<code>API</code>æ¥å£æ¥æ±‚å¤§å°</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">table</span>.length(t)
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">for</span> k, v <span style="color:#cdcd00">in</span> pairs(t) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#39c">=</span> i <span style="color:#39c">+</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> i
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><h3 id="è¿ç®—ç¬¦é‡è½½"><span>è¿ç®—ç¬¦é‡è½½</span></h3>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰<code>18</code>ä¸­ç¬¦å·èƒ½å¤Ÿå‚ä¸è¿ç®—ç¬¦é‡è½½</p>
<table>
<thead>
<tr>
<th>Cæšä¸¾</th>
<th>å…ƒæ–¹æ³•åå­—</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>TM_EQ</td>
<td>__eq</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;==&ldquo;æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰</td>
</tr>
<tr>
<td>TM_ADD</td>
<td>__add</td>
<td>å¯¹åº”è¿ç®—ç¬¦&rdquo;+&quot;ï¼ˆåŠ æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SUB</td>
<td>__sub</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;-&rsquo;ï¼ˆå‡æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_MUL</td>
<td>__mul</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;*&quot;ï¼ˆä¹˜æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_MOD</td>
<td>__mod</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;%&quot;ï¼ˆå–æ¨¡ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_POW</td>
<td>__pow</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;^&quot;ï¼ˆæ¬¡æ–¹ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_DIV</td>
<td>__div</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;/&quot;ï¼ˆé™¤æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_IDIV</td>
<td>__idiv</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;//&quot;ï¼ˆå‘ä¸‹å–æ•´é™¤æ³•ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BAND</td>
<td>__band</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&amp;&quot;ï¼ˆæŒ‰ä½ä¸ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BOR</td>
<td>__bor</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;|&quot;ï¼ˆæŒ‰ä½æˆ–ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BXOR</td>
<td>__bxor</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;^&quot;ï¼ˆæŒ‰ä½å¼‚æˆ–ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SHL</td>
<td>__shl</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&laquo;&quot;ï¼ˆå·¦ç§»ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_SHR</td>
<td>__shr</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;&raquo;&quot;ï¼ˆå³ç§»ï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_UNM</td>
<td>__unm</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;-&rsquo;ï¼ˆå–è´Ÿï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_BNOT</td>
<td>__bnot</td>
<td>å¯¹åº”è¿ç®—ç¬¦&quot;~&quot;ï¼ˆæŒ‰ä½éï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_LT</td>
<td>__lt</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;&lt;&rsquo;ï¼ˆå°äºï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_LE</td>
<td>__le</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;&lt;=&rsquo;ï¼ˆå°äºç­‰äºï¼‰æ“ä½œ</td>
</tr>
<tr>
<td>TM_CONCAT</td>
<td>__concat</td>
<td>å¯¹åº”çš„è¿ç®—ç¬¦ &lsquo;..&rsquo;(è¿æ¥ï¼‰æ“ä½œ</td>
</tr>
</tbody>
</table>
<p>ç»ˆäºåˆ°äº†æœˆåº•ç›˜ç‚¹çš„æ—¥å­äº†,ä¸ºäº†èƒ½æ›´å¥½çš„ç®¡ç†åº—é¢è¿›è¡Œç›˜ç‚¹,éœ€è¦å¯¹å¾ˆå¤šæ•°æ®è¿›è¡ŒåŠ åŠ å‡å‡,å–æ¨¡,ç­‰ç­‰,è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨ä¸Šæˆ‘ä»¬çš„<code>lua</code>çš„<code>18</code>ä¸ªå…ƒæ–¹æ³•,è¿›è¡Œè¿ç®—ç¬¦é‡è½½</p>
<h4 id="__eq"><span>__eq</span></h4>
<p>ä½œç”¨:æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰</p>
<p>ä¸‹é¢ä¾‹å­æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®è®°å½•é‡æ˜¯ä¸æ˜¯ä¸€æ ·</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å®šä¹‰ç›¸ç­‰æ“ä½œæ¥æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®é‡æ˜¯ä¸æ˜¯ä¸€æ ·</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__eq <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#39c">#</span>table1 <span style="color:#39c">==</span> <span style="color:#39c">#</span>table2
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--æ¯”è¾ƒä¸€ä¸‹ä¸»åº—å’Œåˆ†åº—å„è‡ªé”€å”®é‡æ˜¯ä¸æ˜¯ä¸€æ ·</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> isSame <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">==</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(isSame)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307222416122.png" alt="image-20230307222416122"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿”å›äº†<code>false</code>è¯´æ˜ä¸¤å®¶åº—é”€å”®è®°å½•é‡ä¸ä¸€æ ·</p>
<h4 id="__mul"><span>__mul</span></h4>
<p>ä½œç”¨:åšä¹˜æ³•æ“ä½œ</p>
<p>ç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’±</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å®šä¹‰ä¹˜æ³•æ“ä½œæ¥ç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’±</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__mul <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> money <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span>  _,v <span style="color:#cdcd00">in</span> pairs(table1) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		money <span style="color:#39c">=</span> money <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span>  _,v <span style="color:#cdcd00">in</span> pairs(table2) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		money <span style="color:#39c">=</span> money <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> money
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç»Ÿè®¡ä¸‹ä¸»åº—å’Œåˆ†åº—ä¸€å…±æŒ£äº†å¤šå°‘é’±</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> money <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">*</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(money)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307223652491.png" alt="image-20230307223652491"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æ€»çš„<code>money</code>ç®—å‡ºæ¥äº†ä¸€å…±<code>17400</code>å…ƒ</p>
<h4 id="__add"><span>__add</span></h4>
<p>ä½œç”¨:ç”¨æ¥è¿›è¡ŒåŠ æ³•æ“ä½œ</p>
<p>ä¸¾ä¸ªæ —å­æ¯”å¦‚ä¸‹é¢ç”¨æ¥ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—æ€»çš„é”€å”®ç‰©å“ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å®šä¹‰åŠ æ³•æ“ä½œç”¨æ¥ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—çš„é”€å”®æ•°æ®</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__add <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	 <span style="color:#cdcd00">for</span> _, value <span style="color:#cdcd00">in</span> pairs(table2) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>      table.insert(table1, value)
</span></span><span style="display:flex;"><span>   <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>   <span style="color:#cdcd00">return</span> table1
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç»Ÿè®¡ä¸»åº—å’Œåˆ†åº—æ€»çš„é”€å”®æ•°æ®</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> totalShoeInfo <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">+</span> myBranchShoeStore
</span></span><span style="display:flex;"><span><span style="color:#000080">--è¾“å‡ºä¸€ä¸‹ç»“æœ</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(totalShoeInfo) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> item <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> i<span style="color:#39c">=</span><span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">3</span> <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">if</span> i <span style="color:#39c">~=</span> <span style="color:#cd00cd">3</span> <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>			item <span style="color:#39c">=</span> item <span style="color:#39c">..</span> v[i] <span style="color:#39c">..</span> <span style="color:#cd0000">&#34;,&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">else</span>
</span></span><span style="display:flex;"><span>			item <span style="color:#39c">=</span> item <span style="color:#39c">..</span> v[i]
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;{&#34;</span> <span style="color:#39c">..</span> item <span style="color:#39c">..</span> <span style="color:#cd0000">&#34;}&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307221910971.png" alt="image-20230307221910971"  />
</p>
<p>ä»ç»“æœä¸Šçœ‹,æˆ‘ä»¬å·²ç»å®Œç¾çš„æŠŠä¸¤å®¶åº—çš„æ•°æ®éƒ½ç»Ÿè®¡åˆåœ¨ä¸€å—äº†</p>
<p><strong>å…¶ä»–çš„è¿ç®—ç¬¦é‡è½½å°±ä¸åœ¨ä¸¾ä¾‹äº†,å’Œä¸Šé¢åˆ—å‡ºæ¥çš„<code>3</code>ä¸ªä¾‹å­éå¸¸é›·åŒ</strong></p>
<h3 id="__call"><span>__call</span></h3>
<p>ä½œç”¨:å½“<code>table</code>åå­—åšä¸ºå‡½æ•°åå­—çš„å½¢å¼è¢«è°ƒç”¨çš„æ—¶å€™,ä¼šè°ƒç”¨<code>__call</code>å‡½æ•°</p>
<p>æŸ¥çœ‹ä¸‹ä¸»åº—æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è·</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å®šä¹‰å‡½æ•°è°ƒç”¨æ“ä½œæ¥æŸ¥çœ‹ä¸‹æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è·</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__call <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(self,target)
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> num14 <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> _,v <span style="color:#cdcd00">in</span> pairs(self) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		num14 <span style="color:#39c">=</span> num14 <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> target <span style="color:#39c">-</span> num14
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--æŸ¥çœ‹ä¸‹ä¸»åº—æ¯æ—¥å®Œæˆé‡‘é¢é‡å·®è·</span>
</span></span><span style="display:flex;"><span>print(myShoeStore(<span style="color:#cd00cd">10000</span>))<span style="color:#000080">--å‡è®¾éœ€è¦æ¯æ—¥å®Œæˆ10000é‡‘é¢çš„é”€å”®é‡</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307225538660.png" alt="image-20230307225538660"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯æ—¥ç›®æ ‡é‡‘é¢å·²ç»è¶…é¢å®Œæˆ,å¹¶ä¸”è¶…äº†<code>1400</code>å—</p>
<h3 id="__close"><span>__close</span></h3>
<h4 id="ä¾‹å­-1"><span>ä¾‹å­</span></h4>
<p>ä½œç”¨:è¢«æ ‡è®°ä¸º<code>to-be-closed</code>çš„å±€éƒ¨å˜é‡ä¼šåœ¨è¶…å‡ºå®ƒçš„ä½œç”¨åŸŸæ—¶,è°ƒç”¨å®ƒçš„<code>__closed</code>å…ƒæ–¹æ³•</p>
<p><code>close</code>å˜é‡<code>To-be-closed Variables</code>éœ€è¦å’Œ<code>close</code>å…ƒæ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œåœ¨å˜é‡è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œä¼šè°ƒç”¨å˜é‡çš„<code>close</code>å…ƒæ–¹æ³•<code>__close</code>,<code>close</code>å˜é‡ä¸€èˆ¬ç”¨äºéœ€è¦åŠæ—¶é‡Šæ”¾çš„èµ„æºçš„æƒ…å†µ,å¤šç”¨è¿™ä¸ªå…¶å®ä¹Ÿèƒ½å‡è½»<code>gc</code>çš„è´Ÿæ‹…</p>
<p>å½“åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--é‹å­ç±»å‹,é”€å”®é¢,æ•°é‡</span>
</span></span><span style="display:flex;"><span>	light <span style="color:#39c">=</span> <span style="color:#cdcd00">true</span>, <span style="color:#000080">--ç¯å¼€ç€</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--ç›˜ç‚¹æ“ä½œç”¨æ¥åšMetatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å®šä¹‰__closeæ“ä½œå½“åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__close <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(self)
</span></span><span style="display:flex;"><span>	self.light <span style="color:#39c">=</span> <span style="color:#cdcd00">false</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--å½“ä¸»åº—é“ºæ™šä¸Šå…³é—¨çš„æ—¶å€™èƒ½è‡ªåŠ¨æŠŠåº—é“ºçš„ç¯å…³é—­</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">do</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> closeStore <span style="color:#39c">&lt;</span>close<span style="color:#39c">&gt;</span> <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.light)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307230719223.png" alt="image-20230307230719223"  />
</p>
<h4 id="æºç åˆ†æ"><span>æºç åˆ†æ</span></h4>
<p><img loading="lazy" src="image-20230307230930861.png" alt="image-20230307230930861"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ä¸€ä¸ªæ˜¯<code>callclosemethod</code>å’Œ<code>checkclosemth</code></p>
<ul>
<li><code>callclosemethod</code> ä¸»è¦å°±æ˜¯ç”¨æ¥è°ƒç”¨è®¾ç½®çš„å…ƒæ–¹æ³•</li>
<li><code>checkclosemth</code> è¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥æ£€æµ‹æ˜¯å¦è®¾ç½®å¥½äº†å…ƒæ–¹æ³•,å¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯å°±ä¼šæŠ¥é”™</li>
</ul>
<h2 id="æ›´è¯¦ç»†çš„æ³¨é‡Šè¯·å»æˆ‘çš„githubåœ°å€"><span>æ›´è¯¦ç»†çš„æ³¨é‡Šè¯·å»æˆ‘çš„GitHubåœ°å€</span></h2>
<p>ä»¥ä¸‹æ˜¯æˆ‘å‡ ä¹æ¯è¡Œéƒ½åŠ äº†æ³¨é‡Šçš„<code>GitHub</code>åœ°å€</p>
<ol>
<li>
<p><code>ltm.c</code>æ³¨é‡Šåœ°å€</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/ltm.c"><strong>ltm.cæ³¨é‡Š</strong></a></p>
</li>
<li>
<p><code>ltm.h</code>æ³¨é‡Šåœ°å€</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/ltm.h"><strong>ltm.hæ³¨é‡Š</strong></a></p>
</li>
</ol>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://frog-game.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://frog-game.github.io/img/alipay_pay.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://frog-game.github.io/posts/read/lua5.4.4.code/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>[Lua5.4.4æºç ].æŒ‡ä»¤é›†</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://www.frog-game.work/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: "ap-beijing",
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2023 
        <a href="https://frog-game.github.io/" style="color:#939393;">frog&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="https://frog-game.github.io/img/beian.png" style="float:left;margin: 0px 5px 0px 0px;"/>
            å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
