<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Lua5.4.4源码].元表 | frog&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="lua源码元表分析">
<meta name="author" content="
作者:&nbsp;frog">
<link rel="canonical" href="https://frog-game.github.io/posts/read/lua5.4.4.metatable/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8b75bf56d6fb0c429b5f3ce03bce19c9ef1e90cc024b64bd12ec321c68cca894.css" integrity="sha256-i3W/Vtb7DEKbXzzgO84Zye8ekMwCS2S9EuwyHGjMqJQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://frog-game.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="mask-icon" href="https://frog-game.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="[Lua5.4.4源码].元表" />
<meta property="og:description" content="lua源码元表分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/" />
<meta property="og:image" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T01:30:29&#43;08:00" />
<meta property="article:modified_time" content="2023-03-07T01:30:29&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" />
<meta name="twitter:title" content="[Lua5.4.4源码].元表"/>
<meta name="twitter:description" content="lua源码元表分析"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "https://frog-game.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📕 阅读",
      "item": "https://frog-game.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "[Lua5.4.4源码].元表",
      "item": "https://frog-game.github.io/posts/read/lua5.4.4.metatable/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Lua5.4.4源码].元表",
  "name": "[Lua5.4.4源码].元表",
  "description": "lua源码元表分析",
  "keywords": [
    ""
  ],
  "articleBody": "前言 lua5.4.4元表现在已经加到了25个类型\n简单来说元方法的作用是因为使用lua原始语法不能做到所需的要求比如对两个table进行加减乘除,或者我在退出作用域的时候想要快速的清除自己自定义的一些数据,等等其他一些特殊需求\n如果大家对C++的重载运算符比较熟悉,或许能够更加清晰的了解元表的作用,其实两者有异曲同工的作用\n从上面的源代码我们可以分析出\nlua中的每个值都可以拥有一个元表 table和userdata各自拥有自己独立的元表 非table和userdata的元表统统放到了global_State的mt数组当中 从对外lua层的API接口来看,我们能看到在lua层只能按设置table的元表,而其他类型的元表设置并没有对外的lua层API接口,lua中提供的两个参数如下 setmetatable(table,metatable) getmetatable(table) 其他类型设置元表只能通过c代码提供的API接口创建元表,比如luaL_newmetatable lua层setmetatable和getmetatable使用方法 首先我们看一下C代码是怎么实现的\nstatic const luaL_Reg base_funcs[] = { {\"getmetatable\", luaB_getmetatable}, {\"setmetatable\", luaB_setmetatable}, }; /// @brief // lua_getmetatable：如果该索引处的值有元表,则将其元表压栈,返回 1 。 否则不会将任何东西入栈,返回 0 。 // luaL_getmetafield：将索引 obj 处对象的元表中 __metatable 域的值压栈。 // 如果该对象没有元表,或是该元表没有相关域, 此函数什么也不会压栈并返回 LUA_TNIL。 /// @param L /// @return static int luaB_getmetatable (lua_State *L) { luaL_checkany(L, 1); if (!lua_getmetatable(L, 1)) { lua_pushnil(L); return 1; /* no metatable */ } luaL_getmetafield(L, 1, \"__metatable\"); return 1; /* returns either __metatable field (if present) or metatable */ } // LUA_TNIL定义在lua.h中 是0 // lua_setmetatable：把一张表弹出栈,并将其设为给定索引处的值的元表。 // a = {} // setmetatable(a,{__metatable = \"hello\"}) // setmetatable(a,{__metatable = \"world\"}) // 这种情况就会报错 // 也就是说 __metatable这个是保护元表,不可读写 static int luaB_setmetatable (lua_State *L) { int t = lua_type(L, 2); luaL_checktype(L, 1, LUA_TTABLE); luaL_argexpected(L, t == LUA_TNIL || t == LUA_TTABLE, 2, \"nil or table\"); if (l_unlikely(luaL_getmetafield(L, 1, \"__metatable\") != LUA_TNIL)) return luaL_error(L, \"cannot change a protected metatable\"); lua_settop(L, 2); lua_setmetatable(L, 1); return 1; } 从源码看出当我们在lua层第一次调用getmetatable(table)的时候如果table没有设置元表就会返回一个nil\nlocal t = getmetatable({}) print(t) 如果设置的是普通元表,那么就会直接返回普通元表\nlocal tt = { } local t2 = { } print(\"m1 table addr:\", t2) setmetatable(tt, t2) print(\"getmetatable addr:\", getmetatable(tt)) 从这个示例的lua代码中我们可以看出t2 table的地址是0000018860667A90 而 getmetatable(tt)的地址也是0000018860667A90 所以从这里我们可以看出其实这代码是lua tt table表里面的c结构体Table里面的metatable指针指向了lua t2 table\ntypedef struct Table { struct Table *metatable;//这个地方如果设置了元表就会通过这个指针指向设置的元表 } Table; 示意图如下\n如果设置了__metatable字段那么就会直接返回于这个字段相关的值\nlocal tt = { } local t2 = { [\"__metatable\"] = \"hello world!!!\" } setmetatable(tt, t2) print(\"getmetatable:\", getmetatable(tt)) 从上我们可以看出如果t2表里面的__metatable的字段设置内容那么就会直接输出__metatable的字段内容\n示意图如下\n当然除了这个我们还要注意的是__metatable字段是有保护机制的不可重写\na = {} setmetatable(a,{__metatable = \"hello\"}) setmetatable(a,{__metatable = \"world\"}) 执行结果\n可以看到此处报错了输出了cannot change a protected metatable错误提示\n还有一点是元表其实是可以共享的比如下面的例子\nlocal tt = { } local tt2 = { } local t2 = { [\"__metatable\"] = \"hello world\" } setmetatable(tt, t2) setmetatable(tt2, t2) print(\"get tt metatable :\", getmetatable(tt)) print(\"get tt2 metatable :\", getmetatable(tt2)) 可以看到tt和tt2指向的是同一个元表t2,然后同时输出了相同的内容hello world\n大概示意图如下\nC层调用元表 其实在之前解释lua源码类型中的full userdata的时候其实就描述过了C是怎么使用luaL_newmetatable luaL_getmetatable lua_setmetatable 来是full userdata起作用的\n//c文件 //#include extern \"C\" { #include \"lua.h\" #include \"lauxlib.h\" #include \"lualib.h\" } #include using namespace std; static struct StudentTag { char* strName; // 学生姓名 }T; static int CFunStudent(lua_State* L) { size_t iBytes = sizeof(struct StudentTag); struct StudentTag* pStudent; pStudent = (struct StudentTag*)lua_newuserdata(L, iBytes); //设置元表 luaL_getmetatable(L, \"StudentMetatable\"); lua_setmetatable(L, -2); return 1; } static int GetName(lua_State* L) { struct StudentTag* pStudent = (struct StudentTag*)luaL_checkudata(L, 1, \"StudentMetatable\"); lua_pushstring(L, pStudent-\u003estrName); return 1; } static int SetName(lua_State* L) { // 第一个参数是userdata struct StudentTag* pStudent = (struct StudentTag*)luaL_checkudata(L, 1, \"StudentMetatable\"); // 第二个参数是一个字符串 const char* pName = luaL_checkstring(L, 2); luaL_argcheck(L, pName != NULL \u0026\u0026 pName != \"\", 2, \"Wrong Parameter\"); pStudent-\u003estrName = (char*)pName; return 0; } static luaL_Reg arrayFunc_meta[] = { { \"getName\", GetName }, { \"setName\", SetName }, { NULL, NULL } }; static luaL_Reg arrayFunc[] = { { \"new\", Student}, { NULL, NULL } }; extern \"C\" _declspec(dllexport) int luaopen_mytestlib(lua_State *L) { // 创建一个新的元表 luaL_newmetatable(L, \"StudentMetatable\"); // 元表.__index = 元表 lua_pushvalue(L, -1); lua_setfield(L, -2, \"__index\"); luaL_setfuncs(L, arrayFunc_meta, 0); luaL_newlib(L, arrayFunc); lua_pushvalue(L, -1); lua_setglobal(L, \"StudentModule\"); return 1; } -- lua 文件 require \"mytestlib\" local objStudent = StudentModule.new() objStudent:setName(\"11111\") local strName = objStudent:getName() print(strName) for k,v in pairs(getmetatable(objStudent)) do print(tostring(k),tostring(v)) end 大概流程图如下\n首先在ENV里面注册了模块studentModule,等价于_ENV[\"studentModule\"] = table 然后这个table里面存有lua的接口new和指向c层函数指针的CFunstudent 通过函数指针的CFunstudent指向的CFunstudent函数我们创建了一块内存区域 因为userdata也和table结构一样都能设置元表,也就是说可以通过元表,能给lua层提供接口来操作这块userdata 所以后面这部分就是创建元表,并通过元表内部的setName和getName函数对userdata进行了操作,有点像我们不能很方便去直接控制电视机的电路板[userdata],所以发明了遥控器[元表],方便用户[lua层]通过遥控器控制电视机换台什么的操作 设置元方法 C枚举 元方法名字 解释 TM_INDEX __index 索引table[key] 访问表中不存在的值 TM_NEWINDEX __newindex 索引赋值 table[key] = value 对表中不存在的值进行赋值 TM_GC __gc 当对象被gc回收时将会调用gc元方法 TM_MODE __mode 弱引用表 TM_LEN __len 对应运算符\"#\" 取对象长度 TM_EQ __eq 对应运算符\"==“比较两个对象是否相等 TM_ADD __add 对应运算符”+\"（加法）操作 TM_SUB __sub 对应的运算符 ‘-’（减法）操作 TM_MUL __mul 对应运算符\"*\"（乘法）操作 TM_MOD __mod 对应运算符\"%\"（取模）操作 TM_POW __pow 对应运算符\"^\"（次方）操作 TM_DIV __div 对应运算符\"/\"（除法）操作 TM_IDIV __idiv 对应运算符\"//\"（向下取整除法）操作 TM_BAND __band 对应运算符\"\u0026\"（按位与）操作 TM_BOR __bor 对应运算符\"|\"（按位或）操作 TM_BXOR __bxor 对应运算符\"^\"（按位异或）操作 TM_SHL __shl 对应运算符\"«\"（左移）操作 TM_SHR __shr 对应运算符\"»\"（右移）操作 TM_UNM __unm 对应的运算符 ‘-’（取负）操作 TM_BNOT __bnot 对应运算符\"~\"（按位非）操作 TM_LT __lt 对应的运算符 ‘\u003c’（小于）操作 TM_LE __le 对应的运算符 ‘\u003c=’（小于等于）操作 TM_CONCAT __concat 对应的运算符 ‘..’(连接）操作 TM_CALL __call 函数调用操作 func(args) TM_CLOSE __close 被标记为to-be-closed的局部变量\n会在超出它的作用域时,调用它的__closed元方法 __index 举个现实中的例子,比如你现在去街上买鞋子,来到了鞋柜,你非常喜欢这双鞋子,但是这家店里面没有这双款式的鞋子了,一般来说店家都会说,不着急你等等,我去其他分店帮你调配一下鞋子,您是等等还是我邮寄给你过去呢\n其实这快,当店家没有鞋子的时候,去其他分店调配和lua的__index很像\n首先我作为店家今天库存只有12号和13号款式的鞋子,lua伪代码如下 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } 这个时候来了个小红问问有没有20号款式的鞋子,说非常喜欢这样款式的,作为店主首先你查了下自己的库存\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } print(myShoeStore.num20_shoe) 我们可以看到返回了nil,说明我现在的店铺已经没有20号鞋子的库存了,为了留住顾客,你只能去分店查找,毕竟一单生意一份收入,挣钱嘛不寒碜,那怎么样才能和分店挂钩起来,让我能方便的查找呢,相信聪明的你肯定想到了__index元方法,没错就是它\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { __index = {--关键地方,靠的就是__index来进行关联查找 num20_shoe = \"Size 20 shoes\",--20号鞋子 } } setmetatable(myShoeStore,myBranchShoeStore);--关键地方,这里等价于把两家店给串连起来了 print(myShoeStore.num20_shoe) 可以看到上图的输出,完美找到了20号的鞋子,留下了这笔生意,当然如果你分店更多,那么你可以一直用__index元方法串连下去,直到你找到你想要的数据\n总结:定义了在table中通过给定的key找到的value为nil时怎么办的行为\n下面我们在进行一下关键源码点分析\n上面的源码就是设置__index元方法的核心逻辑地方\n首先第一步会判断slot是不是null,如果是那么就说明t变量不是table,就直接报错跳过 第二步如果slot不是null那说明t是一个table,这个时候我们通过TM_INDEX索引找到table对应的metatable元方法 得到了元方法指针以后,我们在判断一下如果指针是null那么就说明没有设置元方法,那么只要直接返回nil就可以了 走到了这一步了,那么说明我们找到了TM_INDEX对应的元方法了,注意哈,重点来了 如果元方法是个函数,那么就会调用luaT_callTMres把函数入栈,并且把结果求出来,当做查询结果 如果元方法是个table,那么就直接求元素下标为key的table内容,也就是tm[key]指向的内容 如果上面都不满足,既不是表,又不是函数,就直接返回slot为null,结果为0 综合总结\nlua代码从表t中查找键k时,lua处理流程如下:\nt中是否有k,有则直接返回值,否则进行第二步\nt是否有元表, 无则返回nil, 有则进行第三步\nt的元表是否有__index元方法,没有直接返回nil, 有则查找__index指向的表或对应的函数,把表中或者函数的返回值当做结果\n到此为止我们通过源码知道了__index内幕到底做了啥,那为了正确性,我们写点lua源码验证一下\n__index元方法设置的不是table,或者函数时候 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { __index = 11111 -- 注意这个地方的写法 } setmetatable(myShoeStore,myBranchShoeStore);--关键地方,这里等价于把两家店给串连起来了 print(myShoeStore.num20_shoe) 我们可以看到当没有把__index的元方法设置成table,或者函数的时候,可以看到输出是直接报错的\n__index元方法设置的是table local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { __index = {--关键地方,靠的就是__index来进行关联查找 num20_shoe = \"Size 20 shoes\",--20号鞋子 } } setmetatable(myShoeStore,myBranchShoeStore);--关键地方,这里等价于把两家店给串连起来了 print(myShoeStore.num20_shoe) __index元方法设置的是函数 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { __index = function(table,key,key) print(table) print(key) return \"Size 20 shoes\" end } setmetatable(myShoeStore,myBranchShoeStore);--关键地方,这里等价于把两家店给串连起来了 print(myShoeStore.num20_shoe) 从上面我们可以看出如果在myShoeStore中找不到num20_shoe,那么就会从他的元表myBranchShoeStore中去查找是不是有设置元方法__index,发现__index元方法设置的是个函数,还有能看到这个函数有两个形参,一个是table,一个是key正好对应的是myShoeStore和num20_shoe字段,最后还能看到返回值\"Size 20 shoes\"也作为了结果返回\n为什么有些地方__index元方法要指向自己 在讲解前请先熟悉这个流程\nlua代码从表t中查找键k时,lua处理流程如下:\nt中是否有k,有则直接返回值,否则进行第二步\nt是否有元表, 无则返回nil, 有则进行第三步\nt的元表是否有__index元方法,没有直接返回nil, 有则查找__index指向的表或对应的函数,把表中或者函数的返回值当做结果\na. 当我们使用__index元方法要指向自己的方法时候\n---当我们使用__index元方法要指向自己的方法时候 local class = {} function class:new() self.__index = self return setmetatable( {}, self ) end function class:get_num20_shoe() print(\"Size 20 shoes\") end --当我们第一次new class的时候,发现可以输出get_num20_shoe函数的内容 local myshoestrore = class:new() myshoestrore.get_num20_shoe() -- 当我们在此调用通过myshoestroe new class的时候,发现还是能继续输出get_num20_shoe函数里面的内容 local myBranchShoeStore = myshoestrore:new() myBranchShoeStore.get_num20_shoe() b. 当我们不使用__index元方法要指向自己的方法时\n---当我们不使用__index元方法要指向自己的方法时候 local class = {} class.__index = class function class:new() return setmetatable( {}, self ) end function class:get_num20_shoe() print(\"Size 20 shoes\") end --当我们第一次new class的时候,发现可以输出get_num20_shoe函数的内容 local myshoestrore = class:new() myshoestrore.get_num20_shoe() -- 当我们在此调用通过myshoestroe new class的时候,发现就不能在继续输出get_num20_shoe函数里面的内容了,主要原因还是 -- myshoestrore里面是没有__index元方法的,导致继承链断了 local myBranchShoeStore = myshoestrore:new() myBranchShoeStore.get_num20_shoe() __index实现的面向对象 这里贴一下云风大神写的一个lua面向对象实现的代码\nlocal _class = {} -- super 为基类 function class(super) local class_type = {} --类模板 class_type.ctor = false -- 构造函数 class_type.super = super --赋值基类 class_type.staticFun = {} --静态函数 class_type.new = function(...) -- new方法成员 local obj = {} do local create --嵌套调用主要是为了能掉到基类ctor create = function(c, ...) if c.super then create(c.super, ...) --调用基类ctor end if c.ctor then c.ctor(obj, ...) --调用构造 end end create(class_type, ...) end setmetatable(obj, {__index = _class[class_type]}) --利用元表__index设置保证 obj继承自_class[class_type] return obj end local vtbl = {} --vtbl理解为类容器也就是存类的成员,函数等等 vtbl.super = _class[super] _class[class_type] = vtbl setmetatable( -- 有新的成员存到vtbl中 class_type, { __newindex = function(t, k, v) vtbl[k] = v end } ) if super then setmetatable( -- 如果子类有成员直接返回,子类没有返回基类的成员 vtbl, { __index = function(t, k) local ret = _class[super][k] vtbl[k] = ret return ret end } ) end return class_type end 具体实现原理请仔细查看源码注释吧,这里就不详细解释了,相信聪明的你一定能看出名堂\n如果想更复杂的lua实现class面向对象的代码方法,可以去这个地址喵喵,这个写的还是很不错的,里面有强弱表相关,不到200行代码就实现了,类,继承,虚函数,私有变量,table混合使用等等功能\nmiddleclass\n__newindex 如果说__index字段是在访问表中不存在的值是执行的查找操作的话[get]\n那么__nexindex字段则是在对表中不存在的值进行的赋值操作[set]\n当然你也可以给你的table去一个的赋值创建变量比如像下面lua代码一样,为了能够留住顾客我费劲通过各种方法在我的店铺创建出来了一双20号的鞋子\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } myShoeStore.num20_shoe = \"Size 20 shoes\" --费劲巴拉的在自己店铺弄出了一双20号款式的鞋子 虽然20号鞋子创建出来了,但是大家发现没有我是总店按道理来说总店不是工厂,而应该让工厂去履行这个职责,这样专人做转事,保值保量,又快又好,所以我们又对代码做了如下处理\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myShoeFactory = { __newindex = function(table, key, value) --关键地方,靠的就是__newindex来进行鞋子的创建 rawset(table, key, value); end } setmetatable(myShoeStore,myShoeFactory);--关键地方,这里等价于把两家店给串连起来了 --- 有元表的情况下设置值,这样等价于我把本来要在主店创建20号鞋子的任务,丢给我的鞋子工厂去处理了 myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) 通过上面的处理等价于我把本来要在主店创建20号鞋子的任务,丢给我的鞋子工厂myShoeFactory去处理了\n接下来我们来看看源码\n我们可以看到大概流程如下\nt中是否有元方法,没有的话直接设置值,否则进行第二步 元方法指向的函数,直接通过luaT_callTM函数接口进行设置,否则进行第三步 如果元方法指向是个table,那么就直接回去table对应的值,进行设置,否则进行第四步 如果元方法指向不是table也不是函数,那么就直接报错 __newindex设置的不是table也不是函数的时候 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myShoeFactory = { __newindex = 11111 } setmetatable(myShoeStore,myShoeFactory);--关键地方,这里等价于把两家店给串连起来了 --- 设置的不是table也不是函数的时候 myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) _元表没有_设置newindex的时候 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myShoeFactory = { } setmetatable(myShoeStore,myShoeFactory);--关键地方,这里等价于把两家店给串连起来了 --- _元表没有_设置newindex的时候 myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) 可以看到直接赋值了,还是有想要的结果输出\n__newindex设置的是table local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myShoeFactoryItem = { num20_shoe = \"Size 21 shoes\" } local myShoeFactory = { __newindex = myShoeFactoryItem } setmetatable(myShoeStore,myShoeFactory);--关键地方,这里等价于把两家店给串连起来了 print(\"set num20_shoe before myShoeFactoryItem.num20_shoe:\",myShoeFactoryItem.num20_shoe) myShoeStore.num20_shoe = \"Size 20 shoes\" print(\"set num20_shoe after myShoeFactoryItem.num20_shoe:\",myShoeFactoryItem.num20_shoe) print(myShoeStore.num20_shoe) 我们可以看到当修改myShoeFactoryItem中num20_shoe字段的之前他的值是\"Size 21 shoes\"\n当调用 myShoeStore.num20_shoe = \"Size 20 shoes\"进行设置的时候\nmyShoeFactoryItem中num20_shoe字段的之前他的值变成了\"Size 20 shoes\"\n而再次输出myShoeStore.num20_shoe的时候看到的值是nil\n所以我们可以看到这东西有点像我的工厂正在产21号的鞋子,但是我这个时候紧急需要20号鞋子,我就隔空通过主店对工厂发出了创建20号鞋子的命令,但是主店却不会去创建20号鞋子,这样非常nice有点隔空打牛,但是不影响主店的意思在里面\n__newindex设置的是函数 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myShoeFactory = { __newindex = function(table, key, value) --关键地方,靠的就是__newindex来进行鞋子的创建 rawset(table, key, value);--使用rawset来进行设置,因为不会去调用元方法对table进行设置,所以能得到更好的性能和避免元方法的无限递归调用 end } setmetatable(myShoeStore,myShoeFactory);--关键地方,这里等价于把两家店给串连起来了 --- 有元表的情况下设置值,这样等价于我把本来要在主店创建20号鞋子的任务,丢给我的鞋子工厂去处理了 myShoeStore.num20_shoe = \"Size 20 shoes\" print(myShoeStore.num20_shoe) 这块地方废话就不多说了,可以自己对着注释捋一下就明白了,其实__newindex开场白的时候也进行了介绍\n__gc 主要用来当对象被销毁时,该元方法将以对象作为参数进行调用,并对一些自定义的资源释放,可以将此元方法认为是一种析构函数也行,这个元方法指向的内容必须的是个函数\n先来喵喵源代码\n1号位置获取元方法 2号位置调用你指向的函数,从调用的是luaD_pcall函数中可以看出,__gc元方法指向的必须是个函数 __gc指向的不是函数 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } print(\"myShoeStore addr:\",myShoeStore)--先打印下myShoeStore table地址 local myShoeFactoryGC = { __gc =1111 } setmetatable(myShoeStore,myShoeFactoryGC); myShoeStore = nil --设置成nil,下面调用collectgarbage才会被回收 collectgarbage()-- 进行gc回收 可以看到什么都没有发生\n__gc指向的是函数 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } print(\"myShoeStore addr:\",myShoeStore)--先打印下myShoeStore table地址 local myShoeFactoryGC = { __gc =function( table ) print(\"myShoeFactoryGC released table addr:\",table) -- myShoeStore table被回收了 end } setmetatable(myShoeStore,myShoeFactoryGC); myShoeStore = nil --设置成nil,下面调用collectgarbage才会被回收 collectgarbage()-- 进行gc回收 从上面我们能够看出当myShoeStore table被回收的时候,也会触发__gc的元方法,大白话来说就有点像我的主店倒闭了,那么和我关联的工厂也没有必要在给我进行关联,给我发鞋子什么的来我这卖了.\n__mode 假设如果你的主店和你名下的分店有强引用关系,比如你欠了分店的预付款什么的,这个时候分店不想和你干了,按照法律来说及时分店自己关闭了,分店和你的劳动纠纷还是存在,你还是跑不了,毕竟强引用关系再次,但是如果你和分店在签订加盟合同的时候,说的是自负盈亏,如果主店付不出利润钱了,两个人也扯不上任何法律上的关系,这样分店自己关闭了,你也不用在负责任,这就有点像弱引用的关系\nlocal myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { num20_shoe = \"Size 20 shoes\",--20号鞋子 num21_shoe = \"Size 21 shoes\",--21号鞋子 } local contract = {} --两人在此建立合同 contract[1] = myShoeStore contract[2] = myBranchShoeStore myBranchShoeStore = nil --设置成nil,下面调用collectgarbage才会被回收 collectgarbage()-- 进行gc回收 for k,v in pairs(contract) do print(k,v) end 可以看到当两者建立合同并且没有设置弱引用的时候,myBranchShoeStore分店哪怕主动回收了,最后发现和myShoeStore主店有引用关系在,还是没有被回收\n那么怎么解决这种情况呢,我们可以使用__mode来解决这个问题,\n操作符 说明 k 表的key为弱引用 v 表的value为弱引用 kv 表的key,value都为弱引用 local myShoeStore = { num12_shoe = \"Size 12 shoes\",--12号鞋子 num13_shoe = \"Size 13 shoes\",--13号鞋子 } local myBranchShoeStore = { num20_shoe = \"Size 20 shoes\",--20号鞋子 num21_shoe = \"Size 21 shoes\",--21号鞋子 } local contract = {} --两人在此建立合同 contract[1] = myShoeStore contract[2] = myBranchShoeStore for k,v in pairs(contract) do print(k,v) end print(\"\\n-------------collectgarbage after-----------------\") setmetatable(contract,{__mode=\"v\"})--这个地方把value设置成了弱引用 myBranchShoeStore = nil --设置成nil,下面调用collectgarbage才会被回收 collectgarbage()-- 进行gc回收 for k,v in pairs(contract) do print(k,v) end 我们可以看到回收之前是2个table,而当调用myBranchShoeStore = nil ,collectgarbage()的时候,发现myBranchShoeStore 被回收了\n入口源码剖析 1号位置是从元表中获取元方法 2号位置是根据设置的操作符是什么进行对应的gc回收 弱表原理剖析 上面是弱表的原理剖析,大家可以把图片放大或者下载下来观看\n弱表具体的相关源码太多了,这里就不一一展示了,感兴趣的可以去下面连接查找traverseweakvalue,traverseephemeron,traverseephemeron,traversetable四个主要函数进行观看,函数处也写了不少注释\n弱表相关的gc部分 __len 这个是用来求自定义长度使用的\n例子 假如这个时候来了个顾客,顾客说你这有20码以上的鞋子吗,我的脚比较特殊需要都试试,如果你是店家但是因为没有使用信息化处理,看着满主店仓库堆满的鞋子,你是不是会很绝望,等你从仓库中翻出那些鞋子,估计顾客都跑掉了,所以这个时候我们就可以使用_len元方法来处理这个窘迫的问题\nlocal myShoeStore = { num12_shoe = {12,\"Size 12 shoes\"},--12号鞋子 num13_shoe = {13,\"Size 13 shoes\"},--13号鞋子 num20_shoe = {20,\"Size 20 shoes\"},--20号鞋子 num21_shoe = {21,\"Size 21 shoes\"},--21号鞋子 num22_shoe = {22,\"Size 22 shoes\"},--22号鞋子 num23_shoe = {23,\"Size 23 shoes\"},--23号鞋子 } local myShoeStoreLen ={ __len = function (table) --通过此处的计算直接把20号以上的鞋子都给统计出来 local len = 0 for k,v in pairs(table) do if( 20 \u003c= v[1]) then len= len+ 1 end end return len; end } setmetatable(myShoeStore, myShoeStoreLen); print(#myShoeStore)--这个地方得到__len元方法统计的数据量大小 从上面结果我们可以看出,完美的得到了想要的数据\n源码讲解 上面是当你是用#去求大小的时候,会更加你#后面跟的数据类型来判断怎么求大小\n如果是#table,那么就看一下是否设置了元方法,如果设置了走luaT_callTMres函数调用元方法求大小,否则通过luaH_getn函数求大小 如果是#短字符串,直接通过tsvalue(rb)-\u003eshrlen返回大小 如果是#长字符串,直接通过tsvalue(rb)-\u003eu.lnglen返回大小 如果是#其他,那么就判断是否设置了元表如果设置了就通过luaT_callTMres函数调用元方法求大小,否则报错,这个其他比如是userdata等等 已经说道了这里那么就好好说下#table的时候通过luaH_getn函数求大小\n可以看到上面的内容还是挺蛋疼的,又是二分,又是边界什么什么的,不着急,我们慢慢嚼碎它\n首先我们知道lua的table是分为数组和hash部分的\n所以为了求出合适的大小lua会按如下规则来求大小,或者更简单点来说,lua用#求大小就是求table的边界\n那么怎么求边界呢,边界又是针对什么的呢\n边界是针对table的数组部分的,但若哈希部分的key为整数且刚好连着数组部分,则也会一并参与计算\n若某个整数下标n,满足table[boundary]不为空,而table[boundary+1]为空,则n为table的边界\ntable[boundary] != nil table[boundary+1] == nil\n为了提高遍历查找边界的效率,lua源码并没有进行遍历查找,而是通过二分查找\n如果table数组部分的最后一个元素为nil,那么将在数组部分进行二分查找\n针对table的数组部分的,但若哈希部分的key为整数且刚好连着数组部分,则也会一并参与计算\n最后一种情况是数组部分中没有元素 或如果table数组部分的最后一个元素为nil,那么将在hash部分进行二分查找\n用#求table长度的一些情况 全部为数组,没有hash部分 table的数组部分最后一个元素不是nil 例子1\nlocal myShoeStore = {12,13,14,15,16,17} print(#myShoeStore) 例子2\nlocal myShoeStore = {12,nil,nil,nil,nil,17} print(#myShoeStore) 例子3\nlocal myShoeStore = {nil,nil,nil,nil,nil,17} print(#myShoeStore) 因为table数组部分最后一位不是nil所以会跑到luaH_getn函数的这个地方,直接返回Table结构体里面的alimit字段大小 table的数组部分最后一个元素是nil,数组部分倒数第二个不是nil 例子1\nlocal myShoeStore = {12,13,14,15,16,nil} print(#myShoeStore) 例子2\nlocal myShoeStore = {12,nil,nil,nil,16,nil} print(#myShoeStore) 例子3\nlocal myShoeStore = {nil,nil,nil,nil,16,nil} print(#myShoeStore) 因为数组部分最后一个元素为nil,数组部分倒数第二个不是nil,那么就直接返回Table结构体里面的alimit字段大小减1 table的数组部分最后一个元素是nil,数组部分倒数第二个也是nil 关键源码部分\n例子1\nlocal myShoeStore = {12,13,14,15,nil,nil} print(#myShoeStore) 简单说下例子1进入二分查找的运算过程\n第一轮 i = 0；j = 6；判断j - i \u003e 1；进入white循环 第二轮 i = 0；j = 6；m = (i + j) / 2 = 3；判断array[m - 1]是不是空,不为空; i=m=3；判断j - i \u003e 1；进入white循环 第三轮 i = 3；j = 6；m = (i + j) / 2 = 4；判断array[m - 1]是不是空,不为空; i=m=4；判断j - i \u003e 1；进入white循环 第四轮 i = 4；j = 6；m = (i + j) / 2 = 5；判断array[m - 1]是不是空,为空; j=m=5；判断j - i 不大于1；退出循环,并返回i值 例子2\nlocal myShoeStore = {12,13,nil,nil,nil,nil} print(#myShoeStore) 例子3\nlocal myShoeStore = {12,13,nil,nil,nil,nil} print(#myShoeStore) 因为数组部分最后一个元素为nil,数组部分倒数第二个也是nil所以直接调用binsearch函数在数组部分进行二分查找得到table大小 ​\t通过上面两个极端的例子,所以我们看到table只看数组部分最后两位的情况来决定什么样的逻辑处理\n1. 如果数组部分最后一位不是`nil`,那么就直接返回`Table`结构体里面的`alimit`字段大小 1. 如果最后一个元素是`nil`,数组部分倒数第二个不是`nil`,那么就直接返回`Table`结构体里面的`alimit`字段大小减`1` 1. 如果数组部分最后一个元素为`nil`,数组部分倒数第二个也是`nil`所以直接调用`binsearch`函数在数组部分进行二分查找,得到`table`大小 全部为hash,没有数组 local myShoeStore = { [1] = \"Size 12 shoes\",--12号鞋子 [3] = \"Size 20 shoes\",--20号鞋子 [4] = \"Size 21 shoes\",--21号鞋子 [5] = \"Size 22 shoes\",--22号鞋子 [6] = \"Size 23 shoes\",--23号鞋子 } print(#myShoeStore) 关键源码部分\nt没有数组元素,调用 hash_search 函数,hash部分从 j = 1 开始遍历, i记录的是上一个 j的值 第一轮 i = 1; j = 2; t[2] 为nil 然后j - i 不大于1 所以直接返回i也就是大小1 在举个触发二分查找的例子\nlocal myShoeStore = { [1] = \"Size 12 shoes\",--12号鞋子 [2] = \"Size 13 shoes\",--13号鞋子 [3] = \"Size 20 shoes\",--20号鞋子 [4] = \"Size 21 shoes\",--21号鞋子 [6] = \"Size 23 shoes\",--23号鞋子 } print(#myShoeStore) t没有数组元素,调用 hash_search 函数,hash部分从 j = 1 开始遍历, i记录的是上一个 j的值 第一轮 i = 1; j = 2; t[2]不为nil；继续下一轮white循环 第二轮 i = 2; j = 4; t[4]不为nil；继续下一轮white循环 第三轮 i = 4; j = 8; t[8]为nil并且j - i \u003e 1； 进入二分查找阶段 第四轮 i = 4; j = 8; m = (i + j) / 2 = 6; t[m]不为空设置i = 6；判断j - i \u003e 1;继续下一轮二分查找 第五轮 i = 6; j = 8；m = (i + j) / 2 = 7; t[m]为空设置j = 7; 判断j - i 不大于1 结束二分查找返回i的值为6 有hash有数组的情况 有数组部分并且和hash部分下标连贯的 local myShoeStore = { \"Size 12 shoes\",--12号鞋子 \"Size 13 shoes\",--13号鞋子 [3] = \"Size 20 shoes\",--20号鞋子 [4] = \"Size 21 shoes\",--21号鞋子 [5] = \"Size 23 shoes\",--23号鞋子 } print(#myShoeStore) 我们可以看到大小就是数组部分的大小2加上hash部分的大小3总共为5\n模拟一下过程因为数组部分大小是2,所以j等于2\n第一轮 i = 2; j = 4; t[4]不为nil；继续下一轮white循环 第二轮 i = 4; j = 8; t[8]为nil；跳出white循环;判断j - i 是否大于1;发现大于;进入二分查找 第三轮 i = 4; j = 8; m = (i + j) / 2 = 6；t[m]为nil；j=m=6；判断j - i 是否大于1 发现大于,继续下一轮二分查找 第四轮 i = 4; j = 6；m = (i + j) / 2 = 5; t[m]不为nil i=m=5; 判断j - i 是否大于1 发现是等于1不符合条件,跳出循环,返回i,也就是5 有数组部分并且和hash部分下标不连贯的 local myShoeStore = { \"Size 12 shoes\",--12号鞋子 \"Size 13 shoes\",--13号鞋子 [4] = \"Size 21 shoes\",--21号鞋子 [5] = \"Size 23 shoes\",--23号鞋子 } print(#myShoeStore) 可以看到上面因为不连贯直接值返回了数组的长度,并没有加上hash的长度,主要原因还是源码的这个地方调用luaH_getint函数返回了absentkey\n#table求大小总结 所以从上面的各种分析能看出来,一般的情况下,如果这个表结构并不是按数字1~N顺序递增的，那么#table取出来的大小可能会是一些奇怪的值,所以建议用如下API接口来求大小\nfunction table.length(t) local i = 0 for k, v in pairs(t) do i = i + 1 end return i end 运算符重载 我们可以看到一共有18中符号能够参与运算符重载\nC枚举 元方法名字 解释 TM_EQ __eq 对应运算符\"==“比较两个对象是否相等 TM_ADD __add 对应运算符”+\"（加法）操作 TM_SUB __sub 对应的运算符 ‘-’（减法）操作 TM_MUL __mul 对应运算符\"*\"（乘法）操作 TM_MOD __mod 对应运算符\"%\"（取模）操作 TM_POW __pow 对应运算符\"^\"（次方）操作 TM_DIV __div 对应运算符\"/\"（除法）操作 TM_IDIV __idiv 对应运算符\"//\"（向下取整除法）操作 TM_BAND __band 对应运算符\"\u0026\"（按位与）操作 TM_BOR __bor 对应运算符\"|\"（按位或）操作 TM_BXOR __bxor 对应运算符\"^\"（按位异或）操作 TM_SHL __shl 对应运算符\"«\"（左移）操作 TM_SHR __shr 对应运算符\"»\"（右移）操作 TM_UNM __unm 对应的运算符 ‘-’（取负）操作 TM_BNOT __bnot 对应运算符\"~\"（按位非）操作 TM_LT __lt 对应的运算符 ‘\u003c’（小于）操作 TM_LE __le 对应的运算符 ‘\u003c=’（小于等于）操作 TM_CONCAT __concat 对应的运算符 ‘..’(连接）操作 终于到了月底盘点的日子了,为了能更好的管理店面进行盘点,需要对很多数据进行加加减减,取模,等等,这个时候就可以用上我们的lua的18个元方法,进行运算符重载\n__eq 作用:比较两个对象是否相等\n下面例子比较一下主店和分店各自销售记录量是不是一样\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--鞋子类型,销售额,数量 {\"Size 13 shoes\",50,80},--鞋子类型,销售额,数量 {\"Size 14 shoes\",80,80},--鞋子类型,销售额,数量 } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--鞋子类型,销售额,数量 {\"Size 21 shoes\",50,80},--鞋子类型,销售额,数量 } --盘点操作用来做Metatable inventoryOpe = {} --定义相等操作来比较一下主店和分店各自销售量是不是一样 inventoryOpe.__eq = function(table1, table2) return #table1 == #table2 end setmetatable(myShoeStore, inventoryOpe) --比较一下主店和分店各自销售量是不是一样 local isSame = myShoeStore == myBranchShoeStore print(isSame) 我们可以看到返回了false说明两家店销售记录量不一样\n__mul 作用:做乘法操作\n统计下主店和分店一共挣了多少钱\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--鞋子类型,销售额,数量 {\"Size 13 shoes\",50,80},--鞋子类型,销售额,数量 {\"Size 14 shoes\",80,80},--鞋子类型,销售额,数量 } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--鞋子类型,销售额,数量 {\"Size 21 shoes\",50,80},--鞋子类型,销售额,数量 } --盘点操作用来做Metatable inventoryOpe = {} --定义乘法操作来统计下主店和分店一共挣了多少钱 inventoryOpe.__mul = function(table1, table2) local money = 0 for _,v in pairs(table1) do money = money + (v[2] * v[3]) end for _,v in pairs(table2) do money = money + (v[2] * v[3]) end return money end setmetatable(myShoeStore, inventoryOpe) --统计下主店和分店一共挣了多少钱 local money = myShoeStore * myBranchShoeStore print(money) 可以看到总的money算出来了一共17400元\n__add 作用:用来进行加法操作\n举个栗子比如下面用来统计主店和分店总的销售物品信息\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--鞋子类型,销售额,数量 {\"Size 13 shoes\",50,80},--鞋子类型,销售额,数量 {\"Size 14 shoes\",80,80},--鞋子类型,销售额,数量 } local myBranchShoeStore = { {\"Size 20 shoes\",50,40},--鞋子类型,销售额,数量 {\"Size 21 shoes\",50,80},--鞋子类型,销售额,数量 } --盘点操作用来做Metatable inventoryOpe = {} --定义加法操作用来统计主店和分店的销售数据 inventoryOpe.__add = function(table1, table2) for _, value in pairs(table2) do table.insert(table1, value) end return table1 end setmetatable(myShoeStore, inventoryOpe) --统计主店和分店总的销售数据 local totalShoeInfo = myShoeStore + myBranchShoeStore --输出一下结果 for k,v in pairs(totalShoeInfo) do local item = \"\" for i=1,3 do if i ~= 3 then item = item .. v[i] .. \",\" else item = item .. v[i] end end print(\"{\" .. item .. \"}\") end 从结果上看,我们已经完美的把两家店的数据都统计合在一块了\n其他的运算符重载就不在举例了,和上面列出来的3个例子非常雷同\n__call 作用:当table名字做为函数名字的形式被调用的时候,会调用__call函数\n查看下主店每日完成金额量差距\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--鞋子类型,销售额,数量 {\"Size 13 shoes\",50,80},--鞋子类型,销售额,数量 {\"Size 14 shoes\",80,80},--鞋子类型,销售额,数量 } --盘点操作用来做Metatable inventoryOpe = {} --定义函数调用操作来查看下每日完成金额量差距 inventoryOpe.__call = function(self,target) local num14 = 0 for _,v in pairs(self) do num14 = num14 + (v[2] * v[3]) end return target - num14 end setmetatable(myShoeStore, inventoryOpe) --查看下主店每日完成金额量差距 print(myShoeStore(10000))--假设需要每日完成10000金额的销售量 我们可以看到每日目标金额已经超额完成,并且超了1400块\n__close 例子 作用:被标记为to-be-closed的局部变量会在超出它的作用域时,调用它的__closed元方法\nclose变量To-be-closed Variables需要和close元方法结合使用，在变量超出作用域时，会调用变量的close元方法__close,close变量一般用于需要及时释放的资源的情况,多用这个其实也能减轻gc的负担\n当店铺晚上关门的时候能自动把店铺的灯关闭\nlocal myShoeStore = { {\"Size 12 shoes\",50,20},--鞋子类型,销售额,数量 {\"Size 13 shoes\",50,80},--鞋子类型,销售额,数量 {\"Size 14 shoes\",80,80},--鞋子类型,销售额,数量 light = true, --灯开着 } --盘点操作用来做Metatable inventoryOpe = {} --定义__close操作当店铺晚上关门的时候能自动把店铺的灯关闭 inventoryOpe.__close = function(self) self.light = false end setmetatable(myShoeStore, inventoryOpe) --当主店铺晚上关门的时候能自动把店铺的灯关闭 do local closeStore \u003cclose\u003e = myShoeStore end print(myShoeStore.light) 源码分析 我们可以看到有两个核心函数一个是callclosemethod和checkclosemth\ncallclosemethod 主要就是用来调用设置的元方法 checkclosemth 这个主要是用来检测是否设置好了元方法,如果没有设置的话就会报错 更详细的注释请去我的GitHub地址 以下是我几乎每行都加了注释的GitHub地址\nltm.c注释地址\nltm.c注释\nltm.h注释地址\nltm.h注释\n",
  "wordCount" : "15296",
  "inLanguage": "en",
  "image":"https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png","datePublished": "2023-03-07T01:30:29+08:00",
  "dateModified": "2023-03-07T01:30:29+08:00",
  "author":[{
    "@type": "Person",
    "name": "frog"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frog-game.github.io/posts/read/lua5.4.4.metatable/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "frog's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frog-game.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://frog-game.github.io/" accesskey="h" title="frog&#39;s Blog (Alt + H)">
            <img src="https://frog-game.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">frog&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://frog-game.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/archives/" title="⏱ 时间轴">
                <span>⏱ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://frog-game.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://frog-game.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://frog-game.github.io/posts/read/">📕 阅读</a></div>
            <h1 class="post-title">
                [Lua5.4.4源码].元表
            </h1>
            <div class="post-description">
                lua源码元表分析
            </div>
            <div class="post-meta">创建:&nbsp;<span title='2023-03-07 01:30:29 +0800 CST'>2023-03-07</span>&nbsp;|&nbsp;更新:&nbsp;2023-03-07&nbsp;|&nbsp;字数:&nbsp;15296字&nbsp;|&nbsp;时长:&nbsp;31分钟&nbsp;|&nbsp;
作者:&nbsp;frog



                &nbsp;|&nbsp;标签: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://frog-game.github.io/tags/lua5.4.4%E6%BA%90%E7%A0%81/">Lua5.4.4源码</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://frog-game.github.io/posts/read/lua5.4.4.metatable/image-20230305135151916.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                <li>
                    <a href="#lua%e5%b1%82setmetatable%e5%92%8cgetmetatable%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="lua层setmetatable和getmetatable使用方法">lua层setmetatable和getmetatable使用方法</a></li>
                <li>
                    <a href="#c%e5%b1%82%e8%b0%83%e7%94%a8%e5%85%83%e8%a1%a8" aria-label="C层调用元表">C层调用元表</a></li>
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e5%85%83%e6%96%b9%e6%b3%95" aria-label="设置元方法">设置元方法</a><ul>
                        
                <li>
                    <a href="#__index" aria-label="__index">__index</a><ul>
                        
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e4%b8%8d%e6%98%aftable%e6%88%96%e8%80%85%e5%87%bd%e6%95%b0%e6%97%b6%e5%80%99" aria-label="__index元方法设置的不是table,或者函数时候"><code>__index</code>元方法设置的不是table,或者函数时候</a></li>
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%aftable" aria-label="__index元方法设置的是table"><code>__index</code>元方法设置的是table</a></li>
                <li>
                    <a href="#__index%e5%85%83%e6%96%b9%e6%b3%95%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__index元方法设置的是函数"><code>__index</code>元方法设置的是函数</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%9c%89%e4%ba%9b%e5%9c%b0%e6%96%b9__index%e5%85%83%e6%96%b9%e6%b3%95%e8%a6%81%e6%8c%87%e5%90%91%e8%87%aa%e5%b7%b1" aria-label="为什么有些地方__index元方法要指向自己">为什么有些地方<code>__index</code>元方法要指向自己</a></li>
                <li>
                    <a href="#__index%e5%ae%9e%e7%8e%b0%e7%9a%84%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1" aria-label="__index实现的面向对象">__index实现的面向对象</a></li></ul>
                </li>
                <li>
                    <a href="#__newindex" aria-label="__newindex">__newindex</a><ul>
                        
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e4%b8%8d%e6%98%aftable%e4%b9%9f%e4%b8%8d%e6%98%af%e5%87%bd%e6%95%b0%e7%9a%84%e6%97%b6%e5%80%99" aria-label="__newindex设置的不是table也不是函数的时候">__newindex设置的不是table也不是函数的时候</a></li>
                <li>
                    <a href="#_%e5%85%83%e8%a1%a8%e6%b2%a1%e6%9c%89_%e8%ae%be%e7%bd%aenewindex%e7%9a%84%e6%97%b6%e5%80%99" aria-label="_元表没有_设置newindex的时候">_元表没有_设置newindex的时候</a></li>
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%aftable" aria-label="__newindex设置的是table">__newindex设置的是table</a></li>
                <li>
                    <a href="#__newindex%e8%ae%be%e7%bd%ae%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__newindex设置的是函数">__newindex设置的是函数</a></li></ul>
                </li>
                <li>
                    <a href="#__gc" aria-label="__gc">__gc</a><ul>
                        
                <li>
                    <a href="#__gc%e6%8c%87%e5%90%91%e7%9a%84%e4%b8%8d%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__gc指向的不是函数">__gc指向的不是函数</a></li>
                <li>
                    <a href="#__gc%e6%8c%87%e5%90%91%e7%9a%84%e6%98%af%e5%87%bd%e6%95%b0" aria-label="__gc指向的是函数">__gc指向的是函数</a></li></ul>
                </li>
                <li>
                    <a href="#__mode" aria-label="__mode">__mode</a><ul>
                        
                <li>
                    <a href="#%e5%85%a5%e5%8f%a3%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90" aria-label="入口源码剖析">入口源码剖析</a></li>
                <li>
                    <a href="#%e5%bc%b1%e8%a1%a8%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90" aria-label="弱表原理剖析">弱表原理剖析</a></li></ul>
                </li>
                <li>
                    <a href="#__len" aria-label="__len">__len</a><ul>
                        
                <li>
                    <a href="#%e4%be%8b%e5%ad%90" aria-label="例子">例子</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3" aria-label="源码讲解">源码讲解</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%b1%82table%e9%95%bf%e5%ba%a6%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%85%e5%86%b5" aria-label="用#求table长度的一些情况">用#求table长度的一些情况</a><ul>
                        
                <li>
                    <a href="#%e5%85%a8%e9%83%a8%e4%b8%ba%e6%95%b0%e7%bb%84%e6%b2%a1%e6%9c%89hash%e9%83%a8%e5%88%86" aria-label="全部为数组,没有hash部分">全部为数组,没有<code>hash</code>部分</a><ul>
                        
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e4%b8%8d%e6%98%afnil" aria-label="table的数组部分最后一个元素不是nil">table的数组部分最后一个元素不是nil</a></li>
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e6%98%afnil%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%80%92%e6%95%b0%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%b8%8d%e6%98%afnil" aria-label="table的数组部分最后一个元素是nil,数组部分倒数第二个不是nil">table的数组部分最后一个元素是nil,数组部分倒数第二个不是nil</a></li>
                <li>
                    <a href="#table%e7%9a%84%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%85%83%e7%b4%a0%e6%98%afnil%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%80%92%e6%95%b0%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%b9%9f%e6%98%afnil" aria-label="table的数组部分最后一个元素是nil,数组部分倒数第二个也是nil">table的数组部分最后一个元素是nil,数组部分倒数第二个也是nil</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%a8%e9%83%a8%e4%b8%bahash%e6%b2%a1%e6%9c%89%e6%95%b0%e7%bb%84" aria-label="全部为hash,没有数组">全部为<code>hash</code>,没有数组</a></li>
                <li>
                    <a href="#%e6%9c%89hash%e6%9c%89%e6%95%b0%e7%bb%84%e7%9a%84%e6%83%85%e5%86%b5" aria-label="有hash有数组的情况">有hash有数组的情况</a><ul>
                        
                <li>
                    <a href="#%e6%9c%89%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%b9%b6%e4%b8%94%e5%92%8chash%e9%83%a8%e5%88%86%e4%b8%8b%e6%a0%87%e8%bf%9e%e8%b4%af%e7%9a%84" aria-label="有数组部分并且和hash部分下标连贯的">有数组部分并且和hash部分下标连贯的</a></li>
                <li>
                    <a href="#%e6%9c%89%e6%95%b0%e7%bb%84%e9%83%a8%e5%88%86%e5%b9%b6%e4%b8%94%e5%92%8chash%e9%83%a8%e5%88%86%e4%b8%8b%e6%a0%87%e4%b8%8d%e8%bf%9e%e8%b4%af%e7%9a%84" aria-label="有数组部分并且和hash部分下标不连贯的">有数组部分并且和hash部分下标不连贯的</a></li></ul>
                </li>
                <li>
                    <a href="#table%e6%b1%82%e5%a4%a7%e5%b0%8f%e6%80%bb%e7%bb%93" aria-label="#table求大小总结">#table求大小总结</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%90%e7%ae%97%e7%ac%a6%e9%87%8d%e8%bd%bd" aria-label="运算符重载">运算符重载</a><ul>
                        
                <li>
                    <a href="#__eq" aria-label="__eq">__eq</a></li>
                <li>
                    <a href="#__mul" aria-label="__mul">__mul</a></li>
                <li>
                    <a href="#__add" aria-label="__add">__add</a></li></ul>
                </li>
                <li>
                    <a href="#__call" aria-label="__call">__call</a></li>
                <li>
                    <a href="#__close" aria-label="__close">__close</a><ul>
                        
                <li>
                    <a href="#%e4%be%8b%e5%ad%90-1" aria-label="例子">例子</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="源码分析">源码分析</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%9b%b4%e8%af%a6%e7%bb%86%e7%9a%84%e6%b3%a8%e9%87%8a%e8%af%b7%e5%8e%bb%e6%88%91%e7%9a%84github%e5%9c%b0%e5%9d%80" aria-label="更详细的注释请去我的GitHub地址">更详细的注释请去我的GitHub地址</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="前言"><span>前言</span></h2>
<p><code>lua5.4.4</code>元表现在已经加到了<code>25</code>个类型</p>
<p>简单来说元方法的作用是因为使用<code>lua</code>原始语法不能做到所需的要求比如对两个<code>table</code>进行加减乘除,或者我在退出作用域的时候想要快速的清除自己自定义的一些数据,等等其他一些特殊需求</p>
<p>如果大家对<code>C++</code>的重载运算符比较熟悉,或许能够更加清晰的了解元表的作用,其实两者有异曲同工的作用</p>
<p><img loading="lazy" src="image-20230304172037144.png" alt="image-20230304172037144"  />
</p>
<p><img loading="lazy" src="image-20230304163913227.png" alt="image-20230304163913227"  />
</p>
<p><img loading="lazy" src="image-20230304163930013.png" alt="image-20230304163930013"  />
</p>
<p><img loading="lazy" src="image-20230304164027724.png" alt="image-20230304164027724"  />
</p>
<p>从上面的源代码我们可以分析出</p>
<ul>
<li><code>lua</code>中的每个值都可以拥有一个元表</li>
<li><code>table</code>和<code>userdata</code>各自拥有自己独立的元表</li>
<li>非<code>table</code>和<code>userdata</code>的元表统统放到了<code>global_State</code>的<code>mt</code>数组当中</li>
</ul>
<p><img loading="lazy" src="image-20230304172328493.png" alt="image-20230304172328493"  />
</p>
<p><img loading="lazy" src="image-20230304164703349.png" alt="image-20230304164703349"  />
</p>
<ul>
<li>从对外<code>lua</code>层的<code>API</code>接口来看,我们能看到在<code>lua</code>层只能按设置<code>table</code>的元表,而其他类型的元表设置并没有对外的<code>lua</code>层<code>API</code>接口,lua中提供的两个参数如下</li>
<li><strong>setmetatable(table,metatable)</strong></li>
<li><strong>getmetatable(table)</strong></li>
<li>其他类型设置元表只能通过c代码提供的<code>API</code>接口创建元表,比如<code>luaL_newmetatable</code></li>
</ul>
<h2 id="lua层setmetatable和getmetatable使用方法"><span>lua层setmetatable和getmetatable使用方法</span></h2>
<p>首先我们看一下<code>C</code>代码是怎么实现的</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#cdcd00">const</span> luaL_Reg base_funcs[] <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>  {<span style="color:#cd0000">&#34;getmetatable&#34;</span>, luaB_getmetatable},
</span></span><span style="display:flex;"><span>  {<span style="color:#cd0000">&#34;setmetatable&#34;</span>, luaB_setmetatable},
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">/// @brief 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// lua_getmetatable：如果该索引处的值有元表,则将其元表压栈,返回 1 。 否则不会将任何东西入栈,返回 0 。
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// luaL_getmetafield：将索引 obj 处对象的元表中 __metatable 域的值压栈。
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// 如果该对象没有元表,或是该元表没有相关域, 此函数什么也不会压栈并返回 LUA_TNIL。
</span></span></span><span style="display:flex;"><span><span style="color:#000080">/// @param L 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">/// @return 
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> luaB_getmetatable (lua_State <span style="color:#39c">*</span>L) {
</span></span><span style="display:flex;"><span>  luaL_checkany(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">if</span> (<span style="color:#39c">!</span>lua_getmetatable(L, <span style="color:#cd00cd">1</span>)) {
</span></span><span style="display:flex;"><span>    lua_pushnil(L);
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;  <span style="color:#000080">/* no metatable */</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  luaL_getmetafield(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;__metatable&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;  <span style="color:#000080">/* returns either __metatable field (if present) or metatable */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">// LUA_TNIL定义在lua.h中 是0
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// lua_setmetatable：把一张表弹出栈,并将其设为给定索引处的值的元表。
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// a = {}
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// setmetatable(a,{__metatable = &#34;hello&#34;})
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// setmetatable(a,{__metatable = &#34;world&#34;})
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// 这种情况就会报错
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// 也就是说 __metatable这个是保护元表,不可读写
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> luaB_setmetatable (lua_State <span style="color:#39c">*</span>L) {
</span></span><span style="display:flex;"><span>  <span style="color:#00cd00">int</span> t <span style="color:#39c">=</span> lua_type(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>  luaL_checktype(L, <span style="color:#cd00cd">1</span>, LUA_TTABLE);
</span></span><span style="display:flex;"><span>  luaL_argexpected(L, t <span style="color:#39c">==</span> LUA_TNIL <span style="color:#39c">||</span> t <span style="color:#39c">==</span> LUA_TTABLE, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;nil or table&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">if</span> (l_unlikely(luaL_getmetafield(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;__metatable&#34;</span>) <span style="color:#39c">!=</span> LUA_TNIL))
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> luaL_error(L, <span style="color:#cd0000">&#34;cannot change a protected metatable&#34;</span>);
</span></span><span style="display:flex;"><span>  lua_settop(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>  lua_setmetatable(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>从源码看出当我们在<code>lua</code>层第一次调用<code>getmetatable(table)</code>的时候如果<code>table</code>没有设置元表就会返回一个<code>nil</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> t <span style="color:#39c">=</span> getmetatable({})
</span></span><span style="display:flex;"><span>print(t)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304210228115.png" alt="image-20230304210228115"  />
</p>
</li>
<li>
<p>如果设置的是普通元表,那么就会直接返回普通元表</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> { 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> { }
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;m1 table addr:&#34;</span>, t2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;getmetatable addr:&#34;</span>, getmetatable(tt))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304213851676.png" alt="image-20230304213851676"  />
</p>
<p>从这个示例的<code>lua</code>代码中我们可以看出<code>t2 table</code>的地址是<code>0000018860667A90</code> 而 <code>getmetatable(tt)</code>的地址也是<code>0000018860667A90</code> 所以从这里我们可以看出其实这代码是<code>lua tt table</code>表里面的<code>c</code>结构体<code>Table</code>里面的<code>metatable</code>指针指向了<code>lua t2 table</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>typedef struct Table {
</span></span><span style="display:flex;"><span>  struct Table <span style="color:#39c">*</span>metatable;<span style="color:#39c">//</span><span style="">这个地方如果设置了元表就会通过这个指针指向设置的元表</span>
</span></span><span style="display:flex;"><span>} Table;
</span></span></code></pre></div><p>示意图如下</p>
<p><img loading="lazy" src="image-20230304214800149.png" alt="image-20230304214800149"  />
</p>
</li>
<li>
<p>如果设置了<code>__metatable</code>字段那么就会直接返回于这个字段相关的值</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> { 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span> [<span style="color:#cd0000">&#34;__metatable&#34;</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello world!!!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;getmetatable:&#34;</span>, getmetatable(tt))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304215106783.png" alt="image-20230304215106783"  />
</p>
<p>从上我们可以看出如果<code>t2</code>表里面的<code>__metatable</code>的字段设置内容那么就会直接输出__<code>metatable</code>的字段内容</p>
<p>示意图如下</p>
<p><img loading="lazy" src="image-20230304215439196.png" alt="image-20230304215439196"  />
</p>
</li>
<li>
<p>当然除了这个我们还要注意的是<code>__metatable</code>字段是有保护机制的不可重写</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>a <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>setmetatable(a,{__metatable <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello&#34;</span>})
</span></span><span style="display:flex;"><span>setmetatable(a,{__metatable <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;world&#34;</span>})
</span></span></code></pre></div><p>执行结果</p>
<p><img loading="lazy" src="image-20230304221727712.png" alt="image-20230304221727712"  />
</p>
<p>可以看到此处报错了输出了<code>cannot change a protected metatable</code>错误提示</p>
</li>
<li>
<p>还有一点是元表其实是可以共享的比如下面的例子</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt <span style="color:#39c">=</span> {    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> tt2 <span style="color:#39c">=</span> {    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> t2 <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span> [<span style="color:#cd0000">&#34;__metatable&#34;</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(tt, t2)
</span></span><span style="display:flex;"><span>setmetatable(tt2, t2)
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;get tt metatable :&#34;</span>, getmetatable(tt))
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;get tt2 metatable :&#34;</span>, getmetatable(tt2))
</span></span></code></pre></div><p><img loading="lazy" src="image-20230304222254722.png" alt="image-20230304222254722"  />
</p>
<p>可以看到<code>tt和tt2</code>指向的是同一个元表t2,然后同时输出了相同的内容<code>hello world</code></p>
<p>大概示意图如下</p>
<p><img loading="lazy" src="image-20230304222520657.png" alt="image-20230304222520657"  />
</p>
</li>
</ul>
<h2 id="c层调用元表"><span>C层调用元表</span></h2>
<p>其实在之前解释<code>lua</code>源码类型中的<code>full userdata</code>的时候其实就描述过了<code>C</code>是怎么使用<code>luaL_newmetatable</code> <code>luaL_getmetatable</code> <code>lua_setmetatable</code> 来是<code>full userdata</code>起作用的</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">//c文件 
</span></span></span><span style="display:flex;"><span><span style="color:#000080">//#include &lt;string.h&gt;  
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lua.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lauxlib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lualib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;iostream&gt;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#cdcd00">struct</span> StudentTag
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">char</span><span style="color:#39c">*</span> strName; <span style="color:#000080">// 学生姓名
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> CFunStudent(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">size_t</span> iBytes <span style="color:#39c">=</span> <span style="color:#cdcd00">sizeof</span>(<span style="color:#cdcd00">struct</span> StudentTag);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent;
</span></span><span style="display:flex;"><span>	pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)lua_newuserdata(L, iBytes);
</span></span><span style="display:flex;"><span>	<span style="color:#000080">//设置元表
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_getmetatable(L, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_setmetatable(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetName(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_pushstring(L, pStudent<span style="color:#39c">-&gt;</span>strName);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetName(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// 第一个参数是userdata
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span> pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag<span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// 第二个参数是一个字符串
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">const</span> <span style="color:#00cd00">char</span><span style="color:#39c">*</span> pName <span style="color:#39c">=</span> luaL_checkstring(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	luaL_argcheck(L, pName <span style="color:#39c">!=</span> <span style="color:#cd00cd">NULL</span> <span style="color:#39c">&amp;&amp;</span> pName <span style="color:#39c">!=</span> <span style="color:#cd0000">&#34;&#34;</span>, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;Wrong Parameter&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pStudent<span style="color:#39c">-&gt;</span>strName <span style="color:#39c">=</span> (<span style="color:#00cd00">char</span><span style="color:#39c">*</span>)pName;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span>  luaL_Reg arrayFunc_meta[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getName&#34;</span>, GetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setName&#34;</span>, SetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> luaL_Reg arrayFunc[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;new&#34;</span>, Student},
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span>  _declspec(dllexport) <span style="color:#00cd00">int</span> luaopen_mytestlib(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#000080">// 创建一个新的元表
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_newmetatable(L, <span style="color:#cd0000">&#34;StudentMetatable&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// 元表.__index = 元表
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setfield(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;__index&#34;</span>);
</span></span><span style="display:flex;"><span>	luaL_setfuncs(L, arrayFunc_meta, <span style="color:#cd00cd">0</span>);
</span></span><span style="display:flex;"><span>	luaL_newlib(L, arrayFunc);
</span></span><span style="display:flex;"><span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setglobal(L, <span style="color:#cd0000">&#34;StudentModule&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">-- lua 文件</span>
</span></span><span style="display:flex;"><span>require <span style="color:#cd0000">&#34;mytestlib&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> objStudent <span style="color:#39c">=</span> StudentModule.new()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objStudent:setName(<span style="color:#cd0000">&#34;11111&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> strName <span style="color:#39c">=</span> objStudent:getName()
</span></span><span style="display:flex;"><span>print(strName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(getmetatable(objStudent)) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(tostring(k),tostring(v))
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>大概流程图如下</p>
<p><img loading="lazy" src="image-20230305135151916.png" alt="image-20230305135151916"  />
</p>
<ul>
<li>首先在<code>ENV</code>里面注册了模块<code>studentModule</code>,等价于_<code>ENV[&quot;studentModule&quot;] = table</code></li>
<li>然后这个<code>table</code>里面存有<code>lua</code>的接口<code>new</code>和指向<code>c</code>层函数指针的<code>CFunstudent</code></li>
<li>通过函数指针的<code>CFunstudent</code>指向的<code>CFunstudent</code>函数我们创建了一块内存区域</li>
<li>因为<code>userdata</code>也和<code>table</code>结构一样都能设置元表,也就是说可以通过元表,能给<code>lua</code>层提供接口来操作这块<code>userdata</code></li>
<li>所以后面这部分就是创建元表,并通过元表内部的<code>setName</code>和<code>getName</code>函数对<code>userdata</code>进行了操作,有点像我们不能很方便去直接控制电视机的电路板[<code>userdata</code>],所以发明了遥控器[<code>元表</code>],方便用户[<code>lua层</code>]通过遥控器控制电视机换台什么的操作</li>
</ul>
<h2 id="设置元方法"><span>设置元方法</span></h2>
<table>
<thead>
<tr>
<th>C枚举</th>
<th>元方法名字</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>TM_INDEX</td>
<td>__index</td>
<td>索引table[key] 访问表中不存在的值</td>
</tr>
<tr>
<td>TM_NEWINDEX</td>
<td>__newindex</td>
<td>索引赋值 table[key] = value 对表中不存在的值进行赋值</td>
</tr>
<tr>
<td>TM_GC</td>
<td>__gc</td>
<td>当对象被gc回收时将会调用gc元方法</td>
</tr>
<tr>
<td>TM_MODE</td>
<td>__mode</td>
<td>弱引用表</td>
</tr>
<tr>
<td>TM_LEN</td>
<td>__len</td>
<td>对应运算符&quot;#&quot; 取对象长度</td>
</tr>
<tr>
<td>TM_EQ</td>
<td>__eq</td>
<td>对应运算符&quot;==&ldquo;比较两个对象是否相等</td>
</tr>
<tr>
<td>TM_ADD</td>
<td>__add</td>
<td>对应运算符&rdquo;+&quot;（加法）操作</td>
</tr>
<tr>
<td>TM_SUB</td>
<td>__sub</td>
<td>对应的运算符 &lsquo;-&rsquo;（减法）操作</td>
</tr>
<tr>
<td>TM_MUL</td>
<td>__mul</td>
<td>对应运算符&quot;*&quot;（乘法）操作</td>
</tr>
<tr>
<td>TM_MOD</td>
<td>__mod</td>
<td>对应运算符&quot;%&quot;（取模）操作</td>
</tr>
<tr>
<td>TM_POW</td>
<td>__pow</td>
<td>对应运算符&quot;^&quot;（次方）操作</td>
</tr>
<tr>
<td>TM_DIV</td>
<td>__div</td>
<td>对应运算符&quot;/&quot;（除法）操作</td>
</tr>
<tr>
<td>TM_IDIV</td>
<td>__idiv</td>
<td>对应运算符&quot;//&quot;（向下取整除法）操作</td>
</tr>
<tr>
<td>TM_BAND</td>
<td>__band</td>
<td>对应运算符&quot;&amp;&quot;（按位与）操作</td>
</tr>
<tr>
<td>TM_BOR</td>
<td>__bor</td>
<td>对应运算符&quot;|&quot;（按位或）操作</td>
</tr>
<tr>
<td>TM_BXOR</td>
<td>__bxor</td>
<td>对应运算符&quot;^&quot;（按位异或）操作</td>
</tr>
<tr>
<td>TM_SHL</td>
<td>__shl</td>
<td>对应运算符&quot;&laquo;&quot;（左移）操作</td>
</tr>
<tr>
<td>TM_SHR</td>
<td>__shr</td>
<td>对应运算符&quot;&raquo;&quot;（右移）操作</td>
</tr>
<tr>
<td>TM_UNM</td>
<td>__unm</td>
<td>对应的运算符 &lsquo;-&rsquo;（取负）操作</td>
</tr>
<tr>
<td>TM_BNOT</td>
<td>__bnot</td>
<td>对应运算符&quot;~&quot;（按位非）操作</td>
</tr>
<tr>
<td>TM_LT</td>
<td>__lt</td>
<td>对应的运算符 &lsquo;&lt;&rsquo;（小于）操作</td>
</tr>
<tr>
<td>TM_LE</td>
<td>__le</td>
<td>对应的运算符 &lsquo;&lt;=&rsquo;（小于等于）操作</td>
</tr>
<tr>
<td>TM_CONCAT</td>
<td>__concat</td>
<td>对应的运算符 &lsquo;..&rsquo;(连接）操作</td>
</tr>
<tr>
<td>TM_CALL</td>
<td>__call</td>
<td>函数调用操作 func(args)</td>
</tr>
<tr>
<td>TM_CLOSE</td>
<td>__close</td>
<td>被标记为to-be-closed的局部变量<br />会在超出它的作用域时,调用它的__closed元方法</td>
</tr>
</tbody>
</table>
<h3 id="__index"><span>__index</span></h3>
<p>举个现实中的例子,比如你现在去街上买鞋子,来到了鞋柜,你非常喜欢这双鞋子,但是这家店里面没有这双款式的鞋子了,一般来说店家都会说,不着急你等等,我去其他分店帮你调配一下鞋子,您是等等还是我邮寄给你过去呢</p>
<p>其实这快,当店家没有鞋子的时候,去其他分店调配和<code>lua</code>的<code>__index</code>很像</p>
<ol>
<li>首先我作为店家今天库存只有<code>12</code>号和<code>13</code>号款式的鞋子,<code>lua</code>伪代码如下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个时候来了个小红问问有没有<code>20</code>号款式的鞋子,说非常喜欢这样款式的,作为店主首先你查了下自己的库存</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306144628009.png" alt="image-20230306144628009"  />
</p>
<p>我们可以看到返回了nil,说明我现在的店铺已经没有20号鞋子的库存了,为了留住顾客,你只能去分店查找,毕竟一单生意一份收入,挣钱嘛不寒碜,那怎么样才能和分店挂钩起来,让我能方便的查找呢,相信聪明的你肯定想到了__index元方法,没错就是它</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> {<span style="color:#000080">--关键地方,靠的就是__index来进行关联查找</span>
</span></span><span style="display:flex;"><span>           num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306151356327.png" alt="image-20230306151356327"  />
</p>
<p>可以看到上图的输出,完美找到了<code>20</code>号的鞋子,留下了这笔生意,当然如果你分店更多,那么你可以一直用<code>__index</code>元方法串连下去,直到你找到你想要的数据</p>
<p><strong>总结:</strong><code>定义了在table中通过给定的key找到的value为nil时怎么办的行为</code></p>
<p>下面我们在进行一下关键源码点分析</p>
<p><img loading="lazy" src="image-20230305181819971.png" alt="image-20230305181819971"  />
</p>
<p>上面的源码就是设置<code>__index</code>元方法的核心逻辑地方</p>
<ul>
<li>首先第一步会判断<code>slot</code>是不是<code>null</code>,如果是那么就说明<code>t</code>变量不是<code>table</code>,就直接报错跳过</li>
<li>第二步如果<code>slot</code>不是<code>null</code>那说明<code>t</code>是一个<code>table</code>,这个时候我们通过<code>TM_INDEX</code>索引找到<code>table</code>对应的<code>metatable</code>元方法</li>
<li>得到了元方法指针以后,我们在判断一下如果指针是<code>null</code>那么就说明没有设置元方法,那么只要直接返回<code>nil</code>就可以了</li>
<li>走到了这一步了,那么说明我们找到了<code>TM_INDEX</code>对应的元方法了,注意哈,重点来了
<ul>
<li>如果元方法是个函数,那么就会调用<code>luaT_callTMres</code>把函数入栈,并且把结果求出来,当做查询结果</li>
<li>如果元方法是个<code>table</code>,那么就直接求元素下标为<code>key</code>的<code>table</code>内容,也就是<code>tm[key]</code>指向的内容</li>
<li>如果上面都不满足,既不是表,又不是函数,就直接返回<code>slot</code>为<code>null</code>,结果为<code>0</code></li>
</ul>
</li>
</ul>
<p><strong>综合总结</strong></p>
<p><code>lua代码从表t中查找键k时,lua处理流程如下:</code></p>
<ol>
<li>
<p><code>t</code>中是否有<code>k</code>,有则直接返回值,否则进行第二步</p>
</li>
<li>
<p><code>t</code>是否有元表, 无则返回<code>nil</code>, 有则进行第三步</p>
</li>
<li>
<p><code>t</code>的元表是否有<code>__index元方法</code>,没有直接返回<code>nil,</code> 有则查找<code>__index</code>指向的表或对应的函数,把表中或者函数的返回值当做结果</p>
</li>
</ol>
<p>到此为止我们通过源码知道了<code>__index</code>内幕到底做了啥,那为了正确性,我们写点<code>lua</code>源码验证一下</p>
<h4 id="__index元方法设置的不是table或者函数时候"><span><code>__index</code>元方法设置的不是table,或者函数时候</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	 __index <span style="color:#39c">=</span> <span style="color:#cd00cd">11111</span> <span style="color:#000080">-- 注意这个地方的写法</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306155606613.png" alt="image-20230306155606613"  />
</p>
<p>我们可以看到当没有把<code>__index</code>的元方法设置成<code>table</code>,或者函数的时候,可以看到输出是直接报错的</p>
<h4 id="__index元方法设置的是table"><span><code>__index</code>元方法设置的是table</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> {<span style="color:#000080">--关键地方,靠的就是__index来进行关联查找</span>
</span></span><span style="display:flex;"><span>           num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306151356327.png" alt="image-20230306151356327"  />
</p>
<h4 id="__index元方法设置的是函数"><span><code>__index</code>元方法设置的是函数</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>        __index <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table,key,key)
</span></span><span style="display:flex;"><span>            print(table)
</span></span><span style="display:flex;"><span>            print(key)
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myBranchShoeStore);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306162910669.png" alt="image-20230306162910669"  />
</p>
<p>从上面我们可以看出如果在<code>myShoeStore</code>中找不到<code>num20_shoe</code>,那么就会从他的元表<code>myBranchShoeStore</code>中去查找是不是有设置元方法<code>__index</code>,发现<code>__index</code>元方法设置的是个函数,还有能看到这个函数有两个形参,一个是<code>table</code>,一个是<code>key</code>正好对应的是<code>myShoeStore</code>和<code>num20_shoe</code>字段,最后还能看到返回值<code>&quot;Size 20 shoes&quot;</code>也作为了结果返回</p>
<h4 id="为什么有些地方__index元方法要指向自己"><span>为什么有些地方<code>__index</code>元方法要指向自己</span></h4>
<p>在讲解前请先熟悉这个流程</p>
<p><code>lua代码从表t中查找键k时,lua处理流程如下:</code></p>
<ol>
<li>
<p><code>t</code>中是否有<code>k</code>,有则直接返回值,否则进行第二步</p>
</li>
<li>
<p><code>t</code>是否有元表, 无则返回<code>nil</code>, 有则进行第三步</p>
</li>
<li>
<p><code>t</code>的元表是否有<code>__index元方法</code>,没有直接返回<code>nil,</code> 有则查找<code>__index</code>指向的表或对应的函数,把表中或者函数的返回值当做结果</p>
</li>
</ol>
<p><strong>a. 当我们使用__index元方法要指向自己的方法时候</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">---当我们使用__index元方法要指向自己的方法时候</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:new()
</span></span><span style="display:flex;"><span>    self.__index <span style="color:#39c">=</span> self
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> setmetatable( {}, self )
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:get_num20_shoe()
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--当我们第一次new class的时候,发现可以输出get_num20_shoe函数的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myshoestrore <span style="color:#39c">=</span> class:new()
</span></span><span style="display:flex;"><span>myshoestrore.get_num20_shoe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- 当我们在此调用通过myshoestroe new class的时候,发现还是能继续输出get_num20_shoe函数里面的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> myshoestrore:new()
</span></span><span style="display:flex;"><span>myBranchShoeStore.get_num20_shoe()
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306172552872.png" alt="image-20230306172552872"  />
</p>
<p><strong>b. 当我们不使用__index元方法要指向自己的方法时</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000080">---当我们不使用__index元方法要指向自己的方法时候</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>class.__index <span style="color:#39c">=</span> class
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:new()
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> setmetatable( {}, self )
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">class</span>:get_num20_shoe()
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--当我们第一次new class的时候,发现可以输出get_num20_shoe函数的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myshoestrore <span style="color:#39c">=</span> class:new()
</span></span><span style="display:flex;"><span>myshoestrore.get_num20_shoe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- 当我们在此调用通过myshoestroe new class的时候,发现就不能在继续输出get_num20_shoe函数里面的内容了,主要原因还是</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">-- myshoestrore里面是没有__index元方法的,导致继承链断了</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> myshoestrore:new()
</span></span><span style="display:flex;"><span>myBranchShoeStore.get_num20_shoe()
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306173033789.png" alt="image-20230306173033789"  />
</p>
<h4 id="__index实现的面向对象"><span>__index实现的面向对象</span></h4>
<p>这里贴一下云风大神写的一个<code>lua</code>面向对象实现的代码</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> _class <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#000080">-- super 为基类</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">function</span> class(super)
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> class_type <span style="color:#39c">=</span> {} <span style="color:#000080">--类模板</span>
</span></span><span style="display:flex;"><span>    class_type.ctor <span style="color:#39c">=</span> <span style="color:#cdcd00">false</span> <span style="color:#000080">-- 构造函数</span>
</span></span><span style="display:flex;"><span>    class_type.super <span style="color:#39c">=</span> super <span style="color:#000080">--赋值基类</span>
</span></span><span style="display:flex;"><span>    class_type.staticFun <span style="color:#39c">=</span> {} <span style="color:#000080">--静态函数</span>
</span></span><span style="display:flex;"><span>    class_type.new <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(...) <span style="color:#000080">-- new方法成员</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00cd00">local</span> obj <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00cd00">local</span> create  <span style="color:#000080">--嵌套调用主要是为了能掉到基类ctor</span>
</span></span><span style="display:flex;"><span>            create <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(c, ...)
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">if</span> c.super <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>                    create(c.super, ...) <span style="color:#000080">--调用基类ctor</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">if</span> c.ctor <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>                    c.ctor(obj, ...) <span style="color:#000080">--调用构造</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            create(class_type, ...)
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>        setmetatable(obj, {__index <span style="color:#39c">=</span> _class[class_type]}) <span style="color:#000080">--利用元表__index设置保证 obj继承自_class[class_type]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">return</span> obj
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> vtbl <span style="color:#39c">=</span> {} <span style="color:#000080">--vtbl理解为类容器也就是存类的成员,函数等等</span>
</span></span><span style="display:flex;"><span>    vtbl.super <span style="color:#39c">=</span> _class[super] 
</span></span><span style="display:flex;"><span>    _class[class_type] <span style="color:#39c">=</span> vtbl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    setmetatable( <span style="color:#000080">-- 有新的成员存到vtbl中</span>
</span></span><span style="display:flex;"><span>        class_type,
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(t, k, v)
</span></span><span style="display:flex;"><span>                vtbl[k] <span style="color:#39c">=</span> v
</span></span><span style="display:flex;"><span>            <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">if</span> super <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>        setmetatable( <span style="color:#000080">-- 如果子类有成员直接返回,子类没有返回基类的成员</span>
</span></span><span style="display:flex;"><span>            vtbl,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                __index <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(t, k)
</span></span><span style="display:flex;"><span>                    <span style="color:#00cd00">local</span> ret <span style="color:#39c">=</span> _class[super][k]
</span></span><span style="display:flex;"><span>                    vtbl[k] <span style="color:#39c">=</span> ret
</span></span><span style="display:flex;"><span>                    <span style="color:#cdcd00">return</span> ret
</span></span><span style="display:flex;"><span>                <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> class_type
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p>具体实现原理请仔细查看源码注释吧,这里就不详细解释了,相信聪明的你一定能看出名堂</p>
<p>如果想更复杂的<code>lua</code>实现<code>class</code>面向对象的代码方法,可以去这个地址喵喵,这个写的还是很不错的,里面有强弱表相关,不到<code>200</code>行代码就实现了,类,继承,虚函数,私有变量,<code>table</code>混合使用等等功能</p>
<p><a href="https://github.com/kikito/middleclass/blob/master/middleclass.lua">middleclass</a></p>
<h3 id="__newindex"><span>__newindex</span></h3>
<p>如果说<code>__index</code>字段是在访问表中不存在的值是执行的查找操作的话[<code>get</code>]</p>
<p>那么<code>__nexindex</code>字段则是在对表中不存在的值进行的赋值操作[<code>set</code>]</p>
<p>当然你也可以给你的<code>table</code>去一个的赋值创建变量比如像下面<code>lua</code>代码一样,为了能够留住顾客我费劲通过各种方法在我的店铺创建出来了一双<code>20</code>号的鞋子</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span> <span style="color:#000080">--费劲巴拉的在自己店铺弄出了一双20号款式的鞋子</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306174922398.png" alt="image-20230306174922398"  />
</p>
<p>虽然20号鞋子创建出来了,但是大家发现没有我是总店按道理来说总店不是工厂,而应该让工厂去履行这个职责,这样专人做转事,保值保量,又快又好,所以我们又对代码做了如下处理</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table, key, value) <span style="color:#000080">--关键地方,靠的就是__newindex来进行鞋子的创建</span>
</span></span><span style="display:flex;"><span>          rawset(table, key, value);
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- 有元表的情况下设置值,这样等价于我把本来要在主店创建20号鞋子的任务,丢给我的鞋子工厂去处理了</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306193334378.png" alt="image-20230306193334378"  />
</p>
<p>通过上面的处理等价于我把本来要在主店创建<code>20</code>号鞋子的任务,丢给我的鞋子工厂<code>myShoeFactory</code>去处理了</p>
<p>接下来我们来看看源码</p>
<p><img loading="lazy" src="image-20230306194200024.png" alt="image-20230306194200024"  />
</p>
<p>我们可以看到大概流程如下</p>
<ol>
<li>t中是否有元方法,没有的话直接设置值,否则进行第二步</li>
<li>元方法指向的函数,直接通过<code>luaT_callTM</code>函数接口进行设置,否则进行第三步</li>
<li>如果元方法指向是个<code>table</code>,那么就直接回去<code>table</code>对应的值,进行设置,否则进行第四步</li>
<li>如果元方法指向不是<code>table</code>也不是函数,那么就直接报错</li>
</ol>
<h4 id="__newindex设置的不是table也不是函数的时候"><span>__newindex设置的不是table也不是函数的时候</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cd00cd">11111</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- 设置的不是table也不是函数的时候</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306194930423.png" alt="image-20230306194930423"  />
</p>
<h4 id="_元表没有_设置newindex的时候"><span>_元表没有_设置newindex的时候</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- _元表没有_设置newindex的时候 </span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306195129247.png" alt="image-20230306195129247"  />
</p>
<p>可以看到直接赋值了,还是有想要的结果输出</p>
<h4 id="__newindex设置的是table"><span>__newindex设置的是table</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryItem <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> myShoeFactoryItem
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> print(<span style="color:#cd0000">&#34;set num20_shoe before myShoeFactoryItem.num20_shoe:&#34;</span>,myShoeFactoryItem.num20_shoe)
</span></span><span style="display:flex;"><span> myShoeStore.num20_shoe <span style="color:#39c">=</span>  <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span> print(<span style="color:#cd0000">&#34;set num20_shoe after myShoeFactoryItem.num20_shoe:&#34;</span>,myShoeFactoryItem.num20_shoe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306200454139.png" alt="image-20230306200454139"  />
</p>
<p>我们可以看到当修改<code>myShoeFactoryItem</code>中<code>num20_shoe</code>字段的之前他的值是<code>&quot;Size 21 shoes&quot;</code></p>
<p>当调用 <code>myShoeStore.num20_shoe =  &quot;Size 20 shoes&quot;</code>进行设置的时候</p>
<p><code>myShoeFactoryItem</code>中<code>num20_shoe</code>字段的之前他的值变成了<code>&quot;Size 20 shoes&quot;</code></p>
<p>而再次输出<code>myShoeStore.num20_shoe</code>的时候看到的值是<code>nil</code></p>
<p>所以我们可以看到这东西有点像我的工厂正在产<code>21</code>号的鞋子,但是我这个时候紧急需要<code>20</code>号鞋子,我就隔空通过主店对工厂发出了创建<code>20</code>号鞋子的命令,但是主店却不会去创建<code>20</code>号鞋子,这样非常<code>nice</code>有点隔空打牛,但是不影响主店的意思在里面</p>
<h4 id="__newindex设置的是函数"><span>__newindex设置的是函数</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myShoeFactory <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>      __newindex <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table, key, value) <span style="color:#000080">--关键地方,靠的就是__newindex来进行鞋子的创建</span>
</span></span><span style="display:flex;"><span>          rawset(table, key, value);<span style="color:#000080">--使用rawset来进行设置,因为不会去调用元方法对table进行设置,所以能得到更好的性能和避免元方法的无限递归调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> setmetatable(myShoeStore,myShoeFactory);<span style="color:#000080">--关键地方,这里等价于把两家店给串连起来了</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">--- 有元表的情况下设置值,这样等价于我把本来要在主店创建20号鞋子的任务,丢给我的鞋子工厂去处理了</span>
</span></span><span style="display:flex;"><span>  myShoeStore.num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.num20_shoe)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306193334378.png" alt="image-20230306193334378"  />
</p>
<p>这块地方废话就不多说了,可以自己对着注释捋一下就明白了,其实<code>__newindex</code>开场白的时候也进行了介绍</p>
<h3 id="__gc"><span>__gc</span></h3>
<p>主要用来当对象被销毁时,该元方法将以对象作为参数进行调用,并对一些自定义的资源释放,可以将此元方法认为是一种析构函数也行,这个元方法指向的内容必须的是个函数</p>
<p>先来喵喵源代码</p>
<p><img loading="lazy" src="image-20230306203628536.png" alt="image-20230306203628536"  />
</p>
<ul>
<li><code>1</code>号位置获取元方法</li>
<li><code>2</code>号位置调用你指向的函数,从调用的是<code>luaD_pcall</code>函数中可以看出,<code>__gc</code>元方法指向的必须是个函数</li>
</ul>
<h4 id="__gc指向的不是函数"><span>__gc指向的不是函数</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;myShoeStore addr:&#34;</span>,myShoeStore)<span style="color:#000080">--先打印下myShoeStore table地址</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryGC <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	__gc <span style="color:#39c">=</span><span style="color:#cd00cd">1111</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore,myShoeFactoryGC);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--设置成nil,下面调用collectgarbage才会被回收</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- 进行gc回收</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306205437394.png" alt="image-20230306205437394"  />
</p>
<p>可以看到什么都没有发生</p>
<h4 id="__gc指向的是函数"><span>__gc指向的是函数</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;myShoeStore addr:&#34;</span>,myShoeStore)<span style="color:#000080">--先打印下myShoeStore table地址</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeFactoryGC <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	__gc <span style="color:#39c">=</span><span style="color:#cdcd00">function</span>( table )
</span></span><span style="display:flex;"><span>		print(<span style="color:#cd0000">&#34;myShoeFactoryGC released table addr:&#34;</span>,table) <span style="color:#000080">-- myShoeStore table被回收了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore,myShoeFactoryGC);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--设置成nil,下面调用collectgarbage才会被回收</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- 进行gc回收</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306205237891.png" alt="image-20230306205237891"  />
</p>
<p>从上面我们能够看出当<code>myShoeStore table</code>被回收的时候,也会触发<code>__gc</code>的元方法,大白话来说就有点像我的主店倒闭了,那么和我关联的工厂也没有必要在给我进行关联,给我发鞋子什么的来我这卖了.</p>
<h3 id="__mode"><span>__mode</span></h3>
<p>假设如果你的主店和你名下的分店有强引用关系,比如你欠了分店的预付款什么的,这个时候分店不想和你干了,按照法律来说及时分店自己关闭了,分店和你的劳动纠纷还是存在,你还是跑不了,毕竟强引用关系再次,但是如果你和分店在签订加盟合同的时候,说的是自负盈亏,如果主店付不出利润钱了,两个人也扯不上任何法律上的关系,这样分店自己关闭了,你也不用在负责任,这就有点像弱引用的关系</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>		num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>		num21_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> contract <span style="color:#39c">=</span> {} <span style="color:#000080">--两人在此建立合同</span>
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myBranchShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--设置成nil,下面调用collectgarbage才会被回收</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- 进行gc回收</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306213441302.png" alt="image-20230306213441302"  />
</p>
<p>可以看到当两者建立合同并且没有设置弱引用的时候<code>,myBranchShoeStore</code>分店哪怕主动回收了,最后发现和<code>myShoeStore</code>主店有引用关系在,还是没有被回收</p>
<p>那么怎么解决这种情况呢,我们可以使用<code>__mode</code>来解决这个问题,</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>k</td>
<td>表的key为弱引用</td>
</tr>
<tr>
<td>v</td>
<td>表的value为弱引用</td>
</tr>
<tr>
<td>kv</td>
<td>表的key,value都为弱引用</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>		num20_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>		num21_shoe <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> contract <span style="color:#39c">=</span> {} <span style="color:#000080">--两人在此建立合同</span>
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span>contract[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#cd0000">&#34;</span><span style="color:#cd0000">\n</span><span style="color:#cd0000">-------------collectgarbage after-----------------&#34;</span>)
</span></span><span style="display:flex;"><span>setmetatable(contract,{__mode<span style="color:#39c">=</span><span style="color:#cd0000">&#34;v&#34;</span>})<span style="color:#000080">--这个地方把value设置成了弱引用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myBranchShoeStore <span style="color:#39c">=</span> <span style="color:#cdcd00">nil</span> <span style="color:#000080">--设置成nil,下面调用collectgarbage才会被回收</span>
</span></span><span style="display:flex;"><span>collectgarbage()<span style="color:#000080">-- 进行gc回收</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(contract) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(k,v)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230306214108485.png" alt="image-20230306214108485"  />
</p>
<p>我们可以看到回收之前是<code>2个table</code>,而当调用<code>myBranchShoeStore = nil ,collectgarbage()</code>的时候,发现<code>myBranchShoeStore</code> 被回收了</p>
<h4 id="入口源码剖析"><span>入口源码剖析</span></h4>
<p><img loading="lazy" src="image-20230306215333685.png" alt="image-20230306215333685"  />
</p>
<ul>
<li><code>1</code>号位置是从元表中获取元方法</li>
<li><code>2</code>号位置是根据设置的操作符是什么进行对应的<code>gc</code>回收</li>
</ul>
<h4 id="弱表原理剖析"><span>弱表原理剖析</span></h4>
<p><img loading="lazy" src="weaktable.png" alt="image-20230306214108485"  />
</p>
<p>上面是弱表的原理剖析,大家可以把图片放大或者下载下来观看</p>
<p>弱表具体的相关源码太多了,这里就不一一展示了,感兴趣的可以去下面连接查找<code>traverseweakvalue,traverseephemeron,traverseephemeron,traversetable</code>四个主要函数进行观看,函数处也写了不少注释</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/lgc.c">弱表相关的gc部分 </a></p>
<h3 id="__len"><span>__len</span></h3>
<p><code>这个是用来求自定义长度使用的</code></p>
<h4 id="例子"><span>例子</span></h4>
<p>假如这个时候来了个顾客,顾客说你这有<code>20</code>码以上的鞋子吗,我的脚比较特殊需要都试试,如果你是店家但是因为没有使用信息化处理,看着满主店仓库堆满的鞋子,你是不是会很绝望,等你从仓库中翻出那些鞋子,估计顾客都跑掉了,所以这个时候我们就可以使用<code>_len</code>元方法来处理这个窘迫的问题</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	num12_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>},<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	num13_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">13</span>,<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>},<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>	num20_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">20</span>,<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>},<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>	num21_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">21</span>,<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>},<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>	num22_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">22</span>,<span style="color:#cd0000">&#34;Size 22 shoes&#34;</span>},<span style="color:#000080">--22号鞋子</span>
</span></span><span style="display:flex;"><span>	num23_shoe <span style="color:#39c">=</span> {<span style="color:#cd00cd">23</span>,<span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>},<span style="color:#000080">--23号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStoreLen <span style="color:#39c">=</span>{
</span></span><span style="display:flex;"><span>	__len <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span> (table) <span style="color:#000080">--通过此处的计算直接把20号以上的鞋子都给统计出来</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> len <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(table) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">if</span>( <span style="color:#cd00cd">20</span> <span style="color:#39c">&lt;=</span> v[<span style="color:#cd00cd">1</span>]) <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>			len<span style="color:#39c">=</span> len<span style="color:#39c">+</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> len;
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, myShoeStoreLen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)<span style="color:#000080">--这个地方得到__len元方法统计的数据量大小</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307102631783.png" alt="image-20230307102631783"  />
</p>
<p>从上面结果我们可以看出,完美的得到了想要的数据</p>
<h4 id="源码讲解"><span>源码讲解</span></h4>
<p><img loading="lazy" src="image-20230307102824259.png" alt="image-20230307102824259"  />
</p>
<p>上面是当你是用<code>#</code>去求大小的时候,会更加你#后面跟的数据类型来判断怎么求大小</p>
<ul>
<li>如果是<code>#table</code>,那么就看一下是否设置了元方法,如果设置了走<code>luaT_callTMres</code>函数调用元方法求大小,否则通过<code>luaH_getn</code>函数求大小</li>
<li>如果是<code>#短字符串</code>,直接通过<code>tsvalue(rb)-&gt;shrlen</code>返回大小</li>
<li>如果是<code>#长字符串</code>,直接通过<code>tsvalue(rb)-&gt;u.lnglen</code>返回大小</li>
<li>如果是<code>#其他</code>,那么就判断是否设置了元表如果设置了就通过<code>luaT_callTMres</code>函数调用元方法求大小,否则报错,这个其他比如是<code>userdata</code>等等</li>
</ul>
<p>已经说道了这里那么就好好说下<code>#table</code>的时候通过<code>luaH_getn</code>函数求大小</p>
<p><img loading="lazy" src="image-20230307103807433.png" alt="image-20230307103807433"  />
</p>
<p>可以看到上面的内容还是挺蛋疼的,又是二分,又是边界什么什么的,不着急,我们慢慢嚼碎它</p>
<p>首先我们知道<code>lua</code>的<code>table</code>是分为<code>数组</code>和<code>hash</code>部分的</p>
<p>所以为了求出合适的大小<code>lua</code>会按如下规则来求大小,或者更简单点来说,<code>lua用#求大小就是求table的边界</code></p>
<p>那么怎么求边界呢,边界又是针对什么的呢</p>
<ul>
<li>
<p>边界是针对<code>table</code>的数组部分的,但若哈希部分的<code>key</code>为整数且刚好连着数组部分,则也会一并参与计算</p>
</li>
<li>
<p>若某个整数下标<code>n</code>,满足<code>table[boundary]</code>不为空,而<code>table[boundary+1]</code>为空,则<code>n</code>为<code>table</code>的边界</p>
<blockquote>
<p>table[boundary] != nil
table[boundary+1] == nil</p>
</blockquote>
</li>
</ul>
<p>为了提高遍历查找边界的效率,<code>lua</code>源码并没有进行遍历查找,而是通过二分查找</p>
<ol>
<li>
<p>如果<code>table</code>数组部分的最后一个元素为<code>nil</code>,那么将在数组部分进行二分查找</p>
</li>
<li>
<p>针对<code>table</code>的数组部分的,但若哈希部分的<code>key</code>为整数且刚好连着数组部分,则也会一并参与计算</p>
</li>
<li></li>
<li>
<p>最后一种情况是数组部分中没有元素 或如果<code>table</code>数组部分的最后一个元素为<code>nil</code>,那么将在<code>hash</code>部分进行二分查找</p>
</li>
</ol>
<hr>
<h4 id="用求table长度的一些情况"><span>用#求table长度的一些情况</span></h4>
<h5 id="全部为数组没有hash部分"><span>全部为数组,没有<code>hash</code>部分</span></h5>
<h6 id="table的数组部分最后一个元素不是nil"><span>table的数组部分最后一个元素不是nil</span></h6>
<p><code>例子1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307141320810.png" alt="image-20230307141320810"  />
</p>
<p><code>例子2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153017370.png" alt="image-20230307153017370"  />
</p>
<p><code>例子3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">17</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153050144.png" alt="image-20230307153050144"  />
</p>
<ul>
<li>因为<code>table</code>数组部分最后一位不是<code>nil</code>所以会跑到<code>luaH_getn</code>函数的这个地方,直接返回<code>Table</code>结构体里面的<code>alimit</code>字段大小</li>
</ul>
<p><img loading="lazy" src="image-20230307141624175.png" alt="image-20230307141624175"  />
</p>
<h6 id="table的数组部分最后一个元素是nil数组部分倒数第二个不是nil"><span>table的数组部分最后一个元素是nil,数组部分倒数第二个不是nil</span></h6>
<p><code>例子1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307142944522.png" alt="image-20230307142944522"  />
</p>
<p><code>例子2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307152702572.png" alt="image-20230307152702572"  />
</p>
<p><code>例子3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cd00cd">16</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153146377.png" alt="image-20230307153146377"  />
</p>
<ul>
<li>因为数组部分最后一个元素为<code>nil</code>,数组部分倒数第二个不是<code>nil</code>,那么就直接返回<code>Table</code>结构体里面的<code>alimit</code>字段大小减<code>1</code></li>
</ul>
<p><img loading="lazy" src="image-20230307142908113.png" alt="image-20230307142908113"  />
</p>
<h6 id="table的数组部分最后一个元素是nil数组部分倒数第二个也是nil"><span>table的数组部分最后一个元素是nil,数组部分倒数第二个也是nil</span></h6>
<p><strong>关键源码部分</strong></p>
<p><img loading="lazy" src="image-20230307151703174.png" alt="image-20230307151703174"  />
</p>
<p><img loading="lazy" src="image-20230307165132582.png" alt="image-20230307165132582"  />
</p>
<p><code>例子1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cd00cd">14</span>,<span style="color:#cd00cd">15</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307152222070.png" alt="image-20230307152222070"  />
</p>
<p>简单说下<code>例子1</code>进入二分查找的运算过程</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">第一轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span><span style="">；</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">；进入</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第二轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span><span style="">；</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">3</span><span style="">；判断</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">是不是空</span>,<span style="">不为空</span>; i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">3</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">；进入</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第三轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">3</span><span style="">；</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span><span style="">；判断</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">是不是空</span>,<span style="">不为空</span>; i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">4</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">；进入</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第四轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span><span style="">；</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span><span style="">；判断</span>array[m <span style="color:#39c">-</span> <span style="color:#cd00cd">1</span>]<span style="">是不是空</span>,<span style="">为空</span>; j<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">5</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="">不大于</span><span style="color:#cd00cd">1</span><span style="">；退出循环</span>,<span style="">并返回</span>i<span style="">值</span>
</span></span></code></pre></div><p><code>例子2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153326096.png" alt="image-20230307153326096"  />
</p>
<p><code>例子3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> {<span style="color:#cd00cd">12</span>,<span style="color:#cd00cd">13</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>,<span style="color:#cdcd00">nil</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307153238458.png" alt="image-20230307153238458"  />
</p>
<ul>
<li>因为数组部分最后一个元素为<code>nil</code>,数组部分倒数第二个也是<code>nil</code>所以直接调用<code>binsearch</code>函数在数组部分进行二分查找得到<code>table</code>大小</li>
</ul>
<p>​	<strong>通过上面两个极端的例子,所以我们看到<code>table</code>只看数组部分最后两位的情况来决定什么样的逻辑处理</strong></p>
<pre><code>1. 如果数组部分最后一位不是`nil`,那么就直接返回`Table`结构体里面的`alimit`字段大小
1. 如果最后一个元素是`nil`,数组部分倒数第二个不是`nil`,那么就直接返回`Table`结构体里面的`alimit`字段大小减`1`
1. 如果数组部分最后一个元素为`nil`,数组部分倒数第二个也是`nil`所以直接调用`binsearch`函数在数组部分进行二分查找,得到`table`大小
</code></pre>
<h5 id="全部为hash没有数组"><span>全部为<code>hash</code>,没有数组</span></h5>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 22 shoes&#34;</span>,<span style="color:#000080">--22号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">6</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307155918239.png" alt="image-20230307155918239"  />
</p>
<p><strong>关键源码部分</strong></p>
<p><img loading="lazy" src="image-20230307155954243.png" alt="image-20230307155954243"  />
</p>
<p><img loading="lazy" src="image-20230307160109188.png" alt="image-20230307160109188"  />
</p>
<ul>
<li><code>t</code>没有数组元素,调用 <code>hash_search</code> 函数,<code>hash</code>部分从 <code>j = 1</code> 开始遍历, <code>i</code>记录的是上一个 <code>j</code>的值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">第一轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; t[<span style="color:#cd00cd">2</span>] <span style="">为</span><span style="color:#cdcd00">nil</span> <span style="">然后</span>j <span style="color:#39c">-</span> i <span style="">不大于</span><span style="color:#cd00cd">1</span> <span style="">所以直接返回</span>i<span style="">也就是大小</span><span style="color:#cd00cd">1</span>  
</span></span></code></pre></div><p>在举个触发二分查找的例子</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">1</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">2</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">6</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307160807187.png" alt="image-20230307160807187"  />
</p>
<ul>
<li><code>t</code>没有数组元素,调用 <code>hash_search</code> 函数,<code>hash</code>部分从 <code>j = 1</code> 开始遍历, <code>i</code>记录的是上一个 <code>j</code>的值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">第一轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">1</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; t[<span style="color:#cd00cd">2</span>]<span style="">不为</span><span style="color:#cdcd00">nil</span><span style="">；继续下一轮</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第二轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; t[<span style="color:#cd00cd">4</span>]<span style="">不为</span><span style="color:#cdcd00">nil</span><span style="">；继续下一轮</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第三轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; t[<span style="color:#cd00cd">8</span>]<span style="">为</span>nil<span style="">并且</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span><span style="">；</span> <span style="">进入二分查找阶段</span>
</span></span><span style="display:flex;"><span><span style="">第四轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span>; t[m]<span style="">不为空设置</span>i <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="color:#39c">&gt;</span> <span style="color:#cd00cd">1</span>;<span style="">继续下一轮二分查找</span>
</span></span><span style="display:flex;"><span><span style="">第五轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span><span style="">；</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">7</span>; t[m]<span style="">为空设置</span>j <span style="color:#39c">=</span> <span style="color:#cd00cd">7</span>; <span style="">判断</span>j <span style="color:#39c">-</span> i <span style="">不大于</span><span style="color:#cd00cd">1</span> <span style="">结束二分查找返回</span>i<span style="">的值为</span><span style="color:#cd00cd">6</span>
</span></span></code></pre></div><h5 id="有hash有数组的情况"><span>有hash有数组的情况</span></h5>
<h6 id="有数组部分并且和hash部分下标连贯的"><span>有数组部分并且和hash部分下标连贯的</span></h6>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">3</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#000080">--20号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307194943203.png" alt="image-20230307194943203"  />
</p>
<p><img loading="lazy" src="image-20230307160109188.png" alt="image-20230307160109188"  />
</p>
<p>我们可以看到大小就是数组部分的大小<code>2</code>加上<code>hash</code>部分的大小<code>3</code>总共为<code>5</code></p>
<p>模拟一下过程因为数组部分大小是<code>2</code>,所以j等于<code>2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="">第一轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">2</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; t[<span style="color:#cd00cd">4</span>]<span style="">不为</span><span style="color:#cdcd00">nil</span><span style="">；继续下一轮</span>white<span style="">循环</span>
</span></span><span style="display:flex;"><span><span style="">第二轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; t[<span style="color:#cd00cd">8</span>]<span style="">为</span><span style="color:#cdcd00">nil</span><span style="">；跳出</span>white<span style="">循环</span>;<span style="">判断</span>j <span style="color:#39c">-</span> i <span style="">是否大于</span><span style="color:#cd00cd">1</span>;<span style="">发现大于</span>;<span style="">进入二分查找</span>
</span></span><span style="display:flex;"><span><span style="">第三轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">8</span>; m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；</span>t[m]<span style="">为</span><span style="color:#cdcd00">nil</span><span style="">；</span>j<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">6</span><span style="">；判断</span>j <span style="color:#39c">-</span> i <span style="">是否大于</span><span style="color:#cd00cd">1</span> <span style="">发现大于</span>,<span style="">继续下一轮二分查找</span>
</span></span><span style="display:flex;"><span><span style="">第四轮</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">4</span>; j <span style="color:#39c">=</span> <span style="color:#cd00cd">6</span><span style="">；</span>m <span style="color:#39c">=</span> (i <span style="color:#39c">+</span> j) <span style="color:#39c">/</span> <span style="color:#cd00cd">2</span> <span style="color:#39c">=</span> <span style="color:#cd00cd">5</span>; t[m]<span style="">不为</span><span style="color:#cdcd00">nil</span> i<span style="color:#39c">=</span>m<span style="color:#39c">=</span><span style="color:#cd00cd">5</span>; <span style="">判断</span>j <span style="color:#39c">-</span> i <span style="">是否大于</span><span style="color:#cd00cd">1</span> <span style="">发现是等于</span><span style="color:#cd00cd">1</span><span style="">不符合条件</span>,<span style="">跳出循环</span>,<span style="">返回</span>i,<span style="">也就是</span><span style="color:#cd00cd">5</span>
</span></span></code></pre></div><h6 id="有数组部分并且和hash部分下标不连贯的"><span>有数组部分并且和hash部分下标不连贯的</span></h6>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#000080">--12号鞋子</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#000080">--13号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">4</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#000080">--21号鞋子</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#cd00cd">5</span>] <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;Size 23 shoes&#34;</span>,<span style="color:#000080">--23号鞋子</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#39c">#</span>myShoeStore)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307200545253.png" alt="image-20230307200545253"  />
</p>
<p>可以看到上面因为不连贯直接值返回了数组的长度,并没有加上hash的长度,主要原因还是源码的这个地方调用<code>luaH_getint</code>函数返回了<code>absentkey</code></p>
<p><img loading="lazy" src="image-20230307200703891.png" alt="image-20230307200703891"  />
</p>
<h5 id="table求大小总结"><span>#table求大小总结</span></h5>
<p>所以从上面的各种分析能看出来,一般的情况下,如果这个表结构并不是按数字<code>1~N</code>顺序递增的，那么<code>#table</code>取出来的大小可能会是一些奇怪的值,所以建议用如下<code>API</code>接口来求大小</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#cdcd00">function</span> <span style="color:#00cdcd">table</span>.length(t)
</span></span><span style="display:flex;"><span>    <span style="color:#00cd00">local</span> i <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">for</span> k, v <span style="color:#cdcd00">in</span> pairs(t) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#39c">=</span> i <span style="color:#39c">+</span> <span style="color:#cd00cd">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cdcd00">return</span> i
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><h3 id="运算符重载"><span>运算符重载</span></h3>
<p>我们可以看到一共有<code>18</code>中符号能够参与运算符重载</p>
<table>
<thead>
<tr>
<th>C枚举</th>
<th>元方法名字</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>TM_EQ</td>
<td>__eq</td>
<td>对应运算符&quot;==&ldquo;比较两个对象是否相等</td>
</tr>
<tr>
<td>TM_ADD</td>
<td>__add</td>
<td>对应运算符&rdquo;+&quot;（加法）操作</td>
</tr>
<tr>
<td>TM_SUB</td>
<td>__sub</td>
<td>对应的运算符 &lsquo;-&rsquo;（减法）操作</td>
</tr>
<tr>
<td>TM_MUL</td>
<td>__mul</td>
<td>对应运算符&quot;*&quot;（乘法）操作</td>
</tr>
<tr>
<td>TM_MOD</td>
<td>__mod</td>
<td>对应运算符&quot;%&quot;（取模）操作</td>
</tr>
<tr>
<td>TM_POW</td>
<td>__pow</td>
<td>对应运算符&quot;^&quot;（次方）操作</td>
</tr>
<tr>
<td>TM_DIV</td>
<td>__div</td>
<td>对应运算符&quot;/&quot;（除法）操作</td>
</tr>
<tr>
<td>TM_IDIV</td>
<td>__idiv</td>
<td>对应运算符&quot;//&quot;（向下取整除法）操作</td>
</tr>
<tr>
<td>TM_BAND</td>
<td>__band</td>
<td>对应运算符&quot;&amp;&quot;（按位与）操作</td>
</tr>
<tr>
<td>TM_BOR</td>
<td>__bor</td>
<td>对应运算符&quot;|&quot;（按位或）操作</td>
</tr>
<tr>
<td>TM_BXOR</td>
<td>__bxor</td>
<td>对应运算符&quot;^&quot;（按位异或）操作</td>
</tr>
<tr>
<td>TM_SHL</td>
<td>__shl</td>
<td>对应运算符&quot;&laquo;&quot;（左移）操作</td>
</tr>
<tr>
<td>TM_SHR</td>
<td>__shr</td>
<td>对应运算符&quot;&raquo;&quot;（右移）操作</td>
</tr>
<tr>
<td>TM_UNM</td>
<td>__unm</td>
<td>对应的运算符 &lsquo;-&rsquo;（取负）操作</td>
</tr>
<tr>
<td>TM_BNOT</td>
<td>__bnot</td>
<td>对应运算符&quot;~&quot;（按位非）操作</td>
</tr>
<tr>
<td>TM_LT</td>
<td>__lt</td>
<td>对应的运算符 &lsquo;&lt;&rsquo;（小于）操作</td>
</tr>
<tr>
<td>TM_LE</td>
<td>__le</td>
<td>对应的运算符 &lsquo;&lt;=&rsquo;（小于等于）操作</td>
</tr>
<tr>
<td>TM_CONCAT</td>
<td>__concat</td>
<td>对应的运算符 &lsquo;..&rsquo;(连接）操作</td>
</tr>
</tbody>
</table>
<p>终于到了月底盘点的日子了,为了能更好的管理店面进行盘点,需要对很多数据进行加加减减,取模,等等,这个时候就可以用上我们的<code>lua</code>的<code>18</code>个元方法,进行运算符重载</p>
<h4 id="__eq"><span>__eq</span></h4>
<p>作用:比较两个对象是否相等</p>
<p>下面例子比较一下主店和分店各自销售记录量是不是一样</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--盘点操作用来做Metatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--定义相等操作来比较一下主店和分店各自销售量是不是一样</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__eq <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#39c">#</span>table1 <span style="color:#39c">==</span> <span style="color:#39c">#</span>table2
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--比较一下主店和分店各自销售量是不是一样</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> isSame <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">==</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(isSame)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307222416122.png" alt="image-20230307222416122"  />
</p>
<p>我们可以看到返回了<code>false</code>说明两家店销售记录量不一样</p>
<h4 id="__mul"><span>__mul</span></h4>
<p>作用:做乘法操作</p>
<p>统计下主店和分店一共挣了多少钱</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--盘点操作用来做Metatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--定义乘法操作来统计下主店和分店一共挣了多少钱</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__mul <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> money <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span>  _,v <span style="color:#cdcd00">in</span> pairs(table1) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		money <span style="color:#39c">=</span> money <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span>  _,v <span style="color:#cdcd00">in</span> pairs(table2) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		money <span style="color:#39c">=</span> money <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> money
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--统计下主店和分店一共挣了多少钱</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> money <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">*</span> myBranchShoeStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(money)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307223652491.png" alt="image-20230307223652491"  />
</p>
<p>可以看到总的<code>money</code>算出来了一共<code>17400</code>元</p>
<h4 id="__add"><span>__add</span></h4>
<p>作用:用来进行加法操作</p>
<p>举个栗子比如下面用来统计主店和分店总的销售物品信息</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00cd00">local</span> myBranchShoeStore <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 20 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">40</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 21 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--盘点操作用来做Metatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--定义加法操作用来统计主店和分店的销售数据</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__add <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(table1, table2)
</span></span><span style="display:flex;"><span>	 <span style="color:#cdcd00">for</span> _, value <span style="color:#cdcd00">in</span> pairs(table2) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>      table.insert(table1, value)
</span></span><span style="display:flex;"><span>   <span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>   <span style="color:#cdcd00">return</span> table1
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--统计主店和分店总的销售数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">local</span> totalShoeInfo <span style="color:#39c">=</span> myShoeStore <span style="color:#39c">+</span> myBranchShoeStore
</span></span><span style="display:flex;"><span><span style="color:#000080">--输出一下结果</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v <span style="color:#cdcd00">in</span> pairs(totalShoeInfo) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> item <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> i<span style="color:#39c">=</span><span style="color:#cd00cd">1</span>,<span style="color:#cd00cd">3</span> <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">if</span> i <span style="color:#39c">~=</span> <span style="color:#cd00cd">3</span> <span style="color:#cdcd00">then</span>
</span></span><span style="display:flex;"><span>			item <span style="color:#39c">=</span> item <span style="color:#39c">..</span> v[i] <span style="color:#39c">..</span> <span style="color:#cd0000">&#34;,&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">else</span>
</span></span><span style="display:flex;"><span>			item <span style="color:#39c">=</span> item <span style="color:#39c">..</span> v[i]
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	print(<span style="color:#cd0000">&#34;{&#34;</span> <span style="color:#39c">..</span> item <span style="color:#39c">..</span> <span style="color:#cd0000">&#34;}&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307221910971.png" alt="image-20230307221910971"  />
</p>
<p>从结果上看,我们已经完美的把两家店的数据都统计合在一块了</p>
<p><strong>其他的运算符重载就不在举例了,和上面列出来的<code>3</code>个例子非常雷同</strong></p>
<h3 id="__call"><span>__call</span></h3>
<p>作用:当<code>table</code>名字做为函数名字的形式被调用的时候,会调用<code>__call</code>函数</p>
<p>查看下主店每日完成金额量差距</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--盘点操作用来做Metatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--定义函数调用操作来查看下每日完成金额量差距</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__call <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(self,target)
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> num14 <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">for</span> _,v <span style="color:#cdcd00">in</span> pairs(self) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>		num14 <span style="color:#39c">=</span> num14 <span style="color:#39c">+</span> (v[<span style="color:#cd00cd">2</span>] <span style="color:#39c">*</span> v[<span style="color:#cd00cd">3</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> target <span style="color:#39c">-</span> num14
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--查看下主店每日完成金额量差距</span>
</span></span><span style="display:flex;"><span>print(myShoeStore(<span style="color:#cd00cd">10000</span>))<span style="color:#000080">--假设需要每日完成10000金额的销售量</span>
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307225538660.png" alt="image-20230307225538660"  />
</p>
<p>我们可以看到每日目标金额已经超额完成,并且超了<code>1400</code>块</p>
<h3 id="__close"><span>__close</span></h3>
<h4 id="例子-1"><span>例子</span></h4>
<p>作用:被标记为<code>to-be-closed</code>的局部变量会在超出它的作用域时,调用它的<code>__closed</code>元方法</p>
<p><code>close</code>变量<code>To-be-closed Variables</code>需要和<code>close</code>元方法结合使用，在变量超出作用域时，会调用变量的<code>close</code>元方法<code>__close</code>,<code>close</code>变量一般用于需要及时释放的资源的情况,多用这个其实也能减轻<code>gc</code>的负担</p>
<p>当店铺晚上关门的时候能自动把店铺的灯关闭</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#00cd00">local</span> myShoeStore <span style="color:#39c">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 12 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">20</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 13 shoes&#34;</span>,<span style="color:#cd00cd">50</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	{<span style="color:#cd0000">&#34;Size 14 shoes&#34;</span>,<span style="color:#cd00cd">80</span>,<span style="color:#cd00cd">80</span>},<span style="color:#000080">--鞋子类型,销售额,数量</span>
</span></span><span style="display:flex;"><span>	light <span style="color:#39c">=</span> <span style="color:#cdcd00">true</span>, <span style="color:#000080">--灯开着</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--盘点操作用来做Metatable</span>
</span></span><span style="display:flex;"><span>inventoryOpe <span style="color:#39c">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--定义__close操作当店铺晚上关门的时候能自动把店铺的灯关闭</span>
</span></span><span style="display:flex;"><span>inventoryOpe.__close <span style="color:#39c">=</span> <span style="color:#cdcd00">function</span>(self)
</span></span><span style="display:flex;"><span>	self.light <span style="color:#39c">=</span> <span style="color:#cdcd00">false</span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setmetatable(myShoeStore, inventoryOpe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">--当主店铺晚上关门的时候能自动把店铺的灯关闭</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">do</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">local</span> closeStore <span style="color:#39c">&lt;</span>close<span style="color:#39c">&gt;</span> <span style="color:#39c">=</span> myShoeStore
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(myShoeStore.light)
</span></span></code></pre></div><p><img loading="lazy" src="image-20230307230719223.png" alt="image-20230307230719223"  />
</p>
<h4 id="源码分析"><span>源码分析</span></h4>
<p><img loading="lazy" src="image-20230307230930861.png" alt="image-20230307230930861"  />
</p>
<p>我们可以看到有两个核心函数一个是<code>callclosemethod</code>和<code>checkclosemth</code></p>
<ul>
<li><code>callclosemethod</code> 主要就是用来调用设置的元方法</li>
<li><code>checkclosemth</code> 这个主要是用来检测是否设置好了元方法,如果没有设置的话就会报错</li>
</ul>
<h2 id="更详细的注释请去我的github地址"><span>更详细的注释请去我的GitHub地址</span></h2>
<p>以下是我几乎每行都加了注释的<code>GitHub</code>地址</p>
<ol>
<li>
<p><code>ltm.c</code>注释地址</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/ltm.c"><strong>ltm.c注释</strong></a></p>
</li>
<li>
<p><code>ltm.h</code>注释地址</p>
<p><a href="https://github.com/frog-game/lua-5.4.4-comments/blob/master/src/ltm.h"><strong>ltm.h注释</strong></a></p>
</li>
</ol>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://frog-game.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>微信</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://frog-game.github.io/img/alipay_pay.png" alt="alipay"></a>
                        <p>支付宝</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>🧧 鼓励</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://frog-game.github.io/posts/read/lua5.4.4.code/">
    <span class="title">下一页 »</span>
    <br>
    <span>[Lua5.4.4源码].指令集</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">💬评论</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://www.frog-game.work/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: "ap-beijing",
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2023 
        <a href="https://frog-game.github.io/" style="color:#939393;">frog&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">备案号</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="https://frog-game.github.io/img/beian.png" style="float:left;margin: 0px 5px 0px 0px;"/>
            公网安备
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        总访客数: <span id="busuanzi_value_site_uv"></span>
        总访问量: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"frog's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
