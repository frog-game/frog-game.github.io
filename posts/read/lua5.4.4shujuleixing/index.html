<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Lua5.4.4æºç ]æ•°æ®ç±»å‹ | frog&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="luaæºç æ•°æ®ç±»å‹åˆ†æ">
<meta name="author" content="
ä½œè€…:&nbsp;frog">
<link rel="canonical" href="https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8b75bf56d6fb0c429b5f3ce03bce19c9ef1e90cc024b64bd12ec321c68cca894.css" integrity="sha256-i3W/Vtb7DEKbXzzgO84Zye8ekMwCS2S9EuwyHGjMqJQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://frog-game.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="mask-icon" href="https://frog-game.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="[Lua5.4.4æºç ]æ•°æ®ç±»å‹" />
<meta property="og:description" content="luaæºç æ•°æ®ç±»å‹åˆ†æ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/" />
<meta property="og:image" content="https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/image-20230123132152317.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-24T01:30:29&#43;08:00" />
<meta property="article:modified_time" content="2023-01-24T01:30:29&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/image-20230123132152317.png" />
<meta name="twitter:title" content="[Lua5.4.4æºç ]æ•°æ®ç±»å‹"/>
<meta name="twitter:description" content="luaæºç æ•°æ®ç±»å‹åˆ†æ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://frog-game.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• é˜…è¯»",
      "item": "https://frog-game.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "[Lua5.4.4æºç ]æ•°æ®ç±»å‹",
      "item": "https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Lua5.4.4æºç ]æ•°æ®ç±»å‹",
  "name": "[Lua5.4.4æºç ]æ•°æ®ç±»å‹",
  "description": "luaæºç æ•°æ®ç±»å‹åˆ†æ",
  "keywords": [
    ""
  ],
  "articleBody": "LUA_TNIL nilè¡¨ç¤ºçš„æ„æ€å°±æ˜¯æ— æ•ˆå€¼ å¦‚æœèµ‹å€¼ä¸ºnil,ç­‰ä»·äºå°±æ˜¯åˆ é™¤,åˆ°æ—¶å€™GCåˆ¤æ–­æ²¡æœ‰ä»»ä½•å…³è”,å°±ä¼šæŠŠè¿™ä¸ªå€¼å›æ”¶ LUA_TNIL é™¤äº†å®šä¹‰å¯¹å¤–çš„LUA_VNIL nilç±»å‹,è¿˜ä¼šåˆ†ä¸º{LUA_VEMPTY:,LUA_VABSTKEY}è¿™ä¸¤ä¸ªä¸œè¥¿ä¸å¯¹å¤–,ç”¨äºCå±‚é€»è¾‘çš„åˆ¤æ–­ LUA_VEMPTY: ç©ºæ§½ä½, Cå±‚ç”¨æ¥å ä½å’Œæ¸…é™¤é€»è¾‘ LUA_VABSTKEY:Cå±‚ç”¨æ¥æŸ¥æ‰¾Keyæ—¶å€™æ‰¾ä¸åˆ°çš„æ—¶å€™è¿”å›ç±»å‹ LUA_TBOOLEAN åœ¨luaé‡Œé¢0ä¹Ÿæ˜¯çœŸå€¼,è¿™ç‚¹å’Œå…¶ä»–è¯­è¨€æ¯”å¦‚C/C++ç­‰ç­‰è¯­è¨€ä¸ä¸€æ ·,è¦æ³¨æ„\n0:çœŸ\nnil:å‡\nfalse:å‡\nå…¶ä»–å€¼:çœŸ\nLUA_TLIGHTUSERDATA å’Œ LUA_TUSERDATA åŒºåˆ« LUA_TUSERDATA LUA_TLIGHTUSERDATA ä½œç”¨ é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„ç»“æ„ä½“ä¸€å°æ®µå›ºå®šçš„å†…å­˜åŒºåŸŸ é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„æŒ‡é’ˆ(void *) å†…å­˜ç®¡ç† ç”±Luaçš„åƒåœ¾å›æ”¶å™¨ç®¡ç† ä½¿ç”¨è€…éœ€è¦å…³å¿ƒå…¶å†…å­˜ å…ƒè¡¨ æœ‰ç‹¬ç«‹çš„å…ƒè¡¨ æ²¡æœ‰ç‹¬ç«‹çš„å…ƒè¡¨ åˆ›å»º void *lua_newuserdata(lua_State *L, size_t size) lua_pushlightuserdata(lua_State *L, void *p); å…·ä½“åŒºåˆ«å…¶å®æˆ‘ä»¬åœ¨luaæºç ä¸­ä¹Ÿèƒ½æ‰¾åˆ°åŒºåˆ«\næˆ‘ä»¬åœ¨æºç ä¸­æ‰¾åˆ°äº†è¿™æ®µä»£ç å¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ®ç±»å‹è¿”å›äº†1å’Œ2ä¸¤ä¸ªä¸åŒçš„åœ°å€\né¦–å…ˆæˆ‘ä»¬æ¥è¯´LUA_TUSERDATA\nLUA_TUSERDATA 1å¤„æˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªå®,å¯ä»¥çœ‹åˆ°å…¶å®æ˜¯è¿”å›çš„æ˜¯ä¸€å—å®å®åœ¨åœ¨çš„å†…å­˜åœ°å€\n///è®¡ç®—ç”¨æˆ·æ•°æ®çš„å†…å­˜åŒºåŸŸçš„åç§»é‡ // offsetofæ˜¯ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡ #define udatamemoffset(nuv) \\ ((nuv) == 0 ? offsetof(Udata0, bindata) \\ : offsetof(Udata, uv) + (sizeof(UValue) * (nuv))) #define getudatamem(u)\t(cast_charp(u) + udatamemoffset((u)-\u003enuvalue)) //è¿”å›å†…å­˜å—çš„åœ°å€ ä»ä¸‹å›¾ä¸­æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°LUA_TUSERDATAé‡Œé¢æœ‰ ç‹¬ç«‹å…ƒè¡¨\nLUA_TUSERDATAå®ç°ä¾‹å­ //cæ–‡ä»¶ //#include extern \"C\" { #include \"lua.h\" #include \"lauxlib.h\" #include \"lualib.h\" } #include using namespace std; static struct StudentTag { char *strName; // å­¦ç”Ÿå§“å char *strNum; // å­¦å· int iSex; // å­¦ç”Ÿæ€§åˆ« int iAge; // å­¦ç”Ÿå¹´é¾„ }T; static int Student(lua_State *L) { size_t iBytes = sizeof(struct StudentTag); struct StudentTag *pStudent; pStudent = (struct StudentTag *)lua_newuserdata(L, iBytes); //è®¾ç½®å…ƒè¡¨ luaL_getmetatable(L, \"Student\"); lua_setmetatable(L, -2); //lua_pushnumber(L, 123); return 1; // æ–°çš„userdataå·²ç»åœ¨æ ˆä¸Šäº† } static int GetName(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \"Student\"); lua_pushstring(L, pStudent-\u003estrName); return 1; } static int SetName(lua_State *L) { // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯userdata struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \"Student\"); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² const char *pName = luaL_checkstring(L, 2); luaL_argcheck(L, pName != NULL \u0026\u0026 pName != \"\", 2, \"Wrong Parameter\"); pStudent-\u003estrName =(char*) pName; return 0; } static int GetAge(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \"Student\"); lua_pushinteger(L, pStudent-\u003eiAge); return 1; } static int SetAge(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \"Student\"); int iAge = luaL_checkinteger(L, 2); luaL_argcheck(L, iAge \u003e= 6 \u0026\u0026 iAge \u003c= 100, 2, \"Wrong Parameter\"); pStudent-\u003eiAge = iAge; return 0; } static int GetSex(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 1; } static int SetSex(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 0; } static int GetNum(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 1; } static int SetNum(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 0; } static luaL_Reg arrayFunc_meta[] = { { \"getName\", GetName }, { \"setName\", SetName }, { \"getAge\", GetAge }, { \"setAge\", SetAge }, { \"getSex\", GetSex }, { \"setSex\", SetSex }, { \"getNum\", GetNum }, { \"setNum\", SetNum }, { NULL, NULL } }; static luaL_Reg arrayFunc[] = { { \"new\", Student}, { NULL, NULL } }; extern \"C\" _declspec(dllexport) int luaopen_mytestlib(lua_State *L) { // åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨ luaL_newmetatable(L, \"Student\"); // å…ƒè¡¨.__index = å…ƒè¡¨ lua_pushvalue(L, -1); lua_setfield(L, -2, \"__index\"); luaL_setfuncs(L, arrayFunc_meta, 0); luaL_newlib(L, arrayFunc); lua_pushvalue(L, -1); lua_setglobal(L, \"Sdudent\"); /* the module name */ return 1; } -- lua æ–‡ä»¶ require \"mytestlib\" local objStudent = Sdudent.new() objStudent:setName(\"æœå†»\") local strName = objStudent:getName() print(strName ) for k,v in pairs(getmetatable(objStudent)) do print(tostring(k),tostring(v)) end LUA_TLIGHTUSERDATA 2å¤„æˆ‘ä»¬è¿”å›çš„ä¹Ÿæ˜¯ä¸ªå®\n#define pvalue(o)\tcheck_exp(ttislightuserdata(o), val_(o).p) //è·å–light userdataçš„æŒ‡é’ˆ è¿›ä¸€æ­¥è¿½è¸ªæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pæŒ‡é’ˆæŒ‡å‘çš„æ˜¯è¿™ä¸ªç»“æ„ä½“,é‡Œé¢å¹¶æ²¡æœ‰å…ƒè¡¨ç›¸å…³çš„å®ç°,æ‰€ä»¥åé¢å…ƒè¡¨ç›¸å…³çš„å¤„ç†éƒ½å¾—æˆ‘ä»¬è‡ªå·±å¤„ç†\nä½“å¤–è¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ç”¨CJSONå»ååºåˆ—åŒ–çš„æ—¶å€™èƒ½çœ‹åˆ°æ‰“å°tableé‡Œé¢çš„å€¼å±…ç„¶æ˜¯null æ¯”å¦‚è¿™æ ·çš„ç»“æœ\n{\"key1\":\"value\",\"key\":null,\"key2\":\"value2\"} é¦–å…ˆçœ‹çœ‹lua_pushlightuserdataå®ç°\nåœ¨çœ‹çœ‹cjson.soçš„å®ç°\nlua_newtable(L); lua_pushlightuserdata(L, NULL); lua_setfield(L, -2, \"null\"); æˆ‘ä»¬è¿›å…¥lua_pushlightuserdata(L, NULL); ç„¶åçœ‹åˆ°äº† setpvalue(L-\u003etop, p)çš„è°ƒç”¨\nè¿™æ ·åœ¨å®é™…è°ƒç”¨æ—¶, setpvalue(L-\u003etop, p) ç›¸å½“äº void *p = NULL æœ€åæ˜¯è¢«å°è£…åˆ°tableå˜é‡é‡Œè¿”å›çš„\nè¿™ä¸ªç‚¹éœ€è¦æ³¨æ„å¾ˆå®¹æ˜“é€ æˆbug\nLUA_TLIGHTUSERDATAå®ç°ä¾‹å­ //Cæ–‡ä»¶ #include #include #include using namespace std; extern \"C\" { #include \"lua.h\" #include \"lualib.h\" #include \"lauxlib.h\" } typedef struct { int x; int y; int z; }TData; static int getAttribute(lua_State* L) { TData *data = (TData*)lua_touserdata(L, 1); std::string attribute = luaL_checkstring(L, 2); int result = 0; if (attribute == \"x\") { result = data-\u003ex; } else if (attribute == \"y\") { result = data-\u003ey; } else { result = data-\u003ez; } lua_pushnumber(L, result); return 1; } static luaL_Reg dataLib[] = { { \"__index\", getAttribute }, { NULL, NULL } }; void getMetaTable(lua_State* L, luaL_Reg* methods) { lua_pushlightuserdata(L, methods); lua_gettable(L, LUA_REGISTRYINDEX); if (lua_isnil(L, -1)) { /* not found */ lua_pop(L, 1); lua_newtable(L); luaL_setfuncs(L, methods, 0); lua_pushlightuserdata(L, methods); lua_pushvalue(L, -2); lua_settable(L, LUA_REGISTRYINDEX); } } int main() { const char* filename = \"test.lua\"; lua_State *lua = luaL_newstate(); if (lua == NULL) { fprintf(stderr, \"open lua failed\"); return -1; } luaL_openlibs(lua); TData input = { 123, 231, 321 }; lua_pushlightuserdata(lua, \u0026input); getMetaTable(lua, dataLib); lua_setmetatable(lua, -2); lua_setglobal(lua, \"input\"); if (luaL_dofile(lua, filename)) { //luaL_error(lua, \"load file %s failed\", filename); } lua_getglobal(lua, \"data\"); int output = lua_tointeger(lua, -1); std::cout \u003c\u003c output \u003c\u003c std::endl; return 0; } --luaæ–‡ä»¶ data = input.x; print(data) LUA_TNUMBER lua5.3ä»¥åå·²ç»æŠŠè¿™ä¸ªæ•°å€¼ç±»å‹åˆ†ä¸ºäº†2ä¸­ç±»å‹\nLUA_VNUMINT æ•´æ•°ç±»å‹ å…¶å®å°±æ˜¯cä¸­çš„longlong,å ç”¨8ä¸ªå­—èŠ‚ LUA_VNUMFLT æµ®ç‚¹ç±»å‹ å…¶å®å°±æ˜¯cä¸­çš„double,å ç”¨8ä¸ªå­—èŠ‚ å¯¹åº”çš„æºç å¦‚ä¸‹\nLUA_TSTRING lua5.4å°†stringåˆ†ä¸ºäº†ä¸¤ç§\nLUA_VSHRSTR:çŸ­å­—ç¬¦ä¸²\nå°äºç­‰äº40å­—èŠ‚çš„ hashå€¼æ˜¯åœ¨åˆ›å»ºæ—¶å°±è®¡ç®—å‡ºæ¥çš„ LUA_VLNGSTR é•¿å­—ç¬¦ä¸²\nå¤§äº40å­—èŠ‚çš„å°±æ˜¯é•¿å­—ç¬¦ä¸² çœŸæ­£éœ€è¦å®ƒçš„hashå€¼æ—¶ï¼Œæ‰ä¼šæ‰‹åŠ¨è°ƒç”¨luaS_hashlongstrå‡½æ•°ç”Ÿæˆè¯¥å€¼,luaå†…éƒ¨ç°åœ¨åªæœ‰åœ¨æŠŠé•¿ä¸²ä½œä¸ºtableçš„keyæ—¶ï¼Œæ‰ä¼šå»è®¡ç®—å®ƒ å­—ç¬¦ä¸²ç»“æ„ å­˜å‚¨ä½ç½® çŸ­å­—ç¬¦ä¸² ç›¸åŒhashå­—ç¬¦ä¸²å­˜å‚¨åœ¨ stringtable strt é“¾è¡¨ç»“æ„ä¸Š ä¸€èˆ¬çŸ­å­—ç¬¦ä¸²ä¼šä½¿ç”¨è¿™ç§æ–¹å¼å­˜å‚¨\né•¿å­—ç¬¦ä¸² å› ä¸ºé•¿å­—ç¬¦ä¸²æ˜¯æƒ°æ€§ç”Ÿæˆçš„ï¼Œåªæœ‰åœ¨éœ€è¦hashå€¼å¾—æ—¶å€™æ‰ä¼šå»åˆ›å»º,æ‰€ä»¥ä¸ä¼šæƒ³çŸ­å­—ç¬¦ä¸²ä¸€æ ·å­˜åœ¨global_State-\u003estrté‡Œé¢çš„,è€Œæ˜¯çœŸæ­£ç”Ÿæˆä¸€ç‰‡Tstringå†…å­˜ç©ºé—´,æ‰€ä»¥ç›¸åŒçš„é•¿å­—ç¬¦ä¸²ä¼šæœ‰ä¸åŒçš„å†…å­˜ç©ºé—´å‰¯æœ¬å­˜å‚¨,è¿™ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„\nç¼“å­˜ ä¸ºäº†æé«˜æŸ¥æ‰¾å‘½ä¸­ç‡,luaä½œè€…è¿˜ä½¿ç”¨hashMapè¿™ç§æ–¹å¼æ¥æé«˜å‘½ä¸­ç‡\nä¸‹å›¾ä¸­Næ˜¯æ•°ç»„è¡Œï¼ŒMæ˜¯æ•°ç»„åˆ—\niçš„ä¸‹æ ‡å€¼é€šè¿‡unsigned int i = point2uint(str) % STRCACHE_Næ±‚å¾—\njçš„æœ€å¤§å€¼å›ºå®šå°±æ˜¯ä¸‹é¢çš„å®å‡½æ•° STRCACHE_M 2\né‰´äºç¯‡å¹…é•¿åº¦,åé¢ä¼šä¸“é—¨å‡ºä¸€ç¯‡æ–‡ç« è¯¦ç»†çš„è®²è§£luaçš„stringé‡Œé‡Œå¤–å¤–\nLUA_TTABLE è¡¨ lua çš„tableæ˜¯ä¸ªå¾ˆç¥å¥‡çš„ç»“æ„,ä»–æ˜¯hash,æ•°ç»„çš„æ··åˆä½“,é€šè¿‡tableå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æ¨¡å—,å…ƒè¡¨,ç¯å¢ƒ,é¢å‘å¯¹è±¡,stl,ç­‰ç­‰åŠŸèƒ½\ntableçš„æºç ç»“æ„\nç»“æ„ç¤ºæ„å›¾\nè¯¦ç»†è§£é‡Š,ä¼šåœ¨å•ç‹¬å‡ºä¸€ç¯‡æ–‡ç« \nLUA_TTHREAD threadå³ä¸ºçº¿ç¨‹,ä½†æ˜¯åœ¨luaä¸­æ˜¯æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µçš„ï¼Œè¿™ä¸ªçº¿ç¨‹å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹,è€Œæ›´å¤šçš„æ˜¯ä¸€ä¸ªèƒ½å‚¨å­˜è¿è¡ŒçŠ¶æ€çš„æ•°æ®ç»“æ„,è¿™ä¸ªç»“æ„æ›´å¤šçš„æ˜¯ç»™åç¨‹**coroutine**ä½¿ç”¨çš„\nçº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ« çº¿ç¨‹æ¶ˆè€—æ“ä½œç³»ç»Ÿèµ„æºï¼Œåç¨‹å¯ä»¥é ç¼–è¯‘è¯­è¨€å®ç°ï¼Œå› æ­¤ç§°ä¸ºç”¨æˆ·æ€çº¿ç¨‹é‡çº§æ›´è½» çº¿ç¨‹å¹¶è¡Œï¼Œåç¨‹å¹¶å‘ çº¿ç¨‹åŒæ­¥ï¼Œåç¨‹å¼‚æ­¥ çº¿ç¨‹æŠ¢å å¼ï¼Œåç¨‹éæŠ¢å å¼ï¼Œéœ€è¦æ‰‹åŠ¨åˆ‡æ¢ çº¿ç¨‹ä¸Šåƒï¼Œåç¨‹ä¸Šä¸‡ çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåç¨‹åˆ‡æ¢ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåªåœ¨ç”¨æˆ·æ€è¿›è¡Œåˆ‡æ¢ æºç ç»“æ„\n/// @brief Lua ä¸»çº¿ç¨‹æ ˆ æ•°æ®ç»“æ„ ///ä½œç”¨ï¼šç®¡ç†æ•´ä¸ªæ ˆå’Œå½“å‰å‡½æ•°ä½¿ç”¨çš„æ ˆçš„æƒ…å†µï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å‡½æ•°è°ƒç”¨ä»¥åŠå’Œcçš„é€šä¿¡ struct lua_State { CommonHeader; lu_byte status;//å½“å‰çŠ¶æ€æœºçš„çŠ¶æ€,LUA_YIELDå’ŒLUA_OKä¸ºlua_StateçŠ¶æ€æœºçš„çŠ¶æ€,è¿™ä¸¤ä¸ªçŠ¶æ€å’Œåç¨‹æœ‰è¿™å¯¹åº”å…³ç³»,è¯¦è§auxstatuså‡½æ•° lu_byte allowhook;//æ˜¯å¦å…è®¸hook unsigned short nci; /* number of items in 'ci' list *///ciåˆ—è¡¨ä¸­çš„æ¡ç›®æ•°ï¼Œå­˜å‚¨ä¸€å…±å¤šå°‘ä¸ªCallInfo StkId top; /* first free slot in the stack *///æŒ‡å‘æ ˆçš„é¡¶éƒ¨ï¼Œå‹å…¥æ•°æ®ï¼Œéƒ½é€šè¿‡ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆæ¥å®ç° global_State *l_G;//å…¨å±€çŠ¶æ€æœºï¼Œç»´æŠ¤å…¨å±€å­—ç¬¦ä¸²è¡¨ã€å†…å­˜ç®¡ç†å‡½æ•°ã€gcç­‰ä¿¡æ¯ CallInfo *ci; /* call info for current function *///å½“å‰è¿è¡Œå‡½æ•°ä¿¡æ¯ StkId stack_last; /* end of stack (last element + 1) *///æ‰§è¡Œlua stackæœ€åä¸€ä¸ªç©ºé—²çš„slot StkId stack; /* stack base *///stackåŸºåœ°å€ UpVal *openupval; /* list of open upvalues in this stack */// upvalues opençŠ¶æ€æ—¶å€™çš„çš„é“¾è¡¨ StkId tbclist; /* list of to-be-closed variables *///æ­¤å †æ ˆä¸­æ‰€æœ‰æ´»åŠ¨çš„å°†è¦å…³é—­çš„å˜é‡çš„åˆ—è¡¨ GCObject *gclist;//GCåˆ—è¡¨ struct lua_State *twups; /* list of threads with open upvalues *///twups é“¾è¡¨ æ‰€æœ‰å¸¦æœ‰ open upvalue çš„ thread éƒ½ä¼šæ”¾åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œè¿™æ ·æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„éå† thread çš„é€”å¾„ï¼Œå¹¶ä¸”æ’é™¤æ‰äº†æ²¡æœ‰ open upvalue çš„ thread struct lua_longjmp *errorJmp; /* current error recover point *///å‘ç”Ÿé”™è¯¯çš„é•¿è·³è½¬ä½ç½®ï¼Œç”¨äºè®°å½•å½“å‡½æ•°å‘ç”Ÿé”™è¯¯æ—¶è·³è½¬å‡ºå»çš„ä½ç½® CallInfo base_ci; /* CallInfo for first level (C calling Lua) *///æŒ‡å‘å‡½æ•°è°ƒç”¨æ ˆçš„æ ˆåº• volatile lua_Hook hook;//ç”¨æˆ·æ³¨å†Œçš„hookå›è°ƒå‡½æ•° ptrdiff_t errfunc; /* current error handling function (stack index) *///å‘ç”Ÿé”™è¯¯çš„å›è°ƒå‡½æ•° l_uint32 nCcalls; /* number of nested (non-yieldable | C) calls */// å½“å‰Cå‡½æ•°çš„è°ƒç”¨çš„æ·±åº¦ int oldpc; /* last pc traced *///æœ€åä¸€æ¬¡æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½ç½® int basehookcount;//ç”¨æˆ·è®¾ç½®çš„æ‰§è¡ŒæŒ‡ä»¤æ•°ï¼ˆåœ¨hookmask=LUA_MASK_COUNTç”Ÿæ•ˆï¼‰ int hookcount;//è¿è¡Œæ—¶ï¼Œè·‘äº†å¤šå°‘æ¡æŒ‡ä»¤ volatile l_signalT hookmask;//æ”¯æŒé‚£äº›hookèƒ½åŠ› }; è¯¦ç»†è§£é‡Š,ä¼šåœ¨å•ç‹¬å‡ºä¸€ç¯‡æ–‡ç« \nå€¼å¯¹è±¡ç»“æ„ /// @brief å®é™…å­˜å‚¨çš„å€¼ // GCObjectå’Œå…¶ä»–ä¸éœ€è¦è¿›è¡Œè¿›è¡ŒGCçš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªè”åˆä½“é‡Œé¢æ„æˆäº†Valueç±»å‹ // lua5.3ä»¥å numberç±»å‹å°±æœ‰äº†ä¸¤ä¸ªç±»å‹floatå’Œint ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ lua_Number nå’Œ lua_Integer i typedef union Value { struct GCObject *gc; /* collectable objects */// å¯å›æ”¶çš„å¯¹è±¡ /*ä¸‹é¢éƒ½æ˜¯ä¸å¯å›æ”¶ç±»å‹*/ void *p; /* light userdata *///è½»é‡çº§userdata lua_CFunction f; /* light C functions *///å‡½æ•°æŒ‡é’ˆ ä¾‹å¦‚ï¼ˆtypedef int (*lua_CFunction)(lua_State *L)ï¼‰ lua_Integer i; /* integer numbers *///æ•´å‹ cä¸­çš„longlongï¼Œå ç”¨8ä¸ªå­—èŠ‚ lua_Number n; /* float numbers *///æµ®ç‚¹ç±»å‹ cä¸­çš„doubleï¼Œå ç”¨8ä¸ªå­—èŠ‚ } Value; å˜é‡ è¯´æ˜ GCObject gc ç”¨äºåƒåœ¾å›æ”¶ ä¸»è¦æ˜¯ä¸ºäº†è¿æ¥åƒåœ¾å›æ”¶å¯¹è±¡çš„äº’ç›¸å¼•ç”¨å…³ç³» void *p ä¸ºcä¸­ä¼ å…¥çš„æŒ‡é’ˆï¼Œç”±c åˆ†é…å’Œé‡Šæ”¾ light userdata lua_CFunction f è¡¨ç¤ºCå¯¼å‡ºç»™luaçš„å‡½æ•°æŒ‡é’ˆï¼Œtypedef int (*lua_CFunction) (lua_State *L) lua_Integer i è¡¨ç¤ºæ•´æ•°ç±»å‹ï¼Œtypedef long long lua_Integer lua_Number n è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹ç±»å‹ï¼Œtypedef double lua_Number éGCå¯¹è±¡ ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°éGCçš„å¯¹è±¡æœ‰4ä¸­\nlight userdata Cå‡½æ•° æ•´å‹ æµ®ç‚¹å‹ int b(lua 5.4æ•°å­—åˆ†ä¸ºæ•´æ•°å’Œæµ®ç‚¹ï¼Œè€Œiæ­£å¥½ä¹Ÿå¯ä»¥ç”¨ä½œbool,æ‰€ä»¥æŠŠè¿™ä¸ªç»™**åˆ é™¤**,å’Œ lua_Integer i ç»“åˆåˆ°ä¸€èµ·äº†) GCå¯¹è±¡ union GCUnion { GCObject gc; /* common header */ struct TString ts;//å­—ç¬¦ä¸² struct Udata u;//ç”¨æˆ·æ•°æ® union Closure cl;//é—­åŒ… struct Table h;//è¡¨ struct Proto p;//å‡½æ•°åŸå‹:å­˜æ”¾å‡½æ•°å­—èŠ‚ç ä¿¡æ¯ struct lua_State th; /* thread *///çº¿ç¨‹ struct UpVal upv;//ä¸Šå€¼ }; ä»ä¸Šé¢çš„unionç»“æ„ä½“å¯ä»¥çœ‹åˆ°GCå¯¹è±¡æœ‰6ä¸­\nå­—ç¬¦ä¸² userdata closure é—­åŒ… table lua å‡½æ•°åŸå‹ lua çº¿ç¨‹ (å…¶å®å°±æ˜¯åç¨‹) luaä¸Šå€¼ CommonHeaderç±»å‹ #define CommonHeader\tstruct GCObject *next; lu_byte tt; lu_byte marked next æŒ‡é’ˆ æŒ‡å‘ä¸‹ä¸€ä¸ªGCå¯¹è±¡ tt GCå¯¹è±¡çš„å®é™…ç±»å‹(æ¯”å¦‚ä¸Šé¢6ä¸­GCå¯¹è±¡) marked æ ‡è¯†GCçš„çŠ¶æ€ TValuefields ç±»å‹ #define TValuefields Value value_; int tt_ Valueï¼šå­˜å‚¨å…·ä½“æ•°æ®çš„å€¼ tt_ï¼šè¡¨ç¤ºè¿™ä¸ªå€¼çš„ç±»å‹ï¼Œå³æ‰€æœ‰çš„åŸºç¡€æ•°æ®ç±»å‹ ",
  "wordCount" : "3853",
  "inLanguage": "en",
  "image":"https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/image-20230123132152317.png","datePublished": "2023-01-24T01:30:29+08:00",
  "dateModified": "2023-01-24T01:30:29+08:00",
  "author":[{
    "@type": "Person",
    "name": "frog"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "frog's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frog-game.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://frog-game.github.io/" accesskey="h" title="frog&#39;s Blog (Alt + H)">
            <img src="https://frog-game.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">frog&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://frog-game.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://frog-game.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/read/">ğŸ“• é˜…è¯»</a></div>
            <h1 class="post-title">
                [Lua5.4.4æºç ]æ•°æ®ç±»å‹
            </h1>
            <div class="post-description">
                luaæºç æ•°æ®ç±»å‹åˆ†æ
            </div>
            <div class="post-meta">åˆ›å»º:&nbsp;<span title='2023-01-24 01:30:29 +0800 CST'>2023-01-24</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2023-01-24&nbsp;|&nbsp;å­—æ•°:&nbsp;3853å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;8åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;frog



                &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://frog-game.github.io/tags/lua5.4.4%E6%BA%90%E7%A0%81/">Lua5.4.4æºç </a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| è®¿é—®: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://frog-game.github.io/posts/read/lua5.4.4shujuleixing/image-20230123132152317.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#lua_tnil" aria-label="LUA_TNIL">LUA_TNIL</a></li>
                <li>
                    <a href="#lua_tboolean" aria-label="LUA_TBOOLEAN">LUA_TBOOLEAN</a></li>
                <li>
                    <a href="#lua_tlightuserdata-%e5%92%8c-lua_tuserdata" aria-label="LUA_TLIGHTUSERDATA å’Œ LUA_TUSERDATA">LUA_TLIGHTUSERDATA å’Œ LUA_TUSERDATA</a><ul>
                        
                <li>
                    <a href="#lua_tuserdata" aria-label="LUA_TUSERDATA">LUA_TUSERDATA</a><ul>
                        
                <li>
                    <a href="#lua_tuserdata%e5%ae%9e%e7%8e%b0%e4%be%8b%e5%ad%90" aria-label="LUA_TUSERDATAå®ç°ä¾‹å­">LUA_TUSERDATAå®ç°ä¾‹å­</a></li></ul>
                </li>
                <li>
                    <a href="#lua_tlightuserdata" aria-label="LUA_TLIGHTUSERDATA">LUA_TLIGHTUSERDATA</a><ul>
                        
                <li>
                    <a href="#%e4%bd%93%e5%a4%96%e8%af%9d%e4%b8%ba%e4%bb%80%e4%b9%88%e6%9c%89%e6%97%b6%e5%80%99%e7%94%a8cjson%e5%8e%bb%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e7%9a%84%e6%97%b6%e5%80%99%e8%83%bd%e7%9c%8b%e5%88%b0%e6%89%93%e5%8d%b0table%e9%87%8c%e9%9d%a2%e7%9a%84%e5%80%bc%e5%b1%85%e7%84%b6%e6%98%afnull" aria-label="ä½“å¤–è¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ç”¨CJSONå»ååºåˆ—åŒ–çš„æ—¶å€™èƒ½çœ‹åˆ°æ‰“å°tableé‡Œé¢çš„å€¼å±…ç„¶æ˜¯null">ä½“å¤–è¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ç”¨<code>CJSON</code>å»ååºåˆ—åŒ–çš„æ—¶å€™èƒ½çœ‹åˆ°æ‰“å°<code>table</code>é‡Œé¢çš„å€¼å±…ç„¶æ˜¯<code>null</code></a></li>
                <li>
                    <a href="#lua_tlightuserdata%e5%ae%9e%e7%8e%b0%e4%be%8b%e5%ad%90" aria-label="LUA_TLIGHTUSERDATAå®ç°ä¾‹å­">LUA_TLIGHTUSERDATAå®ç°ä¾‹å­</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#lua_tnumber" aria-label="LUA_TNUMBER">LUA_TNUMBER</a></li>
                <li>
                    <a href="#lua_tstring" aria-label="LUA_TSTRING">LUA_TSTRING</a><ul>
                        
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e7%bb%93%e6%9e%84" aria-label="å­—ç¬¦ä¸²ç»“æ„"><strong>å­—ç¬¦ä¸²ç»“æ„</strong></a></li>
                <li>
                    <a href="#%e5%ad%98%e5%82%a8%e4%bd%8d%e7%bd%ae" aria-label="å­˜å‚¨ä½ç½®">å­˜å‚¨ä½ç½®</a><ul>
                        
                <li>
                    <a href="#%e7%9f%ad%e5%ad%97%e7%ac%a6%e4%b8%b2" aria-label="çŸ­å­—ç¬¦ä¸²">çŸ­å­—ç¬¦ä¸²</a></li>
                <li>
                    <a href="#%e9%95%bf%e5%ad%97%e7%ac%a6%e4%b8%b2" aria-label="é•¿å­—ç¬¦ä¸²">é•¿å­—ç¬¦ä¸²</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%93%e5%ad%98" aria-label="ç¼“å­˜">ç¼“å­˜</a></li></ul>
                </li>
                <li>
                    <a href="#lua_ttable-%e8%a1%a8" aria-label="LUA_TTABLE è¡¨">LUA_TTABLE è¡¨</a></li>
                <li>
                    <a href="#lua_tthread" aria-label="LUA_TTHREAD">LUA_TTHREAD</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e5%92%8c%e5%8d%8f%e7%a8%8b%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«">çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%80%bc%e5%af%b9%e8%b1%a1%e7%bb%93%e6%9e%84" aria-label="å€¼å¯¹è±¡ç»“æ„">å€¼å¯¹è±¡ç»“æ„</a><ul>
                        
                <li>
                    <a href="#%e9%9d%9egc%e5%af%b9%e8%b1%a1" aria-label="éGCå¯¹è±¡">éGCå¯¹è±¡</a></li>
                <li>
                    <a href="#gc%e5%af%b9%e8%b1%a1" aria-label="GCå¯¹è±¡">GCå¯¹è±¡</a></li>
                <li>
                    <a href="#commonheader%e7%b1%bb%e5%9e%8b" aria-label="CommonHeaderç±»å‹">CommonHeaderç±»å‹</a></li>
                <li>
                    <a href="#tvaluefields-%e7%b1%bb%e5%9e%8b" aria-label="TValuefields ç±»å‹">TValuefields ç±»å‹</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="lua_tnil"><span>LUA_TNIL</span></h2>
<ol>
<li><code>nil</code>è¡¨ç¤ºçš„æ„æ€å°±æ˜¯æ— æ•ˆå€¼</li>
<li>å¦‚æœèµ‹å€¼ä¸º<code>nil</code>,ç­‰ä»·äºå°±æ˜¯åˆ é™¤,åˆ°æ—¶å€™<code>GC</code>åˆ¤æ–­æ²¡æœ‰ä»»ä½•å…³è”,å°±ä¼šæŠŠè¿™ä¸ªå€¼å›æ”¶</li>
<li><code>LUA_TNIL</code> é™¤äº†å®šä¹‰å¯¹å¤–çš„<code>LUA_VNIL nilç±»å‹</code>,è¿˜ä¼šåˆ†ä¸º<code>{LUA_VEMPTY:,LUA_VABSTKEY}</code>è¿™ä¸¤ä¸ªä¸œè¥¿ä¸å¯¹å¤–,ç”¨äº<code>C</code>å±‚é€»è¾‘çš„åˆ¤æ–­
<ul>
<li><code>LUA_VEMPTY</code>: ç©ºæ§½ä½, <code>C</code>å±‚ç”¨æ¥å ä½å’Œæ¸…é™¤é€»è¾‘</li>
<li><code>LUA_VABSTKEY</code>:<code>C</code>å±‚ç”¨æ¥æŸ¥æ‰¾<code>Key</code>æ—¶å€™æ‰¾ä¸åˆ°çš„æ—¶å€™è¿”å›ç±»å‹</li>
</ul>
</li>
</ol>
<h2 id="lua_tboolean"><span>LUA_TBOOLEAN</span></h2>
<ol>
<li>
<p>åœ¨<code>lua</code>é‡Œé¢<code>0ä¹Ÿæ˜¯çœŸå€¼</code>,è¿™ç‚¹å’Œå…¶ä»–è¯­è¨€æ¯”å¦‚<code>C/C++</code>ç­‰ç­‰è¯­è¨€ä¸ä¸€æ ·,è¦æ³¨æ„</p>
<ul>
<li>
<p><code>0</code>:çœŸ</p>
</li>
<li>
<p><code>nil</code>:å‡</p>
</li>
<li>
<p><code>false</code>:å‡</p>
</li>
<li>
<p><code>å…¶ä»–å€¼</code>:çœŸ</p>
</li>
</ul>
</li>
</ol>
<h2 id="lua_tlightuserdata-å’Œ-lua_tuserdata"><span>LUA_TLIGHTUSERDATA å’Œ LUA_TUSERDATA</span></h2>
<table>
<thead>
<tr>
<th>åŒºåˆ«</th>
<th><strong>LUA_TUSERDATA</strong></th>
<th>LUA_TLIGHTUSERDATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½œç”¨</td>
<td>é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„ç»“æ„ä½“ä¸€å°æ®µå›ºå®šçš„å†…å­˜åŒºåŸŸ</td>
<td>é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„æŒ‡é’ˆ(void *)</td>
</tr>
<tr>
<td>å†…å­˜ç®¡ç†</td>
<td>ç”±Luaçš„åƒåœ¾å›æ”¶å™¨ç®¡ç†</td>
<td>ä½¿ç”¨è€…éœ€è¦å…³å¿ƒå…¶å†…å­˜</td>
</tr>
<tr>
<td>å…ƒè¡¨</td>
<td>æœ‰ç‹¬ç«‹çš„å…ƒè¡¨</td>
<td>æ²¡æœ‰ç‹¬ç«‹çš„å…ƒè¡¨</td>
</tr>
<tr>
<td>åˆ›å»º</td>
<td>void *lua_newuserdata(lua_State *L, size_t size)</td>
<td>lua_pushlightuserdata(lua_State *L, void *p);</td>
</tr>
</tbody>
</table>
<p>å…·ä½“åŒºåˆ«å…¶å®æˆ‘ä»¬åœ¨<code>lua</code>æºç ä¸­ä¹Ÿèƒ½æ‰¾åˆ°åŒºåˆ«</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123103128853.png" alt="image-20230123103128853"  />
</p>
<p>æˆ‘ä»¬åœ¨æºç ä¸­æ‰¾åˆ°äº†è¿™æ®µä»£ç å¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ®ç±»å‹è¿”å›äº†<code>1</code>å’Œ<code>2</code>ä¸¤ä¸ªä¸åŒçš„åœ°å€</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥è¯´<code>LUA_TUSERDATA</code></p>
<h3 id="lua_tuserdata"><span>LUA_TUSERDATA</span></h3>
<p><code>1</code>å¤„æˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªå®,å¯ä»¥çœ‹åˆ°å…¶å®æ˜¯è¿”å›çš„æ˜¯ä¸€å—å®å®åœ¨åœ¨çš„å†…å­˜åœ°å€</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">///è®¡ç®—ç”¨æˆ·æ•°æ®çš„å†…å­˜åŒºåŸŸçš„åç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// offsetofæ˜¯ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#000080">#define udatamemoffset(nuv) \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">	((nuv) == 0 ? offsetof(Udata0, bindata)  \
</span></span></span><span style="display:flex;"><span><span style="color:#000080">                    : offsetof(Udata, uv) + (sizeof(UValue) * (nuv)))
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>
</span></span><span style="display:flex;"><span><span style="color:#000080">#define getudatamem(u)	(cast_charp(u) + udatamemoffset((u)-&gt;nuvalue)) </span><span style="color:#000080">//è¿”å›å†…å­˜å—çš„åœ°å€
</span></span></span></code></pre></div><p>ä»ä¸‹å›¾ä¸­æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°<code>LUA_TUSERDATA</code>é‡Œé¢æœ‰ ç‹¬ç«‹å…ƒè¡¨</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123103834850.png" alt="image-20230123103834850"  />
</p>
<h4 id="lua_tuserdataå®ç°ä¾‹å­"><span>LUA_TUSERDATAå®ç°ä¾‹å­</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">//cæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#000080">//#include &lt;string.h&gt;  
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lua.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lauxlib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#000080">#include</span> <span style="color:#000080">&#34;lualib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;iostream&gt;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#cdcd00">struct</span> StudentTag
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">char</span> <span style="color:#39c">*</span>strName; <span style="color:#000080">// å­¦ç”Ÿå§“å
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#00cd00">char</span> <span style="color:#39c">*</span>strNum; <span style="color:#000080">// å­¦å·
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#00cd00">int</span> iSex; <span style="color:#000080">// å­¦ç”Ÿæ€§åˆ«
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#00cd00">int</span> iAge; <span style="color:#000080">// å­¦ç”Ÿå¹´é¾„
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> Student(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">size_t</span> iBytes <span style="color:#39c">=</span> <span style="color:#cdcd00">sizeof</span>(<span style="color:#cdcd00">struct</span> StudentTag);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>pStudent;
</span></span><span style="display:flex;"><span>	pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>)lua_newuserdata(L, iBytes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	 <span style="color:#000080">//è®¾ç½®å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_getmetatable(L, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_setmetatable(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">//lua_pushnumber(L, 123);
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>; <span style="color:#000080">// æ–°çš„userdataå·²ç»åœ¨æ ˆä¸Šäº†
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetName(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_pushstring(L, pStudent<span style="color:#39c">-&gt;</span>strName);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetName(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯userdata
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">const</span> <span style="color:#00cd00">char</span> <span style="color:#39c">*</span>pName <span style="color:#39c">=</span> luaL_checkstring(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	luaL_argcheck(L, pName <span style="color:#39c">!=</span> <span style="color:#cd00cd">NULL</span> <span style="color:#39c">&amp;&amp;</span> pName <span style="color:#39c">!=</span> <span style="color:#cd0000">&#34;&#34;</span>, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;Wrong Parameter&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pStudent<span style="color:#39c">-&gt;</span>strName <span style="color:#39c">=</span>(<span style="color:#00cd00">char</span><span style="color:#39c">*</span>) pName;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetAge(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>	lua_pushinteger(L, pStudent<span style="color:#39c">-&gt;</span>iAge);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetAge(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>pStudent <span style="color:#39c">=</span> (<span style="color:#cdcd00">struct</span> StudentTag <span style="color:#39c">*</span>)luaL_checkudata(L, <span style="color:#cd00cd">1</span>, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> iAge <span style="color:#39c">=</span> luaL_checkinteger(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	luaL_argcheck(L, iAge <span style="color:#39c">&gt;=</span> <span style="color:#cd00cd">6</span> <span style="color:#39c">&amp;&amp;</span> iAge <span style="color:#39c">&lt;=</span> <span style="color:#cd00cd">100</span>, <span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;Wrong Parameter&#34;</span>);
</span></span><span style="display:flex;"><span>	pStudent<span style="color:#39c">-&gt;</span>iAge <span style="color:#39c">=</span> iAge;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetSex(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// è¿™é‡Œç”±ä½ æ¥è¡¥å……
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetSex(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// è¿™é‡Œç”±ä½ æ¥è¡¥å……
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> GetNum(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// è¿™é‡Œç”±ä½ æ¥è¡¥å……
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> SetNum(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// è¿™é‡Œç”±ä½ æ¥è¡¥å……
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span>  luaL_Reg arrayFunc_meta[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getName&#34;</span>, GetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setName&#34;</span>, SetName },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getAge&#34;</span>, GetAge },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setAge&#34;</span>, SetAge },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getSex&#34;</span>, GetSex },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setSex&#34;</span>, SetSex },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;getNum&#34;</span>, GetNum },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;setNum&#34;</span>, SetNum },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> luaL_Reg arrayFunc[] <span style="color:#39c">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;new&#34;</span>, Student},
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span>  _declspec(dllexport) <span style="color:#00cd00">int</span> luaopen_mytestlib(lua_State <span style="color:#39c">*</span>L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	luaL_newmetatable(L, <span style="color:#cd0000">&#34;Student&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#000080">// å…ƒè¡¨.__index = å…ƒè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setfield(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;__index&#34;</span>);
</span></span><span style="display:flex;"><span>	luaL_setfuncs(L, arrayFunc_meta, <span style="color:#cd00cd">0</span>);
</span></span><span style="display:flex;"><span>	luaL_newlib(L, arrayFunc);
</span></span><span style="display:flex;"><span>	lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	lua_setglobal(L, <span style="color:#cd0000">&#34;Sdudent&#34;</span>); <span style="color:#000080">/* the module name */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#39c">--</span> lua <span style="">æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>require <span style="color:#cd0000">&#34;mytestlib&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local objStudent <span style="color:#39c">=</span> Sdudent.new()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objStudent:setName(<span style="color:#cd0000">&#34;æœå†»&#34;</span>)
</span></span><span style="display:flex;"><span>local strName <span style="color:#39c">=</span> objStudent:getName()
</span></span><span style="display:flex;"><span>print(strName )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">for</span> k,v in pairs(getmetatable(objStudent)) <span style="color:#cdcd00">do</span>
</span></span><span style="display:flex;"><span>	print(tostring(k),tostring(v))
</span></span><span style="display:flex;"><span>end
</span></span></code></pre></div><h3 id="lua_tlightuserdata"><span>LUA_TLIGHTUSERDATA</span></h3>
<p><code>2</code>å¤„æˆ‘ä»¬è¿”å›çš„ä¹Ÿæ˜¯ä¸ªå®</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define pvalue(o)	check_exp(ttislightuserdata(o), val_(o).p) </span><span style="color:#000080">//è·å–light userdataçš„æŒ‡é’ˆ
</span></span></span></code></pre></div><p>è¿›ä¸€æ­¥è¿½è¸ªæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>p</code>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯è¿™ä¸ªç»“æ„ä½“,é‡Œé¢å¹¶æ²¡æœ‰å…ƒè¡¨ç›¸å…³çš„å®ç°,æ‰€ä»¥åé¢å…ƒè¡¨ç›¸å…³çš„å¤„ç†éƒ½å¾—æˆ‘ä»¬è‡ªå·±å¤„ç†</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123104539735.png" alt="image-20230123104539735"  />
</p>
<h4 id="ä½“å¤–è¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ç”¨cjsonå»ååºåˆ—åŒ–çš„æ—¶å€™èƒ½çœ‹åˆ°æ‰“å°tableé‡Œé¢çš„å€¼å±…ç„¶æ˜¯null"><span>ä½“å¤–è¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ç”¨<code>CJSON</code>å»ååºåˆ—åŒ–çš„æ—¶å€™èƒ½çœ‹åˆ°æ‰“å°<code>table</code>é‡Œé¢çš„å€¼å±…ç„¶æ˜¯<code>null</code></span></h4>
<p>æ¯”å¦‚è¿™æ ·çš„ç»“æœ</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>{<span style="color:#cd0000">&#34;key1&#34;</span><span style="color:#39c">:</span><span style="color:#cd0000">&#34;value&#34;</span>,<span style="color:#cd0000">&#34;key&#34;</span><span style="color:#39c">:</span>null,<span style="color:#cd0000">&#34;key2&#34;</span><span style="color:#39c">:</span><span style="color:#cd0000">&#34;value2&#34;</span>}
</span></span></code></pre></div><p>é¦–å…ˆçœ‹çœ‹<code>lua_pushlightuserdata</code>å®ç°</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123111513660.png" alt="image-20230123111513660"  />
</p>
<p>åœ¨çœ‹çœ‹<code>cjson.so</code>çš„å®ç°</p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>lua_newtable(L);
</span></span><span style="display:flex;"><span>lua_pushlightuserdata(L, <span style="color:#cd00cd">NULL</span>);
</span></span><span style="display:flex;"><span>lua_setfield(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>, <span style="color:#cd0000">&#34;null&#34;</span>);
</span></span></code></pre></div><p>æˆ‘ä»¬è¿›å…¥<code>lua_pushlightuserdata(L, NULL);</code>  ç„¶åçœ‹åˆ°äº† <code>setpvalue(L-&gt;top, p)</code>çš„è°ƒç”¨</p>
<p>è¿™æ ·åœ¨å®é™…è°ƒç”¨æ—¶,<code> setpvalue(L-&gt;top, p)</code> ç›¸å½“äº <code>void *p = NULL</code>  æœ€åæ˜¯è¢«å°è£…åˆ°<code>table</code>å˜é‡é‡Œè¿”å›çš„</p>
<p>è¿™ä¸ªç‚¹éœ€è¦æ³¨æ„å¾ˆå®¹æ˜“é€ æˆ<code>bug</code></p>
<h4 id="lua_tlightuserdataå®ç°ä¾‹å­"><span>LUA_TLIGHTUSERDATAå®ç°ä¾‹å­</span></h4>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">//Cæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;stdio.h&gt;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;string&gt;</span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&lt;iostream&gt;</span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">extern</span> <span style="color:#cd0000">&#34;C&#34;</span> {
</span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&#34;lua.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&#34;lualib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080">#include</span> <span style="color:#000080">&#34;lauxlib.h&#34;  </span><span style="color:#000080">
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>}
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">typedef</span> <span style="color:#cdcd00">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> x;
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> y;
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> z;
</span></span><span style="display:flex;"><span>}TData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span> <span style="color:#00cd00">int</span> getAttribute(lua_State<span style="color:#39c">*</span> L)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	TData <span style="color:#39c">*</span>data <span style="color:#39c">=</span> (TData<span style="color:#39c">*</span>)lua_touserdata(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	std<span style="color:#39c">::</span>string attribute <span style="color:#39c">=</span> luaL_checkstring(L, <span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> result <span style="color:#39c">=</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">if</span> (attribute <span style="color:#39c">==</span> <span style="color:#cd0000">&#34;x&#34;</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		result <span style="color:#39c">=</span> data<span style="color:#39c">-&gt;</span>x;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">else</span> <span style="color:#cdcd00">if</span> (attribute <span style="color:#39c">==</span> <span style="color:#cd0000">&#34;y&#34;</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		result <span style="color:#39c">=</span> data<span style="color:#39c">-&gt;</span>y;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		result <span style="color:#39c">=</span> data<span style="color:#39c">-&gt;</span>z;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	lua_pushnumber(L, result);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cdcd00">static</span>  luaL_Reg dataLib[] <span style="color:#39c">=</span> {
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd0000">&#34;__index&#34;</span>, getAttribute },
</span></span><span style="display:flex;"><span>	{ <span style="color:#cd00cd">NULL</span>, <span style="color:#cd00cd">NULL</span> }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">void</span> getMetaTable(lua_State<span style="color:#39c">*</span> L, luaL_Reg<span style="color:#39c">*</span> methods)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	lua_pushlightuserdata(L, methods);
</span></span><span style="display:flex;"><span>	lua_gettable(L, LUA_REGISTRYINDEX);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">if</span> (lua_isnil(L, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>)) {
</span></span><span style="display:flex;"><span>		<span style="color:#000080">/* not found */</span>
</span></span><span style="display:flex;"><span>		lua_pop(L, <span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		lua_newtable(L);
</span></span><span style="display:flex;"><span>		luaL_setfuncs(L, methods, <span style="color:#cd00cd">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		lua_pushlightuserdata(L, methods);
</span></span><span style="display:flex;"><span>		lua_pushvalue(L, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>		lua_settable(L, LUA_REGISTRYINDEX);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00cd00">int</span> main()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">const</span> <span style="color:#00cd00">char</span><span style="color:#39c">*</span> filename <span style="color:#39c">=</span> <span style="color:#cd0000">&#34;test.lua&#34;</span>;
</span></span><span style="display:flex;"><span>	lua_State <span style="color:#39c">*</span>lua <span style="color:#39c">=</span> luaL_newstate();
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">if</span> (lua <span style="color:#39c">==</span> <span style="color:#cd00cd">NULL</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		fprintf(stderr, <span style="color:#cd0000">&#34;open lua failed&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#cdcd00">return</span> <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	luaL_openlibs(lua);
</span></span><span style="display:flex;"><span>	TData input <span style="color:#39c">=</span> { <span style="color:#cd00cd">123</span>, <span style="color:#cd00cd">231</span>, <span style="color:#cd00cd">321</span> };
</span></span><span style="display:flex;"><span>	lua_pushlightuserdata(lua, <span style="color:#39c">&amp;</span>input);
</span></span><span style="display:flex;"><span>	getMetaTable(lua, dataLib);
</span></span><span style="display:flex;"><span>	lua_setmetatable(lua, <span style="color:#39c">-</span><span style="color:#cd00cd">2</span>);
</span></span><span style="display:flex;"><span>	lua_setglobal(lua, <span style="color:#cd0000">&#34;input&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">if</span> (luaL_dofile(lua, filename))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#000080">//luaL_error(lua, &#34;load file %s failed&#34;, filename);
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>	}
</span></span><span style="display:flex;"><span>	lua_getglobal(lua, <span style="color:#cd0000">&#34;data&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#00cd00">int</span> output <span style="color:#39c">=</span> lua_tointeger(lua, <span style="color:#39c">-</span><span style="color:#cd00cd">1</span>);
</span></span><span style="display:flex;"><span>	std<span style="color:#39c">::</span>cout <span style="color:#39c">&lt;&lt;</span> output <span style="color:#39c">&lt;&lt;</span> std<span style="color:#39c">::</span>endl;
</span></span><span style="display:flex;"><span>	<span style="color:#cdcd00">return</span> <span style="color:#cd00cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#39c">--</span>lua<span style="">æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>data <span style="color:#39c">=</span> input.x;
</span></span><span style="display:flex;"><span>print(data)
</span></span></code></pre></div><h2 id="lua_tnumber"><span>LUA_TNUMBER</span></h2>
<p><code>lua5.3ä»¥å</code>å·²ç»æŠŠè¿™ä¸ªæ•°å€¼ç±»å‹åˆ†ä¸ºäº†<code>2</code>ä¸­ç±»å‹</p>
<ul>
<li><code>LUA_VNUMINT</code> æ•´æ•°ç±»å‹ å…¶å®å°±æ˜¯cä¸­çš„<code>longlong</code>,å ç”¨<code>8</code>ä¸ªå­—èŠ‚</li>
<li><code>LUA_VNUMFLT</code> æµ®ç‚¹ç±»å‹ å…¶å®å°±æ˜¯cä¸­çš„<code>double</code>,å ç”¨<code>8</code>ä¸ªå­—èŠ‚</li>
</ul>
<p>å¯¹åº”çš„æºç å¦‚ä¸‹</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123112120451.png" alt="image-20230123112120451"  />
</p>
<h2 id="lua_tstring"><span>LUA_TSTRING</span></h2>
<p><code>lua5.4</code>å°†<code>string</code>åˆ†ä¸ºäº†ä¸¤ç§</p>
<p><code>LUA_VSHRSTR</code>:çŸ­å­—ç¬¦ä¸²</p>
<ul>
<li>å°äºç­‰äº<code>40</code>å­—èŠ‚çš„</li>
<li><code>hash</code>å€¼æ˜¯åœ¨åˆ›å»ºæ—¶å°±è®¡ç®—å‡ºæ¥çš„</li>
</ul>
<p><code>LUA_VLNGSTR</code> é•¿å­—ç¬¦ä¸²</p>
<ul>
<li>å¤§äº<code>40</code>å­—èŠ‚çš„å°±æ˜¯é•¿å­—ç¬¦ä¸²</li>
<li>çœŸæ­£éœ€è¦å®ƒçš„hashå€¼æ—¶ï¼Œæ‰ä¼šæ‰‹åŠ¨è°ƒç”¨<code>luaS_hashlongstr</code>å‡½æ•°ç”Ÿæˆè¯¥å€¼,<code>lua</code>å†…éƒ¨ç°åœ¨åªæœ‰åœ¨æŠŠé•¿ä¸²ä½œä¸º<code>table</code>çš„<code>key</code>æ—¶ï¼Œæ‰ä¼šå»è®¡ç®—å®ƒ</li>
</ul>
<h3 id="å­—ç¬¦ä¸²ç»“æ„"><span><strong>å­—ç¬¦ä¸²ç»“æ„</strong></span></h3>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123132740554.png" alt="image-20230123132740554"  />
</p>
<h3 id="å­˜å‚¨ä½ç½®"><span>å­˜å‚¨ä½ç½®</span></h3>
<h4 id="çŸ­å­—ç¬¦ä¸²"><span>çŸ­å­—ç¬¦ä¸²</span></h4>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123134046523.png" alt="image-20230123134046523"  />
</p>
<p>ç›¸åŒ<code>hash</code>å­—ç¬¦ä¸²å­˜å‚¨åœ¨ <code>stringtable strt</code> é“¾è¡¨ç»“æ„ä¸Š ä¸€èˆ¬<code>çŸ­å­—ç¬¦ä¸²</code>ä¼šä½¿ç”¨è¿™ç§æ–¹å¼å­˜å‚¨</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123162130402.png" alt="image-20230123162130402"  />
</p>
<h4 id="é•¿å­—ç¬¦ä¸²"><span>é•¿å­—ç¬¦ä¸²</span></h4>
<p>å› ä¸ºé•¿å­—ç¬¦ä¸²æ˜¯æƒ°æ€§ç”Ÿæˆçš„ï¼Œåªæœ‰åœ¨éœ€è¦<code>hash</code>å€¼å¾—æ—¶å€™æ‰ä¼šå»åˆ›å»º,æ‰€ä»¥ä¸ä¼šæƒ³çŸ­å­—ç¬¦ä¸²ä¸€æ ·å­˜åœ¨<code>global_State-&gt;strt</code>é‡Œé¢çš„,è€Œæ˜¯çœŸæ­£ç”Ÿæˆä¸€ç‰‡<code>Tstring</code>å†…å­˜ç©ºé—´,æ‰€ä»¥ç›¸åŒçš„é•¿å­—ç¬¦ä¸²ä¼šæœ‰ä¸åŒçš„å†…å­˜ç©ºé—´å‰¯æœ¬å­˜å‚¨,è¿™ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„</p>
<h3 id="ç¼“å­˜"><span>ç¼“å­˜</span></h3>
<p>ä¸ºäº†æé«˜æŸ¥æ‰¾å‘½ä¸­ç‡<code>,lu</code>aä½œè€…è¿˜ä½¿ç”¨<code>hashMap</code>è¿™ç§æ–¹å¼æ¥æé«˜å‘½ä¸­ç‡</p>
<p>ä¸‹å›¾ä¸­<code>N</code>æ˜¯æ•°ç»„è¡Œï¼Œ<code>M</code>æ˜¯æ•°ç»„åˆ—</p>
<p><code>i</code>çš„ä¸‹æ ‡å€¼é€šè¿‡<code>unsigned int i = point2uint(str) % STRCACHE_N</code>æ±‚å¾—</p>
<p><code>j</code>çš„æœ€å¤§å€¼å›ºå®šå°±æ˜¯ä¸‹é¢çš„å®å‡½æ•° <code>STRCACHE_M 2</code></p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/Typoraimage-20220405133449863.png" alt="Typoraimage-20220405133449863"  />
</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123163118382.png" alt="image-20230123163118382"  />
</p>
<p>é‰´äºç¯‡å¹…é•¿åº¦,åé¢ä¼šä¸“é—¨å‡ºä¸€ç¯‡æ–‡ç« è¯¦ç»†çš„è®²è§£<code>lua</code>çš„<code>string</code>é‡Œé‡Œå¤–å¤–</p>
<h2 id="lua_ttable-è¡¨"><span>LUA_TTABLE è¡¨</span></h2>
<p><code>lua</code> çš„<code>table</code>æ˜¯ä¸ªå¾ˆç¥å¥‡çš„ç»“æ„,ä»–æ˜¯<code>hash</code>,æ•°ç»„çš„æ··åˆä½“,é€šè¿‡<code>table</code>å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æ¨¡å—,å…ƒè¡¨,ç¯å¢ƒ,é¢å‘å¯¹è±¡,<code>stl</code>,ç­‰ç­‰åŠŸèƒ½</p>
<p><code>table</code>çš„æºç ç»“æ„</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230123170655933.png" alt="image-20230123170655933"  />
</p>
<p>ç»“æ„ç¤ºæ„å›¾</p>
<p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230125220102216.png" alt="image-20230125220102216"  />
</p>
<p>è¯¦ç»†è§£é‡Š,ä¼šåœ¨å•ç‹¬å‡ºä¸€ç¯‡æ–‡ç« </p>
<h2 id="lua_tthread"><span>LUA_TTHREAD</span></h2>
<p><code>thread</code>å³ä¸ºçº¿ç¨‹,ä½†æ˜¯åœ¨<code>lua</code>ä¸­æ˜¯æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µçš„ï¼Œè¿™ä¸ªçº¿ç¨‹å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹,è€Œæ›´å¤šçš„æ˜¯ä¸€ä¸ªèƒ½å‚¨å­˜è¿è¡ŒçŠ¶æ€çš„æ•°æ®ç»“æ„,è¿™ä¸ªç»“æ„æ›´å¤šçš„æ˜¯ç»™åç¨‹**<code>coroutine</code>**ä½¿ç”¨çš„</p>
<h3 id="çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«"><span>çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«</span></h3>
<ol>
<li>çº¿ç¨‹æ¶ˆè€—æ“ä½œç³»ç»Ÿèµ„æºï¼Œåç¨‹å¯ä»¥é ç¼–è¯‘è¯­è¨€å®ç°ï¼Œå› æ­¤ç§°ä¸ºç”¨æˆ·æ€çº¿ç¨‹é‡çº§æ›´è½»</li>
<li>çº¿ç¨‹å¹¶è¡Œï¼Œåç¨‹å¹¶å‘</li>
<li>çº¿ç¨‹åŒæ­¥ï¼Œåç¨‹å¼‚æ­¥</li>
<li>çº¿ç¨‹æŠ¢å å¼ï¼Œåç¨‹éæŠ¢å å¼ï¼Œéœ€è¦æ‰‹åŠ¨åˆ‡æ¢</li>
<li>çº¿ç¨‹ä¸Šåƒï¼Œåç¨‹ä¸Šä¸‡</li>
<li>çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåç¨‹åˆ‡æ¢ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåªåœ¨ç”¨æˆ·æ€è¿›è¡Œåˆ‡æ¢</li>
</ol>
<p><strong>æºç ç»“æ„</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">/// @brief Lua ä¸»çº¿ç¨‹æ ˆ æ•°æ®ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#000080">///ä½œç”¨ï¼šç®¡ç†æ•´ä¸ªæ ˆå’Œå½“å‰å‡½æ•°ä½¿ç”¨çš„æ ˆçš„æƒ…å†µï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å‡½æ•°è°ƒç”¨ä»¥åŠå’Œcçš„é€šä¿¡
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">struct</span> lua_State {
</span></span><span style="display:flex;"><span>  CommonHeader;
</span></span><span style="display:flex;"><span>  lu_byte status;<span style="color:#000080">//å½“å‰çŠ¶æ€æœºçš„çŠ¶æ€,LUA_YIELDå’ŒLUA_OKä¸ºlua_StateçŠ¶æ€æœºçš„çŠ¶æ€,è¿™ä¸¤ä¸ªçŠ¶æ€å’Œåç¨‹æœ‰è¿™å¯¹åº”å…³ç³»,è¯¦è§auxstatuså‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  lu_byte allowhook;<span style="color:#000080">//æ˜¯å¦å…è®¸hook
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#00cd00">unsigned</span> <span style="color:#00cd00">short</span> nci;  <span style="color:#000080">/* number of items in &#39;ci&#39; list */</span><span style="color:#000080">//ciåˆ—è¡¨ä¸­çš„æ¡ç›®æ•°ï¼Œå­˜å‚¨ä¸€å…±å¤šå°‘ä¸ªCallInfo
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  StkId top;  <span style="color:#000080">/* first free slot in the stack */</span><span style="color:#000080">//æŒ‡å‘æ ˆçš„é¡¶éƒ¨ï¼Œå‹å…¥æ•°æ®ï¼Œéƒ½é€šè¿‡ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆæ¥å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  global_State <span style="color:#39c">*</span>l_G;<span style="color:#000080">//å…¨å±€çŠ¶æ€æœºï¼Œç»´æŠ¤å…¨å±€å­—ç¬¦ä¸²è¡¨ã€å†…å­˜ç®¡ç†å‡½æ•°ã€gcç­‰ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  CallInfo <span style="color:#39c">*</span>ci;  <span style="color:#000080">/* call info for current function */</span><span style="color:#000080">//å½“å‰è¿è¡Œå‡½æ•°ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  StkId stack_last;  <span style="color:#000080">/* end of stack (last element + 1) */</span><span style="color:#000080">//æ‰§è¡Œlua stackæœ€åä¸€ä¸ªç©ºé—²çš„slot
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  StkId stack;  <span style="color:#000080">/* stack base */</span><span style="color:#000080">//stackåŸºåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  UpVal <span style="color:#39c">*</span>openupval;  <span style="color:#000080">/* list of open upvalues in this stack */</span><span style="color:#000080">// upvalues opençŠ¶æ€æ—¶å€™çš„çš„é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  StkId tbclist;  <span style="color:#000080">/* list of to-be-closed variables */</span><span style="color:#000080">//æ­¤å †æ ˆä¸­æ‰€æœ‰æ´»åŠ¨çš„å°†è¦å…³é—­çš„å˜é‡çš„åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  GCObject <span style="color:#39c">*</span>gclist;<span style="color:#000080">//GCåˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> lua_State <span style="color:#39c">*</span>twups;  <span style="color:#000080">/* list of threads with open upvalues */</span><span style="color:#000080">//twups é“¾è¡¨  æ‰€æœ‰å¸¦æœ‰ open upvalue çš„ thread éƒ½ä¼šæ”¾åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œè¿™æ ·æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„éå† thread çš„é€”å¾„ï¼Œå¹¶ä¸”æ’é™¤æ‰äº†æ²¡æœ‰ open upvalue çš„ thread
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> lua_longjmp <span style="color:#39c">*</span>errorJmp;  <span style="color:#000080">/* current error recover point */</span><span style="color:#000080">//å‘ç”Ÿé”™è¯¯çš„é•¿è·³è½¬ä½ç½®ï¼Œç”¨äºè®°å½•å½“å‡½æ•°å‘ç”Ÿé”™è¯¯æ—¶è·³è½¬å‡ºå»çš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  CallInfo base_ci;  <span style="color:#000080">/* CallInfo for first level (C calling Lua) */</span><span style="color:#000080">//æŒ‡å‘å‡½æ•°è°ƒç”¨æ ˆçš„æ ˆåº•
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">volatile</span> lua_Hook hook;<span style="color:#000080">//ç”¨æˆ·æ³¨å†Œçš„hookå›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#00cd00">ptrdiff_t</span> errfunc;  <span style="color:#000080">/* current error handling function (stack index) */</span><span style="color:#000080">//å‘ç”Ÿé”™è¯¯çš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  l_uint32 nCcalls;  <span style="color:#000080">/* number of nested (non-yieldable | C)  calls */</span><span style="color:#000080">// å½“å‰Cå‡½æ•°çš„è°ƒç”¨çš„æ·±åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#00cd00">int</span> oldpc;  <span style="color:#000080">/* last pc traced */</span><span style="color:#000080">//æœ€åä¸€æ¬¡æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#00cd00">int</span> basehookcount;<span style="color:#000080">//ç”¨æˆ·è®¾ç½®çš„æ‰§è¡ŒæŒ‡ä»¤æ•°ï¼ˆåœ¨hookmask=LUA_MASK_COUNTç”Ÿæ•ˆï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#00cd00">int</span> hookcount;<span style="color:#000080">//è¿è¡Œæ—¶ï¼Œè·‘äº†å¤šå°‘æ¡æŒ‡ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">volatile</span> l_signalT hookmask;<span style="color:#000080">//æ”¯æŒé‚£äº›hookèƒ½åŠ›
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>};
</span></span></code></pre></div><p>è¯¦ç»†è§£é‡Š,ä¼šåœ¨å•ç‹¬å‡ºä¸€ç¯‡æ–‡ç« </p>
<h2 id="å€¼å¯¹è±¡ç»“æ„"><span>å€¼å¯¹è±¡ç»“æ„</span></h2>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">/// @brief å®é™…å­˜å‚¨çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// GCObjectå’Œå…¶ä»–ä¸éœ€è¦è¿›è¡Œè¿›è¡ŒGCçš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªè”åˆä½“é‡Œé¢æ„æˆäº†Valueç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#000080">// lua5.3ä»¥å numberç±»å‹å°±æœ‰äº†ä¸¤ä¸ªç±»å‹floatå’Œint ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ lua_Number nå’Œ lua_Integer i
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span><span style="color:#cdcd00">typedef</span> <span style="color:#cdcd00">union</span> Value {
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">struct</span> GCObject <span style="color:#39c">*</span>gc;    <span style="color:#000080">/* collectable objects */</span><span style="color:#000080">// å¯å›æ”¶çš„å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#000080">/*ä¸‹é¢éƒ½æ˜¯ä¸å¯å›æ”¶ç±»å‹*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00cd00">void</span> <span style="color:#39c">*</span>p;         <span style="color:#000080">/* light userdata */</span><span style="color:#000080">//è½»é‡çº§userdata
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  lua_CFunction f; <span style="color:#000080">/* light C functions */</span><span style="color:#000080">//å‡½æ•°æŒ‡é’ˆ ä¾‹å¦‚ï¼ˆtypedef int (*lua_CFunction)(lua_State *L)ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  lua_Integer i;   <span style="color:#000080">/* integer numbers */</span><span style="color:#000080">//æ•´å‹  cä¸­çš„longlongï¼Œå ç”¨8ä¸ªå­—èŠ‚
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  lua_Number n;    <span style="color:#000080">/* float numbers */</span><span style="color:#000080">//æµ®ç‚¹ç±»å‹ cä¸­çš„doubleï¼Œå ç”¨8ä¸ªå­—èŠ‚ 
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>} Value;
</span></span></code></pre></div><table>
<thead>
<tr>
<th><strong>å˜é‡</strong></th>
<th><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GCObject gc</strong></td>
<td>ç”¨äºåƒåœ¾å›æ”¶ ä¸»è¦æ˜¯ä¸ºäº†è¿æ¥åƒåœ¾å›æ”¶å¯¹è±¡çš„äº’ç›¸å¼•ç”¨å…³ç³»</td>
</tr>
<tr>
<td><strong>void *p</strong></td>
<td>ä¸ºcä¸­ä¼ å…¥çš„æŒ‡é’ˆï¼Œç”±c åˆ†é…å’Œé‡Šæ”¾ <code>light userdata</code></td>
</tr>
<tr>
<td><strong>lua_CFunction f</strong></td>
<td>è¡¨ç¤ºCå¯¼å‡ºç»™luaçš„å‡½æ•°æŒ‡é’ˆï¼Œ<code>typedef int (*lua_CFunction) (lua_State *L)</code></td>
</tr>
<tr>
<td><strong>lua_Integer i</strong></td>
<td>è¡¨ç¤ºæ•´æ•°ç±»å‹ï¼Œ<code>typedef long long lua_Integer</code></td>
</tr>
<tr>
<td><strong>lua_Number n</strong></td>
<td>è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹ç±»å‹ï¼Œ<code>typedef double lua_Number</code></td>
</tr>
</tbody>
</table>
<h3 id="égcå¯¹è±¡"><span>éGCå¯¹è±¡</span></h3>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°<code>éGCçš„å¯¹è±¡</code>æœ‰<code>4</code>ä¸­</p>
<ul>
<li><code>light userdata</code></li>
<li><code>C</code>å‡½æ•°</li>
<li>æ•´å‹</li>
<li>æµ®ç‚¹å‹</li>
<li><del><strong><font color='red'>int b</font></strong></del>(<code>lua 5.4</code>æ•°å­—åˆ†ä¸ºæ•´æ•°å’Œæµ®ç‚¹ï¼Œè€Œiæ­£å¥½ä¹Ÿå¯ä»¥ç”¨ä½œ<code>bool</code>,æ‰€ä»¥æŠŠè¿™ä¸ªç»™**<font color='red'>åˆ é™¤</font>**,å’Œ<code> lua_Integer i</code> ç»“åˆåˆ°ä¸€èµ·äº†)</li>
</ul>
<h3 id="gcå¯¹è±¡"><span>GCå¯¹è±¡</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#cdcd00">union</span> GCUnion {
</span></span><span style="display:flex;"><span>  GCObject gc;  <span style="color:#000080">/* common header */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cdcd00">struct</span> TString ts;<span style="color:#000080">//å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> Udata u;<span style="color:#000080">//ç”¨æˆ·æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">union</span> Closure cl;<span style="color:#000080">//é—­åŒ…
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> Table h;<span style="color:#000080">//è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> Proto p;<span style="color:#000080">//å‡½æ•°åŸå‹:å­˜æ”¾å‡½æ•°å­—èŠ‚ç ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> lua_State th;  <span style="color:#000080">/* thread */</span><span style="color:#000080">//çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>  <span style="color:#cdcd00">struct</span> UpVal upv;<span style="color:#000080">//ä¸Šå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>};
</span></span></code></pre></div><p>ä»ä¸Šé¢çš„<code>union</code>ç»“æ„ä½“å¯ä»¥çœ‹åˆ°<code>GCå¯¹è±¡</code>æœ‰<code>6</code>ä¸­</p>
<ul>
<li>å­—ç¬¦ä¸²</li>
<li><code>userdata</code></li>
<li><code>closure</code> é—­åŒ…</li>
<li><code>table</code></li>
<li><code>lua</code> å‡½æ•°åŸå‹</li>
<li><code>lua</code> çº¿ç¨‹ (å…¶å®å°±æ˜¯åç¨‹)</li>
<li><code>lua</code>ä¸Šå€¼</li>
</ul>
<h3 id="commonheaderç±»å‹"><span>CommonHeaderç±»å‹</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define CommonHeader	struct GCObject *next; lu_byte tt; lu_byte marked
</span></span></span></code></pre></div><ul>
<li><code>next</code> æŒ‡é’ˆ æŒ‡å‘ä¸‹ä¸€ä¸ª<code>GC</code>å¯¹è±¡</li>
<li><code>tt</code> <code>GC</code>å¯¹è±¡çš„å®é™…ç±»å‹(æ¯”å¦‚ä¸Šé¢<code>6</code>ä¸­<code>GC</code>å¯¹è±¡)</li>
<li><code>marked</code> æ ‡è¯†<code>GC</code>çš„çŠ¶æ€</li>
</ul>
<h3 id="tvaluefields-ç±»å‹"><span>TValuefields ç±»å‹</span></h3>
<div class="highlight"><pre tabindex="0" style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000080">#define TValuefields    Value value_; int tt_
</span></span></span><span style="display:flex;"><span><span style="color:#000080"></span>Value<span style="">ï¼šå­˜å‚¨å…·ä½“æ•°æ®çš„å€¼</span>
</span></span><span style="display:flex;"><span>tt_<span style="">ï¼šè¡¨ç¤ºè¿™ä¸ªå€¼çš„ç±»å‹ï¼Œå³æ‰€æœ‰çš„åŸºç¡€æ•°æ®ç±»å‹</span>
</span></span></code></pre></div><p><img loading="lazy" src="[lua5.4.4]shujuleixing.assets/image-20230124234606435.png" alt="image-20230124234606435"  />
</p>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://frog-game.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://frog-game.github.io/img/alipay_pay.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://frog-game.github.io/posts/read/lua5.4.4table/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>[Lua5.4.4æºç ]è¡¨</span>
  </a>
  <a class="next" href="https://frog-game.github.io/posts/read/lua5.4.4zifuchuan/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>[Lua5.4.4æºç ]å­—ç¬¦ä¸²</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://www.frog-game.work/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: "ap-beijing",
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2023 
        <a href="https://frog-game.github.io/" style="color:#939393;">frog&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="https://frog-game.github.io/img/beian.png" style="float:left;margin: 0px 5px 0px 0px;"/>
            å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
