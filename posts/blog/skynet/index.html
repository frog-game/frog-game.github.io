<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>skynetèµæ | frog&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="äº‘é£skynetèµæ,æ³¨è§£,å›¾ç¤º">
<meta name="author" content="
ä½œè€…:&nbsp;frog">
<link rel="canonical" href="https://frog-game.github.io/posts/blog/skynet/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8b1bcfe952e1e1a78b44fa99f358fddf187aee65873bbc85ca10d6f18a3bff33.css" integrity="sha256-ixvP6VLh4aeLRPqZ81j93xh67mWHO7yFyhDW8Yo7/zM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://frog-game.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://frog-game.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://frog-game.github.io/img/Q.gif">
<link rel="mask-icon" href="https://frog-game.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="skynetèµæ" />
<meta property="og:description" content="äº‘é£skynetèµæ,æ³¨è§£,å›¾ç¤º" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://frog-game.github.io/posts/blog/skynet/" />
<meta property="og:image" content="https://frog-game.github.io/posts/blog/skynet/Typoraimage-20220228100347880.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-15T01:30:29&#43;08:00" />
<meta property="article:modified_time" content="2022-09-15T01:30:29&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://frog-game.github.io/posts/blog/skynet/Typoraimage-20220228100347880.png" />
<meta name="twitter:title" content="skynetèµæ"/>
<meta name="twitter:description" content="äº‘é£skynetèµæ,æ³¨è§£,å›¾ç¤º"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://frog-game.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ§± æ¬ç –",
      "item": "https://frog-game.github.io/posts/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "skynetèµæ",
      "item": "https://frog-game.github.io/posts/blog/skynet/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "skynetèµæ",
  "name": "skynetèµæ",
  "description": "äº‘é£skynetèµæ,æ³¨è§£,å›¾ç¤º",
  "keywords": [
    ""
  ],
  "articleBody": "linuxç¼–è¯‘ make linux MALLOC_STATICLIB= SKYNET_DEFINES=-DNOUSE_JEMALLOC ç½‘ç»œæµç¨‹å›¾ workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ— æ¯ä¸ªåœ¨çº¿å®¢æˆ·ç«¯åœ¨SkynetæœåŠ¡å™¨ä¸Šéƒ½å¯¹åº”æœ‰ä¸€ä¸ªSocketä¸å…¶è¿æ¥ï¼Œä¸€ä¸ªSocketåœ¨Skynetå†…éƒ¨å¯¹åº”ä¸€ä¸ªLuaè™šæ‹Ÿæœºå’Œä¸€ä¸ªå®¢æˆ·ç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—per client mqã€‚å½“å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯æ—¶ï¼Œè¯¥é˜Ÿåˆ—ä¼šæŒ‚è½½åˆ°å…¨å±€é˜Ÿåˆ—global message queueä¸Šä¾›å·¥ä½œçº¿ç¨‹worker Threadsè¿›è¡Œè°ƒåº¦å¤„ç†ã€‚\nä¸€ä¸ªSocketçº¿ç¨‹socket threadä¼šè½®è¯¢æ‰€æœ‰çš„Socketï¼Œå½“æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åå°†è¯·æ±‚æ‰“åŒ…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘é€åˆ°è¯¥Socketå¯¹åº”çš„å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—per client mqä¸­ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯é˜Ÿåˆ—æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚\nå¤šä¸ªWorkerå·¥ä½œçº¿ç¨‹worker threadsä»å…¨å±€é˜Ÿåˆ—å¤´éƒ¨è·å–å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæ¯•åå†å°†æ¶ˆæ¯é˜Ÿåˆ—é‡æ–°æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚\nskynetä¸­ä¸åŒæœåŠ¡æ˜¯åˆ©ç”¨ç³»ç»Ÿçš„å¤šçº¿ç¨‹å®Œå…¨å¹¶è¡Œçš„ï¼Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bå’ŒæœåŠ¡Cåˆ†åˆ«å„è‡ªå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå¹¶ä¸èƒ½ä¿è¯å…ˆå‘çš„æ¶ˆæ¯å…ˆè¢«å¤„ç†ã€‚è€Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bä¾æ¬¡å‘é€ä¸¤æ¡æ¶ˆæ¯æ—¶ï¼Œå…ˆå‘çš„æ¶ˆæ¯ä¸€å®šä¼šè¢«æœåŠ¡Bå…ˆå¤„ç†ã€‚\nä½¿ç”¨Luaå®ç°çš„æœåŠ¡åªæ˜¯ä¸€ä¸ªå†…åµŒäº†Luaè™šæ‹Ÿæœºçš„æœåŠ¡ï¼Œä¹Ÿéµå®ˆä¸Šé¢çš„è§„åˆ™ã€‚å¦‚æœæœåŠ¡Bæ˜¯ä¸€ä¸ªLuaæœåŠ¡ï¼Œå½“æœåŠ¡Aå‘æœåŠ¡Bå‘é€ä¸¤æ¡æ¶ˆæ¯xå’Œyæ—¶ï¼ŒSkynetä¸€å®šä¿è¯xå…ˆè¢«æœåŠ¡Bä¸­çš„Luaè™šæ‹Ÿæœºæ¥æ”¶åˆ°ï¼Œå¹¶ä¸ºæ¶ˆæ¯xç”Ÿæˆè¦ç»™åç¨‹Xï¼Œå¹¶è¿è¡Œè¿™ä¸ªåç¨‹ã€‚ç„¶åæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯yï¼Œå¹¶é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„åç¨‹Yå¹¶è¿è¡Œã€‚\nåŒæ­¥é—®é¢˜ åŒæ­¥ä¹Ÿæ˜¯skynetå­˜åœ¨çš„é—®é¢˜ï¼Œå½“ä¸€ä¸ªæœåŠ¡callå…¶ä»–æœåŠ¡æ—¶ï¼Œå½“å‰åç¨‹ä¼šæŒ‚èµ·ï¼Œä½†æ˜¯è¿™ä¸ªæœåŠ¡è¿˜å¯ä»¥æ¥å—å¹¶å¤„ç†å…¶ä»–æ¶ˆæ¯ã€‚å¦‚æœå¤šä¸ªåç¨‹æ”¹åˆ°åŒä¸€ä¸ªæ•°æ®ï¼Œä½ ä¸åšåŒæ­¥å¤„ç†å°±æ— æ³•ç¡®å®šè¿™ä¸ªæ•°æ®ä¼šæ˜¯å¤šå°‘ã€‚\nè¿™æ ·çš„ä¾‹å­ç‰¹åˆ«å¸¸è§ï¼Œæ¯”å¦‚ï¼ŒæœåŠ¡æ­£å½“å¤„ç†ç©å®¶loginè¯·æ±‚ï¼Œåˆšå¥½é‡åˆ°callæŒ‚èµ·ï¼Œè¿™æ—¶å€™åˆæœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œæ¯”å¦‚logoutï¼ŒæœåŠ¡å°±ä¼šè½¬å»å¤„ç†logoutæ¶ˆæ¯ã€‚é‚£ç©å®¶ç©¶ç«Ÿæ˜¯loginï¼Œè¿˜æ˜¯logoutï¼Ÿ\nå½“ç„¶ï¼ŒåŒæ­¥é—®é¢˜ä¹Ÿå®¹æ˜“è§£å†³ï¼ŒåŠ å¤šä¸€ä¸ªstateçš„æ ‡è¯†å’Œä¸€ä¸ªåç¨‹åˆ—è¡¨ï¼Œæ“ä½œæ‰§è¡Œæ—¶ï¼Œå°†stateç½®doingï¼Œå…¶ä»–åç¨‹åˆ¤æ–­state=doingæ—¶å°±å°†è‡ªå·±åŠ åˆ°åç¨‹åˆ—è¡¨ï¼Œç„¶å skynet.waitã€‚åœ¨æ“ä½œæ‰§è¡Œå®Œåï¼Œé‡ç½®stateï¼Œç„¶åéå†åç¨‹åˆ—è¡¨ä¾æ¬¡ skynet.wakeup(co) ï¼Œæœ€åå°†åç¨‹åˆ—è¡¨ç½®ç©ºã€‚\nè§£é‡Šæ­¤é˜Ÿåˆ— çº¢é»‘æ ‘ä¸Šçš„èŠ‚ç‚¹æ˜¯æ‰€æœ‰ç›‘å¬çš„socket é»„è‰²åº•çš„æ˜¯interesting é˜Ÿåˆ— è“è‰²åº•æ˜¯é»„è‰²åº•çš„å­é˜Ÿåˆ— ä¹Ÿå°±æ˜¯å°±ç»ªé˜Ÿåˆ— epoll_ctrl() æ‰§è¡Œå¢åŠ æ“ä½œæ—¶å€™å°±æ˜¯å¾€interestingé˜Ÿåˆ—å¡socket å½“æœ‰è¯»å†™äº‹ä»¶æ—¶å€™ï¼Œå°±ä¼šå¾€è“è‰²åº•é˜Ÿåˆ—æ”¾å…¥socketä¹Ÿå°±æ˜¯å¡å…¥å°±ç»ªé˜Ÿåˆ— é€šè¿‡epoll_wait()æŠŠå°±ç»ªé˜Ÿåˆ—çš„ä¸œè¥¿è¿”å›å‡ºæ¥\nçº¿ç¨‹ç±»å‹ socket thread : çº¿ç¨‹è¿›ç¨‹æ¶ˆæ¯æ”¶å‘\nmonitor thread : çº¿ç¨‹ç›‘æ§æœåŠ¡æ˜¯ä¸æ˜¯é™·å…¥æ­»å¾ªç¯ï¼Œæ¶ˆæ¯æ˜¯å¦å µä½\ntime thread : çº¿ç¨‹ä¸»è¦ç”¨äºå®ç°skynetçš„å®šæ—¶å™¨\nwork thread çº¿ç¨‹ å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè°ƒåº¦\næ¶ˆæ¯æµè½¬ å…ˆä»å…¨å±€é˜Ÿåˆ—popä¸€ä¸ªæ¬¡çº§é˜Ÿåˆ—ï¼Œç„¶åä»æ¬¡çº§é˜Ÿåˆ—popä¸€ä¸ªæ¶ˆæ¯è°ƒç”¨å›è°ƒå‡½æ•°è¿›è¡Œé€»è¾‘å¤„ç† ç”¨å®Œä»¥åå¦‚æœæ¬¡çº§é˜Ÿåˆ—ä¸ä¸ºç©ºæˆ–è€…å µå¡ï¼Œç»§ç»­æŠŠæ¬¡çº§é˜Ÿåˆ—æ”¾å…¥å…¨å±€é˜Ÿåˆ— å¯åŠ¨æµç¨‹ åŠ è½½é…ç½®æ–‡ä»¶\né…ç½®æ–‡ä»¶å­˜å…¥luaçš„å…¨å±€å˜é‡env\nåˆ›å»ºå’Œå¯åŠ¨cæœåŠ¡logger\nå¯åŠ¨å¼•å¯¼æ¨¡å—å¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªluaæœåŠ¡(bootstrap)\nç„¶ååœ¨é€šè¿‡bootstrapé…ç½®å»å¯åŠ¨å…¶ä»–çš„å¾®æœåŠ¡\ncluster ä¸¤æ¡tcpé€šé“æ€»ç»“ å‰æ ä¸¤ç«¯æ˜¯ä¸¥æ ¼åˆ†ä¸ºè¯·æ±‚æ–¹å’Œå›åº”æ–¹ã€‚æ¯”å¦‚ A---\u003e B ï¼Œé‚£ä¹ˆåªèƒ½æ˜¯Aå‘Bæå‡ºè¯·æ±‚ï¼ŒB å›åº”å®ƒï¼›å¦‚æœ B-----\u003e\u003eA éœ€è¦ç”± B å‘ A å†å»ºç«‹ä¸€æ¡é€šé“ã€‚\nTCPç‰¹æ€§ä½¿å¾—æ¯ä¸ªTCPè¿æ¥å¯ä»¥å¾—åˆ°å‡ç­‰çš„å¸¦å®½ã€‚åœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰è¶Šå¤šTCPè¿æ¥ï¼Œè·å¾—çš„å¸¦å®½è¶Šå¤§\n1æ¡è¿æ¥ ä¼˜ç‚¹ï¼šé“¾æ¥å°‘ï¼Œå¯¹äºæ²¡æœ‰æ¥è§¦è¿‡skynetï¼Œä¼ ç»ŸæœåŠ¡å™¨äººå¾ˆå®¹æ˜“è¿™ç§æ–¹å¼è¿æ¥æ–¹å¼ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¾ˆå¤šéƒ½æ˜¯csç»“æ„ç¨‹åºå‘˜è¿‡æ¥çš„ **ç¼ºç‚¹ï¼š**å¦‚æœæ–­äº†ï¼Œæ•°æ®å°±æ— æ³•ä¼ è¾“ï¼Œå¾—é‡æ–°å»ºç«‹æ–°çš„è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œéœ€è¦æ¸…æ¥šé‚£è¾¹æ˜¯å‘é€æ–¹ï¼Œé‚£è¾¹æ˜¯æ¥å—æ–¹\n2æ¡è¿æ¥ **ä¼˜ç‚¹ï¼š**åœ¨å‰é¢å‰æçš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸¤æ¡è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘ç¨‹åºå‘˜ä¸éœ€è¦å…³å¿ƒæˆ‘è¿™ä¸ªæ—¶å€™æ˜¯clientï¼Œè¿˜æ˜¯serverï¼Œåªéœ€è¦é€šè¿‡cluster.callï¼Œcluster.sendï¼Œæ¥å£ç›´æ¥å¾€é‡Œé¢å¡æ•°æ®å°±è¡Œäº†ï¼Œå¤šæ¡è¿æ¥ä¹Ÿä¾¿äºæŠ¢å¸¦å®½ **ç¼ºç‚¹:**å¤šäº†ä¸€æ¡è¿æ¥ï¼Œå¯¹csç»“æ„è¿‡æ¥çš„ç¨‹åºå‘˜ä¸å¤ªå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆå¼„æœ‰å¥½å¤„ï¼Œæˆ–è€…æ˜¯ä¸çŸ¥é“æœ‰å‰é¢é‚£ä¸ªå‰æ ä¸ºä»€ä¹ˆä¸åœ¨å¼€è¾Ÿæ›´å¤šçš„è¿æ¥ï¼Œå› ä¸ºå¼€è¾Ÿæ›´å¤šçš„é“¾æ¥æ„ä¹‰ä¸å¤§ï¼Œå¦‚æœè¿™å°æœºå™¨ä¸Šå¼„äº†ä¸å°‘è¿›ç¨‹ï¼Œè¿æ¥æ•°å’Œæœºå™¨çš„é…ç½®ä¹Ÿæ˜¯æœ‰å…³ç³»çš„ï¼Œå¤šäº†ï¼Œå¦‚æœç”¨ä¸ä¸Šä¹Ÿæ˜¯ä¸€ç§æµªè´¹ï¼ŒåŒæ—¶å¯¹äºä¸šåŠ¡ç¨‹åºå‘˜æ¥è¯´ä¹Ÿé€»è¾‘æ··ä¹±ï¼Œ å› ä¸ºå‡å¦‚æ˜¯4æ¡ï¼Œé‚£ä¹ˆæ¥å—æ–¹è¿˜å¾—åŒºåˆ†æ˜¯é‚£æ¡å‘è¿‡æ¥çš„æ•°æ®\nmaster / slave ç»„ç½‘è¿‡ç¨‹ slave3å‘é€syncç»™masterï¼Œå¹¶å¯åŠ¨è‡ªå·±çš„listen masteræ”¶åˆ°ä¿¡æ¯ç»™å·²ç»è¿æ¥ä¸Šçš„slave1ï¼Œslave2å‘é€slave3è¯·æ±‚è¿æ¥çš„æƒ…å†µ masterç»™slave3å‘é€å½“å‰å·²ç»è¿æ¥ä¸Šçš„slaveæ•°é‡ï¼Œå¹¶æŠŠslave3åŠ å…¥èŠ‚ç‚¹ç»„ slave1ï¼Œslave3æ¥æ”¶åˆ°masterå‘é€çš„ä¿¡æ¯åï¼Œè°ƒç”¨connectå»è¿æ¥slave3 master /slave æ–­ç½‘è¿‡ç¨‹ masteræ£€æµ‹åˆ°slave3å¤±å»è¿æ¥ï¼ŒæŠŠslave3è¿æ¥fdç½®æˆ0 masteræŠŠå¤±å»è¿æ¥çš„slave3 id å¹¿æ’­ç»™slave1ï¼Œslave2 slave1ï¼Œslave2å¾—åˆ°slave3 idä¹‹åå’Œslave3æ–­å¼€è¿æ¥ harbor æœåŠ¡ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªharboridï¼Œåœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªharboridæ”¾åˆ°æ¶ˆæ¯idçš„\né«˜8ä½ï¼Œæ‰€ä»¥é€šè¿‡é«˜8ä½çš„å¯¹æ¯”å°±çŸ¥é“è¿™ä¸ªæ¶ˆæ¯æ˜¯è¿œç¨‹æ¶ˆæ¯ï¼Œè¿˜æ˜¯æœ¬åœ°æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯è¿œç¨‹æ¶ˆæ¯\né€šè¿‡harborå’Œè¿œç¨‹çš„harborå»ºç«‹tcpè¿æ¥å‘é€æ•°æ®è¿‡å»ï¼Œå¦‚æœæ˜¯æœ¬åœ°ç›´æ¥æ”¾å…¥æœ¬åœ°èŠ‚ç‚¹å¤„ç†é€»è¾‘\næ¶ˆæ¯å¤„ç†æ–¹å¼ skeynet.send éå µå¡ä¸éœ€è¦åº”ç­” skynet.call å µå¡éœ€è¦åº”ç­” skynet.ret å›åº”æ¶ˆæ¯ skynet.response è¯·æ±‚å’Œç›¸åº”åœ¨ä¸ç”¨åç¨‹å¤„ç† skynet.queue ä¸²è¡ŒåŒ–æ¶ˆæ¯æ‰§è¡Œ é” äº’æ–¥é” é€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´\u003eçº¿ç¨‹åˆ‡æ¢æ—¶é—´åœºæ™¯ å¾—åˆ°é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’å¤„ç†é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€\näº’æ–¥é”åŠ é”å¤±è´¥ä»¥åï¼Œä¼šä»ç”¨æˆ·æ€å˜æˆå†…æ ¸æ€ï¼Œçº¿ç¨‹å°±ä¼šé‡Šæ”¾CPU ç»™å…¶ä»–çº¿ç¨‹,ä¼šæœ‰ä¸¤æ¬¡çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æˆæœ¬\nçº¿ç¨‹åŠ é”å¤±è´¥æ—¶ï¼Œå†…æ ¸ä¼šæŠŠçº¿ç¨‹çš„çŠ¶æ€ä»ã€Œè¿è¡Œã€çŠ¶æ€è®¾ç½®ä¸ºã€Œç¡çœ ã€çŠ¶æ€ï¼Œç„¶åæŠŠ CPU åˆ‡æ¢ç»™å…¶ä»–çº¿ç¨‹è¿è¡Œ æ¥ç€ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œä¹‹å‰ã€Œç¡çœ ã€çŠ¶æ€çš„çº¿ç¨‹ä¼šå˜ä¸ºã€Œå°±ç»ªã€çŠ¶æ€ï¼Œç„¶åå†…æ ¸ä¼šåœ¨åˆé€‚çš„æ—¶é—´ï¼ŒæŠŠ CPU åˆ‡æ¢ç»™è¯¥çº¿ç¨‹è¿è¡Œã€‚ ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ï¼Œå¤§æ¦‚åœ¨å‡ åçº³ç§’åˆ°å‡ å¾®å¦™ä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœä½ èƒ½ç¡®è®¤ä½ è¢«é”ä½çš„ä»£ç æ—¶é—´å¾ˆçŸ­ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥ç”¨äº’æ–¥é”ï¼Œè€Œåº”è¯¥ç”¨è‡ªæ—‹é”\nè‡ªæ—‹é” æ²¡æœ‰è·å–åˆ°æƒé™çš„çš„çº¿ç¨‹ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ä¸€ç›´è‡ªæ—‹æ£€æµ‹æ˜¯å¦èƒ½è·å–èµ„æºï¼Œé€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´\u003c çº¿ç¨‹åˆ‡æ¢æ—¶é—´çš„åœºæ™¯ï¼Œå¾—åˆ°é”å¤„ç†é€»è¾‘æœ€å¥½åˆ«æœ‰IOæ“ä½œæˆ–è€…æ–‡ä»¶æµæ“ä½œ\nè‡ªæ—‹é”æ˜¯é€šè¿‡cpuçš„CASå‡½æ•°ï¼Œåœ¨ç”¨æˆ·æ€å°±å®Œæˆäº†åŠ é”å’Œè§£é”æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œç›¸æ¯”äº’æ–¥é”æ¥è¯´ï¼Œä¼šå¿«ä¸€ç‚¹\nä¸€èˆ¬åŠ é”çš„è¿‡ç¨‹æœ‰ä¸¤æ­¥\næŸ¥çœ‹é”çš„çŠ¶æ€ï¼Œå¦‚æœé”æ˜¯ç©ºé—²çš„ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬äºŒæ­¥ å°†é”è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰ è‡ªæ—‹é”åŠ é”å¤±è´¥ä»¥åçº¿ç¨‹ä¼šå¿™ç­‰å¾…ï¼Œç›´åˆ°å®ƒèƒ½æ‹¿åˆ°é”\nè¯»å†™é” å®ç°åœ¨rwlock.hä¸­\nè¯»é”æ˜¯å…±äº«é”æ¦‚å¿µï¼Œå…¶ä»–é”å»è¯»çš„æ—¶å€™è¯»å–çš„æ˜¯å…±äº«çš„èµ„æºï¼Œ\nå†™é”æ˜¯ç‹¬å æ¦‚å¿µï¼Œå…¶ä»–é”åªèƒ½ç­‰å¾…æŠ¢å åˆ°çš„é”é‡Šæ”¾èµ„æºï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯\næ‰€ä»¥æ›´å…·åœºæ™¯å¯ä»¥åˆ†ä¸ºè¯»ä¼˜å…ˆé”å’Œå†™ä¼˜å…ˆé”\nè¯»ä¼˜å…ˆé” è¯»ä¼˜å…ˆé”å¯¹äºè¯»çº¿ç¨‹å¹¶å‘æ€§æ›´å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€ç›´æœ‰è¯»çº¿ç¨‹è·å–é”ï¼Œé‚£ä¹ˆå†™çº¿ç¨‹å°±ä¼šè¢«é¥¿æ­»\nå†™ä¼˜å…ˆé” å†™ä¼˜å…ˆé”å¯ä»¥ä¿è¯å†™çº¿ç¨‹ä¸è¢«é¥¿æ­»ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æœ‰å†™çº¿ç¨‹è·å–ï¼Œé‚£ä¹ˆè¯»çº¿ç¨‹ä¹Ÿä¼šè¢«é¥¿æ­»\næ‰€ä»¥ä¸ç®¡æ˜¯ä¼˜å…ˆè¯»é”è¿˜æ˜¯å†™é”ï¼Œå¯¹æ–¹éƒ½å¯èƒ½è¢«é¥¿æ­»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åè¢’ä»»ä½•ä¸€æ–¹ï¼Œæä¸ªå…¬å¹³è¯»å†™é”\nå…¬å¹³è¯»å†™é” ç”¨é˜Ÿåˆ—æŠŠè·å–é”çš„çº¿ç¨‹æ’é˜Ÿï¼Œä¸ç®¡æ˜¯å†™çº¿ç¨‹è¿˜æ˜¯è¯»çº¿ç¨‹éƒ½æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™åŠ é”ï¼Œè¿™æ ·è¯»çº¿ç¨‹ä¸€æ ·èƒ½å¹¶å‘ï¼Œä¹Ÿä¸ä¼šå‡ºç°é¥¥é¥¿ç°è±¡\nä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ« æ‚²è§‚é”åšäº‹æ¯”è¾ƒæ‚²è§‚ï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨è®¿é—®èµ„æºä¹‹å‰éƒ½ä¼šå…ˆä¸Šä¸€æŠŠé”ã€‚\nä¹è§‚é”æ­£å¥½ç›¸åï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥ä¼šè®©å…ˆä¿®æ”¹å®Œèµ„æºï¼Œç„¶ååœ¨åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å†²çªï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„çº¿ç¨‹åœ¨ä¿®æ”¹èµ„æºï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥æ”¾å¼ƒæœ¬æ¬¡æ“ä½œï¼Œ\näº’æ–¥é”ã€è‡ªæ—‹é”ã€è¯»å†™é”ï¼Œéƒ½æ˜¯å±äºæ‚²è§‚é”\né‡å…¥é” å°±æ˜¯èƒ½ä¸€æ¡çº¿ç¨‹ä¸Šèƒ½é‡å¤è·å–çš„é”ï¼Œè€Œä¸å¯¼è‡´æ­»é”\ncluster æ¨¡å¼ åœ¨æ¯ä¸ª skynet èŠ‚ç‚¹ï¼ˆå•ä¸ªè¿›ç¨‹ï¼‰å†…ï¼Œå¯åŠ¨ä¸€ä¸ªå« clusterd çš„æœåŠ¡ã€‚æ‰€æœ‰éœ€è¦è·¨è¿›ç¨‹çš„æ¶ˆæ¯æŠ•é€’éƒ½å…ˆæŠŠæ¶ˆæ¯æŠ•é€’åˆ°è¿™ä¸ªæœåŠ¡ä¸Šï¼Œå†ç”±å®ƒæ¥è½¬å‘åˆ°ç½‘ç»œã€‚\né¦–é€‰é€šè¿‡clustername.luaé…ç½®è¡¨é…ç½®å¥½å…¨éƒ¨çš„clusterèŠ‚ç‚¹ åœ¨æ‰€æœ‰è¦å‘ç°çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œrequire\"skynet.cluster\" ç”¨cluster.openå»ºç«‹è‡ªå·±çš„ç›‘å¬å¥½è®©åˆ«çš„èŠ‚ç‚¹å’Œè‡ªå·±å»ºç«‹tcpé€šé“è¿æ¥ é€šè¿‡cluster.registeræ³¨å†Œcreateçš„service è¿œç¨‹èŠ‚ç‚¹åˆ©ç”¨cluster.query()æ¥å¾—åˆ°æ³¨å†Œè¿‡çš„èŠ‚ç‚¹ é€šè¿‡cluster.call skynet.call cluster.send skynet.sendæ¥è°ƒç”¨è¿œç¨‹function1 function2å‡½æ•° ç®€æ˜“çš„mmo æ¶æ„ ç½‘å…³æœåŠ¡ main.lua å»ºç«‹ watchdog watchdog é€šè¿‡skynet.start() åˆ›å»ºgateService gateServiceå¹¶é€šè¿‡rpcè°ƒç”¨ watchdogService socket.open å‡½æ•° watchdogService é€šè¿‡ socket.open åˆ›å»º agenService agenService æŠŠfd forwardç»™gateService client å‘é€è¯·æ±‚ç»™gateService gateService æŠŠè¯·æ±‚é‡å®šå‘ç»™agentService agentService æŠŠå¤„ç†ç»“æœè¿”å›ç»™client åç¨‹ coroutine å®ç° è¯¦ç»†ä»£ç è§lcorolib.c\næ´¾å‘æ¶ˆæ¯ function skynet.dispatch_message(...) -- å½“å‰æ¶ˆæ¯å¤„ç† local succ, err = pcall(raw_dispatch_message,...) while true do -- é¡ºåºæ‰§è¡Œskynet.fork åˆ›å»ºçš„åç¨‹ if fork_queue.h \u003e fork_queue.t then -- queue is empty fork_queue.h = 1 fork_queue.t = 0 break end -- pop queue local h = fork_queue.h local co = fork_queue[h] fork_queue[h] = nil fork_queue.h = h + 1 local fork_succ, fork_err = pcall(suspend,co,coroutine_resume(co)) if not fork_succ then if succ then succ = false err = tostring(fork_err) else err = tostring(err) .. \"\\n\" .. tostring(fork_err) end end end assert(succ, tostring(err)) end å¤„ç†å½“å‰æ¶ˆæ¯ local function raw_dispatch_message(prototype, msg, sz, session, source) -- skynet.PTYPE_RESPONSE = 1, read skynet.h if prototype == 1 then -- å¯¹å›åº”ç±»å‹çš„åŒ…å¤„ç† local co = session_id_coroutine[session] if co == \"BREAK\" then session_id_coroutine[session] = nil elseif co == nil then unknown_response(session, source, msg, sz) else local tag = session_coroutine_tracetag[co] if tag then c.trace(tag, \"resume\") end session_id_coroutine[session] = nil suspend(co, coroutine_resume(co, true, msg, sz, session)) end else local p = proto[prototype] -- æ‰¾åˆ°å¯¹åº”çš„è§£æåè®® if p == nil then if prototype == skynet.PTYPE_TRACE then -- trace next request trace_source[source] = c.tostring(msg,sz) elseif session ~= 0 then c.send(source, skynet.PTYPE_ERROR, session, \"\") else unknown_request(session, source, msg, sz, prototype) end return end local f = p.dispatch -- è·å–å¤„ç†çš„å‡½æ•° if f then local co = co_create(f) -- è·å–åç¨‹ session_coroutine_id[co] = session session_coroutine_address[co] = source local traceflag = p.trace if traceflag == false then -- force off trace_source[source] = nil session_coroutine_tracetag[co] = false else local tag = trace_source[source] if tag then trace_source[source] = nil c.trace(tag, \"request\") session_coroutine_tracetag[co] = tag elseif traceflag then -- set running_thread for trace running_thread = co skynet.trace() end end suspend(co, coroutine_resume(co, session,source, p.unpack(msg,sz))) else trace_source[source] = nil if session ~= 0 then c.send(source, skynet.PTYPE_ERROR, session, \"\") else unknown_request(session, source, msg, sz, proto[prototype].name) end end end end åˆ›å»ºåç¨‹ local function co_create(f) local co = tremove(coroutine_pool) -- ä»åç¨‹æ± ä¸­è·å–åç¨‹ if co == nil then --å¦‚æœæ²¡æœ‰äº† co = coroutine_create(function(...) -- åˆ›å»ºæ–°çš„ f(...) --æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä¸ä¼šç«‹é©¬æ‰§è¡Œåªä¼šè°ƒç”¨coroutine.resumeæ—¶å€™æ‰ä¼šæ‰§è¡Œ while true do -- ä¸ºäº†èƒ½å¤Ÿå¤ç”¨åˆšåˆ›å»ºçš„åæˆï¼Œä¸‹é¢éœ€è¦å¯¹åç¨‹è¿›è¡Œåˆå§‹åŒ–å’Œå›æ”¶ local session = session_coroutine_id[co] if session and session ~= 0 then local source = debug.getinfo(f,\"S\") skynet.error(string.format(\"Maybe forgot response session %s from %s : %s:%d\", session, skynet.address(session_coroutine_address[co]), source.source, source.linedefined)) end -- coroutine exit local tag = session_coroutine_tracetag[co] if tag ~= nil then if tag then c.trace(tag, \"end\") end session_coroutine_tracetag[co] = nil end local address = session_coroutine_address[co] if address then session_coroutine_id[co] = nil session_coroutine_address[co] = nil end -- recycle co into pool f = nil coroutine_pool[#coroutine_pool+1] = co -- recv new main function f f = coroutine_yield \"SUSPEND\" f(coroutine_yield()) end end) else -- pass the main function f to coroutine, and restore running thread local running = running_thread coroutine_resume(co, f) running_thread = running end return co end åç¨‹æŒ‚èµ· -- suspend is local function function suspend(co, result, command) if not result then -- æ‰§è¡Œcoå¤±è´¥ä»¥åçš„å¤„ç† local session = session_coroutine_id[co] if session then -- coroutine may fork by others (session is nil) local addr = session_coroutine_address[co] if session ~= 0 then -- only call response error local tag = session_coroutine_tracetag[co] if tag then c.trace(tag, \"error\") end c.send(addr, skynet.PTYPE_ERROR, session, \"\") end session_coroutine_id[co] = nil end session_coroutine_address[co] = nil session_coroutine_tracetag[co] = nil skynet.fork(function() end) -- trigger command \"SUSPEND\" local tb = traceback(co,tostring(command)) coroutine.close(co) error(tb) end if command == \"SUSPEND\" then -- æŒ‚èµ·æ“ä½œ return dispatch_wakeup() -- å¦‚æœæœ‰èƒ½å¤Ÿè¢«å”¤é†’çš„åç¨‹ï¼Œå°±wakeup elseif command == \"QUIT\" then coroutine.close(co) -- service exit return elseif command == \"USER\" then -- See skynet.coutine for detail error(\"Call skynet.coroutine.yield out of skynet.coroutine.resume\\n\" .. traceback(co)) elseif command == nil then -- debug trace return else error(\"Unknown command : \" .. command .. \"\\n\" .. traceback(co)) end end\tåç¨‹é”€æ¯ ä¸»è¦æ˜¯å› ä¸ºè¿™ç§åŸºç¡€ç±»å‹LUA_TTHREADæ¥å†³å®šæ€ä¹ˆé”€æ¯\nLUA_TTHREAD ä»‹ç»:\né™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼Œå…¶å®ƒçº¿ç¨‹å’Œå…¶å®ƒLuaå¯¹è±¡ä¸€æ ·éƒ½æ˜¯åƒåœ¾å›æ”¶çš„å¯¹è±¡ã€‚ç­‰å¾…GCå›æ”¶ï¼Œå½“æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¼šå‹å…¥æ ˆï¼Œè¿™æ ·èƒ½ç¡®ä¿æ–°çº¿ç¨‹ä¸ä¼šæˆä¸ºåƒåœ¾\næ¯æ¬¡è°ƒç”¨lua_newstateçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„luastate,ä¸åŒçš„luastateå®Œå…¨ç‹¬ç«‹ï¼Œä¹‹é—´ä¸å…±äº«ä»»ä½•æ•°æ®\nåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæ ˆäº†ï¼Œä½†æ˜¯å®ƒä¸å…¶çº¿ç¨‹å…±ç”¨è™šæ‹Ÿæœºçš„å…¨å±€çŠ¶æ€\nåç¨‹æä¾›äº†æ–°çš„apiæ¥å£å’Œ lua_resetthread, coroutine.close ä¼šä½¿åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€,å¹¶ä¸”å…³é—­æ‰€æœ‰çš„closeå˜é‡\nsend.call æµç¨‹ API ç›¸å…³ cluster cluster.call(node, address, ...) --è¿œç¨‹è°ƒç”¨nodeä¸­çš„addr cluster.send(node, address, ...) --sendè°ƒç”¨è¿œç¨‹nodeçš„addr cluster.open(port) --æœ¬åœ°æ‰“å¼€(ç›‘å¬)ä¸€ä¸ªclusterç»“ç‚¹ï¼Œä½¿å…¶èƒ½åœ¨clusterä¸­çš„å…¶ä»–ç»“ç‚¹å‘ç° cluster.reload(config) --é‡è½½è¿œç¨‹ç»“ç‚¹é…ç½®è¡¨ï¼Œè¡¨ä¸­çš„clusterç»“ç‚¹éƒ½openè¿‡ï¼Œåˆ™å¯ä»¥é€šè®¯ cluster.proxy(node, name) --è®¾ç½®è¿œç¨‹ç»“ç‚¹çš„ä»£ç†ï¼Œä½¿å¾—å¯ä»¥åƒè°ƒç”¨æœ¬åœ°RPCä¸€æ ·è°ƒç”¨è¿œç¨‹ç»“ç‚¹ cluster.snax(node, name, address) --ç”Ÿæˆä¸€ä¸ªè¿œç¨‹çš„snaxæœåŠ¡å¯¹è±¡ cluster.register(name, addr) --æ³¨å†Œä¸€ä¸ªclusterç»“ç‚¹ cluster.query(node, name) --æŸ¥æ‰¾è¿œç¨‹ç»“ç‚¹ä¸­æ³¨å†Œè¿‡çš„ç»“ç‚¹æ˜¯å¦å­˜åœ¨ harbor harbor.link(id) --ç”¨æ¥ç›‘æ§ä¸€ä¸ª slave æ˜¯å¦æ–­å¼€ã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ­£å¸¸ï¼Œè¿™ä¸ª api å°†é˜»å¡ã€‚å½“ slave æ–­å¼€æ—¶ï¼Œä¼šç«‹åˆ»è¿”å›ã€‚ harbor.linkmaster() --ç”¨æ¥åœ¨ slave ä¸Šç›‘æ§å’Œ master çš„è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚è¿™ä¸ª api å¤šç”¨äºå¼‚å¸¸æ—¶çš„å®‰å…¨é€€å‡ºï¼ˆå› ä¸ºå½“ slave å’Œ master æ–­å¼€åï¼Œæ²¡æœ‰æ‰‹æ®µå¯ä»¥æ¢å¤ï¼‰ã€‚ harbor.connect(id) --å’Œ harbor.link ç›¸åã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ²¡æœ‰è¿æ¥ï¼Œè¿™ä¸ª api å°†é˜»å¡ï¼Œä¸€ç›´åˆ°å®ƒè¿ä¸Šæ¥æ‰è¿”å›ã€‚ harbor.queryname(name) --å¯ä»¥ç”¨æ¥æŸ¥è¯¢å…¨å±€åå­—æˆ–æœ¬åœ°åå­—å¯¹åº”çš„æœåŠ¡åœ°å€ã€‚å®ƒæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ã€‚ harbor.globalname(name, handle) --æ³¨å†Œä¸€ä¸ªå…¨å±€åå­—ã€‚å¦‚æœ handle ä¸ºç©ºï¼Œåˆ™æ³¨å†Œè‡ªå·±ã€‚skynet.name å’Œ skynet.register æ˜¯ç”¨å…¶å®ç°çš„ã€‚ æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£ skynet.getenv(varName) --confé…ç½®ä¿¡æ¯å·²ç»å†™å…¥åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œé€šè¿‡è¯¥å‡½æ•°è·å–æ³¨å†Œè¡¨çš„å˜é‡å€¼ skynet.setenv(varName, varValue) --è®¾ç½®æ³¨å†Œè¡¨ä¿¡æ¯ï¼ŒvarValueä¸€èˆ¬æ˜¯numberæˆ–stringï¼Œä½†æ˜¯ä¸èƒ½è®¾ç½®å·²ç»å­˜åœ¨çš„varname skynet.error(...) --æ‰“å°å‡½æ•° skynet.start(func) --ç”¨ func å‡½æ•°åˆå§‹åŒ–æœåŠ¡ï¼Œå¹¶å°†æ¶ˆæ¯å¤„ç†å‡½æ•°æ³¨å†Œåˆ° C å±‚ï¼Œè®©è¯¥æœåŠ¡å¯ä»¥å·¥ä½œã€‚ skynet.init(func) --è‹¥æœåŠ¡å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œåˆ™æ³¨å†Œä¸€ä¸ªå‡½æ•°ç­‰æœåŠ¡åˆå§‹åŒ–é˜¶æ®µå†æ‰§è¡Œï¼›è‹¥æœåŠ¡å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œåˆ™ç«‹åˆ»è¿è¡Œè¯¥å‡½æ•°ã€‚ skynet.exit() --ç»“æŸå½“å‰æœåŠ¡ skynet.self() --è·å–å½“å‰æœåŠ¡çš„å¥æŸ„handler skynet.address(handler) --å°†handleè½¬æ¢æˆå­—ç¬¦ä¸² skynet.abort() --é€€å‡ºskynetè¿›ç¨‹ skynet.kill(address) ----å¼ºåˆ¶æ€æ­»å…¶ä»–æœåŠ¡ã€‚å¯ä»¥ç”¨æ¥å¼ºåˆ¶å…³é—­åˆ«çš„æœåŠ¡ã€‚ä½†å¼ºçƒˆä¸æ¨èè¿™æ ·åšã€‚å› ä¸ºå¯¹è±¡ä¼šåœ¨ä»»æ„ä¸€æ¡æ¶ˆæ¯å¤„ç†å®Œæ¯•åï¼Œæ¯«æ— å¾å…†çš„é€€å‡ºã€‚æ‰€ä»¥æ¨èçš„åšæ³•æ˜¯ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè®©å¯¹æ–¹è‡ªå·±å–„åä»¥åŠè°ƒç”¨ skynet.exit ã€‚æ³¨ï¼šskynet.kill(skynet.self()) ä¸å®Œå…¨ç­‰ä»·äº skynet.exit() ï¼Œåè€…æ›´å®‰å…¨ã€‚\tæ™®é€šæœåŠ¡ skynet.newservice(luaServerName, ...)\tå…¨å±€å”¯ä¸€æœåŠ¡ skynet.uniqueservice(servicename, ...) --å½“å‰çš„skynetèŠ‚ç‚¹å…¨å±€å”¯ä¸€ skynet.uniqueservice(true, servicename, ...) --æ‰€æœ‰çš„èŠ‚ç‚¹å…¨å±€å”¯ä¸€ skynet.queryservice(servicename, ...) --å½“å‰çš„skynetèŠ‚ç‚¹ä¸­æŸ¥æ‰¾ skynet.queryservice(true, servicename, ...) --æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­æŸ¥æ‰¾ åˆ«å åˆ«ååˆ†ä¸¤ç§ï¼š\næœ¬åœ°åˆ«å ä»£è¡¨åªèƒ½åœ¨å½“å‰skynetèŠ‚ç‚¹ä½¿ç”¨ï¼Œæœ¬åœ°åˆ«åç”¨ .å¼€å¤´\nå…¨å±€åˆ«å å¯ä»¥åœ¨æ‰€æœ‰çš„skynetä¸­ä½¿ç”¨ å…¨å±€åˆ«åä¸èƒ½ä»¥. å¼€å¤´\nskynet.register(aliasname) --ç»™å½“å‰æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å skynet.name(aliasname, servicehandler) --ç»™æŒ‡å®šservicehandlerçš„æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å --[[ æŸ¥è¯¢åˆ«åä¸ºaliasnameçš„æœåŠ¡,å¯ä»¥æ˜¯å…¨å±€åˆ«åä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«åï¼Œ 1ã€å½“æŸ¥è¯¢æœ¬åœ°åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil 2ã€å½“æŸ¥è¯¢å…¨å±€åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±é˜»å¡ç­‰å¾…åˆ°è¯¥æœåŠ¡åˆå§‹åŒ–å®Œæˆ ]]-- skynet.harbor.queryname(aliasname) skynet.localname(aliasname) --æŸ¥è¯¢æœ¬åœ°åˆ«åä¸ºaliasnameçš„æœåŠ¡ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil skynet.kill(handle) --æ€æ­»å¸¦åˆ«åæœåŠ¡ æœåŠ¡è°ƒåº¦ skynet.sleep(time) --è®©å½“å‰çš„ä»»åŠ¡ç­‰å¾… time * 0.01s ã€‚ skynet.fork(func, ...) --å¯åŠ¨ä¸€ä¸ªæ–°çš„ä»»åŠ¡å»æ‰§è¡Œå‡½æ•° func , å…¶å®å°±æ˜¯å¼€äº†ä¸€ä¸ªåç¨‹ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆå°†è¿”å›çº¿ç¨‹å¥æŸ„ è™½ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”Ÿçš„coroutine.createæ¥åˆ›å»ºåç¨‹ï¼Œä½†æ˜¯ä¼šæ‰“ä¹±skynetçš„å·¥ä½œæµç¨‹ skynet.yield() --è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œä½¿æœ¬æœåŠ¡å†…å…¶å®ƒä»»åŠ¡æœ‰æœºä¼šæ‰§è¡Œï¼Œéšåä¼šç»§ç»­è¿è¡Œã€‚ skynet.wait() --è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œç›´åˆ°ç”¨ wakeup å”¤é†’å®ƒã€‚ skynet.wakeup(co) --å”¤é†’ç”¨ wait æˆ– sleep å¤„äºç­‰å¾…çŠ¶æ€çš„ä»»åŠ¡ã€‚ skynet.timeout(time, func) --è®¾å®šä¸€ä¸ªå®šæ—¶è§¦å‘å‡½æ•° func ï¼Œåœ¨ time * 0.01s åè§¦å‘ã€‚ skynet.starttime() --è¿”å›å½“å‰è¿›ç¨‹çš„å¯åŠ¨ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚ skynet.now() --è¿”å›å½“å‰è¿›ç¨‹å¯åŠ¨åç»è¿‡çš„æ—¶é—´ (0.01 ç§’) ã€‚ skynet.time() --é€šè¿‡ starttime å’Œ now è®¡ç®—å‡ºå½“å‰ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚\tæ¶ˆæ¯ç±»å‹ #define PTYPE_TEXT 0 --æ–‡æœ¬ #define PTYPE_RESPONSE 1 --è¡¨ç¤ºä¸€ä¸ªå›åº”åŒ… #define PTYPE_MULTICAST 2 --å¹¿æ’­æ¶ˆæ¯ #define PTYPE_CLIENT 3 --ç”¨æ¥å¤„ç†ç½‘ç»œå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯ #define PTYPE_SYSTEM 4 --ç³»ç»Ÿæ¶ˆæ¯ #define PTYPE_HARBOR 5 --é›†ç¾¤å†…å…¶ä»–çš„ skynet èŠ‚ç‚¹å‘æ¥çš„æ¶ˆæ¯ #define PTYPE_SOCKET 6 --å¥—æ¥å­—æ¶ˆæ¯ #define PTYPE_ERROR 7 --é”™è¯¯æ¶ˆæ¯ï¼Œä¸€èˆ¬æœåŠ¡é€€å‡ºçš„æ—¶å€™ä¼šå‘é€erroræ¶ˆæ¯ç»™å…³è”çš„æœåŠ¡ #define PTYPE_QUEUE 8 --é˜Ÿåˆ—æ–¹å¼ #define PTYPE_DEBUG 9 --è°ƒè¯• #define PTYPE_LUA 10 --luaç±»å‹çš„æ¶ˆæ¯ï¼Œæœ€å¸¸ç”¨ #define PTYPE_SNAX 11 --snaxæœåŠ¡æ¶ˆæ¯ #define PTYPE_TAG_DONTCOPY 0x10000 --ç¦æ­¢æ‹·è´ #define PTYPE_TAG_ALLOCSESSION 0x20000 --åˆ†é…æ–°çš„ session æ‰“åŒ…è§£åŒ… skynet.pack(...) --æ‰“åŒ… skynet.unpack(msg, sz) --è§£åŒ…\tå‘é€æ¶ˆæ¯ -- å‘é€æ— éœ€å“åº”çš„æ¶ˆæ¯ skynet.send(addr, type, ...) --ç”¨ type ç±»å‹å‘ addr å‘é€æœªæ‰“åŒ…çš„æ¶ˆæ¯ã€‚è¯¥å‡½æ•°ä¼šè‡ªåŠ¨æŠŠ...å‚æ•°åˆ—è¡¨è¿›è¡Œæ‰“åŒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹luaæ¶ˆæ¯ä½¿ç”¨skynet.packæ‰“åŒ…ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚è‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰ skynet.rawsend(addr, type, msg, sz) --ç”¨ type ç±»å‹å‘ addr å‘é€ä¸€ä¸ªæ‰“åŒ…å¥½çš„æ¶ˆæ¯ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰ -- å‘é€å¿…é¡»å“åº”çš„æ¶ˆæ¯ skynet.call(addr, type, ...) --ç”¨é»˜è®¤å‡½æ•°æ‰“åŒ…æ¶ˆæ¯ï¼Œå‘addrå‘é€typeç±»å‹çš„æ¶ˆæ¯å¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œå¹¶å¯¹å›åº”ä¿¡æ¯è¿›è¡Œè§£åŒ…ã€‚ï¼ˆè‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰ skynet.rawcall(addr, type, msg, sz) --ç›´æ¥å‘addrå‘é€typeç±»å‹çš„msg,szå¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œä¸å¯¹å›åº”ä¿¡æ¯è§£åŒ…ã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰ å“åº”æ¶ˆæ¯ -- åŒä¸€ä¸ªåæˆå¤„ç† skynet.ret() --ç›®æ ‡æœåŠ¡æ¶ˆæ¯å¤„ç†åéœ€è¦é€šè¿‡è¯¥å‡½æ•°å°†ç»“æœè¿”å› skynet.retpack(...) --å°†æ¶ˆæ¯ç”¨skynet.pack æ‰“åŒ…ï¼Œå¹¶è°ƒç”¨ ret å›åº”ã€‚ --ä¸åœ¨ä¸€ä¸ªåæˆå¤„ç† local response = skynet.response(pack)--å‚æ•°packæŒ‡å®šåº”ç­”æ‰“åŒ…å‡½æ•°ï¼Œä¸å¡«é»˜è®¤ä½¿ç”¨skynet.pack, å¿…é¡»æ ¹æ®æ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰“åŒ…å‡½æ•°ä¸€è‡´ è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•° response(ok, ...) --å‚æ•°okçš„å€¼å¯ä»¥æ˜¯ \"test\"ã€trueã€falseï¼Œä¸º\"test\"æ—¶è¡¨ç¤ºæ£€æŸ¥æ¥æ”¶å“åº”çš„æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œä¸ºtrueæ—¶è¡¨ç¤ºå‘é€åº”ç­”PTYPE_RESPONSEï¼Œä¸ºfalseæ—¶è¡¨ç¤ºå‘é€PTYPE_ERRORé”™è¯¯æ¶ˆæ¯ã€‚ æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜ skynet.queue() --å¸®åŠ©ä½ å›é¿è¿™äº›æœåŠ¡é‡å…¥æˆ–è€…ä¼ªå¹¶å‘å¼•èµ·çš„å¤æ‚æ€§,ä½†æ˜¯æ˜æ˜¾é™ä½äº†æœåŠ¡çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ‰€ä»¥ä½¿ç”¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™å°½é‡ç¼©å°ä¸´ç•ŒåŒºçš„é¢—ç²’åº¦å¤§å° åè®®è½¬æ¢ skynet.forward_type() --éœ€è¦æä¾›ä¸€å¼ æ¶ˆæ¯è½¬æ¢æ˜ å°„è¡¨forward_map, å…¶ä»–çš„æ–¹æ³•ä¸skynet.startä¸€æ · ä¼ªé€ æ¶ˆæ¯ skynet.redirect(dest,source,typename, session, msg, sz) --ä½¿ç”¨sourceæœåŠ¡åœ°å€ï¼Œå‘é€typenameç±»å‹çš„æ¶ˆæ¯ç»™destæœåŠ¡ï¼Œä¸éœ€è¦æ¥æ”¶å“åº”ï¼Œï¼ˆsourceï¼Œdeståªèƒ½æ˜¯æœåŠ¡IDï¼‰msg szä¸€èˆ¬ä½¿ç”¨skynet.packæ‰“åŒ…ç”Ÿæˆ ç»„æ’­ skynet.multicast -- å½“ç»„æ’­çš„æ•°æ®é‡è¾ƒå¤§æ—¶å€™å¯ä»¥èŠ‚çœå†…éƒ¨çš„å¸¦å®½ socket --å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ã€‚è¿”å›ä¸€ä¸ªæ•°å­— id ã€‚ socket.open(address, port) --å…³é—­ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ª API æœ‰å¯èƒ½é˜»å¡ä½æ‰§è¡Œæµã€‚å› ä¸ºå¦‚æœæœ‰å…¶å®ƒ coroutine --æ­£åœ¨é˜»å¡è¯»è¿™ä¸ª id å¯¹åº”çš„è¿æ¥ï¼Œä¼šå…ˆé©±ä½¿è¯»æ“ä½œç»“æŸï¼Œclose æ“ä½œæ‰è¿”å›ã€‚ socket.close(id) --åœ¨æå…¶ç½•è§çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç²—æš´çš„ç›´æ¥å…³é—­æŸä¸ªè¿æ¥ï¼Œè€Œé¿å… socket.close çš„é˜»å¡ç­‰å¾…æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚ socket.close_fd(id) --å¼ºè¡Œå…³é—­ä¸€ä¸ªè¿æ¥ã€‚å’Œ close ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸ä¼šç­‰å¾…å¯èƒ½å­˜åœ¨çš„å…¶å®ƒ coroutine çš„è¯»æ“ä½œã€‚ --ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ª API ï¼Œä½†å¦‚æœä½ éœ€è¦åœ¨ __gc å…ƒæ–¹æ³•ä¸­å…³é—­è¿æ¥çš„è¯ï¼Œ --shutdown æ˜¯ä¸€ä¸ªæ¯” close æ›´å¥½çš„é€‰æ‹©ï¼ˆå› ä¸ºåœ¨ gc è¿‡ç¨‹ä¸­æ— æ³•åˆ‡æ¢ coroutineï¼‰ã€‚ä¸close_fdç±»ä¼¼ socket.shutdown(id) --[[ ä»ä¸€ä¸ª socket ä¸Šè¯» sz æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚ å¦‚æœè¯»åˆ°äº†æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®ƒæŠŠè¿™ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚ å¦‚æœè¿æ¥æ–­å¼€å¯¼è‡´å­—èŠ‚æ•°ä¸å¤Ÿï¼Œå°†è¿”å›ä¸€ä¸ª false åŠ ä¸Šè¯»åˆ°çš„å­—ç¬¦ä¸²ã€‚ å¦‚æœ sz ä¸º nil ï¼Œåˆ™è¿”å›å°½å¯èƒ½å¤šçš„å­—èŠ‚æ•°ï¼Œä½†è‡³å°‘è¯»ä¸€ä¸ªå­—èŠ‚ï¼ˆè‹¥æ— æ–°æ•°æ®ï¼Œä¼šé˜»å¡ï¼‰ã€‚ --]] socket.read(id, sz) --ä»ä¸€ä¸ª socket ä¸Šè¯»æ‰€æœ‰çš„æ•°æ®ï¼Œç›´åˆ° socket ä¸»åŠ¨æ–­å¼€ï¼Œæˆ–åœ¨å…¶å®ƒ coroutine ç”¨ socket.close å…³é—­å®ƒã€‚ socket.readall(id) --ä»ä¸€ä¸ª socket ä¸Šè¯»ä¸€è¡Œæ•°æ®ã€‚sep æŒ‡è¡Œåˆ†å‰²ç¬¦ã€‚é»˜è®¤çš„ sep ä¸º \"\\n\"ã€‚è¯»åˆ°çš„å­—ç¬¦ä¸²æ˜¯ä¸åŒ…å«è¿™ä¸ªåˆ†å‰²ç¬¦çš„ã€‚ --å¦‚æœå¦å¤–ä¸€ç«¯å°±å…³é—­äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šè¿”å›ä¸€ä¸ªnilï¼Œå¦‚æœbufferä¸­æœ‰æœªè¯»æ•°æ®åˆ™ä½œä¸ºç¬¬äºŒä¸ªè¿”å›å€¼è¿”å›ã€‚ socket.readline(id, sep) --ç­‰å¾…ä¸€ä¸ª socket å¯è¯»ã€‚ socket.block(id) --æŠŠä¸€ä¸ªå­—ç¬¦ä¸²ç½®å…¥æ­£å¸¸çš„å†™é˜Ÿåˆ—ï¼Œskynet æ¡†æ¶ä¼šåœ¨ socket å¯å†™æ—¶å‘é€å®ƒã€‚ socket.write(id, str) --æŠŠå­—ç¬¦ä¸²å†™å…¥ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å¦‚æœæ­£å¸¸çš„å†™é˜Ÿåˆ—è¿˜æœ‰å†™æ“ä½œæœªå®Œæˆæ—¶ï¼Œä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸Šçš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«å‘å‡ºã€‚ --åªæœ‰åœ¨æ­£å¸¸å†™é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šå¤„ç†ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œæ¯æ¬¡å†™çš„å­—ç¬¦ä¸²éƒ½å¯ä»¥çœ‹æˆåŸå­æ“ä½œã€‚ --ä¸ä¼šåªå‘é€ä¸€åŠï¼Œç„¶åè½¬å»å‘é€æ­£å¸¸å†™é˜Ÿåˆ—çš„æ•°æ®ã€‚ socket.lwrite(id, str) --ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œè¿”å›ä¸€ä¸ª id ï¼Œä¾› start ä½¿ç”¨ã€‚ socket.listen(address, port) --[[ accept æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æ¯å½“ä¸€ä¸ªç›‘å¬çš„ id å¯¹åº”çš„ socket ä¸Šæœ‰è¿æ¥æ¥å…¥çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨ accept å‡½æ•°ã€‚ è¿™ä¸ªå‡½æ•°ä¼šå¾—åˆ°æ¥å…¥è¿æ¥çš„ id ä»¥åŠ ip åœ°å€ã€‚ä½ å¯ä»¥åšåç»­æ“ä½œã€‚ æ¯å½“ accept å‡½æ•°è·å¾—ä¸€ä¸ªæ–°çš„ socket id åï¼Œå¹¶ä¸ä¼šç«‹å³æ”¶åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚ è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šå¸Œæœ›æŠŠè¿™ä¸ª socket çš„æ“ä½œæƒè½¬è®©ç»™åˆ«çš„æœåŠ¡å»å¤„ç†ã€‚accept(id, addr) ]]-- socket.start(id , accept) --[[ ä»»ä½•ä¸€ä¸ªæœåŠ¡åªæœ‰åœ¨è°ƒç”¨ socket.start(id) ä¹‹åï¼Œæ‰å¯ä»¥è¯»åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚ å‘ä¸€ä¸ª socket id å†™æ•°æ®ä¹Ÿéœ€è¦å…ˆè°ƒç”¨ start ã€‚ socket çš„ id å¯¹äºæ•´ä¸ª skynet èŠ‚ç‚¹éƒ½æ˜¯å…¬å¼€çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ id è¿™ä¸ªæ•°å­— é€šè¿‡æ¶ˆæ¯å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œå…¶ä»–æœåŠ¡ä¹Ÿå¯ä»¥å»æ“ä½œå®ƒã€‚skynet æ¡†æ¶æ˜¯æ ¹æ®è°ƒç”¨ start è¿™ä¸ª api çš„ä½ç½®æ¥å†³å®šæŠŠå¯¹åº” socket ä¸Šçš„æ•°æ®è½¬å‘åˆ°å“ªé‡Œå»çš„ã€‚ --]] socket.start(id) --æ¸…é™¤ socket id åœ¨æœ¬æœåŠ¡å†…çš„æ•°æ®ç»“æ„ï¼Œä½†å¹¶ä¸å…³é—­è¿™ä¸ª socket ã€‚ --è¿™å¯ä»¥ç”¨äºä½ æŠŠ id å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œä»¥è½¬äº¤ socket çš„æ§åˆ¶æƒã€‚ socket.abandon(id) --[[ å½“ id å¯¹åº”çš„ socket ä¸Šå¾…å‘çš„æ•°æ®è¶…è¿‡ 1M å­—èŠ‚åï¼Œç³»ç»Ÿå°†å›è°ƒ callback ä»¥ç¤ºè­¦å‘Šã€‚ function callback(id, size) å›è°ƒå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•° id å’Œ size ï¼Œsize çš„å•ä½æ˜¯ K ã€‚ å¦‚æœä½ ä¸è®¾å›è°ƒï¼Œé‚£ä¹ˆå°†æ¯å¢åŠ  64K åˆ©ç”¨ skynet.error å†™ä¸€è¡Œé”™è¯¯ä¿¡æ¯ã€‚ --]] socket.warning(id, callback) socketChannel ç”¨æ¥æ”¯æŒåŒå‘ä¼ è¾“ï¼Œå¼‚æ­¥éå µå¡å¤„ç†æ•°æ® dns skynet.dns --è°ƒç”¨äº†ç³»ç»Ÿ api getaddrinfo ï¼Œæœ‰å¯èƒ½é˜»å¡ä½æ•´ä¸ª socket çº¿ç¨‹ æ‰€ä»¥skynetå°è£…äº†è¿™ä¸ªæ¥å£æ¥è§£å†³dnsæŸ¥è¯¢æ—¶å€™é€ æˆçš„çº¿ç¨‹å µå¡é—®é¢˜ skynet çš„é€šä¿¡è°ƒè¯•pack å®¢æˆ·ç«¯æŒ‰å¤§å°ç«¯æ‰“åŒ…æˆäºŒè¿›åˆ¶\nlocal result = string.pack(\"\u003es2\",\"string2pack\") pack \u003e è¡¨ç¤ºæŒ‰å¤§ç«¯é¡ºåºã€‚s2 è¡¨ç¤ºæŒ‰ç…§2ä¸ªå­—èŠ‚æ‰“åŒ…ã€‚ æˆ‘ä»¬çŸ¥é“stringç”±charç»„æˆã€‚1ä¸ªchar æ˜¯ 0-255 ä¹‹é—´çš„æ•°ï¼Œ2^8 ,1char=8byte éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»–é™¤äº†è¢«æ‰“åŒ…çš„éƒ¨åˆ†ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å‰é¢åŠ 2ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºé•¿åº¦ã€‚ å¦‚æœè¦æ‰“åŒ…ä¸€ä¸ªæ•°å­—åˆ™éœ€è¦è½¬æ¢ã€‚ç”±2ç§åŠæ³• string.pack(\"I2\",number)ï¼Œä¼šåœ¨å‰é¢äºŒè¿›åˆ¶åŠ 2ä½è¡¨ç¤ºé•¿åº¦çš„ä¸œè¥¿ã€‚ socketå‘é€\nsocket.send æœåŠ¡ç«¯æ¥æ”¶\ngateserverå·²ç»æœ‰æ¥æ”¶çš„ä»£ç äº†ã€‚ æ³¨æ„çš„æ˜¯ï¼Œsocketä¼šè‡ªåŠ¨æŒ‰packçš„æ•°æ®åˆ†æ®µæ¥æ”¶ã€‚ä¹Ÿå°±æ˜¯ä¼šæ ¹æ®packçš„å‰é¢2ä½å¾—åˆ°sizeã€‚æ ¹æ®sizeå»æ¥æ”¶åé¢çš„æ•°æ®ã€‚ç„¶åå‘ä¸Šä¼ é€’ä¸€ä»½messageã€‚ æ¥æ”¶åˆ°çš„messageå·²ç»æ˜¯å»æ‰äº†å‰é¢2ä½çš„æ•°æ®ã€‚ å®¢æˆ·ç«¯æ¥æ”¶\næˆ·ç«¯æ¥æ”¶åˆ°çš„æ•°æ®ç›®å‰æˆ‘æ˜¯ç”¨skynetæä¾›çš„â€œclient.socketâ€.æ²¡æœ‰netpackå¯ç”¨ã€‚ æ¥æ”¶åˆ°çš„æ•°æ®éœ€è¦è‡ªè¡Œå»é™¤å‰é¢çš„2ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆstring.packäº§ç”Ÿçš„ï¼‰ã€‚ skynet clientsocket å¯¼è‡´ io.read æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜ https://blog.csdn.net/gneveek/article/details/78940693 ",
  "wordCount" : "8909",
  "inLanguage": "en",
  "image":"https://frog-game.github.io/posts/blog/skynet/Typoraimage-20220228100347880.png","datePublished": "2022-09-15T01:30:29+08:00",
  "dateModified": "2022-09-15T01:30:29+08:00",
  "author":[{
    "@type": "Person",
    "name": "frog"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frog-game.github.io/posts/blog/skynet/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "frog's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frog-game.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://frog-game.github.io/" accesskey="h" title="frog&#39;s Blog (Alt + H)">
            <img src="https://frog-game.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">frog&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://frog-game.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://frog-game.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://frog-game.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://frog-game.github.io/posts/blog/">ğŸ§± æ¬ç –</a></div>
            <h1 class="post-title">
                skynetèµæ
            </h1>
            <div class="post-description">
                äº‘é£skynetèµæ,æ³¨è§£,å›¾ç¤º
            </div>
            <div class="post-meta">åˆ›å»º:&nbsp;<span title='2022-09-15 01:30:29 +0800 CST'>2022-09-15</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2022-09-15&nbsp;|&nbsp;å­—æ•°:&nbsp;8909å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;18åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;frog



                &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://frog-game.github.io/tags/skynet/">skynet</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| è®¿é—®: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://frog-game.github.io/posts/blog/skynet/Typoraimage-20220228100347880.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#linux%e7%bc%96%e8%af%91" aria-label="linuxç¼–è¯‘">linuxç¼–è¯‘</a></li>
                <li>
                    <a href="#%e7%bd%91%e7%bb%9c%e6%b5%81%e7%a8%8b%e5%9b%be" aria-label="ç½‘ç»œæµç¨‹å›¾">ç½‘ç»œæµç¨‹å›¾</a><ul>
                        
                <li>
                    <a href="#work%e7%ba%bf%e7%a8%8b%e5%92%8c%e6%ac%a1%e7%ba%a7%e9%98%9f%e5%88%97" aria-label="workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ—">workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ—</a></li>
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e9%97%ae%e9%a2%98" aria-label="åŒæ­¥é—®é¢˜">åŒæ­¥é—®é¢˜</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e7%b1%bb%e5%9e%8b" aria-label="çº¿ç¨‹ç±»å‹">çº¿ç¨‹ç±»å‹</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%b5%81%e8%bd%ac" aria-label="æ¶ˆæ¯æµè½¬">æ¶ˆæ¯æµè½¬</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b" aria-label="å¯åŠ¨æµç¨‹">å¯åŠ¨æµç¨‹</a></li>
                <li>
                    <a href="#cluster-%e4%b8%a4%e6%9d%a1tcp%e9%80%9a%e9%81%93%e6%80%bb%e7%bb%93" aria-label="cluster ä¸¤æ¡tcpé€šé“æ€»ç»“">cluster ä¸¤æ¡tcpé€šé“æ€»ç»“</a></li>
                <li>
                    <a href="#master--slave-%e7%bb%84%e7%bd%91%e8%bf%87%e7%a8%8b" aria-label="master / slave ç»„ç½‘è¿‡ç¨‹">master / slave ç»„ç½‘è¿‡ç¨‹</a></li>
                <li>
                    <a href="#master-slave-%e6%96%ad%e7%bd%91%e8%bf%87%e7%a8%8b" aria-label="master /slave æ–­ç½‘è¿‡ç¨‹">master /slave æ–­ç½‘è¿‡ç¨‹</a></li>
                <li>
                    <a href="#harbor-%e6%9c%8d%e5%8a%a1" aria-label="harbor æœåŠ¡">harbor æœåŠ¡</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86%e6%96%b9%e5%bc%8f" aria-label="æ¶ˆæ¯å¤„ç†æ–¹å¼">æ¶ˆæ¯å¤„ç†æ–¹å¼</a></li>
                <li>
                    <a href="#%e9%94%81" aria-label="é”">é”</a><ul>
                        
                <li>
                    <a href="#%e4%ba%92%e6%96%a5%e9%94%81" aria-label="äº’æ–¥é”"><code>äº’æ–¥é”</code></a></li>
                <li>
                    <a href="#%e8%87%aa%e6%97%8b%e9%94%81" aria-label="è‡ªæ—‹é”"><code>è‡ªæ—‹é”</code></a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e9%94%81" aria-label="è¯»å†™é”"><code>è¯»å†™é”</code></a><ul>
                        
                <li>
                    <a href="#%e8%af%bb%e4%bc%98%e5%85%88%e9%94%81" aria-label="è¯»ä¼˜å…ˆé”"><code>è¯»ä¼˜å…ˆé”</code></a></li>
                <li>
                    <a href="#%e5%86%99%e4%bc%98%e5%85%88%e9%94%81" aria-label="å†™ä¼˜å…ˆé”"><code>å†™ä¼˜å…ˆé”</code></a></li>
                <li>
                    <a href="#%e5%85%ac%e5%b9%b3%e8%af%bb%e5%86%99%e9%94%81" aria-label="å…¬å¹³è¯»å†™é”"><code>å…¬å¹³è¯»å†™é”</code></a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b9%90%e8%a7%82%e9%94%81%e5%92%8c%e6%82%b2%e8%a7%82%e9%94%81%e5%8c%ba%e5%88%ab" aria-label="ä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ«"><code>ä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ«</code></a></li>
                <li>
                    <a href="#%e9%87%8d%e5%85%a5%e9%94%81" aria-label="é‡å…¥é”"><code>é‡å…¥é”</code></a></li></ul>
                </li>
                <li>
                    <a href="#cluster-%e6%a8%a1%e5%bc%8f" aria-label="cluster æ¨¡å¼">cluster æ¨¡å¼</a></li>
                <li>
                    <a href="#%e7%ae%80%e6%98%93%e7%9a%84mmo-%e6%9e%b6%e6%9e%84" aria-label="ç®€æ˜“çš„mmo æ¶æ„">ç®€æ˜“çš„mmo æ¶æ„</a></li>
                <li>
                    <a href="#%e7%bd%91%e5%85%b3%e6%9c%8d%e5%8a%a1" aria-label="ç½‘å…³æœåŠ¡">ç½‘å…³æœåŠ¡</a></li>
                <li>
                    <a href="#%e5%8d%8f%e7%a8%8b" aria-label="åç¨‹">åç¨‹</a><ul>
                        
                <li>
                    <a href="#%e6%b4%be%e5%8f%91%e6%b6%88%e6%81%af" aria-label="æ´¾å‘æ¶ˆæ¯">æ´¾å‘æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e5%a4%84%e7%90%86%e5%bd%93%e5%89%8d%e6%b6%88%e6%81%af" aria-label="å¤„ç†å½“å‰æ¶ˆæ¯">å¤„ç†å½“å‰æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%8d%8f%e7%a8%8b" aria-label="åˆ›å»ºåç¨‹">åˆ›å»ºåç¨‹</a></li>
                <li>
                    <a href="#%e5%8d%8f%e7%a8%8b%e6%8c%82%e8%b5%b7" aria-label="åç¨‹æŒ‚èµ·">åç¨‹æŒ‚èµ·</a></li>
                <li>
                    <a href="#%e5%8d%8f%e7%a8%8b%e9%94%80%e6%af%81" aria-label="åç¨‹é”€æ¯">åç¨‹é”€æ¯</a></li></ul>
                </li>
                <li>
                    <a href="#sendcall-%e6%b5%81%e7%a8%8b" aria-label="send.call æµç¨‹">send.call æµç¨‹</a></li>
                <li>
                    <a href="#api-%e7%9b%b8%e5%85%b3" aria-label="API ç›¸å…³">API ç›¸å…³</a><ul>
                        
                <li>
                    <a href="#cluster" aria-label="cluster">cluster</a></li>
                <li>
                    <a href="#harbor" aria-label="harbor">harbor</a></li>
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e6%9c%8d%e5%8a%a1%e7%9a%84%e4%b8%80%e4%ba%9b%e5%9f%ba%e7%a1%80%e6%8e%a5%e5%8f%a3" aria-label="æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£">æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£</a></li>
                <li>
                    <a href="#%e6%99%ae%e9%80%9a%e6%9c%8d%e5%8a%a1" aria-label="æ™®é€šæœåŠ¡">æ™®é€šæœåŠ¡</a></li>
                <li>
                    <a href="#%e5%85%a8%e5%b1%80%e5%94%af%e4%b8%80%e6%9c%8d%e5%8a%a1" aria-label="å…¨å±€å”¯ä¸€æœåŠ¡">å…¨å±€å”¯ä¸€æœåŠ¡</a></li>
                <li>
                    <a href="#%e5%88%ab%e5%90%8d" aria-label="åˆ«å">åˆ«å</a></li>
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e8%b0%83%e5%ba%a6" aria-label="æœåŠ¡è°ƒåº¦">æœåŠ¡è°ƒåº¦</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e7%b1%bb%e5%9e%8b" aria-label="æ¶ˆæ¯ç±»å‹">æ¶ˆæ¯ç±»å‹</a></li>
                <li>
                    <a href="#%e6%89%93%e5%8c%85%e8%a7%a3%e5%8c%85" aria-label="æ‰“åŒ…è§£åŒ…">æ‰“åŒ…è§£åŒ…</a></li>
                <li>
                    <a href="#%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" aria-label="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e5%93%8d%e5%ba%94%e6%b6%88%e6%81%af" aria-label="å“åº”æ¶ˆæ¯">å“åº”æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e5%86%b2%e5%85%a5%e6%97%b6%e5%ba%8f%e9%97%ae%e9%a2%98" aria-label="æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜">æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜</a></li>
                <li>
                    <a href="#%e5%8d%8f%e8%ae%ae%e8%bd%ac%e6%8d%a2" aria-label="åè®®è½¬æ¢">åè®®è½¬æ¢</a></li>
                <li>
                    <a href="#%e4%bc%aa%e9%80%a0%e6%b6%88%e6%81%af" aria-label="ä¼ªé€ æ¶ˆæ¯">ä¼ªé€ æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e7%bb%84%e6%92%ad" aria-label="ç»„æ’­">ç»„æ’­</a></li>
                <li>
                    <a href="#socket" aria-label="socket">socket</a></li>
                <li>
                    <a href="#socketchannel" aria-label="socketChannel">socketChannel</a></li>
                <li>
                    <a href="#dns" aria-label="dns">dns</a></li></ul>
                </li>
                <li>
                    <a href="#skynet-%e7%9a%84%e9%80%9a%e4%bf%a1%e8%b0%83%e8%af%95pack" aria-label="skynet çš„é€šä¿¡è°ƒè¯•pack">skynet çš„é€šä¿¡è°ƒè¯•pack</a></li>
                <li>
                    <a href="#skynet-clientsocket-%e5%af%bc%e8%87%b4-ioread-%e6%97%a0%e6%b3%95%e6%ad%a3%e7%a1%ae%e5%b7%a5%e4%bd%9c%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="skynet clientsocket å¯¼è‡´ io.read æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜">skynet clientsocket å¯¼è‡´ io.read æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="linuxç¼–è¯‘">linuxç¼–è¯‘<a hidden class="anchor" aria-hidden="true" href="#linuxç¼–è¯‘">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make linux MALLOC_STATICLIB<span style="color:#f92672">=</span> SKYNET_DEFINES<span style="color:#f92672">=</span>-DNOUSE_JEMALLOC
</span></span></code></pre></div><h2 id="ç½‘ç»œæµç¨‹å›¾">ç½‘ç»œæµç¨‹å›¾<a hidden class="anchor" aria-hidden="true" href="#ç½‘ç»œæµç¨‹å›¾">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228100347880.png" alt="Typoraimage-20220228100347880"  />
</p>
<h3 id="workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ—">workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ—">#</a></h3>
<blockquote>
<p>æ¯ä¸ªåœ¨çº¿å®¢æˆ·ç«¯åœ¨SkynetæœåŠ¡å™¨ä¸Šéƒ½å¯¹åº”æœ‰ä¸€ä¸ªSocketä¸å…¶è¿æ¥ï¼Œä¸€ä¸ªSocketåœ¨Skynetå†…éƒ¨å¯¹åº”ä¸€ä¸ªLuaè™šæ‹Ÿæœºå’Œä¸€ä¸ªå®¢æˆ·ç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—per client mqã€‚å½“å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯æ—¶ï¼Œè¯¥é˜Ÿåˆ—ä¼šæŒ‚è½½åˆ°å…¨å±€é˜Ÿåˆ—global message queueä¸Šä¾›å·¥ä½œçº¿ç¨‹worker Threadsè¿›è¡Œè°ƒåº¦å¤„ç†ã€‚</p>
<p>ä¸€ä¸ªSocketçº¿ç¨‹socket threadä¼šè½®è¯¢æ‰€æœ‰çš„Socketï¼Œå½“æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åå°†è¯·æ±‚æ‰“åŒ…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘é€åˆ°è¯¥Socketå¯¹åº”çš„å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—per client mqä¸­ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯é˜Ÿåˆ—æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚</p>
<p>å¤šä¸ªWorkerå·¥ä½œçº¿ç¨‹worker threadsä»å…¨å±€é˜Ÿåˆ—å¤´éƒ¨è·å–å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæ¯•åå†å°†æ¶ˆæ¯é˜Ÿåˆ—é‡æ–°æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚</p>
<p>skynetä¸­ä¸åŒæœåŠ¡æ˜¯åˆ©ç”¨ç³»ç»Ÿçš„å¤šçº¿ç¨‹å®Œå…¨å¹¶è¡Œçš„ï¼Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bå’ŒæœåŠ¡Cåˆ†åˆ«å„è‡ªå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå¹¶ä¸èƒ½ä¿è¯å…ˆå‘çš„æ¶ˆæ¯å…ˆè¢«å¤„ç†ã€‚è€Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bä¾æ¬¡å‘é€ä¸¤æ¡æ¶ˆæ¯æ—¶ï¼Œå…ˆå‘çš„æ¶ˆæ¯ä¸€å®šä¼šè¢«æœåŠ¡Bå…ˆå¤„ç†ã€‚</p>
<p>ä½¿ç”¨Luaå®ç°çš„æœåŠ¡åªæ˜¯ä¸€ä¸ªå†…åµŒäº†Luaè™šæ‹Ÿæœºçš„æœåŠ¡ï¼Œä¹Ÿéµå®ˆä¸Šé¢çš„è§„åˆ™ã€‚å¦‚æœæœåŠ¡Bæ˜¯ä¸€ä¸ªLuaæœåŠ¡ï¼Œå½“æœåŠ¡Aå‘æœåŠ¡Bå‘é€ä¸¤æ¡æ¶ˆæ¯xå’Œyæ—¶ï¼ŒSkynetä¸€å®šä¿è¯xå…ˆè¢«æœåŠ¡Bä¸­çš„Luaè™šæ‹Ÿæœºæ¥æ”¶åˆ°ï¼Œå¹¶ä¸ºæ¶ˆæ¯xç”Ÿæˆè¦ç»™åç¨‹Xï¼Œå¹¶è¿è¡Œè¿™ä¸ªåç¨‹ã€‚ç„¶åæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯yï¼Œå¹¶é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„åç¨‹Yå¹¶è¿è¡Œã€‚</p>
</blockquote>
<h3 id="åŒæ­¥é—®é¢˜">åŒæ­¥é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#åŒæ­¥é—®é¢˜">#</a></h3>
<p>åŒæ­¥ä¹Ÿæ˜¯skynetå­˜åœ¨çš„é—®é¢˜ï¼Œå½“ä¸€ä¸ªæœåŠ¡callå…¶ä»–æœåŠ¡æ—¶ï¼Œå½“å‰åç¨‹ä¼šæŒ‚èµ·ï¼Œä½†æ˜¯è¿™ä¸ªæœåŠ¡è¿˜å¯ä»¥æ¥å—å¹¶å¤„ç†å…¶ä»–æ¶ˆæ¯ã€‚å¦‚æœå¤šä¸ªåç¨‹æ”¹åˆ°åŒä¸€ä¸ªæ•°æ®ï¼Œä½ ä¸åšåŒæ­¥å¤„ç†å°±æ— æ³•ç¡®å®šè¿™ä¸ªæ•°æ®ä¼šæ˜¯å¤šå°‘ã€‚</p>
<p>è¿™æ ·çš„ä¾‹å­ç‰¹åˆ«å¸¸è§ï¼Œæ¯”å¦‚ï¼ŒæœåŠ¡æ­£å½“å¤„ç†ç©å®¶loginè¯·æ±‚ï¼Œåˆšå¥½é‡åˆ°callæŒ‚èµ·ï¼Œè¿™æ—¶å€™åˆæœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œæ¯”å¦‚logoutï¼ŒæœåŠ¡å°±ä¼šè½¬å»å¤„ç†logoutæ¶ˆæ¯ã€‚é‚£ç©å®¶ç©¶ç«Ÿæ˜¯loginï¼Œè¿˜æ˜¯logoutï¼Ÿ</p>
<p>å½“ç„¶ï¼ŒåŒæ­¥é—®é¢˜ä¹Ÿå®¹æ˜“è§£å†³ï¼ŒåŠ å¤šä¸€ä¸ªstateçš„æ ‡è¯†å’Œä¸€ä¸ªåç¨‹åˆ—è¡¨ï¼Œæ“ä½œæ‰§è¡Œæ—¶ï¼Œå°†stateç½®doingï¼Œå…¶ä»–åç¨‹åˆ¤æ–­state=doingæ—¶å°±å°†è‡ªå·±åŠ åˆ°åç¨‹åˆ—è¡¨ï¼Œç„¶å skynet.waitã€‚åœ¨æ“ä½œæ‰§è¡Œå®Œåï¼Œé‡ç½®stateï¼Œç„¶åéå†åç¨‹åˆ—è¡¨ä¾æ¬¡ skynet.wakeup(co) ï¼Œæœ€åå°†åç¨‹åˆ—è¡¨ç½®ç©ºã€‚</p>
<h3 id="è§£é‡Šæ­¤é˜Ÿåˆ—typoraimage-20220228101336039typoraimage-20220228101336039png">è§£é‡Šæ­¤é˜Ÿåˆ—<img loading="lazy" src="Typoraimage-20220228101336039.png" alt="Typoraimage-20220228101336039"  />
</h3>
<blockquote>
<p>çº¢é»‘æ ‘ä¸Šçš„èŠ‚ç‚¹æ˜¯æ‰€æœ‰ç›‘å¬çš„socket
é»„è‰²åº•çš„æ˜¯interesting é˜Ÿåˆ— è“è‰²åº•æ˜¯é»„è‰²åº•çš„å­é˜Ÿåˆ— ä¹Ÿå°±æ˜¯å°±ç»ªé˜Ÿåˆ—
epoll_ctrl() æ‰§è¡Œå¢åŠ æ“ä½œæ—¶å€™å°±æ˜¯å¾€interestingé˜Ÿåˆ—å¡socket
å½“æœ‰è¯»å†™äº‹ä»¶æ—¶å€™ï¼Œå°±ä¼šå¾€è“è‰²åº•é˜Ÿåˆ—æ”¾å…¥socketä¹Ÿå°±æ˜¯å¡å…¥å°±ç»ªé˜Ÿåˆ—
é€šè¿‡epoll_wait()æŠŠå°±ç»ªé˜Ÿåˆ—çš„ä¸œè¥¿è¿”å›å‡ºæ¥</p>
</blockquote>
<h3 id="çº¿ç¨‹ç±»å‹">çº¿ç¨‹ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹ç±»å‹">#</a></h3>
<blockquote>
<p><code>socket thread </code>: çº¿ç¨‹è¿›ç¨‹æ¶ˆæ¯æ”¶å‘</p>
<p><code>monitor thread</code> :  çº¿ç¨‹ç›‘æ§æœåŠ¡æ˜¯ä¸æ˜¯é™·å…¥æ­»å¾ªç¯ï¼Œæ¶ˆæ¯æ˜¯å¦å µä½</p>
<p><code>time thread </code>: çº¿ç¨‹ä¸»è¦ç”¨äºå®ç°skynetçš„å®šæ—¶å™¨</p>
<p><code>work thread</code> çº¿ç¨‹ å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè°ƒåº¦</p>
</blockquote>
<h3 id="æ¶ˆæ¯æµè½¬">æ¶ˆæ¯æµè½¬<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯æµè½¬">#</a></h3>
<blockquote>
<ol>
<li>å…ˆä»å…¨å±€é˜Ÿåˆ—<code>pop</code>ä¸€ä¸ªæ¬¡çº§é˜Ÿåˆ—ï¼Œç„¶åä»æ¬¡çº§é˜Ÿåˆ—<code>pop</code>ä¸€ä¸ªæ¶ˆæ¯è°ƒç”¨å›è°ƒå‡½æ•°è¿›è¡Œé€»è¾‘å¤„ç†</li>
<li>ç”¨å®Œä»¥åå¦‚æœæ¬¡çº§é˜Ÿåˆ—ä¸ä¸ºç©ºæˆ–è€…å µå¡ï¼Œç»§ç»­æŠŠæ¬¡çº§é˜Ÿåˆ—æ”¾å…¥å…¨å±€é˜Ÿåˆ—</li>
</ol>
</blockquote>
<h2 id="å¯åŠ¨æµç¨‹">å¯åŠ¨æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#å¯åŠ¨æµç¨‹">#</a></h2>
<ol>
<li>
<p>åŠ è½½é…ç½®æ–‡ä»¶</p>
</li>
<li>
<p>é…ç½®æ–‡ä»¶å­˜å…¥luaçš„å…¨å±€å˜é‡env</p>
</li>
<li>
<p>åˆ›å»ºå’Œå¯åŠ¨cæœåŠ¡<code>logger</code></p>
</li>
<li>
<p>å¯åŠ¨å¼•å¯¼æ¨¡å—å¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªluaæœåŠ¡(<code>bootstrap</code>)</p>
</li>
<li>
<p>ç„¶ååœ¨é€šè¿‡<code>bootstrap</code>é…ç½®å»å¯åŠ¨å…¶ä»–çš„å¾®æœåŠ¡</p>
</li>
</ol>
<h2 id="cluster-ä¸¤æ¡tcpé€šé“æ€»ç»“">cluster ä¸¤æ¡tcpé€šé“æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#cluster-ä¸¤æ¡tcpé€šé“æ€»ç»“">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228113906508.png" alt="Typoraimage-20220228113906508"  />
</p>
<p><strong><font color='red'>å‰æ</font></strong>
ä¸¤ç«¯æ˜¯ä¸¥æ ¼åˆ†ä¸ºè¯·æ±‚æ–¹å’Œå›åº”æ–¹ã€‚æ¯”å¦‚<code> A---&gt; B</code> ï¼Œé‚£ä¹ˆåªèƒ½æ˜¯Aå‘Bæå‡ºè¯·æ±‚ï¼ŒB å›åº”å®ƒï¼›å¦‚æœ <code>B-----&gt;&gt;A</code> éœ€è¦ç”± B å‘ A å†å»ºç«‹ä¸€æ¡é€šé“ã€‚</p>
<p>TCPç‰¹æ€§ä½¿å¾—æ¯ä¸ªTCPè¿æ¥å¯ä»¥å¾—åˆ°å‡ç­‰çš„å¸¦å®½ã€‚åœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰è¶Šå¤šTCPè¿æ¥ï¼Œè·å¾—çš„å¸¦å®½è¶Šå¤§</p>
<blockquote>
<p>1æ¡è¿æ¥
<strong>ä¼˜ç‚¹</strong>ï¼šé“¾æ¥å°‘ï¼Œå¯¹äºæ²¡æœ‰æ¥è§¦è¿‡skynetï¼Œä¼ ç»ŸæœåŠ¡å™¨äººå¾ˆå®¹æ˜“è¿™ç§æ–¹å¼è¿æ¥æ–¹å¼ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¾ˆå¤šéƒ½æ˜¯csç»“æ„ç¨‹åºå‘˜è¿‡æ¥çš„
**ç¼ºç‚¹ï¼š**å¦‚æœæ–­äº†ï¼Œæ•°æ®å°±æ— æ³•ä¼ è¾“ï¼Œå¾—é‡æ–°å»ºç«‹æ–°çš„è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œéœ€è¦æ¸…æ¥šé‚£è¾¹æ˜¯å‘é€æ–¹ï¼Œé‚£è¾¹æ˜¯æ¥å—æ–¹</p>
</blockquote>
<blockquote>
<p>2æ¡è¿æ¥
**ä¼˜ç‚¹ï¼š**åœ¨å‰é¢å‰æçš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸¤æ¡è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘ç¨‹åºå‘˜ä¸éœ€è¦å…³å¿ƒæˆ‘è¿™ä¸ªæ—¶å€™æ˜¯clientï¼Œè¿˜æ˜¯serverï¼Œåªéœ€è¦é€šè¿‡<code>cluster.call</code>ï¼Œ<code>cluster.send</code>ï¼Œæ¥å£ç›´æ¥å¾€é‡Œé¢å¡æ•°æ®å°±è¡Œäº†ï¼Œå¤šæ¡è¿æ¥ä¹Ÿä¾¿äºæŠ¢å¸¦å®½
**ç¼ºç‚¹:**å¤šäº†ä¸€æ¡è¿æ¥ï¼Œå¯¹csç»“æ„è¿‡æ¥çš„ç¨‹åºå‘˜ä¸å¤ªå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆå¼„æœ‰å¥½å¤„ï¼Œæˆ–è€…æ˜¯ä¸çŸ¥é“æœ‰å‰é¢é‚£ä¸ªå‰æ
ä¸ºä»€ä¹ˆä¸åœ¨å¼€è¾Ÿæ›´å¤šçš„è¿æ¥ï¼Œå› ä¸ºå¼€è¾Ÿæ›´å¤šçš„é“¾æ¥æ„ä¹‰ä¸å¤§ï¼Œå¦‚æœè¿™å°æœºå™¨ä¸Šå¼„äº†ä¸å°‘è¿›ç¨‹ï¼Œè¿æ¥æ•°å’Œæœºå™¨çš„é…ç½®ä¹Ÿæ˜¯æœ‰å…³ç³»çš„ï¼Œå¤šäº†ï¼Œå¦‚æœç”¨ä¸ä¸Šä¹Ÿæ˜¯ä¸€ç§æµªè´¹ï¼ŒåŒæ—¶å¯¹äºä¸šåŠ¡ç¨‹åºå‘˜æ¥è¯´ä¹Ÿé€»è¾‘æ··ä¹±ï¼Œ
å› ä¸ºå‡å¦‚æ˜¯4æ¡ï¼Œé‚£ä¹ˆæ¥å—æ–¹è¿˜å¾—åŒºåˆ†æ˜¯é‚£æ¡å‘è¿‡æ¥çš„æ•°æ®</p>
</blockquote>
<h2 id="master--slave-ç»„ç½‘è¿‡ç¨‹">master / slave ç»„ç½‘è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#master--slave-ç»„ç½‘è¿‡ç¨‹">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228105701937.png" alt="Typoraimage-20220228105701937"  />
</p>
<ol>
<li><code>slave3</code>å‘é€<code>sync</code>ç»™<code>master</code>ï¼Œå¹¶å¯åŠ¨è‡ªå·±çš„<code>listen</code></li>
<li><code>master</code>æ”¶åˆ°ä¿¡æ¯ç»™å·²ç»è¿æ¥ä¸Šçš„<code>slave1</code>ï¼Œ<code>slave2</code>å‘é€<code>slave3</code>è¯·æ±‚è¿æ¥çš„æƒ…å†µ</li>
<li><code>master</code>ç»™<code>slave3</code>å‘é€å½“å‰å·²ç»è¿æ¥ä¸Šçš„<code>slave</code>æ•°é‡ï¼Œå¹¶æŠŠ<code>slave3</code>åŠ å…¥èŠ‚ç‚¹ç»„</li>
<li><code>slave1</code>ï¼Œ<code>slave3</code>æ¥æ”¶åˆ°<code>master</code>å‘é€çš„ä¿¡æ¯åï¼Œè°ƒç”¨<code>connect</code>å»è¿æ¥<code>slave3</code></li>
</ol>
<h2 id="master-slave-æ–­ç½‘è¿‡ç¨‹">master /slave æ–­ç½‘è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#master-slave-æ–­ç½‘è¿‡ç¨‹">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228110016236.png" alt="Typoraimage-20220228110016236"  />
</p>
<ol>
<li><code>master</code>æ£€æµ‹åˆ°<code>slave3</code>å¤±å»è¿æ¥ï¼ŒæŠŠ<code>slave3</code>è¿æ¥<code>fd</code>ç½®æˆ<code>0</code></li>
<li><code>master</code>æŠŠå¤±å»è¿æ¥çš„<code>slave3 id </code>å¹¿æ’­ç»™<code>slave1</code>ï¼Œ<code>slave2</code></li>
<li><code>slave1</code>ï¼Œ<code>slave2</code>å¾—åˆ°<code>slave3 id</code>ä¹‹åå’Œ<code>slave3</code>æ–­å¼€è¿æ¥</li>
</ol>
<h2 id="harbor-æœåŠ¡">harbor æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#harbor-æœåŠ¡">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228110247888.png" alt="Typoraimage-20220228110247888"  />
</p>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª<code>harborid</code>ï¼Œåœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ª<code>harborid</code>æ”¾åˆ°æ¶ˆæ¯<code>id</code>çš„</p>
<p>é«˜8ä½ï¼Œæ‰€ä»¥é€šè¿‡é«˜8ä½çš„å¯¹æ¯”å°±çŸ¥é“è¿™ä¸ªæ¶ˆæ¯æ˜¯è¿œç¨‹æ¶ˆæ¯ï¼Œè¿˜æ˜¯æœ¬åœ°æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯è¿œç¨‹æ¶ˆæ¯</p>
<p>é€šè¿‡<code>harbor</code>å’Œè¿œç¨‹çš„<code>harbor</code>å»ºç«‹<code>tcp</code>è¿æ¥å‘é€æ•°æ®è¿‡å»ï¼Œå¦‚æœæ˜¯æœ¬åœ°ç›´æ¥æ”¾å…¥æœ¬åœ°èŠ‚ç‚¹å¤„ç†é€»è¾‘</p>
<h2 id="æ¶ˆæ¯å¤„ç†æ–¹å¼">æ¶ˆæ¯å¤„ç†æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯å¤„ç†æ–¹å¼">#</a></h2>
<ul>
<li><code>skeynet.send</code> éå µå¡ä¸éœ€è¦åº”ç­”</li>
<li><code>skynet.call</code> å µå¡éœ€è¦åº”ç­”</li>
<li><code>skynet.ret</code> å›åº”æ¶ˆæ¯</li>
<li><code>skynet.response</code> è¯·æ±‚å’Œç›¸åº”åœ¨ä¸ç”¨åç¨‹å¤„ç†</li>
<li><code>skynet.queue</code> ä¸²è¡ŒåŒ–æ¶ˆæ¯æ‰§è¡Œ</li>
</ul>
<h2 id="é”">é”<a hidden class="anchor" aria-hidden="true" href="#é”">#</a></h2>
<h3 id="äº’æ–¥é”"><code>äº’æ–¥é”</code><a hidden class="anchor" aria-hidden="true" href="#äº’æ–¥é”">#</a></h3>
<p>é€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´&gt;çº¿ç¨‹åˆ‡æ¢æ—¶é—´åœºæ™¯ å¾—åˆ°é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’å¤„ç†é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€</p>
<p><code>äº’æ–¥é”åŠ é”å¤±è´¥</code>ä»¥åï¼Œä¼šä»ç”¨æˆ·æ€å˜æˆå†…æ ¸æ€ï¼Œçº¿ç¨‹å°±ä¼šé‡Šæ”¾<code>CPU</code> ç»™å…¶ä»–çº¿ç¨‹,<code>ä¼šæœ‰ä¸¤æ¬¡çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æˆæœ¬</code></p>
<ol>
<li>çº¿ç¨‹åŠ é”å¤±è´¥æ—¶ï¼Œå†…æ ¸ä¼šæŠŠçº¿ç¨‹çš„çŠ¶æ€ä»<code>ã€Œè¿è¡Œã€</code>çŠ¶æ€è®¾ç½®ä¸º<code>ã€Œç¡çœ ã€</code>çŠ¶æ€ï¼Œç„¶åæŠŠ CPU åˆ‡æ¢ç»™å…¶ä»–çº¿ç¨‹è¿è¡Œ</li>
<li>æ¥ç€ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œä¹‹å‰<code>ã€Œç¡çœ ã€</code>çŠ¶æ€çš„çº¿ç¨‹ä¼šå˜ä¸ºã€Œ<code>å°±ç»ªã€</code>çŠ¶æ€ï¼Œç„¶åå†…æ ¸ä¼šåœ¨åˆé€‚çš„æ—¶é—´ï¼ŒæŠŠ CPU åˆ‡æ¢ç»™è¯¥çº¿ç¨‹è¿è¡Œã€‚</li>
</ol>
<p>ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ï¼Œå¤§æ¦‚åœ¨å‡ åçº³ç§’åˆ°å‡ å¾®å¦™ä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœä½ èƒ½ç¡®è®¤ä½ è¢«é”ä½çš„ä»£ç æ—¶é—´å¾ˆçŸ­ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥ç”¨äº’æ–¥é”ï¼Œè€Œåº”è¯¥ç”¨è‡ªæ—‹é”</p>
<p><img loading="lazy" src="Typoraimage-20220301214016070.png" alt="Typoraimage-20220301214016070"  />
</p>
<h3 id="è‡ªæ—‹é”"><code>è‡ªæ—‹é”</code><a hidden class="anchor" aria-hidden="true" href="#è‡ªæ—‹é”">#</a></h3>
<p>æ²¡æœ‰è·å–åˆ°æƒé™çš„çš„çº¿ç¨‹ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ä¸€ç›´è‡ªæ—‹æ£€æµ‹æ˜¯å¦èƒ½è·å–èµ„æºï¼Œé€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´&lt; çº¿ç¨‹åˆ‡æ¢æ—¶é—´çš„åœºæ™¯ï¼Œå¾—åˆ°é”å¤„ç†é€»è¾‘æœ€å¥½åˆ«æœ‰IOæ“ä½œæˆ–è€…æ–‡ä»¶æµæ“ä½œ</p>
<p>è‡ªæ—‹é”æ˜¯é€šè¿‡<code>cpu</code>çš„<code>CAS</code>å‡½æ•°ï¼Œåœ¨ç”¨æˆ·æ€å°±å®Œæˆäº†åŠ é”å’Œè§£é”æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œç›¸æ¯”äº’æ–¥é”æ¥è¯´ï¼Œä¼šå¿«ä¸€ç‚¹</p>
<p>ä¸€èˆ¬åŠ é”çš„è¿‡ç¨‹æœ‰ä¸¤æ­¥</p>
<ol>
<li>æŸ¥çœ‹é”çš„çŠ¶æ€ï¼Œå¦‚æœé”æ˜¯ç©ºé—²çš„ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬äºŒæ­¥</li>
<li>å°†é”è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰</li>
</ol>
<p><code>è‡ªæ—‹é”åŠ é”å¤±è´¥</code>ä»¥åçº¿ç¨‹ä¼š<code>å¿™ç­‰å¾…</code>ï¼Œç›´åˆ°å®ƒèƒ½<code>æ‹¿åˆ°é”</code></p>
<h3 id="è¯»å†™é”"><code>è¯»å†™é”</code><a hidden class="anchor" aria-hidden="true" href="#è¯»å†™é”">#</a></h3>
<p>å®ç°åœ¨<code>rwlock.h</code>ä¸­</p>
<p><code>è¯»é”</code>æ˜¯<code>å…±äº«</code>é”æ¦‚å¿µï¼Œå…¶ä»–é”å»è¯»çš„æ—¶å€™è¯»å–çš„æ˜¯å…±äº«çš„èµ„æºï¼Œ</p>
<p><code>å†™é”</code>æ˜¯<code>ç‹¬å </code>æ¦‚å¿µï¼Œå…¶ä»–é”åªèƒ½ç­‰å¾…æŠ¢å åˆ°çš„é”é‡Šæ”¾èµ„æºï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯</p>
<p>æ‰€ä»¥æ›´å…·åœºæ™¯å¯ä»¥åˆ†ä¸º<code>è¯»ä¼˜å…ˆé”</code>å’Œ<code>å†™ä¼˜å…ˆé”</code></p>
<h4 id="è¯»ä¼˜å…ˆé”"><code>è¯»ä¼˜å…ˆé”</code><a hidden class="anchor" aria-hidden="true" href="#è¯»ä¼˜å…ˆé”">#</a></h4>
<p><img loading="lazy" src="Typoraimage-20220301220450723.png" alt="Typoraimage-20220301220450723"  />
</p>
<p><code>è¯»ä¼˜å…ˆé”</code>å¯¹äºè¯»çº¿ç¨‹å¹¶å‘æ€§æ›´å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€ç›´æœ‰<code>è¯»çº¿ç¨‹</code>è·å–é”ï¼Œé‚£ä¹ˆ<code>å†™çº¿ç¨‹</code>å°±ä¼šè¢«é¥¿æ­»</p>
<h4 id="å†™ä¼˜å…ˆé”"><code>å†™ä¼˜å…ˆé”</code><a hidden class="anchor" aria-hidden="true" href="#å†™ä¼˜å…ˆé”">#</a></h4>
<p><img loading="lazy" src="Typoraimage-20220301220728053.png" alt="Typoraimage-20220301220728053"  />
</p>
<p><code>å†™ä¼˜å…ˆé”</code>å¯ä»¥ä¿è¯<code>å†™çº¿ç¨‹</code>ä¸è¢«é¥¿æ­»ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æœ‰<code>å†™çº¿ç¨‹</code>è·å–ï¼Œé‚£ä¹ˆ<code>è¯»çº¿ç¨‹</code>ä¹Ÿä¼šè¢«é¥¿æ­»</p>
<p>æ‰€ä»¥ä¸ç®¡æ˜¯ä¼˜å…ˆè¯»é”è¿˜æ˜¯å†™é”ï¼Œå¯¹æ–¹éƒ½å¯èƒ½è¢«é¥¿æ­»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åè¢’ä»»ä½•ä¸€æ–¹ï¼Œæä¸ª<code>å…¬å¹³è¯»å†™é”</code></p>
<h4 id="å…¬å¹³è¯»å†™é”"><code>å…¬å¹³è¯»å†™é”</code><a hidden class="anchor" aria-hidden="true" href="#å…¬å¹³è¯»å†™é”">#</a></h4>
<p>ç”¨é˜Ÿåˆ—æŠŠè·å–é”çš„çº¿ç¨‹æ’é˜Ÿï¼Œä¸ç®¡æ˜¯å†™çº¿ç¨‹è¿˜æ˜¯è¯»çº¿ç¨‹éƒ½æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™åŠ é”ï¼Œè¿™æ ·è¯»çº¿ç¨‹ä¸€æ ·èƒ½å¹¶å‘ï¼Œä¹Ÿä¸ä¼šå‡ºç°é¥¥é¥¿ç°è±¡</p>
<h3 id="ä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ«"><code>ä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ«</code><a hidden class="anchor" aria-hidden="true" href="#ä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ«">#</a></h3>
<p><code>æ‚²è§‚é”</code>åšäº‹æ¯”è¾ƒæ‚²è§‚ï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨è®¿é—®èµ„æºä¹‹å‰éƒ½ä¼šå…ˆä¸Šä¸€æŠŠé”ã€‚</p>
<p><code>ä¹è§‚é”</code>æ­£å¥½ç›¸åï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥ä¼šè®©å…ˆä¿®æ”¹å®Œèµ„æºï¼Œç„¶ååœ¨åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å†²çªï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„çº¿ç¨‹åœ¨ä¿®æ”¹èµ„æºï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥æ”¾å¼ƒæœ¬æ¬¡æ“ä½œï¼Œ</p>
<p>äº’æ–¥é”ã€è‡ªæ—‹é”ã€è¯»å†™é”ï¼Œéƒ½æ˜¯å±äº<code>æ‚²è§‚é”</code></p>
<h3 id="é‡å…¥é”"><code>é‡å…¥é”</code><a hidden class="anchor" aria-hidden="true" href="#é‡å…¥é”">#</a></h3>
<p><img loading="lazy" src="Typoraimage-20220301223631466.png" alt="Typoraimage-20220301223631466"  />
</p>
<p>å°±æ˜¯èƒ½ä¸€æ¡çº¿ç¨‹ä¸Šèƒ½é‡å¤è·å–çš„é”ï¼Œè€Œä¸å¯¼è‡´æ­»é”</p>
<h2 id="cluster-æ¨¡å¼">cluster æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#cluster-æ¨¡å¼">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228110904150.png" alt="Typoraimage-20220228110904150"  />
</p>
<p><img loading="lazy" src="Typoraimage-20220228111216579.png" alt="Typoraimage-20220228111216579"  />
</p>
<p>åœ¨æ¯ä¸ª <code>skynet</code> èŠ‚ç‚¹ï¼ˆå•ä¸ªè¿›ç¨‹ï¼‰å†…ï¼Œå¯åŠ¨ä¸€ä¸ªå« <code>clusterd</code> çš„æœåŠ¡ã€‚æ‰€æœ‰éœ€è¦è·¨è¿›ç¨‹çš„æ¶ˆæ¯æŠ•é€’éƒ½å…ˆæŠŠæ¶ˆæ¯æŠ•é€’åˆ°è¿™ä¸ªæœåŠ¡ä¸Šï¼Œå†ç”±å®ƒæ¥è½¬å‘åˆ°ç½‘ç»œã€‚</p>
<ol>
<li>é¦–é€‰é€šè¿‡<code>clustername.lua</code>é…ç½®è¡¨é…ç½®å¥½å…¨éƒ¨çš„<code>cluster</code>èŠ‚ç‚¹</li>
<li>åœ¨æ‰€æœ‰è¦å‘ç°çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ<code>require&quot;skynet.cluster&quot;</code></li>
<li>ç”¨<code>cluster.open</code>å»ºç«‹è‡ªå·±çš„ç›‘å¬å¥½è®©åˆ«çš„èŠ‚ç‚¹å’Œè‡ªå·±å»ºç«‹<code>tcp</code>é€šé“è¿æ¥</li>
<li>é€šè¿‡<code>cluster.register</code>æ³¨å†Œ<code>create</code>çš„<code>service</code></li>
<li>è¿œç¨‹èŠ‚ç‚¹åˆ©ç”¨<code>cluster.query()</code>æ¥å¾—åˆ°æ³¨å†Œè¿‡çš„èŠ‚ç‚¹</li>
<li>é€šè¿‡<code>cluster.call</code> <code>skynet.call</code> <code> cluster.send</code> <code>skynet.send</code>æ¥è°ƒç”¨è¿œç¨‹<code>function1</code> <code>function2</code>å‡½æ•°</li>
</ol>
<h2 id="ç®€æ˜“çš„mmo-æ¶æ„">ç®€æ˜“çš„mmo æ¶æ„<a hidden class="anchor" aria-hidden="true" href="#ç®€æ˜“çš„mmo-æ¶æ„">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228111324603.png" alt="Typoraimage-20220228111324603"  />
</p>
<h2 id="ç½‘å…³æœåŠ¡">ç½‘å…³æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#ç½‘å…³æœåŠ¡">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228111359433.png" alt="Typoraimage-20220228111359433"  />
</p>
<ol>
<li><code>main.lua</code> å»ºç«‹ <code>watchdog</code></li>
<li><code>watchdog</code> é€šè¿‡<code>skynet.start()</code> åˆ›å»º<code>gateService</code></li>
<li><code>gateService</code>å¹¶é€šè¿‡<code>rpc</code>è°ƒç”¨ <code>watchdogService socket.open</code> å‡½æ•°</li>
<li><code>watchdogService</code> é€šè¿‡ <code>socket.open</code> åˆ›å»º <code>agenService</code></li>
<li><code>agenService</code> æŠŠ<code>fd forward</code>ç»™<code>gateService</code></li>
<li><code>client </code>å‘é€è¯·æ±‚ç»™<code>gateService</code></li>
<li><code>gateService</code> æŠŠè¯·æ±‚é‡å®šå‘ç»™<code>agentService</code></li>
<li><code>agentService</code> æŠŠå¤„ç†ç»“æœè¿”å›ç»™<code>client</code></li>
</ol>
<h2 id="åç¨‹">åç¨‹<a hidden class="anchor" aria-hidden="true" href="#åç¨‹">#</a></h2>
<p>coroutine å®ç° è¯¦ç»†ä»£ç è§<code>lcorolib.c</code></p>
<h3 id="æ´¾å‘æ¶ˆæ¯">æ´¾å‘æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#æ´¾å‘æ¶ˆæ¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>function skynet.dispatch_message(...)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">å½“å‰æ¶ˆæ¯å¤„ç†</span>
</span></span><span style="display:flex;"><span>    local succ, err <span style="color:#f92672">=</span> pcall(raw_dispatch_message,...)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> true <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">é¡ºåºæ‰§è¡Œ</span>skynet.fork <span style="color:#960050;background-color:#1e0010">åˆ›å»ºçš„åç¨‹</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> fork_queue.h <span style="color:#f92672">&gt;</span> fork_queue.t then
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">--</span> queue is empty
</span></span><span style="display:flex;"><span>            fork_queue.h <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            fork_queue.t <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span> pop queue
</span></span><span style="display:flex;"><span>        local h <span style="color:#f92672">=</span> fork_queue.h
</span></span><span style="display:flex;"><span>        local co <span style="color:#f92672">=</span> fork_queue[h]
</span></span><span style="display:flex;"><span>        fork_queue[h] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>        fork_queue.h <span style="color:#f92672">=</span> h <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        local fork_succ, fork_err <span style="color:#f92672">=</span> pcall(suspend,co,coroutine_resume(co))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> not fork_succ then
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> succ then
</span></span><span style="display:flex;"><span>                succ <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>                err <span style="color:#f92672">=</span> tostring(fork_err)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                err <span style="color:#f92672">=</span> tostring(err) .. <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> .. tostring(fork_err)
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>    assert(succ, tostring(err))
</span></span><span style="display:flex;"><span>end
</span></span></code></pre></div><h3 id="å¤„ç†å½“å‰æ¶ˆæ¯">å¤„ç†å½“å‰æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å¤„ç†å½“å‰æ¶ˆæ¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>local function raw_dispatch_message(prototype, msg, sz, session, source)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">--</span> skynet.PTYPE_RESPONSE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, read skynet.h
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> prototype <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> then <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">å¯¹å›åº”ç±»å‹çš„åŒ…å¤„ç†</span>
</span></span><span style="display:flex;"><span>        local co <span style="color:#f92672">=</span> session_id_coroutine[session]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> co <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;BREAK&#34;</span> then
</span></span><span style="display:flex;"><span>            session_id_coroutine[session] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>        elseif co <span style="color:#f92672">==</span> nil then
</span></span><span style="display:flex;"><span>            unknown_response(session, source, msg, sz)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            local tag <span style="color:#f92672">=</span> session_coroutine_tracetag[co]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag then c.trace(tag, <span style="color:#e6db74">&#34;resume&#34;</span>) end
</span></span><span style="display:flex;"><span>            session_id_coroutine[session] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>            suspend(co, coroutine_resume(co, true, msg, sz, session))
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        local p <span style="color:#f92672">=</span> proto[prototype] <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">æ‰¾åˆ°å¯¹åº”çš„è§£æåè®®</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> p <span style="color:#f92672">==</span> nil then
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> prototype <span style="color:#f92672">==</span> skynet.PTYPE_TRACE then
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> trace next request
</span></span><span style="display:flex;"><span>                trace_source[source] <span style="color:#f92672">=</span> c.tostring(msg,sz)
</span></span><span style="display:flex;"><span>            elseif session <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> then
</span></span><span style="display:flex;"><span>                c.send(source, skynet.PTYPE_ERROR, session, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                unknown_request(session, source, msg, sz, prototype)
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        local f <span style="color:#f92672">=</span> p.dispatch <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">è·å–å¤„ç†çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> f then
</span></span><span style="display:flex;"><span>            local co <span style="color:#f92672">=</span> co_create(f) <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">è·å–åç¨‹</span>
</span></span><span style="display:flex;"><span>            session_coroutine_id[co] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>            session_coroutine_address[co] <span style="color:#f92672">=</span> source
</span></span><span style="display:flex;"><span>            local traceflag <span style="color:#f92672">=</span> p.trace
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> traceflag <span style="color:#f92672">==</span> false then
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> force off
</span></span><span style="display:flex;"><span>                trace_source[source] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                session_coroutine_tracetag[co] <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                local tag <span style="color:#f92672">=</span> trace_source[source]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> tag then
</span></span><span style="display:flex;"><span>                    trace_source[source] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                    c.trace(tag, <span style="color:#e6db74">&#34;request&#34;</span>)
</span></span><span style="display:flex;"><span>                    session_coroutine_tracetag[co] <span style="color:#f92672">=</span> tag
</span></span><span style="display:flex;"><span>                elseif traceflag then
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">--</span> set running_thread <span style="color:#66d9ef">for</span> trace
</span></span><span style="display:flex;"><span>                    running_thread <span style="color:#f92672">=</span> co
</span></span><span style="display:flex;"><span>                    skynet.trace()
</span></span><span style="display:flex;"><span>                end
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>            suspend(co, coroutine_resume(co, session,source, p.unpack(msg,sz)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            trace_source[source] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> then
</span></span><span style="display:flex;"><span>                c.send(source, skynet.PTYPE_ERROR, session, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                unknown_request(session, source, msg, sz, proto[prototype].name)
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>end
</span></span></code></pre></div><h3 id="åˆ›å»ºåç¨‹">åˆ›å»ºåç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºåç¨‹">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>local function co_create(f)
</span></span><span style="display:flex;"><span>    local co <span style="color:#f92672">=</span> tremove(coroutine_pool) <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">ä»åç¨‹æ± ä¸­è·å–åç¨‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> co <span style="color:#f92672">==</span> nil then <span style="color:#f92672">--</span><span style="color:#960050;background-color:#1e0010">å¦‚æœæ²¡æœ‰äº†</span>
</span></span><span style="display:flex;"><span>        co <span style="color:#f92672">=</span> coroutine_create(function(...) <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">åˆ›å»ºæ–°çš„</span>
</span></span><span style="display:flex;"><span>            f(...) <span style="color:#f92672">--</span><span style="color:#960050;background-color:#1e0010">æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä¸ä¼šç«‹é©¬æ‰§è¡Œåªä¼šè°ƒç”¨</span>coroutine.resumeæ—¶å€™æ‰ä¼šæ‰§è¡Œ
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> true <span style="color:#66d9ef">do</span> <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">ä¸ºäº†èƒ½å¤Ÿå¤ç”¨åˆšåˆ›å»ºçš„åæˆï¼Œä¸‹é¢éœ€è¦å¯¹åç¨‹è¿›è¡Œåˆå§‹åŒ–å’Œå›æ”¶</span>
</span></span><span style="display:flex;"><span>                local session <span style="color:#f92672">=</span> session_coroutine_id[co]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> session and session <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> then
</span></span><span style="display:flex;"><span>                    local source <span style="color:#f92672">=</span> debug.getinfo(f,<span style="color:#e6db74">&#34;S&#34;</span>)
</span></span><span style="display:flex;"><span>                    skynet.error(string.format(<span style="color:#e6db74">&#34;Maybe forgot response session %s from %s : %s:%d&#34;</span>,
</span></span><span style="display:flex;"><span>                        session,
</span></span><span style="display:flex;"><span>                        skynet.address(session_coroutine_address[co]),
</span></span><span style="display:flex;"><span>                        source.source, source.linedefined))
</span></span><span style="display:flex;"><span>                end
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> coroutine exit
</span></span><span style="display:flex;"><span>                local tag <span style="color:#f92672">=</span> session_coroutine_tracetag[co]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">~=</span> nil then
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> tag then c.trace(tag, <span style="color:#e6db74">&#34;end&#34;</span>) end
</span></span><span style="display:flex;"><span>                    session_coroutine_tracetag[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                end
</span></span><span style="display:flex;"><span>                local address <span style="color:#f92672">=</span> session_coroutine_address[co]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> address then
</span></span><span style="display:flex;"><span>                    session_coroutine_id[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                    session_coroutine_address[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> recycle co into pool
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>                coroutine_pool[<span style="color:#960050;background-color:#1e0010">#</span>coroutine_pool<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> co
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> recv new main function f
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> coroutine_yield <span style="color:#e6db74">&#34;SUSPEND&#34;</span>
</span></span><span style="display:flex;"><span>                f(coroutine_yield())
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>        end)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span> pass the main function f to coroutine, and restore running <span style="color:#66d9ef">thread</span>
</span></span><span style="display:flex;"><span>        local running <span style="color:#f92672">=</span> running_thread
</span></span><span style="display:flex;"><span>        coroutine_resume(co, f)
</span></span><span style="display:flex;"><span>        running_thread <span style="color:#f92672">=</span> running
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> co
</span></span><span style="display:flex;"><span>end
</span></span></code></pre></div><h3 id="åç¨‹æŒ‚èµ·">åç¨‹æŒ‚èµ·<a hidden class="anchor" aria-hidden="true" href="#åç¨‹æŒ‚èµ·">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f92672">--</span> suspend is local function
</span></span><span style="display:flex;"><span>function suspend(co, result, command)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> not result then <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">æ‰§è¡Œ</span>coå¤±è´¥ä»¥åçš„å¤„ç†
</span></span><span style="display:flex;"><span>        local session <span style="color:#f92672">=</span> session_coroutine_id[co]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session then <span style="color:#f92672">--</span> coroutine may fork by others (session is nil)
</span></span><span style="display:flex;"><span>            local addr <span style="color:#f92672">=</span> session_coroutine_address[co]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> then
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">--</span> only call response error
</span></span><span style="display:flex;"><span>                local tag <span style="color:#f92672">=</span> session_coroutine_tracetag[co]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> tag then c.trace(tag, <span style="color:#e6db74">&#34;error&#34;</span>) end
</span></span><span style="display:flex;"><span>                c.send(addr, skynet.PTYPE_ERROR, session, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>            session_coroutine_id[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>        end
</span></span><span style="display:flex;"><span>        session_coroutine_address[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>        session_coroutine_tracetag[co] <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>        skynet.fork(function() end) <span style="color:#f92672">--</span> trigger command <span style="color:#e6db74">&#34;SUSPEND&#34;</span>
</span></span><span style="display:flex;"><span>        local tb <span style="color:#f92672">=</span> traceback(co,tostring(command))
</span></span><span style="display:flex;"><span>        coroutine.close(co)
</span></span><span style="display:flex;"><span>        error(tb)
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;SUSPEND&#34;</span> then <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">æŒ‚èµ·æ“ä½œ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dispatch_wakeup() <span style="color:#f92672">--</span> <span style="color:#960050;background-color:#1e0010">å¦‚æœæœ‰èƒ½å¤Ÿè¢«å”¤é†’çš„åç¨‹ï¼Œå°±</span>wakeup
</span></span><span style="display:flex;"><span>    elseif command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;QUIT&#34;</span> then
</span></span><span style="display:flex;"><span>        coroutine.close(co)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span> service exit
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    elseif command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;USER&#34;</span> then
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span> See skynet.coutine <span style="color:#66d9ef">for</span> detail
</span></span><span style="display:flex;"><span>        error(<span style="color:#e6db74">&#34;Call skynet.coroutine.yield out of skynet.coroutine.resume</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> .. traceback(co))
</span></span><span style="display:flex;"><span>    elseif command <span style="color:#f92672">==</span> nil then
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span> debug trace
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        error(<span style="color:#e6db74">&#34;Unknown command : &#34;</span> .. command .. <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> .. traceback(co))
</span></span><span style="display:flex;"><span>    end
</span></span><span style="display:flex;"><span>end				
</span></span></code></pre></div><h3 id="åç¨‹é”€æ¯">åç¨‹é”€æ¯<a hidden class="anchor" aria-hidden="true" href="#åç¨‹é”€æ¯">#</a></h3>
<p>ä¸»è¦æ˜¯å› ä¸ºè¿™ç§åŸºç¡€ç±»å‹<code>LUA_TTHREAD</code>æ¥å†³å®šæ€ä¹ˆé”€æ¯</p>
<p><code>LUA_TTHREAD</code> ä»‹ç»:</p>
<ol>
<li>
<p>é™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼Œå…¶å®ƒçº¿ç¨‹å’Œå…¶å®ƒ<code>Lua</code>å¯¹è±¡ä¸€æ ·éƒ½æ˜¯åƒåœ¾å›æ”¶çš„å¯¹è±¡ã€‚ç­‰å¾…GCå›æ”¶ï¼Œå½“æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¼šå‹å…¥æ ˆï¼Œè¿™æ ·èƒ½ç¡®ä¿æ–°çº¿ç¨‹ä¸ä¼šæˆä¸ºåƒåœ¾</p>
</li>
<li>
<p>æ¯æ¬¡è°ƒç”¨<code>lua_newstate</code>çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>luastate</code>,ä¸åŒçš„<code>luastate</code>å®Œå…¨ç‹¬ç«‹ï¼Œä¹‹é—´ä¸å…±äº«ä»»ä½•æ•°æ®</p>
</li>
<li>
<p>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæ ˆäº†ï¼Œä½†æ˜¯å®ƒä¸å…¶çº¿ç¨‹å…±ç”¨è™šæ‹Ÿæœºçš„å…¨å±€çŠ¶æ€</p>
<p><img loading="lazy" src="Typoraimage-20220228115133988.png" alt="Typoraimage-20220228115133988"  />
</p>
</li>
<li>
<p>åç¨‹æä¾›äº†æ–°çš„<code>api</code>æ¥å£å’Œ <code>lua_resetthread</code>, <code>coroutine.close</code> ä¼šä½¿åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€,å¹¶ä¸”å…³é—­æ‰€æœ‰çš„<code>close</code>å˜é‡</p>
</li>
</ol>
<h2 id="sendcall-æµç¨‹">send.call æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#sendcall-æµç¨‹">#</a></h2>
<p><img loading="lazy" src="Typoraimage-20220228112317687.png" alt="Typoraimage-20220228112317687"  />
</p>
<h2 id="api-ç›¸å…³">API ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#api-ç›¸å…³">#</a></h2>
<h3 id="cluster">cluster<a hidden class="anchor" aria-hidden="true" href="#cluster">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>cluster.call(node, address, ...) <span style="color:#75715e">--è¿œç¨‹è°ƒç”¨nodeä¸­çš„addr</span>
</span></span><span style="display:flex;"><span>cluster.send(node, address, ...) <span style="color:#75715e">--sendè°ƒç”¨è¿œç¨‹nodeçš„addr</span>
</span></span><span style="display:flex;"><span>cluster.open(port) <span style="color:#75715e">--æœ¬åœ°æ‰“å¼€(ç›‘å¬)ä¸€ä¸ªclusterç»“ç‚¹ï¼Œä½¿å…¶èƒ½åœ¨clusterä¸­çš„å…¶ä»–ç»“ç‚¹å‘ç°</span>
</span></span><span style="display:flex;"><span>cluster.reload(config) <span style="color:#75715e">--é‡è½½è¿œç¨‹ç»“ç‚¹é…ç½®è¡¨ï¼Œè¡¨ä¸­çš„clusterç»“ç‚¹éƒ½openè¿‡ï¼Œåˆ™å¯ä»¥é€šè®¯</span>
</span></span><span style="display:flex;"><span>cluster.proxy(node, name) <span style="color:#75715e">--è®¾ç½®è¿œç¨‹ç»“ç‚¹çš„ä»£ç†ï¼Œä½¿å¾—å¯ä»¥åƒè°ƒç”¨æœ¬åœ°RPCä¸€æ ·è°ƒç”¨è¿œç¨‹ç»“ç‚¹</span>
</span></span><span style="display:flex;"><span>cluster.snax(node, name, address) <span style="color:#75715e">--ç”Ÿæˆä¸€ä¸ªè¿œç¨‹çš„snaxæœåŠ¡å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>cluster.register(name, addr) <span style="color:#75715e">--æ³¨å†Œä¸€ä¸ªclusterç»“ç‚¹</span>
</span></span><span style="display:flex;"><span>cluster.query(node, name) <span style="color:#75715e">--æŸ¥æ‰¾è¿œç¨‹ç»“ç‚¹ä¸­æ³¨å†Œè¿‡çš„ç»“ç‚¹æ˜¯å¦å­˜åœ¨</span>
</span></span></code></pre></div><h3 id="harbor">harbor<a hidden class="anchor" aria-hidden="true" href="#harbor">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>harbor.link(id) <span style="color:#75715e">--ç”¨æ¥ç›‘æ§ä¸€ä¸ª slave æ˜¯å¦æ–­å¼€ã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ­£å¸¸ï¼Œè¿™ä¸ª api å°†é˜»å¡ã€‚å½“ slave æ–­å¼€æ—¶ï¼Œä¼šç«‹åˆ»è¿”å›ã€‚</span>
</span></span><span style="display:flex;"><span>harbor.linkmaster() <span style="color:#75715e">--ç”¨æ¥åœ¨ slave ä¸Šç›‘æ§å’Œ master çš„è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚è¿™ä¸ª api å¤šç”¨äºå¼‚å¸¸æ—¶çš„å®‰å…¨é€€å‡ºï¼ˆå› ä¸ºå½“ slave å’Œ master æ–­å¼€åï¼Œæ²¡æœ‰æ‰‹æ®µå¯ä»¥æ¢å¤ï¼‰ã€‚</span>
</span></span><span style="display:flex;"><span>harbor.connect(id) <span style="color:#75715e">--å’Œ harbor.link ç›¸åã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ²¡æœ‰è¿æ¥ï¼Œè¿™ä¸ª api å°†é˜»å¡ï¼Œä¸€ç›´åˆ°å®ƒè¿ä¸Šæ¥æ‰è¿”å›ã€‚</span>
</span></span><span style="display:flex;"><span>harbor.queryname(name) <span style="color:#75715e">--å¯ä»¥ç”¨æ¥æŸ¥è¯¢å…¨å±€åå­—æˆ–æœ¬åœ°åå­—å¯¹åº”çš„æœåŠ¡åœ°å€ã€‚å®ƒæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ã€‚</span>
</span></span><span style="display:flex;"><span>harbor.globalname(name, handle) <span style="color:#75715e">--æ³¨å†Œä¸€ä¸ªå…¨å±€åå­—ã€‚å¦‚æœ handle ä¸ºç©ºï¼Œåˆ™æ³¨å†Œè‡ªå·±ã€‚skynet.name å’Œ skynet.register æ˜¯ç”¨å…¶å®ç°çš„ã€‚</span>
</span></span></code></pre></div><h3 id="æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£">æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.getenv(varName) <span style="color:#75715e">--confé…ç½®ä¿¡æ¯å·²ç»å†™å…¥åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œé€šè¿‡è¯¥å‡½æ•°è·å–æ³¨å†Œè¡¨çš„å˜é‡å€¼</span>
</span></span><span style="display:flex;"><span>skynet.setenv(varName, varValue) <span style="color:#75715e">--è®¾ç½®æ³¨å†Œè¡¨ä¿¡æ¯ï¼ŒvarValueä¸€èˆ¬æ˜¯numberæˆ–stringï¼Œä½†æ˜¯ä¸èƒ½è®¾ç½®å·²ç»å­˜åœ¨çš„varname</span>
</span></span><span style="display:flex;"><span>skynet.error(...) <span style="color:#75715e">--æ‰“å°å‡½æ•°</span>
</span></span><span style="display:flex;"><span>skynet.start(func) <span style="color:#75715e">--ç”¨ func å‡½æ•°åˆå§‹åŒ–æœåŠ¡ï¼Œå¹¶å°†æ¶ˆæ¯å¤„ç†å‡½æ•°æ³¨å†Œåˆ° C å±‚ï¼Œè®©è¯¥æœåŠ¡å¯ä»¥å·¥ä½œã€‚</span>
</span></span><span style="display:flex;"><span>skynet.init(func) <span style="color:#75715e">--è‹¥æœåŠ¡å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œåˆ™æ³¨å†Œä¸€ä¸ªå‡½æ•°ç­‰æœåŠ¡åˆå§‹åŒ–é˜¶æ®µå†æ‰§è¡Œï¼›è‹¥æœåŠ¡å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œåˆ™ç«‹åˆ»è¿è¡Œè¯¥å‡½æ•°ã€‚</span>
</span></span><span style="display:flex;"><span>skynet.exit() <span style="color:#75715e">--ç»“æŸå½“å‰æœåŠ¡</span>
</span></span><span style="display:flex;"><span>skynet.self() <span style="color:#75715e">--è·å–å½“å‰æœåŠ¡çš„å¥æŸ„handler</span>
</span></span><span style="display:flex;"><span>skynet.address(handler) <span style="color:#75715e">--å°†handleè½¬æ¢æˆå­—ç¬¦ä¸²</span>
</span></span><span style="display:flex;"><span>skynet.abort() <span style="color:#75715e">--é€€å‡ºskynetè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>skynet.kill(address) <span style="color:#75715e">----å¼ºåˆ¶æ€æ­»å…¶ä»–æœåŠ¡ã€‚å¯ä»¥ç”¨æ¥å¼ºåˆ¶å…³é—­åˆ«çš„æœåŠ¡ã€‚ä½†å¼ºçƒˆä¸æ¨èè¿™æ ·åšã€‚å› ä¸ºå¯¹è±¡ä¼šåœ¨ä»»æ„ä¸€æ¡æ¶ˆæ¯å¤„ç†å®Œæ¯•åï¼Œæ¯«æ— å¾å…†çš„é€€å‡ºã€‚æ‰€ä»¥æ¨èçš„åšæ³•æ˜¯ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè®©å¯¹æ–¹è‡ªå·±å–„åä»¥åŠè°ƒç”¨ skynet.exit ã€‚æ³¨ï¼šskynet.kill(skynet.self()) ä¸å®Œå…¨ç­‰ä»·äº skynet.exit() ï¼Œåè€…æ›´å®‰å…¨ã€‚			</span>
</span></span></code></pre></div><h3 id="æ™®é€šæœåŠ¡">æ™®é€šæœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#æ™®é€šæœåŠ¡">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.newservice(luaServerName, ...)		
</span></span></code></pre></div><h3 id="å…¨å±€å”¯ä¸€æœåŠ¡">å…¨å±€å”¯ä¸€æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#å…¨å±€å”¯ä¸€æœåŠ¡">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.uniqueservice(servicename, ...) <span style="color:#75715e">--å½“å‰çš„skynetèŠ‚ç‚¹å…¨å±€å”¯ä¸€</span>
</span></span><span style="display:flex;"><span>skynet.uniqueservice(<span style="color:#66d9ef">true</span>, servicename, ...) <span style="color:#75715e">--æ‰€æœ‰çš„èŠ‚ç‚¹å…¨å±€å”¯ä¸€</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>skynet.queryservice(servicename, ...) <span style="color:#75715e">--å½“å‰çš„skynetèŠ‚ç‚¹ä¸­æŸ¥æ‰¾</span>
</span></span><span style="display:flex;"><span>skynet.queryservice(<span style="color:#66d9ef">true</span>, servicename, ...) <span style="color:#75715e">--æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­æŸ¥æ‰¾</span>
</span></span></code></pre></div><h3 id="åˆ«å">åˆ«å<a hidden class="anchor" aria-hidden="true" href="#åˆ«å">#</a></h3>
<p>åˆ«ååˆ†ä¸¤ç§ï¼š</p>
<ol>
<li>
<p>æœ¬åœ°åˆ«å ä»£è¡¨åªèƒ½åœ¨å½“å‰<code>skynet</code>èŠ‚ç‚¹ä½¿ç”¨ï¼Œæœ¬åœ°åˆ«åç”¨ <code>.</code>å¼€å¤´</p>
</li>
<li>
<p>å…¨å±€åˆ«å å¯ä»¥åœ¨æ‰€æœ‰çš„<code>skynet</code>ä¸­ä½¿ç”¨ å…¨å±€åˆ«åä¸èƒ½ä»¥<code>.</code> å¼€å¤´</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.register(aliasname) <span style="color:#75715e">--ç»™å½“å‰æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å</span>
</span></span><span style="display:flex;"><span>skynet.name(aliasname, servicehandler) <span style="color:#75715e">--ç»™æŒ‡å®šservicehandlerçš„æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--[[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">æŸ¥è¯¢åˆ«åä¸ºaliasnameçš„æœåŠ¡,å¯ä»¥æ˜¯å…¨å±€åˆ«åä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«åï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">1ã€å½“æŸ¥è¯¢æœ¬åœ°åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2ã€å½“æŸ¥è¯¢å…¨å±€åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±é˜»å¡ç­‰å¾…åˆ°è¯¥æœåŠ¡åˆå§‹åŒ–å®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">]]</span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>skynet.harbor.queryname(aliasname)
</span></span><span style="display:flex;"><span>skynet.localname(aliasname) <span style="color:#75715e">--æŸ¥è¯¢æœ¬åœ°åˆ«åä¸ºaliasnameçš„æœåŠ¡ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil</span>
</span></span><span style="display:flex;"><span>skynet.kill(handle) <span style="color:#75715e">--æ€æ­»å¸¦åˆ«åæœåŠ¡</span>
</span></span></code></pre></div><h3 id="æœåŠ¡è°ƒåº¦">æœåŠ¡è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#æœåŠ¡è°ƒåº¦">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.sleep(time) <span style="color:#75715e">--è®©å½“å‰çš„ä»»åŠ¡ç­‰å¾… time * 0.01s ã€‚</span>
</span></span><span style="display:flex;"><span>skynet.fork(func, ...) <span style="color:#75715e">--å¯åŠ¨ä¸€ä¸ªæ–°çš„ä»»åŠ¡å»æ‰§è¡Œå‡½æ•° func , å…¶å®å°±æ˜¯å¼€äº†ä¸€ä¸ªåç¨‹ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆå°†è¿”å›çº¿ç¨‹å¥æŸ„ è™½ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”Ÿçš„coroutine.createæ¥åˆ›å»ºåç¨‹ï¼Œä½†æ˜¯ä¼šæ‰“ä¹±skynetçš„å·¥ä½œæµç¨‹</span>
</span></span><span style="display:flex;"><span>skynet.yield() <span style="color:#75715e">--è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œä½¿æœ¬æœåŠ¡å†…å…¶å®ƒä»»åŠ¡æœ‰æœºä¼šæ‰§è¡Œï¼Œéšåä¼šç»§ç»­è¿è¡Œã€‚</span>
</span></span><span style="display:flex;"><span>skynet.wait() <span style="color:#75715e">--è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œç›´åˆ°ç”¨ wakeup å”¤é†’å®ƒã€‚</span>
</span></span><span style="display:flex;"><span>skynet.wakeup(co) <span style="color:#75715e">--å”¤é†’ç”¨ wait æˆ– sleep å¤„äºç­‰å¾…çŠ¶æ€çš„ä»»åŠ¡ã€‚    </span>
</span></span><span style="display:flex;"><span>skynet.timeout(time, func) <span style="color:#75715e">--è®¾å®šä¸€ä¸ªå®šæ—¶è§¦å‘å‡½æ•° func ï¼Œåœ¨ time * 0.01s åè§¦å‘ã€‚</span>
</span></span><span style="display:flex;"><span>skynet.starttime() <span style="color:#75715e">--è¿”å›å½“å‰è¿›ç¨‹çš„å¯åŠ¨ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚</span>
</span></span><span style="display:flex;"><span>skynet.now() <span style="color:#75715e">--è¿”å›å½“å‰è¿›ç¨‹å¯åŠ¨åç»è¿‡çš„æ—¶é—´ (0.01 ç§’) ã€‚</span>
</span></span><span style="display:flex;"><span>skynet.time() <span style="color:#75715e">--é€šè¿‡ starttime å’Œ now è®¡ç®—å‡ºå½“å‰ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚		</span>
</span></span></code></pre></div><h3 id="æ¶ˆæ¯ç±»å‹">æ¶ˆæ¯ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯ç±»å‹">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_TEXT 0        --æ–‡æœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_RESPONSE 1    --è¡¨ç¤ºä¸€ä¸ªå›åº”åŒ…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_MULTICAST 2   --å¹¿æ’­æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_CLIENT 3      --ç”¨æ¥å¤„ç†ç½‘ç»œå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_SYSTEM 4      --ç³»ç»Ÿæ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_HARBOR 5      --é›†ç¾¤å†…å…¶ä»–çš„ skynet èŠ‚ç‚¹å‘æ¥çš„æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_SOCKET 6    --å¥—æ¥å­—æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_ERROR 7     --é”™è¯¯æ¶ˆæ¯ï¼Œä¸€èˆ¬æœåŠ¡é€€å‡ºçš„æ—¶å€™ä¼šå‘é€erroræ¶ˆæ¯ç»™å…³è”çš„æœåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_QUEUE 8     --é˜Ÿåˆ—æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_DEBUG 9     --è°ƒè¯•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_LUA 10   --luaç±»å‹çš„æ¶ˆæ¯ï¼Œæœ€å¸¸ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_SNAX 11  --snaxæœåŠ¡æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_TAG_DONTCOPY 0x10000 --ç¦æ­¢æ‹·è´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTYPE_TAG_ALLOCSESSION 0x20000 --åˆ†é…æ–°çš„ session
</span></span></span></code></pre></div><h3 id="æ‰“åŒ…è§£åŒ…">æ‰“åŒ…è§£åŒ…<a hidden class="anchor" aria-hidden="true" href="#æ‰“åŒ…è§£åŒ…">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.pack(...) <span style="color:#75715e">--æ‰“åŒ…</span>
</span></span><span style="display:flex;"><span>skynet.unpack(msg, sz) <span style="color:#75715e">--è§£åŒ…		</span>
</span></span></code></pre></div><h3 id="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å‘é€æ¶ˆæ¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span> <span style="color:#75715e">-- å‘é€æ— éœ€å“åº”çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span> skynet.send(addr, type, ...)  <span style="color:#75715e">--ç”¨ type ç±»å‹å‘ addr å‘é€æœªæ‰“åŒ…çš„æ¶ˆæ¯ã€‚è¯¥å‡½æ•°ä¼šè‡ªåŠ¨æŠŠ...å‚æ•°åˆ—è¡¨è¿›è¡Œæ‰“åŒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹luaæ¶ˆæ¯ä½¿ç”¨skynet.packæ‰“åŒ…ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚è‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰</span>
</span></span><span style="display:flex;"><span> skynet.rawsend(addr, type, msg, sz)  <span style="color:#75715e">--ç”¨ type ç±»å‹å‘ addr å‘é€ä¸€ä¸ªæ‰“åŒ…å¥½çš„æ¶ˆæ¯ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">-- å‘é€å¿…é¡»å“åº”çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>skynet.call(addr, type, ...)  <span style="color:#75715e">--ç”¨é»˜è®¤å‡½æ•°æ‰“åŒ…æ¶ˆæ¯ï¼Œå‘addrå‘é€typeç±»å‹çš„æ¶ˆæ¯å¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œå¹¶å¯¹å›åº”ä¿¡æ¯è¿›è¡Œè§£åŒ…ã€‚ï¼ˆè‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰</span>
</span></span><span style="display:flex;"><span>skynet.rawcall(addr, type, msg, sz) <span style="color:#75715e">--ç›´æ¥å‘addrå‘é€typeç±»å‹çš„msg,szå¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œä¸å¯¹å›åº”ä¿¡æ¯è§£åŒ…ã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰</span>
</span></span></code></pre></div><h3 id="å“åº”æ¶ˆæ¯">å“åº”æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å“åº”æ¶ˆæ¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- åŒä¸€ä¸ªåæˆå¤„ç†</span>
</span></span><span style="display:flex;"><span>skynet.ret() <span style="color:#75715e">--ç›®æ ‡æœåŠ¡æ¶ˆæ¯å¤„ç†åéœ€è¦é€šè¿‡è¯¥å‡½æ•°å°†ç»“æœè¿”å›</span>
</span></span><span style="display:flex;"><span>skynet.retpack(...) <span style="color:#75715e">--å°†æ¶ˆæ¯ç”¨skynet.pack æ‰“åŒ…ï¼Œå¹¶è°ƒç”¨ ret å›åº”ã€‚</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ä¸åœ¨ä¸€ä¸ªåæˆå¤„ç†</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> response <span style="color:#f92672">=</span> skynet.response(pack)<span style="color:#75715e">--å‚æ•°packæŒ‡å®šåº”ç­”æ‰“åŒ…å‡½æ•°ï¼Œä¸å¡«é»˜è®¤ä½¿ç”¨skynet.pack, å¿…é¡»æ ¹æ®æ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰“åŒ…å‡½æ•°ä¸€è‡´ è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°</span>
</span></span><span style="display:flex;"><span>response(ok, ...) <span style="color:#75715e">--å‚æ•°okçš„å€¼å¯ä»¥æ˜¯ &#34;test&#34;ã€trueã€falseï¼Œä¸º&#34;test&#34;æ—¶è¡¨ç¤ºæ£€æŸ¥æ¥æ”¶å“åº”çš„æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œä¸ºtrueæ—¶è¡¨ç¤ºå‘é€åº”ç­”PTYPE_RESPONSEï¼Œä¸ºfalseæ—¶è¡¨ç¤ºå‘é€PTYPE_ERRORé”™è¯¯æ¶ˆæ¯ã€‚</span>
</span></span></code></pre></div><h3 id="æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜">æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.queue() <span style="color:#75715e">--å¸®åŠ©ä½ å›é¿è¿™äº›æœåŠ¡é‡å…¥æˆ–è€…ä¼ªå¹¶å‘å¼•èµ·çš„å¤æ‚æ€§,ä½†æ˜¯æ˜æ˜¾é™ä½äº†æœåŠ¡çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ‰€ä»¥ä½¿ç”¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™å°½é‡ç¼©å°ä¸´ç•ŒåŒºçš„é¢—ç²’åº¦å¤§å°</span>
</span></span></code></pre></div><h3 id="åè®®è½¬æ¢">åè®®è½¬æ¢<a hidden class="anchor" aria-hidden="true" href="#åè®®è½¬æ¢">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.forward_type() <span style="color:#75715e">--éœ€è¦æä¾›ä¸€å¼ æ¶ˆæ¯è½¬æ¢æ˜ å°„è¡¨forward_map, å…¶ä»–çš„æ–¹æ³•ä¸skynet.startä¸€æ ·</span>
</span></span></code></pre></div><h3 id="ä¼ªé€ æ¶ˆæ¯">ä¼ªé€ æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#ä¼ªé€ æ¶ˆæ¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.redirect(dest,source,typename, session, msg, sz) <span style="color:#75715e">--ä½¿ç”¨sourceæœåŠ¡åœ°å€ï¼Œå‘é€typenameç±»å‹çš„æ¶ˆæ¯ç»™destæœåŠ¡ï¼Œä¸éœ€è¦æ¥æ”¶å“åº”ï¼Œï¼ˆsourceï¼Œdeståªèƒ½æ˜¯æœåŠ¡IDï¼‰msg szä¸€èˆ¬ä½¿ç”¨skynet.packæ‰“åŒ…ç”Ÿæˆ</span>
</span></span></code></pre></div><h3 id="ç»„æ’­">ç»„æ’­<a hidden class="anchor" aria-hidden="true" href="#ç»„æ’­">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.multicast <span style="color:#75715e">-- å½“ç»„æ’­çš„æ•°æ®é‡è¾ƒå¤§æ—¶å€™å¯ä»¥èŠ‚çœå†…éƒ¨çš„å¸¦å®½</span>
</span></span></code></pre></div><h3 id="socket">socket<a hidden class="anchor" aria-hidden="true" href="#socket">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">--å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ã€‚è¿”å›ä¸€ä¸ªæ•°å­— id ã€‚</span>
</span></span><span style="display:flex;"><span>socket.open(address, port)      
</span></span><span style="display:flex;"><span><span style="color:#75715e">--å…³é—­ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ª API æœ‰å¯èƒ½é˜»å¡ä½æ‰§è¡Œæµã€‚å› ä¸ºå¦‚æœæœ‰å…¶å®ƒ coroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--æ­£åœ¨é˜»å¡è¯»è¿™ä¸ª id å¯¹åº”çš„è¿æ¥ï¼Œä¼šå…ˆé©±ä½¿è¯»æ“ä½œç»“æŸï¼Œclose æ“ä½œæ‰è¿”å›ã€‚</span>
</span></span><span style="display:flex;"><span>socket.close(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--åœ¨æå…¶ç½•è§çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç²—æš´çš„ç›´æ¥å…³é—­æŸä¸ªè¿æ¥ï¼Œè€Œé¿å… socket.close çš„é˜»å¡ç­‰å¾…æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚</span>
</span></span><span style="display:flex;"><span>socket.close_fd(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--å¼ºè¡Œå…³é—­ä¸€ä¸ªè¿æ¥ã€‚å’Œ close ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸ä¼šç­‰å¾…å¯èƒ½å­˜åœ¨çš„å…¶å®ƒ coroutine çš„è¯»æ“ä½œã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ª API ï¼Œä½†å¦‚æœä½ éœ€è¦åœ¨ __gc å…ƒæ–¹æ³•ä¸­å…³é—­è¿æ¥çš„è¯ï¼Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--shutdown æ˜¯ä¸€ä¸ªæ¯” close æ›´å¥½çš„é€‰æ‹©ï¼ˆå› ä¸ºåœ¨ gc è¿‡ç¨‹ä¸­æ— æ³•åˆ‡æ¢ coroutineï¼‰ã€‚ä¸close_fdç±»ä¼¼</span>
</span></span><span style="display:flex;"><span>socket.shutdown(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--[[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ä»ä¸€ä¸ª socket ä¸Šè¯» sz æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å¦‚æœè¯»åˆ°äº†æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®ƒæŠŠè¿™ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å¦‚æœè¿æ¥æ–­å¼€å¯¼è‡´å­—èŠ‚æ•°ä¸å¤Ÿï¼Œå°†è¿”å›ä¸€ä¸ª false åŠ ä¸Šè¯»åˆ°çš„å­—ç¬¦ä¸²ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å¦‚æœ sz ä¸º nil ï¼Œåˆ™è¿”å›å°½å¯èƒ½å¤šçš„å­—èŠ‚æ•°ï¼Œä½†è‡³å°‘è¯»ä¸€ä¸ªå­—èŠ‚ï¼ˆè‹¥æ— æ–°æ•°æ®ï¼Œä¼šé˜»å¡ï¼‰ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--]]</span>
</span></span><span style="display:flex;"><span>socket.read(id, sz)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ä»ä¸€ä¸ª socket ä¸Šè¯»æ‰€æœ‰çš„æ•°æ®ï¼Œç›´åˆ° socket ä¸»åŠ¨æ–­å¼€ï¼Œæˆ–åœ¨å…¶å®ƒ coroutine ç”¨ socket.close å…³é—­å®ƒã€‚</span>
</span></span><span style="display:flex;"><span>socket.readall(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ä»ä¸€ä¸ª socket ä¸Šè¯»ä¸€è¡Œæ•°æ®ã€‚sep æŒ‡è¡Œåˆ†å‰²ç¬¦ã€‚é»˜è®¤çš„ sep ä¸º &#34;\n&#34;ã€‚è¯»åˆ°çš„å­—ç¬¦ä¸²æ˜¯ä¸åŒ…å«è¿™ä¸ªåˆ†å‰²ç¬¦çš„ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--å¦‚æœå¦å¤–ä¸€ç«¯å°±å…³é—­äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šè¿”å›ä¸€ä¸ªnilï¼Œå¦‚æœbufferä¸­æœ‰æœªè¯»æ•°æ®åˆ™ä½œä¸ºç¬¬äºŒä¸ªè¿”å›å€¼è¿”å›ã€‚</span>
</span></span><span style="display:flex;"><span>socket.readline(id, sep)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ç­‰å¾…ä¸€ä¸ª socket å¯è¯»ã€‚</span>
</span></span><span style="display:flex;"><span>socket.block(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--æŠŠä¸€ä¸ªå­—ç¬¦ä¸²ç½®å…¥æ­£å¸¸çš„å†™é˜Ÿåˆ—ï¼Œskynet æ¡†æ¶ä¼šåœ¨ socket å¯å†™æ—¶å‘é€å®ƒã€‚</span>
</span></span><span style="display:flex;"><span>socket.write(id, str)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--æŠŠå­—ç¬¦ä¸²å†™å…¥ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å¦‚æœæ­£å¸¸çš„å†™é˜Ÿåˆ—è¿˜æœ‰å†™æ“ä½œæœªå®Œæˆæ—¶ï¼Œä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸Šçš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«å‘å‡ºã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--åªæœ‰åœ¨æ­£å¸¸å†™é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šå¤„ç†ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œæ¯æ¬¡å†™çš„å­—ç¬¦ä¸²éƒ½å¯ä»¥çœ‹æˆåŸå­æ“ä½œã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ä¸ä¼šåªå‘é€ä¸€åŠï¼Œç„¶åè½¬å»å‘é€æ­£å¸¸å†™é˜Ÿåˆ—çš„æ•°æ®ã€‚</span>
</span></span><span style="display:flex;"><span>socket.lwrite(id, str)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œè¿”å›ä¸€ä¸ª id ï¼Œä¾› start ä½¿ç”¨ã€‚</span>
</span></span><span style="display:flex;"><span>socket.listen(address, port)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--[[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    accept æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æ¯å½“ä¸€ä¸ªç›‘å¬çš„ id å¯¹åº”çš„ socket ä¸Šæœ‰è¿æ¥æ¥å…¥çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨ accept å‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">è¿™ä¸ªå‡½æ•°ä¼šå¾—åˆ°æ¥å…¥è¿æ¥çš„ id ä»¥åŠ ip åœ°å€ã€‚ä½ å¯ä»¥åšåç»­æ“ä½œã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    æ¯å½“ accept å‡½æ•°è·å¾—ä¸€ä¸ªæ–°çš„ socket id åï¼Œå¹¶ä¸ä¼šç«‹å³æ”¶åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šå¸Œæœ›æŠŠè¿™ä¸ª socket çš„æ“ä½œæƒè½¬è®©ç»™åˆ«çš„æœåŠ¡å»å¤„ç†ã€‚accept(id, addr)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">]]</span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>socket.start(id , accept)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--[[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ä»»ä½•ä¸€ä¸ªæœåŠ¡åªæœ‰åœ¨è°ƒç”¨ socket.start(id) ä¹‹åï¼Œæ‰å¯ä»¥è¯»åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">å‘ä¸€ä¸ª socket id å†™æ•°æ®ä¹Ÿéœ€è¦å…ˆè°ƒç”¨ start ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    socket çš„ id å¯¹äºæ•´ä¸ª skynet èŠ‚ç‚¹éƒ½æ˜¯å…¬å¼€çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ id è¿™ä¸ªæ•°å­—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">é€šè¿‡æ¶ˆæ¯å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œå…¶ä»–æœåŠ¡ä¹Ÿå¯ä»¥å»æ“ä½œå®ƒã€‚skynet æ¡†æ¶æ˜¯æ ¹æ®è°ƒç”¨ start è¿™ä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">api çš„ä½ç½®æ¥å†³å®šæŠŠå¯¹åº” socket ä¸Šçš„æ•°æ®è½¬å‘åˆ°å“ªé‡Œå»çš„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--]]</span>
</span></span><span style="display:flex;"><span>socket.start(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--æ¸…é™¤ socket id åœ¨æœ¬æœåŠ¡å†…çš„æ•°æ®ç»“æ„ï¼Œä½†å¹¶ä¸å…³é—­è¿™ä¸ª socket ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--è¿™å¯ä»¥ç”¨äºä½ æŠŠ id å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œä»¥è½¬äº¤ socket çš„æ§åˆ¶æƒã€‚</span>
</span></span><span style="display:flex;"><span>socket.abandon(id)
</span></span><span style="display:flex;"><span><span style="color:#75715e">--[[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å½“ id å¯¹åº”çš„ socket ä¸Šå¾…å‘çš„æ•°æ®è¶…è¿‡ 1M å­—èŠ‚åï¼Œç³»ç»Ÿå°†å›è°ƒ callback ä»¥ç¤ºè­¦å‘Šã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">function callback(id, size) å›è°ƒå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•° id å’Œ size ï¼Œsize çš„å•ä½æ˜¯ K ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å¦‚æœä½ ä¸è®¾å›è°ƒï¼Œé‚£ä¹ˆå°†æ¯å¢åŠ  64K åˆ©ç”¨ skynet.error å†™ä¸€è¡Œé”™è¯¯ä¿¡æ¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--]]</span>
</span></span><span style="display:flex;"><span>socket.warning(id, callback)
</span></span></code></pre></div><h3 id="socketchannel">socketChannel<a hidden class="anchor" aria-hidden="true" href="#socketchannel">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç”¨æ¥æ”¯æŒåŒå‘ä¼ è¾“ï¼Œå¼‚æ­¥éå µå¡å¤„ç†æ•°æ®</span>
</span></span></code></pre></div><h3 id="dns">dns<a hidden class="anchor" aria-hidden="true" href="#dns">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>skynet.dns <span style="color:#75715e">--è°ƒç”¨äº†ç³»ç»Ÿ api getaddrinfo ï¼Œæœ‰å¯èƒ½é˜»å¡ä½æ•´ä¸ª socket çº¿ç¨‹ æ‰€ä»¥skynetå°è£…äº†è¿™ä¸ªæ¥å£æ¥è§£å†³dnsæŸ¥è¯¢æ—¶å€™é€ æˆçš„çº¿ç¨‹å µå¡é—®é¢˜</span>
</span></span></code></pre></div><h2 id="skynet-çš„é€šä¿¡è°ƒè¯•pack">skynet çš„é€šä¿¡è°ƒè¯•pack<a hidden class="anchor" aria-hidden="true" href="#skynet-çš„é€šä¿¡è°ƒè¯•pack">#</a></h2>
<ol>
<li>
<p>å®¢æˆ·ç«¯æŒ‰å¤§å°ç«¯æ‰“åŒ…æˆäºŒè¿›åˆ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> result <span style="color:#f92672">=</span> string.pack(<span style="color:#e6db74">&#34;&gt;s2&#34;</span>,<span style="color:#e6db74">&#34;string2pack&#34;</span>)
</span></span><span style="display:flex;"><span>pack <span style="color:#f92672">&gt;</span> <span style="color:#960050;background-color:#1e0010">è¡¨ç¤ºæŒ‰å¤§ç«¯é¡ºåºã€‚</span>s2 <span style="color:#960050;background-color:#1e0010">è¡¨ç¤ºæŒ‰ç…§</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ä¸ªå­—èŠ‚æ‰“åŒ…ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">æˆ‘ä»¬çŸ¥é“</span>stringç”±charç»„æˆ<span style="color:#960050;background-color:#1e0010">ã€‚</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">ä¸ª</span>char <span style="color:#960050;background-color:#1e0010">æ˜¯</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">255</span> <span style="color:#960050;background-color:#1e0010">ä¹‹é—´çš„æ•°ï¼Œ</span><span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">8</span> ,<span style="color:#ae81ff">1</span>char<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>byte
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»–é™¤äº†è¢«æ‰“åŒ…çš„éƒ¨åˆ†ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å‰é¢åŠ </span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºé•¿åº¦ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¦‚æœè¦æ‰“åŒ…ä¸€ä¸ªæ•°å­—åˆ™éœ€è¦è½¬æ¢ã€‚ç”±</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ç§åŠæ³•</span>
</span></span><span style="display:flex;"><span>string.pack(<span style="color:#e6db74">&#34;I2&#34;</span>,number)<span style="color:#960050;background-color:#1e0010">ï¼Œä¼šåœ¨å‰é¢äºŒè¿›åˆ¶åŠ </span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ä½è¡¨ç¤ºé•¿åº¦çš„ä¸œè¥¿ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>socketå‘é€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>socket.send
</span></span></code></pre></div></li>
<li>
<p>æœåŠ¡ç«¯æ¥æ”¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>gateserverå·²ç»æœ‰æ¥æ”¶çš„ä»£ç äº†<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">æ³¨æ„çš„æ˜¯ï¼Œ</span>socketä¼šè‡ªåŠ¨æŒ‰packçš„æ•°æ®åˆ†æ®µæ¥æ”¶<span style="color:#960050;background-color:#1e0010">ã€‚ä¹Ÿå°±æ˜¯ä¼šæ ¹æ®</span>packçš„å‰é¢2ä½å¾—åˆ°size<span style="color:#960050;background-color:#1e0010">ã€‚æ ¹æ®</span>sizeå»æ¥æ”¶åé¢çš„æ•°æ®<span style="color:#960050;background-color:#1e0010">ã€‚ç„¶åå‘ä¸Šä¼ é€’ä¸€ä»½</span>message<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">æ¥æ”¶åˆ°çš„</span>messageå·²ç»æ˜¯å»æ‰äº†å‰é¢2ä½çš„æ•°æ®<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>å®¢æˆ·ç«¯æ¥æ”¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">æˆ·ç«¯æ¥æ”¶åˆ°çš„æ•°æ®ç›®å‰æˆ‘æ˜¯ç”¨</span>skynetæä¾›çš„<span style="color:#960050;background-color:#1e0010">â€œ</span>client.socket<span style="color:#960050;background-color:#1e0010">â€</span>.<span style="color:#960050;background-color:#1e0010">æ²¡æœ‰</span>netpackå¯ç”¨<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">æ¥æ”¶åˆ°çš„æ•°æ®éœ€è¦è‡ªè¡Œå»é™¤å‰é¢çš„</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆ</span>string.packäº§ç”Ÿçš„<span style="color:#960050;background-color:#1e0010">ï¼‰ã€‚</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="skynet-clientsocket-å¯¼è‡´-ioread-æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜">skynet clientsocket å¯¼è‡´ io.read æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#skynet-clientsocket-å¯¼è‡´-ioread-æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">https</span><span style="color:#f92672">://</span><span style="color:#a6e22e">blog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">csdn</span><span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gneveek</span><span style="color:#f92672">/</span><span style="color:#a6e22e">article</span><span style="color:#f92672">/</span><span style="color:#a6e22e">details</span><span style="color:#f92672">/</span><span style="color:#ae81ff">78940693</span>
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://frog-game.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://frog-game.github.io/img/alipay_pay.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://frog-game.github.io/posts/blog/ringbuff/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ç¯å½¢buff</span>
  </a>
  <a class="next" href="https://frog-game.github.io/posts/blog/vscode-lua-chajian/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>å¾®æœåŠ¡luaè°ƒè¯•å™¨</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://www.frog-game.work/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: "ap-beijing",
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://frog-game.github.io/" style="color:#939393;">frog&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="https://frog-game.github.io/img/beian.png" style="float:left;margin: 0px 5px 0px 0px;"/>
            å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"frog's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
