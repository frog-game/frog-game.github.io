[{"content":"ä¸€äº›å­—æ®µçš„è§£é‡Š è§‚å¯Ÿè€…ï¼šæˆ‘å¯ä»¥è§‚å¯Ÿåˆ°é‚£äº›äººã€‚ è¢«è§‚å¯Ÿè€…ï¼šé‚£äº›äººèƒ½è§‚å¯Ÿåˆ°è‡ªå·±ã€‚ #define WATCHER_MODE 0x01 è§‚å¯Ÿè€…æ¨¡å¼ #define MARKER_MODE 0x02 è¢«è§‚å¯Ÿè€…æ¨¡å¼ ç¯å¡”ç›¸å…³[ç»“æ„ä½“] 1ï¼šç¯å¡”åŒºåŸŸç»“æ„\nstruct towerSpace_s { void (*callback)(void*pUserData,bool bAddTo,uint64_t watcher, uint64_t marker); -- å›è°ƒå‡½æ•° void*\tpUserData; //ç”¨æˆ·ä¿¡æ¯ float\tfMin[2]; //æœ€å°ä½ç½® float\tfGridLength[3];//ç½‘æ ¼x y,zæ–¹å‘é•¿åº¦ float\tfMovefRange;//ç§»åŠ¨èŒƒå›´ int32_t\tiSplitThreshold;//æ‹†åˆ†é˜ˆå€¼ int32_t iMaxWidth; //æœ€å¤§å®½åº¦ int32_t iMaxHeight;//æœ€å¤§é«˜åº¦ int32_t* pGrids;//ç½‘æ ¼æ•°æ® tower_tt*\tpTowers;//ç¯å¡”æ•°æ® int32_t\tiTowerNext;//ä¸‹ä¸€ä¸ªç¯å¡”id int32_t\tiTowerCapacity;//ç¯å¡”å®¹é‡ aoiObj_tt* pSlotObj;//æ ¼å­é‡Œé¢å¯¹è±¡ int32_t\tiSlotIndex;//æ ¼å­ç´¢å¼• int32_t iSlotCapacity;//æ ¼å­å®¹é‡ }; 2ï¼šç¯å¡”ä¿¡æ¯ç»“æ„\ntypedef struct tower_s { aoi_tree_tt watcher; //ç¯å¡”è§‚å¯Ÿè€…[ç”¨æ¥å­˜å‚¨è§‚å¯Ÿåˆ°çš„å¯¹è±¡] aoi_tree_tt\tmarker;//ç¯å¡”è¢«è§‚å¯Ÿè€… int32_t iMarkerCount;//è¢«è§‚å¯Ÿè€…æ•°é‡ int32_t iFirstChildId;//ç¬¬ä¸€ä¸ªå„¿å­èŠ‚ç‚¹ç´¢å¼• } tower_tt; 3ï¼šç¯å¡”åˆ’åˆ†åçš„èŠ‚ç‚¹ç»“æ„ã€å››ä¸ªå„¿å­èŠ‚ç‚¹ã€‘\ntypedef struct aoiNode_s { RB_ENTRY(aoiNode_s) entry; //å®ä½“ int32_t\tiId; //id } aoiNode_tt; 4ï¼šç¯å¡”é‡Œé¢å¯¹è±¡ç»“æ„\ntypedef struct aoiObj_s { int32_t\tiId; // id int32_t iMode; // æ¨¡å¼(MARKER_MODE:è¢«è§‚å¯Ÿè€…æ¨¡å¼ WATCHER_MODE:è§‚å¯Ÿæ¨¡å¼) uint64_t uiMask;//æ©ç  uint64_t uiUserData; //ç”¨æˆ·æ•°æ® float\tfViewRadius; // è§†é‡åŠå¾„ float last[3]; //ä¸Šä¸€ä¸ªxyzä½ç½® float pos[3];//å½“å‰xyzä½ç½® } aoiObj_tt; ç¯å¡”AOIç›¸å…³çš„ä¸€äº›æ“ä½œå‡½æ•° int32_t luaopen_laoi(lua_State *L) { #ifdef luaL_checkversion luaL_checkversion(L); #endif registerTowerSpaceL(L); luaL_Reg lualib_funcs[] = { {\u0026#34;createAoiSpace\u0026#34;,\tlcreateAoiSpace},//åˆ›å»ºaoiåŒºåŸŸ {NULL, NULL} }; luaL_newlib(L, lualib_funcs); return 1; } int32_t registerTowerSpaceL(struct lua_State *L) { luaL_newmetatable(L, \u0026#34;towerSpace\u0026#34;); lua_pushvalue(L, -1); lua_setfield(L, -2, \u0026#34;__index\u0026#34;); struct luaL_Reg lua_towerSpaceFuncs[] = { {\u0026#34;setCallback\u0026#34;,\tlaoi_setCallback}, //è®¾ç½®å›è°ƒå‡½æ•° {\u0026#34;addObj\u0026#34;,\tlaoi_addObj},//å¢åŠ ä¸€ä¸ªå®ä½“å¯¹è±¡ {\u0026#34;removeObj\u0026#34;,\tlaoi_removeObj},//ç§»é™¤ä¸€ä¸ªå®ä½“å¯¹è±¡ {\u0026#34;updateObjMask\u0026#34;,\tlaoi_updateObjMask},//æ›´æ–°å¯¹è±¡çš„mask[0x01:è§‚å¯Ÿè€… 0x02:è¢«è§‚å¯Ÿè€…] {\u0026#34;updateObjPos\u0026#34;,\tlaoi_updateObjPos},//æ›´æ–°å¯¹è±¡çš„pos {\u0026#34;addObjWatcher\u0026#34;,\tlaoi_addObjWatcher},//å¢åŠ å¯¹è±¡åˆ°ç›¸åº”çš„è§‚å¯Ÿå®¹å™¨ {\u0026#34;removeObjWatcher\u0026#34;,laoi_removeObjWatcher},//ä»ç›¸åº”çš„è§‚å¯Ÿå®¹å™¨ç§»é™¤å¯¹è±¡ {\u0026#34;addObjMarker\u0026#34;,\tlaoi_addObjMarker},//å¢åŠ å¯¹è±¡åˆ°è¢«è§‚å¯Ÿè€… {\u0026#34;removeObjMarker\u0026#34;,\tlaoi_removeObjMarker},//ç§»é™¤å¯¹è±¡åˆ°è¢«è§‚å¯Ÿè€… {\u0026#34;__gc\u0026#34;, laoi_towerSpace_gc},//æ­¤åŒºåŸŸè¿›è¡ŒGCå›æ”¶ {NULL, NULL} }; luaL_setfuncs(L, lua_towerSpaceFuncs, 0); return 1; } [å››å‰æ ‘]lodç¤ºæ„å›¾ é»‘è‰²å¤§æ¡†æ˜¯AOIçš„åŒºåŸŸå¤§å° æ¯ä¸ªæ­£æ–¹å½¢å—ä¸Šé¢éƒ½æœ‰ä¸€ä¸ªç¯å¡” æš‚æ—¶å®šçš„æœ€å¤šåˆ†è£‚3å±‚ é»‘è‰²çš„åŸç‚¹æ˜¯åœºæ™¯å†…çš„å®ä½“ ç¯å¡”AOIä¸€äº›å…³é”®å‡½æ•°[å…·ä½“ä»£ç åœ¨frog-game-serveræ¡†æ¶] 1. æ›´æ–°è§‚å¯Ÿè€…é›†åˆ\ninline static void changeAoiObjWatcher(towerSpace_tt* pTowerSpace,aoiObj_tt* pObj) { float bmin[3]; float bmax[3]; bmin[0] = pObj-\u0026gt;last[0] - pObj-\u0026gt;fViewRadius; bmin[2] = pObj-\u0026gt;last[2] - pObj-\u0026gt;fViewRadius; bmax[0] = pObj-\u0026gt;last[0] + pObj-\u0026gt;fViewRadius; bmax[2] = pObj-\u0026gt;last[2] + pObj-\u0026gt;fViewRadius; int32_t minxLast = 0; int32_t minyLast = 0; int32_t maxxLast = 0; int32_t maxyLast = 0; calcGridLodLoc(pTowerSpace, 2,bmin, \u0026amp;minxLast, \u0026amp;minyLast); calcGridLodLoc(pTowerSpace, 2,bmax, \u0026amp;maxxLast, \u0026amp;maxyLast); minxLast = minxLast \u0026gt; 0 ? minxLast : 0; minyLast = minyLast \u0026gt; 0 ? minyLast : 0; maxxLast = maxxLast \u0026lt; pTowerSpace-\u0026gt;iMaxWidth * 4 ? maxxLast : pTowerSpace-\u0026gt;iMaxWidth*4 - 1; maxyLast = maxyLast \u0026lt; pTowerSpace-\u0026gt;iMaxHeight * 4 ? maxyLast : pTowerSpace-\u0026gt;iMaxHeight*4 - 1; bmin[0] = pObj-\u0026gt;pos[0] - pObj-\u0026gt;fViewRadius; bmin[2] = pObj-\u0026gt;pos[2] - pObj-\u0026gt;fViewRadius; bmax[0] = pObj-\u0026gt;pos[0] + pObj-\u0026gt;fViewRadius; bmax[2] = pObj-\u0026gt;pos[2] + pObj-\u0026gt;fViewRadius; int32_t minx = 0; int32_t miny = 0; int32_t maxx = 0; int32_t maxy = 0; calcGridLodLoc(pTowerSpace, 2,bmin, \u0026amp;minx, \u0026amp;miny); calcGridLodLoc(pTowerSpace, 2,bmax, \u0026amp;maxx, \u0026amp;maxy); minx = minx \u0026gt; 0 ? minx : 0; miny = miny \u0026gt; 0 ? miny : 0; maxx = maxx \u0026lt; pTowerSpace-\u0026gt;iMaxWidth*4 ? maxx : pTowerSpace-\u0026gt;iMaxWidth*4 - 1; maxy = maxy \u0026lt; pTowerSpace-\u0026gt;iMaxHeight*4 ? maxy : pTowerSpace-\u0026gt;iMaxHeight*4 - 1; //æ˜¯å¦é‡åˆ if(isOverlap(minx,miny,maxx,maxy,minxLast,minyLast,maxxLast,maxyLast)) { int32_t iMinX = minx \u0026lt; minxLast ? minx : minxLast; int32_t iMinY = miny \u0026lt; minyLast ? miny : minyLast; int32_t iMaxX = maxx \u0026gt;= maxxLast ? maxx : maxxLast; int32_t iMaxY = maxy \u0026gt;= maxyLast ? maxy : maxyLast; int32_t iChanged = 0; //å¾€ä¸Šæ‰¾åˆ°æœ€å¤§çš„ç½‘æ ¼å— //ä¸ºä»€ä¹ˆæ˜¯iMinY/4 æ˜¯å› ä¸ºé™¤ä»¥4å°±åƒå››å‰æ ‘ä¸€æ ·æ‰¾æœ€ä¸Šé¢çš„çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•å€¼ä¸€æ · for (int32_t iY = iMinY/4; iY \u0026lt; (iMaxY+3)/4; ++iY) { for (int32_t iX = iMinX/4; iX \u0026lt; (iMaxX+3)/4; ++iX) { iChanged = 0; if(isInInside(iX*4,iY*4,iX*4+3,iY*4+3,minxLast,minyLast,maxxLast,maxyLast)) { iChanged = 0x1; } if(isInInside(iX*4,iY*4,iX*4+3,iY*4+3,minx,miny,maxx,maxy)) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { removeGridWatcher(pTowerSpace,pObj,iX,iY); } break; case 0x2: { insertGridWatcher(pTowerSpace,pObj,iX,iY,pObj-\u0026gt;pos); } break; case 0x3: { int32_t iTowerId = pTowerSpace-\u0026gt;pGrids[iX + iY * pTowerSpace-\u0026gt;iMaxWidth]; assert(iTowerId != -1); tower_tt* pTower = pTowerSpace-\u0026gt;pTowers + iTowerId; if (pTower-\u0026gt;iFirstChildId == -1) { continue; } for (int32_t ly = 0; ly \u0026lt; 2; ly++) { for (int32_t lx = 0; lx \u0026lt; 2; lx++) { iChanged = 0; if (isInInside(iX * 4 + lx * 2, iY * 4 + ly * 2, iX * 4 + lx * 2 + 1, iY * 4 + ly * 2 + 1, minxLast, minyLast, maxxLast, maxyLast)) { iChanged = 0x1; } if (isInInside(iX * 4 + lx * 2, iY * 4 + ly * 2, iX * 4 + lx * 2 + 1, iY * 4 + ly * 2 + 1, minx, miny, maxx, maxy)) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { removeLodWatcher(pTowerSpace, iTowerId, pObj, iX, iY, iX * 4 + lx * 2, iY * 4 + ly * 2); } break; case 0x2: { insertLodWatcher(pTowerSpace, iTowerId, pObj, iX, iY, iX * 4 + lx * 2, iY * 4 + ly * 2); } break; case 0x3: { tower_tt* pLodTower = pTowerSpace-\u0026gt;pTowers + pTower-\u0026gt;iFirstChildId + ly * 2 + lx; if (pLodTower-\u0026gt;iFirstChildId == -1) { continue; } for (int32_t l2y = 0; l2y \u0026lt; 2; l2y++) { for (int32_t l2x = 0; l2x \u0026lt; 2; l2x++) { iChanged = 0; if (isInRect(iX * 4 + lx * 2+l2x, iY * 4 + ly * 2+l2y, minxLast, minyLast, maxxLast, maxyLast)) { iChanged = 0x1; } if (isInRect(iX * 4 + lx * 2+l2x, iY * 4 + ly * 2+l2y, minx, miny, maxx, maxy)) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + pLodTower-\u0026gt;iFirstChildId + l2y * 2 + l2x; aoiNode_tt findNode; findNode.iId = pObj-\u0026gt;iId; aoiNode_tt* pT = RB_FIND(aoi_tree_s, \u0026amp;pLod2Tower-\u0026gt;watcher, \u0026amp;findNode); assert(pT); RB_REMOVE(aoi_tree_s, \u0026amp;pLod2Tower-\u0026gt;watcher, pT); mem_free(pT); aoiNode_tt* pI; RB_FOREACH(pI, aoi_tree_s, \u0026amp;pLod2Tower-\u0026gt;marker) { aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; if ((pI-\u0026gt;iId != pObj-\u0026gt;iId) \u0026amp;\u0026amp; (pObj-\u0026gt;uiMask \u0026amp; pMarkerObj-\u0026gt;uiMask)) { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData, false, pObj-\u0026gt;uiUserData, pMarkerObj-\u0026gt;uiUserData); } } } break; case 0x2: { tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + pLodTower-\u0026gt;iFirstChildId + l2y * 2 + l2x; aoiNode_tt* pNode = mem_malloc(sizeof(aoiNode_tt)); pNode-\u0026gt;iId = pObj-\u0026gt;iId; RB_INSERT(aoi_tree_s, \u0026amp;pLod2Tower-\u0026gt;watcher, pNode); aoiNode_tt* pI; RB_FOREACH(pI, aoi_tree_s, \u0026amp;pLod2Tower-\u0026gt;marker) { aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; if ((pI-\u0026gt;iId != pObj-\u0026gt;iId) \u0026amp;\u0026amp; (pObj-\u0026gt;uiMask \u0026amp; pMarkerObj-\u0026gt;uiMask)) { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData, true, pObj-\u0026gt;uiUserData, pMarkerObj-\u0026gt;uiUserData); } } } break; } } } } break; } } } } break; } } } } else { for (int32_t iY = minyLast / 4; iY \u0026lt;= (maxyLast + 3) / 4; ++iY) { for (int32_t iX = minxLast / 4; iX \u0026lt;= (maxxLast + 3) / 4; ++iX) { removeGridWatcher(pTowerSpace, pObj, iX, iY); } } for (int32_t iY = miny/4; iY \u0026lt;= (maxy+3)/4; ++iY) { for (int32_t iX = minx/4; iX \u0026lt;= (maxx+3)/4; ++iX) { insertGridWatcher(pTowerSpace,pObj,iX,iY,pObj-\u0026gt;pos); } } }\t} 2. æŠŠè¢«è§‚å¯Ÿè€…è½¬å…¥è§‚å¯Ÿè€…å®¹å™¨\ninline static void changeAoiObjMaskToWatcher(towerSpace_tt* pTowerSpace,aoiObj_tt* pObj,int32_t iX,int32_t iY,uint64_t uiMask) { int32_t iTowerId = pTowerSpace-\u0026gt;pGrids[iX+iY*pTowerSpace-\u0026gt;iMaxWidth]; assert(iTowerId != -1); tower_tt* pTower = pTowerSpace-\u0026gt;pTowers + iTowerId; if (pTower-\u0026gt;iFirstChildId == -1) { int32_t iChanged; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pTower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { iChanged = 0; aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } return; } int32_t minGridX =iX*4; int32_t minGridY =iY*4; int32_t maxGridX =iX*4+3; int32_t maxGridY =iY*4+3; float bmin[3]; float bmax[3]; int32_t minx = 0; int32_t miny = 0; int32_t maxx = 0; int32_t maxy = 0; bmin[0] = pObj-\u0026gt;last[0] - pObj-\u0026gt;fViewRadius; bmin[2] = pObj-\u0026gt;last[2] - pObj-\u0026gt;fViewRadius; bmax[0] = pObj-\u0026gt;last[0] + pObj-\u0026gt;fViewRadius; bmax[2] = pObj-\u0026gt;last[2] + pObj-\u0026gt;fViewRadius; calcGridLodLoc(pTowerSpace, 2,bmin, \u0026amp;minx, \u0026amp;miny); calcGridLodLoc(pTowerSpace, 2,bmax, \u0026amp;maxx, \u0026amp;maxy); if(!isInInside(minGridX,minGridY,maxGridX,maxGridY,minx,miny,maxx,maxy)) { for (int32_t y = 0; y \u0026lt; 2; y++) { for (int32_t x = 0; x \u0026lt; 2; x++) { tower_tt* pLodTower = pTowerSpace-\u0026gt;pTowers + pTower-\u0026gt;iFirstChildId + y*2+x; if(pLodTower-\u0026gt;iFirstChildId == -1) { int32_t iChanged; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLodTower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { iChanged = 0; aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } } else { if(!isInInside(minGridX+x*2,minGridY+y*2,minGridX+x*2+1,minGridY+y*2+1,minx,miny,maxx,maxy)) { for (int32_t ly = 0; ly \u0026lt; 2; ly++) { for (int32_t lx = 0; lx \u0026lt; 2; lx++) { if(isInRect(minGridX+x*2+lx,minGridY+y*2+ly,minx,miny,maxx,maxy)) { tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + pLodTower-\u0026gt;iFirstChildId + ly*2+lx; int32_t iChanged; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLod2Tower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { iChanged = 0; aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } } } } } else { int32_t iChanged; aoiNode_tt* pI; for (int32_t i = 0; i \u0026lt; 4; i++) { tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + pLodTower-\u0026gt;iFirstChildId+i; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLod2Tower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } } } } } } } else { int32_t iChanged; aoiNode_tt* pI; for (int32_t i = 0; i \u0026lt; 4; i++) { tower_tt* pLodTower = pTowerSpace-\u0026gt;pTowers + pTower-\u0026gt;iFirstChildId+i; if (pLodTower-\u0026gt;iFirstChildId == -1) { RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLodTower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } } else { for (int32_t j = 0; j \u0026lt; 4; j++) { tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + pLodTower-\u0026gt;iFirstChildId+j; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLod2Tower-\u0026gt;marker) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pMarkerObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pMarkerObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pMarkerObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pObj-\u0026gt;uiUserData,pMarkerObj-\u0026gt;uiUserData); } break; } } } } } } } } 3. æ›´æ–°AOIçš„è¢«è§‚å¯Ÿè€…\nvoid towerSpace_updateAoiObjMask(towerSpace_tt* pTowerSpace,int32_t iObjId,uint64_t uiMask) { aoiObj_tt* pObj = pTowerSpace-\u0026gt;pSlotObj + iObjId; assert(pObj-\u0026gt;iId == iObjId); if(pObj-\u0026gt;uiMask == uiMask) { return; } if(pObj-\u0026gt;iMode\u0026amp;MARKER_MODE) { int32_t iX; int32_t iY; calcGridLoc(pTowerSpace,pObj-\u0026gt;last,\u0026amp;iX,\u0026amp;iY); int32_t iTowerId = pTowerSpace-\u0026gt;pGrids[iX+iY*pTowerSpace-\u0026gt;iMaxWidth]; assert(iTowerId != -1); tower_tt* pTower = pTowerSpace-\u0026gt;pTowers + iTowerId; if(pTower-\u0026gt;iFirstChildId == -1) { int32_t iChanged = 0; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pTower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } } else { int32_t iLodX; int32_t iLodY; calcGridLodLoc(pTowerSpace,1,pObj-\u0026gt;last,\u0026amp;iLodX,\u0026amp;iLodY); int32_t iTowerLodId = pTower-\u0026gt;iFirstChildId + (iLodX -iX*2)+(iLodY - iY*2)*2; tower_tt* pLodTower = pTowerSpace-\u0026gt;pTowers + iTowerLodId; if(pLodTower-\u0026gt;iFirstChildId == -1) { int32_t iChanged = 0; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pTower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLodTower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } } else { int32_t iLod2X; int32_t iLod2Y; calcGridLodLoc(pTowerSpace,2,pObj-\u0026gt;last,\u0026amp;iLod2X,\u0026amp;iLod2Y); int32_t iTowerLod2Id = pLodTower-\u0026gt;iFirstChildId + (iLod2X -iLodX*2)+(iLod2Y - iLodY*2)*2; tower_tt* pLod2Tower = pTowerSpace-\u0026gt;pTowers + iTowerLod2Id; int32_t iChanged = 0; aoiNode_tt* pI; RB_FOREACH(pI,aoi_tree_s,\u0026amp;pTower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLodTower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } RB_FOREACH(pI,aoi_tree_s,\u0026amp;pLod2Tower-\u0026gt;watcher) { if(pI-\u0026gt;iId != pObj-\u0026gt;iId) { aoiObj_tt* pWatcherObj = pTowerSpace-\u0026gt;pSlotObj + pI-\u0026gt;iId; iChanged = 0; if(pWatcherObj-\u0026gt;iMode\u0026amp;pObj-\u0026gt;uiMask) { iChanged = 0x1; } if(pWatcherObj-\u0026gt;iMode\u0026amp;uiMask) { iChanged |= 0x2; } switch (iChanged) { case 0x1: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,false,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; case 0x2: { pTowerSpace-\u0026gt;callback(pTowerSpace-\u0026gt;pUserData,true,pI-\u0026gt;iId,pObj-\u0026gt;iId); } break; } } } } } } if(pObj-\u0026gt;iMode\u0026amp;WATCHER_MODE) { float bmin[3]; float bmax[3]; bmin[0] = pObj-\u0026gt;last[0] - pObj-\u0026gt;fViewRadius; bmin[2] = pObj-\u0026gt;last[2] - pObj-\u0026gt;fViewRadius; bmax[0] = pObj-\u0026gt;last[0] + pObj-\u0026gt;fViewRadius; bmax[2] = pObj-\u0026gt;last[2] + pObj-\u0026gt;fViewRadius; int32_t minx = 0; int32_t miny = 0; int32_t maxx = 0; int32_t maxy = 0; calcGridLoc(pTowerSpace, bmin, \u0026amp;minx, \u0026amp;miny); calcGridLoc(pTowerSpace, bmax, \u0026amp;maxx, \u0026amp;maxy); minx = minx \u0026gt; 0 ? minx : 0; miny = miny \u0026gt; 0 ? miny : 0; maxx = maxx \u0026lt; pTowerSpace-\u0026gt;iMaxWidth ? maxx : pTowerSpace-\u0026gt;iMaxWidth - 1; maxy = maxy \u0026lt; pTowerSpace-\u0026gt;iMaxHeight ? maxy : pTowerSpace-\u0026gt;iMaxHeight - 1; for (int32_t iY = miny; iY \u0026lt;= maxy; ++iY) { for (int32_t iX = minx; iX \u0026lt;= maxx; ++iX) { changeAoiObjMaskToWatcher(pTowerSpace,pObj,iX,iY,uiMask); } } } pObj-\u0026gt;uiMask = uiMask; } åœ¨æ­¤AOIæ¨¡å¼ä¸‹å¾®æœåŠ¡å™¨å¤§ä¸–ç•Œåœ°å›¾åˆ†å‰²æ–¹æ³•å’Œä¼ ç»Ÿè¿›ç¨‹åˆ†å‰²æ–¹æ³•çš„ä¸åŒ ä¼ ç»Ÿå¤§ä¸–ç•Œåœ°å›¾åˆ†å‰²æ–¹æ³• æ­¤æ–¹æ³•ä¸ºå‚ç›´åˆ†å‰²æ–¹æ³•ï¼Œå°†ä¸€ä¸ªä¸€äºŒåå…¬é‡Œçš„å¤§åœ°å›¾åˆ†å‰²æˆå¾ˆå¤šå°åœ°å›¾æ”¾åˆ°å„è‡ªçš„è¿›ç¨‹å½“ä¸­å»å¤„ç†æ•°æ®ï¼Œè¿™ç§éœ€è¦å¤„ç†å¤§ä¸–ç•Œåœ°å›¾è¾¹ç¼é—®é¢˜ï¼Œéœ€è¦åšé•œåƒæ•°æ®ç®¡ç†ï¼Œè¿˜æœ‰å¦‚æœè§’è‰²åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ä¹Ÿå°±æ˜¯æŸä¸ªå°åœ°å›¾ä¸Šé¢å †ç§¯ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹çš„å‹åŠ›ä¼šå¾ˆå¤§ï¼Œåˆ«çš„è¿›ç¨‹å´å¾ˆä¼‘é—²ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦å¤„ç†ï¼Œæ€»ä¹‹å¾ˆå¤šéº»çƒ¦ã€‚æ‰€ä»¥æˆ‘ä»¬æ”¹æˆäº†å¾®æœåŠ¡å™¨æ°´å¹³åˆ†å‰²åŠ ç¯å¡”AOIæ–¹å¼\nå¾®æœåŠ¡å¤§ä¸–ç•Œåœ°å›¾å¤„ç†æ–¹æ³•\næ­¤ç»“æ„åŸºäºå¾®æœåŠ¡æ°´å¹³åˆ†å‰²ï¼Œæ¯ä¸ªç›¸åŒå¾®æœåŠ¡å¯ä»¥å¹¶è¡Œå†å¼€å¾ˆå¤šæ¥å¹¶è¡Œå¤„ç†å‡å°‘å‹åŠ›ï¼Œæ¯”å¦‚ç¯å¡”AOIå¼€äº†5ä¸ªå¾®æœåŠ¡æˆ‘å‘ç°ç®—åŠ›è¿˜æ˜¯ä¸å¤Ÿï¼Œ é‚£ä¹ˆæˆ‘å¯ä»¥åœ¨å¢åŠ æ–°çš„ç¯å¡”AOIå¾®æœåŠ¡æ¥å¹¶è¡Œå¤„ç†æ•°æ®ï¼Œæ‰€ä»¥ç†è®ºä¸Šä¸€ä¸ª20å…¬é‡Œçš„åœ°å›¾æ’‘ä¸ª10å¤šä¸‡çš„äººä¸æˆé—®é¢˜ã€‚è€Œä¸”è¿™ç§æ¨¡å¼åœ¨æœåŠ¡å™¨ä¸éœ€è¦å¤„ç†æ— ç¼é—®é¢˜\nä¸€äº›ç–‘é—®çš„æ€»ç»“ ä¸ºä»€ä¹ˆæœ‰äº†è§‚å¯Ÿè€…é›†åˆï¼Œè¿˜éœ€è¦è¢«è§‚å¯Ÿè€…é›†åˆ å› ä¸ºæœ‰æ—¶å€™æƒ³ä¸»åŠ¨æ£€æŸ¥å¯¹è±¡çš„çŠ¶æ€ï¼Œä»æ€ªç‰©AIä¼šå®šæ—¶æ£€æŸ¥è¢«è§‚å¯Ÿè€…é›†åˆçš„è·ç¦»ï¼Œå†³å®šæ˜¯å¦å‘åŠ¨æ”»å‡»ï¼›åˆæ¯”å¦‚é‡Šæ”¾æŠ€èƒ½éœ€è¦éå†è¢«è§‚å¯Ÿè€…é›†åˆï¼Œåˆ¤æ–­å®ƒä»¬æ˜¯å¦å‘½ä¸­ã€‚å¦‚æœæ²¡æœ‰è¢«è§‚å¯Ÿè€…é›†åˆï¼Œå°±å¿…é¡»éå†æ•´ä¸ªåœºæ™¯çš„å¯¹è±¡\nç®€å•æµ‹è¯•æ•°æ® ","permalink":"https://frog-game.github.io/posts/blog/aoi-tower/","summary":"ä¸€äº›å­—æ®µçš„è§£é‡Š è§‚å¯Ÿè€…ï¼šæˆ‘å¯ä»¥è§‚å¯Ÿåˆ°é‚£äº›äººã€‚ è¢«è§‚å¯Ÿè€…ï¼šé‚£äº›äººèƒ½è§‚å¯Ÿåˆ°è‡ªå·±ã€‚ #define WATCHER_MODE 0x01 è§‚å¯Ÿè€…æ¨¡å¼ #define MARKER_MODE 0x02 è¢«è§‚å¯Ÿè€…æ¨¡å¼ ç¯å¡”ç›¸å…³[ç»“æ„ä½“] 1ï¼šç¯å¡”åŒºåŸŸç»“æ„","title":"å››å‰æ ‘Lodç¯å¡”AOI"},{"content":"luaåˆ é™¤tableä¸­çš„å¤šä¸ªå…ƒç´  å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æœ‰è¿™æ ·çš„éœ€æ±‚:åˆ é™¤tableä¸­è‹¥å¹²ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œæœ€åŸå§‹çš„æƒ³æ³•å°±æ˜¯ç”¨foréå†ä¸€è¾¹tableï¼Œç¬¦åˆæ¡ä»¶çš„ç”¨table.removeå°±å¯ä»¥äº†\nfunction test1(t) for i , v in ipairs(t) do if v.id%3 == 0 then table.remove(t ,i) end end end ç»“æœè¯æ˜è¿™æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºtable.removeåˆ é™¤ç¬¬iå…ƒç´ åï¼Œiåé¢çš„å…ƒç´ ä¼šå‘å‰è¡¥é½ï¼Œè¿™æ ·åˆ é™¤å‰å¤„äºi+1çš„å…ƒç´ å°±å˜æˆäº†iå…ƒç´ ï¼Œç„¶åforå¾ªç¯ä»tä¸­å–ç¬¬i+1ä¸ªå…ƒç´ ï¼Œè¿™æ ·å°±æ¼æ‰äº†ç¬¬i+1ä¸ªå…ƒç´ ï¼Œæ—¢ç„¶è¿™æ ·ä¸è¡Œï¼Œå¾ˆè‡ªç„¶çš„å°±æƒ³åˆ°ç”¨whileå¾ªç¯ï¼Œå¯ä»¥è‡ªç”±æ§åˆ¶â€œéå†çš„æŒ‡é’ˆâ€æ˜¯å¦å‰è¿›ï¼Œæœ‰åˆ é™¤æ“ä½œï¼Œå°±ä¸å‰è¿›ï¼Œå¦åˆ™æ‰å‰è¿›\nä»£ç å¦‚ä¸‹\nfunction test2(t) local int i =1 while(t[i]) do if t[i].id%3 == 0 then table.remove(t , i) else i = i + 1 end end end è·‘ä¸€ä¸‹ï¼Œå¾ˆæ­£å¸¸ï¼\nä½†æ˜¯æ³¨æ„table.removeæ˜¯åˆ é™¤é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œæ¯ä¸€æ¬¡æ“ä½œéƒ½è¦ç§»åŠ¨å¤§é‡å…ƒç´ ï¼Œæ€§èƒ½ä¸ä¼šå¤ªå¥½ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘ç”¨ä¸´æ—¶çš„tableï¼Œç”¨æ¥ä¿å­˜æ²¡æœ‰è¢«åˆ é™¤çš„å…ƒç´ ï¼Œæœ€åå†è®©tæŒ‡å‘è¿™ä¸ªtableï¼Œä»¥ç©ºé—´æ¥æ¢æ—¶é—´ï¼Œè€Œå®é™…ä½¿ç”¨ä¸­ï¼Œtä¸­çš„å…ƒç´ å¾€å¾€æ˜¯tableç±»å‹ï¼Œè¿™æ ·ä¸´æ—¶çš„tableä¸­åªä¼šä¿å­˜å…ƒç´ çš„å¼•ç”¨ï¼Œå› æ­¤å ç”¨çš„ç©ºé—´å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\nä»£ç å¦‚ä¸‹\nfunction test3(t) local newT = {} for i ,v in ipairs(t) do if v.id%3 ~= 0 then table.insert(newT , v) end end t= newT end å¾ˆå¥½å¥‡test3()åˆ°åº•æ¯”test2()å¿«å¤šå°‘å‘¢ï¼Œæˆ‘æµ‹è¯•äº†ä¸€ä¸‹\nt = {} local n = 10000 for i = 1,n do table.insert(t ,{id = i}) end næ˜¯10000çš„æƒ…å†µä¸‹ï¼š\ntest2è€—æ—¶0.234s\ntest3è€—æ—¶0.002s\nç›¸å·®éå¸¸å¤§ã€‚\nç»“è®ºï¼š\nåˆ é™¤tableä¸­çš„å¤šä¸ªå…ƒç´ ï¼Œåœ¨tableè¾ƒå¤§ï¼Œä¸”åˆ é™¤æ“ä½œè¾ƒé¢‘ç¹æ—¶ï¼Œåˆ‡å¿Œä½¿ç”¨table.remove\nLUA-ç‚¹å·å’Œå†’å· ç”±äºLUAä¸­æ˜¯æ¨¡æ‹Ÿç±»ï¼Œæ²¡æœ‰classï¼Œ\næ‰€ä»¥è¿™é‡Œæ˜¯ä½¿ç”¨.å·æ¥è®¿é—®å®ä¾‹çš„æˆå‘˜\nre.SetActive(re, re.activeSelf == false); è€Œå†’å·ï¼š åˆ™æ˜¯ç§è¯­æ³•ç³–ï¼Œçœç•¥äº†ä¸Šé¢ä»£ç ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°\nre:SetActive(re.activeSelf == false); ä¹Ÿå°±æ˜¯è¯´ï¼šluaä¸­å¯¹è±¡.æ–¹æ³•ï¼Œåªèƒ½æ‰¾åˆ°æ–¹æ³•ï¼Œå¯¹è±¡åªèƒ½æ˜¯ç±»å‹ï¼Œå³ä½¿ä¼ å…¥çš„æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥ç­‰æ•ˆäºç¡®å®šäº†å•çº¯çš„æ–¹æ³•ï¼\næ‰€ä»¥å†’å·çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿäº†å¯¹è±¡è®¿é—®è‡ªå·±æ–¹æ³•çš„æ€æƒ³ï¼Œä½†æœ¬è´¨ä¸æ˜¯ï¼\nè®°ä½ï¼šluaæ²¡æœ‰é¢å‘å¯¹è±¡ï¼\nä¸ºä»€ä¹ˆJSONå­—ç¬¦ä¸²å½“ä¸­ä¼šå‡ºç°åæ–œæ ? å¯¹tableæˆ–è€…å¯¹è±¡è¿›è¡Œäº†ä¸¤æ¬¡çš„åºåˆ—åŒ–ã€‚è¯´ç™½äº†å°±æ˜¯è¿›è¡Œäº†ä¸¤æ¬¡çš„toJSONString\nlua å–ä½™é—®é¢˜ lua å¯¹æ•°å­—å­—ç¬¦ä¸²å–ä½™ lua å¯¹å­—ç¬¦ä¸²'0'å–ä½™ï¼Œ luaå› ä¸ºæ˜¯å¼±è¯­è¨€æ‰€ä»¥ä¼šå°è¯•æŠŠä¸Šé¢çš„å­—ç¬¦ä¸²'0'è½¬æ¢æˆæ•°å­—0ï¼Œç„¶åå»è¿›è¡Œå–ä½™ï¼Œä½†æ˜¯åˆä¸èƒ½å¯¹0è¿›è¡Œå–ä½™æ‰€ä»¥ä¼šè¿”å›NaN\nä¸ºå•¥è¿”å›NaN æœ‰å¯èƒ½æ˜¯è¿™ä¸ªåŸå› \nç±»å‹æ˜¯intæ—¶åšäº†åˆ¤æ–­ï¼Œä¸ºdoubleæˆ–è€…å­—ç¬¦ä¸²ä¼šåšè½¬æ¢è·³è¿‡äº†å‰ç½®åˆ¤æ–­ï¼Œä¹Ÿå°±NaNäº†\nluaç›´æ¥å¯¹æ•°å­—0å–ä½™ ä¼šç›´æ¥æŠ¥è¯­æ³•é”™è¯¯\n","permalink":"https://frog-game.github.io/posts/blog/lua-kaifa-zhuyidian/","summary":"luaåˆ é™¤tableä¸­çš„å¤šä¸ªå…ƒç´  å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æœ‰è¿™æ ·çš„éœ€æ±‚:åˆ é™¤tableä¸­è‹¥å¹²ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œæœ€åŸå§‹çš„æƒ³æ³•å°±æ˜¯ç”¨foréå†ä¸€è¾¹tableï¼Œ","title":"luaå¼€å‘ç»éªŒæ€»ç»“"},{"content":"èƒŒæ™¯ æ¯å½“æˆ‘ä»¬æ¥æ”¶ä¸€ä»½æ–°çš„ç‰ˆæœ¬ï¼Œä»£ç æ‹¿åˆ°æ‰‹è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æŸ¥çœ‹ git logï¼Œçœ‹çœ‹è¿™ä»½ä»£ç çš„æäº¤è®°å½•ï¼Œæœ€è¿‘ä»£ç åšä»€ä¹ˆä¿®æ”¹ã€‚å¦‚æœæˆ‘ä»¬çœ‹åˆ° git log æ‚ä¹±æ— ç« ï¼Œå¦‚æœä¸çŸ¥é“æ¯æ¬¡æäº¤çš„ä»£ç åˆ°åº•æ˜¯åšäº†ä»€ä¹ˆï¼Œé‚£ä¹ˆå¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯æ¯”è¾ƒç—›è‹¦çš„äº‹æƒ…ã€‚æ‰€ä»¥è¯´ï¼Œè§„èŒƒçš„ CHANGELOG ä¸ä»…æœ‰åŠ©äºä»–äººå¸®å¿™ review ä»£ç ï¼Œä¹Ÿèƒ½é«˜æ•ˆçš„è¾“å‡º Release Noteï¼Œå¯¹ç‰ˆæœ¬ç®¡ç†ä¹Ÿè‡³å…³é‡è¦ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ [Gitlab]çš„æœåŠ¡ç«¯ hook æ¥é’ˆå¯¹git change log è¿›è¡Œæ ¡éªŒï¼Œæ‹¦æˆªä¸ç¬¦åˆæˆ‘ä»¬è§„èŒƒçš„æäº¤åˆ°ä»“åº“ã€‚\næ–¹æ¡ˆè®¾è®¡ æœåŠ¡ç«¯ git hook åˆ†ä¸ºä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š\npre-receiveï¼ˆæ¨é€å‰ï¼‰ update post-receiveï¼ˆæ¨é€åï¼‰ è¿™ä¸‰ä¸ªæ­¥éª¤å°±æ˜¯æˆ‘ä»¬æœ¬åœ° push å®Œä»£ç æœåŠ¡ç«¯è¦åšçš„äº‹æƒ…ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š\næˆ‘ä»¬å¯ä»¥åœ¨ pre-receiveï¼ˆæ¨é€å‰ï¼‰é˜¶æ®µæ¥åšæäº¤ä¿¡æ¯çš„æ ¡éªŒï¼Œå¦‚æœä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œç›´æ¥è¿”å›ï¼Œåˆ™è¯¥æ¨é€ä¾¿ä¸ä¼šæ¨é€åˆ° GitLab ä»“åº“ä¸­å»ã€‚\nå®è·µè½åœ°-ç®€å•ä¾‹å­ ç¯å¢ƒè¯´æ˜ gitlabç‰ˆæœ¬:14.3.3\nhook é…ç½® ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°è¦é…ç½®ä»“åº“åœ¨ gitlab ä¸­å­˜å‚¨çš„è·¯å¾„ï¼Œä½†å›  gitlab çš„ä»“åº“è‡ªæŸä¸ªç‰ˆæœ¬å¼€å§‹é‡‡ç”¨ hash å­˜å‚¨ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“ä»“åº“å¯¹åº”çš„ç‰©ç†è·¯å¾„ï¼Œå¯ä»¥å¦‚ä¸‹æ“ä½œ\nGitlabé»˜è®¤çš„ä»“åº“å­˜å‚¨è·¯å¾„åœ¨ /var/opt/gitlab/git-dataç›®å½•ä¸‹ï¼Œä»“åº“å­˜å‚¨åœ¨å­ç›®å½•repositoriesé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/gitlab/gitlab.rbæ–‡ä»¶ä¸­git_data_dirså‚æ•°æ¥è‡ªå®šä¹‰ä»“åº“å­˜å‚¨è·¯å¾„ã€‚ä¸‹å›¾æ˜¯æˆ‘ä»¬æœåŠ¡å™¨çš„ä»“åº“è·¯å¾„ã€‚ ä¿å­˜gitä»£ç è·¯å¾„æ—¶ç”¨çš„æ˜¯hashæ¥ä¿å­˜çš„ï¼Œå› ä¸ºæˆ‘è¦åœ¨ä»£ç åº“çš„hooksç›®å½•æ·»åŠ ä¸€äº›git hooksã€‚ä½†æ˜¯gitlabä¿å­˜çš„è·¯å¾„å´æ˜¯è¿™æ ·çš„å¦‚ä¸‹ã€‚ gitlabæ˜¯æ ¹æ®hashå€¼æ¥ä¿å­˜çš„è·¯å¾„ï¼Œè¿™ä¸ªå€¼æ˜¯é¡¹ç›®id,é¡¹ç›®idåœ¨æ¯ä¸ªé¡¹ç›®çš„è®¾ç½®é¡µé¢å¯ä»¥æ‰¾åˆ°ã€‚ æˆ‘testé¡¹ç›®çš„IDæ˜¯7ï¼Œåœ¨shellä¸­æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼ˆecho -n ID | sha256sumï¼‰ç”Ÿæˆä¸€ä¸ªhashå€¼ï¼ŒæŒ‰è¿™ä¸ªå€¼å»æ‰¾è¿™ä¸ªgitåº“çš„ä»£ç ä½ç½®ã€‚testé¡¹ç›®çš„hashå€¼æ˜¯7902699be42c8a8e46fbbb4501726517e86b22c56a189f7625a6da49081b2451. æŸ¥çœ‹gitlab /opt/git/git-data/repositories/@hashed/79/02/ç›®å½•ï¼Œæœ‰ä¸€ä¸ªè·Ÿè¿™ä¸ªä¸€æ¨¡ä¸€æ ·çš„hashå€¼ï¼Œokã€‚ ç¬¬ä¸‰æ­¥ï¼Œhooks ä¸­æ˜¯ gitlab ç¤ºä¾‹çš„ä¸€äº›é’©å­ï¼Œæˆ‘ä»¬è¿™é‡Œé¦–å…ˆæ–°å»ºç›®å½• custom_hooksï¼Œç„¶åç”¨å†åˆ›å»ºæ–‡ä»¶ pre-receiveï¼ˆæ¨é€å‰ï¼‰ï¼Œpre-receive æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼ˆè„šæœ¬è¯­è¨€ä¸º shellï¼‰ï¼ŒåŒæ—¶ä¿®æ”¹ pre-receive æ–‡ä»¶çš„æƒé™ã€‚\nä¿®æ”¹æ–‡ä»¶æƒé™ï¼š\nchmod +777 pre-receive #!/bin/bash echo \u0026#34;å¼€å§‹æäº¤ä¿¡æ¯æ£€æŸ¥...\u0026#34; # ä»æ ‡å‡†è¾“å…¥è·å–æœ¬æ¬¡æäº¤çš„commit idåŠåˆ†æ”¯çš„ä¿¡æ¯ read normalInput ARR=($normalInput) parentCommitId=${ARR[0]} currentCommitId=${ARR[1]} branch=${ARR[2]} echo \u0026#34;æ‚¨æäº¤çš„åˆ†æ”¯ä¸ºï¼š$branch\u0026#34; # è·å–coomitçš„ä¿¡æ¯ï¼Œç”¨æˆ·ï¼Œé‚®ç®±ï¼Œmsgç­‰ user=$(git log --pretty=format:\u0026#34;%an\u0026#34; $currentCommitId -1) echo \u0026#34;æäº¤è€…ä¸ºï¼š$user\u0026#34; commitDate=$(git log --pretty=format:\u0026#34;%cd\u0026#34; $currentCommitId -1) echo \u0026#34;æäº¤æ—¥æœŸä¸ºï¼š$commitDate\u0026#34; msg=$(git log --pretty=format:\u0026#34;%s\u0026#34; $currentCommitId -1) echo \u0026#34;æäº¤çš„æ³¨é‡Šä¸ºï¼š$msg\u0026#34; flag=$(echo $msg | grep -E \u0026#34;fix.*|add.*|del.*|update.*|temp.*|test.*|revert.*|Merge.*\u0026#34;) if [ -z \u0026#34;$flag\u0026#34; ]; then echo \u0026#34;[ERROR]æäº¤ä¿¡æ¯æ ¡éªŒæœªé€šè¿‡ï¼Œéœ€ä»¥ fix|add|del|update|temp|test|revert å¼€å¤´\u0026#34; exit 1 fi ç¬¬å››æ­¥ï¼Œåœ¨æœ¬åœ°å°è¯•æ¨é€ï¼Œæ¨é€æ˜¾ç¤ºå¦‚ä¸‹ï¼Œå¦‚æœä¸ç¬¦åˆè§„èŒƒåˆ™æ— æ³•æäº¤æˆåŠŸã€‚\nç¬¬äº”æ­¥ï¼Œæˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ç›®å½•å¦‚ä¸‹ï¼š pre-receive.py[ä¸»è¦åšäº†ä»£ç åŒ–é£æ ¼æ£€æŸ¥+luacheck] #!/usr/bin/python # coding=utf-8 import re import shutil import tempfile import subprocess import os import sys import emoji from rich.panel import Panel from rich import box from rich.console import Console class Trigger(object): def __init__(self): \u0026#39;\u0026#39;\u0026#39; åˆå§‹åŒ–æäº¤è€…ï¼Œæäº¤idï¼Œ æäº¤è€…msgä¿¡æ¯,å½“å‰æ“ä½œçš„åˆ†æ”¯ \u0026#39;\u0026#39;\u0026#39; self.pushAuthor = \u0026#34;\u0026#34; self.pushCommit = [] self.pushMsg = [] self.pushCount = \u0026#34;\u0026#34; self.pushFile = [] self.console = Console() self.astyle_lint_dir = \u0026#39;/var/opt/gitlab/gitlab_cicd/format_check/linux\u0026#39; def __getGitInfo(self): \u0026#39;\u0026#39;\u0026#39; \u0026#39;\u0026#39;\u0026#39; self.oldObject, self.newObject, self.ref = sys.stdin.readline().strip().split(\u0026#39; \u0026#39;) def __getPushInfo(self): \u0026#39;\u0026#39;\u0026#39; git showå‘½ä»¤è·å–pushä½œè€…ï¼Œæ—¶é—´ï¼Œä»¥åŠæ–‡ä»¶åˆ—è¡¨ æ–‡ä»¶çš„è·¯å¾„ä¸ºç›¸å¯¹äºç‰ˆæœ¬åº“æ ¹ç›®å½•çš„ä¸€ä¸ªç›¸å¯¹è·¯å¾„ \u0026#39;\u0026#39;\u0026#39; rev = subprocess.Popen( \u0026#39;git rev-list \u0026#39; + self.newObject, shell=True, stdout=subprocess.PIPE) revList = rev.stdout.readlines() revList = [x.decode(\u0026#39;utf-8\u0026#39;).strip() for x in revList] # print(revList) # æŸ¥æ‰¾ä»ä¸Šæ¬¡æäº¤self.oldObjectä¹‹åè¿˜æœ‰å¤šå°‘æ¬¡æäº¤ # ä¸»è¦æ˜¯ä¸ºäº†è·å–æäº¤çš„æ–‡ä»¶åˆ—è¡¨ if \u0026#34;0000000000000000000000000000000000000000\u0026#34; == self.oldObject: exit(0) indexOld = revList.index(self.oldObject) pushList = revList[:indexOld] pushList.reverse() getFlag = False # print(pushList) # temp file c_cpp_tempdir = tempfile.mkdtemp(\u0026#39;git_c_cpp_hook\u0026#39;) lua_tempdir = tempfile.mkdtemp(\u0026#39;git_lua_hook\u0026#39;) # print(lua_tempdir) c_cpp_temp_file_path = [] lua_temp_file_path = [] # å¾ªç¯è·å–æ¯æ¬¡æäº¤çš„æ–‡ä»¶åˆ—è¡¨ for pObject in pushList: p = subprocess.Popen(\u0026#39;git show \u0026#39; + pObject, shell=True, stdout=subprocess.PIPE) pipe = p.stdout.readlines() pipe = [x.decode(\u0026#39;utf-8\u0026#39;).strip() for x in pipe] self.pushMsg.append(pipe[4].strip() + \u0026#39;\\n\u0026#39;) self.pushCommit.append(pipe[0].strip(\u0026#34;commit\u0026#34;).strip()) if not getFlag: self.pushAuthor = pipe[1].strip( \u0026#34;Author\u0026#34;).replace(\u0026#39;:\u0026#39;, \u0026#39;\u0026#39;).strip() self.pushCount = len(pushList) getFlag = True # print(pipe) # éªŒè¯æ˜¯å¦c,c++,luaæ–‡ä»¶ fileList = [x for x in pipe if x.startswith(\u0026#34;diff --git\u0026#34;)] # print(\u0026#34;===\u0026gt;\u0026#34;, fileList) indexList = [x for x in pipe if x.startswith( \u0026#34;index \u0026#34;) or x.startswith(\u0026#34;similarity index 100%\u0026#34;)] # print(\u0026#34;===\u0026gt;\u0026#34;, indexList) # fiList = dict(zip(fileList, indexList)) fiList = {fileList[i]: indexList[i] for i in range(len(fileList))} # print(\u0026#34;===\u0026gt;\u0026#34;, fiList) for file in fiList: if fiList[file].strip().startswith(\u0026#34;similarity index 100%\u0026#34;): continue if not (file.lower().endswith(\u0026#39;.cpp\u0026#39;) or file.lower().endswith(\u0026#39;.h\u0026#39;) or file.lower().endswith(\u0026#39;.c\u0026#39;) or file.lower().endswith(\u0026#39;.lua\u0026#39;)): continue filename = file.split(\u0026#39;/\u0026#39;)[-1] # print(filename) self.pushFile.append(filename) # git get Tree content_hash = fiList[file].strip()[15:22] # print(content_hash) content_p = subprocess.Popen( \u0026#39;git cat-file -p \u0026#39;+content_hash, shell=True, stdout=subprocess.PIPE) cpipe = content_p.stdout.readlines() cpipeList = [x.decode(\u0026#39;utf-8\u0026#39;) for x in cpipe] # print(cpipeList) if file.lower().endswith(\u0026#39;.cpp\u0026#39;) or file.lower().endswith(\u0026#39;.h\u0026#39;) or file.lower().endswith(\u0026#39;.c\u0026#39;): # print(filename) # print(content_hash) # print(file) # print(cpipeList) file_path = os.path.join(c_cpp_tempdir, filename) c_cpp_temp_file_path.append(file_path + \u0026#39;\\n\u0026#39;) with open(file_path, \u0026#39;w+\u0026#39;) as fp: fp.writelines(cpipeList) if file.lower().endswith(\u0026#39;.lua\u0026#39;): file_path = os.path.join(lua_tempdir, filename) lua_temp_file_path.append(file_path + \u0026#39;\\n\u0026#39;) with open(file_path, \u0026#39;w+\u0026#39;) as fp: fp.writelines(cpipeList) fc = open(self.astyle_lint_dir + \u0026#39;/.clang-format\u0026#39;) # print(fc.read()) with open(os.path.join(c_cpp_tempdir, \u0026#39;.clang-format\u0026#39;), \u0026#39;w+\u0026#39;) as fp: fp.writelines(fc.read()) fc.close() fe = open(self.astyle_lint_dir + \u0026#39;/.editorconfig\u0026#39;) # print(fe.read()) with open(os.path.join(lua_tempdir, \u0026#39;.editorconfig\u0026#39;), \u0026#39;w+\u0026#39;) as fp: fp.writelines(fe.read()) fe.close() # checkstyle exitflag = 0 exitflag |= self.check_commit_msg() exitflag |= self.c_cpp_handler_checkstyle( c_cpp_tempdir, c_cpp_temp_file_path) exitflag |= self.lua_handler_checkstyle( lua_tempdir, lua_temp_file_path) exitflag |= self.lua_handler_checkdiagnosis( lua_tempdir, lua_temp_file_path) if 1 == exitflag: exit(1) # å¤„ç†c,cppæ–‡ä»¶ def c_cpp_handler_checkstyle(self, c_cpp_tempdir, c_cpp_temp_file_path): try: blag = 0 finalpipe = [] c_cpp_temp_name = [] for path in c_cpp_temp_file_path: cmd = r\u0026#39;python \u0026#39; + self.astyle_lint_dir + \u0026#34;/../run-clang-format.py\u0026#34; + \\ \u0026#39; --clang-format-executable clang-format -r \u0026#39; + path # print(cmd) result = subprocess.Popen( cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE) rpipe = result.stdout.readlines() # print(rpipe) if len(rpipe) \u0026gt; 0: rpipeList = [ x.decode(\u0026#39;utf-8\u0026#39;).replace(c_cpp_tempdir + \u0026#39;/\u0026#39;, \u0026#39;\u0026#39;) for x in rpipe] finalpipe.append(\u0026#34;\u0026#34;.join(rpipeList)) (filepath, tempfilename) = os.path.split(path) c_cpp_temp_name.append(tempfilename) blag = 1 # print(finalpipe) if len(finalpipe) \u0026gt; 0: self.console.print( Panel(\u0026#39;[blue]\u0026#39; + \u0026#34; [ERROR]å¤„ç†c,cppæ–‡ä»¶ä»£ç è§„èŒƒæœªé€šè¿‡\\n\u0026#34; + \u0026#34; éœ€è¦ç”¨vscode clang-format æ’ä»¶è¿›è¡Œä»£ç æ ¼å¼åŒ–\\n\u0026#34; + \u0026#34; æˆ–è€…å»tools\\gitlab_cicd\\n\u0026#34; + \u0026#34; ä¸‹æ‰¾åˆ°install.batè¿›è¡Œè‡ªåŠ¨æ ¼å¼åŒ–\u0026#34; + \u0026#39;\\n\u0026#39; + \u0026#34;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\u0026#34; + \u0026#34;===\u0026gt;æœ‰é—®é¢˜çš„c,cppæ–‡ä»¶\u0026lt;===:\\n\u0026#34; + \u0026#34;\u0026#34;.join(c_cpp_temp_name) + \u0026#34;\\n===\u0026gt;é”™è¯¯æç¤º\u0026lt;===:\\n\u0026#34; + re.sub(\u0026#39;\\x1b.*?m\u0026#39;, \u0026#39;\u0026#39;, \u0026#34;\u0026#34;.join(finalpipe)) + \u0026#39;[/]\u0026#39;, box=box.DOUBLE)) return blag finally: shutil.rmtree(c_cpp_tempdir) # pass # å¤„ç†luaæ–‡ä»¶é£æ ¼ def lua_handler_checkstyle(self, lua_tempdir, lua_temp_file_path): try: blag = 0 finalpipe = [] lua_error_temp_name = [] for path in lua_temp_file_path: cmd = self.astyle_lint_dir + \u0026#39;/codeformat check -f \u0026#39; + path + \u0026#39; -DAE\u0026#39; # print(cmd) result = subprocess.Popen( cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE) rpipe = result.stdout.readlines() # print(rpipe) if len(rpipe) \u0026gt; 0: rpipeList = [x.decode(\u0026#39;utf-8\u0026#39;).replace(lua_tempdir + \u0026#39;/\u0026#39;, \u0026#39;\u0026#39;) for x in rpipe] rpipestr = \u0026#34;\u0026#34;.join(rpipeList) (filepath, tempfilename) = os.path.split(path) if(not re.search(r\u0026#39;^Check.*?OK$\u0026#39;, rpipestr)): finalpipe.append(rpipestr) lua_error_temp_name.append(tempfilename) blag = 1 # print(lua_error_temp_name) if 1 == blag: self.console.print( Panel(\u0026#39;[blue]\u0026#39; + \u0026#34; [ERROR]å¤„ç†luaæ–‡ä»¶ä»£ç è§„èŒƒæœªé€šè¿‡\\n\u0026#34; + \u0026#34; éœ€è¦ç”¨vscode EmmyLuaCodeStyle æ’ä»¶è¿›è¡Œä»£ç æ ¼å¼åŒ–\\n\u0026#34; + \u0026#34; æˆ–è€…å»tools\\gitlab_cicd\\n\u0026#34; + \u0026#34; ä¸‹æ‰¾åˆ°install.batè¿›è¡Œè‡ªåŠ¨æ ¼å¼åŒ–\u0026#34; + \u0026#39;\\n\u0026#39; + \u0026#34;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\u0026#34; + \u0026#34;===\u0026gt;æœ‰é—®é¢˜çš„luaæ–‡ä»¶\u0026lt;===:\\n\u0026#34; + \u0026#34;\u0026#34;.join(lua_error_temp_name) + \u0026#34;\\n===\u0026gt;é”™è¯¯æç¤º\u0026lt;===:\\n\u0026#34; + re.sub(\u0026#39;\\x1b.*?m\u0026#39;, \u0026#39;\u0026#39;, \u0026#34;\u0026#34;.join(finalpipe)) + \u0026#39;[/]\u0026#39;, box=box.DOUBLE)) return blag finally: # shutil.rmtree(lua_tempdir) pass def lua_handler_checkdiagnosis(self, lua_tempdir, lua_temp_file_path): try: blag = 0 finalpipe = [] lua_error_temp_name = [] for path in lua_temp_file_path: cmd = self.astyle_lint_dir + \u0026#39;/luacheck \u0026#39; + path + \\ \u0026#39; --no-config --no-default-config --codes -q --exclude-files **/config.lua --ignore 311\u0026#39; # print(cmd) result = subprocess.Popen( cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE) rpipe = result.stdout.readlines() # print(rpipe) if len(rpipe) \u0026gt; 0: rpipeList = [ x.decode(\u0026#39;utf-8\u0026#39;).replace(lua_tempdir + \u0026#39;/\u0026#39;, \u0026#39;\u0026#39;) for x in rpipe] rpipestr = \u0026#34;\u0026#34;.join(rpipeList) (filepath, tempfilename) = os.path.split(path) if(re.findall(r\u0026#39;^Check.*?error\u0026#39;, rpipestr)): finalpipe.append(rpipestr) lua_error_temp_name.append(tempfilename) blag = 1 # print(finalpipe) if 1 == blag: self.console.print( Panel(\u0026#39;[blue]\u0026#39; + \u0026#34; [ERROR]å¤„ç†luaæ–‡ä»¶ä»£ç è¯­æ³•æœªé€šè¿‡\\n\u0026#34; + \u0026#34; è¯·æ‰‹åŠ¨ä¿®æ”¹å¹¶æäº¤, ç›´åˆ°æ‰€æœ‰ä»£ç éƒ½ç¬¦åˆè§„èŒƒä¸ºæ­¢...\u0026#34; + \u0026#39;\\n\u0026#39; + \u0026#34;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\u0026#34; + \u0026#34;===\u0026gt;æœ‰é—®é¢˜çš„luaæ–‡ä»¶\u0026lt;===:\\n\u0026#34; + \u0026#34;\u0026#34;.join(lua_error_temp_name) + \u0026#34; \\n===\u0026gt;é”™è¯¯æç¤º\u0026lt;===:\\n\u0026#34; + re.sub(\u0026#39;\\x1b.*?m\u0026#39;, \u0026#39;\u0026#39;, \u0026#34;\u0026#34;.join(finalpipe)) + \u0026#39;[/]\u0026#39;, box=box.DOUBLE, expand=True)) return blag finally: shutil.rmtree(lua_tempdir) # pass def check_commit_msg(self): print(\u0026#34;å¼€å§‹æäº¤ä¿¡æ¯æ£€æŸ¥...\u0026#34;) print(\u0026#34;æäº¤è€…ä¸º:\u0026#34;, self.pushAuthor) print(\u0026#34;å½“å‰æäº¤æ€»æ¬¡æ•°:\u0026#34;, self.pushCount) print(\u0026#34;å½“å‰æäº¤æ³¨é‡Šæ¶ˆæ¯:\u0026#34;) for msg in self.pushMsg: print(msg, end=\u0026#34;\u0026#34;) for msg in self.pushMsg: if len(msg) \u0026lt; 10: self.console.print( Panel(\u0026#39;[blue]\u0026#39; + \u0026#34;[ERROR]æäº¤ä¿¡æ¯æ ¡éªŒæœªé€šè¿‡\\n\u0026#34; \u0026#34;msgé•¿åº¦å¿…é¡»å¤§äº10\u0026#34; + \u0026#39;[/]\u0026#39;, box=box.DOUBLE)) return 1 msgList = msg.split(\u0026#34; \u0026#34;, 1) if not (len(msgList) == 2 and emoji.is_emoji(msgList[0]) and re.search(r\u0026#39;^[init|feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert](.*):[\\s]{1}[\\S]{1,20}\\n\u0026#39;, msgList[1]), re.S): self.console.print( Panel(\u0026#39;[blue]\u0026#39; + \u0026#34; [ERROR]æäº¤ä¿¡æ¯æ ¡éªŒæœªé€šè¿‡,å†…å®¹ä¸ç¬¦åˆè§„èŒƒ\\n\u0026#34; + \u0026#34; è¯·å»vscodeä¸‹è½½git-commit-pluginè¿›è¡Œè§„èŒƒæäº¤\\n\u0026#34; + \u0026#34;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\u0026#34; + \u0026#34;e.g.:ğŸ‰ init(å½±å“èŒƒå›´æ¨¡å—): é¡¹ç›®åˆå§‹åŒ–\\n\u0026#34; + \u0026#34;e.g.:âœ¨ feat(å½±å“èŒƒå›´æ¨¡å—): æ–°å¢æŸæŸåŠŸèƒ½\\n\u0026#34; + \u0026#34;e.g.:ğŸ fix(å½±å“èŒƒå›´æ¨¡å—): ä¿®å¤æŸæŸbug\\n\u0026#34; + \u0026#34;e.g.:ğŸ“ƒ docs(å½±å“èŒƒå›´æ¨¡å—): æ–°å¢æŸæŸè¯´æ˜æ–‡æ¡£\\n\u0026#34; + \u0026#34;e.g.:ğŸŒˆ style(å½±å“èŒƒå›´æ¨¡å—): ä»…ä»…ä¿®æ”¹äº†ç©ºæ ¼,ç¼©è¿›,é€—å·ç­‰ç­‰\\n\u0026#34; + \u0026#34;e.g.:ğŸ¦„ refactor(å½±å“èŒƒå›´æ¨¡å—): é‡æ„æŸæŸåŠŸèƒ½\\n\u0026#34; + \u0026#34;e.g.:ğŸˆ perf(å½±å“èŒƒå›´æ¨¡å—): ä¼˜åŒ–äº†æé«˜æŸæŸæ¨¡å—æ€§èƒ½\\n\u0026#34; + \u0026#34;e.g.:ğŸ§ª test(å½±å“èŒƒå›´æ¨¡å—): æµ‹è¯•æ¨¡å—åŠŸèƒ½\\n\u0026#34; + \u0026#34;e.g.:ğŸ”§ build(å½±å“èŒƒå›´æ¨¡å—): æ„å»ºäº†é‚£ä¸ªç‰ˆæœ¬\\n\u0026#34; + \u0026#34;e.g.:ğŸ ci(å½±å“èŒƒå›´æ¨¡å—): å¯¹æŸæŸciæ–‡ä»¶çš„ä¿®æ”¹\\n\u0026#34; + \u0026#34;e.g.:ğŸ³ chore(å½±å“èŒƒå›´æ¨¡å—): æ”¹å˜äº†æŸæŸæ„å»ºæµç¨‹\\n\u0026#34; + \u0026#34;e.g.:â†© revert(å½±å“èŒƒå›´æ¨¡å—): å›é€€æŸä¸ªç‰ˆæœ¬\\n\u0026#34; + \u0026#39;[/]\u0026#39;, box=box.DOUBLE)) return 1 return 0 def getGitPushInfo(self): self.__getGitInfo() self.__getPushInfo() if __name__ == \u0026#34;__main__\u0026#34;: t = Trigger() t.getGitPushInfo() exit(0) ","permalink":"https://frog-game.github.io/posts/blog/gitlab-pre-receive-hook/","summary":"èƒŒæ™¯ æ¯å½“æˆ‘ä»¬æ¥æ”¶ä¸€ä»½æ–°çš„ç‰ˆæœ¬ï¼Œä»£ç æ‹¿åˆ°æ‰‹è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æŸ¥çœ‹ git logï¼Œçœ‹çœ‹è¿™ä»½ä»£ç çš„æäº¤è®°å½•ï¼Œæœ€è¿‘ä»£ç åšä»€ä¹ˆä¿®æ”¹ã€‚å¦‚æœæˆ‘ä»¬çœ‹åˆ° git log æ‚ä¹±æ— ç« ","title":"gitlabæœåŠ¡å™¨é’©å­"},{"content":"åŸºç¡€ç±»å‹ å®šä¹‰ è§£é‡Š LUA_TNONE åˆ¤æ–­è¿™ä¸ªå˜é‡æ˜¯å¦ç­‰äºä¸ºç©ºä½¿ç”¨çš„ï¼Œluaå†…éƒ¨ä½¿ç”¨ï¼Œæ³¨æ„ä¸æ˜¯å’Œnilç±»å‹ä¸ç­‰ä»· LUA_TNIL å…¨å±€å˜é‡æ²¡è¢«å¤åˆ¶å°±æ˜¯nilç±»å‹ï¼Œåˆ é™¤å˜é‡ä¼šè¢«èµ‹å€¼æˆnilç±»å‹ï¼Œnilç±»å‹å°±nilä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºå˜é‡æ˜¯å¦è¢«èµ‹å€¼ï¼Œå˜é‡èµ‹å€¼æˆnilä¹Ÿè¡¨ç¤ºåˆ é™¤å˜é‡ LUA_TBOOLEAN falseå’Œnilä¸ºå‡ å…¶ä»–éƒ½ä¸ºçœŸ(åŒ…æ‹¬0) LUA_TLIGHTUSERDATA è§1.1 è¡¨ LUA_TNUMBER æ‰€æœ‰æ•°å­—ï¼Œint float double ç±»å‹éƒ½ä¸ºnumberç±»å‹ numberç±»å‹å¯ä»¥å’Œå…¨æ˜¯æ•°å­—çš„å­—ç¬¦ä¸²è¿›è¡Œè®¡ç®—ï¼Œå­—ç¬¦ä¸²ä¼šè¿›è¡Œç±»å‹è½¬æ¢ LUA_TSTRING ä¸€ä½†è¢«èµ‹å€¼å°±ä¸èƒ½è¢«ä¿®æ”¹ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•string.gsub()æ¥ä¿®æ”¹ï¼›åˆ†ä¸ºé•¿å­—ç¬¦ä¸²å’ŒçŸ­å­—ç¬¦ä¸²ï¼ˆå°äºç­‰äº40å­—ç¬¦ï¼‰ LUA_TTABLE æ•°ç»„å®¹å™¨ LUA_TFUNCTION å‡½æ•° LUA_TUSERDAT è§1.1 è¡¨ LUA_TTHREAD åç¨‹ï¼Œåªæ˜¯æ‹·è´äº†ä¸€ä¸ªæ ˆç©ºé—´ LUA_NUMTAGS tag æ€»æ•° LUA_TTHREAD ä»£è¡¨åç¨‹ç±»å‹ é™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼Œå…¶å®ƒçº¿ç¨‹å’Œå…¶å®ƒLuaå¯¹è±¡ä¸€æ ·éƒ½æ˜¯åƒåœ¾å›æ”¶çš„å¯¹è±¡ã€‚å½“æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¼šå‹å…¥æ ˆï¼Œè¿™æ ·èƒ½ç¡®ä¿æ–°çº¿ç¨‹ä¸ä¼šæˆä¸ºåƒåœ¾ æ¯æ¬¡è°ƒç”¨lua_newstateçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„luastate,ä¸åŒçš„luastateå®Œå…¨ç‹¬ç«‹ï¼Œä¹‹é—´ä¸å…±äº«ä»»ä½•æ•°æ® åç¨‹æä¾›äº†æ–°çš„apiæ¥å£å’Œlua_resetthread,coroutine.close ä¼šä½¿åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€,å¹¶ä¸”å…³é—­æ‰€æœ‰çš„closeå˜é‡ full userdataå’Œlight userdataåŒºåˆ« åŒºåˆ« full userdata light userdata ä½œç”¨ é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„ç»“æ„ä½“ä¸€å°æ®µå›ºå®šçš„å†…å­˜åŒºåŸŸ é€šå¸¸ç”¨æ¥è¡¨ç¤ºCä¸­çš„æŒ‡é’ˆ(void *) å†…å­˜ç®¡ç† ç”±Luaçš„åƒåœ¾å›æ”¶å™¨ç®¡ç† ä½¿ç”¨è€…éœ€è¦å…³å¿ƒå…¶å†…å­˜ å…ƒè¡¨ æœ‰ç‹¬ç«‹çš„å…ƒè¡¨ æ²¡æœ‰ç‹¬ç«‹çš„å…ƒè¡¨ åˆ›å»º void *lua_newuserdata(lua_State *L, size_t size) lua_pushlightuserdata(lua_State *L, void *p); full userdata //cæ–‡ä»¶ //#include \u0026lt;string.h\u0026gt; extern \u0026#34;C\u0026#34; { #include \u0026#34;lua.h\u0026#34; #include \u0026#34;lauxlib.h\u0026#34; #include \u0026#34;lualib.h\u0026#34; } #include \u0026lt;iostream\u0026gt; using namespace std; static struct StudentTag { char *strName; // å­¦ç”Ÿå§“å char *strNum; // å­¦å· int iSex; // å­¦ç”Ÿæ€§åˆ« int iAge; // å­¦ç”Ÿå¹´é¾„ }T; static int Student(lua_State *L) { size_t iBytes = sizeof(struct StudentTag); struct StudentTag *pStudent; pStudent = (struct StudentTag *)lua_newuserdata(L, iBytes); //è®¾ç½®å…ƒè¡¨ luaL_getmetatable(L, \u0026#34;Student\u0026#34;); lua_setmetatable(L, -2); //lua_pushnumber(L, 123); return 1; // æ–°çš„userdataå·²ç»åœ¨æ ˆä¸Šäº† } static int GetName(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \u0026#34;Student\u0026#34;); lua_pushstring(L, pStudent-\u0026gt;strName); return 1; } static int SetName(lua_State *L) { // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯userdata struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \u0026#34;Student\u0026#34;); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² const char *pName = luaL_checkstring(L, 2); luaL_argcheck(L, pName != NULL \u0026amp;\u0026amp; pName != \u0026#34;\u0026#34;, 2, \u0026#34;Wrong Parameter\u0026#34;); pStudent-\u0026gt;strName =(char*) pName; return 0; } static int GetAge(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \u0026#34;Student\u0026#34;); lua_pushinteger(L, pStudent-\u0026gt;iAge); return 1; } static int SetAge(lua_State *L) { struct StudentTag *pStudent = (struct StudentTag *)luaL_checkudata(L, 1, \u0026#34;Student\u0026#34;); int iAge = luaL_checkinteger(L, 2); luaL_argcheck(L, iAge \u0026gt;= 6 \u0026amp;\u0026amp; iAge \u0026lt;= 100, 2, \u0026#34;Wrong Parameter\u0026#34;); pStudent-\u0026gt;iAge = iAge; return 0; } static int GetSex(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 1; } static int SetSex(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 0; } static int GetNum(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 1; } static int SetNum(lua_State *L) { // è¿™é‡Œç”±ä½ æ¥è¡¥å…… return 0; } static luaL_Reg arrayFunc_meta[] = { { \u0026#34;getName\u0026#34;, GetName }, { \u0026#34;setName\u0026#34;, SetName }, { \u0026#34;getAge\u0026#34;, GetAge }, { \u0026#34;setAge\u0026#34;, SetAge }, { \u0026#34;getSex\u0026#34;, GetSex }, { \u0026#34;setSex\u0026#34;, SetSex }, { \u0026#34;getNum\u0026#34;, GetNum }, { \u0026#34;setNum\u0026#34;, SetNum }, { NULL, NULL } }; static luaL_Reg arrayFunc[] = { { \u0026#34;new\u0026#34;, Student}, { NULL, NULL } }; extern \u0026#34;C\u0026#34; _declspec(dllexport) int luaopen_mytestlib(lua_State *L) { // åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨ luaL_newmetatable(L, \u0026#34;Student\u0026#34;); // å…ƒè¡¨.__index = å…ƒè¡¨ lua_pushvalue(L, -1); lua_setfield(L, -2, \u0026#34;__index\u0026#34;); luaL_setfuncs(L, arrayFunc_meta, 0); luaL_newlib(L, arrayFunc); lua_pushvalue(L, -1); lua_setglobal(L, \u0026#34;Sdudent\u0026#34;); /* the module name */ return 1; } -- lua æ–‡ä»¶ require \u0026#34;mytestlib\u0026#34; local objStudent = Sdudent.new() objStudent:setName(\u0026#34;æœå†»\u0026#34;) local strName = objStudent:getName() print(strName ) for k,v in pairs(getmetatable(objStudent)) do print(tostring(k),tostring(v)) end light userdata //Cæ–‡ä»¶ #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string\u0026gt; #include \u0026lt;iostream\u0026gt; using namespace std; extern \u0026#34;C\u0026#34; { #include \u0026#34;lua.h\u0026#34; #include \u0026#34;lualib.h\u0026#34; #include \u0026#34;lauxlib.h\u0026#34; } typedef struct { int x; int y; int z; }TData; static int getAttribute(lua_State* L) { TData *data = (TData*)lua_touserdata(L, 1); std::string attribute = luaL_checkstring(L, 2); int result = 0; if (attribute == \u0026#34;x\u0026#34;) { result = data-\u0026gt;x; } else if (attribute == \u0026#34;y\u0026#34;) { result = data-\u0026gt;y; } else { result = data-\u0026gt;z; } lua_pushnumber(L, result); return 1; } static luaL_Reg dataLib[] = { { \u0026#34;__index\u0026#34;, getAttribute }, { NULL, NULL } }; void getMetaTable(lua_State* L, luaL_Reg* methods) { lua_pushlightuserdata(L, methods); lua_gettable(L, LUA_REGISTRYINDEX); if (lua_isnil(L, -1)) { /* not found */ lua_pop(L, 1); lua_newtable(L); luaL_setfuncs(L, methods, 0); lua_pushlightuserdata(L, methods); lua_pushvalue(L, -2); lua_settable(L, LUA_REGISTRYINDEX); } } int main() { const char* filename = \u0026#34;test.lua\u0026#34;; lua_State *lua = luaL_newstate(); if (lua == NULL) { fprintf(stderr, \u0026#34;open lua failed\u0026#34;); return -1; } luaL_openlibs(lua); TData input = { 123, 231, 321 }; lua_pushlightuserdata(lua, \u0026amp;input); getMetaTable(lua, dataLib); lua_setmetatable(lua, -2); lua_setglobal(lua, \u0026#34;input\u0026#34;); if (luaL_dofile(lua, filename)) { //luaL_error(lua, \u0026#34;load file %s failed\u0026#34;, filename); } lua_getglobal(lua, \u0026#34;data\u0026#34;); int output = lua_tointeger(lua, -1); std::cout \u0026lt;\u0026lt; output \u0026lt;\u0026lt; std::endl; return 0; } --luaæ–‡ä»¶ data = input.x; print(data) éœ€è¦æ³¨æ„åœ°æ–¹ åºå· æ³¨æ„é¡¹ 1 Luaä¸­å˜é‡æ²¡æœ‰é¢„å®šä¹‰ç±»å‹ï¼Œæ¯ä¸ªå˜é‡å¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„å€¼ï¼Œè¦ç”¨å°±ç›´æ¥èµ‹å€¼ä¸€ç§æ•°æ®ç±»å‹çš„å€¼ 2 nilç±»å‹å°±nilä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºå˜é‡æ˜¯å¦è¢«èµ‹å€¼ï¼Œå˜é‡èµ‹å€¼æˆnilä¹Ÿè¡¨ç¤ºåˆ é™¤å˜é‡ 3 ä½¿ç”¨Type(xxxå˜é‡) å¯ä»¥è·å–è¯¥å˜é‡çš„æ•°æ®ç±»å‹ 4 number æ‰€æœ‰æ•°å­—ï¼Œint float double ç±»å‹ç­‰éƒ½ä¸ºnumberç±»å‹äº† 5 å­—ç¬¦ä¸²ä¸€æ—¦èµ‹å€¼ä¸èƒ½è¢«ä¿®æ”¹ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•string.gsub()æ¥ä¿®æ”¹ï¼Œå¯ä»¥å†™æˆâ€™xxasâ€™å•å¼•å·ï¼Œä½†æ˜¯å»ºè®®ç”¨åŒå¼•å·â€â€ 6 numberç±»å‹å¯ä»¥å’Œå…¨æ˜¯æ•°å­—çš„å­—ç¬¦ä¸²è¿›è¡Œè®¡ç®—ï¼Œå­—ç¬¦ä¸²ä¼šè¿›è¡Œç±»å‹è½¬æ¢ 7 .. è¿æ¥ç¬¦å· ï¼Œå¯ä»¥è¿æ¥å­—ç¬¦ä¸²ç±»å‹ï¼Œä¹Ÿå¯ä»¥è¿æ¥æ•´å½¢çš„å˜é‡ï¼Œä½†æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨çœŸå®çš„æ•°å­—è¦åœ¨åé¢åŠ ä¸ªç©ºæ ¼ï¼Œå› ä¸ºç³»ç»Ÿä¼šæŠŠ æ•°å­—.. çœ‹å‡º2ä¸ªæµ®ç‚¹ å¦‚ 1..2 ï¼ˆé”™è¯¯å†™æ³•ï¼‰ 1 ..2 (æ­£ç¡®å†™æ³•) 8 ç±»å‹ä¸åŒï¼Œæ¯”è¾ƒåˆ¤æ–­ä¹Ÿä¸ä¼šç›¸ç­‰,å¦‚numberç±»å‹çš„123ä¸ç­‰äºstringç±»å‹çš„123 9 è®¡ç®—è¿ç®—ç¬¦ä¸­å–ä½™å¯ä»¥å’Œæµ®ç‚¹æ•°è®¡ç®—ï¼Œå¯ä»¥ç²¾ç¡®åˆ°å°æ•°çº§åˆ« 10 å…³ç³»è¿ç®—ç¬¦ä¸­~= è¡¨ç¤ºä¸ç­‰äºï¼Œç±»ä¼¼å…¶ä»–è¯­è¨€å¦‚cçš„ != 11 é€»è¾‘è¿ç®—ç¬¦ and ï¼Œor ï¼Œnot å¯¹åº” \u0026amp;\u0026amp; ï¼Œ|| , ï¼ 12 è¡¨è¾¾å¼ï¼ša and b aä¸ºå‡åˆ™è¿”å›a å¦åˆ™è¿”å›bï¼Œ a or b aä¸ºçœŸè¿”å›aå¦åˆ™è¿”å›b ,ç®€å•ç†è§£andå°±æ˜¯å…ˆåˆ¤æ–­a aæ­£ç¡®å°±ç»§ç»­åˆ¤æ–­bï¼Œå¦‚æœbä¹Ÿæ­£ç¡®è¿”å›btrueï¼Œåˆ™if(a and b) ä¸ºtrue ï¼Œè¿™å®é™…ä¸Šä¹Ÿæ˜¯\u0026amp;\u0026amp;çš„ä½¿ç”¨åŸç†ä¸€æ · ï¼Œå¦‚æœaä¸ºå‡å°±æ˜¯falseç›´æ¥è¿”å›a if(a and b) å°±æ˜¯falseäº† ã€‚ or åŒç† 13 èµ‹å€¼æ–¹å¼ä¸€ï¼šå¤šä¸ªå˜é‡åŒæ—¶èµ‹å€¼ï¼Œå¤šçš„å˜é‡(å˜é‡ä¸ªæ•°å¤šäºå€¼ä¸ªæ•°)é»˜è®¤ä¸ºnilï¼Œå°‘çš„å˜é‡(å˜é‡ä¸ªæ•°å°‘äºå€¼ä¸ªæ•°)ä¸åšå¤„ç†ï¼Œå¯ä»¥ç±»å‹æ··æ­ 14 å±€éƒ¨å˜é‡ ç”¨localä¿®é¥°å£°æ˜ ï¼Œå†…å­˜åœ¨æ ˆä¸Šï¼Œåœ¨ä¸€ä¸ªå‡½æ•°ï¼Œä»£ç å—{ }å†… å‡½æ•°ï¼Œä»£ç å—ç»“æŸï¼Œå†…å­˜è‡ªåŠ¨é‡Šæ”¾ 15 å…¨å±€å˜é‡åœ¨å †ä¸Šï¼Œå¯ä»¥éšæ—¶åˆ›å»ºï¼Œç¨‹åºç»“æŸï¼Œå†…å­˜è‡ªåŠ¨é‡Šæ”¾ 16 æ§åˆ¶è¯­å¥ä¸Šï¼Œæœ‰if for where æ²¡æœ‰switchç»“æ„ 17 æ§åˆ¶è¯­å¥ä¸Šï¼Œä¸éœ€è¦å†™ () {} {æŒ‡ä»£ ï¼šthen } æŒ‡ä»£ ï¼š end 18 å¾ªç¯ç»“æ„ while do end ,é‡Œé¢ä¸èƒ½å†™() ä»¥åŠ ++ â€“ += ç±»ä¼¼çš„è¿ç®—ç¬¦ 19 å¾ªç¯ç»“æ„ for ä¹Ÿä¸éœ€è¦å†™() ä¹Ÿä¸åœ¨èµ‹å€¼é™¤äº†å¯¹ç¬¬ä¸€ä¸ªèµ‹å€¼ï¼Œå…¶ä»–éƒ½å¯ä»¥çœç•¥å†™é»˜è®¤å†™ä¸º \u0026lt;= +xx æˆ– \u0026gt;= -xx 20 å‡½æ•°çš„è¿”å›å€¼å’Œå…¶ä»–è¯­è¨€ä¸€æ ·å¯ä»¥è¿”å›ä¸ªå€¼ï¼Œå˜é‡ã€‚ä½†æ˜¯ä¸åŒçš„æ˜¯å¯ä»¥åŒæ—¶è¿”å›å¤šä¸ªå˜é‡ï¼Œè¿›è¡Œå¤šä¸ªèµ‹å€¼ 21 tableå¯ä»¥æœ‰æ•°ç»„çš„å½¢å¼ï¼Œå­—å…¸çš„å½¢å¼ï¼Œæ•°ç»„å­—å…¸åŒæ—¶æ··åˆçš„å½¢å¼ 22 print()æ‰“å°ä¼šé»˜è®¤æ¢è¡Œ 23 #å·æ•°ç»„æ˜¯è®¡ç®—æ•°ç»„å®¹å™¨tableçš„ä¸‹æ ‡ä¸ªæ•°ï¼Œluaçš„æ•°ç»„å®¹å™¨ä¸‹æ ‡ä»1å¼€å§‹è®¡ç®—é€’å¢ï¼Œå­—å…¸ä¸åŒ…æ‹¬keyå…ƒç´  24 ipairs ä»…ä»…éå†å€¼ï¼ŒæŒ‰ç…§ç´¢å¼•å‡åºéå†ï¼Œç´¢å¼•ä¸­æ–­åœæ­¢éå†ã€‚ä¸èƒ½è¿”å› nil,å¦‚æœé‡åˆ° nil åˆ™é€€å‡ºã€‚å®ƒåªèƒ½éå†åˆ°é›†åˆä¸­å‡ºç°çš„ç¬¬ä¸€ä¸ªä¸æ˜¯æ•´æ•°çš„ keyã€‚ pairs èƒ½éå†é›†åˆçš„æ‰€æœ‰å…ƒç´ ã€‚å³ pairs å¯ä»¥éå†é›†åˆä¸­æ‰€æœ‰çš„ keyï¼Œå¹¶ä¸”é™¤äº†è¿­ä»£å™¨æœ¬èº«ä»¥åŠéå†è¡¨æœ¬èº«è¿˜å¯ä»¥è¿”å› nilã€‚ 25 luaå¸ƒå°”ç±»å‹åªæœ‰ä¸¤ä¸ªå–å€¼falseå’Œtrue. ä½†è¦æ³¨æ„luaä¸­æ‰€æœ‰çš„å€¼éƒ½å¯ä»¥ä½œä¸ºæ¡ä»¶. åœ¨æ§åˆ¶ç»“æ„çš„æ¡ä»¶ä¸­é™¤äº†falseå’Œnilä¸ºå‡, å…¶ä»–å€¼éƒ½ä¸ºçœŸã€‚luaè®¤ä¸º 0 å’Œ ç©ºå­—ç¬¦ä¸²éƒ½æ˜¯çœŸï¼ï¼ pairså’Œipairs ä¾‹å­æ¯”è¾ƒ test = {[\u0026#34;xxx\u0026#34;] = nil , tt = \u0026#34;tabao\u0026#34;} for k , v in pairs(test) do print(k,v) end è¾“å‡ºï¼š tt tabao test = {nil = xxxx , tt = \u0026#34;tabao\u0026#34;} for k , v in pairs(test) do print(k,v) end è¾“å‡ºï¼šstdin:1: bad argument #1 to \u0026#39;for iterator\u0026#39; (table expected, got nil) stack traceback: [C]: in function \u0026#39;next\u0026#39; stdin:1: in main chunk [C]: in ? local tab = { [1] = \u0026#34;a\u0026#34;, [3] = \u0026#34;b\u0026#34;, [4] = \u0026#34;c\u0026#34; } for k, v in ipairs(tab) do print(k, v) end è¾“å‡ºï¼š1 a ,åœ¨keyç­‰äº2å¤„æ–­å¼€ local tab= { [2] = \u0026#34;a\u0026#34;, [3] = \u0026#34;b\u0026#34;, [4] = \u0026#34;c\u0026#34; } for k, v in ipairs(tab) do print(k, v) end è¾“å‡ºï¼šä»€ä¹ˆéƒ½æ²¡è¾“å‡ºï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ§åˆ¶å˜é‡åˆå§‹å€¼æ˜¯æŒ‰å‡åºæ¥éå†çš„ï¼Œå½“keyä¸º1æ—¶ï¼Œvalueä¸ºnilï¼Œæ­¤æ—¶ä¾¿åœæ­¢äº†éå†ï¼Œ æ‰€æœ‰ä»€ä¹ˆç»“æœéƒ½æ²¡è¾“å‡ºã€‚ for k, v in pairs(tab) do print(k, v) end è¾“å‡ºï¼š2 a, 3 b, 4 c local tab = {\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, [3] = \u0026#34;c\u0026#34;, [\u0026#34;two\u0026#34;] = \u0026#34;d\u0026#34;} for i,v in ipairs(tab) do print( tab [i] ) end è¾“å‡ºï¼šaï¼Œbï¼Œc for i,v in pairs(tab) do print( tab [i] ) è¾“å‡ºï¼šaï¼Œbï¼Œcï¼Œdã€‚ lua æ¨¡å— import å’Œ require å·®å¼‚ è½½å…¥ä¸€ä¸ªæ¨¡å— import() ä¸ require() åŠŸèƒ½ç›¸åŒï¼Œä½†å…·æœ‰ä¸€å®šç¨‹åº¦çš„è‡ªåŠ¨åŒ–ç‰¹æ€§ã€‚\nimportæ”¯æŒç›¸å¯¹è·¯å¾„çš„å†™æ³•ï¼Œä¸€ä¸ªç‚¹è¡¨ç¤ºå½“å‰ç›®å½•ï¼Œä¸¤ä¸ªç‚¹è¡¨ç¤ºä¸Šä¸€çº§ç›®å½•ï¼Œä»¥æ­¤ç±»æ¨ã€‚\nrequire æœ€å¥½å†™æˆç»å¯¹è·¯å¾„çš„å½¢å¼å¦‚ï¼šrequire \u0026quot;src.ui.common.FightPointAdd\u0026quot; or require \u0026quot;src/common/FightPointAdd\u0026quot;\nimportè¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿æ˜¯å‡è®¾ï¼šA/B/ä¸‹æœ‰ä¸¤ä¸ªæ–‡ä»¶ c.lua,d.luaï¼Œå¦‚æœåœ¨ cä¸­ç”¨åˆ°äº† dè¯,require( \u0026quot;A/B/d\u0026quot;),import(\u0026quot;.d\u0026quot;) ï¼Œå¦‚æœåé¢ç›®å½•ç»“æ„æ”¹äº† ,c,déƒ½åˆ°äº† Aç›®å½•ä¸‹,é‚£å¯¹åº”çš„è¦ä¿®æ”¹ require(\u0026quot;A/d) è€Œ importå¯ä»¥ä¸ç”¨ä¿®æ”¹ã€‚\nlua æ­£åˆ™è¡¨è¾¾å¼ æµ‹è¯•å·¥å…·åœ°å€:https://wiki.luatos.com/pages/emulator.html\nä¸‹é¢çš„è¡¨åˆ—å‡ºäº† Luaæ”¯æŒçš„æ‰€æœ‰å­—ç¬¦ç±»:\n. ä»»æ„å­—ç¬¦ %a å­—æ¯ %c æ§åˆ¶å­—ç¬¦ %d æ•°å­— %l å°å†™å­—æ¯ %p æ ‡ç‚¹å­—ç¬¦ %s ç©ºç™½ç¬¦ %u å¤§å†™å­—æ¯ %w å­—æ¯å’Œæ•°å­— %x åå…­è¿›åˆ¶æ•°å­— %z ä»£è¡¨0çš„å­—ç¬¦ ä¸Šé¢å­—ç¬¦ç±»çš„å¤§å†™å½¢å¼è¡¨ç¤ºå°å†™æ‰€ä»£è¡¨çš„é›†åˆçš„è¡¥é›†ã€‚ä¾‹å¦‚, %Aéå­—æ¯çš„å­—ç¬¦:\nprint(string.gsub(\u0026#34;hello, up-down!\u0026#34;, \u0026#34;%A\u0026#34;, \u0026#34;.\u0026#34;)) --\u0026gt; hello..up.down. 4 æ•°å­— 4ä¸æ˜¯å­—ç¬¦ä¸²ç»“æœçš„ä¸€éƒ¨åˆ†ï¼Œä»–æ˜¯ gsubè¿”å›çš„ç¬¬äºŒä¸ªç»“æœï¼Œä»£è¡¨å‘ç”Ÿæ›¿æ¢çš„æ¬¡æ•°.\nluaç‰¹æ®Šå­—ç¬¦\n( ) . % + - * ? [ ^ $ %ç”¨ä½œç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰å­—ç¬¦ï¼Œå› æ­¤ %. åŒ¹é…ç‚¹; %%åŒ¹é…å­—ç¬¦ % .è½¬ä¹‰å­—ç¬¦ %ä¸ä»…å¯ä»¥ç”¨æ¥è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œè¿˜å¯ä»¥ç”¨äºæ‰€æœ‰çš„éå­—æ¯çš„å­—ç¬¦ã€‚å½“å¯¹ä¸€ä¸ªå­—ç¬¦æœ‰ç–‘é—®çš„æ—¶å€™ï¼Œä¸ºå®‰å…¨èµ·è§è¯·ä½¿ç”¨è½¬ä¹‰å­—ç¬¦è½¬ä¹‰ä»–ã€‚\n\\ æ˜¯luaçš„è½¬ä¹‰å­—ç¬¦\n[%w_]å°†åŒ¹é…å­—æ¯æ•°å­—å’Œä¸‹åˆ’çº¿\n[01]åŒ¹é…äºŒè¿›åˆ¶æ•°å­—ï¼Œ[%[%]]åŒ¹é…ä¸€å¯¹æ–¹æ‹¬å·\nç¬¬ä¸€ä¸ªå­—ç¬¦å’Œæœ€åä¸€ä¸ªå­—ç¬¦ä¹‹é—´ç”¨è¿å­—ç¬¦ -è¿æ¥è¡¨ç¤ºè¿™ä¸¤ä¸ªå­—ç¬¦ä¹‹é—´èŒƒå›´å†…çš„å­—ç¬¦é›†åˆ\n%dè¡¨ç¤º [0-9]\n%xè¡¨ç¤º [0-9a-fA-F]\næŸ¥æ‰¾å…«è¿›åˆ¶æ•°:[0-7]\nåŒ¹é…ä»»ä½•éæ¢è¡Œç¬¦æˆ·çš„å­—ç¬¦: [^\\n]\næ¨¡å¼ä¿®é¥°ç¬¦\n+ åŒ¹é…å‰ä¸€å­—ç¬¦1æ¬¡æˆ–å¤šæ¬¡ * åŒ¹é…å‰ä¸€å­—ç¬¦0æ¬¡æˆ–å¤šæ¬¡ - åŒ¹é…å‰ä¸€å­—ç¬¦0æ¬¡æˆ–å¤šæ¬¡ ? åŒ¹é…å‰ä¸€å­—ç¬¦0æ¬¡æˆ–1æ¬¡ +åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ï¼Œå¥¹æ€»æ˜¯è¿›è¡Œæœ€é•¿çš„åŒ¹é…. æ¯”å¦‚ï¼Œæ¨¡å¼ä¸² %a+åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ¯æˆ–è€…ä¸€ä¸ªå•è¯ :\nprint(string.gsub(\u0026#34;one, and two; and three\u0026#34;, \u0026#34;%a+\u0026#34;, \u0026#34;word\u0026#34;)) --\u0026gt; word, word word; word word %d+åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­— (æ•´æ•°):\ni, j = string.find(\u0026#34;the number 1298 is even\u0026#34;, \u0026#34;%d+\u0026#34;) print(i,j) --\u0026gt; 12 15 * ä¸ +ç±»ä¼¼, ä½†æ˜¯ä»–åŒ¹é…ä¸€ä¸ªå­—ç¬¦ 0æ¬¡æˆ–å¤šæ¬¡å‡ºç°.ä¸€ä¸ªå…¸å‹çš„åº”ç”¨æ˜¯åŒ¹é…ç©ºç™½ã€‚æ¯”å¦‚ï¼Œä¸ºäº†åŒ¹é…ä¸€å¯¹åœ†æ‹¬å· ()æˆ–è€… ( )ä¹‹é—´çš„ç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨ %(%s*%) ( '%s*ç”¨æ¥åŒ¹é… 0ä¸ªæˆ–å¤šä¸ªç©ºç™½,ç”±äºåœ†æ‹¬å·åœ¨æ¨¡å¼ä¸­æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ %è½¬ä¹‰ä»– .) å†çœ‹ä¸€ä¸ªä¾‹å­ï¼Œ[_%a][_%w]*åŒ¹é… Luaç¨‹åºä¸­çš„æ ‡ç¤ºç¬¦ï¼šå­—æ¯æˆ–è€…ä¸‹åˆ’çº¿å¼€å¤´çš„å­—æ¯ä¸‹åˆ’çº¿æ•°å­—åºåˆ—ã€‚\n-ä¸ *ä¸€æ ·ï¼Œéƒ½åŒ¹é…ä¸€ä¸ªå­—ç¬¦çš„0æ¬¡æˆ–å¤šæ¬¡å‡ºç°ï¼Œä½†æ˜¯ä»–è¿›è¡Œçš„æ˜¯æœ€çŸ­åŒ¹é…ã€‚æŸäº›æ—¶å€™è¿™ä¸¤ä¸ªç”¨èµ·æ¥æ²¡æœ‰åŒºåˆ«ï¼Œä½†æœ‰äº›æ—¶å€™ç»“æœå°†æˆªç„¶ä¸åŒã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨æ¨¡å¼ [_%a][_%w]-æ¥æŸ¥æ‰¾æ ‡ç¤ºç¬¦ï¼Œä½ å°†åªèƒ½æ‰¾åˆ°ç¬¬ä¸€ä¸ªå­—æ¯ï¼Œå› ä¸º [_%w]-æ°¸è¿œåŒ¹é…ç©ºã€‚å¦ä¸€æ–¹é¢ï¼Œå‡å®šä½ æƒ³æŸ¥æ‰¾Cç¨‹åºä¸­çš„æ³¨é‡Šï¼Œå¾ˆå¤šäººå¯èƒ½ä½¿ç”¨ /%*.*%*/ (ä¹Ÿå°±æ˜¯è¯´ \u0026quot;/*\u0026quot; åé¢è·Ÿç€ä»»æ„å¤šä¸ªå­—ç¬¦ï¼Œç„¶åè·Ÿç€ \u0026quot;*/\u0026quot;) ç„¶è€Œï¼Œç”±äº .*è¿›è¡Œçš„æ˜¯æœ€é•¿åŒ¹é…ï¼Œè¿™ä¸ªæ¨¡å¼å°†åŒ¹é…ç¨‹åºä¸­ç¬¬ä¸€ä¸ª \u0026quot;/*\u0026quot; å’Œæœ€åä¸€ä¸ª \u0026quot;*/\u0026quot;ä¹‹é—´æ‰€æœ‰éƒ¨åˆ†:\ntest = \u0026#34;int x; /* x */ int y; /* y */\u0026#34; print(string.gsub(test, \u0026#34;/%*.*%*/\u0026#34;, \u0026#34;\u0026lt;COMMENT\u0026gt;\u0026#34;)) --\u0026gt; int x; \u0026lt;COMMENT\u0026gt; ç„¶è€Œæ¨¡å¼ .-è¿›è¡Œçš„æ˜¯æœ€çŸ­åŒ¹é…ï¼Œå¥¹ä¼šåŒ¹é… \u0026quot;/*\u0026quot;å¼€å§‹åˆ°ç¬¬ä¸€ä¸ª \u0026quot;*/\u0026quot;ä¹‹å‰çš„éƒ¨åˆ†:\ntest = \u0026#34;int x; /* x */ int y; /* y */\u0026#34; print(string.gsub(test, \u0026#34;/%*.-%*/\u0026#34;, \u0026#34;\u0026lt;COMMENT\u0026gt;\u0026#34;)) --\u0026gt; int x; \u0026lt;COMMENT\u0026gt; int y; \u0026lt;COMMENT\u0026gt; ?åŒ¹é…ä¸€ä¸ªå­—ç¬¦ 0æ¬¡æˆ– 1æ¬¡.ä¸¾ä¸ªä¾‹å­ï¼Œå‡å®šæˆ‘ä»¬æƒ³åœ¨ä¸€æ®µæ–‡æœ¬å†…æŸ¥æ‰¾ä¸€ä¸ªæ•´æ•°ï¼Œæ•´æ•°å¯èƒ½å¸¦æœ‰æ­£è´Ÿå·ã€‚ æ¨¡å¼ [+-]?%d+ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œå¥¹å¯ä»¥åŒ¹é… åƒ \u0026quot;-12\u0026quot;, \u0026quot;23\u0026quot; å’Œ \u0026quot;+1009\u0026quot;ç­‰æ•°å­—. [+-] æ˜¯ä¸€ä¸ªåŒ¹é… +æˆ–è€… -çš„å­—ç¬¦ç±»ï¼›æ¥ä¸‹æ¥çš„ ?æ„æ€æ˜¯åŒ¹é…å‰é¢çš„å­—ç¬¦ç±» 0æ¬¡æˆ–è€… 1æ¬¡.\nä¸å…¶ä»–ç³»ç»Ÿçš„æ¨¡å¼ä¸åŒçš„æ˜¯ï¼ŒLuaä¸­çš„ä¿®é¥°ç¬¦ä¸èƒ½ç”¨å­—ç¬¦ç±»ï¼›ä¸èƒ½å°†æ¨¡å¼åˆ†ç»„ç„¶åä½¿ç”¨ä¿®é¥°ç¬¦ä½œç”¨è¿™ä¸ªåˆ†ç»„ã€‚æ¯”å¦‚ï¼Œæ²¡æœ‰ä¸€ä¸ªæ¨¡å¼å¯ä»¥åŒ¹é…ä¸€ä¸ªå¯é€‰çš„å•è¯(é™¤éè¿™ä¸ªå•è¯åªæœ‰ä¸€ä¸ªå­—æ¯)ã€‚ä¸‹é¢æˆ‘å°†çœ‹åˆ°ï¼Œé€šå¸¸ä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é«˜çº§æŠ€æœ¯ç»•å¼€è¿™ä¸ªé™åˆ¶ã€‚\nä»¥ ^å¼€å¤´çš„æ¨¡å¼åªåŒ¹é…ç›®æ ‡ä¸²çš„å¼€å§‹éƒ¨åˆ†ï¼Œç›¸ä¼¼çš„ï¼Œä»¥ $ç»“å°¾çš„æ¨¡å¼åªåŒ¹é…ç›®æ ‡ä¸²çš„ç»“å°¾éƒ¨åˆ†ã€‚è¿™ä¸ä»…å¯ä»¥ç”¨æ¥é™åˆ¶ä½ è¦æŸ¥æ‰¾çš„æ¨¡å¼ï¼Œè¿˜å¯ä»¥å®šä½(anchor)æ¨¡å¼ã€‚æ¯”å¦‚ï¼š\nif string.find(s, \u0026#34;^%d\u0026#34;) then ... ç¬¦ä¸²sæ˜¯å¦ä»¥æ•°å­—å¼€å¤´ï¼Œè€Œ if string.find(s, \u0026#34;^[+-]?%d+$\u0026#34;) then ... æ£€æŸ¥å­—ç¬¦ä¸² sæ˜¯å¦æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚\n%bç”¨æ¥åŒ¹é…å¯¹ç§°çš„å­—ç¬¦.å¸¸å†™ä¸º %bxy,xå’Œ yæ˜¯ä»»æ„ä¸¤ä¸ªä¸åŒçš„å­—ç¬¦ï¼›xä½œä¸ºåŒ¹é…çš„å¼€å§‹,yä½œä¸ºåŒ¹é…çš„ç»“æŸã€‚æ¯”å¦‚ï¼Œ %b()åŒ¹é…ä»¥ (å¼€å§‹ï¼Œ ä»¥ )ç»“æŸçš„å­—ç¬¦ä¸²:\nprint(string.gsub(\u0026#34;a (enclosed (in) parentheses) line\u0026#34;, \u0026#34;%b()\u0026#34;, \u0026#34;\u0026#34;)) --\u0026gt; a line å¸¸ç”¨çš„è¿™ç§æ¨¡å¼æœ‰ï¼š %b(), %b[], %b%{%},å’Œ %b\u0026lt;\u0026gt;ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å­—ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ã€‚\nluaå­—ç¬¦ä¸²ç®¡ç† typedef struct TString { CommonHeader; // å­—ç¬¦ä¸²çš„å­ç±»å‹æœ‰ä¸¤ç§ï¼šé•¿å­—ç¬¦ä¸²å’ŒçŸ­å­—ç¬¦ä¸² // çŸ­å­—ç¬¦ä¸²ï¼šextraè¡¨ç¤ºLuaä¿ç•™å­—çš„ç´¢å¼•ï¼Œå¦‚æœä¸º0å°±ä¸æ˜¯ä¿ç•™å­— // é•¿å­—ç¬¦ä¸²ï¼šextraæ ‡è®°æ˜¯å¦å·²ç»è®¡ç®—å“ˆå¸Œå€¼ï¼Œ0è¡¨ç¤ºè¿˜æœªè®¡ç®— lu_byte extra; lu_byte shrlen; // çŸ­å­—ç¬¦ä¸²é•¿åº¦ unsigned int hash; // å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ // ä¸‹é¢è”åˆåˆ†ä¸¤ç§æƒ…å†µï¼š // å¦‚æœæ˜¯é•¿å­—ç¬¦ä¸²åˆ™æ˜¯é•¿åº¦lnglen // å¦‚æœæ˜¯çŸ­å­—ç¬¦ä¸²åˆ™æ˜¯hnextï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªçŸ­å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒçŸ­å­—ç¬¦ä¸²ä¼šç”¨å“ˆå¸Œè¡¨ç¼“å­˜ï¼Œ union { size_t lnglen; struct TString *hnext; } u; char contents[1];//çœŸæ­£çš„å­—ç¬¦ä¸²å­˜å‚¨åœ¨è¿™é‡Œ } TString; å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼ å…¨å±€å­—ç¬¦ä¸²è¡¨ typedef struct stringtable { TString **hash;//hashæ•£åˆ—æ¡¶ int nuse; /* number of elements *///å®é™…çš„ä½¿ç”¨å…ƒç´  int size;//å½“å‰æ¡¶çš„å¤§å° } stringtable; é“¾è¡¨æ–¹å¼ ç›¸åŒ hashå­—ç¬¦ä¸²å­˜å‚¨åœ¨ stringtable strt é“¾è¡¨ç»“æ„ä¸Š ä¸€èˆ¬ çŸ­å­—ç¬¦ä¸²ä¼šä½¿ç”¨è¿™ç§æ–¹å¼å­˜å‚¨\nhashMapç¼“å­˜æ–¹å¼ ä¸‹å›¾ä¸­Næ˜¯æ•°ç»„è¡Œï¼ŒMæ˜¯æ•°ç»„åˆ—\niçš„ä¸‹æ ‡å€¼é€šè¿‡ unsigned int i = point2uint(str) % STRCACHE_Nhashæ±‚å¾—\njçš„æœ€å¤§å€¼å›ºå®šå°±æ˜¯ä¸‹é¢çš„å®å‡½æ•° STRCACHE_M 2\nä¸‹é¢ä¸¤ä¸ªå‡½æ•° luaS_new luaS_newlstræ˜¯åˆ›å»ºå­—ç¬¦ä¸²çš„æ ¸å¿ƒå‡½æ•°\n/* ** Create or reuse a zero-terminated string, first checking in the ** cache (using the string address as a key). The cache can contain ** only zero-terminated strings, so it is safe to use \u0026#39;strcmp\u0026#39; to ** check hits. åˆ›å»ºæˆ–é‡ç”¨ä¸€ä¸ªä»¥\u0026#39;0\u0026#39;ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œé¦–å…ˆæŸ¥æ‰¾ global_state çš„ strcache ç¼“å­˜æ˜¯å¦å·²å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼Œ è‹¥å­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œå¹¶åŠ å…¥åˆ°ç¼“å­˜ä¸­ */ TString *luaS_new (lua_State *L, const char *str) { //point2uint æŒ‡é’ˆè½¬æ— ç¬¦å·æ•´æ•° unsigned int i = point2uint(str) % STRCACHE_N; /* hash */ //æ±‚å‡ºstrcacheä¸‹æ ‡ STRCACHE_Nç­‰äº53 int j; //åœ¨å…¨å±€Gä¸­æŸ¥æ‰¾strcacheé‡Œé¢æŸ¥æ‰¾æ˜¯å¦æœ‰è¿™ä¸ªstring TString **p = G(L)-\u0026gt;strcache[i]; for (j = 0; j \u0026lt; STRCACHE_M; j++) { if (strcmp(str, getstr(p[j])) == 0) /* hit? */ return p[j]; /* that is it */ } //å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ›å»ºæ–°çš„Tstring,å¹¶æ”¾åˆ°ç¬¬ä¸€ä¸ªä½ç½® //åŒæ—¶ä¹Ÿæ„å‘³ç€æœ€åä¸€ä¸ªå…ƒç´ ä¼šè¢«ç§»é™¤strcache /* normal route */ for (j = STRCACHE_M - 1; j \u0026gt; 0; j--) p[j] = p[j - 1]; /* move out last element */ /* new element is first in the list */ p[0] = luaS_newlstr(L, str, strlen(str));//åˆ›å»ºæ–°çš„Tstring return p[0]; } /* ** new string (with explicit length) åˆ›å»ºä¸€ä¸ªç»™å®šé•¿åº¦çš„å­—ç¬¦ä¸² */ TString *luaS_newlstr (lua_State *L, const char *str, size_t l) { if (l \u0026lt;= LUAI_MAXSHORTLEN) /* short string? */ //åˆ¤æ–­æ˜¯ä¸æ˜¯çŸ­å­—ç¬¦ä¸² return internshrstr(L, str, l);//çŸ­å­—ç¬¦ä¸²åˆ›å»º else {//é•¿å­—ç¬¦ä¸²åˆ›å»º TString *ts; if (l_unlikely(l \u0026gt;= (MAX_SIZE - sizeof(TString))/sizeof(char)))//å¦‚æœå­—ç¬¦ä¸²å¤ªé•¿ åˆ›å»ºå¤±è´¥ luaM_toobig(L); ts = luaS_createlngstrobj(L, l);//ç›´æ¥åˆ›å»ºé•¿å­—ç¬¦ä¸² memcpy(getstr(ts), str, l * sizeof(char));//æ‹·è´å­—ç¬¦ä¸²å†…å®¹ return ts; } } /* ** Checks whether short string exists and reuses it or creates a new one. ** æ£€æŸ¥çŸ­å­—ç¬¦ä¸²æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ */ static TString *internshrstr (lua_State *L, const char *str, size_t l) { TString *ts; global_State *g = G(L);//å…¨å±€è¡¨ stringtable *tb = \u0026amp;g-\u0026gt;strt;//å…¨å±€å­—ç¬¦ä¸²è¡¨ï¼Œluaæ‰€æœ‰çš„çŸ­å­—ç¬¦ä¸²éƒ½å­˜åœ¨è¿™ä¸ªé‡Œé¢ unsigned int h = luaS_hash(str, l, g-\u0026gt;seed);//æ±‚çš„hashå€¼ TString **list = \u0026amp;tb-\u0026gt;hash[lmod(h, tb-\u0026gt;size)];//æ±‚å¾—å…¨å±€å­—ç¬¦ä¸²è¡¨ä¸­å¯¹åº”hashä½ç½®çš„é“¾è¡¨ lua_assert(str != NULL); /* otherwise \u0026#39;memcmp\u0026#39;/\u0026#39;memcpy\u0026#39; are undefined */ for (ts = *list; ts != NULL; ts = ts-\u0026gt;u.hnext) {//éå†é“¾è¡¨æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒçš„å­—ç¬¦ä¸² if (l == ts-\u0026gt;shrlen \u0026amp;\u0026amp; (memcmp(str, getstr(ts), l * sizeof(char)) == 0)) { /* found! */ if (isdead(g, ts)) /* dead (but not collected yet)? *///å¦‚æœæ‰¾åˆ°ï¼Œå¹¶ä¸”å½“å‰gcåˆ¤æ–­è¦è¢«å›æ”¶ changewhite(ts); /* resurrect it *///è¿™ä¸ªæ—¶å€™ä¿®æ”¹å®ƒä¸ºç™½è‰²çŠ¶æ€ï¼Œè¡¨ç¤ºä¸éœ€è¦å›æ”¶ return ts;//ç›´æ¥è¿”å›æŸ¥æ‰¾åˆ°çš„å­—ç¬¦ä¸² } } /* else must create a new string *///å¦åˆ™å¿…é¡»åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² if (tb-\u0026gt;nuse \u0026gt;= tb-\u0026gt;size) { /* need to grow string table? *///å®¹é‡ä¸å¤Ÿéœ€è¦æ‰©å®¹ growstrtab(L, tb);//æ‰©å®¹å®¹é‡ list = \u0026amp;tb-\u0026gt;hash[lmod(h, tb-\u0026gt;size)]; /* rehash with new size *///é‡æ–°è®¡ç®—å…¨å±€å­—ç¬¦ä¸²è¡¨ä¸­å¯¹åº”çš„hashä½ç½®çš„é“¾è¡¨ } ts = createstrobj(L, l, LUA_VSHRSTR, h);//åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ memcpy(getstr(ts), str, l * sizeof(char));//æ‹·è´è¿›å» ts-\u0026gt;shrlen = cast_byte(l);//èµ‹å€¼å­—ç¬¦ä¸²å¤§å°ï¼ŒæŒ‰æ— ç¬¦å·charå¤§å°æ±‚é•¿åº¦ ts-\u0026gt;u.hnext = *list;//æ·»åŠ åˆ°å…¨å±€çš„å­—ç¬¦ä¸²è¡¨ä¸­,æ­¤å¤„æ˜¯å¤´æ’æ³•æ’å…¥æ•°æ® *list = ts; tb-\u0026gt;nuse++; return ts; } //åˆ›å»ºä¸€ä¸ªé•¿ä¸² TString *luaS_createlngstrobj (lua_State *L, size_t l) { TString *ts = createstrobj(L, l, LUA_VLNGSTR, G(L)-\u0026gt;seed); ts-\u0026gt;u.lnglen = l; return ts; } /*åˆ›å»ºä¸€ä¸ªé•¿å­—ç¬¦ä¸²æˆ–è€…çŸ­å­—ç¬¦ä¸² ** creates a new string object */ static TString *createstrobj (lua_State *L, size_t l, int tag, unsigned int h) { TString *ts; GCObject *o; size_t totalsize; /* total size of TString object */ totalsize = sizelstring(l);//å¾—åˆ°çœŸæ­£å­—ç¬¦ä¸²çš„å¤§å° o = luaC_newobj(L, tag, totalsize);//åˆ›å»ºä¸€ä¸ªGCå¯¹è±¡ ts = gco2ts(o);//å¼ºåˆ¶è½¬æ¢ä¸ºTsingç»“æ„ ts-\u0026gt;hash = h;//èµ‹seedå€¼ä¹Ÿå°±æ˜¯éšæœºç§å­ ts-\u0026gt;extra = 0;//0è¡¨ç¤ºè¿˜æœªè®¡ç®—çœŸæ­£çš„hashå€¼ getstr(ts)[l] = \u0026#39;\\0\u0026#39;; /* ending 0 */ return ts; } å‡½æ•°è°ƒç”¨è¿‡ç¨‹ å­—ç¬¦ä¸²å¤§å° å­—ç¬¦ä¸²å†…å®¹ä¼šåœ¨æœ‰æ•ˆæ•°æ®çš„ç»“å°¾å¼ºåˆ¶åŠ ä¸Š \\0ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¯¹è±¡çš„æ€»å¤§å°ä¸º:\nå¤´çš„å¤§å°åŠ ä¸Šå­—ç¬¦ä¸²çš„ç©ºé—´+åŠ ä¸Šæœ€åçš„ \\0\n/* ** Size of a TString: Size of the header plus space for the string ** itself (including final \u0026#39;\\0\u0026#39;). */ #define sizelstring(l) (offsetof(TString, contents) + ((l) + 1) * sizeof(char)) //offsetof(TString, contents) contentsæˆå‘˜ç›¸å¯¹äºTStringå¼€å¤´ä½ç½®çš„åç§»é‡ï¼Œç­‰ä»·äºå¤´çš„å¤§å° //((l) + 1) læ˜¯å¤–éƒ¨ä¼ è¿›æ¥é•¿çŸ­å­—ç¬¦ä¸²çš„å¤§å° +1æ˜¯æœ€å\u0026#39;\\0\u0026#39;å¤§å° é•¿çŸ­å­—ç¬¦ä¸² /* ** Maximum length for short strings, that is, strings that are ** internalized. (Cannot be smaller than reserved words or tags for ** metamethods, as these strings must be internalized; ** #(\u0026#34;function\u0026#34;) = 8, #(\u0026#34;__newindex\u0026#34;) = 10.) */ #if !defined(LUAI_MAXSHORTLEN) #define LUAI_MAXSHORTLEN\t40 #endif çŸ­å­—ç¬¦ä¸² å®šä¹‰:å°äºç­‰äº 40ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²\næ¯”è¾ƒå¤§å° å› ä¸ºæ˜¯é‡å¤åˆ©ç”¨çš„ï¼Œæ‰€ä»¥ç›´æ¥æ¯”è¾ƒæŒ‡é’ˆåœ°å€å°±å¯ä»¥äº†\n/* ** equality for short strings, which are always internalized */ #define eqshrstr(a,b)\tcheck_exp((a)-\u0026gt;tt == LUA_VSHRSTR, (a) == (b)) é•¿å­—ç¬¦ä¸² è®¡ç®—hashå€¼ é•¿å­—ç¬¦ä¸²ä¸ä¼šé©¬ä¸Šè®¡ç®—å“ˆå¸Œå€¼ï¼Œä¸€èˆ¬åœ¨è°ƒç”¨ luaS_hashlongstr æ—¶å€™æ‰ä¼šå»è®¡ç®—\nunsigned int luaS_hashlongstr (TString *ts) { lua_assert(ts-\u0026gt;tt == LUA_VLNGSTR); if (ts-\u0026gt;extra == 0) { /* no hash? *///extraä¸º0çš„æ—¶å€™æ‰å»è®¡ç®—hashå€¼ size_t len = ts-\u0026gt;u.lnglen; ts-\u0026gt;hash = luaS_hash(getstr(ts), len, ts-\u0026gt;hash);//é€šè¿‡luaS_hashåˆ›å»ºhashå€¼ ts-\u0026gt;extra = 1; /* now it has its hash */ } return ts-\u0026gt;hash; } unsigned int luaS_hash (const char *str, size_t l, unsigned int seed) { unsigned int h = seed ^ cast_uint(l); for (; l \u0026gt; 0; l--) h ^= ((h\u0026lt;\u0026lt;5) + (h\u0026gt;\u0026gt;2) + cast_byte(str[l - 1])); return h; } æ¯”è¾ƒå¤§å° /* ** equality for long strings é•¿å­—ç¬¦ä¸²çš„æ¯”è¾ƒï¼šå…ˆæ¯”è¾ƒåœ°å€ï¼Œå†æ¯”è¾ƒé•¿åº¦ï¼Œæœ€åæ¯”è¾ƒå†…å®¹ */ int luaS_eqlngstr (TString *a, TString *b) { size_t len = a-\u0026gt;u.lnglen; lua_assert(a-\u0026gt;tt == LUA_VLNGSTR \u0026amp;\u0026amp; b-\u0026gt;tt == LUA_VLNGSTR); return (a == b) || /* same instance or... */ ((len == b-\u0026gt;u.lnglen) \u0026amp;\u0026amp; /* equal length and ... */ (memcmp(getstr(a), getstr(b), len) == 0)); /* equal contents */ } luaè®¾å€¼å–å€¼é‡ç½®hashå’Œtableè¿‡ç¨‹ lua table å€¼å¯¹è±¡ç»“æ„ /* ** Union of all Lua values è¿˜æœ‰å‡ ç§æ•°æ®ç±»å‹æ˜¯ä¸éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶çš„, //Lua ä¸­å°†GCObject å’Œå®ƒä»¬ä¸€èµ·æ”¾åœ¨äº†è”åˆä½“Value ä¸­: */ typedef union Value { struct GCObject *gc; /* collectable objects */ void *p; /* light userdata */ lua_CFunction f; /* light C functions */ lua_Integer i; /* integer numbers */ lua_Number n; /* float numbers */ } Value; å˜é‡ è¯´æ˜ GCObject gc ç”¨äºåƒåœ¾å›æ”¶ ä¸»è¦æ˜¯ä¸ºäº†è¿æ¥åƒåœ¾å›æ”¶å¯¹è±¡çš„äº’ç›¸å¼•ç”¨å…³ç³» void *p ä¸ºcä¸­ä¼ å…¥çš„æŒ‡é’ˆï¼Œç”±c åˆ†é…å’Œé‡Šæ”¾ light userdata lua_CFunction f è¡¨ç¤ºCå¯¼å‡ºç»™luaçš„å‡½æ•°æŒ‡é’ˆï¼Œtypedef int (*lua_CFunction) (lua_State *L) lua_Integer i è¡¨ç¤ºæ•´æ•°ç±»å‹ï¼Œtypedef long long lua_Integer lua_Number n è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹ç±»å‹ï¼Œtypedef double lua_Number éGCå¯¹è±¡ ä»ä¸Šé¢å¯ä»¥çœ‹åˆ° éGCçš„å¯¹è±¡æœ‰ 4ä¸­\nlight userdata Cå‡½æ•° æ•´å‹ æµ®ç‚¹å‹ int b(lua 5.4 æ•°å­—åˆ†ä¸ºæ•´æ•°å’Œæµ®ç‚¹ï¼Œè€Œiæ­£å¥½ä¹Ÿå¯ä»¥ç”¨ä½œbool,æ‰€ä»¥æŠŠè¿™ä¸ªç»™åˆ é™¤,å’Œ lua_Integer i ç»“åˆåˆ°ä¸€èµ·äº†) GCå¯¹è±¡ union GCUnion { GCObject gc; /* common header */ struct TString ts; struct Udata u; union Closure cl; struct Table h; struct Proto p;// Protoä¸»è¦å­˜æ”¾äºŒè¿›åˆ¶æŒ‡ä»¤é›†Opcode Luaåœ¨è§£æå‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ä¸€æ¡æ¡è¯­å¥é€ä¸ªâ€˜ç¼–è¯‘â€™æˆæŒ‡ä»¤é›† struct lua_State th; /* thread */ struct UpVal upv; }; ä»ä¸Šé¢çš„ unionç»“æ„ä½“å¯ä»¥çœ‹åˆ° GCå¯¹è±¡æœ‰ 6ä¸­\nå­—ç¬¦ä¸² userdata closure é—­åŒ… table lua å‡½æ•°åŸå‹(Protoä¸»è¦å­˜æ”¾äºŒè¿›åˆ¶æŒ‡ä»¤é›†Opcode) lua çº¿ç¨‹ (å…¶å®å°±æ˜¯åç¨‹) luaä¸Šå€¼ CommonHeaderç±»å‹ #define CommonHeader\tstruct GCObject *next; lu_byte tt; lu_byte marked next æŒ‡é’ˆ æŒ‡å‘ä¸‹ä¸€ä¸ªGCå¯¹è±¡ tt GCå¯¹è±¡çš„å®é™…ç±»å‹(æ¯”å¦‚ä¸Šé¢6ä¸­GCå¯¹è±¡) marked æ ‡è¯†GCçš„çŠ¶æ€(ç™½1 ç™½2 é»‘ final) TValuefields ç±»å‹ #define TValuefields Value value_; int tt_ Valueï¼šå­˜å‚¨å…·ä½“æ•°æ®çš„å€¼ tt_ï¼šè¡¨ç¤ºè¿™ä¸ªå€¼çš„ç±»å‹ï¼Œå³æ‰€æœ‰çš„åŸºç¡€æ•°æ®ç±»å‹ table ç»“æ„ typedef struct Table { CommonHeader; lu_byte flags; /* 1\u0026lt;\u0026lt;p means tagmethod(p) is not present *///ç”¨äºè¡¨ç¤ºcacheåœ¨è¯¥è¡¨ä¸­å®ç°äº†å“ªäº›å…ƒæ–¹æ³• lu_byte lsizenode; /* log2 of size of \u0026#39;node\u0026#39; array *///å“ˆå¸Œéƒ¨åˆ†çš„é•¿åº¦å¯¹æ•°ï¼š1 \u0026lt;\u0026lt; lsizenode æ‰èƒ½å¾—åˆ°å®é™…çš„size unsigned int alimit; /* \u0026#34;limit\u0026#34; of \u0026#39;array\u0026#39; array *///æ•°ç»„éƒ¨åˆ†çš„é•¿åº¦ TValue *array; /* array part *///æ•°ç»„éƒ¨åˆ† Node *node;//hashéƒ¨åˆ† é—­æ•£åˆ—æ–¹æ³•è§£å†³hashå†²çª Node *lastfree; /* any free position is before this position *///ç©ºé—²æ§½ä½ struct Table *metatable;//å…ƒè¡¨ GCObject *gclist;//gcé“¾è¡¨ } Table; typedef union Node { struct NodeKey { TValuefields; /* fields for value *///å€¼åŸŸ lu_byte key_tt; /* key type *///keyç±»å‹ int next; /* for chaining *///é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç´¢å¼• Value key_val; /* key value *///keyå€¼ } u; TValue i_val; /* direct access to node\u0026#39;s value as a proper \u0026#39;TValue\u0026#39; */ } Node; hashè§£å†³å†²çªæ—¶å€™çš„ä¸¤ç§æ–¹æ³• é—­æ•£åˆ— ï¼ˆå³å¼€æ”¾åœ°å€æ³•ï¼‰ï¼šå½“å‘ç”Ÿå“ˆå¸Œå†²çªæ—¶ï¼Œå¦‚æœè¯¥å“ˆå¸Œè¡¨è¿˜æ²¡æœ‰è¢«å¡«æ»¡ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥å…ƒç´ æ”¾åˆ°å“ˆå¸Œè¡¨çš„ä¸‹ä¸€ä¸ªç©ºé—²çš„ä½ç½®\nä¼˜ç‚¹ï¼šç®€å• æ˜“æ‡‚,å½“hashè¡¨å·²ç»æ²¡æœ‰ç©ºæ ¼çš„æ—¶å€™ï¼Œluaå°±ä¼šresizeè¿™ä¸ªhashè¡¨ã€‚è¿™æ ·åšçš„å¥½å¤„ä¸»è¦æ˜¯ä¸ç”¨åŠ¨æ€ç”³è¯·å†…å­˜ç©ºé—´ï¼Œhashè¡¨åˆå§‹åŒ–çš„æ—¶å€™æœ‰å¤šå°‘å†…å­˜ç©ºé—´å°±ç”¨å¤šå°‘ï¼Œä¸å¤Ÿå°±resizeè¿™ä¸ªhashè¡¨ã€‚\nç¼ºç‚¹ï¼šä¸€æ—¦å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼Œæ‰€æœ‰çš„å†²çªè¿æ¥åœ¨ä¸€èµ·ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿæ•°æ®â€å †ç§¯â€ã€‚å³ä¸åŒçš„æ•°æ®å ç”¨å¯ä»¥åˆ©ç”¨çš„ä½ç½®ï¼Œå°±ä½¿å¾—å¯»æ‰¾å…¶ä½™æ•°æ®çš„ä½ç½®éœ€è¦è¿›è¡Œå¤šæ¬¡æ¯”è¾ƒï¼Œå°±ä¼šå¯¼è‡´æŸ¥æ‰¾çš„æ•ˆç‡é™ä½ã€‚\nå¼€æ•£åˆ— å¼€æ•£åˆ—æ³•ï¼ˆå“ˆå¸Œæ¡¶ï¼‰ï¼šåˆåé“¾åœ°å€æ³•ï¼Œå…ˆç”¨å“ˆå¸Œå‡½æ•°è®¡ç®—æ¯ä¸ªæ•°æ®çš„æ•£åˆ—åœ°å€ï¼ŒæŠŠå…·æœ‰ç›¸åŒåœ°å€çš„å…ƒç´ å½’äºåŒä¸€ä¸ªé›†åˆä¹‹ä¸­ï¼ŒæŠŠè¯¥é›†åˆå¤„ç†ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨çš„å¤´èŠ‚ç‚¹å­˜å‚¨äºå“ˆå¸Œè¡¨ä¹‹ä¸­ã€‚\nä¼˜ç‚¹:è§£å†³äº†æ•°æ®æº¢å‡ºçš„é—®é¢˜\nç¼ºç‚¹:éœ€è¦å¢åŠ é“¾æ¥çš„æŒ‡é’ˆï¼Œå¢åŠ å­˜å‚¨å¼€é”€\næ–°å»ºä¸€ä¸ªtable Table *luaH_new (lua_State *L) { GCObject *o = luaC_newobj(L, LUA_VTABLE, sizeof(Table)); Table *t = gco2t(o); t-\u0026gt;metatable = NULL;//åˆå§‹è®¾ç½®metatableä¸ºnull t-\u0026gt;flags = cast_byte(maskflags); /* table has no metamethod fields */ t-\u0026gt;array = NULL;//åˆå§‹åŒ–æ•°ç»„å¤§å° t-\u0026gt;alimit = 0;//æ•°ç»„é•¿åº¦ setnodevector(L, t, 0);//åˆå§‹åŒ–å“ˆå¸Œéƒ¨åˆ† return t; } static void setnodevector (lua_State *L, Table *t, unsigned int size) { //å¦‚æœsizeæ˜¯0ï¼šå°±æ˜¯è¯´æ•´ä¸ªtableä¸ºç©ºï¼Œé‚£ä¹ˆå°±æ˜¯åˆå§‹åŒ–è¿™äº›ä¸œè¥¿ä¸ºé›¶ if (size == 0) { /* no elements to hash part? */ t-\u0026gt;node = cast(Node *, dummynode); /* use common \u0026#39;dummynode\u0026#39; */ t-\u0026gt;lsizenode = 0; t-\u0026gt;lastfree = NULL; /* signal that it is using dummy node */ } //å¦‚æœsizeä¸ä¸ºé›¶ï¼š else { int i; int lsize = luaO_ceillog2(size); //æ‹¿åˆ° æ–°çš„ çœŸå®çš„ å“ˆå¸Œéƒ¨åˆ†é•¿åº¦log2ä¹‹åçš„ç»“æœ //å¦‚æœæ–°çš„é•¿åº¦è¶…å‡ºäº†æœ€å¤§çš„å“ˆå¸Œé•¿åº¦: if (lsize \u0026gt; MAXHBITS || (1u \u0026lt;\u0026lt; lsize) \u0026gt; MAXHSIZE) luaG_runerror(L, \u0026#34;table overflow\u0026#34;);//æŠ¥é”™ size = twoto(lsize); //è¦ä¿è¯åˆ†é…çš„æ˜¯ä»¥2çš„æŒ‡æ•°å¢é•¿æ¥è¿›è¡Œæ‰©å®¹çš„ //åˆ›å»ºäº†ä¸ªå¤§å°ä¸º size*sizeof(Node) çš„å†…å­˜å—ï¼Œç„¶ååˆå§‹åŒ–è¿™å—å†…å­˜ t-\u0026gt;node = luaM_newvector(L, size, Node); for (i = 0; i \u0026lt; (int)size; i++) { Node *n = gnode(t, i); //å°†è¿™å—å†…å­˜ç»™åˆå§‹åŒ– gnext(n) = 0; setnilkey(n); setempty(gval(n)); } t-\u0026gt;lsizenode = cast_byte(lsize); t-\u0026gt;lastfree = gnode(t, size); /* all positions are free */ } } å¢åŠ ä¸€ä¸ªå…ƒç´  /* è¿™ä¸ªå‡½æ•°çš„ä¸»è¦åŠŸèƒ½å°†ä¸€ä¸ªkeyæ’å…¥å“ˆå¸Œè¡¨ï¼Œå¹¶è¿”å›keyå…³è”çš„valueæŒ‡é’ˆã€‚ 1. é¦–å…ˆé€šè¿‡keyè®¡ç®—å‡ºä¸»ä½ç½®ï¼Œå¦‚æœä¸»ä½ç½®ä¸ºç©ºç»“ç‚¹é‚£æœ€ç®€å•ï¼Œå°†keyè®¾è¿›è¯¥ç»“ç‚¹ï¼Œç„¶åè¿”å›ç»“ç‚¹çš„å€¼æŒ‡é’ˆã€‚ 2. å¦‚æœä¸æ˜¯ç©ºç»“ç‚¹å°±è¦åˆ†æƒ…å†µï¼Œçœ‹3å’Œ4ä¸¤ç§æƒ…å†µ 3.å¦‚æœè¯¥ç»“ç‚¹å°±æ˜¯ä¸»ä½ç½®ç»“ç‚¹ï¼Œé‚£ä¹ˆè¦å¦æ‰¾ä¸€ä¸ªç©ºé—²ä½ç½®ï¼ŒæŠŠKeyæ”¾è¿›å»ï¼Œå’Œä¸»ç»“ç‚¹é“¾æ¥èµ·æ¥ï¼Œ ç„¶åè¿”å›æ–°ç»“ç‚¹çš„å€¼æŒ‡é’ˆã€‚ 4.å¦‚æœè¯¥ç»“ç‚¹ä¸æ˜¯ä¸»ä½ç½®ç»“ç‚¹ï¼ŒæŠŠè¿™ä¸ªç»“ç‚¹ç§»åˆ°ç©ºé—²ä½ç½®å»ï¼›ç„¶åæˆ‘è¿›é©»è¿™ä¸ªä½ç½®ï¼Œå¹¶è¿”å›ç»“ç‚¹çš„å€¼æŒ‡é’ˆã€‚ */ TValue *luaH_newkey (lua_State *L, Table *t, const TValue *key) { Node *mp; TValue aux; if (unlikely(ttisnil(key))) //keyæ˜¯ç©ºå€¼ æŠ¥é”™ luaG_runerror(L, \u0026#34;table index is nil\u0026#34;); else if (ttisfloat(key)) { //keyæ˜¯float è½¬æˆint ä¸èƒ½å°±æŠ¥é”™ lua_Number f = fltvalue(key);//å¾—åˆ°floatå€¼ lua_Integer k; if (luaV_flttointeger(f, \u0026amp;k, F2Ieq)) { /* does key fit in an integer? *///å¦‚æœèƒ½è½¬æˆint setivalue(\u0026amp;aux, k); key = \u0026amp;aux; /* insert it as an integer *///æ’å…¥ä¸€ä¸ªintå€¼ } else if (unlikely(luai_numisnan(f)))//å¦‚æœæ˜¯ä¸ªnanæ•° luaG_runerror(L, \u0026#34;table index is NaN\u0026#34;); } mp = mainpositionTV(t, key);// mainpositionå‡½æ•°é€šè¿‡keyæ‰¾åˆ°â€œä¸»ä½ç½®â€çš„nodeæ¡¶ if (!isempty(gval(mp)) || isdummy(t)) { /* main position is taken? */// ä¸»ä½ç½®æ¡¶è¢«å ï¼Œæˆ–è€…å“ˆå¸Œè¡¨éƒ¨åˆ†ä¸ºç©º Node *othern; Node *f = getfreepos(t); /* get a free place */// æ‰¾ç©ºé—²ä½ç½®ï¼Œè¿™é‡Œè¿˜æ¶‰åŠåˆ°æ²¡ç©ºé—²ä½ç½®ä¼šé‡å»ºå“ˆå¸Œè¡¨çš„æ“ä½œ if (f == NULL) { /* cannot find a free place? *///å¦‚æœæ²¡ç©ºé—²ä½ç½®å°±é‡å»ºtable rehash(L, t, key); /* grow table */ //é‡å»ºå“ˆå¸Œè¡¨çš„æ“ä½œ /* whatever called \u0026#39;newkey\u0026#39; takes care of TM cache */ return luaH_set(L, t, key); /* insert key into grown table */ } lua_assert(!isdummy(t)); othern = mainposition(t, keytt(mp), \u0026amp;keyval(mp));// é€šè¿‡ä¸»ä½ç½®è¿™ä¸ªç»“ç‚¹çš„keyï¼Œè®¡ç®—å‡ºæœ¬æ¥çš„ä¸»ä½ç½®ç»“ç‚¹ if (othern != mp) { /* is colliding node out of its main position? */ /* yes; move colliding node into free position */ while (othern + gnext(othern) != mp) /* find previous */// è¿™ç§å°±å¯¹åº”ä¸Šé¢è¯´çš„æƒ…å†µ4çš„å¤„ç†ï¼ŒæŠŠç»“ç‚¹ç§»åˆ°ç©ºé—²ä½ç½®å» othern += gnext(othern); gnext(othern) = cast_int(f - othern); /* rechain to point to \u0026#39;f\u0026#39; */// ç§»åŠ¨ä¹‹å‰ï¼Œè¦å…ˆæŠŠé“¾æ¥ç»“ç‚¹çš„åç§»è°ƒæ•´ä¸€ä¸‹ *f = *mp; /* copy colliding node into free pos. (mp-\u0026gt;next also goes) */// æŠŠå†²çªç»“ç‚¹ç§»åˆ°ç©ºé—²ä½ç½® if (gnext(mp) != 0) { // å¦‚æœå†²çªç»“ç‚¹ä¹Ÿæœ‰é“¾æ¥ç»“ç‚¹ï¼Œä¹Ÿè¦è°ƒæ•´è¿‡æ¥ gnext(f) += cast_int(mp - f); /* correct \u0026#39;next\u0026#39; */ gnext(mp) = 0; /* now \u0026#39;mp\u0026#39; is free */ } setempty(gval(mp)); } else { /* colliding node is in its own main position */ /* new node will go into free position */ if (gnext(mp) != 0) gnext(f) = cast_int((mp + gnext(mp)) - f); /* chain new position */ else lua_assert(gnext(f) == 0); gnext(mp) = cast_int(f - mp); mp = f; } } setnodekey(L, mp, key); luaC_barrierback(L, obj2gco(t), key); lua_assert(isempty(gval(mp))); return gval(mp); } ","permalink":"https://frog-game.github.io/posts/read/luayuanmashagnxi/","summary":"åŸºç¡€ç±»å‹ å®šä¹‰ è§£é‡Š LUA_TNONE åˆ¤æ–­è¿™ä¸ªå˜é‡æ˜¯å¦ç­‰äºä¸ºç©ºä½¿ç”¨çš„ï¼Œluaå†…éƒ¨ä½¿ç”¨ï¼Œæ³¨æ„ä¸æ˜¯å’Œnilç±»å‹ä¸ç­‰ä»· LUA_TNIL å…¨å±€å˜é‡æ²¡è¢«å¤åˆ¶å°±æ˜¯nilç±»å‹ï¼Œåˆ é™¤å˜é‡ä¼šè¢«èµ‹","title":"luaæºç èµæ"},{"content":"å›¾è§£é‡Š ç»“æ„ä½“ typedef struct byteQueue_s { char*\tpBuffer;//æ•°æ® size_t\tnCapacity;//å®¹é‡ size_t\tnReadIndex;//è¯»æŒ‡é’ˆç´¢å¼• size_t\tnWriteIndex;//å†™æŒ‡é’ˆç´¢å¼• } byteQueue_tt; åˆå§‹ ç»“æ„ä½“ å‡è®¾è¦ç”³è¯·çš„ç©ºé—´ ç¯å½¢buffç»“æ„ä½“å¤§å°ä¸º8\nnWriteIndex å†™æŒ‡é’ˆç´¢å¼• nReadIndex è¯»æŒ‡é’ˆç´¢å¼• ç¯å½¢buffåˆå§‹åŒ–\nvoid byteQueue_init(byteQueue_tt* pByteQueue,size_t nCapacity = /* = 8*/) { pByteQueue-\u0026gt;nReadIndex = nCapacity;//è¯»æŒ‡é’ˆç´¢å¼•ä½ç½®è®¾ç½®ä¸º8,æ”¾åˆ°æœ«å°¾ pByteQueue-\u0026gt;nWriteIndex = 0;//å†™æŒ‡é’ˆç´¢å¼•ä½ç½®è®¾ç½®æˆ0ï¼Œæ”¾åˆ°å¼€å¤´ pByteQueue-\u0026gt;nCapacity = nCapacity;//å®¹é‡ if( nCapacity != 0 ) { pByteQueue-\u0026gt;pBuffer = mem_malloc(nCapacity);//ç”³è¯·ç©ºé—´ } else { pByteQueue-\u0026gt;pBuffer = NULL;//ç½®ç©º } } æ¸…ç©ºç»“æ„ä½“ void byteQueue_clear(byteQueue_tt* pByteQueue) { pByteQueue-\u0026gt;nReadIndex = 0;//è¯»æŒ‡é’ˆç´¢å¼•ä½ç½®è®¾ç½®ä¸º0,æ”¾åˆ°å¼€å¤´ pByteQueue-\u0026gt;nWriteIndex = 0;//å†™æŒ‡é’ˆç´¢å¼•ä½ç½®è®¾ç½®ä¸º0,æ”¾åˆ°å¼€å¤´ pByteQueue-\u0026gt;nCapacity = 0;//å®¹é‡è®¾ç½®ä¸º0 if(pByteQueue-\u0026gt;pBuffer) { mem_free(pByteQueue-\u0026gt;pBuffer);//å¦‚æœæœ‰æ•°æ®è¿›è¡Œé‡Šæ”¾ pByteQueue-\u0026gt;pBuffer = NULL;//å¹¶ä¸”ç½®ç©º } } è·å–å‰©ä½™å…¨éƒ¨å¯å†™ç©ºé—´ static inline size_t byteQueue_getBytesWritable(byteQueue_tt* pByteQueue) { if (pByteQueue-\u0026gt;nReadIndex \u0026gt;= pByteQueue-\u0026gt;nWriteIndex )//å†™æŒ‡é’ˆå’Œè¯»æŒ‡é’ˆé‡åˆï¼Œæˆ–è€…åœ¨è¯»æŒ‡é’ˆå‰é¢ { return pByteQueue-\u0026gt;nReadIndex - pByteQueue-\u0026gt;nWriteIndex;//ç›´æ¥è¯»æŒ‡é’ˆ - å†™æŒ‡é’ˆ å°±æ˜¯ å†™å…¥äº†å¤šå°‘å†…å®¹ } else//å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢ { return pByteQueue-\u0026gt;nReadIndex + (pByteQueue-\u0026gt;nCapacity - pByteQueue-\u0026gt;nWriteIndex); //è¯»æŒ‡é’ˆä½ç½® + (å®¹é‡ - å†™æŒ‡é’ˆä½ç½®) } } å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆå‰é¢[æ±‚å¾—æ˜¯è“è‰²å—æ•°æ®] å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢[æ±‚å¾—æ˜¯è“è‰²å—æ•°æ®] è·å–å‰©ä½™å…¨éƒ¨å¯è¯»ç©ºé—´ static inline size_t byteQueue_getBytesReadable(byteQueue_tt* pByteQueue) { if(pByteQueue-\u0026gt;nWriteIndex \u0026gt; pByteQueue-\u0026gt;nReadIndex) //è¯»æŒ‡é’ˆåœ¨å†™æŒ‡é’ˆå‰é¢ { return pByteQueue-\u0026gt;nWriteIndex - pByteQueue-\u0026gt;nReadIndex;//ç›´æ¥å†™æŒ‡é’ˆ - è¯»æŒ‡é’ˆ å°±æ˜¯å¯ä»¥è¯»å¤šå°‘æ•°æ® } else //è¯»æŒ‡é’ˆå’Œå†™æŒ‡é’ˆé‡åˆ,æˆ–è€…è¯»æŒ‡é’ˆåœ¨å†™æŒ‡é’ˆåé¢ { return pByteQueue-\u0026gt;nWriteIndex + (pByteQueue-\u0026gt;nCapacity - pByteQueue-\u0026gt;nReadIndex); //å†™æŒ‡é’ˆ + (å®¹é‡ - è¯»æŒ‡é’ˆä½ç½®) } } å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢[æ±‚çš„æ˜¯çº¢è‰²å—çš„æ•°æ®] å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆå‰é¢[æ±‚çš„æ˜¯çº¢è‰²å—çš„æ•°æ®] æŸ¥çœ‹è¿ç»­çš„å¯å†™ç©ºé—´ //æŸ¥çœ‹è¿ç»­çš„å¯å†™ç©ºé—´ //size_t* pWriteBytes èƒ½è¿ç»­å†™å…¥çš„å¤§å° static inline char* byteQueue_peekContiguousBytesWrite(byteQueue_tt* pByteQueue, size_t* pWriteBytes) { if (pByteQueue-\u0026gt;nReadIndex \u0026gt;= pByteQueue-\u0026gt;nWriteIndex)//è¯»æŒ‡é’ˆåœ¨å†™æŒ‡é’ˆåé¢ { *pWriteBytes = pByteQueue-\u0026gt;nReadIndex - pByteQueue-\u0026gt;nWriteIndex;//èƒ½è¿ç»­å†™å…¥çš„å¤§å° } else//è¯»æŒ‡é’ˆåœ¨å†™æŒ‡é’ˆå‰é¢ { *pWriteBytes = pByteQueue-\u0026gt;nCapacity - pByteQueue-\u0026gt;nWriteIndex;//èƒ½è¿ç»­å†™å…¥çš„å¤§å° } return pByteQueue-\u0026gt;pBuffer + pByteQueue-\u0026gt;nWriteIndex;//å¼€å§‹è¿ç»­å†™å…¥æŒ‡é’ˆçš„èµ·å§‹ä½ç½® } å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆå‰é¢[æ±‚å¾—è¿ç»­å¯å†™çš„ç©ºé—´] å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢[æ±‚å¾—è¿ç»­å¯å†™çš„ç©ºé—´] æŸ¥çœ‹è¿ç»­å¯è¯»ç©ºé—´ //æŸ¥çœ‹è¿ç»­çš„å¯è¯»ç©ºé—´ //size_t* pWriteBytes èƒ½è¿ç»­è¯»å–çš„å¤§å° static inline char* byteQueue_peekContiguousBytesRead(byteQueue_tt* pByteQueue, size_t* pReadBytes) { if(pByteQueue-\u0026gt;nWriteIndex \u0026gt; pByteQueue-\u0026gt;nReadIndex)//å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢ { *pReadBytes = pByteQueue-\u0026gt;nWriteIndex - pByteQueue-\u0026gt;nReadIndex;//èƒ½è¿ç»­è¯»å–çš„å¤§å° } else { *pReadBytes = pByteQueue-\u0026gt;nCapacity - pByteQueue-\u0026gt;nReadIndex;//èƒ½è¿ç»­è¯»å–çš„å¤§å° } return pByteQueue-\u0026gt;pBuffer + pByteQueue-\u0026gt;nReadIndex;//å¼€å§‹è¿ç»­è¯»å…¥æŒ‡é’ˆçš„èµ·å§‹ä½ç½® } å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆåé¢[æ±‚å¾—è¿ç»­å¯è¯»çš„ç©ºé—´] å†™æŒ‡é’ˆåœ¨è¯»æŒ‡é’ˆå‰é¢[æ±‚å¾—è¿ç»­å¯è¯»çš„ç©ºé—´] å†™å…¥ä¸€ä¸ªå­—ç¬¦[ç©ºé—´ä¸è¶³æŒ‰256çš„å€æ•°è‡ªåŠ¨æ‰©å±•] void byteQueue_writeChar(byteQueue_tt* pByteQueue, const char c) { if(pByteQueue-\u0026gt;nCapacity == 0) { //åˆå§‹åŒ–å®¹é‡,bufferå¤§å°ï¼Œå¯è¯»ç´¢å¼• pByteQueue-\u0026gt;nCapacity = 256;//åˆå§‹åŒ–å®¹é‡å¤§å°[256] pByteQueue-\u0026gt;pBuffer = mem_malloc(pByteQueue-\u0026gt;nCapacity);//ç”³è¯·ç©ºé—´ pByteQueue-\u0026gt;nReadIndex = pByteQueue-\u0026gt;nCapacity;//åˆå§‹åŒ–è¯»ç´¢å¼•ä½ç½® } else { size_t nBytesWritable = byteQueue_getBytesWritable(pByteQueue);//è·å–è·å–å‰©ä½™å…¨éƒ¨å¯å†™ç©ºé—´ if (1 \u0026gt; nBytesWritable) { //align_size å°†sizeæŒ‰alignå¤§å°æ•´æ•°å€æå‡,ç”¨äºå†…å­˜å¯¹é½ size_t nNewCapacity = align_size( (pByteQueue-\u0026gt;nCapacity \u0026lt;\u0026lt; 1) + 1,256); char* pBuffer = mem_malloc(nNewCapacity); if(pByteQueue-\u0026gt;nReadIndex != pByteQueue-\u0026gt;nCapacity)//è¯´æ˜è¿˜æœ‰æ•°æ®æ²¡æœ‰è¯»èµ° { size_t nWritten = byteQueue_getBytesReadable(pByteQueue);//è·å–å‰©ä½™å…¨éƒ¨å¯è¯»çš„ç©ºé—´ size_t nReadBytes = 0;//è¿ç»­å¯è¯»çš„ç©ºé—´çš„å¤§å° char* pRead = byteQueue_peekContiguousBytesRead(pByteQueue, \u0026amp;nReadBytes);//å¼€å§‹è¯»å–æ•°æ®çš„èµ·å§‹ä½ç½® memcpy(pBuffer,pRead,nReadBytes);//ç›´æ¥æ‹·è´ if( nReadBytes != nWritten )//å¦‚æœè¿ç»­å¯è¯»çš„ç©ºé—´çš„å¤§å°!=å‰©ä½™å…¨éƒ¨å¯è¯»çš„ç©ºé—´ { memcpy(pBuffer+ nReadBytes,pByteQueue-\u0026gt;pBuffer,nWritten - nReadBytes);//æŠŠå‰©ä¸‹çš„å¯è¯»çš„ç©ºé—´å†™å…¥æ–°bufferç©ºé—´ } pByteQueue-\u0026gt;nReadIndex = 0;//åˆ°äº†æ–°ç©ºé—´éœ€è¦é‡æ–°ç§»åŠ¨è¯»æŒ‡é’ˆ pByteQueue-\u0026gt;nWriteIndex = nWritten;//åˆ°äº†æ–°ç©ºé—´éœ€è¦é‡æ–°ç§»åŠ¨å†™æŒ‡é’ˆ } else //æ²¡æœ‰æ•°æ®éœ€è¦è¯»å–ç›´æ¥åˆå§‹åŒ–æŒ‡é’ˆä½ç½® { pByteQueue-\u0026gt;nReadIndex = nNewCapacity; pByteQueue-\u0026gt;nWriteIndex = 0; } pByteQueue-\u0026gt;nCapacity = nNewCapacity; mem_free(pByteQueue-\u0026gt;pBuffer); pByteQueue-\u0026gt;pBuffer = pBuffer; } } pByteQueue-\u0026gt;pBuffer[pByteQueue-\u0026gt;nWriteIndex] = c;//èµ‹å€¼ pByteQueue-\u0026gt;nWriteIndex = (pByteQueue-\u0026gt;nWriteIndex + 1) % pByteQueue-\u0026gt;nCapacity;//ç´¢å¼•ä½ç§»ä¸€ä½ if (pByteQueue-\u0026gt;nReadIndex == pByteQueue-\u0026gt;nCapacity)//å¦‚æœè¯»ç´¢å¼•åœ¨å°¾éƒ¨ { pByteQueue-\u0026gt;nReadIndex = 0;//æŠŠè¯»ç´¢å¼•æ”¾åˆ°å¤´éƒ¨ } } å†™å…¥æŒ‡å®šå¤§å°ç©ºé—´çš„æ•°æ®[ç©ºé—´ä¸è¶³æŒ‰256çš„å€æ•°è‡ªåŠ¨æ‰©å±•] void byteQueue_write(byteQueue_tt* pByteQueue, const void* pInBytes, size_t nLength) { assert(nLength != 0); if(pByteQueue-\u0026gt;nCapacity == 0)//å®¹é‡å¤§å°ä¸º0 { pByteQueue-\u0026gt;nCapacity = align_size(nLength,256);//åˆå§‹åŒ–å®¹é‡å¤§å°[256çš„å€æ•°] pByteQueue-\u0026gt;pBuffer = mem_malloc(pByteQueue-\u0026gt;nCapacity);//ç”³è¯·ç©ºé—´ pByteQueue-\u0026gt;nReadIndex = pByteQueue-\u0026gt;nCapacity;//åˆå§‹åŒ–è¯»ç´¢å¼•ä½ç½® } else { size_t nBytesWritable = byteQueue_getBytesWritable(pByteQueue);//è·å–å‰©ä½™å¯å†™ç©ºé—´ if (nLength \u0026gt; nBytesWritable)//å¦‚æœå†™å…¥çš„å¤§å°å¤§äºå‰©ä½™å¯å†™ç©ºé—´ { //æ•°æ®è¿›è¡Œæ‰©å±• size_t nNewCapacity = align_size( (pByteQueue-\u0026gt;nCapacity \u0026lt;\u0026lt; 1) + (nLength-nBytesWritable),256); char* pBuffer = mem_malloc(nNewCapacity);//ç”³è¯·ç©ºé—´å¤§å° if(pByteQueue-\u0026gt;nReadIndex != pByteQueue-\u0026gt;nCapacity )//è¿˜æœ‰æ•°æ®å¯è¯» { size_t nWritten = byteQueue_getBytesReadable(pByteQueue);//å‰©ä½™å…¨éƒ¨å¯è¯»ç©ºé—´ size_t nReadBytes = 0;//è¿ç»­å¯è¯»çš„ç©ºé—´å¤§å° char* pRead = byteQueue_peekContiguousBytesRead(pByteQueue, \u0026amp;nReadBytes);//å¼€å§‹è¿ç»­è¯»å…¥æŒ‡é’ˆçš„èµ·å§‹ä½ç½® memcpy(pBuffer,pRead,nReadBytes);//æŠŠè¿ç»­å¯è¯»çš„ç©ºé—´å†™å…¥æ–°bufferç©ºé—´ if( nReadBytes != nWritten )//å¦‚æœè¿ç»­å¯è¯»çš„ç©ºé—´!=å‰©ä½™å…¨éƒ¨å¯è¯»ç©ºé—´ { memcpy(pBuffer + nReadBytes,pByteQueue-\u0026gt;pBuffer,nWritten - nReadBytes);//æŠŠå‰©ä¸‹çš„å¯è¯»çš„ç©ºé—´å†™å…¥æ–°bufferç©ºé—´ } pByteQueue-\u0026gt;nReadIndex = 0;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = nWritten;//é‡ç½®å†™ç´¢å¼• } else { pByteQueue-\u0026gt;nReadIndex = nNewCapacity;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = 0;//é‡ç½®å†™ç´¢å¼• } pByteQueue-\u0026gt;nCapacity = nNewCapacity;////é‡ç½®å®¹é‡å¤§å° mem_free(pByteQueue-\u0026gt;pBuffer);//é‡Šæ”¾æ—§buffç©ºé—´ pByteQueue-\u0026gt;pBuffer = pBuffer;//é‡ç½®æŒ‡é’ˆåˆ°æ–°buffç©ºé—´ } } size_t nWriteBytes = 0;//è¿ç»­å¯å†™çš„ç©ºé—´å¤§å° char* pWrite = byteQueue_peekContiguousBytesWrite(pByteQueue,\u0026amp;nWriteBytes);//å¼€å§‹å†™å…¥çš„æŒ‡é’ˆä½ç½® if (nWriteBytes \u0026gt;= nLength)//å¦‚æœè¿ç»­å†™å…¥çš„ç©ºé—´èƒ½å¤Ÿæ»¡è¶³éœ€è¦å†™å…¥çš„ç©ºé—´å¤§å° { memcpy(pWrite, pInBytes, nLength);//ç›´æ¥æ‹·è´ } else { memcpy(pWrite, pInBytes, nWriteBytes);//å…ˆæ‹·è´è¿ç»­å¯å†™å…¥çš„ç©ºé—´å¤§å° memcpy(pByteQueue-\u0026gt;pBuffer, (const char*)pInBytes + nWriteBytes, nLength - nWriteBytes);//å†æŠŠå‰©ä½™è¦å†™å…¥çš„å¤§å°ç©ºé—´å†™å…¥ } pByteQueue-\u0026gt;nWriteIndex = (pByteQueue-\u0026gt;nWriteIndex + nLength) % pByteQueue-\u0026gt;nCapacity;//é‡ç½®è¯»ç´¢å¼• if (pByteQueue-\u0026gt;nReadIndex == pByteQueue-\u0026gt;nCapacity) { pByteQueue-\u0026gt;nReadIndex = 0;//é‡ç½®å†™ç´¢å¼• } } å†™å…¥æŒ‡å®šå¤§å°ç©ºé—´çš„æ•°æ®[ç©ºé—´ä¸è¶³æŒ‰å‰©ä½™éœ€è¦ç©ºé—´å¤§å°ç”³è¯·] void byteQueue_writeBytes(byteQueue_tt* pByteQueue, const void* pInBytes, size_t nLength) { assert(nLength != 0); if(pByteQueue-\u0026gt;nCapacity == 0)//å®¹é‡å¤§å°ä¸º0 { pByteQueue-\u0026gt;nCapacity = nLength;//åˆå§‹åŒ–å®¹é‡å¤§å°[éœ€è¦ç©ºé—´å¤§å°] pByteQueue-\u0026gt;pBuffer = mem_malloc(pByteQueue-\u0026gt;nCapacity);//ç”³è¯·ç©ºé—´ pByteQueue-\u0026gt;nReadIndex = pByteQueue-\u0026gt;nCapacity;//åˆå§‹åŒ–è¯»ç´¢å¼•ä½ç½® } else { size_t nBytesWritable = byteQueue_getBytesWritable(pByteQueue);//å‰©ä½™å¯å†™çš„å…¨éƒ¨ç©ºé—´å¤§å° if (nLength \u0026gt; nBytesWritable)//å¦‚æœå†™å…¥çš„å¤§å°å¤§äºå‰©ä½™å¯å†™å…¥çš„ç©ºé—´å¤§å° { size_t nNewCapacity = pByteQueue-\u0026gt;nCapacity + (nLength - nBytesWritable);//å¼€è¾Ÿæ­£å¥½å¤§å°çš„ç©ºé—´ char* pBuffer = mem_malloc(nNewCapacity);//ç”³è¯·ç©ºé—´ if(pByteQueue-\u0026gt;nReadIndex != pByteQueue-\u0026gt;nCapacity)//è¿˜æœ‰ç©ºé—´å¯è¯»éœ€è¦æŠŠè¿™æ®µç©ºé—´èµ‹å€¼åˆ°æ–°ç©ºé—´ { size_t nWritten = byteQueue_getBytesReadable(pByteQueue);//å‰©ä½™å¯è¯»çš„å…¨éƒ¨ç©ºé—´ size_t nReadBytes = 0;//è¿ç»­å¯è¯»çš„ç©ºé—´ char* pRead = byteQueue_peekContiguousBytesRead(pByteQueue, \u0026amp;nReadBytes);//å¼€å§‹è¯»å–ç©ºé—´çš„èµ·å§‹ä½ç½® memcpy(pBuffer,pRead,nReadBytes);//æ‹·è´åˆ°æ–°ç©ºé—´ if( nReadBytes != nWritten )//è¿ç»­å¯è¯»çš„ç©ºé—´!=å‰©ä½™å¯è¯»çš„å…¨éƒ¨ç©ºé—´ { memcpy(pBuffer+ nReadBytes,pByteQueue-\u0026gt;pBuffer,nWritten - nReadBytes);//æ‹·è´å‰©ä½™æ•°æ®åˆ°æ–°ç©ºé—´ } pByteQueue-\u0026gt;nReadIndex = 0;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = nWritten;//é‡ç½®å†™ç´¢å¼• } else { pByteQueue-\u0026gt;nReadIndex = nNewCapacity;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = 0;//é‡ç½®å†™ç´¢å¼• } pByteQueue-\u0026gt;nCapacity = nNewCapacity;//é‡ç½®å®¹é‡ mem_free(pByteQueue-\u0026gt;pBuffer);//é‡Šæ”¾æ—§ç©ºé—´ pByteQueue-\u0026gt;pBuffer = pBuffer;//æ–°ç©ºé—´æŒ‡é’ˆæŒ‡å‘æ—§ç©ºé—´æŒ‡é’ˆ } } size_t nWriteBytes = 0;//è¿ç»­å¯å†™å…¥ç©ºé—´å¤§å° char* pWrite = byteQueue_peekContiguousBytesWrite(pByteQueue,\u0026amp;nWriteBytes);//å¯å†™å…¥å¼€å§‹æŒ‡é’ˆ if (nWriteBytes \u0026gt;= nLength)//å®¹é‡è¶³å¤Ÿ { memcpy(pWrite, pInBytes, nLength);//ç›´æ¥æ‹·è´ } else { memcpy(pWrite, pInBytes, nWriteBytes);//å…ˆæ‹·è´è¿ç»­å¯å†™å…¥ç©ºé—´å¤§å° memcpy(pByteQueue-\u0026gt;pBuffer, (const char*)pInBytes + nWriteBytes, nLength - nWriteBytes);//å‰©ä½™çš„åœ¨ç›´æ¥æ‹·è´ } pByteQueue-\u0026gt;nWriteIndex = (pByteQueue-\u0026gt;nWriteIndex + nLength) % pByteQueue-\u0026gt;nCapacity;//é‡ç½®å†™ç´¢å¼• if (pByteQueue-\u0026gt;nReadIndex == pByteQueue-\u0026gt;nCapacity) { pByteQueue-\u0026gt;nReadIndex = 0;//é‡ç½®è¯»ç´¢å¼• } } è¯»å–æ•°æ® bool byteQueue_readBytes(byteQueue_tt* pByteQueue, void* pOutBytes, size_t nMaxLengthToRead, bool bPeek /*= false*/ ) { size_t nBytesWritten = byteQueue_getBytesReadable(pByteQueue);//å¯è¯»çš„ç©ºé—´å¤§å° size_t nBytesToRead = nBytesWritten \u0026lt; nMaxLengthToRead ? nBytesWritten : nMaxLengthToRead;//å¾—åˆ°å¯è¯»å–çš„å¤§å° if (nBytesToRead == 0) { return false; } size_t nReadBytes = 0;//è¿ç»­å¯è¯»çš„å¤§å° char* pRead = byteQueue_peekContiguousBytesRead(pByteQueue, \u0026amp;nReadBytes);//è¿ç»­å¯è¯»ç©ºé—´å¤§å°çš„èµ·å§‹ç´¢å¼• if( nReadBytes \u0026gt;= nBytesToRead )//æ»¡è¶³å¯è¯»å¤§å°éœ€æ±‚ { memcpy(pOutBytes,pRead,nBytesToRead);//ç›´æ¥è¯»å– } else { memcpy(pOutBytes,pRead,nReadBytes);//ç›´æ¥è¿ç»­å¯è¯»çš„ç©ºé—´å¤§å° memcpy((char*)pOutBytes+nReadBytes,pByteQueue-\u0026gt;pBuffer,nBytesToRead-nReadBytes);//è¯»å–å‰©ä½™éœ€è¦è¯»å–çš„å¤§å° } if (!bPeek)//ä¸æ˜¯æ¢æµ‹ byteQueue_readOffset(pByteQueue,nBytesToRead);//ç›´æ¥ç§»åŠ¨æŒ‡é’ˆ return true; } é‡ç½®å®¹é‡ void byteQueue_reserve(byteQueue_tt* pByteQueue, size_t nCapacity) { size_t nWritten = byteQueue_getBytesReadable(pByteQueue);//å‰©ä½™å…¨éƒ¨å¯è¯»å¤§å° if(nWritten \u0026gt; nCapacity)//å¦‚æœå…¨éƒ¨å¯è¯»çš„å¤§å°å¤§äºè¦é‡ç½®çš„å®¹é‡å¤§å° { return; } if(pByteQueue-\u0026gt;nReadIndex != pByteQueue-\u0026gt;nCapacity)//æœ‰å‰©ä½™éœ€è¦è¯»å–çš„ç©ºé—´æ•°æ® { char* pBuffer = mem_malloc(nCapacity);//ç”³è¯·æ–°çš„é‡ç½®ç©ºé—´å¤§å° size_t nReadBytes = 0;//è¿ç»­å¯è¯»çš„ç©ºé—´å¤§å° char* pRead = byteQueue_peekContiguousBytesRead(pByteQueue, \u0026amp;nReadBytes);//è¿ç»­å¯è¯»ç©ºé—´å¤§å°çš„èµ·å§‹ä½ç½® memcpy(pBuffer,pRead,nReadBytes);//ç›´æ¥æ‹·è´ if( nReadBytes != nWritten )//è¿˜æœ‰å‰©ä½™è¦æ‹·è´çš„ç©ºé—´ { memcpy(pBuffer + nReadBytes,pByteQueue-\u0026gt;pBuffer,nWritten - nReadBytes);//æ‹·è´å‰©ä½™è¦æ‹·è´çš„æ•°æ® } pByteQueue-\u0026gt;nReadIndex = 0;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = nWritten;//é‡ç½®å†™ç´¢å¼• mem_free(pByteQueue-\u0026gt;pBuffer);//é‡Šæ”¾æ—§ç©ºé—´ pByteQueue-\u0026gt;pBuffer = pBuffer;//æ–°ç©ºé—´çš„æŒ‡é’ˆæŒ‡å‘æ—§ç©ºé—´æŒ‡é’ˆ } else { pByteQueue-\u0026gt;pBuffer = mem_realloc(pByteQueue-\u0026gt;pBuffer,nCapacity);//ç›´æ¥æŒ‡å‘ç”³è¯·ç©ºé—´çš„å¤§å° pByteQueue-\u0026gt;nReadIndex = nCapacity;//é‡ç½®è¯»ç´¢å¼• pByteQueue-\u0026gt;nWriteIndex = 0;//é‡ç½®å†™ç´¢å¼• } pByteQueue-\u0026gt;nCapacity = nCapacity;//é‡ç½®å®¹é‡ } ","permalink":"https://frog-game.github.io/posts/blog/ringbuff/","summary":"å›¾è§£é‡Š ç»“æ„ä½“ typedef struct byteQueue_s { char* pBuffer;//æ•°æ® size_t nCapacity;//å®¹é‡ size_t nReadIndex;//è¯»æŒ‡é’ˆç´¢å¼• size_t nWriteIndex;","title":"ç¯å½¢buff"},{"content":"linuxç¼–è¯‘ make linux MALLOC_STATICLIB= SKYNET_DEFINES=-DNOUSE_JEMALLOC ç½‘ç»œæµç¨‹å›¾ workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ— æ¯ä¸ªåœ¨çº¿å®¢æˆ·ç«¯åœ¨SkynetæœåŠ¡å™¨ä¸Šéƒ½å¯¹åº”æœ‰ä¸€ä¸ªSocketä¸å…¶è¿æ¥ï¼Œä¸€ä¸ªSocketåœ¨Skynetå†…éƒ¨å¯¹åº”ä¸€ä¸ªLuaè™šæ‹Ÿæœºå’Œä¸€ä¸ªå®¢æˆ·ç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—per client mqã€‚å½“å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯æ—¶ï¼Œè¯¥é˜Ÿåˆ—ä¼šæŒ‚è½½åˆ°å…¨å±€é˜Ÿåˆ—global message queueä¸Šä¾›å·¥ä½œçº¿ç¨‹worker Threadsè¿›è¡Œè°ƒåº¦å¤„ç†ã€‚\nä¸€ä¸ªSocketçº¿ç¨‹socket threadä¼šè½®è¯¢æ‰€æœ‰çš„Socketï¼Œå½“æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åå°†è¯·æ±‚æ‰“åŒ…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘é€åˆ°è¯¥Socketå¯¹åº”çš„å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—per client mqä¸­ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯é˜Ÿåˆ—æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚\nå¤šä¸ªWorkerå·¥ä½œçº¿ç¨‹worker threadsä»å…¨å±€é˜Ÿåˆ—å¤´éƒ¨è·å–å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»å®¢æˆ·ç‰¹å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæ¯•åå†å°†æ¶ˆæ¯é˜Ÿåˆ—é‡æ–°æŒ‚åˆ°å…¨å±€é˜Ÿåˆ—é˜Ÿå°¾ã€‚\nskynetä¸­ä¸åŒæœåŠ¡æ˜¯åˆ©ç”¨ç³»ç»Ÿçš„å¤šçº¿ç¨‹å®Œå…¨å¹¶è¡Œçš„ï¼Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bå’ŒæœåŠ¡Cåˆ†åˆ«å„è‡ªå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå¹¶ä¸èƒ½ä¿è¯å…ˆå‘çš„æ¶ˆæ¯å…ˆè¢«å¤„ç†ã€‚è€Œå½“ä½ ä»æœåŠ¡Aå‘æœåŠ¡Bä¾æ¬¡å‘é€ä¸¤æ¡æ¶ˆæ¯æ—¶ï¼Œå…ˆå‘çš„æ¶ˆæ¯ä¸€å®šä¼šè¢«æœåŠ¡Bå…ˆå¤„ç†ã€‚\nä½¿ç”¨Luaå®ç°çš„æœåŠ¡åªæ˜¯ä¸€ä¸ªå†…åµŒäº†Luaè™šæ‹Ÿæœºçš„æœåŠ¡ï¼Œä¹Ÿéµå®ˆä¸Šé¢çš„è§„åˆ™ã€‚å¦‚æœæœåŠ¡Bæ˜¯ä¸€ä¸ªLuaæœåŠ¡ï¼Œå½“æœåŠ¡Aå‘æœåŠ¡Bå‘é€ä¸¤æ¡æ¶ˆæ¯xå’Œyæ—¶ï¼ŒSkynetä¸€å®šä¿è¯xå…ˆè¢«æœåŠ¡Bä¸­çš„Luaè™šæ‹Ÿæœºæ¥æ”¶åˆ°ï¼Œå¹¶ä¸ºæ¶ˆæ¯xç”Ÿæˆè¦ç»™åç¨‹Xï¼Œå¹¶è¿è¡Œè¿™ä¸ªåç¨‹ã€‚ç„¶åæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯yï¼Œå¹¶é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„åç¨‹Yå¹¶è¿è¡Œã€‚\nåŒæ­¥é—®é¢˜ åŒæ­¥ä¹Ÿæ˜¯skynetå­˜åœ¨çš„é—®é¢˜ï¼Œå½“ä¸€ä¸ªæœåŠ¡callå…¶ä»–æœåŠ¡æ—¶ï¼Œå½“å‰åç¨‹ä¼šæŒ‚èµ·ï¼Œä½†æ˜¯è¿™ä¸ªæœåŠ¡è¿˜å¯ä»¥æ¥å—å¹¶å¤„ç†å…¶ä»–æ¶ˆæ¯ã€‚å¦‚æœå¤šä¸ªåç¨‹æ”¹åˆ°åŒä¸€ä¸ªæ•°æ®ï¼Œä½ ä¸åšåŒæ­¥å¤„ç†å°±æ— æ³•ç¡®å®šè¿™ä¸ªæ•°æ®ä¼šæ˜¯å¤šå°‘ã€‚\nè¿™æ ·çš„ä¾‹å­ç‰¹åˆ«å¸¸è§ï¼Œæ¯”å¦‚ï¼ŒæœåŠ¡æ­£å½“å¤„ç†ç©å®¶loginè¯·æ±‚ï¼Œåˆšå¥½é‡åˆ°callæŒ‚èµ·ï¼Œè¿™æ—¶å€™åˆæœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œæ¯”å¦‚logoutï¼ŒæœåŠ¡å°±ä¼šè½¬å»å¤„ç†logoutæ¶ˆæ¯ã€‚é‚£ç©å®¶ç©¶ç«Ÿæ˜¯loginï¼Œè¿˜æ˜¯logoutï¼Ÿ\nå½“ç„¶ï¼ŒåŒæ­¥é—®é¢˜ä¹Ÿå®¹æ˜“è§£å†³ï¼ŒåŠ å¤šä¸€ä¸ªstateçš„æ ‡è¯†å’Œä¸€ä¸ªåç¨‹åˆ—è¡¨ï¼Œæ“ä½œæ‰§è¡Œæ—¶ï¼Œå°†stateç½®doingï¼Œå…¶ä»–åç¨‹åˆ¤æ–­state=doingæ—¶å°±å°†è‡ªå·±åŠ åˆ°åç¨‹åˆ—è¡¨ï¼Œç„¶å skynet.waitã€‚åœ¨æ“ä½œæ‰§è¡Œå®Œåï¼Œé‡ç½®stateï¼Œç„¶åéå†åç¨‹åˆ—è¡¨ä¾æ¬¡ skynet.wakeup(co) ï¼Œæœ€åå°†åç¨‹åˆ—è¡¨ç½®ç©ºã€‚\nè§£é‡Šæ­¤é˜Ÿåˆ— çº¢é»‘æ ‘ä¸Šçš„èŠ‚ç‚¹æ˜¯æ‰€æœ‰ç›‘å¬çš„socket é»„è‰²åº•çš„æ˜¯interesting é˜Ÿåˆ— è“è‰²åº•æ˜¯é»„è‰²åº•çš„å­é˜Ÿåˆ— ä¹Ÿå°±æ˜¯å°±ç»ªé˜Ÿåˆ— epoll_ctrl() æ‰§è¡Œå¢åŠ æ“ä½œæ—¶å€™å°±æ˜¯å¾€interestingé˜Ÿåˆ—å¡socket å½“æœ‰è¯»å†™äº‹ä»¶æ—¶å€™ï¼Œå°±ä¼šå¾€è“è‰²åº•é˜Ÿåˆ—æ”¾å…¥socketä¹Ÿå°±æ˜¯å¡å…¥å°±ç»ªé˜Ÿåˆ— é€šè¿‡epoll_wait()æŠŠå°±ç»ªé˜Ÿåˆ—çš„ä¸œè¥¿è¿”å›å‡ºæ¥\nçº¿ç¨‹ç±»å‹ socket thread : çº¿ç¨‹è¿›ç¨‹æ¶ˆæ¯æ”¶å‘\nmonitor thread : çº¿ç¨‹ç›‘æ§æœåŠ¡æ˜¯ä¸æ˜¯é™·å…¥æ­»å¾ªç¯ï¼Œæ¶ˆæ¯æ˜¯å¦å µä½\ntime thread : çº¿ç¨‹ä¸»è¦ç”¨äºå®ç°skynetçš„å®šæ—¶å™¨\nwork thread çº¿ç¨‹ å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè°ƒåº¦\næ¶ˆæ¯æµè½¬ å…ˆä»å…¨å±€é˜Ÿåˆ—popä¸€ä¸ªæ¬¡çº§é˜Ÿåˆ—ï¼Œç„¶åä»æ¬¡çº§é˜Ÿåˆ—popä¸€ä¸ªæ¶ˆæ¯è°ƒç”¨å›è°ƒå‡½æ•°è¿›è¡Œé€»è¾‘å¤„ç† ç”¨å®Œä»¥åå¦‚æœæ¬¡çº§é˜Ÿåˆ—ä¸ä¸ºç©ºæˆ–è€…å µå¡ï¼Œç»§ç»­æŠŠæ¬¡çº§é˜Ÿåˆ—æ”¾å…¥å…¨å±€é˜Ÿåˆ— å¯åŠ¨æµç¨‹ åŠ è½½é…ç½®æ–‡ä»¶\né…ç½®æ–‡ä»¶å­˜å…¥luaçš„å…¨å±€å˜é‡env\nåˆ›å»ºå’Œå¯åŠ¨cæœåŠ¡logger\nå¯åŠ¨å¼•å¯¼æ¨¡å—å¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªluaæœåŠ¡(bootstrap)\nç„¶ååœ¨é€šè¿‡bootstrapé…ç½®å»å¯åŠ¨å…¶ä»–çš„å¾®æœåŠ¡\ncluster ä¸¤æ¡tcpé€šé“æ€»ç»“ å‰æ ä¸¤ç«¯æ˜¯ä¸¥æ ¼åˆ†ä¸ºè¯·æ±‚æ–¹å’Œå›åº”æ–¹ã€‚æ¯”å¦‚ A---\u0026gt; B ï¼Œé‚£ä¹ˆåªèƒ½æ˜¯Aå‘Bæå‡ºè¯·æ±‚ï¼ŒB å›åº”å®ƒï¼›å¦‚æœ B-----\u0026gt;\u0026gt;A éœ€è¦ç”± B å‘ A å†å»ºç«‹ä¸€æ¡é€šé“ã€‚\nTCPç‰¹æ€§ä½¿å¾—æ¯ä¸ªTCPè¿æ¥å¯ä»¥å¾—åˆ°å‡ç­‰çš„å¸¦å®½ã€‚åœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰è¶Šå¤šTCPè¿æ¥ï¼Œè·å¾—çš„å¸¦å®½è¶Šå¤§\n1æ¡è¿æ¥ ä¼˜ç‚¹ï¼šé“¾æ¥å°‘ï¼Œå¯¹äºæ²¡æœ‰æ¥è§¦è¿‡skynetï¼Œä¼ ç»ŸæœåŠ¡å™¨äººå¾ˆå®¹æ˜“è¿™ç§æ–¹å¼è¿æ¥æ–¹å¼ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¾ˆå¤šéƒ½æ˜¯csç»“æ„ç¨‹åºå‘˜è¿‡æ¥çš„ **ç¼ºç‚¹ï¼š**å¦‚æœæ–­äº†ï¼Œæ•°æ®å°±æ— æ³•ä¼ è¾“ï¼Œå¾—é‡æ–°å»ºç«‹æ–°çš„è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œéœ€è¦æ¸…æ¥šé‚£è¾¹æ˜¯å‘é€æ–¹ï¼Œé‚£è¾¹æ˜¯æ¥å—æ–¹\n2æ¡è¿æ¥ **ä¼˜ç‚¹ï¼š**åœ¨å‰é¢å‰æçš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸¤æ¡è¿æ¥ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘ç¨‹åºå‘˜ä¸éœ€è¦å…³å¿ƒæˆ‘è¿™ä¸ªæ—¶å€™æ˜¯clientï¼Œè¿˜æ˜¯serverï¼Œåªéœ€è¦é€šè¿‡cluster.callï¼Œcluster.sendï¼Œæ¥å£ç›´æ¥å¾€é‡Œé¢å¡æ•°æ®å°±è¡Œäº†ï¼Œå¤šæ¡è¿æ¥ä¹Ÿä¾¿äºæŠ¢å¸¦å®½ **ç¼ºç‚¹:**å¤šäº†ä¸€æ¡è¿æ¥ï¼Œå¯¹csç»“æ„è¿‡æ¥çš„ç¨‹åºå‘˜ä¸å¤ªå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆå¼„æœ‰å¥½å¤„ï¼Œæˆ–è€…æ˜¯ä¸çŸ¥é“æœ‰å‰é¢é‚£ä¸ªå‰æ ä¸ºä»€ä¹ˆä¸åœ¨å¼€è¾Ÿæ›´å¤šçš„è¿æ¥ï¼Œå› ä¸ºå¼€è¾Ÿæ›´å¤šçš„é“¾æ¥æ„ä¹‰ä¸å¤§ï¼Œå¦‚æœè¿™å°æœºå™¨ä¸Šå¼„äº†ä¸å°‘è¿›ç¨‹ï¼Œè¿æ¥æ•°å’Œæœºå™¨çš„é…ç½®ä¹Ÿæ˜¯æœ‰å…³ç³»çš„ï¼Œå¤šäº†ï¼Œå¦‚æœç”¨ä¸ä¸Šä¹Ÿæ˜¯ä¸€ç§æµªè´¹ï¼ŒåŒæ—¶å¯¹äºä¸šåŠ¡ç¨‹åºå‘˜æ¥è¯´ä¹Ÿé€»è¾‘æ··ä¹±ï¼Œ å› ä¸ºå‡å¦‚æ˜¯4æ¡ï¼Œé‚£ä¹ˆæ¥å—æ–¹è¿˜å¾—åŒºåˆ†æ˜¯é‚£æ¡å‘è¿‡æ¥çš„æ•°æ®\nmaster / slave ç»„ç½‘è¿‡ç¨‹ slave3å‘é€syncç»™masterï¼Œå¹¶å¯åŠ¨è‡ªå·±çš„listen masteræ”¶åˆ°ä¿¡æ¯ç»™å·²ç»è¿æ¥ä¸Šçš„slave1ï¼Œslave2å‘é€slave3è¯·æ±‚è¿æ¥çš„æƒ…å†µ masterç»™slave3å‘é€å½“å‰å·²ç»è¿æ¥ä¸Šçš„slaveæ•°é‡ï¼Œå¹¶æŠŠslave3åŠ å…¥èŠ‚ç‚¹ç»„ slave1ï¼Œslave3æ¥æ”¶åˆ°masterå‘é€çš„ä¿¡æ¯åï¼Œè°ƒç”¨connectå»è¿æ¥slave3 master /slave æ–­ç½‘è¿‡ç¨‹ masteræ£€æµ‹åˆ°slave3å¤±å»è¿æ¥ï¼ŒæŠŠslave3è¿æ¥fdç½®æˆ0 masteræŠŠå¤±å»è¿æ¥çš„slave3 id å¹¿æ’­ç»™slave1ï¼Œslave2 slave1ï¼Œslave2å¾—åˆ°slave3 idä¹‹åå’Œslave3æ–­å¼€è¿æ¥ harbor æœåŠ¡ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªharboridï¼Œåœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªharboridæ”¾åˆ°æ¶ˆæ¯idçš„\né«˜8ä½ï¼Œæ‰€ä»¥é€šè¿‡é«˜8ä½çš„å¯¹æ¯”å°±çŸ¥é“è¿™ä¸ªæ¶ˆæ¯æ˜¯è¿œç¨‹æ¶ˆæ¯ï¼Œè¿˜æ˜¯æœ¬åœ°æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯è¿œç¨‹æ¶ˆæ¯\né€šè¿‡harborå’Œè¿œç¨‹çš„harborå»ºç«‹tcpè¿æ¥å‘é€æ•°æ®è¿‡å»ï¼Œå¦‚æœæ˜¯æœ¬åœ°ç›´æ¥æ”¾å…¥æœ¬åœ°èŠ‚ç‚¹å¤„ç†é€»è¾‘\næ¶ˆæ¯å¤„ç†æ–¹å¼ skeynet.send éå µå¡ä¸éœ€è¦åº”ç­” skynet.call å µå¡éœ€è¦åº”ç­” skynet.ret å›åº”æ¶ˆæ¯ skynet.response è¯·æ±‚å’Œç›¸åº”åœ¨ä¸ç”¨åç¨‹å¤„ç† skynet.queue ä¸²è¡ŒåŒ–æ¶ˆæ¯æ‰§è¡Œ é” äº’æ–¥é” é€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´\u0026gt;çº¿ç¨‹åˆ‡æ¢æ—¶é—´åœºæ™¯ å¾—åˆ°é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’å¤„ç†é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€\näº’æ–¥é”åŠ é”å¤±è´¥ä»¥åï¼Œä¼šä»ç”¨æˆ·æ€å˜æˆå†…æ ¸æ€ï¼Œçº¿ç¨‹å°±ä¼šé‡Šæ”¾CPU ç»™å…¶ä»–çº¿ç¨‹,ä¼šæœ‰ä¸¤æ¬¡çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æˆæœ¬\nçº¿ç¨‹åŠ é”å¤±è´¥æ—¶ï¼Œå†…æ ¸ä¼šæŠŠçº¿ç¨‹çš„çŠ¶æ€ä»ã€Œè¿è¡Œã€çŠ¶æ€è®¾ç½®ä¸ºã€Œç¡çœ ã€çŠ¶æ€ï¼Œç„¶åæŠŠ CPU åˆ‡æ¢ç»™å…¶ä»–çº¿ç¨‹è¿è¡Œ æ¥ç€ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œä¹‹å‰ã€Œç¡çœ ã€çŠ¶æ€çš„çº¿ç¨‹ä¼šå˜ä¸ºã€Œå°±ç»ªã€çŠ¶æ€ï¼Œç„¶åå†…æ ¸ä¼šåœ¨åˆé€‚çš„æ—¶é—´ï¼ŒæŠŠ CPU åˆ‡æ¢ç»™è¯¥çº¿ç¨‹è¿è¡Œã€‚ ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ï¼Œå¤§æ¦‚åœ¨å‡ åçº³ç§’åˆ°å‡ å¾®å¦™ä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœä½ èƒ½ç¡®è®¤ä½ è¢«é”ä½çš„ä»£ç æ—¶é—´å¾ˆçŸ­ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥ç”¨äº’æ–¥é”ï¼Œè€Œåº”è¯¥ç”¨è‡ªæ—‹é”\nè‡ªæ—‹é” æ²¡æœ‰è·å–åˆ°æƒé™çš„çš„çº¿ç¨‹ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ä¸€ç›´è‡ªæ—‹æ£€æµ‹æ˜¯å¦èƒ½è·å–èµ„æºï¼Œé€‚ç”¨äºå¾—åˆ°é”ä»¥åå¤„ç†æ—¶é—´\u0026lt; çº¿ç¨‹åˆ‡æ¢æ—¶é—´çš„åœºæ™¯ï¼Œå¾—åˆ°é”å¤„ç†é€»è¾‘æœ€å¥½åˆ«æœ‰IOæ“ä½œæˆ–è€…æ–‡ä»¶æµæ“ä½œ\nè‡ªæ—‹é”æ˜¯é€šè¿‡cpuçš„CASå‡½æ•°ï¼Œåœ¨ç”¨æˆ·æ€å°±å®Œæˆäº†åŠ é”å’Œè§£é”æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œç›¸æ¯”äº’æ–¥é”æ¥è¯´ï¼Œä¼šå¿«ä¸€ç‚¹\nä¸€èˆ¬åŠ é”çš„è¿‡ç¨‹æœ‰ä¸¤æ­¥\næŸ¥çœ‹é”çš„çŠ¶æ€ï¼Œå¦‚æœé”æ˜¯ç©ºé—²çš„ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬äºŒæ­¥ å°†é”è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰ è‡ªæ—‹é”åŠ é”å¤±è´¥ä»¥åçº¿ç¨‹ä¼šå¿™ç­‰å¾…ï¼Œç›´åˆ°å®ƒèƒ½æ‹¿åˆ°é”\nè¯»å†™é” å®ç°åœ¨rwlock.hä¸­\nè¯»é”æ˜¯å…±äº«é”æ¦‚å¿µï¼Œå…¶ä»–é”å»è¯»çš„æ—¶å€™è¯»å–çš„æ˜¯å…±äº«çš„èµ„æºï¼Œ\nå†™é”æ˜¯ç‹¬å æ¦‚å¿µï¼Œå…¶ä»–é”åªèƒ½ç­‰å¾…æŠ¢å åˆ°çš„é”é‡Šæ”¾èµ„æºï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯\næ‰€ä»¥æ›´å…·åœºæ™¯å¯ä»¥åˆ†ä¸ºè¯»ä¼˜å…ˆé”å’Œå†™ä¼˜å…ˆé”\nè¯»ä¼˜å…ˆé” è¯»ä¼˜å…ˆé”å¯¹äºè¯»çº¿ç¨‹å¹¶å‘æ€§æ›´å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€ç›´æœ‰è¯»çº¿ç¨‹è·å–é”ï¼Œé‚£ä¹ˆå†™çº¿ç¨‹å°±ä¼šè¢«é¥¿æ­»\nå†™ä¼˜å…ˆé” å†™ä¼˜å…ˆé”å¯ä»¥ä¿è¯å†™çº¿ç¨‹ä¸è¢«é¥¿æ­»ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æœ‰å†™çº¿ç¨‹è·å–ï¼Œé‚£ä¹ˆè¯»çº¿ç¨‹ä¹Ÿä¼šè¢«é¥¿æ­»\næ‰€ä»¥ä¸ç®¡æ˜¯ä¼˜å…ˆè¯»é”è¿˜æ˜¯å†™é”ï¼Œå¯¹æ–¹éƒ½å¯èƒ½è¢«é¥¿æ­»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åè¢’ä»»ä½•ä¸€æ–¹ï¼Œæä¸ªå…¬å¹³è¯»å†™é”\nå…¬å¹³è¯»å†™é” ç”¨é˜Ÿåˆ—æŠŠè·å–é”çš„çº¿ç¨‹æ’é˜Ÿï¼Œä¸ç®¡æ˜¯å†™çº¿ç¨‹è¿˜æ˜¯è¯»çº¿ç¨‹éƒ½æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™åŠ é”ï¼Œè¿™æ ·è¯»çº¿ç¨‹ä¸€æ ·èƒ½å¹¶å‘ï¼Œä¹Ÿä¸ä¼šå‡ºç°é¥¥é¥¿ç°è±¡\nä¹è§‚é”å’Œæ‚²è§‚é”åŒºåˆ« æ‚²è§‚é”åšäº‹æ¯”è¾ƒæ‚²è§‚ï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨è®¿é—®èµ„æºä¹‹å‰éƒ½ä¼šå…ˆä¸Šä¸€æŠŠé”ã€‚\nä¹è§‚é”æ­£å¥½ç›¸åï¼Œä»–è®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥ä¼šè®©å…ˆä¿®æ”¹å®Œèµ„æºï¼Œç„¶ååœ¨åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å†²çªï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„çº¿ç¨‹åœ¨ä¿®æ”¹èµ„æºï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥æ”¾å¼ƒæœ¬æ¬¡æ“ä½œï¼Œ\näº’æ–¥é”ã€è‡ªæ—‹é”ã€è¯»å†™é”ï¼Œéƒ½æ˜¯å±äºæ‚²è§‚é”\né‡å…¥é” å°±æ˜¯èƒ½ä¸€æ¡çº¿ç¨‹ä¸Šèƒ½é‡å¤è·å–çš„é”ï¼Œè€Œä¸å¯¼è‡´æ­»é”\ncluster æ¨¡å¼ åœ¨æ¯ä¸ª skynet èŠ‚ç‚¹ï¼ˆå•ä¸ªè¿›ç¨‹ï¼‰å†…ï¼Œå¯åŠ¨ä¸€ä¸ªå« clusterd çš„æœåŠ¡ã€‚æ‰€æœ‰éœ€è¦è·¨è¿›ç¨‹çš„æ¶ˆæ¯æŠ•é€’éƒ½å…ˆæŠŠæ¶ˆæ¯æŠ•é€’åˆ°è¿™ä¸ªæœåŠ¡ä¸Šï¼Œå†ç”±å®ƒæ¥è½¬å‘åˆ°ç½‘ç»œã€‚\né¦–é€‰é€šè¿‡clustername.luaé…ç½®è¡¨é…ç½®å¥½å…¨éƒ¨çš„clusterèŠ‚ç‚¹ åœ¨æ‰€æœ‰è¦å‘ç°çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œrequire\u0026quot;skynet.cluster\u0026quot; ç”¨cluster.openå»ºç«‹è‡ªå·±çš„ç›‘å¬å¥½è®©åˆ«çš„èŠ‚ç‚¹å’Œè‡ªå·±å»ºç«‹tcpé€šé“è¿æ¥ é€šè¿‡cluster.registeræ³¨å†Œcreateçš„service è¿œç¨‹èŠ‚ç‚¹åˆ©ç”¨cluster.query()æ¥å¾—åˆ°æ³¨å†Œè¿‡çš„èŠ‚ç‚¹ é€šè¿‡cluster.call skynet.call cluster.send skynet.sendæ¥è°ƒç”¨è¿œç¨‹function1 function2å‡½æ•° ç®€æ˜“çš„mmo æ¶æ„ ç½‘å…³æœåŠ¡ main.lua å»ºç«‹ watchdog watchdog é€šè¿‡skynet.start() åˆ›å»ºgateService gateServiceå¹¶é€šè¿‡rpcè°ƒç”¨ watchdogService socket.open å‡½æ•° watchdogService é€šè¿‡ socket.open åˆ›å»º agenService agenService æŠŠfd forwardç»™gateService client å‘é€è¯·æ±‚ç»™gateService gateService æŠŠè¯·æ±‚é‡å®šå‘ç»™agentService agentService æŠŠå¤„ç†ç»“æœè¿”å›ç»™client åç¨‹ coroutine å®ç° è¯¦ç»†ä»£ç è§lcorolib.c\næ´¾å‘æ¶ˆæ¯ function skynet.dispatch_message(...) -- å½“å‰æ¶ˆæ¯å¤„ç† local succ, err = pcall(raw_dispatch_message,...) while true do -- é¡ºåºæ‰§è¡Œskynet.fork åˆ›å»ºçš„åç¨‹ if fork_queue.h \u0026gt; fork_queue.t then -- queue is empty fork_queue.h = 1 fork_queue.t = 0 break end -- pop queue local h = fork_queue.h local co = fork_queue[h] fork_queue[h] = nil fork_queue.h = h + 1 local fork_succ, fork_err = pcall(suspend,co,coroutine_resume(co)) if not fork_succ then if succ then succ = false err = tostring(fork_err) else err = tostring(err) .. \u0026#34;\\n\u0026#34; .. tostring(fork_err) end end end assert(succ, tostring(err)) end å¤„ç†å½“å‰æ¶ˆæ¯ local function raw_dispatch_message(prototype, msg, sz, session, source) -- skynet.PTYPE_RESPONSE = 1, read skynet.h if prototype == 1 then -- å¯¹å›åº”ç±»å‹çš„åŒ…å¤„ç† local co = session_id_coroutine[session] if co == \u0026#34;BREAK\u0026#34; then session_id_coroutine[session] = nil elseif co == nil then unknown_response(session, source, msg, sz) else local tag = session_coroutine_tracetag[co] if tag then c.trace(tag, \u0026#34;resume\u0026#34;) end session_id_coroutine[session] = nil suspend(co, coroutine_resume(co, true, msg, sz, session)) end else local p = proto[prototype] -- æ‰¾åˆ°å¯¹åº”çš„è§£æåè®® if p == nil then if prototype == skynet.PTYPE_TRACE then -- trace next request trace_source[source] = c.tostring(msg,sz) elseif session ~= 0 then c.send(source, skynet.PTYPE_ERROR, session, \u0026#34;\u0026#34;) else unknown_request(session, source, msg, sz, prototype) end return end local f = p.dispatch -- è·å–å¤„ç†çš„å‡½æ•° if f then local co = co_create(f) -- è·å–åç¨‹ session_coroutine_id[co] = session session_coroutine_address[co] = source local traceflag = p.trace if traceflag == false then -- force off trace_source[source] = nil session_coroutine_tracetag[co] = false else local tag = trace_source[source] if tag then trace_source[source] = nil c.trace(tag, \u0026#34;request\u0026#34;) session_coroutine_tracetag[co] = tag elseif traceflag then -- set running_thread for trace running_thread = co skynet.trace() end end suspend(co, coroutine_resume(co, session,source, p.unpack(msg,sz))) else trace_source[source] = nil if session ~= 0 then c.send(source, skynet.PTYPE_ERROR, session, \u0026#34;\u0026#34;) else unknown_request(session, source, msg, sz, proto[prototype].name) end end end end åˆ›å»ºåç¨‹ local function co_create(f) local co = tremove(coroutine_pool) -- ä»åç¨‹æ± ä¸­è·å–åç¨‹ if co == nil then --å¦‚æœæ²¡æœ‰äº† co = coroutine_create(function(...) -- åˆ›å»ºæ–°çš„ f(...) --æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä¸ä¼šç«‹é©¬æ‰§è¡Œåªä¼šè°ƒç”¨coroutine.resumeæ—¶å€™æ‰ä¼šæ‰§è¡Œ while true do -- ä¸ºäº†èƒ½å¤Ÿå¤ç”¨åˆšåˆ›å»ºçš„åæˆï¼Œä¸‹é¢éœ€è¦å¯¹åç¨‹è¿›è¡Œåˆå§‹åŒ–å’Œå›æ”¶ local session = session_coroutine_id[co] if session and session ~= 0 then local source = debug.getinfo(f,\u0026#34;S\u0026#34;) skynet.error(string.format(\u0026#34;Maybe forgot response session %s from %s : %s:%d\u0026#34;, session, skynet.address(session_coroutine_address[co]), source.source, source.linedefined)) end -- coroutine exit local tag = session_coroutine_tracetag[co] if tag ~= nil then if tag then c.trace(tag, \u0026#34;end\u0026#34;) end session_coroutine_tracetag[co] = nil end local address = session_coroutine_address[co] if address then session_coroutine_id[co] = nil session_coroutine_address[co] = nil end -- recycle co into pool f = nil coroutine_pool[#coroutine_pool+1] = co -- recv new main function f f = coroutine_yield \u0026#34;SUSPEND\u0026#34; f(coroutine_yield()) end end) else -- pass the main function f to coroutine, and restore running thread local running = running_thread coroutine_resume(co, f) running_thread = running end return co end åç¨‹æŒ‚èµ· -- suspend is local function function suspend(co, result, command) if not result then -- æ‰§è¡Œcoå¤±è´¥ä»¥åçš„å¤„ç† local session = session_coroutine_id[co] if session then -- coroutine may fork by others (session is nil) local addr = session_coroutine_address[co] if session ~= 0 then -- only call response error local tag = session_coroutine_tracetag[co] if tag then c.trace(tag, \u0026#34;error\u0026#34;) end c.send(addr, skynet.PTYPE_ERROR, session, \u0026#34;\u0026#34;) end session_coroutine_id[co] = nil end session_coroutine_address[co] = nil session_coroutine_tracetag[co] = nil skynet.fork(function() end) -- trigger command \u0026#34;SUSPEND\u0026#34; local tb = traceback(co,tostring(command)) coroutine.close(co) error(tb) end if command == \u0026#34;SUSPEND\u0026#34; then -- æŒ‚èµ·æ“ä½œ return dispatch_wakeup() -- å¦‚æœæœ‰èƒ½å¤Ÿè¢«å”¤é†’çš„åç¨‹ï¼Œå°±wakeup elseif command == \u0026#34;QUIT\u0026#34; then coroutine.close(co) -- service exit return elseif command == \u0026#34;USER\u0026#34; then -- See skynet.coutine for detail error(\u0026#34;Call skynet.coroutine.yield out of skynet.coroutine.resume\\n\u0026#34; .. traceback(co)) elseif command == nil then -- debug trace return else error(\u0026#34;Unknown command : \u0026#34; .. command .. \u0026#34;\\n\u0026#34; .. traceback(co)) end end\tåç¨‹é”€æ¯ ä¸»è¦æ˜¯å› ä¸ºè¿™ç§åŸºç¡€ç±»å‹LUA_TTHREADæ¥å†³å®šæ€ä¹ˆé”€æ¯\nLUA_TTHREAD ä»‹ç»:\né™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼Œå…¶å®ƒçº¿ç¨‹å’Œå…¶å®ƒLuaå¯¹è±¡ä¸€æ ·éƒ½æ˜¯åƒåœ¾å›æ”¶çš„å¯¹è±¡ã€‚ç­‰å¾…GCå›æ”¶ï¼Œå½“æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¼šå‹å…¥æ ˆï¼Œè¿™æ ·èƒ½ç¡®ä¿æ–°çº¿ç¨‹ä¸ä¼šæˆä¸ºåƒåœ¾\næ¯æ¬¡è°ƒç”¨lua_newstateçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„luastate,ä¸åŒçš„luastateå®Œå…¨ç‹¬ç«‹ï¼Œä¹‹é—´ä¸å…±äº«ä»»ä½•æ•°æ®\nåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæ ˆäº†ï¼Œä½†æ˜¯å®ƒä¸å…¶çº¿ç¨‹å…±ç”¨è™šæ‹Ÿæœºçš„å…¨å±€çŠ¶æ€\nåç¨‹æä¾›äº†æ–°çš„apiæ¥å£å’Œ lua_resetthread, coroutine.close ä¼šä½¿åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€,å¹¶ä¸”å…³é—­æ‰€æœ‰çš„closeå˜é‡\nsend.call æµç¨‹ API ç›¸å…³ cluster cluster.call(node, address, ...) --è¿œç¨‹è°ƒç”¨nodeä¸­çš„addr cluster.send(node, address, ...) --sendè°ƒç”¨è¿œç¨‹nodeçš„addr cluster.open(port) --æœ¬åœ°æ‰“å¼€(ç›‘å¬)ä¸€ä¸ªclusterç»“ç‚¹ï¼Œä½¿å…¶èƒ½åœ¨clusterä¸­çš„å…¶ä»–ç»“ç‚¹å‘ç° cluster.reload(config) --é‡è½½è¿œç¨‹ç»“ç‚¹é…ç½®è¡¨ï¼Œè¡¨ä¸­çš„clusterç»“ç‚¹éƒ½openè¿‡ï¼Œåˆ™å¯ä»¥é€šè®¯ cluster.proxy(node, name) --è®¾ç½®è¿œç¨‹ç»“ç‚¹çš„ä»£ç†ï¼Œä½¿å¾—å¯ä»¥åƒè°ƒç”¨æœ¬åœ°RPCä¸€æ ·è°ƒç”¨è¿œç¨‹ç»“ç‚¹ cluster.snax(node, name, address) --ç”Ÿæˆä¸€ä¸ªè¿œç¨‹çš„snaxæœåŠ¡å¯¹è±¡ cluster.register(name, addr) --æ³¨å†Œä¸€ä¸ªclusterç»“ç‚¹ cluster.query(node, name) --æŸ¥æ‰¾è¿œç¨‹ç»“ç‚¹ä¸­æ³¨å†Œè¿‡çš„ç»“ç‚¹æ˜¯å¦å­˜åœ¨ harbor harbor.link(id) --ç”¨æ¥ç›‘æ§ä¸€ä¸ª slave æ˜¯å¦æ–­å¼€ã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ­£å¸¸ï¼Œè¿™ä¸ª api å°†é˜»å¡ã€‚å½“ slave æ–­å¼€æ—¶ï¼Œä¼šç«‹åˆ»è¿”å›ã€‚ harbor.linkmaster() --ç”¨æ¥åœ¨ slave ä¸Šç›‘æ§å’Œ master çš„è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚è¿™ä¸ª api å¤šç”¨äºå¼‚å¸¸æ—¶çš„å®‰å…¨é€€å‡ºï¼ˆå› ä¸ºå½“ slave å’Œ master æ–­å¼€åï¼Œæ²¡æœ‰æ‰‹æ®µå¯ä»¥æ¢å¤ï¼‰ã€‚ harbor.connect(id) --å’Œ harbor.link ç›¸åã€‚å¦‚æœ harbor id å¯¹åº”çš„ slave æ²¡æœ‰è¿æ¥ï¼Œè¿™ä¸ª api å°†é˜»å¡ï¼Œä¸€ç›´åˆ°å®ƒè¿ä¸Šæ¥æ‰è¿”å›ã€‚ harbor.queryname(name) --å¯ä»¥ç”¨æ¥æŸ¥è¯¢å…¨å±€åå­—æˆ–æœ¬åœ°åå­—å¯¹åº”çš„æœåŠ¡åœ°å€ã€‚å®ƒæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ã€‚ harbor.globalname(name, handle) --æ³¨å†Œä¸€ä¸ªå…¨å±€åå­—ã€‚å¦‚æœ handle ä¸ºç©ºï¼Œåˆ™æ³¨å†Œè‡ªå·±ã€‚skynet.name å’Œ skynet.register æ˜¯ç”¨å…¶å®ç°çš„ã€‚ æ„å»ºæœåŠ¡çš„ä¸€äº›åŸºç¡€æ¥å£ skynet.getenv(varName) --confé…ç½®ä¿¡æ¯å·²ç»å†™å…¥åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œé€šè¿‡è¯¥å‡½æ•°è·å–æ³¨å†Œè¡¨çš„å˜é‡å€¼ skynet.setenv(varName, varValue) --è®¾ç½®æ³¨å†Œè¡¨ä¿¡æ¯ï¼ŒvarValueä¸€èˆ¬æ˜¯numberæˆ–stringï¼Œä½†æ˜¯ä¸èƒ½è®¾ç½®å·²ç»å­˜åœ¨çš„varname skynet.error(...) --æ‰“å°å‡½æ•° skynet.start(func) --ç”¨ func å‡½æ•°åˆå§‹åŒ–æœåŠ¡ï¼Œå¹¶å°†æ¶ˆæ¯å¤„ç†å‡½æ•°æ³¨å†Œåˆ° C å±‚ï¼Œè®©è¯¥æœåŠ¡å¯ä»¥å·¥ä½œã€‚ skynet.init(func) --è‹¥æœåŠ¡å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œåˆ™æ³¨å†Œä¸€ä¸ªå‡½æ•°ç­‰æœåŠ¡åˆå§‹åŒ–é˜¶æ®µå†æ‰§è¡Œï¼›è‹¥æœåŠ¡å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œåˆ™ç«‹åˆ»è¿è¡Œè¯¥å‡½æ•°ã€‚ skynet.exit() --ç»“æŸå½“å‰æœåŠ¡ skynet.self() --è·å–å½“å‰æœåŠ¡çš„å¥æŸ„handler skynet.address(handler) --å°†handleè½¬æ¢æˆå­—ç¬¦ä¸² skynet.abort() --é€€å‡ºskynetè¿›ç¨‹ skynet.kill(address) ----å¼ºåˆ¶æ€æ­»å…¶ä»–æœåŠ¡ã€‚å¯ä»¥ç”¨æ¥å¼ºåˆ¶å…³é—­åˆ«çš„æœåŠ¡ã€‚ä½†å¼ºçƒˆä¸æ¨èè¿™æ ·åšã€‚å› ä¸ºå¯¹è±¡ä¼šåœ¨ä»»æ„ä¸€æ¡æ¶ˆæ¯å¤„ç†å®Œæ¯•åï¼Œæ¯«æ— å¾å…†çš„é€€å‡ºã€‚æ‰€ä»¥æ¨èçš„åšæ³•æ˜¯ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè®©å¯¹æ–¹è‡ªå·±å–„åä»¥åŠè°ƒç”¨ skynet.exit ã€‚æ³¨ï¼šskynet.kill(skynet.self()) ä¸å®Œå…¨ç­‰ä»·äº skynet.exit() ï¼Œåè€…æ›´å®‰å…¨ã€‚\tæ™®é€šæœåŠ¡ skynet.newservice(luaServerName, ...)\tå…¨å±€å”¯ä¸€æœåŠ¡ skynet.uniqueservice(servicename, ...) --å½“å‰çš„skynetèŠ‚ç‚¹å…¨å±€å”¯ä¸€ skynet.uniqueservice(true, servicename, ...) --æ‰€æœ‰çš„èŠ‚ç‚¹å…¨å±€å”¯ä¸€ skynet.queryservice(servicename, ...) --å½“å‰çš„skynetèŠ‚ç‚¹ä¸­æŸ¥æ‰¾ skynet.queryservice(true, servicename, ...) --æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­æŸ¥æ‰¾ åˆ«å åˆ«ååˆ†ä¸¤ç§ï¼š\næœ¬åœ°åˆ«å ä»£è¡¨åªèƒ½åœ¨å½“å‰skynetèŠ‚ç‚¹ä½¿ç”¨ï¼Œæœ¬åœ°åˆ«åç”¨ .å¼€å¤´\nå…¨å±€åˆ«å å¯ä»¥åœ¨æ‰€æœ‰çš„skynetä¸­ä½¿ç”¨ å…¨å±€åˆ«åä¸èƒ½ä»¥. å¼€å¤´\nskynet.register(aliasname) --ç»™å½“å‰æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å skynet.name(aliasname, servicehandler) --ç»™æŒ‡å®šservicehandlerçš„æœåŠ¡å®šä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ˜¯å…¨å±€åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«å --[[ æŸ¥è¯¢åˆ«åä¸ºaliasnameçš„æœåŠ¡,å¯ä»¥æ˜¯å…¨å±€åˆ«åä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°åˆ«åï¼Œ 1ã€å½“æŸ¥è¯¢æœ¬åœ°åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil 2ã€å½“æŸ¥è¯¢å…¨å±€åˆ«åæ—¶ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±é˜»å¡ç­‰å¾…åˆ°è¯¥æœåŠ¡åˆå§‹åŒ–å®Œæˆ ]]-- skynet.harbor.queryname(aliasname) skynet.localname(aliasname) --æŸ¥è¯¢æœ¬åœ°åˆ«åä¸ºaliasnameçš„æœåŠ¡ï¼Œè¿”å›servicehandlerï¼Œä¸å­˜åœ¨å°±è¿”å›nil skynet.kill(handle) --æ€æ­»å¸¦åˆ«åæœåŠ¡ æœåŠ¡è°ƒåº¦ skynet.sleep(time) --è®©å½“å‰çš„ä»»åŠ¡ç­‰å¾… time * 0.01s ã€‚ skynet.fork(func, ...) --å¯åŠ¨ä¸€ä¸ªæ–°çš„ä»»åŠ¡å»æ‰§è¡Œå‡½æ•° func , å…¶å®å°±æ˜¯å¼€äº†ä¸€ä¸ªåç¨‹ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆå°†è¿”å›çº¿ç¨‹å¥æŸ„ è™½ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”Ÿçš„coroutine.createæ¥åˆ›å»ºåç¨‹ï¼Œä½†æ˜¯ä¼šæ‰“ä¹±skynetçš„å·¥ä½œæµç¨‹ skynet.yield() --è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œä½¿æœ¬æœåŠ¡å†…å…¶å®ƒä»»åŠ¡æœ‰æœºä¼šæ‰§è¡Œï¼Œéšåä¼šç»§ç»­è¿è¡Œã€‚ skynet.wait() --è®©å‡ºå½“å‰çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œç›´åˆ°ç”¨ wakeup å”¤é†’å®ƒã€‚ skynet.wakeup(co) --å”¤é†’ç”¨ wait æˆ– sleep å¤„äºç­‰å¾…çŠ¶æ€çš„ä»»åŠ¡ã€‚ skynet.timeout(time, func) --è®¾å®šä¸€ä¸ªå®šæ—¶è§¦å‘å‡½æ•° func ï¼Œåœ¨ time * 0.01s åè§¦å‘ã€‚ skynet.starttime() --è¿”å›å½“å‰è¿›ç¨‹çš„å¯åŠ¨ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚ skynet.now() --è¿”å›å½“å‰è¿›ç¨‹å¯åŠ¨åç»è¿‡çš„æ—¶é—´ (0.01 ç§’) ã€‚ skynet.time() --é€šè¿‡ starttime å’Œ now è®¡ç®—å‡ºå½“å‰ UTC æ—¶é—´ï¼ˆç§’ï¼‰ã€‚\tæ¶ˆæ¯ç±»å‹ #define PTYPE_TEXT 0 --æ–‡æœ¬ #define PTYPE_RESPONSE 1 --è¡¨ç¤ºä¸€ä¸ªå›åº”åŒ… #define PTYPE_MULTICAST 2 --å¹¿æ’­æ¶ˆæ¯ #define PTYPE_CLIENT 3 --ç”¨æ¥å¤„ç†ç½‘ç»œå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯ #define PTYPE_SYSTEM 4 --ç³»ç»Ÿæ¶ˆæ¯ #define PTYPE_HARBOR 5 --é›†ç¾¤å†…å…¶ä»–çš„ skynet èŠ‚ç‚¹å‘æ¥çš„æ¶ˆæ¯ #define PTYPE_SOCKET 6 --å¥—æ¥å­—æ¶ˆæ¯ #define PTYPE_ERROR 7 --é”™è¯¯æ¶ˆæ¯ï¼Œä¸€èˆ¬æœåŠ¡é€€å‡ºçš„æ—¶å€™ä¼šå‘é€erroræ¶ˆæ¯ç»™å…³è”çš„æœåŠ¡ #define PTYPE_QUEUE 8 --é˜Ÿåˆ—æ–¹å¼ #define PTYPE_DEBUG 9 --è°ƒè¯• #define PTYPE_LUA 10 --luaç±»å‹çš„æ¶ˆæ¯ï¼Œæœ€å¸¸ç”¨ #define PTYPE_SNAX 11 --snaxæœåŠ¡æ¶ˆæ¯ #define PTYPE_TAG_DONTCOPY 0x10000 --ç¦æ­¢æ‹·è´ #define PTYPE_TAG_ALLOCSESSION 0x20000 --åˆ†é…æ–°çš„ session æ‰“åŒ…è§£åŒ… skynet.pack(...) --æ‰“åŒ… skynet.unpack(msg, sz) --è§£åŒ…\tå‘é€æ¶ˆæ¯ -- å‘é€æ— éœ€å“åº”çš„æ¶ˆæ¯ skynet.send(addr, type, ...) --ç”¨ type ç±»å‹å‘ addr å‘é€æœªæ‰“åŒ…çš„æ¶ˆæ¯ã€‚è¯¥å‡½æ•°ä¼šè‡ªåŠ¨æŠŠ...å‚æ•°åˆ—è¡¨è¿›è¡Œæ‰“åŒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹luaæ¶ˆæ¯ä½¿ç”¨skynet.packæ‰“åŒ…ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚è‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰ skynet.rawsend(addr, type, msg, sz) --ç”¨ type ç±»å‹å‘ addr å‘é€ä¸€ä¸ªæ‰“åŒ…å¥½çš„æ¶ˆæ¯ã€‚addrå¯ä»¥æ˜¯æœåŠ¡å¥æŸ„ä¹Ÿå¯ä»¥æ˜¯åˆ«åã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰ -- å‘é€å¿…é¡»å“åº”çš„æ¶ˆæ¯ skynet.call(addr, type, ...) --ç”¨é»˜è®¤å‡½æ•°æ‰“åŒ…æ¶ˆæ¯ï¼Œå‘addrå‘é€typeç±»å‹çš„æ¶ˆæ¯å¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œå¹¶å¯¹å›åº”ä¿¡æ¯è¿›è¡Œè§£åŒ…ã€‚ï¼ˆè‡ªåŠ¨æ‰“åŒ…ä¸è§£åŒ…ã€‚ï¼‰ skynet.rawcall(addr, type, msg, sz) --ç›´æ¥å‘addrå‘é€typeç±»å‹çš„msg,szå¹¶ç­‰å¾…è¿”å›å“åº”ï¼Œä¸å¯¹å›åº”ä¿¡æ¯è§£åŒ…ã€‚ï¼ˆéœ€è¦è‡ªå·±æ‰“åŒ…ä¸è§£åŒ…ï¼‰ å“åº”æ¶ˆæ¯ -- åŒä¸€ä¸ªåæˆå¤„ç† skynet.ret() --ç›®æ ‡æœåŠ¡æ¶ˆæ¯å¤„ç†åéœ€è¦é€šè¿‡è¯¥å‡½æ•°å°†ç»“æœè¿”å› skynet.retpack(...) --å°†æ¶ˆæ¯ç”¨skynet.pack æ‰“åŒ…ï¼Œå¹¶è°ƒç”¨ ret å›åº”ã€‚ --ä¸åœ¨ä¸€ä¸ªåæˆå¤„ç† local response = skynet.response(pack)--å‚æ•°packæŒ‡å®šåº”ç­”æ‰“åŒ…å‡½æ•°ï¼Œä¸å¡«é»˜è®¤ä½¿ç”¨skynet.pack, å¿…é¡»æ ¹æ®æ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰“åŒ…å‡½æ•°ä¸€è‡´ è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•° response(ok, ...) --å‚æ•°okçš„å€¼å¯ä»¥æ˜¯ \u0026#34;test\u0026#34;ã€trueã€falseï¼Œä¸º\u0026#34;test\u0026#34;æ—¶è¡¨ç¤ºæ£€æŸ¥æ¥æ”¶å“åº”çš„æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œä¸ºtrueæ—¶è¡¨ç¤ºå‘é€åº”ç­”PTYPE_RESPONSEï¼Œä¸ºfalseæ—¶è¡¨ç¤ºå‘é€PTYPE_ERRORé”™è¯¯æ¶ˆæ¯ã€‚ æ¶ˆæ¯å†²å…¥æ—¶åºé—®é¢˜ skynet.queue() --å¸®åŠ©ä½ å›é¿è¿™äº›æœåŠ¡é‡å…¥æˆ–è€…ä¼ªå¹¶å‘å¼•èµ·çš„å¤æ‚æ€§,ä½†æ˜¯æ˜æ˜¾é™ä½äº†æœåŠ¡çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ‰€ä»¥ä½¿ç”¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™å°½é‡ç¼©å°ä¸´ç•ŒåŒºçš„é¢—ç²’åº¦å¤§å° åè®®è½¬æ¢ skynet.forward_type() --éœ€è¦æä¾›ä¸€å¼ æ¶ˆæ¯è½¬æ¢æ˜ å°„è¡¨forward_map, å…¶ä»–çš„æ–¹æ³•ä¸skynet.startä¸€æ · ä¼ªé€ æ¶ˆæ¯ skynet.redirect(dest,source,typename, session, msg, sz) --ä½¿ç”¨sourceæœåŠ¡åœ°å€ï¼Œå‘é€typenameç±»å‹çš„æ¶ˆæ¯ç»™destæœåŠ¡ï¼Œä¸éœ€è¦æ¥æ”¶å“åº”ï¼Œï¼ˆsourceï¼Œdeståªèƒ½æ˜¯æœåŠ¡IDï¼‰msg szä¸€èˆ¬ä½¿ç”¨skynet.packæ‰“åŒ…ç”Ÿæˆ ç»„æ’­ skynet.multicast -- å½“ç»„æ’­çš„æ•°æ®é‡è¾ƒå¤§æ—¶å€™å¯ä»¥èŠ‚çœå†…éƒ¨çš„å¸¦å®½ socket --å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ã€‚è¿”å›ä¸€ä¸ªæ•°å­— id ã€‚ socket.open(address, port) --å…³é—­ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ª API æœ‰å¯èƒ½é˜»å¡ä½æ‰§è¡Œæµã€‚å› ä¸ºå¦‚æœæœ‰å…¶å®ƒ coroutine --æ­£åœ¨é˜»å¡è¯»è¿™ä¸ª id å¯¹åº”çš„è¿æ¥ï¼Œä¼šå…ˆé©±ä½¿è¯»æ“ä½œç»“æŸï¼Œclose æ“ä½œæ‰è¿”å›ã€‚ socket.close(id) --åœ¨æå…¶ç½•è§çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç²—æš´çš„ç›´æ¥å…³é—­æŸä¸ªè¿æ¥ï¼Œè€Œé¿å… socket.close çš„é˜»å¡ç­‰å¾…æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚ socket.close_fd(id) --å¼ºè¡Œå…³é—­ä¸€ä¸ªè¿æ¥ã€‚å’Œ close ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸ä¼šç­‰å¾…å¯èƒ½å­˜åœ¨çš„å…¶å®ƒ coroutine çš„è¯»æ“ä½œã€‚ --ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ª API ï¼Œä½†å¦‚æœä½ éœ€è¦åœ¨ __gc å…ƒæ–¹æ³•ä¸­å…³é—­è¿æ¥çš„è¯ï¼Œ --shutdown æ˜¯ä¸€ä¸ªæ¯” close æ›´å¥½çš„é€‰æ‹©ï¼ˆå› ä¸ºåœ¨ gc è¿‡ç¨‹ä¸­æ— æ³•åˆ‡æ¢ coroutineï¼‰ã€‚ä¸close_fdç±»ä¼¼ socket.shutdown(id) --[[ ä»ä¸€ä¸ª socket ä¸Šè¯» sz æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚ å¦‚æœè¯»åˆ°äº†æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®ƒæŠŠè¿™ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚ å¦‚æœè¿æ¥æ–­å¼€å¯¼è‡´å­—èŠ‚æ•°ä¸å¤Ÿï¼Œå°†è¿”å›ä¸€ä¸ª false åŠ ä¸Šè¯»åˆ°çš„å­—ç¬¦ä¸²ã€‚ å¦‚æœ sz ä¸º nil ï¼Œåˆ™è¿”å›å°½å¯èƒ½å¤šçš„å­—èŠ‚æ•°ï¼Œä½†è‡³å°‘è¯»ä¸€ä¸ªå­—èŠ‚ï¼ˆè‹¥æ— æ–°æ•°æ®ï¼Œä¼šé˜»å¡ï¼‰ã€‚ --]] socket.read(id, sz) --ä»ä¸€ä¸ª socket ä¸Šè¯»æ‰€æœ‰çš„æ•°æ®ï¼Œç›´åˆ° socket ä¸»åŠ¨æ–­å¼€ï¼Œæˆ–åœ¨å…¶å®ƒ coroutine ç”¨ socket.close å…³é—­å®ƒã€‚ socket.readall(id) --ä»ä¸€ä¸ª socket ä¸Šè¯»ä¸€è¡Œæ•°æ®ã€‚sep æŒ‡è¡Œåˆ†å‰²ç¬¦ã€‚é»˜è®¤çš„ sep ä¸º \u0026#34;\\n\u0026#34;ã€‚è¯»åˆ°çš„å­—ç¬¦ä¸²æ˜¯ä¸åŒ…å«è¿™ä¸ªåˆ†å‰²ç¬¦çš„ã€‚ --å¦‚æœå¦å¤–ä¸€ç«¯å°±å…³é—­äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šè¿”å›ä¸€ä¸ªnilï¼Œå¦‚æœbufferä¸­æœ‰æœªè¯»æ•°æ®åˆ™ä½œä¸ºç¬¬äºŒä¸ªè¿”å›å€¼è¿”å›ã€‚ socket.readline(id, sep) --ç­‰å¾…ä¸€ä¸ª socket å¯è¯»ã€‚ socket.block(id) --æŠŠä¸€ä¸ªå­—ç¬¦ä¸²ç½®å…¥æ­£å¸¸çš„å†™é˜Ÿåˆ—ï¼Œskynet æ¡†æ¶ä¼šåœ¨ socket å¯å†™æ—¶å‘é€å®ƒã€‚ socket.write(id, str) --æŠŠå­—ç¬¦ä¸²å†™å…¥ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å¦‚æœæ­£å¸¸çš„å†™é˜Ÿåˆ—è¿˜æœ‰å†™æ“ä½œæœªå®Œæˆæ—¶ï¼Œä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸Šçš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«å‘å‡ºã€‚ --åªæœ‰åœ¨æ­£å¸¸å†™é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šå¤„ç†ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œæ¯æ¬¡å†™çš„å­—ç¬¦ä¸²éƒ½å¯ä»¥çœ‹æˆåŸå­æ“ä½œã€‚ --ä¸ä¼šåªå‘é€ä¸€åŠï¼Œç„¶åè½¬å»å‘é€æ­£å¸¸å†™é˜Ÿåˆ—çš„æ•°æ®ã€‚ socket.lwrite(id, str) --ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œè¿”å›ä¸€ä¸ª id ï¼Œä¾› start ä½¿ç”¨ã€‚ socket.listen(address, port) --[[ accept æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æ¯å½“ä¸€ä¸ªç›‘å¬çš„ id å¯¹åº”çš„ socket ä¸Šæœ‰è¿æ¥æ¥å…¥çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨ accept å‡½æ•°ã€‚ è¿™ä¸ªå‡½æ•°ä¼šå¾—åˆ°æ¥å…¥è¿æ¥çš„ id ä»¥åŠ ip åœ°å€ã€‚ä½ å¯ä»¥åšåç»­æ“ä½œã€‚ æ¯å½“ accept å‡½æ•°è·å¾—ä¸€ä¸ªæ–°çš„ socket id åï¼Œå¹¶ä¸ä¼šç«‹å³æ”¶åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚ è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šå¸Œæœ›æŠŠè¿™ä¸ª socket çš„æ“ä½œæƒè½¬è®©ç»™åˆ«çš„æœåŠ¡å»å¤„ç†ã€‚accept(id, addr) ]]-- socket.start(id , accept) --[[ ä»»ä½•ä¸€ä¸ªæœåŠ¡åªæœ‰åœ¨è°ƒç”¨ socket.start(id) ä¹‹åï¼Œæ‰å¯ä»¥è¯»åˆ°è¿™ä¸ª socket ä¸Šçš„æ•°æ®ã€‚ å‘ä¸€ä¸ª socket id å†™æ•°æ®ä¹Ÿéœ€è¦å…ˆè°ƒç”¨ start ã€‚ socket çš„ id å¯¹äºæ•´ä¸ª skynet èŠ‚ç‚¹éƒ½æ˜¯å…¬å¼€çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ id è¿™ä¸ªæ•°å­— é€šè¿‡æ¶ˆæ¯å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œå…¶ä»–æœåŠ¡ä¹Ÿå¯ä»¥å»æ“ä½œå®ƒã€‚skynet æ¡†æ¶æ˜¯æ ¹æ®è°ƒç”¨ start è¿™ä¸ª api çš„ä½ç½®æ¥å†³å®šæŠŠå¯¹åº” socket ä¸Šçš„æ•°æ®è½¬å‘åˆ°å“ªé‡Œå»çš„ã€‚ --]] socket.start(id) --æ¸…é™¤ socket id åœ¨æœ¬æœåŠ¡å†…çš„æ•°æ®ç»“æ„ï¼Œä½†å¹¶ä¸å…³é—­è¿™ä¸ª socket ã€‚ --è¿™å¯ä»¥ç”¨äºä½ æŠŠ id å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œä»¥è½¬äº¤ socket çš„æ§åˆ¶æƒã€‚ socket.abandon(id) --[[ å½“ id å¯¹åº”çš„ socket ä¸Šå¾…å‘çš„æ•°æ®è¶…è¿‡ 1M å­—èŠ‚åï¼Œç³»ç»Ÿå°†å›è°ƒ callback ä»¥ç¤ºè­¦å‘Šã€‚ function callback(id, size) å›è°ƒå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•° id å’Œ size ï¼Œsize çš„å•ä½æ˜¯ K ã€‚ å¦‚æœä½ ä¸è®¾å›è°ƒï¼Œé‚£ä¹ˆå°†æ¯å¢åŠ  64K åˆ©ç”¨ skynet.error å†™ä¸€è¡Œé”™è¯¯ä¿¡æ¯ã€‚ --]] socket.warning(id, callback) socketChannel ç”¨æ¥æ”¯æŒåŒå‘ä¼ è¾“ï¼Œå¼‚æ­¥éå µå¡å¤„ç†æ•°æ® dns skynet.dns --è°ƒç”¨äº†ç³»ç»Ÿ api getaddrinfo ï¼Œæœ‰å¯èƒ½é˜»å¡ä½æ•´ä¸ª socket çº¿ç¨‹ æ‰€ä»¥skynetå°è£…äº†è¿™ä¸ªæ¥å£æ¥è§£å†³dnsæŸ¥è¯¢æ—¶å€™é€ æˆçš„çº¿ç¨‹å µå¡é—®é¢˜ skynet çš„é€šä¿¡è°ƒè¯•pack å®¢æˆ·ç«¯æŒ‰å¤§å°ç«¯æ‰“åŒ…æˆäºŒè¿›åˆ¶\nlocal result = string.pack(\u0026#34;\u0026gt;s2\u0026#34;,\u0026#34;string2pack\u0026#34;) pack \u0026gt; è¡¨ç¤ºæŒ‰å¤§ç«¯é¡ºåºã€‚s2 è¡¨ç¤ºæŒ‰ç…§2ä¸ªå­—èŠ‚æ‰“åŒ…ã€‚ æˆ‘ä»¬çŸ¥é“stringç”±charç»„æˆã€‚1ä¸ªchar æ˜¯ 0-255 ä¹‹é—´çš„æ•°ï¼Œ2^8 ,1char=8byte éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»–é™¤äº†è¢«æ‰“åŒ…çš„éƒ¨åˆ†ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å‰é¢åŠ 2ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºé•¿åº¦ã€‚ å¦‚æœè¦æ‰“åŒ…ä¸€ä¸ªæ•°å­—åˆ™éœ€è¦è½¬æ¢ã€‚ç”±2ç§åŠæ³• string.pack(\u0026#34;I2\u0026#34;,number)ï¼Œä¼šåœ¨å‰é¢äºŒè¿›åˆ¶åŠ 2ä½è¡¨ç¤ºé•¿åº¦çš„ä¸œè¥¿ã€‚ socketå‘é€\nsocket.send æœåŠ¡ç«¯æ¥æ”¶\ngateserverå·²ç»æœ‰æ¥æ”¶çš„ä»£ç äº†ã€‚ æ³¨æ„çš„æ˜¯ï¼Œsocketä¼šè‡ªåŠ¨æŒ‰packçš„æ•°æ®åˆ†æ®µæ¥æ”¶ã€‚ä¹Ÿå°±æ˜¯ä¼šæ ¹æ®packçš„å‰é¢2ä½å¾—åˆ°sizeã€‚æ ¹æ®sizeå»æ¥æ”¶åé¢çš„æ•°æ®ã€‚ç„¶åå‘ä¸Šä¼ é€’ä¸€ä»½messageã€‚ æ¥æ”¶åˆ°çš„messageå·²ç»æ˜¯å»æ‰äº†å‰é¢2ä½çš„æ•°æ®ã€‚ å®¢æˆ·ç«¯æ¥æ”¶\næˆ·ç«¯æ¥æ”¶åˆ°çš„æ•°æ®ç›®å‰æˆ‘æ˜¯ç”¨skynetæä¾›çš„â€œclient.socketâ€.æ²¡æœ‰netpackå¯ç”¨ã€‚ æ¥æ”¶åˆ°çš„æ•°æ®éœ€è¦è‡ªè¡Œå»é™¤å‰é¢çš„2ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆstring.packäº§ç”Ÿçš„ï¼‰ã€‚ skynet clientsocket å¯¼è‡´ io.read æ— æ³•æ­£ç¡®å·¥ä½œçš„é—®é¢˜ https://blog.csdn.net/gneveek/article/details/78940693 ","permalink":"https://frog-game.github.io/posts/read/skynet/","summary":"linuxç¼–è¯‘ make linux MALLOC_STATICLIB= SKYNET_DEFINES=-DNOUSE_JEMALLOC ç½‘ç»œæµç¨‹å›¾ workçº¿ç¨‹å’Œæ¬¡çº§é˜Ÿåˆ— æ¯ä¸ªåœ¨çº¿å®¢æˆ·ç«¯åœ¨SkynetæœåŠ¡å™¨ä¸Šéƒ½å¯¹åº”æœ‰ä¸€ä¸ªSocketä¸å…¶è¿æ¥ï¼Œä¸€ä¸ªSocket","title":"skynetèµæ"},{"content":"luadebug å®ç°å¤šè™šæ‹ŸæœºåŸç† å…ˆä»luahookåŸç†è¯´èµ·\nåœ¨lua.h å½“ä¸­æˆ‘ä»¬æœ‰ lua_sethookå‡½æ•°æ¥ç»™ä»¬è®¾ç½®é’©å­\nLUA_API void (lua_sethook) (lua_State *L, lua_Hook func, int mask, int count); lua_State *L :è™šæ‹Ÿæœºçš„åœ°å€\nlua_Hook func:æˆ‘ä»¬è®¾å®šçš„é’©å­å›è°ƒå‡½æ•°\nmask: çŠ¶æ€æ©ç å¯ä»¥ç»„åˆæ“ä½œ\nLUA_MASKCALL : è°ƒç”¨å‡½æ•°æ—¶å›è°ƒ LUA_MASKRET :å‡½æ•°è¿”å›æ—¶å›è°ƒ LUA_MASKLINE :æ‰§è¡Œä¸€è¡Œä»£ç æ—¶å€™å›è°ƒ LUA_MASKCOUNT :æ¯æ‰§è¡Œcountæ¡æŒ‡ä»¤æ—¶å€™å›è°ƒ countï¼šåªæœ‰æ©ç åŒ…å«LUA_MASKCOUNT è¿™ä¸ªçŠ¶æ€æ—¶å€™æ‰æœ‰æ•ˆæœï¼Œä»£è¡¨æ‰§è¡Œcountæ¬¡æ‰ä¼šå›è°ƒä¸€æ¬¡é’©å­å‡½æ•°\nLUA_MASKCALL ä¼šåœ¨è°ƒç”¨å‡½æ•°æ—¶å›è°ƒ æˆ‘ä»¬åœ¨è¿½è¸ªluaæºç ï¼Œå¯ä»¥å‘ç°åœ¨æ¯æ¬¡è°ƒç”¨å‡½æ•°ä¹‹å‰éƒ½å›ldo.c å»è°ƒç”¨luaD_precall å‡½æ•°å¹¶æ£€æµ‹æ˜¯å¦è®¾ç½®äº†æ©ç æ ‡è¯†ï¼Œå¦‚æœè®¾ç½®äº† LUA_MASKCALLæ©ç çŠ¶æ€ï¼Œå°±ä¼šè°ƒç”¨ luaD_hook è¿™ä¸ªå›è°ƒå‡½æ•°\nLUA_MASKRET :ä¼šåœ¨å‡½æ•°è¿”å›æ—¶å›è°ƒ æˆ‘ä»¬åœ¨è¿½è¸ªluaæºç ï¼Œå¯ä»¥å‘ç°åœ¨æ¯æ¬¡å‡½æ•°è¿”å›æ—¶å€™éƒ½ä¼šå»ldo.c é‡Œé¢è°ƒç”¨luaD_poscall é‡Œé¢çš„rethookå‡½æ•° å¦‚æœè®¾ç½®äº†å°±ä¼šè°ƒç”¨LUA_MASKRET æ©ç çŠ¶æ€ ï¼Œ å°±ä¼šè°ƒç”¨ luaD_hookè¿™ä¸ªå›è°ƒå‡½æ•°\nLUA_MASKLINE:æ‰§è¡Œä¸€è¡Œä»£ç æ—¶å€™å›è°ƒ æˆ‘ä»¬åœ¨è¿½è¸ªluaæºç ï¼Œå¯ä»¥å‘ç°åœ¨æ¯æ¬¡æ‰§è¡Œä¸€è¡ŒæŒ‡ä»¤éƒ½ä¼šå»ldebug.c å»è°ƒç”¨ luaG_traceexec å‡½æ•° å¦‚æœè®¾ç½®äº†LUA_MASKLINE æ©ç çŠ¶æ€ é‚£ä¹ˆä¹…ä¼šè°ƒç”¨luaD_hook å‡½æ•°\nLUA_MASKCOUNT :æ‰§è¡Œcountæ¡æŒ‡ä»¤æ—¶å€™å›è°ƒ æˆ‘ä»¬åœ¨è¿½è¸ªluaæºç ï¼Œå¯ä»¥å‘ç°æ¯æ¬¡æ‰§è¡Œä¸€è¡ŒæŒ‡ä»¤éƒ½ä¼šå»ldebug.c å»è°ƒç”¨ luaG_traceexec å‡½æ•° è¿™ä¸ªå‡½æ•°éœ€è¦å’Œcountå‚æ•°é…åˆæ‰èƒ½å‘æŒ¥æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ L-\u0026gt;hookcount åœ¨ä¸€æ¬¡æ¬¡é€’å‡ä¹‹åç­‰äº 0 äº†å°±ä¼šè°ƒç”¨ luaD_hook å‡½æ•°\nç»¼åˆä¸Šè¿°æˆ‘ä»¬çœ‹åˆ°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°luaD_hook å‡½æ•°ï¼Œä»”ç»†çœ‹æºç è§‚å¯Ÿå¯ä»¥çœ‹åˆ°åœ¨ç»è¿‡ä¸€ç³»åˆ—åˆ¤æ–­ä»¥åä¼šå›è°ƒæˆ‘ä»¬è®¾ç½®å¥½çš„ L-\u0026gt;hook å‡½æ•°\nå›åˆ°æˆ‘ä»¬ç¬¬**2 **ä¸ªå‚æ•°\n/* Functions to be called by the debugger in specific events */ typedef void(*lua_Hook) (lua_State *L, lua_Debug *ar); å¯ä»¥çœ‹åˆ°è¿”å›äº†ä¸€ä¸ªlua_Debug ç»“æ„ä½“ æˆ‘ä»¬è¿›å…¥è¿™ä¸ªç»“æ„ä½“\nè¿™é‡Œä¸ºäº†å…¼å®¹æ¯ä¸ªä¸åŒçš„luaç‰ˆæœ¬ï¼Œå¼„äº†ä¸ª**union **è”åˆä½“ å†™åœ¨äº†lua_api_loder.hé‡Œé¢\næˆ‘ä»¬è¿›å…¥ lua_Debug_54 ç»“æ„ä½“é‡Œé¢\nå¯ä»¥å‘ç°è¿™é‡Œæœ‰è®¸å¤šçš„ä¿¡æ¯\nç»“æ„å˜é‡ è§£é‡Š event Event codes äº‹ä»¶ç±»å‹æ ‡è¯†å¦‚ä¸‹å‡ ç§ [LUA_HOOKCALL,LUA_HOOKRET,LUA_HOOKLINE,LUA_HOOKCOUNT,LUA_HOOKTAILCALL] name å‡½æ•°åå­— namewhat ä½œç”¨åŸŸçš„å«ä¹‰ï¼Œæ¯”å¦‚æ˜¯globalï¼Œlocalï¼Œmethodï¼Œfield æˆ–è€…\u0026quot;\u0026quot; \u0026ldquo;\u0026ldquo;ä»£è¡¨æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªå‡½æ•° what \u0026lt;span style=\u0026quot;display:inline-block;width: 600px\u0026quot;\u0026gt;å‡½æ•°çš„ç±»å‹ ä¸€èˆ¬ä¸º\u0026quot;lua\u0026rdquo; source å‡½æ•°å®šä¹‰çš„ä½ç½®ï¼Œå¦‚æœæ˜¯loadstringè½½å…¥çš„ï¼Œsourceæ˜¯string å¦‚æœæ˜¯åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­sourceæ ‡è¯†å¸¦æœ‰å‰ç¼€çš„@æ–‡ä»¶åå­— srclen sourceçš„é•¿åº¦ currentline å½“å‰å‡½æ•°æ‰€åœ¨çš„è¡Œ linedefined å‡½æ•°å®šä¹‰çš„é¦–è¡Œåœ°å€ \u0026lt;span style=\u0026quot;display:inline-block;width: 120px\u0026quot;\u0026gt; lastlinedefined å‡½æ•°å®šä¹‰çš„æœ€åä¸€è¡Œçš„è¡Œå· nups ä¸Šå€¼çš„ä¸ªæ•° nparams å‚æ•°æ•°é‡ isvararg æ˜¯ä¸æ˜¯å¯å˜å‚æ•° istailcall æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ å½¢å¦‚**function f(x) return g(x) end ** ftransfer ä¸ç¬¬ä¸€ä¸ªè½¬ç§»å€¼çš„åç§»é‡ ä¸»è¦ç”¨call/returnæ–¹å¼ ntransfer ä¼ è¾“çš„å€¼ ä¸»è¦ç”¨call/returnæ–¹å¼ short_src source çš„ç®€çŸ­è¡¨ç¤º i_ci è®°å½•ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¶‰åŠåˆ°çš„æ ˆå¼•ç”¨ï¼Œluaåœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™ä¼šæŠŠæ¯ä¸ªcallinfoç”¨åŒå‘é“¾è¡¨ä¸²èµ·æ¥ ç»¼åˆä¸Šè¿°åŸç†æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªlua_sethook è¢«è°ƒç”¨æ—¶å€™é€šè¿‡hookè¿”å›çš„ä¿¡æ¯æœ‰è¿™ä¹ˆå¤šï¼Œè€Œä¸”æ¯ä¸€ä¸ªlua_state éƒ½æ˜¯æ²™ç›’éš”ç¦»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ²™ç›’åŸç†ï¼Œé€šè¿‡åœ¨è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªdebuggerManagerçš„ç®¡ç†å™¨æŠŠæ‰€æœ‰ç”Ÿæˆçš„lua_stateçš„æŒ‡é’ˆä¿å­˜åœ¨è¿™ä¸ªç®¡ç†å™¨é‡Œé¢ï¼Œè¿™æ ·åœ¨æ¯æ¬¡luaè°ƒç”¨pcallæ‰§è¡Œè„šæœ¬çš„æ—¶å€™éƒ½ä¼šå»è§¦å‘è‡ªå·±ç›¸å¯¹åº”çš„lua_sethookè®¾ç½®çš„hookå‡½æ•°ï¼Œåœ¨é‡Œé¢è·å–å½“æ—¶è§¦å‘çš„æ—¶å€™çš„ä¸Šè¡¨è¿”å›çš„ä¿¡æ¯ï¼Œç„¶åç»™å®¢æœç«¯æ˜¾ç¤º\nluadebug å®ç°ä¿®æ”¹å˜é‡å€¼ é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªprotobufçš„cmdå‘½ä»¤\n**MessageCMD::SetVariableReq ** //ä¿®æ”¹å˜é‡\nå®¢æœç«¯è®¾ç½®å˜é‡é€»è¾‘\næœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚é€»è¾‘æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹\nç¬¬ä¸€æ­¥: å°†æ­¤luaå®šä¹‰check ç”¨luaL_dostring è¿›è¡Œloadæ‰§è¡Œ\nconst char* loadstr = \u0026#34;function dlua_setvarvalue (name, frame, val, level)\\n\u0026#34; \u0026#34; local found\\n\u0026#34; \u0026#34;\\n\u0026#34; \u0026#34; -- try local variables\\n\u0026#34; \u0026#34; local i = 1\\n\u0026#34; \u0026#34; while true do\\n\u0026#34; \u0026#34; local n, v = debug.getlocal(frame + level, i)\\n\u0026#34; \u0026#34; if not n then\\n\u0026#34; \u0026#34; break\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; if n == name then\\n\u0026#34; \u0026#34; debug.setlocal(frame + level, i, val)\\n\u0026#34; \u0026#34; found = true\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; i = i + 1\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; if found then\\n\u0026#34; \u0026#34; return true\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34;\\n\u0026#34; \u0026#34; -- try upvalues\\n\u0026#34; \u0026#34; local func = debug.getinfo(frame + level).func\\n\u0026#34; \u0026#34; i = 1\\n\u0026#34; \u0026#34; while true do\\n\u0026#34; \u0026#34; local n, v = debug.getupvalue(func, i)\\n\u0026#34; \u0026#34; if not n then\\n\u0026#34; \u0026#34; break\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; if n == name then\\n\u0026#34; \u0026#34; debug.setupvalue(func, i, val)\\n\u0026#34; \u0026#34; return true\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; i = i + 1\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34;\\n\u0026#34; \u0026#34; return false\\n\u0026#34; \u0026#34;end\u0026#34; \u0026#34;\u0026#34;; luaL_dostring(L, loadstr); å¦‚æœæ˜¯set a=1ç±»å‹\nstd::string loadstr = \u0026#34;if not dlua_setvarvalue(\\\u0026#34;\u0026#34; + val + \u0026#34;\\\u0026#34;,\u0026#34; + std::to_string(currentFrameId) + \u0026#34;,\u0026#34; + input + \u0026#34;, 3\u0026#34; + \u0026#34;) then\\n\u0026#34;; loadstr += val + \u0026#34;=\u0026#34; + input + \u0026#34;\\n\u0026#34;; loadstr += \u0026#34;end\\n\u0026#34;; int status = luaL_dostring(L, loadstr.c_str()); if (status != 0) { std::string ret = lua_tostring(L, -1); lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, ret.c_str()); return -1; } å¦‚æœæ˜¯set [t1] t1.a=1 ç±»å‹\nstd::string loadstr = \u0026#34;function dlua_set_val(\u0026#34;; for (auto it = inputval.begin(); it != inputval.end();) { loadstr = loadstr + it-\u0026gt;first; it++; if (it != inputval.end()) { loadstr = loadstr + \u0026#34;,\u0026#34;; } } loadstr = loadstr + \u0026#34;)\\n\u0026#34; + val + \u0026#34;=\u0026#34; + input + \u0026#34;\\n\u0026#34;; loadstr = loadstr + \u0026#34;return \u0026#34;; for (auto it = inputval.begin(); it != inputval.end();) { loadstr = loadstr + it-\u0026gt;first; it++; if (it != inputval.end()) { loadstr = loadstr + \u0026#34;,\u0026#34;; } } loadstr = loadstr + \u0026#34;\\n end\\n\u0026#34;; int status = luaL_dostring(L, loadstr.c_str()); if (status != 0) { std::string ret = lua_tostring(L, -1); lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, ret.c_str()); return -1; } lua_settop(L, oldn); lua_getglobal(L, \u0026#34;dlua_set_val\u0026#34;); if (!lua_isfunction(L, -1)) { lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, \u0026#34;get dlua_set_val fail\u0026#34;); return -1; } for (auto it = inputval.begin(); it != inputval.end(); it++) { if (!FindAndPushVal(L, it-\u0026gt;first, currentFrameId)) { lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, (std::string(\u0026#34;can not find val \u0026#34;) + it-\u0026gt;first).c_str()); return -1; } } int ret = lua_pcall(L, inputval.size(), inputval.size(), 0); if (ret != 0) { std::string ret = lua_tostring(L, -1); lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, ret.c_str()); return -1; } int index = -inputval.size(); for (auto it = inputval.begin(); it != inputval.end(); it++) { std::string name = it-\u0026gt;first; int curoldn = lua_gettop(L); lua_getglobal(L, \u0026#34;dlua_setvarvalue\u0026#34;); if (!lua_isfunction(L, -1)) { lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, \u0026#34;get dlua_setvarvalue fail\u0026#34;); return -1; } lua_pushstring(L, name.c_str()); lua_pushinteger(L,currentFrameId); lua_pushnil(L); lua_pushinteger(L, 2); lua_copy(L, index - 5, -2); ret = lua_pcall(L, 4, 1, 0); if (ret != 0) { std::string ret = lua_tostring(L, -1); lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, ret.c_str()); return -1; } bool suc = lua_toboolean(L, -1); if (!suc) { lua_settop(L, oldn); EmmyFacade::Get().SendLog(LogType::Error, (std::string(\u0026#34;dlua_setvarvalue set \u0026#34;) + name + \u0026#34; fail\u0026#34;).c_str()); return -1; } lua_settop(L, curoldn); index++; } å›¾ç‰‡æ•ˆæœ çœŸæœºè°ƒè¯• adb forward åŸç† è¦æƒ³çŸ¥é“æ€ä¹ˆçœŸæœºè°ƒè¯•æˆ‘ä»¬é¦–å…ˆåº”è¯¥çŸ¥é“adbè°ƒè¯•çš„åŸç†\næ¯”å¦‚æˆ‘ç°åœ¨è°ƒè¯•å®‰å“æ—¶å€™çš„ä½¿ç”¨çš„å‘½ä»¤: adb forward tcp:8888 tcp:9966\né€šè¿‡æ­¤ç«¯å£è½¬å‘æˆ‘ä»¬å°±å¯ä»¥åšåˆ°å§ç”µè„‘tcpç«¯å£çš„æ¶ˆæ¯è½¬å‘åˆ°çœŸæœºé‡Œé¢tcp9966ç«¯å£ä¸Š\næ¡ä»¶æ–­ç‚¹ æ¡ä»¶æ–­ç‚¹åˆ†ä¸º\n1ï¼šè¡¨è¾¾å¼ 2ï¼šå‘½ä¸­æ¬¡æ•°\n3ï¼šæ—¥å¿—æ–­ç‚¹\né¦–å…ˆéœ€è¦åœ¨æ­¤ç»“æ„ä¸­å®šä¹‰3ä¸ªå˜é‡ç”¨äºå¤„ç†3ä¸­ç±»å‹ï¼Œç„¶åé€šè¿‡vscodeè®¾ç½®æ¡ä»¶ç«¯ç‚¹ç±»å‹\néƒ¨åˆ†æ ¸å¿ƒä»£ç \nbool Debugger::ProcessBreakPoint(std::shared_ptr\u0026lt;BreakPoint\u0026gt; bp) { if (!bp-\u0026gt;condition.empty()) { auto ctx = std::make_shared\u0026lt;EvalContext\u0026gt;(); ctx-\u0026gt;expr = bp-\u0026gt;condition; ctx-\u0026gt;depth = 1; bool suc = DoEval(ctx); return suc \u0026amp;\u0026amp; ctx-\u0026gt;result-\u0026gt;valueType == LUA_TBOOLEAN \u0026amp;\u0026amp; ctx-\u0026gt;result-\u0026gt;value == \u0026#34;true\u0026#34;; } if (!bp-\u0026gt;logMessage.empty()) { DoLogMessage(bp); return false; } if (!bp-\u0026gt;hitCondition.empty()) { bp-\u0026gt;hitCount++; return DoHitCondition(bp); } return true; } bool Debugger::DoEval(std::shared_ptr\u0026lt;EvalContext\u0026gt; evalContext) { if (!currentL || !evalContext) { return false; } auto L = currentL; //auto* const L = L; // From \u0026#34;cacheId\u0026#34; if (evalContext-\u0026gt;cacheId \u0026gt; 0) { lua_getfield(L, LUA_REGISTRYINDEX, CACHE_TABLE_NAME); // 1: cacheTable|nil if (lua_type(L, -1) == LUA_TTABLE) { lua_getfield(L, -1, std::to_string(evalContext-\u0026gt;cacheId).c_str()); // 1: cacheTable, 2: value GetVariable(evalContext-\u0026gt;result, -1, evalContext-\u0026gt;depth); lua_pop(L, 2); return true; } lua_pop(L, 1); } // LOAD AS \u0026#34;return expr\u0026#34; std::string statement = \u0026#34;return \u0026#34;; statement.append(evalContext-\u0026gt;expr); int r = luaL_loadstring(L, statement.c_str()); if (r == LUA_ERRSYNTAX) { evalContext-\u0026gt;error = \u0026#34;syntax err: \u0026#34;; evalContext-\u0026gt;error.append(evalContext-\u0026gt;expr); return false; } // call const int fIdx = lua_gettop(L); // create env if (!CreateEnv(evalContext-\u0026gt;stackLevel)) return false; // setup env #ifndef EMMY_USE_LUA_SOURCE lua_setfenv(L, fIdx); #elif defined(EMMY_LUA_51) || defined(EMMY_LUA_JIT) lua_setfenv(L, fIdx); #else //52 \u0026amp; 53 lua_setupvalue(L, fIdx, 1); #endif assert(lua_gettop(L) == fIdx); // call function() return expr end r = lua_pcall(L, 0, 1, 0); if (r == LUA_OK) { evalContext-\u0026gt;result-\u0026gt;name = evalContext-\u0026gt;expr; GetVariable(evalContext-\u0026gt;result, -1, evalContext-\u0026gt;depth); lua_pop(L, 1); return true; } if (r == LUA_ERRRUN) { evalContext-\u0026gt;error = lua_tostring(L, -1); } return false; } void Debugger::DoLogMessage(std::shared_ptr\u0026lt;BreakPoint\u0026gt; bp) { std::string\u0026amp; logMessage = bp-\u0026gt;logMessage; // ä¸ºä»€ä¹ˆä¸ç”¨regex? // å› ä¸ºgcc 4.8 regexè¿˜æ˜¯ç©ºå®ç° // è€Œä¸”åç»­ç‰ˆæœ¬çš„gccä¸­æ­£åˆ™è¡¨è¾¾å¼è¡Œä¸ºä¼¼ä¹ä¹Ÿä¸å¤ªæ­£å¸¸ enum class ParseState { Normal, LeftBrace, RightBrace } state = ParseState::Normal; std::vector\u0026lt;LogMessageReplaceExpress\u0026gt; replaceExpresses; std::size_t leftBraceBegin = 0; std::size_t rightBraceBegin = 0; // å¦‚æœåœ¨è¡¨è¾¾å¼ä¸­å‡ºç°å·¦å¤§æ‹¬å· std::size_t exprLeftCount = 0; for (std::size_t index = 0; index != logMessage.size(); index++) { char ch = logMessage[index]; switch (state) { case ParseState::Normal: { if (ch == \u0026#39;{\u0026#39;) { state = ParseState::LeftBrace; leftBraceBegin = index; exprLeftCount = 0; } else if (ch == \u0026#39;}\u0026#39;) { state = ParseState::RightBrace; rightBraceBegin = index; } break; } case ParseState::LeftBrace: { if (ch == \u0026#39;{\u0026#39;) { // è®¤ä¸ºæ˜¯å·¦åŒå¤§æ‹¬å·è½¬ä¹‰ä¸ºå¯è§çš„\u0026#39;{\u0026#39; if (index == leftBraceBegin + 1) { replaceExpresses.emplace_back(\u0026#34;{\u0026#34;, leftBraceBegin, index, false); state = ParseState::Normal; } else { exprLeftCount++; } } else if (ch == \u0026#39;}\u0026#39;) { // è®¤ä¸ºæ˜¯è¡¨è¾¾å¼å†…çš„å¤§æ‹¬å· if (exprLeftCount \u0026gt; 0) { exprLeftCount--; continue; } replaceExpresses.emplace_back(logMessage.substr(leftBraceBegin + 1, index - leftBraceBegin - 1), leftBraceBegin, index, true); state = ParseState::Normal; } break; } case ParseState::RightBrace: { if (ch == \u0026#39;}\u0026#39; \u0026amp;\u0026amp; (index == rightBraceBegin + 1)) { replaceExpresses.emplace_back(\u0026#34;}\u0026#34;, rightBraceBegin, index, false); } else { //è®¤ä¸ºå·¦å³å¤§æ‹¬å·å¤±é…ï¼Œä¹‹å‰çš„ä¸åšå¤„ç†ï¼Œé€€æ ¼ä¸€ä½å›å»é‡æ–°åˆ¤æ–­ index--; } state = ParseState::Normal; break; } } } std::stringstream message; if (replaceExpresses.empty()) { message \u0026lt;\u0026lt; logMessage; } else { // æ‹¼æ¥å­—ç¬¦ä¸² // æ€ä¹ˆreplace å‡½æ•°éƒ½æ²¡æœ‰å•Š std::size_t start = 0; for (std::size_t index = 0; index != replaceExpresses.size(); index++) { auto\u0026amp; replaceExpress = replaceExpresses[index]; if (start \u0026lt; replaceExpress.StartIndex) { auto fragment = logMessage.substr(start, replaceExpress.StartIndex - start); message \u0026lt;\u0026lt; fragment; start = replaceExpress.StartIndex; } if (replaceExpress.NeedEval) { auto ctx = std::make_shared\u0026lt;EvalContext\u0026gt;(); ctx-\u0026gt;expr = std::move(replaceExpress.Expr); ctx-\u0026gt;depth = 1; bool succeed = DoEval(ctx); if (succeed) { message \u0026lt;\u0026lt; ctx-\u0026gt;result-\u0026gt;value; } else { message \u0026lt;\u0026lt; ctx-\u0026gt;error; } } else { message \u0026lt;\u0026lt; replaceExpress.Expr; } start = replaceExpress.EndIndex + 1; } if (start \u0026lt; logMessage.size()) { auto fragment = logMessage.substr(start, logMessage.size() - start); message \u0026lt;\u0026lt; fragment; } } std::string baseName = BaseName(bp-\u0026gt;file); EmmyFacade::Get().SendLog(LogType::Info, \u0026#34;[%s:%d] %s\u0026#34;, baseName.c_str(), bp-\u0026gt;line, message.str().c_str()); } bool Debugger::DoHitCondition(std::shared_ptr\u0026lt;BreakPoint\u0026gt; bp) { auto\u0026amp; hitCondition = bp-\u0026gt;hitCondition; enum class ParseState { ExpectedOperator, // å¤§äº Gt, // å°äº Le, // å•ç­‰å· Eq, ExpectedHitTimes, ParseDigit, ParseFinish } state = ParseState::ExpectedOperator; enum class Operator { // å¤§äº Gt, // å°äº Le, // å°äºç­‰äº LeEq, // å¤§äºç­‰äº GtEq, // åŒç­‰å· EqEq, } evalOperator = Operator::EqEq; unsigned long long hitTimes = 0; for (std::size_t index = 0; index != hitCondition.size(); index++) { char ch = hitCondition[index]; switch (state) { case ParseState::ExpectedOperator: { if (ch == \u0026#39; \u0026#39;) { continue; } if (ch == \u0026#39;=\u0026#39;) { state = ParseState::Eq; } else if (ch == \u0026#39;\u0026lt;\u0026#39;) { state = ParseState::Le; } else if (ch == \u0026#39;\u0026gt;\u0026#39;) { state = ParseState::Gt; } else { return false; } break; } case ParseState::Eq: { if (ch == \u0026#39;=\u0026#39;) { evalOperator = Operator::EqEq; state = ParseState::ExpectedHitTimes; } else { return false; } break; } case ParseState::Gt: { if (ch == \u0026#39;=\u0026#39;) { evalOperator = Operator::GtEq; state = ParseState::ExpectedHitTimes; } else if (isdigit(ch)) { evalOperator = Operator::Gt; hitTimes = ch - \u0026#39;0\u0026#39;; state = ParseState::ParseDigit; } else if (ch == \u0026#39; \u0026#39;) { evalOperator = Operator::Gt; state = ParseState::ExpectedHitTimes; } else { return false; } break; } case ParseState::Le: { if (ch == \u0026#39;=\u0026#39;) { evalOperator = Operator::LeEq; state = ParseState::ExpectedHitTimes; } else if (isdigit(ch)) { evalOperator = Operator::Le; hitTimes = ch - \u0026#39;0\u0026#39;; state = ParseState::ParseDigit; } else if (ch == \u0026#39; \u0026#39;) { evalOperator = Operator::Gt; state = ParseState::ExpectedHitTimes; } else { return false; } break; } case ParseState::ExpectedHitTimes: { if (ch == \u0026#39; \u0026#39;) { continue; } else if (isdigit(ch)) { hitTimes = ch - \u0026#39;0\u0026#39;; state = ParseState::ParseDigit; } else { return false; } break; } case ParseState::ParseDigit: { if (isdigit(ch)) { hitTimes = hitTimes * 10 + (ch - \u0026#39;0\u0026#39;); } else if (ch == \u0026#39; \u0026#39;) { state = ParseState::ParseFinish; } else { return false; } break; } case ParseState::ParseFinish: { if (ch == \u0026#39; \u0026#39;) { break; } else { return false; } break; } } } switch (evalOperator) { case Operator::EqEq: { return bp-\u0026gt;hitCount == hitTimes; } case Operator::Gt: { return bp-\u0026gt;hitCount \u0026gt; hitTimes; } case Operator::GtEq: { return bp-\u0026gt;hitCount \u0026gt;= hitTimes; } case Operator::Le: { return bp-\u0026gt;hitCount \u0026lt; hitTimes; } case Operator::LeEq: { return bp-\u0026gt;hitCount \u0026lt;= hitTimes; } } return false; } è§†é¢‘æ•ˆæœå±•ç¤º å¤šè™šæ‹Ÿæœºæµ‹è¯• linuxæµ‹è¯• çœŸæœºæµ‹è¯• æ’ä»¶ä¸‹è½½åœ°å€ é’ˆå¯¹skynetè¿™ç§å¾®æœå™¨æ¡†æ¶å’Œè‡ªå·±ä» 0å¼€å‘çš„frogå¾®æœåŠ¡æ¡†æ¶ç¼–å†™çš„luaè°ƒè¯•å™¨ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»vscodeå•†åº—è¿›è¡Œ\nä¸‹è½½ä½¿ç”¨ï¼Œæœ‰ä»»ä½•é—®é¢˜å¯ä»¥åŠ QQç§èŠ\n","permalink":"https://frog-game.github.io/posts/blog/vscode-lua-chajian/","summary":"luadebug å®ç°å¤šè™šæ‹ŸæœºåŸç† å…ˆä»luahookåŸç†è¯´èµ· åœ¨lua.h å½“ä¸­æˆ‘ä»¬æœ‰ lua_sethookå‡½æ•°æ¥ç»™ä»¬è®¾ç½®é’©å­ LUA_API void (lua_sethook) (lua_State *L, lua_Hook func, int mask, int count); lua_State *L :è™šæ‹Ÿæœº","title":"å¾®æœåŠ¡luaè°ƒè¯•å™¨"},{"content":"åœ¨service_snlua.c ä¸­å¢åŠ æ­¤å‡½æ•° void addLuaState(struct snlua *l,const char *debug_ip,const char * debug_port) { if (NULL == debug_ip) { return; } if (NULL == debug_port) { return; } int port = strtol(debug_port, NULL, 10); const char *lua_dofunction = \u0026#34;function snlua_addLuaState()\\n\u0026#34; \u0026#34;local dbg = require(\u0026#39;frog_debug\u0026#39;)\\n\u0026#34; \u0026#34;dbg.startDebugServer(\u0026#39;%s\u0026#39;, %d)\\n\u0026#34; \u0026#34;dbg.addLuaState()\\n\u0026#34; \u0026#34;end\u0026#34; \u0026#34;\u0026#34;; char loadstr[200]; sprintf(loadstr, lua_dofunction, debug_ip, port); int oldn = lua_gettop(l-\u0026gt;L); int status = luaL_dostring(l-\u0026gt;L, loadstr); if (status != 0) { const char *ret = lua_tostring(l-\u0026gt;L, -1); lua_settop(l-\u0026gt;L, oldn); skynet_error(l-\u0026gt;ctx, \u0026#34;[ERROR] addLuaState lua_tostring error!! err:%s\u0026#34;, ret); return; } lua_getglobal(l-\u0026gt;L, \u0026#34;snlua_addLuaState\u0026#34;); if (!lua_isfunction(l-\u0026gt;L, -1)) { const char *ret = lua_tostring(l-\u0026gt;L, -1); lua_settop(l-\u0026gt;L, oldn); skynet_error( l-\u0026gt;ctx, \u0026#34;[ERROR] addLuaState lua_getglobal addLuaState error!! err:%s\u0026#34;, ret); return; } status = lua_pcall(l-\u0026gt;L, 0, 0, 0); if (status != 0) { const char *ret = lua_tostring(l-\u0026gt;L, -1); lua_settop(l-\u0026gt;L, oldn); skynet_error(l-\u0026gt;ctx, \u0026#34;[ERROR] addLuaState lua_pcall addLuaState error!! err:%s\u0026#34;, ret); return; } } å°†addLuaStateå‡½æ•°æ’å…¥åˆ°service_snlua.cå¯¹åº”ä½ç½® static int init_cb(struct snlua *l, struct skynet_context *ctx, const char * args, size_t sz) { lua_State *L = l-\u0026gt;L; l-\u0026gt;ctx = ctx; lua_gc(L, LUA_GCSTOP, 0); lua_pushboolean(L, 1); /* signal for libraries to ignore env. vars. */ lua_setfield(L, LUA_REGISTRYINDEX, \u0026#34;LUA_NOENV\u0026#34;); luaL_openlibs(L); luaL_requiref(L, \u0026#34;skynet.profile\u0026#34;, init_profile, 0); int profile_lib = lua_gettop(L); // replace coroutine.resume / coroutine.wrap lua_getglobal(L, \u0026#34;coroutine\u0026#34;); lua_getfield(L, profile_lib, \u0026#34;resume\u0026#34;); lua_setfield(L, -2, \u0026#34;resume\u0026#34;); lua_getfield(L, profile_lib, \u0026#34;wrap\u0026#34;); lua_setfield(L, -2, \u0026#34;wrap\u0026#34;); lua_settop(L, profile_lib-1); lua_pushlightuserdata(L, ctx); lua_setfield(L, LUA_REGISTRYINDEX, \u0026#34;skynet_context\u0026#34;); luaL_requiref(L, \u0026#34;skynet.codecache\u0026#34;, codecache , 0); lua_pop(L,1); lua_gc(L, LUA_GCGEN, 0, 0); const char *path = optstring(ctx, \u0026#34;lua_path\u0026#34;,\u0026#34;./lualib/?.lua;./lualib/?/init.lua\u0026#34;); lua_pushstring(L, path); lua_setglobal(L, \u0026#34;LUA_PATH\u0026#34;); const char *cpath = optstring(ctx, \u0026#34;lua_cpath\u0026#34;,\u0026#34;./luaclib/?.so\u0026#34;); lua_pushstring(L, cpath); lua_setglobal(L, \u0026#34;LUA_CPATH\u0026#34;); const char *service = optstring(ctx, \u0026#34;luaservice\u0026#34;, \u0026#34;./service/?.lua\u0026#34;); lua_pushstring(L, service); lua_setglobal(L, \u0026#34;LUA_SERVICE\u0026#34;); const char *preload = skynet_command(ctx, \u0026#34;GETENV\u0026#34;, \u0026#34;preload\u0026#34;); lua_pushstring(L, preload); lua_setglobal(L, \u0026#34;LUA_PRELOAD\u0026#34;); lua_pushcfunction(L, traceback); assert(lua_gettop(L) == 1); const char * loader = optstring(ctx, \u0026#34;lualoader\u0026#34;, \u0026#34;./lualib/loader.lua\u0026#34;); int r = luaL_loadfile(L,loader); if (r != LUA_OK) { skynet_error(ctx, \u0026#34;Can\u0026#39;t load %s : %s\u0026#34;, loader, lua_tostring(L, -1)); report_launcher_error(ctx); return 1; } lua_pushlstring(L, args, sz); r = lua_pcall(L,1,0,1); if (r != LUA_OK) { skynet_error(ctx, \u0026#34;lua loader error : %s\u0026#34;, lua_tostring(L, -1)); report_launcher_error(ctx); return 1; } lua_settop(L,0); if (lua_getfield(L, LUA_REGISTRYINDEX, \u0026#34;memlimit\u0026#34;) == LUA_TNUMBER) { size_t limit = lua_tointeger(L, -1); l-\u0026gt;mem_limit = limit; skynet_error(ctx, \u0026#34;Set memory limit to %.2f M\u0026#34;, (float)limit / (1024 * 1024)); lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, \u0026#34;memlimit\u0026#34;); } lua_pop(L, 1); addLuaState(l, optstring(ctx, \u0026#34;debug_ip\u0026#34;, NULL), optstring(ctx, \u0026#34;debug_port\u0026#34;, NULL));//è°ƒç”¨å‡½æ•°æ”¾åˆ°è¿™é‡Œ lua_gc(L, LUA_GCRESTART, 0); return 0; } é‡ç¼–skynetä»£ç  cd skynet make linux MALLOC_STATICLIB= SKYNET_DEFINES=-DNOUSE_JEMALLOC ä¸‹è½½frog_debug.so cd luaclib wget https://github.com/frog-game/frog_debugger/releases/download/1.3.1/linux-x64.zip unzip linux-x64.zip chmod 777 frog_debug.so rm -rf linux-x64.zip åœ¨configé‡Œé¢åŠ ä¸Šä¸¤ä¸ªå­—æ®µ debug_ip = \u0026#34;10.5.32.10\u0026#34; //è¿™ä¸ªæ¢æˆä½ æœåŠ¡å™¨çš„åœ°å€ï¼Œå¦‚æœæœåŠ¡å™¨åœ¨è™šæ‹Ÿæœºé‡Œé¢è®°å¾—NATè½¬å‘ä½ è™šæ‹Ÿæœºçš„åœ°å€ï¼Œç„¶åç”¨ä½ è£…è™šæ‹Ÿæœºçš„PCæœ¬åœ°åœ°å€ debug_port = \u0026#34;9969\u0026#34; è™šæ‹Ÿæœºnatè½¬æ¢æŒ‡å¯¼ åˆ›å»º.jsonæ–‡ä»¶ { // ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ // æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚ // æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387 \u0026#34;version\u0026#34;: \u0026#34;0.2.0\u0026#34;, \u0026#34;configurations\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;lua_new\u0026#34;, \u0026#34;request\u0026#34;: \u0026#34;launch\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Lua New Debug\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;10.5.32.10\u0026#34;, \u0026#34;port\u0026#34;: 9966, \u0026#34;ext\u0026#34;: [ \u0026#34;.lua\u0026#34;, \u0026#34;.lua.txt\u0026#34;, \u0026#34;.lua.bytes\u0026#34; ], \u0026#34;ideConnectDebugger\u0026#34;: true } ] } åˆ°skynet exampleså¯åŠ¨skynetå·¥ç¨‹ ç›´æ¥åœ¨æ­¤ç›®å½•æ‰§è¡Œ\nå¦‚æœå«Œå¼ƒéº»çƒ¦,å¯ä»¥åœ¨githubç›´æ¥ä¸‹è½½exampleç„¶åæŒ‰å¦‚ä¸‹å›¾æ‰§è¡Œ ./skynet examples/config è°ƒè¯•å±•ç¤º ","permalink":"https://frog-game.github.io/posts/tech/vscode-chajian-zhidao/","summary":"åœ¨service_snlua.c ä¸­å¢åŠ æ­¤å‡½æ•° void addLuaState(struct snlua *l,const char *debug_ip,const char * debug_port) { if (NULL == debug_ip) { return; } if (NULL == debug_port) { return; } int port = strtol(debug_port, NULL, 10); const char *lua_dofunction = \u0026#34;function snlua_addLuaState()\\n\u0026#34; \u0026#34;local dbg = require(\u0026#39;frog_debug\u0026#39;)\\n\u0026#34; \u0026#34;dbg.startDebugServer(\u0026#39;%s\u0026#39;, %d)\\n\u0026#34; \u0026#34;dbg.addLuaState()\\n\u0026#34; \u0026#34;end\u0026#34; \u0026#34;\u0026#34;; char loadstr[200]; sprintf(loadstr,","title":"skynet-blueprint-debug luaå¤šè™šæ‹Ÿæœºè°ƒè¯•"},{"content":" æ¼”ç¤º\nå®‰è£…ç¯å¢ƒ ç‰ˆæœ¬ Ubuntu 20.04 zabbix 6.0 mysql 8.0 Ubuntu20.04+mysql8.0+zabbix6.0+elk+filebeat+logstash+grafana\nzabbix 6.0 é˜¿é‡Œäº‘é•œåƒåœ°å€ https://mirrors.aliyun.com/zabbix/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/ ä¸‹è½½ zabbix sudo wget https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-1+ubuntu20.04_all.deb sudo dpkg -i zabbix-release_6.0-1+ubuntu20.04_all.deb sudo apt update å®‰è£…Zabbix serverï¼ŒWebå‰ç«¯ï¼Œagent sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-sql-scripts zabbix-agent åˆ›å»ºåˆå§‹æ•°æ®åº“ mysql -uroot -p123456 mysql\u0026gt; create database zabbix character set utf8mb4 collate utf8mb4_bin; mysql\u0026gt; create user zabbix@`%` identified by \u0026#39;123456\u0026#39;; mysql\u0026gt; grant all privileges on zabbix.* to zabbix@`%`; mysql\u0026gt; quit; å¯¼å…¥åˆå§‹æ¶æ„å’Œæ•°æ®ï¼Œç³»ç»Ÿå°†æç¤ºæ‚¨è¾“å…¥æ–°åˆ›å»ºçš„å¯†ç [é»˜è®¤å¯†ç ç°åœ¨è®¾ç½®ä¸º 123456 zcat /usr/share/doc/zabbix-sql-scripts/mysql/server.sql.gz | mysql -uzabbix -p -h10.40.38.67 zabbix # æŒ‡å®šæœ¬åœ°çš„IPåœ°å€ï¼Œä¸é»˜è®¤å°±ä¼šæŒ‡å‘æœ¬åœ°localhost å¦‚æœæŠ¥ERROR 2003 (HY000): Can't connect to MySQL server on '10.40.38.67:3306' (111) çœ‹ç¬¬5ç« mysqlæ“ä½œæŒ‡å¯¼ï¼Œå¤šåŠæ˜¯å› ä¸ºæƒé™å’Œå¯†ç é—®é¢˜\nä¸ºZabbix serveré…ç½®æ•°æ®åº“ sudo vim /etc/zabbix/zabbix_server.conf ä¿®æ”¹ DBPassword=123456 å¯åŠ¨Zabbix serverå’Œagentè¿›ç¨‹ sudo systemctl restart zabbix-server zabbix-agent apache2 grafana-server sudo systemctl enable zabbix-server zabbix-agent apache2 grafana-server è¿æ¥webå‰ç«¯[10.40.38.67 æ¢æˆä½ çš„ipåœ°å€] [ç”¨è°·æ­Œæµè§ˆå™¨æˆ–è€…microsoft Edgeæµè§ˆå™¨æ‰“å¼€] http://10.40.38.67/zabbix é»˜è®¤çš„ç”¨æˆ·åæ˜¯Admin(Aæ˜¯å¤§å†™)ï¼ŒPasswordï¼šzabbix ä¿®æ”¹æ—¶åŒº sudo vi /etc/apache2/conf-enabled/zabbix.conf ä¿®æ”¹æ ‡å‡†æ—¶åŒºä¸º Asia/Shanghai ä¸­æ–‡æ˜¾ç¤º sudo apt install language-pack-zh-hans #å®‰è£…ä¸­æ–‡è¯­è¨€åŒ… sudo vim /etc/locale.gen #æ‰¾åˆ°zh_CN.UTF-8 UTF-8 å¹¶å–æ¶ˆ#å·æ³¨é‡Šï¼Œç„¶åä¿å­˜å¹¶é€€å‡º sudo locale-gen #ç¼–è¯‘è¯­è¨€åŒ… sudo vim /etc/default/locale #ä¿®æ”¹é»˜è®¤è¯­è¨€ä¸ºä¸­æ–‡ï¼Œå°†åŸæ¥çš„å†…å®¹æ”¹ä¸º LANG=zh_CN.UTF-8 å®‰è£…å‡ºç°çš„é—®é¢˜ Minimum required size of PHP post is 16M (configuration option \u0026ldquo;post_max_size\u0026rdquo;). è§£å†³æ­¥éª¤ï¼š\nsudo vi /etc/php/8.1/apache2/php.ini post_max_size8M 16M\nmax_execution_time30 300\nmax_input_time60 300\ndate.timezone = Asia/Shanghai\nsudo systemctl restart zabbix-server zabbix-agent apache2 grafana-server ERROR 1396 (HY000): Operation CREATE USER failed for 'zabbix'@'%' mysql\u0026gt; create user zabbix@`%` identified by \u0026#39;123456\u0026#39;; ERROR 1396 (HY000): Operation CREATE USER failed for \u0026#39;zabbix\u0026#39;@\u0026#39;%\u0026#39; åŸå› åˆ†æï¼š\nå·²ç»å­˜åœ¨äº†zabbixç”¨æˆ· åœ¨æ‰§è¡Œåˆ é™¤zabbixç”¨æˆ·çš„æ—¶å€™æ²¡æœ‰åˆ é™¤å¹²å‡€ è§£å†³æ–¹æ³•ï¼š\né‡æ–°è¿›è¡Œåˆ é™¤ã€‚\ndrop user zabbix@\u0026#39;%\u0026#39;; flush privileges; å¸è½½ zabbix åˆ é™¤è½¯ä»¶\nsudo apt-get --purge remove zabbix-server-mysql -y sudo apt-get autoremove zabbix-server-mysql -y sudo apt-get --purge remove zabbix-frontend-php -y sudo apt-get autoremove zabbix-frontend-php -y sudo apt-get --purge remove abbix-apache-conf -y sudo apt-get autoremove abbix-apache-conf -y sudo apt-get --purge remove zabbix-agent -y #åˆ é™¤è½¯ä»¶å…¶é…ç½® sudo apt-get autoremove zabbix-agent -y #åˆ é™¤è½¯ä»¶ä¾èµ–åŒ… æ¸…ç†æ•°æ®\nsudo dpkg -l |grep ^rc|awk \u0026#39;{print $2}\u0026#39; |sudo xargs dpkg -P åˆ é™¤ä»¥ä¸Šapt-getä¸‹è½½çš„è½¯ä»¶åŒ…\nsudo apt-get autoclean åˆ é™¤ç¼“å­˜çš„æ‰€æœ‰è½¯ä»¶åŒ…\nsudo apt-get clean åˆ é™¤å…¶ä»–è½¯ä»¶ä¾èµ–çš„ä½†ç°åœ¨å·²ä¸ç”¨çš„è½¯ä»¶åŒ…ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰\nsudo apt-get autoremove æŸ¥è¯¢å‡ºå†—ä½™æ–‡ä»¶å¹¶åˆ é™¤\nsudo find / -name zabbix æ‰§è¡Œrm-rf åˆ é™¤å†—ä½™æ–‡ä»¶\nsudo rm -rf /run/zabbix sudo rm -rf /etc/zabbix sudo rm -rf /usr/share/zabbix sudo rm -rf /var/log/zabbix sudo rm -rf /var/lib/mysql/zabbix åˆ é™¤åŒ…å«zabbixå…³é”®å­—çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹\nsudo find / -name \u0026#34;zabbix*\u0026#34; | sudo xargs rm -rf grafana ä¸‹è½½grafana debå®‰è£…åŒ… sudo apt-get install -y adduser libfontconfig1 sudo wget https://dl.grafana.com/enterprise/release/grafana-enterprise_8.5.4_amd64.deb sudo dpkg -i grafana-enterprise_8.5.4_amd64.deb å¯åŠ¨grafana-server sudo systemctl restart grafana-server sudo systemctl enable grafana-server å®‰è£…zabbixæ’ä»¶ grafana-cli plugins list-remote sudo grafana-cli plugins install alexanderzobnin-zabbix-app #é‡å¯grafana-server sudo systemctl restart grafana-server ä¹Ÿå¯ä»¥åœ¨grafana-\u0026gt;pluginsè¿™é‡Œå®‰è£…\nç™»å½•grafanaæœåŠ¡å™¨[10.40.38.67 æ¢æˆä½ çš„ipåœ°å€] [ç”¨è°·æ­Œæµè§ˆå™¨æˆ–è€…microsoft Edgeæµè§ˆå™¨æ‰“å¼€] http:/10.40.38.67:3000/ #é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸ºadminã€admin grafana é…ç½®zabbixæ•°æ®æº grafana é…ç½®zabbixç›‘æ§é¢æ¿ åœ¨ç‚¹å‡»å®Œnew dashboard æŒ‰é’®ä»¥å æŒ‰ctrl + s ä¿å­˜ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„ä»ªè¡¨ç›˜\ngrafanaå¢åŠ ä¸»é¢˜ å®‰è£…æ’ä»¶ï¼šgrafana-cli plugins install yesoreyeram-boomtheme-panel grafanaä¸»é¢˜åœ°å€ï¼šhttps://github.com/charles1503/grafana-theme/tree/master/CSS/themes/grafanas grafanaæ›´æ”¹ä¸»é¢˜æ•™ç¨‹ï¼šhttps://www.bilibili.com/read/cv7004400 è§†é¢‘æ•™ç¨‹ï¼šhttps://cloud.tencent.com/developer/video/11330 http://10.40.38.67:3000/public/themes/aquamarine.css å…·ä½“æ“ä½œæ­¥éª¤ï¼š\nåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç”¨äºå­˜æ”¾ä¸‹è½½å¯¹åº”ä¸»é¢˜çš„cssæ–‡ä»¶\nsudo mkdir /usr/share/grafana/public/themes/ cd /usr/share/grafana/public/themes/ ä½¿ç”¨ä¸€ä¸ªfor å¾ªç¯ä¸‹è½½å¯¹åº”çš„æ‰€æœ‰ä¸»é¢˜cssæ–‡ä»¶\nfor f in grafana-base.css aquamarine.css hotline.css dark.css plex.css space-gray.css organizr-dashboard.css;do wget https://raw.githubusercontent.com/505384662/grafana-theme/master/CSS/themes/grafana/$f;done ä¸ºGrafanaå®‰è£…ç¤¾åŒºæ’ä»¶Boom Theme\nsudo grafana-cli plugins install yesoreyeram-boomtheme-panel sudo systemctl restart grafana-server åœ¨Dashboardä¸­æ·»åŠ Boom Theme\ngrafana ä¸»é¢˜ä¿®æ”¹åœ°å€ cd /usr/share/grafana/public/themes grafana åŠ æ—¶é’Ÿ grafana-cli plugins install grafana-clock-panel systemctl restart grafana-server grafana flowchartingå®‰è£… sudo grafana-cli plugins install agenty-flowcharting-panel sudo systemctl restart grafana-server grafana ä¿®æ”¹æ¨¡æ¿åœ°å€ https://grafana.com/grafana/dashboards zabbix ä¿®æ”¹é…ç½®åœ°å€ï¼šhttp://192.168.70.130/zabbix/setup.php zabbix å±•ç¤ºåœ°å€ï¼šhttp://192.168.70.130/zabbix/zabbix.php?action=dashboard.view grafana å±•ç¤ºåœ°å€: http://192.168.70.130:3000/d/tYxzFya7z/test_zabbix?orgId=1 Grafana åŒ¿åè®¿é—®ï¼ˆå…ç™»å½•ï¼‰ ä¿®æ”¹Grafanaé…ç½®æ–‡ä»¶\nåœ¨Grafanaçš„é…ç½®æ–‡ä»¶ /etc/grafana/grafana.ini ä¸­ï¼Œæ‰¾åˆ° [auth.anonymous] é…ç½®å—ï¼Œå°†å…¶ä¸‹çš„åŒ¿åè®¿é—®æ§åˆ¶ enabled è®¾ç½®ä¸º trueï¼Œç»„ç»‡æƒé™è®¾ç½®ä¸º Viewer\nViewer:**åªè¯»**æ¨¡å¼\nEditor:**å¯ç¼–è¾‘**æ¨¡å¼\nAdmin:**ç®¡ç†å‘˜**æ¨¡å¼\n#################################### Anonymous Auth ###################### # Set to true to disable (hide) the login form, useful if you use OAuth, defaults to false disable_login_form = true [auth.anonymous] # enable anonymous access enabled = true # specify organization name that should be used for unauthenticated users org_name = Main Org. # specify role for unauthenticated users org_role = Viewer é‡å¯GrafanaæœåŠ¡\nä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ï¼Œé‡å¯GrafanaæœåŠ¡ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š\nsudo systemctl restart grafana-server å¸è½½ grafana æŸ¥æ‰¾åˆ°å®‰è£…è½¯ä»¶å\nsudo dpkg -l | grep grafana åˆ é™¤è½¯ä»¶\nsudo dpkg -r grafana-enterprise æŸ¥è¯¢å‡ºå†—ä½™æ–‡ä»¶å¹¶åˆ é™¤\nfind / -name grafana ç”¨rm-rf å‘½ä»¤åˆ é™¤\nrm -rf /etc/grafana rm -rf /usr/share/grafana rm -rf /usr/share/grafana/public/themes/grafana-theme/CSS/themes/grafana rm -rf /var/log/grafana rm -rf /var/lib/grafana apache2 apache2å¯åŠ¨æŠ¥é”™ å¤§è‡´æ„æ€æ²¡æœ‰å¯¼å…¥apache ç¯å¢ƒå˜é‡ è§£å†³åŠæ³•:\nsource /etc/apache2/envvars è¿˜æ˜¯æŠ¥é”™\nå¤§è‡´æ„æ€æ˜¯80ç«¯å£è¢«å ç”¨äº† æˆ‘é€‰æ‹©çš„æ–¹æ³•æ˜¯killå ç”¨è¿›ç¨‹åœ¨é‡å¯\nroot@hls:/root# netstat -lnp|grep 80 tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 950/nginx: master p tcp6 0 0 :::80 :::* LISTEN 950/nginx: master p unix 2 [ ACC ] STREAM LISTENING 41930 1228/zabbix-plugin_ /tmp/plugin835680808 root@hls:/root# kill -9 950 root@hls:/root# systemctl restart zabbix-server zabbix-agent apache2 å¸è½½apache2 åˆ é™¤è½¯ä»¶\n//1. åˆ é™¤apache sudo apt-get --purge remove apache2 sudo apt-get --purge remove apache2.2-common //2.æ‰¾åˆ°æ²¡æœ‰åˆ é™¤æ‰çš„é…ç½®æ–‡ä»¶ï¼Œä¸€å¹¶åˆ é™¤ sudo find /etc -name \u0026#34;*apache*\u0026#34; |xargs rm -rf sudo rm -rf /var/www sudo rm -rf /etc/libapache2-mod-jk //3.åˆ é™¤å…³è”ï¼Œè¿™æ ·å°±å¯ä»¥å†æ¬¡ç”¨apt-get install apache2 é‡è£…äº† #dpkg -l |grep apache2|awk \u0026#39;{print $2}\u0026#39;|xargs dpkg -P//æ³¨æ„ï¼šè¿™ä¸€æ­¥å¯èƒ½ä¼šæŠ¥é”™ï¼Œä½†ä¹Ÿæ²¡å…³ç³» æŸ¥è¯¢å‡ºå†—ä½™æ–‡ä»¶å¹¶åˆ é™¤\nsudo find / -name apache2 ç”¨rm -rf å‘½ä»¤åˆ é™¤\nNginx å®˜ç½‘ä¸‹è½½åœ°å€ http://nginx.org/en/download.html ä¸€äº›ç¯å¢ƒå‡†å¤‡ å®‰è£…ç¼–è¯‘å·¥å…·\nsudo apt-get install build-essential å®‰è£…ç¼–è¯‘å·¥å…· å®‰è£…gccä»€ä¹ˆçš„å¥½ä¾¿äºä¸‹é¢ç¼–è¯‘å®‰è£… å®‰è£…pcreåŒ…\nsudo apt-get update sudo apt-get install libpcre3 libpcre3-dev sudo apt-get install openssl libssl-dev å®‰è£… zlib åº“\nsudo apt install zlib1g-dev ä¸‹è½½å®‰è£…Nginx sudo wget http://nginx.org/download/nginx-1.21.6.tar.gz sudo tar -xzvf nginx-1.21.6.tar.gz cd nginx-1.21.6 sudo ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-stream --with-mail=dynamic #æœ€å¥½ç”¨ --prefixæŒ‡å®šè·¯å¾„ï¼Œä¾¿äºåé¢åˆ é™¤[åªéœ€è¦åˆ é™¤prefixæŒ‡å®šçš„æ–‡ä»¶å¤¹å°±è¡Œäº†]ï¼Œä¸æŒ‡å®šçš„è¯åé¢åˆ é™¤æ¯”è¾ƒéº»çƒ¦ sudo make sudo make install åˆ¶ä½œè½¯è¿æ¥ ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin/ é…ç½®ç¯å¢ƒå˜é‡ ç¼–è¾‘/etc/profileå¹¶ä¸”è¿½åŠ Nginxçš„ç¯å¢ƒå˜é‡ # nginx export NGINX_HOME=/usr/local/nginx export PATH=$PATH:$NGINX_HOME/sbin ç”Ÿæ•ˆç¯å¢ƒå˜é‡ source /etc/profile æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ nginx -v å¯åŠ¨Nginx sudo nginx å¼ºåˆ¶åœæ­¢Nginx sudo pkill -9 nginx æŸ¥çœ‹Nginxè¿›ç¨‹ ps aux|grep nginx é…ç½®é˜²ç«å¢™ sudo ufw allow \u0026#39;Nginx Full\u0026#39; éªŒè¯é˜²ç«å¢™æ˜¯å¦å…è®¸ å‡ºç°ä¸‹é¢ä¸¤ç§æƒ…å†µéƒ½è®¤ä¸ºå¯ä»¥ Status: active To Action From -- ------ ---- 22/tcp ALLOW Anywhere Nginx Full ALLOW Anywhere 22/tcp (v6) ALLOW Anywhere (v6) Nginx Full (v6) ALLOW Anywhere (v6) sudo ufw status çŠ¶æ€ï¼šä¸æ´»åŠ¨ æµ‹è¯•è®¿é—® http://192.168.70.132:7000 Nginx ç›¸å…³æ–‡ä»¶ä½ç½® nginx path prefix: \u0026#34;/usr/local/nginx\u0026#34; nginx binary file: \u0026#34;/usr/local/nginx/sbin/nginx\u0026#34; nginx modules path: \u0026#34;/usr/local/nginx/modules\u0026#34; nginx configuration prefix: \u0026#34;/usr/local/nginx/conf\u0026#34; nginx configuration file: \u0026#34;/usr/local/nginx/conf/nginx.conf\u0026#34; nginx pid file: \u0026#34;/usr/local/nginx/logs/nginx.pid\u0026#34; nginx error log file: \u0026#34;/usr/local/nginx/logs/error.log\u0026#34; nginx http access log file: \u0026#34;/usr/local/nginx/logs/access.log\u0026#34; nginx http client request body temporary files: \u0026#34;client_body_temp\u0026#34; nginx http proxy temporary files: \u0026#34;proxy_temp\u0026#34; nginx http fastcgi temporary files: \u0026#34;fastcgi_temp\u0026#34; nginx http uwsgi temporary files: \u0026#34;uwsgi_temp\u0026#34; nginx http scgi temporary files: \u0026#34;scgi_temp\u0026#34; å¸è½½ Nginx sudo rm -rf /usr/local/nginx sudo rm -rf /usr/local/nginx/sbin/nginx #è½¯è¿æ¥ä¹Ÿè®°å¾—åˆ é™¤ å¦‚æœæƒ³å®Œå…¨å¹²å‡€ï¼Œ/etc/profile é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ç¯å¢ƒå˜é‡ä¹Ÿå¯ä»¥åˆ é™¤ mysql å®‰è£…mysql sudo apt update sudo apt install mysql-server å®‰è£…å®Œæˆåï¼ŒMySQLæœåŠ¡å°†è‡ªåŠ¨å¯åŠ¨ã€‚è¦éªŒè¯MySQLæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œè¯·è¾“å…¥ï¼š\nsudo systemctl status mysql å½»åº•å¸è½½mysqlæ–¹æ³• æŸ¥çœ‹ä¾èµ–åŒ…\ndpkg --list | grep mysql å…ˆä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤\nsudo apt-get remove mysql-common sudo apt-get autoremove --purge mysql-server-5.0 # å¸è½½ MySQL 5.x ä½¿ç”¨, é5.xç‰ˆæœ¬å¯è·³è¿‡è¯¥æ­¥éª¤ sudo apt-get autoremove --purge mysql-server ç„¶åå†ç”¨\ndpkg --list | grep mysql æŸ¥çœ‹ä¸€ä¸‹ä¾èµ–åŒ…æœ€åç”¨ä¸‹é¢å‘½ä»¤æ¸…é™¤æ®‹ç•™æ•°æ®\ndpkg -l |grep ^rc|awk \u0026#39;{print $2}\u0026#39; |sudo xargs dpkg -P æŸ¥çœ‹ä»MySQL APTå®‰è£…çš„è½¯ä»¶åˆ—è¡¨, æ‰§è¡Œåæ²¡æœ‰æ˜¾ç¤ºåˆ—è¡¨, è¯æ˜MySQLæœåŠ¡å·²å®Œå…¨å¸è½½\ndpkg -l | grep mysql | grep i åšå®¢åœ°å€\nhttps://blog.csdn.net/PY0312/article/details/89481421 MySQLåœ¨Ubuntuä¸Šå¯åŠ¨å‡ºé”™Could not open â€˜abstractions/mysqlâ€˜ rm -rf /etc/apparmor.d/abstractions/mysql rm -rf /etc/apparmor.d/cache/usr.sbin.mysqld find / -name \u0026#39;mysql*\u0026#39; -exec rm -rf {} \\; è¿æ¥MySqlæŠ¥é”™â€œcan\u0026rsquo;t connect to local mysql server through socket \u0026lsquo;/var/run/mysqld/mysqld.sock\u0026rsquo; cd /etc/init.d sudo service mysql stop sudo service mysql start mysql Ubuntu 20.04 Access denied for user \u0026lsquo;root\u0026rsquo;@\u0026rsquo;localhost é¦–å…ˆè¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ è·å–å¯†ç ï¼š\nsudo cat /etc/mysql/debian.cnf å†è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤è¿›å…¥mysql\næŸ¥è¯¢userå…³é”®å­—æ®µ\nselect user, authentication_string,plugin,Host from mysql.user; ä¿®æ”¹å¯†ç æ ¼å¼\nuse mysql; update user set plugin=\u0026#39;mysql_native_password\u0026#39; where user=\u0026#39;root\u0026#39;; flush privileges; ä¿®æ”¹å¯†ç \nuse mysql; ALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED WITH mysql_native_password BY \u0026#39;123456\u0026#39;; flush privileges; è¾“å…¥\nmysql -uroot -p123456; æŸ¥çœ‹æ•ˆæœ\nè®©åˆ«çš„ipèƒ½è¿ä¸Šwslæ•°æ®åº“\nuse mysql; update user set Host=\u0026#39;%\u0026#39; where user=\u0026#39;root\u0026#39;; flush privileges; è¾“å…¥\nselect user, authentication_string,plugin,Host from mysql.user; æŸ¥çœ‹æ•ˆæœ\nå¼€å¯è¿œç¨‹è®¿é—®\nsudo vi /etc/mysql/mysql.conf.d/mysqld.cnf # æ³¨é‡Š bind-address = 127.0.0.1 é‡å¯mysql\nsudo service mysql restart æ•ˆæœ\nELK ä¸€äº›å‡†å¤‡ å®˜ç½‘åœ°å€ https://www.elastic.co/guide/en/elasticsearch/reference/8.0/deb.html#deb-repo è™šæ‹Ÿæœº æƒ³è¦å¤šå¼€æœ€å¥½æ˜¯å…‹éš†ä¸€ä»½å‡ºæ¥ æ¯”å¦‚2å°±æ˜¯å…‹éš†çš„1çš„é•œåƒ\nä¿®æ”¹ å…‹éš†çš„è™šæ‹Ÿæœºç½‘å¡åœ°å€\nsudo vim /etc/netplan/00-installer-config.yaml ä¿®æ”¹å†…å®¹:\nnetwork: ethernets: ens33: #é…ç½®çš„ç½‘å¡çš„åç§° addresses: [192.168.70.130/24] #é…ç½®çš„é™æ€ipåœ°å€å’Œæ©ç  dhcp4: no #å…³é—­DHCPï¼Œå¦‚æœéœ€è¦æ‰“å¼€DHCPåˆ™å†™yes optional: true gateway4: 192.168.70.2 #ç½‘å…³åœ°å€ nameservers: addresses: [192.168.70.2,114.114.114.114] #DNSæœåŠ¡å™¨åœ°å€ï¼Œå¤šä¸ªDNSæœåŠ¡å™¨åœ°å€éœ€è¦ç”¨è‹±æ–‡é€—å·åˆ†éš”å¼€ version: 2 renderer: networkd #æŒ‡å®šåç«¯é‡‡ç”¨systemd-networkdæˆ–è€…Network Managerï¼Œå¯ä¸å¡«å†™åˆ™é»˜è®¤ä½¿ç”¨systemd-workd ä½¿é…ç½®ç”Ÿæ•ˆ\nsudo netplan apply æ³¨æ„äº‹é¡¹\n1ã€ipåœ°å€å’ŒDNSæœåŠ¡å™¨åœ°å€éœ€è¦ç”¨[]æ‹¬èµ·æ¥ï¼Œä½†æ˜¯ç½‘å…³åœ°å€ä¸éœ€è¦ 2ã€æ³¨æ„æ¯ä¸ªå†’å·åè¾¹éƒ½è¦å…ˆåŠ ä¸€ä¸ªç©ºæ ¼ 3ã€æ³¨æ„æ¯ä¸€å±‚å‰è¾¹çš„ç¼©è¿›ï¼Œè‡³å°‘æ¯”ä¸Šä¸€å±‚å¤šä¸¤ä¸ªç©ºæ ¼ å®‰è£…javaç¯å¢ƒ å®‰è£…java\nsudo apt install openjdk-8-jdk æŸ¥çœ‹java ç‰ˆæœ¬\nsudo java -version æŸ¥çœ‹ java è·¯å¾„\nsudo which java ls -l /usr/bin/java çœ‹çœ‹è¿™æ˜¯å¦æ˜¯ä¸ªè½¯è¿æ¥ï¼Œæ‰¾å‡ºè¿™ä¸ªè½¯è¿æ¥æŒ‡å‘çš„è·¯å¾„\nls -l /usr/bin/java çš„ç¡®ä¸ºè½¯è¿æ¥ï¼Œç»§ç»­å¾€ä¸‹æ‰¾æŒ‡å‘çš„è·¯å¾„\nè‡³æ­¤ï¼Œjava çš„å®‰è£…è·¯å¾„å³ä¸º /usr/lib/jvm/java-11-openjdk-amd64/bin/java\né…ç½® java ç¯å¢ƒ\nsudo vim /etc/profile åœ¨å¼¹å‡ºçš„ vim ç¼–è¾‘å™¨ä¸­è¾“å…¥\n# JAVA JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64 PATH=$JAVA_HOME/bin:$PATH export JAVA_HOME PATH esc é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œè¾“å…¥ :xåï¼Œå•å‡»å›è½¦é€€å‡ºã€‚\nåœ¨ç»ˆç«¯è¾“å…¥\nsource /etc/profile ä½¿ä¹‹å‰çš„é…ç½®ç”Ÿæ•ˆã€‚\néªŒè¯\njava -version\n$JAVA_HOME/bin/java -version\npython3 [ä¸æ˜¯å¿…é¡»è£…ä¸»è¦æ˜¯æƒ³ä½¿ç”¨ json.tool æ ¼å¼åŒ–è¾“å‡º]\nå®‰è£…python3.8\nsudo apt-get install python3.8 å»ºç«‹è½¯è¿æ¥\nsudo ln -s /usr/bin/python3.8 /usr/bin/python å¦‚æœæƒ³è¦åˆ é™¤è½¯è¿æ¥\nsudo rm -rf /usr/bin/python æ ¼å¼åŒ–è¾“å‡º\ncurl -XGET http://192.168.70.131:9200/_mapping | python -m json.tool Elasticsearch åŸºç¡€çŸ¥è¯† å’Œå…³ç³»å‹æ•°æ®åº“çš„æ¯”è¾ƒ DBMS Elasticsearch database Index table type(åœ¨7.0ä¹‹åtypeä¸ºå›ºå®šå€¼_doc) Row Document Column Field Schema Mapping SQL DSL(Descriptor Structure Language) å®‰è£…Elasticsearch debåŒ…å®‰è£…æ–¹å¼\nsudo wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.2-amd64.deb sudo wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.2-amd64.deb.sha512 shasum -a 512 -c elasticsearch-8.2.2-amd64.deb.sha512 sudo dpkg -i elasticsearch-8.2.2-amd64.deb æ‰§è¡Œ**sudo dpkg -i elasticsearch-8.2.2-amd64.deb** å›ç”Ÿæˆè¶…çº§ç”¨æˆ·å¯†ç  0NgzdrlHquc1YdXrQout\n--------------------------- Security autoconfiguration information ------------------------------ Authentication and authorization are enabled. TLS for the transport and HTTP layers is enabled and configured. The generated password for the elastic built-in superuser is : 0NgzdrlHquc1YdXrQout If this node should join an existing cluster, you can reconfigure this with \u0026#39;/usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token \u0026lt;token-here\u0026gt;\u0026#39; after creating an enrollment token on your existing cluster. You can complete the following actions at any time: Reset the password of the elastic built-in superuser with \u0026#39;/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic\u0026#39;. Generate an enrollment token for Kibana instances with \u0026#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana\u0026#39;. Generate an enrollment token for Elasticsearch nodes with \u0026#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node\u0026#39;. ------------------------------------------------------------------------------------------------- ç”Ÿæˆ ca ã€ç”Ÿæˆ è¯ä¹¦\n# ç”Ÿæˆ ca # æ ¹æ®æç¤ºï¼š # è¾“å…¥ ca çš„å¯†ç ï¼ˆå¯†ç ä¸è¦å¿˜è®°ï¼Œåé¢ç”Ÿæˆè¯ä¹¦éœ€è¦ï¼‰ # è¾“å…¥ç”Ÿæˆ ca çš„æ–‡ä»¶åï¼ˆé»˜è®¤ä¼šè®©ä½ è¾“å…¥ elastic-stack-ca.p12ï¼Œè¿™é‡Œå°±æŒ‰ç…§é»˜è®¤çš„æ¥ï¼‰ sudo /usr/share/elasticsearch/bin/elasticsearch-certutil ca # ç”Ÿæˆè¯ä¹¦ # æ ¹æ®æç¤ºï¼š # è¾“å…¥ä¹‹å‰ ca çš„å¯†ç  # è¾“å…¥ç”Ÿæˆè¯ä¹¦çš„æ–‡ä»¶åï¼ˆé»˜è®¤è®©ä½ è¾“å…¥ elastic-certificates.p12ï¼Œè¿™é‡Œå°±æŒ‰ç…§é»˜è®¤çš„æ¥ï¼‰ # è¾“å…¥ç”Ÿæˆè¯ä¹¦çš„å¯†ç ï¼ˆå¯†ç ä¸è¦å¿˜è®°ï¼Œè¿™ä¸ªå¯†ç åœ¨é…ç½® ES keystore çš„æ—¶å€™éœ€è¦ï¼‰ # --ca åé¢çš„æ–‡ä»¶æ˜¯ä¸Šé¢æ­¥éª¤ç”Ÿæˆçš„ elastic-stack-ca.p12 æ–‡ä»¶ï¼Œå¦‚æœä¿®æ”¹äº†çš„è¯ï¼Œè¿™é‡Œä¹Ÿéœ€è¦ä¿®æ”¹ sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 â€‹\tä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œä¸€èˆ¬å°† ca ä¸è¯ä¹¦æ”¾åˆ° ~/.config/certs ç›®å½•ä¸‹\n# åˆ›å»ºç›®å½•å¹¶ç§»åŠ¨ ca ä¸è¯ä¹¦ sudo mkdir -p ~/.config/certs \u0026amp;\u0026amp; sudo mv /usr/share/elasticsearch/elastic-stack-ca.p12 /usr/share/elasticsearch/elastic-certificates.p12 ~/.config/certs å¯åŠ¨ Elasticsearch â€‹\t[ä¸ºäº†å®‰å…¨è€ƒè™‘Elasticsearchä¸å…è®¸ä½¿ç”¨rootç”¨æˆ·æ¥å¯åŠ¨]\næ‰“å¼€ elasticsearch é…ç½®æ–‡ä»¶\nsudo vim /etc/elasticsearch/elasticsearch.yml #æ‰“å¼€é…ç½®æ–‡ä»¶ ä¿®æ”¹ netWork.host, http.port å­—æ®µ\nnetwork.host: 10.40.38.66 #æ³¨æ„ network.host:å’Œ10.40.38.66 ä¹‹é—´éœ€è¦ç©ºæ ¼è¦ä¸å¯åŠ¨ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶ç±»å‹ä¸ºkey-valeæ ¼å¼ http.port: 9200 #æ³¨æ„ http.port:å’Œ9200 ä¹‹é—´éœ€è¦ç©ºæ ¼è¦ä¸å¯åŠ¨ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶ç±»å‹ä¸ºkey-valeæ ¼å¼ å› ä¸ºæ˜¯å†…ç½‘æµ‹è¯•æš‚æ—¶å…³é—­ xpack å®‰å…¨éªŒè¯æ–¹é¢é€‰é¡¹,ä»¥åéœ€è¦å†å»å¼€å¯\nå¯åŠ¨Elasticsearch\nsudo systemctl start elasticsearch.service å¼€æœºå¯åŠ¨elasticsearch\nsudo systemctl enable elasticsearch.service è¿æ¥grafana Elasticsearch æ“ä½œå‘½ä»¤ ç”¨jpså‘½ä»¤å…³é—­Elasticsearch\n$ jps | grep Elasticsearch 14542 Elasticsearch kill -9 14542 æŸ¥çœ‹ Elasticsearch ç«¯å£\nsudo netstat -tnlp |grep java æ£€æµ‹æ˜¯å¦å¯åŠ¨æˆåŠŸ\ncurl -XGET \u0026#39;http://192.168.70.131:9200/\u0026#39; -H \u0026#39;Content-Type: application/json\u0026#39; ç”¨journal æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—\nsudo journalctl -f ç”¨ journal æŸ¥çœ‹elasticsearch æœåŠ¡æ—¥å¿—\nsudo journalctl --unit elasticsearch ç”¨journal æŸ¥çœ‹elasticsearch æŒ‡å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—\nsudo journalctl --unit elasticsearch --since \u0026#34;2022-02-01 18:17:16\u0026#34; æŸ¥çœ‹ elasticsearch.log\nsudo vim /var/log/elasticsearch/elasticsearch.log Elasticsearch å¸è½½ # æŸ¥çœ‹å®‰è£…çš„è½¯ä»¶ sudo dpkg -l | grep elasticsearch #æŸ¥çœ‹å®‰è£…å…³è” sudo dpkg -L elasticsearch #ç§»é™¤å®‰è£…è½¯ä»¶ sudo dpkg -P elasticsearch #ç»§ç»­æŸ¥çœ‹æœªå¸è½½çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name elasticsearch #ç§»é™¤ç›®å½•å’Œæ–‡ä»¶å…·ä½“å‚è€ƒè‡ªå·±çš„ç¯å¢ƒ sudo rm -rf /var/lib/elasticsearch \u0026amp;\u0026amp; sudo rm -rf /var/lib/dpkg/info/elasticsearch.* \u0026amp;\u0026amp; sudo rm -rf /etc/default/elasticsearch \u0026amp;\u0026amp; sudo rm -rf /etc/init.d/elasticsearch \u0026amp;\u0026amp; sudo rm -rf /var/log/elasticsearch \u0026amp;\u0026amp; sudo rm -rf /usr/share/elasticsearch #åœ¨æ­¤æŸ¥çœ‹æ˜¯å¦æœ‰å…³è”çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name elasticsearch Logstash å®‰è£… Logstash ä¸‹è½½å®‰è£…å…¬å…±ç­¾å\nsudo wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - æ¥ä¸‹å®‰è£… apt-transport-https åŒ…\nsudo apt-get install apt-transport-https å°†å­˜å‚¨åº“ä¿å­˜åˆ° /etc/apt/sources.list.d/elastic-8.x.list\necho \u0026#34;deb https://artifacts.elastic.co/packages/8.x/apt stable main\u0026#34; | sudo tee -a /etc/apt/sources.list.d/elastic-8.x.list ç„¶åä½ å°±èƒ½å®‰è£…Elasticsearchäº†\nsudo apt-get update \u0026amp;\u0026amp; sudo apt-get install logstash æ’ä»¶åœ°å€ https://www.elastic.co/guide/en/logstash-versioned-plugins/current/index.html é…ç½®è¡¨å­—æ®µè§£é‡Š https://blog.csdn.net/weixin_42073629/article/details/110154037?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-110154037.pc_agg_new_rank\u0026amp;utm_term=logstash%E5%8F%82%E6%95%B0convert\u0026amp;spm=1000.2123.3001.4430 æŸ¥çœ‹å®‰è£…çš„æ’ä»¶ sudo /usr/share/logstash/bin/logstash-plugin list å¯åŠ¨Lostash ä¿®æ”¹ logstash.yml é…ç½®\nsudo vim /etc/logstash/logstash.yml å¯¼å…¥æ•°æ®[åˆ©ç”¨logstash ç›´æ¥åˆ†æmovies.csv ä¼ é€ç»™elasticsearchæ–¹å¼] â€‹\tæ”¶é›†æµç¨‹: movies.csv-\u0026gt;logstash-\u0026gt;elasticdearch-\u0026gt;grafana\nä¸‹è½½ml-latest.zip æ•°æ®\nsudo wget https://files.grouplens.org/datasets/movielens/ml-latest.zip è§£å‹ ml-latest.zip\nsudo unzip ml-latest.zip åœ¨/etc/logstash ç›®å½•ä¸‹åˆ›å»ºlogstash.conf æ–‡ä»¶\nsudo vim /etc/logstash/logstash.conf æŠŠä»¥ä¸‹å†…å®¹å†™å…¥logstash.conf\ninput { file { #ç›‘å¬æ–‡ä»¶çš„è·¯å¾„ path =\u0026gt; \u0026#34;/home/hls/downs/ml-latest/movies.csv\u0026#34; #ç›‘å¬æ–‡ä»¶çš„èµ·å§‹ä½ç½®ï¼Œé»˜è®¤æ˜¯end start_position =\u0026gt; \u0026#34;beginning\u0026#34; #ç›‘å¬æ–‡ä»¶è¯»å–ä¿¡æ¯è®°å½•çš„ä½ç½® sincedb_path =\u0026gt; \u0026#34;/home/hls/downs/ml-latest/db_path.log\u0026#34; } } filter { csv { separator =\u0026gt; \u0026#34;,\u0026#34; columns =\u0026gt; [\u0026#34;id\u0026#34;,\u0026#34;content\u0026#34;,\u0026#34;genre\u0026#34;,\u0026#34;@timestamp\u0026#34;] } mutate { # split =\u0026gt; { \u0026#34;genre\u0026#34; =\u0026gt; \u0026#34;|\u0026#34; } # remove_field =\u0026gt; [\u0026#34;path\u0026#34;, \u0026#34;host\u0026#34;,\u0026#34;@timestamp\u0026#34;,\u0026#34;message\u0026#34;] #åˆ é™¤æ— ç”¨å­—æ®µ } mutate { split =\u0026gt; [\u0026#34;content\u0026#34;, \u0026#34;(\u0026#34;] #å·¦æ‹¬å·åˆ†å‰² add_field =\u0026gt; { \u0026#34;title\u0026#34; =\u0026gt; \u0026#34;%{[content][0]}\u0026#34;} #å¢åŠ å­—æ®µ add_field =\u0026gt; { \u0026#34;year\u0026#34; =\u0026gt; \u0026#34;%{[content][1]}\u0026#34;} #å¢åŠ å­—æ®µ } mutate { convert =\u0026gt; { #year è½¬æ¢æˆæ•´å‹ \u0026#34;year\u0026#34; =\u0026gt; \u0026#34;integer\u0026#34; } strip =\u0026gt; [\u0026#34;title\u0026#34;] #å»æ‰å­—æ®µé¦–å°¾çš„ç©ºæ ¼ # remove_field =\u0026gt; [\u0026#34;path\u0026#34;, \u0026#34;host\u0026#34;,\u0026#34;@timestamp\u0026#34;,\u0026#34;message\u0026#34;,\u0026#34;content\u0026#34;] #åˆ é™¤æ— ç”¨å­—æ®µ } } output { elasticsearch { # åŒå¼•å·ä¸­çš„å†…å®¹ä¸ºESçš„åœ°å€ï¼Œè§†å®é™…æƒ…å†µè€Œå®š hosts =\u0026gt; \u0026#34;http://192.168.70.131:9200\u0026#34; index =\u0026gt; \u0026#34;movies\u0026#34; document_id =\u0026gt; \u0026#34;%{id}\u0026#34; #docId ç­‰ä»·äº_id å­—æ®µ } stdout {} } å¦‚æœéœ€è¦é‡æ–°å¯¼å…¥ï¼Œå…ˆåˆ é™¤db_path.log æ–‡ä»¶\nsudo rm -rf /var/lib/logstash/.lock sudo rm -rf /home/hls/downs/ml-latest/db_path.log sudo /usr/share/logstash/bin/logstash -f /etc/logstash/logstash.conf æŠ¥é”™\næ‰§è¡Œå‘½ä»¤**sudo /usr/share/logstash/bin/logstash -f /etc/logstash/logstash.conf** åå¦‚æœæŠ¥é”™\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults é‚£ä¹ˆå°±åˆ›å»ºè½¯è¿æ¥\ncd /usr/share/logstash sudo ln -s /etc/logstash ./config æ‰§è¡Œå‘½ä»¤**sudo /usr/share/logstash/bin/logstash -f /etc/logstash/logstash.conf** åå¦‚æœæŠ¥é”™\nLogstash could not be started because there is already another instance using the configured data directory. If you wish to run multiple instances, you must change the \u0026#34;path.data\u0026#34; setting. é‚£ä¹ˆå°±å» logstash.yml ä¸­path.data æŒ‡å®šçš„è·¯å¾„ä¸Šå»åˆ é™¤.lockæ–‡ä»¶\ncd /var/lib/logstash sudo ls -a sudo rm -rf .lock æˆ–è€…ç›´æ¥ä¸€å¥è¯\nsudo rm -rf /var/lib/logstash/.lock å¼ºåˆ¶æŸ¥çœ‹è¾“å‡º logstash.conf ä¿®æ”¹æˆä½ è‡ªå·±çš„æ–‡ä»¶ sudo /usr/share/logstash/bin/logstash /etc/logstash/logstash.conf --verbose --debug æŸ¥çœ‹æ•°æ® ç”¨Kibanaçš„å‘½ä»¤è¡Œå·¥å…·æ‰§è¡Œ GET _cat/indices å‘½ä»¤ï¼Œå°±èƒ½çœ‹è§å¯¼å…¥åˆ°Elasticsearchçš„ç´¢å¼•\nç”¨kibanaçš„å‘½ä»¤è¡Œå·¥å…·æ‰§è¡Œ**GET /lua_cpu_monitor-2022.06.03/_search**å‘½ä»¤,å°±èƒ½çœ‹è§å¯¼å…¥åˆ°Elasticsearchçš„æ•°æ®\nè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®å‘½ä»¤ logstash.conf ä¿®æ”¹æˆä½ è‡ªå·±çš„æ–‡ä»¶\nsudo /usr/share/logstash/bin/logstash /etc/logstash/logstash.conf --config.reload.automatic é»˜è®¤æ£€æµ‹æ—¶é—´æ˜¯**3**ç§’ å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤ä¿®æ”¹ æŠŠ\u0026lt;\u0026gt;å·é‡Œé¢çš„2æ¢æˆä½ æƒ³è¦çš„æ—¶é—´\nsudo /usr/share/logstash/bin/logstash /etc/logstash/logstash.conf --config.reload.interval \u0026lt;2\u0026gt; å¸è½½Logstash # æŸ¥çœ‹å®‰è£…çš„è½¯ä»¶ sudo dpkg -l | grep logstash #æŸ¥çœ‹å®‰è£…å…³è” sudo dpkg -L logstash #ç§»é™¤å®‰è£…è½¯ä»¶ sudo dpkg -P logstash #ç»§ç»­æŸ¥çœ‹æœªå¸è½½çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name logstash #ç§»é™¤ç›®å½•å’Œæ–‡ä»¶å…·ä½“å‚è€ƒè‡ªå·±çš„ç¯å¢ƒ sudo rm -rf /var/lib/logstash \u0026amp;\u0026amp; sudo rm -rf /var/lib/dpkg/info/logstash.* \u0026amp;\u0026amp; sudo rm -rf /etc/default/logstash \u0026amp;\u0026amp; sudo rm -rf /etc/init.d/logstash \u0026amp;\u0026amp; sudo rm -rf /etc/logstash \u0026amp;\u0026amp; sudo rm -rf /var/log/logstash \u0026amp;\u0026amp; sudo rm -rf /usr/share/logstash #åœ¨æ­¤æŸ¥çœ‹æ˜¯å¦æœ‰å…³è”çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name logstash Kibana å®‰è£…Kibana ä¸‹è½½å®‰è£…å…¬å…±ç­¾å\nwget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - æ¥ä¸‹å®‰è£… apt-transport-https åŒ…\nsudo apt-get install apt-transport-https å°†å­˜å‚¨åº“ä¿å­˜åˆ° /etc/apt/sources.list.d/elastic-8.x.list\necho \u0026#34;deb https://artifacts.elastic.co/packages/8.x/apt stable main\u0026#34; | sudo tee -a /etc/apt/sources.list.d/elastic-8.x.list ç„¶åä½ å°±èƒ½å®‰è£…Kibanaäº†\nsudo apt-get update \u0026amp;\u0026amp; sudo apt-get install kibana å¯åŠ¨Kibana æ‰“å¼€kibana.yml æ–‡æ¡£\nsudo vim /etc/kibana/kibana.yml ä¿®æ”¹ server.port,server.host å­—æ®µ\nå¯åŠ¨\nsudo systemctl start kibana.service è‡ªå¯åŠ¨\nsudo systemctl enable kibana.service æŸ¥çœ‹ kibanaæ—¥å¿—\nsudo vim /var/log/kibana ç”¨è°·æ­Œæˆ–è€…å¾®è½¯è‡ªå¸¦æµè§ˆå™¨æ‰“å¼€åœ°å€\nhttp://10.40.38.66:5601 å¸è½½Kibana # æŸ¥çœ‹å®‰è£…çš„è½¯ä»¶ sudo dpkg -l | grep kibana #æŸ¥çœ‹å®‰è£…å…³è” sudo dpkg -L kibana #ç§»é™¤å®‰è£…è½¯ä»¶ sudo dpkg -P kibana #ç»§ç»­æŸ¥çœ‹æœªå¸è½½çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name kibana #ç§»é™¤ç›®å½•å’Œæ–‡ä»¶å…·ä½“å‚è€ƒè‡ªå·±çš„ç¯å¢ƒ sudo rm -rf /var/lib/kibana \u0026amp;\u0026amp; sudo rm -rf /var/lib/dpkg/info/kibana.* \u0026amp;\u0026amp; sudo rm -rf /etc/kibana #åœ¨æ­¤æŸ¥çœ‹æ˜¯å¦æœ‰å…³è”çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name kibana Filebeat æ­é…filebeatä¸»è¦ä½¿ç”¨æ”¶é›†nginxæ•°æ®, å’Œä¸Šé¢çš„åˆ©ç”¨logstashè§£æmovies.csvï¼Œç„¶åæ”¶é›†æ•°æ®ç»™elasticsearchçš„æ–¹å¼ä¸ä¸€æ ·\næ”¶é›†æµç¨‹: nginx-\u0026gt;filebeat-\u0026gt;logstash-\u0026gt;elasticdearch-\u0026gt;grafana\nå®‰è£…Filebeat sudo curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.2.2-amd64.deb sudo dpkg -i filebeat-8.2.2-amd64.deb ä¿®æ”¹ filebat.yml é…ç½®æ–‡ä»¶ sudo vim /etc/filebeat/filebeat.yml ä¿®æ”¹ä¸‹åˆ—å‡ é¡¹\n# ============================== Filebeat inputs =============================== filebeat.inputs: - type: filestream id: my-filestream-id enabled: true paths: - /home/hls/work/blueprint-server-runtime/log/lua_cpu_monitor.log tags: [\u0026#34;lua_cpu_monitor_log\u0026#34;] - type: filestream id: my-filestream-id enabled: true paths: - /home/hls/work/blueprint-server-runtime/log/lua_mem_monitor.log tags: [\u0026#34;lua_mem_monitor_log\u0026#34;] # ============================== Filebeat modules ============================== filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false setup.template.settings: index.number_of_shards: 1 # ------------------------------ Logstash Output ------------------------------- output.logstash: # The Logstash hosts hosts: [\u0026#34;10.40.38.66:5555\u0026#34;] # ================================= Processors ================================= processors: - add_host_metadata: when.not.contains.tags: forwarded - add_cloud_metadata: ~ - add_docker_metadata: ~ - add_kubernetes_metadata: ~ æµ‹è¯•filebeatå¯åŠ¨åï¼ŒæŸ¥çœ‹ç›¸å…³è¾“å‡ºä¿¡æ¯ sudo filebeat -e -c /etc/filebeat/filebeat.yml -d \u0026#34;publish\u0026#34; åå°æ–¹å¼å¯åŠ¨filebeat nohup filebeat -e -c /etc/filebeat/filebeat.yml \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 \u0026amp; #å°†æ‰€æœ‰æ ‡å‡†è¾“å‡ºåŠæ ‡å‡†é”™è¯¯è¾“å‡ºåˆ°/dev/nullç©ºè®¾å¤‡ï¼Œå³æ²¡æœ‰ä»»ä½•è¾“å‡º nohup filebeat -e -c /etc/filebeat/filebeat.yml \u0026gt; filebeat.log \u0026amp; åœæ­¢filebeat ps -ef | grep filebeat kill -9 è¿›ç¨‹å· å¯åŠ¨å‡ºç°çš„é—®é¢˜ æ‰§è¡Œå‘½ä»¤systemctl start filebeat.serviceå°±èƒ½å¤Ÿå¯åŠ¨äº†ã€‚è€Œåæ‰§è¡Œps -ef|grep filebeatæŸ¥çœ‹ä¸€ä¸‹\nèƒ½å¤Ÿçœ‹åˆ°å·²ç»å¯åŠ¨èƒœåˆ©äº†ï¼Œå¦‚æœä½ å‘ç°æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œé‚£ä¹ˆå°±æ‰§è¡Œ cd /usr/binï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹æ‰§è¡Œ./filebeat -c /etc/filebeat/filebeat.yml -eï¼Œè¿™æ ·ä¼šæé†’å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚è€Œç”¨systemctl start filebeat.serviceå¯åŠ¨çš„æ—¶å€™æ²¡æœ‰ä»»ä½•æé†’ï¼Œè¿åœ¨ /var/log/filebeat/ å’Œ /var/lib/filebeat/registry/filebeat/ éƒ½æ²¡æ‰¾åˆ°é”™è¯¯ä¿¡æ¯ï¼Œè¿™é‡Œå±å®æœ‰ç‚¹å‘ã€‚\né‡æ–°å¯åŠ¨å‘½ä»¤systemctl restart filebeat.service\nå»å®‰è£…logstashçš„æœºå™¨å¯åŠ¨logstash å¢åŠ  logstash_filebeat.conf æ–‡æ¡£\nsudo vim /etc/logstash/conf.d/logstash_filebeat.conf æŠŠä»¥ä¸‹å†…å®¹ç²˜è´´ä¸Šä¿å­˜\ninput { beats { port =\u0026gt; 5555 #è¿™ä¸ªåœ°å€ä¸èƒ½å’Œlogstash.yml é‡Œé¢çš„api.http.host: 9600 ä¸€æ ·ï¼Œè¦ä¸ä¼šå‡ºç°åœ°å€å·²ç»è¢«ç»‘å®šçš„é”™è¯¯ } } output { if \u0026#34;lua_cpu_monitor_log\u0026#34; in [tags] { elasticsearch { hosts =\u0026gt; [\u0026#34;10.40.38.66:9200\u0026#34;] index =\u0026gt; \u0026#34;lua_cpu_monitor-%{+YYYY.MM.dd}\u0026#34; } } if \u0026#34;lua_men_monitor_log\u0026#34; in [tags] { elasticsearch { hosts =\u0026gt; [\u0026#34;10.40.38.66:9200\u0026#34;] index =\u0026gt; \u0026#34;lua_men_monitor-%{+YYYY.MM.dd}\u0026#34; } } } é‡æ–°åŠ è½½æ–°çš„é…ç½®å¹¶å¯åŠ¨logstash\nå…ˆå¯åŠ¨logstashï¼Œç„¶ååœ¨å¯åŠ¨filebeatï¼Œä¸ç„¶çš„è¯filebeatä¼šæ‰¾ä¸åˆ°beatsæ’ä»¶çš„:5555ç«¯å£\nsudo rm -rf /var/lib/logstash/.lock sudo /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash_filebeat.conf --verbose --debug ç”¨filebeat ç›‘æ§ nginx ä¿®æ”¹ nginx conf é…ç½®è¡¨\nsudo vim /usr/local/nginx/conf/nginx.conf åŠ å…¥å¦‚ä¸‹æ—¥å¿—æ ¼å¼\nlog_format main \u0026#39;{\u0026#34;@timestamp\u0026#34;:\u0026#34;$time_iso8601\u0026#34;,\u0026#39; \u0026#39;\u0026#34;@source\u0026#34;:\u0026#34;$server_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;hostname\u0026#34;:\u0026#34;$hostname\u0026#34;,\u0026#39; \u0026#39;\u0026#34;ip\u0026#34;:\u0026#34;$remote_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;client\u0026#34;:\u0026#34;$remote_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;request_method\u0026#34;:\u0026#34;$request_method\u0026#34;,\u0026#39; \u0026#39;\u0026#34;scheme\u0026#34;:\u0026#34;$scheme\u0026#34;,\u0026#39; \u0026#39;\u0026#34;domain\u0026#34;:\u0026#34;$server_name\u0026#34;,\u0026#39; \u0026#39;\u0026#34;referer\u0026#34;:\u0026#34;$http_referer\u0026#34;,\u0026#39; \u0026#39;\u0026#34;request\u0026#34;:\u0026#34;$request_uri\u0026#34;,\u0026#39; \u0026#39;\u0026#34;args\u0026#34;:\u0026#34;$args\u0026#34;,\u0026#39; \u0026#39;\u0026#34;size\u0026#34;:$body_bytes_sent,\u0026#39; \u0026#39;\u0026#34;status\u0026#34;: $status,\u0026#39; \u0026#39;\u0026#34;responsetime\u0026#34;:$request_time,\u0026#39; \u0026#39;\u0026#34;upstreamtime\u0026#34;:\u0026#34;$upstream_response_time\u0026#34;,\u0026#39; \u0026#39;\u0026#34;upstreamaddr\u0026#34;:\u0026#34;$upstream_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;http_user_agent\u0026#34;:\u0026#34;$http_user_agent\u0026#34;,\u0026#39; \u0026#39;\u0026#34;https\u0026#34;:\u0026#34;$https\u0026#34;\u0026#39; \u0026#39;}\u0026#39;; å¯¹æ¯”ä¿®æ”¹ä¸‹å›¾å¯¹åº”çš„3ä¸ªçº¢æ¡†åœ°æ–¹\né‡å¯ nginx\nsudo pkill -9 nginx \u0026amp;\u0026amp; sudo nginx ç”¨ http:192.168.70.132:7000 ç™»å½•nginx ç½‘ç«™ç”Ÿæˆç™»å½•æ—¥å¿—ï¼Œç„¶åæ‰“å¼€ access.log æ—¥å¿—\nsudo vim /usr/local/nginx/logs/access.log sudo tail -f /usr/local/nginx/logs/access.log å¸è½½Filebeat # æŸ¥çœ‹å®‰è£…çš„è½¯ä»¶ sudo dpkg -l | grep filebeat #æŸ¥çœ‹å®‰è£…å…³è” sudo dpkg -L filebeat #ç§»é™¤å®‰è£…è½¯ä»¶ sudo dpkg -P filebeat #ç»§ç»­æŸ¥çœ‹æœªå¸è½½çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name filebeat #ç§»é™¤ç›®å½•å’Œæ–‡ä»¶å…·ä½“å‚è€ƒè‡ªå·±çš„ç¯å¢ƒ sudo rm -rf /var/lib/filebeat \u0026amp;\u0026amp; sudo rm -rf /var/log/filebeat/filebeat \u0026amp;\u0026amp; sudo rm -rf /var/log/filebeat \u0026amp;\u0026amp; sudo rm -rf /usr/share/filebeat #åœ¨æ­¤æŸ¥çœ‹æ˜¯å¦æœ‰å…³è”çš„ç›®å½•å’Œæ–‡ä»¶ sudo find / -name filebeat ","permalink":"https://frog-game.github.io/posts/blog/zabbix-mysql8.0/","summary":"æ¼”ç¤º å®‰è£…ç¯å¢ƒ ç‰ˆæœ¬ Ubuntu 20.04 zabbix 6.0 mysql 8.0 Ubuntu20.04+mysql8.0+zabbix6.0+elk+filebeat+logstash+grafana zabbix 6.0 é˜¿é‡Œäº‘é•œåƒåœ°å€ https://mirrors.aliyun.com/zabbix/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/ ä¸‹è½½ zabbix sudo wget https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-1+ubuntu20.04_all.deb sudo dpkg -i zabbix-release_6.0-1+ubuntu20.04_all.deb sudo apt update å®‰è£…Zabbix serverï¼ŒWebå‰ç«¯ï¼Œagent sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf","title":"zabbixæ¸¸æˆæ—¥å¿—ç›‘æ§"},{"content":"ä¸ºå•¥é€‰æ‹©å¸§åŒæ­¥ å’Œå†™å•æœºæ¸¸æˆç±»ä¼¼ï¼Œå®¢æœç«¯æ”¶é›†è‡ªå·±çš„æŒ‡ä»¤æ“ä½œå‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿›è¡Œæ”¶é›†å¹¿æ’­ç»™æ‰€æœ‰çš„ç©å®¶ï¼Œå®¢æœç«¯æœ¬åœ°é€šè¿‡æ”¶åˆ°çš„åŒ…æ¥æ¨è¿›æ¸¸æˆè¿›åº¦\næœåŠ¡å™¨ï¼šæ¯éš”ä¸€æ®µæ—¶é—´æ”¶é›†å®¢æœç«¯çš„æ“ä½œï¼Œå‘ç»™å®¢æœç«¯ï¼Œç„¶åç»§ç»­é‡‡é›†ä¸‹ä¸€æ¬¡çš„æ“ä½œï¼Œåœ¨å‘ç»™å®¢æœç«¯\nå®¢æœç«¯ï¼šæ”¶åˆ°æœåŠ¡å™¨çš„å¹¿æ’­ä¸‹æ¥çš„æ“ä½œ\u0026mdash;-\u0026gt;è®¡ç®—é€»è¾‘\u0026mdash;\u0026gt;é‡‡é›†è‡ªå·±æ“ä½œä¸ŠæŠ¥æœåŠ¡å™¨\nå¸§åŒæ­¥é€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜ï¼Œäººæ•°è¾ƒå°‘çš„æƒ…å†µ\nå¸§åŒæ­¥æœåŠ¡å™¨æ¯éš”å¤šä¹…åŒæ­¥ä¸€æ¬¡æ¯”è¾ƒåˆé€‚å‘¢\nä¸Šé™ï¼š ç½‘ç»œä¼ è¾“æ—¶é—´ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„pingç™¾åº¦ç½‘ç«™ä½ å¾—åˆ°çš„æ—¶é—´æ˜¯10ms é‚£ä¹ˆ 1000/10 100 å¸§\nä¸‹é™ï¼šä¸‹å‘ç»™ç©å®¶çš„é€Ÿåº¦ï¼Œä¹Ÿå°±æ˜¯ç©å®¶çš„ä½“éªŒï¼Œç§‘å­¦æ•°æ®ç©å®¶åœ¨50 ms-100ms ä¹‹é—´äººä¸ä¼šæ„Ÿè§‰åˆ°å¡é¡¿è®¤ä¸ºæ¯”è¾ƒæµç•…\né‚£ä¹ˆå°±æ˜¯[1000/50,1000/100]\u0026mdash;\u0026gt;[20,10] æ‰€ä»¥ç‹è€…è£è€€ä¸€èˆ¬å–ä¸­é—´å€¼15fps ä¹Ÿå°±æ˜¯1ç§’15å¸§ ä¸€å¸§ 1000/15 66ms\nç®—ä¸‹å¸¦å®½æ˜¯å¤šå°‘ï¼Œæ‰¿å—çš„äº†å—\nå‡è®¾5000ä¸ªäººï¼ŒæŒ‰ä¸€ä¸ªæˆ¿é—´10äººï¼Œé‚£ä¹ˆå°±å¾—500ä¸ªæˆ¿é—´\nå‡è®¾1ç§’çš„æ•°æ®ï¼Œ ä¸€å¸§æˆ‘ä»¬æ¯äºº**16**ä¸ªå­—èŠ‚çš„æŒ‡ä»¤æ•°æ®ï¼Œé‚£ä¹ˆ16 * 10 * 15 * 500 \u0026mdash;\u0026gt;1,200,000Byte \u0026ndash;\u0026gt; 1172KB \u0026mdash;\u0026gt; 1MB å¸¦å®½ï¼Œå¯¹äºç°åœ¨çš„æœåŠ¡å™¨å®Œå…¨æ˜¯å¯ä»¥æ‰¿å—çš„\né€‰ç”¨udpè¿˜æ˜¯tcp tcp ï¼šå‡†ç¡® ä¸¢åŒ…é‡ä¼ \né€šå¸¸tcpä¹Ÿèƒ½åšåˆ°åšå¸§åŒæ­¥ï¼Œä½†æ˜¯å¾ˆéš¾å› å¯¹ç½‘ç»œæ³¢åŠ¨ï¼Œå› ä¸ºå‡å¦‚tcpæœ‰æ¡é“¾è·¯å‘é€äº†ä¸€ä¸ª1å·åŒ…è¿‡å»ï¼Œè¿™ä¸ªæ—¶å€™å› ä¸ºç½‘ç»œæ³¢åŠ¨è¿™ä¸ªé“¾è·¯ç½‘é€Ÿä¸‹é™ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šè§¦å‘é‡ä¼ ï¼Œåœ¨å‘é€2å·åŒ…è¿‡æ¥çš„æ—¶å€™ï¼Œå°±å¯èƒ½ä¼šå¡ä¸»2å·åŒ…ï¼Œä»è€Œå¯¼è‡´å®¢æœç«¯æ”¶ä¸åˆ°åŒ…æ•°æ®\nudpï¼šé«˜æ•ˆï¼Œå¯èƒ½ä¸¢åŒ…ï¼Œä¹±åº å‡è®¾1å·åŒ…å¡ä¸»äº†ï¼Œé‚£ä¹ˆudpä¸ä¼šå»ç­‰å¾…1å·åŒ…æ˜¯å¦å‘å®Œï¼Œåœ¨ä¸‹ä¸€æ¬¡éœ€è¦å‘é€çš„æ—¶å€™å°±ä¼šå†æ¬¡é€šè¿‡æ–°çš„é“¾æ¥å‘é€2å·åŒ…è¿‡å»\nå¸§åŒæ­¥è¿è¡Œå‰æ è¾“å…¥ä¸€è‡´æ€§\nç¡®å®šæ€§çš„ç¢°æ’ï¼Œå¯»è·¯ç»“æœ ç©å®¶æ“ä½œé¡ºåºå”¯ä¸€ è®¡ç®—è¦ä¸€è‡´æ€§\næœåŠ¡å™¨é’ˆå¯¹æ¯ä¸ªå•å±€æ¸¸æˆå¼€å±€æ—¶é—´ç”Ÿæˆéšæœºæ•°ç§å­ï¼Œé€»è¾‘å¸§è®¡ç®—å‡ä¸ºä¼ªéšæœº\næµ®ç‚¹æ•°é‡‡ç”¨å¤šä¸ªå®šç‚¹æ•°ä¿å­˜å’Œè¿ç®—ï¼Œç¡®ä¿æµ®ç‚¹æ•°è®¡ç®—ç»“æœä¸€è‡´\næ¯ä¸ªç½‘ç»œåŒ…éƒ½åŒ…å«è‡ªå¢åºå·ï¼Œå…·ä½“ç®—æ³•å¯æ ¹æ®é¡¹ç›®è‡ªè¡Œå®šä¹‰\nä¸¥æ ¼æ§åˆ¶é™æ€å˜é‡ï¼ˆå…¨å±€å˜é‡ï¼‰çš„ä½¿ç”¨\nç¦æ­¢ä½¿ç”¨ä¸ç¨³å®šçš„æ’åºç®—æ³•\nç¦æ­¢ä½¿ç”¨é¡ºåºä¸ç¡®å®šçš„æ•°æ®ç»“æ„\nå°½é‡ä¸ä½¿ç”¨éå¼€æºçš„ç¬¬ä¸‰æ–¹åº“ï¼ˆæ— æ³•ç¡®å®šç¬¬ä¸‰æ–¹åº“ä¸­æ˜¯å¦æœ‰ä¸Šè¿°çš„ç»“æœä¸ä¸€è‡´ç®—æ³•ï¼‰\nå¤šçº¿ç¨‹é—®é¢˜\nä¸»è¦æ˜¯æ¯ä¸ªå®¢æœç«¯å¤šçº¿ç¨‹ç®—å‡ºç»“æœå¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œæ¯”å¦‚Aå®¢æœç«¯ç”¨äº†3ä¸ªçº¿ç¨‹æ¥ç®—ä½ \tè¿™ä¸ªæ•°æ®ï¼Œbå®¢æœç«¯ç”¨1ä¸ªçº¿ç¨‹æ¥ç®—ä½ è¿™ä¸ªæ•°æ®å¯¼è‡´æœ€åAå’ŒBçš„ç»“æœä¸ä¸€è‡´ï¼Œé™¤éä½ \tèƒ½ä¿è¯æœ€åç»“æœä¸€è‡´ï¼Œè¦ä¸æœ€å¥½åˆ«ç”¨\nåç¨‹ (Coroutine)å†…å†™é€»è¾‘å¸¦æ¥çš„ä¸ç¡®å®šæ€§ä¹Ÿè¦æ³¨æ„\nå¼€å§‹æ¼”ç¤ºä»£ç å‰ï¼Œè¦ä¿è¯è¿è¡Œçš„å¤šä¸ªå®¢æœç«¯ä»£ç ç‰ˆæœ¬è¦ä¸€è‡´ï¼Œå¦‚æœå› ä¸ºç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´è¿è¡Œç»“æœä¸ä¸€æ ·ï¼Œç„¶åæŸ¥äº†å¾ˆä¹…bugé‚£å°±å¤ª2äº†ï¼Œå¦‚æœå½“å‰çº¿ä¸Šå­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œåˆ™åªæœ‰åŒç‰ˆæœ¬ç©å®¶å¯åŒ¹é…åˆ°å•å±€æ¸¸æˆä¸­\nc#çš„ dictionaryéå†çš„æ—¶å€™æ˜¯æ— åºçš„ï¼Œè¿™ä¸ªè¦æ³¨æ„,å¾ˆå®¹ç¿»è½¦\nå¦‚æœåŒæ‰¹å‘é€çš„åŒ…æ¯”è¾ƒå¤šï¼Œå°½é‡åˆå¹¶ï¼Œå‡å°‘åŒ…å¤´ä¿¡æ¯çš„å†—ä½™\nä¸šåŠ¡å±‚ä¸Šé¢å°½é‡å‡å°‘æ•°æ®ç»“æ„åŒ…çš„å¤§å°\né€»è¾‘å¸§çš„è§„åˆ™\næ”¶åˆ°ç¬¬ Nå¸§ï¼Œåªæœ‰å½“æˆ‘æ”¶åˆ°ç¬¬ N+1å¸§çš„æ—¶å€™ï¼Œç¬¬ Nè¿™ä¸€å¸§æˆ‘æ‰å¯ä»¥æ‰§è¡Œã€‚ æœåŠ¡å™¨ä¼šæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡ï¼Œä¸åŒçš„ç»™å¤§å®¶åŒæ­¥å¸§ç¼–å·ï¼ŒåŒ…æ‹¬è¿™ä¸€å¸§çš„è¾“å…¥å¸¦ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœå¸¦ä¸€å¸§ç»™ä½ çš„æ•°æ®ä½ æ‹¿åˆ°ä¹‹åå°±æ‰§è¡Œï¼Œä¸‹ä¸€å¸§æ•°æ®æ²¡æ¥å°±ä¸èƒ½æ‰§è¡Œï¼Œå®ƒçš„ç»“æœå°±æ˜¯å¡é¡¿ã€‚\næˆ˜æ–—æµç•…ä¿è¯æ–¹æ³• é€»è¾‘å¸§ä¿è¯åœ¨ 15-18å¸§ä¸Šä¸‹\næ•°æ®åŒ…å†—ä½™å‘é€ï¼Œå‘é€æ•°æ®é‡è¾ƒå°‘çš„å½“å‰å¸§æ—¶ï¼Œå¯ä»¥æŠŠå‰å‡ å¸§æ•°æ®åˆå¹¶å‘é€\næ¸²æŸ“å¸§ä¿è¯åœ¨ 30å¸§ä»¥ä¸Š\nå¸¸è§çš„å®¢æˆ·ç«¯é¢„æµ‹ï¼Œå®¢æˆ·ç«¯æ’å€¼ï¼ŒæœåŠ¡å™¨å»¶è¿Ÿè¡¥å¿æ–¹æ³•ä¿è¯å®¢æˆ·ç«¯ç”»é¢æµç•…\nå¸§åŒæ­¥æµç¨‹ æœåŠ¡å™¨:\næœåŠ¡å™¨çš„æ¯ä¸ªæ¯”èµ›å¯¹è±¡ï¼Œéƒ½æœ‰ä¸€ä¸ªæˆå‘˜frameid ä¿æŒäº†å½“å‰çš„æ¯”èµ›ï¼Œä¸‹ä¸€å¸§è¦è¿›å…¥çš„idï¼Œframeid =1\næˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰äº†ä¸€ä¸ªæ•°æ®ç»“æ„ match_frames ç”¨æ¥ä¿å­˜æˆ‘ä»¬æ‰€æœ‰ç©å®¶æ¯å¸§çš„æ“ä½œ\nä¿å­˜match_framesè¿™ä¸ªç»“æ„çš„ä½œç”¨:\nå½•åƒå›æ”¾ æ–­çº¿é‡è¿ åœ¨ä¸åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä½œå¼Š udpä¸¢åŒ…æ—¶åºé—®é¢˜ï¼Œä¸¢åŒ…çš„æ—¶å€™éœ€è¦è¡¥å‘ç»™å®¢æœç«¯ next_frame_opt æ¯å¸§æœåŠ¡å™¨é‡‡é›†åˆ°çš„å®¢æœç«¯æ“ä½œ\nnext_frame_opt = {frameid ,{1å·æ“ä½œç©å®¶æŒ‡ä»¤,2å·æ“ä½œç©å®¶æŒ‡ä»¤,3å·æ“ä½œç©å®¶æŒ‡ä»¤,4å·æ“ä½œç©å®¶æŒ‡ä»¤, ..}}\næœåŠ¡å™¨å¯åŠ¨å®šæ—¶å™¨ æ¯éš”66msè§¦å‘ä¸€æ¬¡ on_logic_frame\nä¿å­˜æˆ‘ä»¬å½“å‰çš„æ“ä½œåˆ°match_frames\néå†æ¯ä¸ªç©å®¶ï¼Œç»™æ¯ä¸ªç©å®¶å‘é€æˆ‘ä»¬çš„å¸§æ“ä½œ\næœåŠ¡å™¨è¿›å…¥ä¸‹ä¸€å¸§ frameid = frameid + 1\næœåŠ¡å™¨è¿›å…¥é‡‡é›†ä¸‹ä¸€å¸§çš„æ“ä½œï¼Œæ¸…ç©ºä¸Šä¸€å¸§é‡‡é›†åˆ°çš„å®¢æœç«¯æ“ä½œ:ä¹Ÿå°±æ˜¯æŠŠnext_frame_optæ¸…ç©º\nnext_frame_opt = {frameid ,{}}\nå‘é€æœåŠ¡å™¨è®¤ä¸ºè¿™ä¸ªç©å®¶è¿˜æ²¡æœ‰åŒæ­¥çš„å¸§ï¼Œæ¯ä¸ªç©å®¶å¯¹è±¡è®°å½•äº†ä¸€ä¸ªå˜é‡ sync_frameid ç”¨æ¥è®°å½•è¿™ä¸ªå®¢æœç«¯å·²ç»åŒæ­¥äº†å¤šå°‘å¸§\nåŒæ­¥çš„å¸§ï¼š sync_frameid + 1 TO æœ€æ–°çš„å¸§ \u0026mdash;\u0026gt;ä¸»è¦æ˜¯ç”¨æ¥è§£å†³udpä¸¢åŒ…å’Œæ—¶åºé—®é¢˜\né‡‡ç”¨udp å°†æˆ‘ä»¬éœ€è¦è¡¥å‘çš„å¸§åŒæ­¥ç»™å®¢æœç«¯[sync_frameid + 1,æœ€æ–°å¸§]\nå®¢æˆ·ç«¯:\né€šè¿‡ç½‘ç»œå—åˆ°ç½‘ç»œå—åˆ°å¸§åŒæ­¥çš„æ•°æ®åŒ…ä»¥å,\næ¯ä¸ªå®¢æœç«¯ä¹Ÿä¼šæœ‰ä¸€ä¸ªsync_frameid,ç”¨æ¥è®°å½•ä¸€ä¸‹ä½ è¿™ä¸ªå®¢æœç«¯çœŸæ­£å·²ç»åŒæ­¥åˆ°é‚£ä¸ªå¸§äº†\nå¦‚æœæ”¶åˆ°çš„å¸§idå°äºå®¢æœç«¯çš„å¸§idï¼Œé‚£ä¹ˆç›´æ¥ä¸¢å¼ƒè¿™ä¸ªå¸§\nä¸ºä»€ä¹ˆä¼šå‡ºç°éœ€è¦ä¸¢å¼ƒè¿™ä¸ªå¸§çš„æƒ…å†µ\nå› ä¸ºudp æ—¶åºé—®é¢˜ ï¼šæœ‰å…ˆå‘ååˆ°ï¼Œåå‘å…ˆåˆ°çš„å¯èƒ½\nä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰æ”¶åˆ°99å¸§ï¼Œå¯ä»¥å¼€å§‹å¤„ç†100å¸§ï¼Œè¿˜èƒ½åŒæ­¥å—\n99å¸§æ²¡æœ‰å¤„ç†ï¼ŒæœåŠ¡å™¨å‘100å¸§çš„æ—¶å€™å›è¡¥å‘99å¸§\nå¦‚æœä¸Šä¸€å¸§çš„æ“ä½œä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å¤„ç†ä¸‹ä¸€å¸§ä¹‹å‰ï¼Œä¸€å®šè¦å…ˆåŒæ­¥ä¸‹ä¸Šä¸€å¸§çš„ç»“æœ\nå®¢æœç«¯A:|\u0026hellip;.|..66.3.|\u0026hellip;.|\nå®¢æœç«¯B:|\u0026hellip;.|..66.2.|\u0026hellip;.|\nåœ¨æ’­æ”¾åŠ¨ç”»çš„å¸§ä¸å¸§ä¹‹é—´ï¼Œæˆ‘ä»¬ä¼šå‡ºç°æ—¶é—´çš„å·®å¼‚ï¼Œä¼šå¯¼è‡´ä½ç½®ä¸åŒæ­¥ï¼Œ\nlogic_pos 66ms \u0026ndash;\u0026gt;ç»Ÿä¸€ç”¨66msæ¥è®¡ç®—æ–°çš„ä½ç½®å’Œç»“æœ\nå®¢æœç«¯A:|\u0026hellip;.|..66.|\u0026hellip;.|\nå®¢æœç«¯B:|\u0026hellip;.|..66.|\u0026hellip;.|\næ¯å¸§éƒ½åŒæ­¥ï¼Œå¤„ç†ä¸‹ä¸€å¸§ä¹‹å‰ï¼Œæ¯å¸§éƒ½è¦åŒæ­¥ï¼ŒåŒæ ·çš„è¾“å…¥\u0026mdash;\u0026gt;åŒæ ·çš„è¾“å‡º\nè·³å¸§ å¿«é€Ÿçš„åŒæ­¥å®Œè¿‡æ—¶çš„å¸§ï¼Œç›´åˆ°æœ€æ–°çš„å¸§\næ§åˆ¶æˆ‘ä»¬çš„å®¢æœç«¯ï¼Œæ¥æ ¹æ®æ“ä½œï¼Œæ¥æ’­æ”¾åŠ¨ç”»ï¼Œæ›´æ–°æˆ‘ä»¬çš„é€»è¾‘æ¨è¿›ï¼Œåˆ›å»ºæ€ªç‰©ï¼Œé˜²å¾¡å¡”ï¼Œç­‰ç­‰é€»è¾‘\né‡‡é›†ä½ è‡ªå·±çš„æ“ä½œï¼Œä¸ŠæŠ¥ç»™å®¢æœç«¯\næœåŠ¡å™¨:\næ”¶åˆ°ç©å®¶çš„æ“ä½œï¼Œæ›´æ–°æœåŠ¡å™¨ä¸Šè®¤ä¸ºç©å®¶å·²ç»å¤„ç†çš„å¸§id\n98å¤„ç†å®Œ\u0026ndash;\u0026gt;99, æœåŠ¡å™¨å‘99å¸§-\u0026gt;å®¢æœç«¯\u0026mdash;\u0026gt; å¤„ç†å®Œ99å¸§ï¼Œå®¢æœç«¯æ”¶é›†100å¸§æ“ä½œï¼ŒæœåŠ¡å™¨æ”¶åˆ°100å¸§æ“ä½œ 100 - 1å·²ç»åŒæ­¥å®Œäº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å§98å˜æˆ99å¸§ä¹Ÿå°±æ˜¯ å˜æˆ98\u0026ndash;\u0026gt;99\nå¦‚æœæ”¶åˆ°ç©å®¶æ“ä½œçš„å¸§idï¼Œnext_frame_opts.frameid ç­‰äºé©¬ä¸Šè¦è§¦å‘çš„å¸§idï¼Œè¯´æ˜æ”¶åˆ°äº†ç©å®¶è¿‡æ—¶çš„æ“ä½œ\nå‡è®¾æœåŠ¡å™¨å·²ç»å¤„ç†å®Œ99å¸§ï¼Œé©¬ä¸Šè¦ä¸‹å‘100å¸§äº†ï¼Œè¿™ä¸ªæ—¶å€™å®¢æœç«¯è¿˜ä¸Šä¼ 99å¸§ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºç©å®¶å› ä¸ºç½‘ç»œæˆ–è€…ç‰¹æ®ŠåŸå› å‘é€äº†è¿‡æ—¶çš„æ“ä½œï¼Œæ‰€ä»¥ç›´æ¥ä¸¢å¼ƒ\nè¿™æ ·ä¸¢å¼ƒä¼šå½±å“ç©å®¶çš„æ‰‹æ„Ÿå—\nä¸¢å¸§è‚¯å®šä¼šå½±å“ç©å®¶çš„æ‰‹æ„Ÿï¼Œä½†æ˜¯åŸºæœ¬ä¸å½±å“ç©å®¶æ“ä½œï¼Œ15fpsï¼ŒæŒ‰ä¸€ä¸ªæŒ‰é’®åŸºæœ¬4æ¬¡ï¼Œä¸­é—´ä¸¢ä¸€å¸§ï¼Œä¸å¤ªä¼šå½±å“ç©å®¶æ•´ä½“ï¼ŒåŸºæœ¬ç©å®¶æ„Ÿå—ä¸å‡ºæ¥ã€‚\nä¿å­˜ç©å®¶çš„æ“ä½œï¼Œç­‰å¾…ä¸‹ä¸€å¸§çš„è§¦å‘ï¼Œgotoåˆ°é€»è¾‘4\nå¦‚ä½•å…‹æœudpçš„æ—¶åºå’Œä¸¢åŒ…é—®é¢˜ å®¢æœç«¯: ä¸¢åŒ…, æ™šåˆ°ï¼ŒæœåŠ¡å™¨ä¼šè¡¥å‘ä¸¢æ‰çš„å¸§\næœåŠ¡å™¨: ä¸¢åŒ…, æ²¡æœ‰å¤ªå¤šçš„å½±å“ï¼Œ ä¸‹ä¸€å¸§é©¬ä¸Šå°±å¯ä»¥å¤„ç†\né˜²å¤–æŒ‚ è§†é‡å¤–æŒ‚\nåˆ’åˆ†åœ°å›¾åŒºåŸŸ ç©å®¶ä¿¡æ¯åˆ†å±‚ å±æ€§å¤–æŒ‚ å¤šå®¢æˆ·ç«¯çŠ¶æ€æ ¡éªŒï¼Œå®¢æˆ·ç«¯æ‰§è¡Œå®Œæ¯ä¸ªé€»è¾‘å¸§åï¼Œæ ¹æ®æ¸¸æˆçš„çŠ¶æ€è®¡ç®—å‡ºä¸€ä¸ª Hashå€¼ï¼Œç”¨å…¶æ ‡å®šä¸€ä¸ªå…·ä½“çš„æ¸¸æˆçŠ¶æ€ã€‚ä¸åŒå®¢æˆ·ç«¯é€šè¿‡å¯¹æ¯”è¿™ä¸ªå€¼ï¼Œå³å¯åˆ¤æ–­å®¢æˆ·ç«¯ä¹‹é—´æ˜¯å¦ä¿æŒåŒæ­¥\næ•°æ®çš„åŠ å¯†å¤„ç†\nè¾“å…¥çš„åˆç†æ€§æ£€æµ‹\næœåŠ¡å™¨è¿è¡Œä¸€ä¸ªç²¾ç®€çš„å¯ä¿¡èµ–çš„å®¢æˆ·ç«¯ç¯å¢ƒï¼Œå¾—åˆ°å¯ä¿¡èµ–çš„æ•°æ®\nåå¤–æŒ‚æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è®®é¢˜ã€‚å¸§åŒæ­¥ç»“æ„ä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½åœ¨ç©å®¶æœ¬åœ°ï¼Œç†è®ºä¸Šç©å®¶å¯ä»¥ä»»æ„ä¿®æ”¹è¿™äº›æ•°æ®ã€‚è¿™é‡Œä¸è®¨è®ºä¼ ç»Ÿçš„åŠ å£³åŠåè°ƒè¯•æŠ€æœ¯ã€‚è¿™é‡Œè®¨è®ºåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¸§åŒæ­¥æ¡†æ¶èƒ½å¤Ÿé€šè¿‡ä»€ä¹ˆæ–¹æ³•æ¥è§£å†³è¯¥é—®é¢˜ã€‚æ¡†æ¶èƒ½æä¾›è‡³å°‘3ç§ä¿æŠ¤: a. å…³é”®æ•°æ®ä¿æŠ¤ï¼Œb. è™šæ‹ŸåŒ–, c. æœåŠ¡å™¨åéªŒè¯ã€‚å…³é”®æ•°æ®ä¿æŠ¤å¯ä»¥æœ‰å¾ˆå¤šæŠ€æœ¯ï¼Œæ¡†æ¶å¯¹æ ¸å¿ƒæ•°æ®ï¼Œå¯ä»¥åšå†…å­˜åŠ å¯†ï¼Œå†…å­˜å¤šæ‹·è´å†—ä½™ä¿æŠ¤ç­‰ã€‚æ¡†æ¶æä¾›è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œéƒ¨åˆ†ä»£ç å¯ä»¥åœ¨è™šæ‹Ÿæœº(lua)ä¸­ç›´æ¥æ‰§è¡Œï¼Œç ´è§£éš¾åº¦ä¼šå¢åŠ (å‰ææ˜¯èµ„æºä¿æŠ¤è¶³å¤Ÿ)ã€‚æœåŠ¡å™¨åéªŒè¯æ˜¯æ€æ‰‹é”ï¼ŒéªŒè¯æœåŠ¡å™¨èƒ½è¿è¡Œæ¸¸æˆå½•åƒï¼Œå¹¶ç›´æ¥å¾—å‡ºæ¸¸æˆæˆ˜æ–—ç»“æœï¼Œä»»ä½•ä½œå¼Šéƒ½æ— æ‰€éå½¢ã€‚\nå› æ­¤å¯¹äºå¸§åŒæ­¥ï¼Œåå¤–æŒ‚ç›¸å¯¹æ˜¯ä¸€ä»¶æ¯”è¾ƒå®¹æ˜“çš„äº‹æƒ…ã€‚æ¸¸æˆè¿‡ç¨‹ä¸­ï¼Œç©å®¶ä½œå¼Šåªä¼šå½±å“åˆ°è‡ªå·±ï¼Œä¸ä¼šå½±å“åˆ°ä»–äººã€‚æ¸¸æˆç»“ç®—æ—¶ï¼Œå½“æœåŠ¡å™¨æ£€æµ‹åˆ°ç©å®¶ä¹‹é—´æ¸¸æˆç»“æœä¸ä¸€è‡´æ—¶ï¼Œé€šè¿‡éªŒè¯æœåŠ¡å™¨ï¼Œå¯¹æ¸¸æˆå½•åƒè¿›è¡ŒéªŒè¯è®¡ç®—ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å‘ç°æ˜¯å“ªä¸ªç©å®¶å‘ç”Ÿäº†ä½œå¼Šã€‚\næ€ä¹ˆä¼˜åŒ–å¡é¡¿çš„é—®é¢˜ bufferç¼“å­˜\næœ¬åœ°æ’å€¼å¹³æ»‘åŠ é€»è¾‘ä¸è¡¨ç°åˆ†ç¦»\nä½¿ç”¨ UDPï¼ˆåœ¨æ‰‹æœºç¯å¢ƒä¸‹ï¼Œå¼±ç½‘çš„æƒ…å†µä¸‹ï¼ŒTCPå¾ˆéš¾æ¢å¤é‡è¿ï¼‰\næœåŠ¡ç«¯ Sleep(1)ï¼Œå¹¶ä¸æ˜¯ä»£è¡¨ä¼‘æ¯ 1msï¼Œå…·ä½“ç²¾åº¦çœ‹æ“ä½œç³»ç»Ÿã€‚ï¼ˆwindowsçº¦15msï¼Œlinuxçº¦1msï¼‰\nè¦åœ¨ windowsä¸Šæµ‹è¯•éœ€è¦å°†å…¨å±€è®¾ç½®é«˜ç²¾åº¦è®¡æ—¶å™¨ timeBeginPeriod(1)ï¼Œæœ‰äº›åˆ«çš„è½¯ä»¶å¼€å¯æ—¶ä¼šè®¾ç½®å…¨å±€çš„ç²¾åº¦ã€‚\nå½“è°ƒç”¨Sleepï¼ˆ1ï¼‰æ—¶ï¼ŒCPUä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä»¥èŠ‚çœç”µé‡ï¼Œå› æ­¤ï¼Œå¦‚æœCPUå¤„äºç¡çœ çŠ¶æ€ï¼Œæ“ä½œç³»ç»Ÿï¼ˆOSï¼‰å¦‚ä½•å”¤é†’ä½ çš„çº¿ç¨‹ï¼Ÿç­”æ¡ˆæ˜¯ç¡¬ä»¶ä¸­æ–­ã€‚æ“ä½œç³»ç»Ÿå¯¹è®¡æ—¶å™¨èŠ¯ç‰‡è¿›è¡Œç¼–ç¨‹ï¼Œç„¶åè¯¥è®¡æ—¶å™¨èŠ¯ç‰‡è§¦å‘ä¸­æ–­ä»¥å”¤é†’CPUï¼Œç„¶åæ“ä½œç³»ç»Ÿå¯ä»¥è°ƒåº¦çº¿ç¨‹\nè®¡æ—¶å™¨ä¸­æ–­ä¹‹é—´çš„é—´éš”å–å†³äºWindowsç‰ˆæœ¬å’Œä½ çš„ç¡¬ä»¶ï¼Œä½†åœ¨æˆ‘æœ€è¿‘ä½¿ç”¨çš„æ¯å°è®¡ç®—æœºä¸Šï¼Œé»˜è®¤é—´éš”ä¸º15.625æ¯«ç§’ï¼ˆ1,000æ¯«ç§’é™¤ä»¥64ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨æŸä¸ªéšæœºæ—¶é—´è°ƒç”¨Sleepï¼ˆ1ï¼‰ï¼Œé‚£ä¹ˆå°†æ¥æ¯å½“ä¸‹ä¸€ä¸ªä¸­æ–­è§¦å‘æ—¶ï¼ˆæˆ–è€…å¦‚æœä¸‹ä¸€ä¸ªä¸­æ–­è¿‡æ—©ï¼Œåˆ™åœ¨æ­¤ä¹‹åè§¦å‘ï¼‰ï¼Œä½ å¯èƒ½ä¼šåœ¨1.0æ¯«ç§’è‡³16.625æ¯«ç§’ä¹‹é—´çš„æŸä¸ªæ—¶é—´è¢«å”¤é†’ã€‚\n","permalink":"https://frog-game.github.io/posts/blog/zhentongbu/","summary":"ä¸ºå•¥é€‰æ‹©å¸§åŒæ­¥ å’Œå†™å•æœºæ¸¸æˆç±»ä¼¼ï¼Œå®¢æœç«¯æ”¶é›†è‡ªå·±çš„æŒ‡ä»¤æ“ä½œå‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿›è¡Œæ”¶é›†å¹¿æ’­ç»™æ‰€æœ‰çš„ç©å®¶ï¼Œå®¢æœç«¯æœ¬åœ°é€šè¿‡æ”¶åˆ°çš„åŒ…æ¥æ¨è¿›æ¸¸æˆè¿›åº¦ æœ","title":"å¸§åŒæ­¥"},{"content":"å‰è¨€ æ— ç¼å¤§åœ°å›¾åªæ˜¯å¤–åœ¨è¡¨ç°ï¼Œå…¶å®éƒ½æ˜¯æœ‰ç¼éš™çš„ï¼Œç°åœ¨çš„ç”µè„‘æ€§èƒ½è¿˜ä¸è¶³ä»¥åŠ è½½ä¸€å¼ éå¸¸å¤§çš„åœ°å›¾ï¼Œæ¯”å¦‚80å…¬é‡Œï¼Œç”šè‡³å‡ ç™¾ï¼Œå‡ åƒå…¬é‡Œè¿™ä¹ˆå¤§çš„åœ°å›¾ï¼Œç”µè„‘åšä¸åˆ°ï¼Œæ‰‹æœºå°±æ›´åŠ ä¸ç”¨è¯´äº† è¿™ç±»å¤§åœ°å›¾ï¼Œåœ¨å®¢æœç«¯éƒ½æ˜¯åˆ†åŒºåŸŸè¿›è¡ŒåŠ è½½ï¼Œä¹Ÿå°±æ˜¯ä¼šè¿›è¡Œåˆ‡å‰²ï¼Œæ¯”å¦‚åƒç»åœ°æ±‚ç”Ÿè¿™æ ·çš„æ¸¸æˆï¼Œå¤§æ¦‚80å…¬é‡Œå·¦å³å¤§çš„åœ°å›¾ï¼Œä¼šè¢«åˆ‡å‰²æˆ100 *100 ä¸ªæ ¼å­ï¼Œå¤§æ¦‚æ¯ä¸ªæ ¼å­800ç±³å·¦å³ï¼Œæ¯ä¸ªæ ¼å­ä¼šæ‰“ä¸Šç´¢å¼•æ ‡è®°ï¼Œå½“å®¢æœç«¯åœ¨è¿›è¡Œç§»åŠ¨çš„æ—¶å€™å°±ä¼šæ ¹æ®è§†é‡ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¹å®«æ ¼åŒºåŸŸï¼Œç„¶åæ ¹æ®è§†é‡æ–°æ—§å¯¹åœ°å›¾å—è¿›è¡Œé¢„åŠ è½½å’Œåˆ é™¤ã€‚ åœ¨ç»åœ°æ±‚ç”Ÿè·³ä¼é˜¶æ®µï¼Œå…¶å®æ˜¯æ•´å¼ åœ°å›¾è¿›è¡ŒåŠ è½½çš„ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ä¸æ˜¯åŠ è½½çš„é«˜ç²¾åº¦åœ°å›¾å—ï¼Œè€Œæ˜¯ä¸€ä¸ªç»è¿‡ç®€åŒ–çš„åœ°å›¾ï¼Œè€Œä¸”è¿™ç§åœ°å›¾å—ä¸ä¼šåªæœ‰ä¸€ä»½ï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä»½ï¼Œè¿™ç§ä¹Ÿå«å¤šå±‚LODï¼Œä¹Ÿå°±æ˜¯éšç€ä½ è·³ä¼ä»¥åï¼Œè·ç¦»åœ°é¢è¶Šæ¥è¶Šè¿‘ï¼Œç¨‹åºä¼šç»™ä½ åˆ‡æ¢ä¸åŒçš„åœ°å›¾å—ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä½ åœ¨è·³ä¼çš„è¿‡ç¨‹ä¸­æœ‰æ—¶å€™ä¼šçœ‹åˆ°é—ªçƒæƒ…å†µï¼Œå…¶å®è¿™ä¸ªæ—¶å€™æ˜¯ç¨‹åºåœ¨ç»™ä½ åˆ‡æ¢ä¸åŒçš„åœ°å›¾å— æ„å»ºå¤§ä¸–ç•Œåœ°å›¾ åˆ©ç”¨bspTreeåŸç†å¯¹åœ°å›¾è¿›è¡ŒåŠ¨æ€åˆ‡å‰² åˆ†è£‚æ¡ä»¶ï¼š\näººæ•°è¾¾åˆ°ä¸Šçº¿ åŒºåŸŸå¤§å°å¿…é¡»è¶…è¿‡å¤šå¤§ï¼Œæ¯”å¦‚å¿…é¡»è¾¾åˆ°50 *50 å¤§å°æ‰èƒ½åˆ†è£‚ 1.åœºæ™¯ç®¡ç†æœåŠ¡å™¨å¯åŠ¨ä»¥åä¼šåˆ›å»ºä¸€ä¸ªå…¨å±€çš„spaceï¼Œå‡è®¾å¤§å°æ˜¯100 * 100ï¼ŒåŒæ—¶ä¹Ÿåˆ›å»ºä¸€ä¸ªåŒæ ·å¤§å°çš„cell1\nå‡å¦‚æŒ‰å®½10è¿›è¡Œåˆ†å‰²ï¼Œä¼šå½¢æˆ 10 * 100,90 * 100 ä¸¤ä¸ªé•¿æ–¹å½¢\nå‡å¦‚æŒ‰é•¿90æ¥å¯¹å‰©ä¸‹çš„3è¿›è¡Œåˆ†å‰²\nä¸€ç›´å¾€ä¸‹åˆ‡å‰²çš„è¯ï¼Œå·¦è¾¹ä¼šè¶Šæ¥è¶Šå¤šï¼Œå³å„¿å­ä¼šè¶Šæ¥è¶Šå°‘ï¼Œä»è€Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœä½†æ˜¯ä¹Ÿæœ‰åˆ†å‰²ä¹Ÿæœ‰æ¡ä»¶\nå…„å¼Ÿä¸¤éƒ½ä¸ºå¶å­èŠ‚ç‚¹ å·¦äºŒå­è¢«åˆ†å‰²åçš„å¤§å°ä¸åº”è¯¥å¤§äºå³å„¿å­ åˆ©ç”¨bspTreeåŸç†å¯¹åœ°å›¾è¿›è¡ŒåŠ¨æ€åˆå¹¶ åˆå¹¶æ¡ä»¶:\nCellåŒºåŸŸå°äº100(å¯é…) äººæ•°å°äºæŒ‡å®šäººæ•°(å¯é…) å¾…åˆå¹¶çš„2ä¸ªç»“ç‚¹å¿…é¡»æ˜¯å¶å­ç»“ç‚¹ åˆ é™¤å¾…åˆå¹¶çš„ä¸¤ä¸ªå„¿å­ç»“ç‚¹ï¼Œä¿®æ”¹çˆ¶äº²ç»“ç‚¹çš„åœºæ™¯åŒºåŸŸ åˆå¹¶å‰\nåˆå¹¶å\nå½“ä¸ç®¡æ˜¯åˆ†å‰²è¿˜æ˜¯åˆå¹¶å‘ç°ä»–çš„å®ä½“å·²ç»ä¸å†å½“å‰celläº†é‚£ä¹ˆå®ä½“åº”è¯¥è¿ç§»åˆ°ä»–åˆé€‚çš„åœ°æ–¹å»\nè¾¹ç¼å¤„ç† å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰3ä¸ªcellServerè¿›ç¨‹ç®¡ç†ç€å„è‡ªçš„ABC3ä¸ªcellå—\nå½“ä¸Šé¢çš„aè§’è‰²åˆ°è¾¾è¾¹ç•Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œrealå’Œghostçš„æ•°æ®åŒæ­¥ï¼Œå¼€å§‹åœ¨é‡å åŒºåŸŸè¿›è¡Œè½¬æ¢ï¼Œè¿›è¡Œè½¬æ¢çš„åŒºåŸŸä¸€èˆ¬è¦æ¯”è‡ªå·±çš„è§†é‡èŒƒå›´è¦å¤§ï¼Œæ¯”å¦‚ç°åœ¨çš„é‡å è½¬æ¢åŒºåŸŸå°±æ˜¯é‚£ä¸ªçº¢è‰²åœˆï¼Œå¤§äºè‡ªå·±çš„è§†é‡é»‘è‰²åœˆ\nåœ¨entity aoièŒƒå›´å†…ï¼Œåˆä¸åœ¨åŒä¸€cellçš„ï¼Œåœ¨è¿™ä¸ªcellä¸Šåˆ›å»ºåŒåæ ‡çš„ä¸€ä¸ªghost é•œåƒï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æš—çº¢è‰²å’Œç»¿è‰²æ˜Ÿæ˜Ÿå°±æ˜¯BC cellä¸Šé¢çš„ghosté•œåƒ ghost åªèƒ½æ˜¯åªè¯»çš„ï¼Œæ¯æ¬¡å»ä¿®æ”¹åªèƒ½å…ˆä¿®æ”¹realå®ä½“ç„¶ååœ¨å»åŒæ­¥ghostå±æ€§ æ–°çš„è¾¹ç¼å¤„ç†æ–¹æ³• æ¯”å¦‚ç°åœ¨æœ‰A Bä¸¤ä¸ªcell è¿™ä¸ªæ—¶å€™é»„è‰²çš„è§’è‰²ä»Aèµ°å‘äº†B ç°åœ¨è¿‡äº†è¾¹ç•Œï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨ä¸ç”¨åˆ›å»ºé•œåƒå’Œå®ä½“çš„æ–¹æ³•æ¥å®ç°æ— ç¼åœ°å›¾ï¼Œè€Œæ˜¯ç”¨ä¼ é€çš„æ–¹å¼ï¼Œä¼ é€è§¦å‘çš„å®é™…å°±æ˜¯é‚£æ ¹ç»¿è‰²çº¿å’Œè¾¹ç•Œçš„è·ç¦»ï¼Œæ¯”å¦‚5ç±³ï¼Œå½“ç©å®¶èµ°åˆ°äº†è¿™ä¸ªè§¦å‘èŒƒå›´æˆ‘ä»¬å°±å¼€å§‹ç›´æ¥æŠŠäººä¼ é€åˆ°Bï¼Œè¿™æ ·ä¹Ÿä¸ç”¨å¤„ç†ghostå’Œrealä¹‹é—´å®šæ—¶åŒæ­¥ï¼Œè¿˜æœ‰å¼‚æ­¥æŠ€èƒ½å¸¦æ¥çš„å„ç§å¼‚å¸¸æƒ…å†µï¼ŒbugæŸ¥æ‰¾\næŠ€èƒ½å¤„ç† æ”»å‡»æ–¹ä¸€å®šè¦æ˜¯realå®ä½“ï¼Œè¢«æ”»å‡»æ–¹å¯ä»¥æ˜¯realå®ä½“ï¼Œä¹Ÿå¯ä»¥æ˜¯ghostå®ä½“\nä¸‹æ–¹çš„æ•°æ®åŒæ­¥å¯ä»¥å†™åˆ°æ ¸å¿ƒæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å®šæ—¶åŒæ­¥realå®ä½“çš„ä¿¡æ¯åˆ°ghostå®ä½“ä¸Š\nå¯»è·¯ å› ä¸ºä¸–ç•Œåœ°å›¾å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨**è·¯ç‚¹+ å°æ®µè·ç¦»Aæ˜Ÿæˆ–è€…jpsç®—æ³•**æ¥å®ç°å¯»è·¯\nå…ˆæ±‚è·¯ç‚¹ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„åœ°é“å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æƒé‡å€¼æˆ–è€…æ—¶é—´çš„ç»„åˆï¼Œé€šè¿‡**Dijkstra(è¿ªæ°æ–¯ç‰¹æ‹‰)å’Œfloyd(å¼—æ´›ä¼Šå¾·)**ç®—æ³•æ±‚å‡ºæœ€çŸ­è·¯å¾„ï¼Œè¿™äº›è·¯å¾„å¯ä»¥ç¦»çº¿å…ˆæ±‚å‡ºæ¥ï¼Œç­‰ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä½¿ç”¨ è¿˜æ˜¯ä»¥ä¸Šé¢è¿™å›¾ä¸ºä¾‹å­ç°åœ¨ä½ åœ¨çº¢è‰²å°äººé‚£ä¸ªä½ç½®ä¹Ÿå°±æ˜¯å…³åº„ä¸‹é¢å°äººçš„ä½ç½®ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœéšœç¢ç‰©å¤šï¼Œä½ å¯ä»¥éª‘å•è½¦è¿‡æ¥ä¹Ÿå°±æ˜¯ç”¨**Aæ˜Ÿç®—æ³•å¯»è·¯åˆ°æƒ æ–°è¥¿è¡—å—å£ï¼Œå¦‚æœéšœç¢ç‰©å°‘ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ‰“è½¦ï¼Œæˆ–è€…åå¤§å·´ä¹Ÿå°±æ˜¯jpsç®—æ³•åˆ°å½—æ–°è¥¿è¡—å—å£ï¼Œåˆ°äº†èµ·å§‹ç‚¹ä¹‹åï¼Œä½ å°±å¯ä»¥ååœ°é“ä¹Ÿå°±æ˜¯å‰é¢ç”¨Dijkstra(è¿ªæ°æ–¯ç‰¹æ‹‰)å’Œfloyd(å¼—æ´›ä¼Šå¾·)**ç®—æ³•ç®—å‡ºçš„ç¦»çº¿è·¯å¾„ç›´æ¥åˆ°è¾¾ä¸‹é¢çš„åœ°è·Œç›®çš„åœ°å—é”£é¼“å··\nåˆ°äº†å—é”£é¼“å··ä»¥åï¼ŒåŒæ ·ä½ ä¹Ÿå¯ä»¥æŒ‰2æ­¥éª¤ï¼Œé€‰æ‹©æ˜¯**aæ˜Ÿè¿˜æ˜¯jpsç®—æ³•**åˆ°è¾¾å…¬å¸\nå¦‚æœåœ°å›¾è¶…å¤§ï¼Œå…¶å®åœ¨ç”¨**Dijkstra(è¿ªæ°æ–¯ç‰¹æ‹‰)å’Œfloyd(å¼—æ´›ä¼Šå¾·)**ç®—æ³•ç®—åœ°é“å›¾çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥åˆ†å‡ å—åŒºåŸŸç®—å‡ºå„è‡ªåœ°é“è·¯çº¿å›¾ï¼Œç„¶åè¿æ¥èµ·æ¥ï¼Œä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚å¯ä»¥åˆ’åˆ†ï¼Œå½—æ˜Ÿè¥¿è¡—å—å£åˆ°åŒ—åœŸåŸæ˜¯ä¸€ä¸ªåŒºåŸŸï¼ŒåŒ—åœŸåŸåˆ°é¼“æ¥¼å¤§è¡—æ˜¯ä¸ªåŒºåŸŸï¼Œé¼“æ¥¼å¤§è¡—åˆ°å—é”£é¼“å··æ˜¯ä¸ªåŒºåŸŸï¼Œè¿™3ä¸ªåŒºåŸŸå„è‡ªç®—å¥½ï¼Œå„è‡ªå­˜å‚¨å¥½ï¼Œåˆ°æ—¶æ‹¼æ¥èµ·æ¥å°±æ˜¯æƒ æ–°è¥¿è¡—å—å£åˆ°å—é”£é¼“å··çš„æ•´æ¡ç¦»çº¿è·¯çº¿ï¼Œå¦‚ä¸‹å›¾çº¢ï¼Œé»‘ï¼Œé»„ä¸‰ä¸ªæ¡†ï¼Œä»£è¡¨3ä¸ªåŒºåŸŸ\n","permalink":"https://frog-game.github.io/posts/blog/wufengdashijie/","summary":"å‰è¨€ æ— ç¼å¤§åœ°å›¾åªæ˜¯å¤–åœ¨è¡¨ç°ï¼Œå…¶å®éƒ½æ˜¯æœ‰ç¼éš™çš„ï¼Œç°åœ¨çš„ç”µè„‘æ€§èƒ½è¿˜ä¸è¶³ä»¥åŠ è½½ä¸€å¼ éå¸¸å¤§çš„åœ°å›¾ï¼Œæ¯”å¦‚80å…¬é‡Œï¼Œç”šè‡³å‡ ç™¾ï¼Œå‡ åƒå…¬é‡Œè¿™ä¹ˆå¤§çš„åœ°å›¾ï¼Œç”µè„‘","title":"æ— ç¼å¤§ä¸–ç•Œ"},{"content":"ç½‘ç»œå±‚ é€šè¿‡å¤šreactor +å¤šçº¿ç¨‹ + åç¨‹æ± æ–¹å¼ï¼Œå®ç°win,linux,mac 3æ–¹è·¨å¹³å°çš„åº•å±‚é€šè®¯,èƒ½è½»æ¾ä¸‡çº§åˆ«QPSèµ·æ­¥ï¼Œåº”å¯¹é«˜å¹¶å‘è¯·æ±‚é‡å¤§ï¼ŒIOå¯†é›†å‹å’ŒCPUå¯†é›†å‹ä¸šåŠ¡éƒ½èƒ½å¤„ç†\nè¿›ç¨‹ win\nlinux\nmac\nluaè°ƒè¯• æ’ä»¶èƒ½å¯¹å¾®æœåŠ¡luaä»£ç è¿›è¡Œè°ƒè¯•\nè§†é¢‘æ•ˆæœå±•ç¤º å¤šè™šæ‹Ÿæœºæµ‹è¯• linuxæµ‹è¯• çœŸæœºæµ‹è¯• æ—¥å¿—ç›‘æ§ åˆ©ç”¨Ubuntu20.04+mysql8.0+zabbix6.0+elk+filebeat+logstash+grafan æ­å»ºçš„æ¸¸æˆæ—¥å¿—ç›‘æ§ç³»ç»Ÿ èƒ½å¿«é€Ÿçš„æ”¶é›† æŸ¥è¯¢ è¿½è¸ª å®šä½ æŠ¥è­¦é—®é¢˜\ngit hook åˆ©ç”¨git_pre_commit git_pre_reveive å¯¹æäº¤çš„æ¶ˆæ¯è¿›è¡Œä»£ç è§„èŒƒåŒ–æ£€æŸ¥,commit msgæäº¤æ£€æŸ¥,luaè¯­æ³•æ£€æŸ¥,Excelæ£€æŸ¥\nè‡ªåŠ¨åŒ–check,æ ¼å¼åŒ–,ç¼–è¯‘,éƒ¨ç½²,é€šçŸ¥ åˆ©ç”¨gitlab cicd èƒ½å¯¹ä¸Šä¼ ä»¥åçš„ä»£ç è¿›è¡Œ check,æ ¼å¼åŒ–,ç¼–è¯‘,éƒ¨ç½²,é€šçŸ¥\nè‡ªåŠ¨åŒ– check,æ ¼å¼åŒ–,ç¼–è¯‘,éƒ¨ç½²\nç¾¤é€šçŸ¥\nä¸ªäººé€šçŸ¥\nåœ¨çº¿exelååŒå¼€å‘ å±æ€§è‡ªåŠ¨æ›´æ–° luaçš„å·¥ç¨‹åŒ–å¼ºåŒ– Teal Teal å’Œ Lua çš„å…³ç³»å°±ç±»ä¼¼ TypeScript å’Œ JavaScript çš„å…³ç³»ï¼Œæ”¯æŒç»™å·²æœ‰çš„åº“è¿›è¡Œç±»å‹æ ‡è®°ï¼Œæœ€ç»ˆæ˜¯ç¿»è¯‘ä¸º Lua å»å®é™…ä½¿ç”¨çš„ã€‚\nç±»å‹æ ‡è®°å¯ä»¥å†™åœ¨ xx.d.tl æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚\nlocal record os exit: function(number) end return os åœ¨ Teal ä¸­ä¸»è¦æ–°å¢äº† recordã€array å’Œ map ç±»å‹ï¼Œæ›´å¤šçš„è¯­è¨€ç‰¹æ€§å¯ä»¥è§æ–‡æ¡£ https://github.com/teal-language/tl/blob/master/docs/tutorial.md\nä»£ç æ ·ä¾‹\n-- record ç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­çš„ç»“æ„ä½“ local record arg_t githubåœ°å€åœ¨ä¸‹è¾¹\nteal-language/tl: The compiler for Teal, a typed dialect of Lua (github.com)\nå«é’è¯­è¨€ï¼Œ\nå®‰è£…é¢‡è´¹äº†ä¸€ç•ªåŠŸå¤«,ä¸»è¦æ˜¯æˆ‘å¯¹ç¯å¢ƒä¸ç†Ÿæ‚‰\néœ€è¦luarocksï¼Œ\néœ€è¦mingwï¼ˆå®‰è£…gccï¼‰ï¼Œæ³¨æ„æ˜¯mingwä¸æ˜¯mingw-w64,è¿™tmæ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªé¡¹ç›®\nç„¶åæœ‰ä»€ä¹ˆç”¨å‘¢\næ¥çœ‹ä¸€æ®µæ­£å¸¸çš„luaä»£ç \n//æ­£å¸¸luaä»£ç  local function add(a, b) return a + b end local s = add(1, 2) print(s) è¿™ä»£ç æ‰§è¡Œè‚¯å®šè¿”å›3\n//bug luaä»£ç  local function add(a, b) return a + b end local s = add(\u0026#34;ni\u0026#34;, 2) print(s) ç„¶åæ¥ä¸€æ®µbugä»£ç ï¼Œè¿™ä¸ªbugä»£ç  ä½ ç”¨luac è‚¯å®šæ˜¯æ²¡é—®é¢˜ï¼Œç­‰åˆ°æ‰§è¡ŒæœŸæ‰ä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºluaè®¾è®¡ä¸ºä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œè€Œä¸”è¿™ä»vmå±‚æ¬¡å°±å†³å®šäº†ï¼Œè¿™ä¸ªæƒ…å†µæœ‰ç‚¹åƒjsï¼Œå› ä¸ºåŠ¨æ€åŒ–ï¼Œé”™è¯¯æ£€æŸ¥æ—¶æœºè¢«æ‹–åˆ°äº†è¿è¡Œæ—¶ï¼Œä¸è¿è¡Œï¼Œæ— æ³•å‘ç°é—®é¢˜ï¼ˆäººçœ¼é™¤å¤–ï¼‰\nè½¯ä»¶å·¥ç¨‹çš„å®è·µä¸­ï¼Œä»£ç é™æ€æ£€æŸ¥èƒ½å‘ç°å¤ªå¤šçš„é—®é¢˜ï¼ˆé™æ€ç±»å‹ç¼–ç¨‹è¯­è¨€ï¼‰ï¼Œjså› ä¸ºå¾®è½¯çš„typescriptå¾—åˆ°äº†æå¤§çš„å·¥ç¨‹åŒ–åŠ å¼ºã€‚\né’è¯­è¨€å°±æ˜¯å¯¹luaçš„ç±»å‹åŒ–åŠ å¼ºï¼Œå’Œtsä¹‹äºjsæ˜¯ä¸€æ ·çš„æ¦‚å¿µã€‚\n//é’è¯­è¨€bugä»£ç  local function add(a: number, b: number): number return a + b end local s = add(\u0026#34;a1\u0026#34;,2) print(s) ç„¶åä½¿ç”¨é’è¯­è¨€ï¼ŒåŠ ä¸Šç±»å‹æ ‡æ³¨ï¼Œæ ‡æ³¨çš„å½¢å¼ä¹Ÿåƒæäº†typescript\nç„¶åå°±å¯ä»¥ tl checkæ¥æ£€æŸ¥è¿™ä¸ªé’è¯­è¨€ä»£ç çš„é—®é¢˜äº†\nä¸ç”¨æ‰§è¡Œå°±å¯ä»¥æå‰çŸ¥é“ç¬¬äº”è¡Œæœ‰ä¸ªbugï¼Œè¿™å°±æ˜¯é™æ€ç±»å‹çš„åŠŸèƒ½æ‰€åœ¨ã€‚\né€šè¿‡tl gen æŒ‡ä»¤ å¯ä»¥å°†é’è¯­è¨€ä»£ç ç¼–è¯‘ä¸ºluaï¼Œè¿™ä¸ªæ€è·¯ä¹Ÿæ˜¯å’Œts=\u0026gt;jsä¸€è‡´çš„ã€‚\nä»–çš„å·¥ç¨‹åŒ–ä¼˜åŠ¿å‚è€ƒtså¸¦æ¥çš„jsé©å‘½æ€§ç”Ÿæ€è¿›åŒ–å°±å¯ä»¥æƒ³è±¡ä¸€äºŒã€‚\nçƒ­æ›´æ–° åœ¨ä»£ç å¤ç”¨å’Œç»„ç»‡æ•°æ®æ–¹é¢ï¼Œé¢å‘å¯¹è±¡å¯èƒ½æ˜¯å¤§å®¶ç¬¬ä¸€ååº”ã€‚é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ç»§æ‰¿ï¼Œå°è£…ï¼Œå¤šæ€ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½è§£å†³ä¸å°‘ä»£ç å¤ç”¨ï¼Œæ•°æ®å¤ç”¨çš„é—®é¢˜ã€‚ä¸è¿‡é¢å‘å¯¹è±¡ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒä¹Ÿæœ‰æå¤§çš„ç¼ºé™·ï¼š\næ•°æ®ç»“æ„è€¦åˆæ€§æå¼º ä¸€æ—¦çˆ¶ç±»ä¸­å¢åŠ æˆ–åˆ é™¤æŸä¸ªå­—æ®µï¼Œå¯èƒ½è¦å½±å“åˆ°æ‰€æœ‰å­ç±»ï¼Œå½±å“åˆ°æ‰€æœ‰å­ç±»ç›¸å…³çš„é€»è¾‘ã€‚è¿™æ˜¾å¾—éå¸¸ä¸çµæ´»ï¼Œåœ¨ä¸€å¥—å¤æ‚çš„ç»§æ‰¿ä½“ç³»ä¸­ï¼Œå¾€çˆ¶ç±»ä¸­æ”¹å˜å­—æ®µä¼šå˜å¾—è¶Šæ¥è¶Šéº»çƒ¦ï¼Œæ¯”æ–¹è¯´ABCæ˜¯Dçš„å­ç±»ï¼ŒæŸå¤©å‘ç°éœ€è¦å¢åŠ ä¸€ä¸ªABéƒ½æœ‰çš„æ•°æ®ï¼Œä½†æ˜¯Cæ²¡æœ‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®è‚¯å®šä¸å¥½æ”¾åˆ°çˆ¶ç±»ä¸­ï¼Œåªèƒ½å°†ABæŠ½è±¡å‡ºæ¥ä¸€ä¸ªçˆ¶ç±»Eï¼ŒEç»§æ‰¿äºDï¼ŒABå…±æœ‰çš„å­—æ®µåŠ åˆ°Eä¸­ï¼Œä¸€æ—¦ç»§æ‰¿ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ¥å£ä¹Ÿè¦æ”¹å˜ï¼Œæ¯”æ–¹è¯´ä¹‹å‰æœ‰ä¸ªæ¥å£ä¼ å…¥å‚æ•°ç±»å‹æ˜¯Eï¼Œå½“ABä¸å†éœ€è¦å…±ç”¨çš„é‚£ä¸ªå­—æ®µï¼Œé‚£ä¹ˆéœ€è¦è°ƒæ•´ç»§æ‰¿å…³ç³»ï¼Œè®©ABé‡æ–°ç»§æ‰¿Dï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£çš„ä¼ å…¥å‚æ•°ç±»å‹éœ€è¦æ”¹æˆDï¼Œå…¶ä¸­çš„é€»è¾‘ä»£ç å¾ˆå¯èƒ½ä¹Ÿè¦å‘ç”Ÿè°ƒæ•´ã€‚æ›´å¯æ€•çš„æ˜¯æ¸¸æˆé€»è¾‘å˜åŒ–éå¸¸å¤æ‚ï¼Œéå¸¸é¢‘ç¹ï¼Œå¯èƒ½ä»Šå¤©åŠ äº†ä¸ªå­—æ®µï¼Œæ˜å¤©åˆåˆ æ‰äº†ï¼Œå‡å¦‚æ¯æ¬¡éƒ½è¦å»è°ƒæ•´ç»§æ‰¿ç»“æ„ï¼Œè¿™ç®€ç›´å°±æ˜¯å™©æ¢¦ã€‚ç»§æ‰¿ç»“æ„é¢å¯¹é¢‘ç¹çš„æ•°æ®ç»“æ„è°ƒæ•´æ„Ÿè§‰å¾ˆæ— åŠ›\néš¾ä»¥çƒ­æ’æ‹” ç»§æ‰¿ç»“æ„æ— æ³•è¿è¡Œæ—¶å¢åŠ åˆ é™¤å­—æ®µï¼Œæ¯”å¦‚ç©å®¶Playerå¹³å¸¸æ˜¯èµ°è·¯ï¼Œä½¿ç”¨åéª‘åå°±éª‘é©¬ã€‚é—®é¢˜æ˜¯åéª‘çš„ç›¸å…³ä¿¡æ¯å°±éœ€è¦ä¸€ç›´æŒ‚åœ¨Playerå¯¹è±¡ä¸Šé¢ã€‚è¿™å°±æ˜¾å¾—å¾ˆä¸çµæ´»ï¼Œæˆ‘ä¸éª‘é©¬çš„æ—¶å€™å†…å­˜ä¸­ä¸ºå•¥è¦æœ‰é©¬çš„æ•°æ®ï¼Ÿæ¥å£ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼Œä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£å°±æ°¸è¿œç²˜åœ¨äº†è¿™ä¸ªç±»èº«ä¸Šï¼Œä½ æƒ³ç”©æ‰å¥¹éƒ½ä¸è¡Œï¼Œè¿˜æ˜¯ä»¥éª‘é©¬ä¸ºä¾‹ï¼Œç©å®¶Playerå¯ä»¥è¿›è¡Œéª‘è¡Œï¼Œé‚£ä¹ˆå¯èƒ½ç»§æ‰¿ä¸€ä¸ªéª‘è¡Œçš„æ¥å£ï¼Œé—®é¢˜æ˜¯ï¼Œå½“æˆ‘è¿™ä¸ªPlayerä»åéª‘ä¸Šä¸‹æ¥æ—¶ï¼Œç©å®¶Playerèº«ä¸Šè¿˜æ˜¯æœ‰éª‘è¡Œçš„æ¥å£ï¼Œæ ¹æœ¬æ²¡æ³•åŠ¨æ€åˆ æ‰è¿™ä¸ªæ¥å£ï¼å¯èƒ½ä¾‹å­ä¸¾å¾—ä¸æ˜¯å¾ˆå¯¹ï¼Œä½†æ˜¯é“ç†è¡¨è¿°çš„åº”è¯¥å¾ˆæ¸…æ¥šäº†\nä½¿ç”¨é¢å‘å¯¹è±¡å¯èƒ½å¯¼è‡´ç¾éš¾æ€§åæœï¼Œæ¸¸æˆå¼€å‘ä¸­æœ‰æ–°äººæœ‰è€äººï¼Œæœ‰æŠ€æœ¯å¥½çš„ï¼Œæœ‰æŠ€æœ¯å·®çš„ã€‚äººéƒ½æ˜¯å–œæ¬¢å·æ‡’çš„ï¼Œå½“ä½ å‘ç°è°ƒæ•´ç»§æ‰¿å…³ç³»éº»çƒ¦çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ABä¸­å¢åŠ ä¸€ä¸ªå­—æ®µä¸ºäº†çœäº‹ç›´æ¥å°±æ”¾åˆ°çˆ¶ç±»Dä¸­å»äº†ã€‚å¯¼è‡´Cè«åå¥‡å¦™çš„å¤šäº†ä¸€ä¸ªæ— ç”¨çš„å­—æ®µã€‚å…³é”®è¿˜æ²¡æ³•å‘ç°ï¼Œæœ€åå¯¼è‡´çˆ¶ç±»Dè¶Šæ¥è¶Šå¤§ï¼Œåˆ°æœ€åæœ‰å¯èƒ½å¹²è„†å°±ä¸ç”¨ABCäº†ï¼Œç›´æ¥è®©æ‰€æœ‰å¯¹è±¡éƒ½å˜æˆDï¼Œæ–¹ä¾¿å˜›ï¼æ˜¯çš„ï¼Œå¾ˆå¤šæ¸¸æˆå°±æ˜¯è¿™ä¹ˆå¹²çš„ï¼Œå¼€å‘åˆ°æœ€åæ ¹æœ¬å°±ä¸ç®¡ç»§æ‰¿å…³ç³»äº†ï¼Œå› ä¸ºæƒ³ç®¡ä¹Ÿç®¡ä¸äº†äº†ã€‚\né¢å‘å¯¹è±¡åœ¨é¢å¯¹å¤æ‚çš„æ¸¸æˆé€»è¾‘æ—¶å¾ˆæ— åŠ›ï¼Œæ‰€ä»¥å¾ˆå¤šæ¸¸æˆå¼€å‘è€…åˆå€’é€€äº†å›å»ï¼Œä½¿ç”¨é¢å‘è¿‡ç¨‹è¿›è¡Œå¼€å‘æ¸¸æˆï¼Œé¢å‘è¿‡ç¨‹ï¼Œç®€å•ç²—æš´ï¼Œä¸è€ƒè™‘å¤æ‚çš„ç»§æ‰¿ï¼Œä¸è€ƒè™‘æŠ½è±¡ï¼Œä¸è€ƒè™‘å¤šæ€ï¼Œæ˜¯å¼€å‘å±Šçš„freestyleï¼ŒæŒ½èµ·è¢–å­å°±å¼€æ’¸ï¼Œä½†åŒæ—¶ï¼Œä»£ç é€»è¾‘çš„å¤ç”¨æ€§ï¼Œæ•°æ®çš„å¤ç”¨æ€§ä¹Ÿå¤§å¤§é™ä½ã€‚é¢å‘è¿‡ç¨‹ä¹Ÿä¸æ˜¯ä¸€ç§å¥½çš„æ¸¸æˆå¼€å‘æ¨¡å¼ã€‚\nç»„ä»¶æ¨¡å¼å¾ˆå¥½çš„è§£å†³äº†é¢å‘å¯¹è±¡ä»¥åŠé¢å‘è¿‡ç¨‹çš„ç§ç§ç¼ºé™·ï¼Œåœ¨æ¸¸æˆå®¢æˆ·ç«¯ä¸­ä½¿ç”¨éå¸¸å¹¿æ³›ï¼ŒUnity3dï¼Œè™šå¹»4ï¼Œç­‰ç­‰éƒ½ä½¿ç”¨äº†ç»„ä»¶æ¨¡å¼ã€‚ç»„ä»¶æ¨¡å¼çš„ç‰¹ç‚¹ï¼š 1.é«˜åº¦æ¨¡å—åŒ–ï¼Œä¸€ä¸ªç»„ä»¶å°±æ˜¯ä¸€ä»½æ•°æ®åŠ ä¸€æ®µé€»è¾‘ 2.ç»„ä»¶å¯çƒ­æ’æ‹”ï¼Œéœ€è¦å°±åŠ ä¸Šï¼Œä¸éœ€è¦å°±åˆ é™¤ 3.ç±»å‹ä¹‹é—´ä¾èµ–æå°‘ï¼Œä»»ä½•ç±»å‹å¢åŠ æˆ–åˆ é™¤ç»„ä»¶ä¸ä¼šå½±å“åˆ°å…¶å®ƒç±»å‹ã€‚\nä½†æ˜¯ç›®å‰åªæœ‰æå°‘æœ‰æœåŠ¡ç«¯ä½¿ç”¨äº†ç»„ä»¶çš„è®¾è®¡ï¼Œå®ˆæœ›å…ˆé”‹æœåŠ¡ç«¯åº”è¯¥æ˜¯ä½¿ç”¨äº†ç»„ä»¶çš„è®¾è®¡ï¼Œå®ˆæœ›å…ˆé”‹çš„å¼€å‘äººå‘˜ç§°ä¹‹ä¸ºECSæ¶æ„ï¼Œå…¶å®å°±æ˜¯ç»„ä»¶æ¨¡å¼çš„ä¸€ä¸ªå˜ç§ï¼ŒEå°±æ˜¯Entityï¼ŒCå°±æ˜¯Componentï¼ŒSæ˜¯Systemï¼Œå…¶å®å°±æ˜¯å°†ç»„ä»¶Componentçš„é€»è¾‘ä¸æ•°æ®å‰¥ç¦»ï¼Œé€»è¾‘éƒ¨åˆ†å«System\n","permalink":"https://frog-game.github.io/posts/tech/kuangjia-work/","summary":"ç½‘ç»œå±‚ é€šè¿‡å¤šreactor +å¤šçº¿ç¨‹ + åç¨‹æ± æ–¹å¼ï¼Œå®ç°win,linux,mac 3æ–¹è·¨å¹³å°çš„åº•å±‚é€šè®¯,èƒ½è½»æ¾ä¸‡çº§åˆ«QPSèµ·æ­¥ï¼Œåº”å¯¹é«˜å¹¶å‘è¯·æ±‚é‡","title":"æœåŠ¡å™¨ç®€ä»‹"},{"content":"ç½‘ç»œç¼–ç¨‹æµç¨‹ å µå¡IO éå µå¡IO ä¿¡å·é©±åŠ¨IO å¼‚æ­¥ioæ¨¡å‹ å¤šè·¯å¤ç”¨ å•reactor ä»£è¡¨ä½œï¼šredis å†…å­˜æ•°æ®åº“\næ³¨æ„ï¼šredis 6.0 ä»¥åæ˜¯å¤šçº¿ç¨‹\nå•reactor å¤šè¿›ç¨‹æ¨¡å‹ ä»£è¡¨ï¼šnginx\nå•reactoræ¨¡å‹ + ä»»åŠ¡é˜Ÿåˆ— + çº¿ç¨‹æ±  ä»£è¡¨ä½œ:skynet\nä¸»ä» reactor ä»£è¡¨ä½œï¼šnetty\nå¤šreactor + å¤šçº¿ç¨‹ ä»£è¡¨ä½œï¼šmemcache\nå¤šreactor + å¤šçº¿ç¨‹ +åç¨‹æ±  ","permalink":"https://frog-game.github.io/posts/read/wangluo_io_zhongjie/","summary":"ç½‘ç»œç¼–ç¨‹æµç¨‹ å µå¡IO éå µå¡IO ä¿¡å·é©±åŠ¨IO å¼‚æ­¥ioæ¨¡å‹ å¤šè·¯å¤ç”¨ å•reactor ä»£è¡¨ä½œï¼šredis å†…å­˜æ•°æ®åº“ æ³¨æ„ï¼šredis 6.0 ä»¥åæ˜¯å¤šçº¿ç¨‹ å•r","title":"ç½‘ç»œIOæ¨¡å‹æ€»ç»“"},{"content":"tcp æ¡æ‰‹æŒ¥æ‰‹ åºåˆ—å·: åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™æœ‰è®¡ç®—æœºç”Ÿæˆçš„éšæœºæ•°å¹¶ä½œä¸ºåˆå§‹å€¼ï¼Œé€šè¿‡synåŒ…ä¼ ç»™æ¥æ”¶ç«¯ä¸»æœºï¼Œæ¯å‘ä¸€æ¬¡æ•°æ®ï¼Œå°±ç´¯åŠ ä¸€æ¬¡è¯¥æ•°æ®å­—èŠ‚æ•°çš„å¤§å°ï¼Œä¸»è¦æ˜¯ç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºé—®é¢˜\nç¡®è®¤åº”ç­”å·:æŒ‡ä¸‹ä¸€æ¬¡æœŸæœ›æ”¶åˆ°çš„æ•°æ®çš„åºåˆ—å·ï¼Œå‘é€ç«¯æ”¶åˆ°è¿™ä¸ªç¡®è®¤åº”ç­”ä»¥åå¯ä»¥è®¤ä¸ºè¿™ä¸ªåºå·ä¹‹å‰çš„æ•°æ®éƒ½è¢«æ­£å¸¸æ¥æ”¶äº†ï¼Œä¸»è¦ç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜\næ§åˆ¶ä½:\nACK: è¯¥ä½ä¸º1çš„æ—¶å€™ï¼Œç¡®è®¤åº”ç­”å­—æ®µå˜å¾—æœ‰æ•ˆï¼Œè¯¥å­—æ®µè§„å®šé™¤äº†æœ€åˆå¼€å§‹å»ºç«‹è¿æ¥æ—¶å€™synåŒ…ä¹‹å¤–ï¼Œæ”¹ä¸ºå¿…é¡»è®¾ç½®ä¸º1\nRST:è¯¥ä½ä¸º1çš„æ—¶å€™ï¼Œæ ‡è¯†TCPè¿æ¥ä¸­å‡ºç°å¼‚å¸¸å¿…é¡»å¼ºåˆ¶æ–­å¼€è¿æ¥\nSYN:è¯¥ä¸ºä½1æ—¶å€™ï¼Œè¡¨ç¤ºå¸Œæœ›å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨åºåˆ—å·çš„å­—æ®µè¿›è¡Œåºåˆ—å·åˆå§‹å€¼çš„è®¾å®š\nFIN:è¯¥ä½ä¸º1çš„æ—¶å€™ï¼Œè¡¨ç¤ºä»Šåä¸ä¼šå†æœ‰æ•°æ®å‘é€ï¼Œå¸Œæœ›æ–­å¼€è¿æ¥ï¼Œå½“é€šè®¯ç»“æŸå¸Œæœ›ç«¯å£è¿æ¥æ—¶,é€šè®¯åŒæ–¹çš„ä¸»æœºä¹‹é—´å¯ä»¥ç›¸äº’äº¤äº’FIN ä½ä¸º1çš„TCPæ®µ\nä¸ºä»€ä¹ˆéœ€è¦tcpåè®®ï¼Œtcpå·¥ä½œåœ¨é‚£ä¸€å±‚ IPå±‚æ˜¯ä¸å¯é çš„ï¼Œä»–ä¸ä¿è¯ç½‘ç»œåŒ…çš„äº¤äº’ï¼Œä¸ä¿è¯ç½‘ç»œæŠ¥çš„æŒ‰åºäº¤äº’ï¼Œä¹Ÿä¸ä¿è¯ç½‘ç»œåŒ…ä¸­çš„æ•°æ®çš„å®Œæ•´æ€§ï¼Œå¦‚æœéœ€è¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§é‚£ä¹ˆå°±éœ€è¦TCPå±‚æ¥è´Ÿè´£ TCPæœ‰å“ªäº›ç‰¹æ€§ é¢å‘è¿æ¥çš„ï¼Œå¯é çš„ï¼ŒåŸºäºå­—èŠ‚æµçš„\nå»ºç«‹ä¸€ä¸ªtcpè¿æ¥éœ€è¦è¾¾æˆå“ªäº›å…±è¯† socketï¼šç”±ipåœ°å€å’Œç«¯å£å·ç»„æˆ\nåºåˆ—å·ï¼šä¸»è¦ç”¨æ¥è§£å†³ä¹±åºé—®é¢˜\nçª—å£å¤§å°ï¼šä¸»è¦ç”¨æ¥åšæµé‡æ§åˆ¶\nTCPå››å…ƒç»„ æœ‰ä¸€ä¸ªipçš„æœåŠ¡å™¨ç›‘å¬äº†ä¸€ä¸ªç«¯å£ï¼Œä»–çš„TCPçš„æœ€å¤§è¿æ¥æ•°æ˜¯å¤šå°‘ å¯¹äºIP4æ¥è¯´ï¼Œå®¢æœç«¯ipæœ€å¤šä¸º2çš„32æ¬¡æ–¹(4 294 967 296) å®¢æœç«¯çš„ç«¯å£æœ€å¤šä¸º2çš„16æ¬¡æ–¹(65536) ä¹Ÿå°±æ˜¯æœåŠ¡å™¨å•æœºæœ€å¤§çš„TCPé“¾æ¥æ•°ï¼Œçº¦ä¸º2çš„48æ¬¡æ–¹ æœ€å¤§tcpé“¾æ¥æ•° = å®¢æœç«¯ipæ•° * å®¢æœç«¯çš„ç«¯å£æ•°\nå¦‚æœæœåŠ¡å™¨ä¸èƒ½è¾¾åˆ°ç†æƒ³æ•°ï¼Œä¸€èˆ¬æ˜¯å› ä¸ºä»€ä¹ˆåŸå›  é¦–å…ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶ï¼ŒSocketéƒ½æ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥é¦–å…ˆè¦é€šè¿‡ ulimit é…ç½®æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç›®\nå¦ä¸€ä¸ªå°±æ˜¯å†…å­˜é™åˆ¶ï¼Œæ¯ä¸ªtcpé“¾æ¥éƒ½è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿçš„å†…å­˜æ˜¯æœ‰é™çš„\nudpå’Œtcpçš„åŒºåˆ« ç›®æ ‡å’Œæºç«¯å£å·ï¼šä¸»è¦æ˜¯å‘Šè¯‰udpåè®®åº”è¯¥å§æŠ¥æ–‡å‘ç»™é‚£ä¸ªè¿›ç¨‹\nåŒ…é•¿åº¦ï¼šä¿å­˜äº†UDPé¦–éƒ¨çš„é•¿åº¦è·Ÿæ•°æ®çš„é•¿åº¦ä¹‹å’Œ\næ ¡éªŒå’Œï¼šä¸»è¦æ˜¯ä½äº†æä¾›å¯é çš„udpé¦–éƒ¨å’Œæ•°æ®è€Œè®¾è®¡çš„\nåŒºåˆ«\nè¿æ¥\nTCPæ˜¯é¢å‘è¿æ¥çš„ä¼ è¾“å±‚,ä¼ è¾“æ•°æ®å‰å…ˆè¦å»ºç«‹é“¾æ¥\nUDPæ˜¯ä¸éœ€è¦è¿æ¥çš„ï¼Œå³å¯ä¼ è¾“æ•°æ®\næœåŠ¡å¯¹è±¡\nTCPæ˜¯ä¸€å¯¹ä¸€çš„ä¸¤ç‚¹æœåŠ¡å™¨ï¼Œå³ä¸€æ¡è¿æ¥åªæœ‰ä¸¤ä¸ªç«¯ç‚¹\nUDPæ˜¯æ”¯æŒä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡\nå¯é æ€§\nTCPæ˜¯å¯äº¤äº’æ•°æ®çš„ï¼Œå¯ä»¥æ— å·®é”™ï¼Œä¸ä¸¢å¤±ï¼Œä¸é‡å¤ï¼ŒæŒ‰éœ€åˆ°è¾¾\nUDPæ˜¯å°½è‡ªå·±æœ€å¤§çš„åŠªåŠ›äº¤äº’ï¼Œä¸ä¿è¯å¯é äº¤äº’æ•°æ®\næ‹¥å¡æ§åˆ¶ï¼Œæµé‡æ§åˆ¶\nTCPæœ‰æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶æœºåˆ¶ï¼Œä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§\nUDPåˆ™æ²¡æœ‰ï¼Œå³ä½¿ç½‘ç»œéå¸¸å µå¡ï¼Œä¹Ÿä¸ä¼šå½±å“UDPçš„å‘é€é€Ÿç‡\né¦–éƒ¨å¼€é”€\nTCPé¦–éƒ¨é•¿åº¦è¾ƒé•¿ï¼Œä¼šæœ‰ä¸€å®šçš„å¼€é”€ï¼Œé¦–éƒ¨åœ¨æ²¡æœ‰ä½¿ç”¨é€‰é¡¹çš„æ—¶å€™éƒ½èƒ½è¾¾åˆ°20å­—èŠ‚ï¼Œå¦‚æœä½¿ç”¨äº†é€‰é¡¹åˆ™ä¼šå˜é•¿ UDPé¦–éƒ¨åªæœ‰8ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”æ˜¯å›ºå®šä¸å˜çš„ï¼Œå¼€é”€è¾ƒå°\nä¼ è¾“æ–¹å¼\nTCPæ˜¯æµå¤±ä¼ è¾“ï¼Œæ²¡æœ‰è¾¹ç•Œï¼Œä½†æ˜¯ä¿è¯é¡ºåºå’Œå¯é \nUDPæ˜¯ä¸€ä¸ªåŒ…ä¸€ä¸ªåŒ…å‘é€ï¼Œæ˜¯æœ‰è¾¹ç•Œçš„ï¼Œä½†æ˜¯å¯èƒ½ä¼šä¸¢åŒ…å’Œä¹±åº\nåˆ†ç‰‡ä¸åŒ\nMSSå°±æ˜¯TCPæŠ¥æ–‡æ®µæ‰€å…è®¸ä¼ é€çš„æœ€å¤§æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ï¼Œä¸»æœºä¸€èˆ¬é»˜è®¤MSSä¸º536å­—èŠ‚(576IPæœ€å¤§å­—èŠ‚æ•°-20å­—èŠ‚TCPåè®®å¤´-20å­—èŠ‚IPåè®®å¤´=536å­—èŠ‚)\nMTU æœ€å¤§ä¼ è¾“å•å…ƒ,ä¸€èˆ¬1500\nTCPæ•°æ®å¤§å°å¦‚æœå¤§äºMSSå¤§å°ï¼Œåˆ™ä¼šåœ¨ä¼ è¾“å±‚è¿›è¡Œåˆ†ç‰‡ï¼Œç›®æ ‡ä¸»æœºæ”¶åˆ°åï¼Œä¹ŸåŒæ ·åœ¨ä¼ è¾“å±‚ç»„è£…TCPæ•°æ®åŒ…ï¼Œå¦‚æœä¸­é€”ä¸¢å¤±äº†ä¸€ä¸ªåˆ†ç‰‡ï¼Œåªéœ€ä¼ è¾“ä¸¢å¤±çš„è¿™ä¸ªåˆ†ç‰‡\nUDPçš„æ•°æ®å¤§å°å¦‚æœå¤§äºMTUå¤§å°ï¼Œåˆ™ä¼šåœ¨IPå±‚è¿›è¡Œåˆ†ç‰‡ï¼Œç›®æ ‡ä¸»æœºåœ¨æ”¶åˆ°åï¼Œåœ¨IPè¿›è¡Œç»„è£…æ•°æ®ï¼Œæ¥ç€åœ¨ä¼ ç»™ä¼ è¾“å±‚ï¼Œä½†æ˜¯å¦‚æœä¸­é€”ä¸¢äº†ä¸€ä¸ªåˆ†ç‰‡ï¼Œåœ¨å®ç°å¯é ä¼ è¾“çš„UDPæ—¶åˆ™éœ€è¦é‡ä¼ æ‰€æœ‰çš„æ•°æ®åŒ…ï¼Œè¿™æ ·ä¼ è¾“æ•ˆç‡éå¸¸å·®ï¼Œæ‰€ä»¥é€šå¸¸UDPçš„æŠ¥æ–‡ï¼Œåº”è¯¥å°äºMTU\nä¸ºä»€ä¹ˆUDPå¤´éƒ¨æ²¡æœ‰é¦–éƒ¨å­—æ®µï¼Œè€ŒTCPå¤´éƒ¨æœ‰\nåŸå› TCPæœ‰å¯å˜é•¿çš„é€‰é¡¹å­—æ®µï¼Œè€ŒUDPå¤´éƒ¨é•¿åº¦åˆ™ä¸ä¼šå˜åŒ–ï¼Œæ— éœ€å¤šä¸€ä¸ªå­—èŠ‚å»è®°å½•UDPçš„é¦–éƒ¨é•¿åº¦\nä¸ºä»€ä¹ˆUDPå¤´éƒ¨æœ‰åŒ…é•¿åº¦ï¼Œè€Œtcpæ²¡æœ‰\nTCPæ•°æ®çš„é•¿åº¦ = IPæ€»é•¿åº¦ - IPé¦–éƒ¨é•¿åº¦ - TCPé¦–éƒ¨é•¿åº¦\nå…¶ä¸­ IP æ€»â»“åº¦ å’Œ IP â¾¸éƒ¨â»“åº¦ï¼Œåœ¨ IP â¾¸éƒ¨æ ¼å¼æ˜¯å·²çŸ¥çš„ã€‚TCP â¾¸éƒ¨â»“åº¦ï¼Œåˆ™æ˜¯åœ¨ TCP â¾¸éƒ¨æ ¼å¼å·²çŸ¥çš„ï¼Œæ‰€ä»¥å°± å¯ä»¥æ±‚å¾— TCP æ•°æ®çš„â»“åº¦ã€‚ â¼¤å®¶è¿™æ—¶å°±å¥‡æ€ªäº†é—®ï¼šâ€œ UDP ä¹Ÿæ˜¯åŸºäº IP å±‚çš„å‘€ï¼Œé‚£ UDP çš„æ•°æ®â»“åº¦ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªå…¬å¼è®¡ç®—å‘€ï¼Ÿ ä¸ºä½•è¿˜è¦æœ‰ ã€ŒåŒ…â»“åº¦ã€å‘¢ï¼Ÿâ€ è¿™ä¹ˆâ¼€é—®ï¼Œç¡®å®æ„Ÿè§‰ UDP ã€ŒåŒ…â»“åº¦ã€æ˜¯å†—ä½™çš„ã€‚ å› ä¸ºä¸ºäº†â½¹ç»œè®¾å¤‡ç¡¬ä»¶è®¾è®¡å’Œå¤„ç†â½…ä¾¿ï¼Œâ¾¸éƒ¨â»“åº¦éœ€è¦æ˜¯ 44 å­—èŠ‚çš„æ•´æ•°å€ã€‚ å¦‚æœå»æ‰ UDP ã€ŒåŒ…â»“åº¦ã€å­—æ®µï¼Œé‚£ UDP â¾¸éƒ¨â»“åº¦å°±ä¸æ˜¯ 4 å­—èŠ‚çš„æ•´æ•°å€äº†ï¼Œæ‰€ä»¥è§‰å¾—è¿™å¯èƒ½æ˜¯ä¸ºäº†è¡¥å…¨ UDP â¾¸éƒ¨â»“åº¦æ˜¯ 4 å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ‰è¡¥å……äº†ã€ŒåŒ…â»“åº¦ã€å­—æ®µ\nä¸ºä»€ä¹ˆMTUæ˜¯1500\nå…¶å®ä¸€ä¸ªæ ‡å‡†çš„ä»¥å¤ªç½‘æ•°æ®å¸§å¤§å°æ˜¯ï¼š1518ï¼Œå¤´ä¿¡æ¯æœ‰14å­—èŠ‚ï¼Œå°¾éƒ¨æ ¡éªŒå’ŒFCSå äº†4å­—èŠ‚ï¼Œæ‰€ä»¥çœŸæ­£ç•™ç»™ä¸Šå±‚åè®®ä¼ è¾“æ•°æ®çš„å¤§å°å°±æ˜¯ï¼š1518 - 14 - 4 = 1500ï¼Œé‚£ä¹ˆï¼Œ1518è¿™ä¸ªå€¼åˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ\næœ€æ ¹æœ¬åŸå› \né—®é¢˜å°±å‡ºåœ¨è·¯ç”±å™¨æ‹¨å·ï¼Œå¦‚æœæ˜¯PCæ‹¨å·ï¼Œé‚£ä¹ˆPCä¼šè¿›è¡ŒPPPoEçš„å°è£…ï¼Œä¼šæŒ‰ç…§MTU:1492æ¥è¿›è¡Œä»¥å¤ªç½‘å¸§çš„å°è£…ï¼Œå³ä½¿é€šè¿‡è·¯ç”±å™¨ï¼Œè·¯ç”±å™¨è¿™æ—¶å€™ä¹Ÿåªæ˜¯è½¬å‘è€Œå·²ï¼Œä¸ä¼šè¿›è¡Œæ‹†åŒ…ã€‚\nè€Œå½“ç”¨è·¯ç”±å™¨æ‹¨å·æ—¶ï¼ŒPCå¹¶ä¸çŸ¥é“è·¯ç”±å™¨çš„é€šä¿¡æ–¹å¼ï¼Œä¼šä»¥ç½‘å¡çš„è®¾ç½®ï¼Œé»˜è®¤1500çš„MTUæ¥è¿›è¡Œä»¥å¤ªç½‘å¸§çš„å°è£…ï¼Œåˆ°è¾¾è·¯ç”±å™¨æ—¶ï¼Œç”±äºè·¯ç”±å™¨éœ€è¦è¿›è¡ŒPPPoEåè®®çš„å°è£…ï¼ŒåŠ ä¸Š8å­—èŠ‚çš„å¤´ä¿¡æ¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±å¿…é¡»è¿›è¡Œæ‹†åŒ…ï¼Œè·¯ç”±å™¨æŠŠè¿™ä¸€å¸§çš„å†…å®¹æ‹†æˆä¸¤å¸§å‘é€ï¼Œä¸€å¸§æ˜¯1492ï¼Œä¸€å¸§æ˜¯8ï¼Œç„¶ååˆ†åˆ«åŠ ä¸ŠPPPoEçš„å¤´è¿›è¡Œå‘é€ã€‚\nå¹³æ—¶ç©æ¸¸æˆä¸å¡ï¼Œæ˜¯å› ä¸ºæ•°æ®é‡è·¯ç”±å™¨è¿˜å¤„ç†å¾—è¿‡æ¥ï¼Œè€Œå½“è¿›è¡Œç¾¤æ€ªAOEçš„æ—¶å€™ï¼Œç”±äºçŸ­æ—¶é—´æ•°æ®é‡è¿‡å¤§ï¼Œè·¯ç”±å™¨å¤„ç†ä¸è¿‡æ¥ï¼Œå°±ä¼šå‘ç”Ÿä¸¢åŒ…å¡é¡¿çš„æƒ…å†µï¼Œä¹Ÿå°±æ‰çº¿äº†ã€‚\nå¸–å­é‡Œé¢æåˆ°çš„1480ï¼ŒçŒœæµ‹å¯èƒ½æ˜¯å°½é‡è®¾å°ä¸€ç‚¹ï¼Œé¿å…äºŒæ¬¡æ‹¨å·å¸¦æ¥çš„åˆä¸€æ¬¡PPPoEçš„å°è£…ï¼Œå› ä¸ºæ—¶é—´ä¹…è¿œï¼Œæ²¡åŠæ³•å›åˆ°å½“æ—¶çš„åœºæ™¯å†å»æŠ“åŒ…äº†ã€‚\nTCP è¿æ¥å»ºç«‹(3æ¬¡æ¡æ‰‹) ä¸€å¼€å§‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¤„äºcloseçŠ¶æ€\næœåŠ¡å¼€å§‹ç›‘å¬ç«¯å£ï¼Œè¿™ä¸ªæ—¶å€™æœåŠ¡å™¨å¤„äºlistençŠ¶æ€\nå®¢æˆ·ç«¯ä¼šéšæœºåˆå§‹åŒ–åºåˆ—å· client_isnï¼Œç„¶åæŠŠè¿™ä¸ªåˆå§‹å€¼ä»˜ç»™tcpé¦–éƒ¨çš„åºåˆ—å·å­—æ®µï¼Œå¹¶æŠŠæ ‡è¯†ä½synè®¾ç½®æˆ1ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªsynåŒ…ï¼Œæ­¤åŒ…ä¸åŒ…å«åº”ç”¨å±‚æ•°æ®ï¼Œå‘é€å‡ºå»ä»¥åï¼Œå®¢æœç«¯å¤„äºsys_sentçŠ¶æ€\nä¸‰æ¬¡æ¡æ‰‹ç¬¬ä¸€ä¸ªæŠ¥æ–‡ SYN æŠ¥æ–‡\næœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯æŠ¥æ–‡ï¼Œé¦–å…ˆæœåŠ¡å™¨ä¼šéšæœºåˆå§‹åŒ–è‡ªå·±çš„server_isn ,å°†server _isnå·å­˜å…¥åºåˆ—å·ä¸­ï¼Œå¹¶æŠŠå®¢æœç«¯çš„client_isn +1 å­˜å…¥ç¡®è®¤åº”ç­”å·ä¸­ï¼ŒåŒæ—¶å§SYNå’ŒACKæ ‡å¿—ä½ç½®ä¸º1ï¼Œæ­¤åŒ…ä¸ä¼šåŒ…å«åº”ç”¨å±‚æ•°æ®ï¼Œå‘é€å‡ºå»ä»¥åæœåŠ¡å™¨è¿›å…¥syc_rcvdçŠ¶æ€\nä¸‰æ¬¡æ¡æ‰‹ç¬¬äºŒä¸ªæŠ¥æ–‡ SYNÂ + ACKæŠ¥æ–‡\nå®¢æœç«¯æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„syn + ack æŠ¥æ–‡ä»¥åï¼Œæœ€åè¿˜ä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªACKç¡®è®¤æŠ¥æ–‡ï¼Œå¹¶æŠŠserver_isn åºåˆ—å· + 1 å­˜å…¥ç¡®è®¤åº”ç­”å·ï¼Œç„¶åæŠŠACKæ ‡å¿—ä½è®¾ç½®æˆ1ï¼Œæ­¤åŒ…è¿™ä¸ªæ—¶å€™å¯ä»¥å¸¦åº”ç”¨å±‚æ•°æ®å‘è¿‡å»ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯è¿›å…¥è¿›å…¥establishedçŠ¶æ€ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ACKç¡®è®¤åº”ç­”åŒ…ä»¥åä¹Ÿè¿›å…¥establishedçŠ¶æ€\nä»è¿™ä¸€æ­¥å¯ä»¥çœ‹å‡ºå‰ä¸¤æ­¥æ˜¯ä¸å¸¦æ•°æ®çš„ï¼Œç¬¬ä¸‰æ­¥å¯ä»¥å¸¦æ•°æ®å‘é€\nä¸ºä»€ä¹ˆæ¡æ‰‹æ˜¯3æ¬¡ï¼Œä¸æ˜¯2æ¬¡,4æ¬¡ ä¸»è¦æ˜¯3ä¸ªæ–¹é¢\nå¯ä»¥é˜²æ­¢é‡å¤å†å²é“¾æ¥æ•°\nåŒæ­¥åŒæ–¹åˆå§‹åºåˆ—å· å››æ¬¡æ¡æ‰‹å…¶å®ä¹Ÿèƒ½å¤Ÿå¯é çš„åŒæ­¥åŒæ–¹çš„åˆå§‹åŒ–åºå·ï¼Œä½†æ˜¯ç”±äºç¬¬äºŒæ­¥å’Œç¬¬ä¸€æ­¥å¯ä»¥ä¼˜åŒ–æˆä¸€æ­¥ï¼Œæ‰€ä»¥å°±æˆäº†3æ¬¡æ¡æ‰‹ï¼Œ\nè€Œä¸¤æ¬¡æ¡æ‰‹åªä¿è¯äº†ä¸€æ–¹çš„åˆå§‹åºåˆ—å·èƒ½è¢«å¯¹æ–¹æˆåŠŸæ¥æ”¶ï¼Œæ²¡åŠæ³•ä¿è¯åŒæ–¹åºåˆ—å·éƒ½èƒ½è¢«ç¡®è®¤æ¥æ”¶\né¿å…èµ„æºæµªè´¹\nå¦‚æœåªæœ‰ä¸¤æ¬¡æ¡æ‰‹ï¼Œå½“å®¢æœç«¯çš„synè¯·æ±‚è¿æ¥åœ¨ç½‘ç»œä¸­å µå¡ï¼Œå®¢æœç«¯æ²¡æœ‰æ¥æ”¶åˆ°ACKæŠ¥æ–‡ï¼Œå°±ä¼šé‡æ–°å‘é€synï¼Œç”±äºæ²¡æœ‰ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡å™¨ä¸æ¸…æ¥šå®¢æˆ·ç«¯æ˜¯å¦æ”¶åˆ°äº†è‡ªå·±å‘é€é“¾æ¥çš„ackç¡®è®¤ä¿¡å·ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±åˆ›å»ºé“¾æ¥ï¼Œ\nå¦‚æœå¤šæ¬¡å µå¡ï¼Œå¤šæ¬¡å‘é€synï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¼šå¤šæ¬¡åˆ›å»ºï¼Œé€ æˆå†—ä½™çš„é“¾æ¥ã€‚\næ€»ç»“ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ä¸¤æ¬¡æ¡æ‰‹æˆ–è€…å››æ¬¡æ¡æ‰‹\nä¸¤æ¬¡æ¡æ‰‹ï¼šæ— æ³•é˜²æ­¢å†å²é“¾æ¥çš„å»ºç«‹ï¼Œä¼šé€ æˆåŒæ–¹èµ„æºçš„æµªè´¹ï¼Œä¹Ÿæ— æ³•å¯é çš„åŒæ­¥åŒæ–¹åºåˆ—å·\nå››æ¬¡æ¡æ‰‹ï¼šä¸‰æ¬¡æ¡æ‰‹å°±å·²ç»ç†è®ºä¸Šæœ€å°‘å¯é é“¾æ¥å»ºç«‹ï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨æ›´å¤šçš„é€šä¿¡æ¬¡æ•°\nä¸ºä»€ä¹ˆå®¢æœç«¯å’ŒæœåŠ¡å™¨çš„isnå·ä¸ç›¸åŒ å¦‚æœä¸€ä¸ªå·²ç»å¤±æ•ˆçš„å†å²æŠ¥æ–‡æ®‹ç•™åœ¨ç½‘ç»œä¸­ï¼Œé‚£ä¹ˆå¦‚æœisnå·ç ç›¸åŒé‚£ä¹ˆæ— æ³•åˆ†è¾¨åˆ°åº•æ˜¯ä¸æ˜¯å†å²æŠ¥æ–‡ï¼Œå¦‚æœå†å²æŠ¥æ–‡è¢«æ¥å—äº†é‚£ä¹ˆå°±æœ‰å¯èƒ½äº§ç”Ÿæ•°æ®é”™ä¹±ï¼Œæ‰€ä»¥æ¯æ¬¡å»ºç«‹è¿æ¥å‰éƒ½ä¼šåˆå§‹åŒ–ä¸€ä¸ªåºåˆ—å·ï¼Œå¥½è®©åˆ†è¾¨å‡ºæ¥æ˜¯ä¸æ˜¯å†å²æŠ¥æ–‡ï¼Œå¥½ä¸¢å¼ƒæ‰ è¿˜æœ‰ä¸€ä¸ªæ–¹é¢æ˜¯ä¸ºäº†å®‰å…¨ï¼Œé˜²æ­¢é»‘å®¢ä¼ªé€ ç›¸åŒçš„tcpæŠ¥æ–‡è¢«å¯¹æ–¹æ¥æ”¶ synæ”»å‡» æˆ‘ä»¬çŸ¥é“tcpé“¾æ¥éœ€è¦3æ¬¡æ¡æ‰‹ï¼Œå‡è®¾æ”»å‡»è€…çŸ­æ—¶é—´å†…ï¼Œä¼ªé€ ä¸åŒçš„ipåœ°å€synæŠ¥æ–‡ï¼ŒæœåŠ¡å™¨æ¯æ¥æ”¶ä¸€ä¸ªå°±è¿›å…¥syn_rcvd çŠ¶æ€ï¼Œä½†æœåŠ¡å™¨å‘é€å‡ºå»çš„ack + synæŠ¥æ–‡ï¼Œæ— æ³•å¾—çŸ¥ä½ç½®ipä¸»æœºçš„ackåº”ç­”ï¼Œä¹…è€Œä¹…ä¹‹å°±ä¼šå æ»¡æœåŠ¡å™¨synæ¥æ”¶é˜Ÿåˆ—ï¼ˆæœªè¿æ¥é˜Ÿåˆ—ï¼‰ä½¿å¾—æœåŠ¡å™¨ä¸èƒ½ä¸ºæ­£å¸¸ç”¨æˆ·æœåŠ¡\nè§£å†³åŠæ³•ä¸€\næ§åˆ¶æ¥æ”¶é˜Ÿåˆ—å¤§å°\nnet.core.netdev_max_backlog SYN_RCVD çŠ¶æ€è¿æ¥çš„æœ€å¤§ä¸ªæ•°\nnet.ipv4.tcp_max_syn_backlog è¶…å‡ºå¤„ç†èƒ½åŠ›æ—¶å€™å¯¹äºæ–°çš„syn ç›´æ¥å‘é€RST ä¸¢å¼ƒé“¾æ¥\nnet.ipv4.tcp_max_syn_backlog è§£å†³æ–¹æ³•äºŒ\né¦–å…ˆæ˜¯æ­£å¸¸çš„3æ¬¡æ¡æ‰‹æµç¨‹\nTCP è¿æ¥æ–­å¼€ å®¢æœç«¯ï¼Œæ‰“ç®—å…³é—­è¿æ¥ï¼Œæ­¤æ—¶ä¼šå‘é€ä¸€ä¸ªtcpé¦–éƒ¨FINæ ‡å¿—ä¸º1çš„æŠ¥æ–‡ï¼Œä¹‹åå®¢æˆ·ç«¯è¿›å…¥fin_wait1çŠ¶æ€ æœåŠ¡å™¨æ”¶åˆ°finæŠ¥æ–‡ä¹‹åç„¶åå‘é€ackç¡®è®¤ç ç»™å®¢æœç«¯ï¼Œå¼€å§‹è¿›å…¥close_waitçŠ¶æ€ï¼Œ å®¢æœç«¯æ”¶åˆ°ackç¡®è®¤ç ä»¥åè¿›å…¥fin_wait2çŠ¶æ€ æœåŠ¡å™¨å¤„ç†å®Œæ•°æ®å‘é€finæŠ¥æ–‡ç»™å®¢æœä»¥åè¿›å…¥last_acké˜¶æ®µ å®¢æœç«¯æ”¶åˆ°finæŠ¥æ–‡ä»¥åå‘é€ackç¡®è®¤ç ç»™æœåŠ¡å™¨å¼€å§‹è¿›å…¥time_waitçŠ¶æ€ æœåŠ¡å™¨æ¥åˆ°ackåº”ç­”æŠ¥æ–‡å¼€å§‹è¿›å…¥closeçŠ¶æ€ å®¢æœç«¯ç»è¿‡2mslæ—¶é—´è‡ªåŠ¨è¿›å…¥closeçŠ¶æ€ ä½ å¯ä»¥çœ‹åˆ°æ¯ä¸ªæ–¹å‘éƒ½æœ‰finæŠ¥æ–‡å’Œackåº”ç­”ç ï¼Œæ‰€ä»¥ç®€ç§°å››æ¬¡æŒ¥æ‰‹\nåªæœ‰ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹æ‰ä¼šè¿›å…¥time_wait çŠ¶æ€\nä¸ºä»€ä¹ˆæŒ¥æ‰‹éœ€è¦å››æ¬¡ å®¢æœç«¯å‘é€finé“¾æ¥çš„æ—¶å€™ï¼Œä»…ä»…è¡¨ç¤ºå®¢æˆ·ç«¯ä¸åœ¨å‘é€æ•°æ®ï¼Œä½†æ˜¯è¿˜èƒ½æ¥æ”¶æ•°æ®\næœåŠ¡å™¨æ”¶åˆ°finæŠ¥æ–‡ä»¥åï¼Œå…ˆå›ä¸€ä¸ªackç ï¼Œè€ŒæœåŠ¡å™¨è¿˜æœ‰æ•°æ®éœ€è¦å¤„ç†å’Œå‘é€ï¼Œç­‰æœåŠ¡å™¨ä¸åœ¨å‘é€æ•°æ®\nçš„æ—¶å€™æ‰å‘é€finæŠ¥æ–‡ç»™å®¢æœç«¯\nä»ä¸Šå¯çŸ¥ï¼Œå› ä¸ºè¦ç­‰å¾…æœåŠ¡å™¨å¤„ç†å®Œæ•°æ®ï¼Œæ‰€ä»¥æœåŠ¡å™¨çš„ackå’Œfinç ä¼šåˆ†å¼€å‘\nä¸ºä»€ä¹ˆtime_waitæ˜¯2ML MSLæ˜¯æŠ¥æ–‡ç”Ÿå­˜æœ€å¤§æ—¶é—´ï¼Œä»–åœ¨ä»»ä½•æŠ¥æ–‡åœ¨ç½‘ç»œä¸­å­˜åœ¨çš„æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼ŒæŠ¥æ–‡ä¼šè¢«ä¸¢å¼ƒï¼Œå› ä¸ºtcpæ˜¯åŸºäº\nIPåè®®çš„ï¼Œåœ¨IPåè®®ä¸­æœ‰ä¸€ä¸ªTTLå­—æ®µï¼Œæ˜¯IPå±‚ç»è¿‡çš„æœ€å¤§è·¯ç”±å™¨æ•°ï¼Œæ¯ç»è¿‡ä¸€ä¸ªå¤„ç†ï¼Œå°±ä¼šå‡1ï¼Œä¸€ç›´åˆ°0ï¼Œå°±æŠŠè¿™\nä¸ªæ•°æ®åŒ…è¿›è¡Œä¸¢å¼ƒï¼ŒåŒæ—¶å‘é€icmpæŠ¥æ–‡é€šçŸ¥ä¸»æœº\nMSLå’ŒTTLåŒºåˆ«\nMSLå•ä½æ˜¯æ—¶é—´ TTLæ˜¯è·¯ç”±è·³æ•°ï¼Œæ‰€ä»¥MSLåº”è¯¥å¤§äºTTLæ¶ˆè€—ä¸º0çš„æ—¶é—´ï¼Œä»¥ä¿è¯æŠ¥æ–‡æ˜¯è‡ªç„¶æ¶ˆäº¡\nTIME_WAITç­‰äº2å€ï¼Œæ˜¯å› ä¸ºç½‘ç»œä¸­å¯èƒ½å­˜åœ¨å‘é€æ–¹å‘è¿‡æ¥çš„æ•°æ®åŒ…ï¼Œå½“è¿™äº›å‘é€æ–¹çš„æ•°æ®åŒ…è¢«æ¥æ”¶æ–¹å¤„ç†åï¼Œåˆä¼šå‘å¯¹æ–¹å‘é€å“åº”ï¼Œæ‰€ä»¥ä¸€æ¥ä¸€å›éœ€è¦ç­‰å¾…2å€çš„æ—¶é—´\næ¯”å¦‚è¢«åŠ¨å…³é—­æ–¹æ²¡æœ‰æ”¶åˆ°æ–­å¼€è¿æ¥çš„æœ€åçš„ACKæŠ¥æ–‡ï¼Œå°±ä¼šè§¦å‘é‡å‘finæŠ¥æ–‡ï¼Œå¦ä¸€æ–¹æ”¶åˆ°finæŠ¥æ–‡åï¼Œä¼šé‡å‘ackåº”ç­”ç \nä¸€æ¥ä¸€å›æ­£å¥½2ML\n2MLæ˜¯å®¢æœç«¯æ¥å—åˆ°FINåŒ…ä»¥åå‘é€ACKç å¼€å§‹è®¡æ—¶çš„ï¼Œå¦‚æœåœ¨2MLæ—¶é—´å†…ï¼ŒæœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°ACKç¡®è®¤ç ï¼Œé‡å‘äº†finæŠ¥æ–‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®¢æœç«¯ä¼šé‡å‘ACKç å¹¶é‡æ–°è¿›å…¥2MLè®¡æ—¶\n2MLä¸€èˆ¬å¤šé•¿ linux ä¸­ä¸€èˆ¬è®¾ç½®ä¸º60s ä¹Ÿå°±æ˜¯ä¸€ä¸ªmslæ˜¯30ç§’\n#define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT state, about 60 seconds */ time_wait ç›¸å…³ time_wait è¿‡å¤šåŸå›  å¤§é‡é«˜å¹¶å‘çš„çŸ­è¿æ¥ ç¨‹åºé”™è¯¯ï¼Œæ²¡æœ‰è°ƒç”¨closeå…³é—­è¿æ¥ ackç ä¸¢å¤±ï¼Œå¯¼è‡´æœåŠ¡å™¨é‡æ–°å‘é€finæŠ¥æ–‡ï¼Œè®©time_waité‡æ–°è¿›å…¥è®¡æ—¶ï¼Œä¸ä¼šè¿›å…¥close ä¸ºä»€ä¹ˆéœ€è¦time_waitçŠ¶æ€ é˜²æ­¢æ—§é“¾æ¥çš„æ•°æ®åŒ…\nå¦‚ä¸Šå›¾çš„sql =301çš„åŒ…è¢«ç½‘ç»œå»¶è¿Ÿäº†ï¼Œè¿™ä¸ªæ—¶å€™time_waitè®¾ç½®çš„æ—¶é—´å¾ˆçŸ­ï¼Œæˆ–è€…æ²¡æœ‰ï¼Œä¸Šæ¬¡çš„é“¾æ¥çš„è¢«å…³é—­\nè¿™ä¸ªæ—¶å€™å¦‚æœé‡æ–°å»ºç«‹ç›¸åŒç«¯å£å·çš„è¿æ¥è¢«é‡ç”¨ï¼Œè€Œç½‘ç»œä¸­è¿˜æœ‰seq =301çš„æ¶ˆæ¯åŒ…è¿™ä¸ªæ—¶å€™æŠµè¾¾ï¼Œé‚£ä¹ˆè¿™ä¸ª\næ—¶å€™å®¢æœç«¯æ”¶åˆ°äº†æ—§çš„æ•°æ®åŒ…ï¼Œè¿™ä¸ªæ—¶å€™æ•°æ®å°±ä¼šé”™ä¹±ï¼Œé€ æˆé—®é¢˜\nå¦‚æœè¿™ä¸ªæ—¶å€™æœ‰2MLçš„time_waitæ—¶é—´ï¼Œé‚£ä¹ˆè¶³å¤Ÿä¿è¯åœ¨å»ºç«‹æ–°çš„ç›¸åŒç«¯å£è¿æ¥æ—¶å€™ï¼Œç½‘ç»œä¸­æ—§çš„æ•°æ®åŒ…æ¶ˆäº¡\nä¿è¯è¿æ¥æ­£ç¡®å…³é—­\nå¦‚æœæœ€åçš„ackä¸¢å¤±äº†ï¼ŒæœåŠ¡å™¨å°±ä¼šä¸€ç›´å¤„äºlast_ackçŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™å®¢æœç«¯å‘èµ·æ–°çš„è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æœåŠ¡å™¨å› ä¸ºå¤„äºlast_ackçŠ¶æ€ï¼Œæ‰€ä»¥ä¼šå‘é€rstæŠ¥æ–‡ç»™å®¢æœç«¯ï¼Œè®©å®¢æœç«¯ç›´æ¥ç»ˆæ­¢é“¾æ¥\ntime_waitè¿‡å¤šä¼šæ€ä¹ˆæ · å¦‚æœæœåŠ¡å™¨æœ‰å¤„äºtime_waitçŠ¶æ€çš„tcp é‚£ä¹ˆè¯´æ˜æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘èµ·çš„ç«¯å¼€è¯·æ±‚\nå†…å­˜èµ„æºçš„å ç”¨ ç«¯å£èµ„æºçš„å ç”¨ï¼Œç«¯å£èµ„æºä¹Ÿæ˜¯æœ‰é™çš„ æ‰€ä»¥å¦‚æœå‘èµ·è¿æ¥çš„ä¸€æ–¹time_waitçŠ¶æ€è¿‡å¤šï¼Œå æ»¡äº†æ‰€æœ‰èµ„æºç«¯å£ï¼Œåˆ™ä¼šå¯¼è‡´æ— æ³•åˆ›å»ºæ–°çš„è¿æ¥\nå®¢æˆ·ç«¯ time_waitå¤šçš„è¯ï¼Œå› ä¸ºç«¯å£èµ„æºçš„é™åˆ¶ï¼Œå°±ä¼šå¯¼è‡´ç«¯å£èµ„æºè¢«å ç”¨ï¼Œè¢«å æ»¡å°±ä¼šå¯¼è‡´æ— æ³•åˆ›å»ºæ–°çš„é“¾æ¥\næœåŠ¡å™¨time_waitè¿‡å¤šçš„è¯ï¼Œå› ä¸ºç³»ç»Ÿèµ„æºçš„é™åˆ¶ï¼Œç”±äºä¸€ä¸ªå››å…ƒç»„è¡¨ç¤ºä¸€ä¸ªtcpè¿æ¥ï¼Œç†è®ºä¸ŠæœåŠ¡å™¨å¯ä»¥åˆ›å»ºå¾ˆå¤šè¿æ¥ï¼ŒæœåŠ¡å™¨ç¡®å®ä¹Ÿå¯ä»¥ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œä½†æ˜¯è¿™äº›è¿æ¥ä¼šæ‰”ç»™å¤„ç†çº¿ç¨‹ï¼Œç†è®ºä¸Šç›‘å¬çš„ç«¯å£å¯ä»¥è¢«ç»§ç»­ç›‘å¬ï¼Œä½†æ˜¯çº¿ç¨‹æ± å¤„ç†ä¸äº†é‚£ä¹ˆå¤šçš„ä¸€ç›´ä¸æ–­çš„è¿æ¥ï¼Œæ‰€ä»¥å½“å‡ºç°å¤§é‡time_waitçš„æ—¶å€™ï¼Œç³»ç»Ÿèµ„æºå°±ä¼šè¢«å æ»¡ï¼Œå¯¼è‡´å¤„ç†ä¸äº†æ–°çš„è¿æ¥\næ€ä¹ˆä¼˜åŒ–time_wait æ‰“å¼€ net.ipv4.tcp_tw_reuse å’Œ net.ipv4.tcp_timestamps é€‰é¡¹\ntcp_tw_reuse åŠŸèƒ½åªèƒ½â½¤å®¢æˆ·ç«¯ï¼ˆè¿æ¥å‘èµ·â½…ï¼‰ï¼Œå› ä¸ºå¼€å¯äº†è¯¥åŠŸèƒ½ï¼Œåœ¨è°ƒâ½¤ connect() å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šéšæœºæ‰¾â¼€ä¸ª time_wait çŠ¶æ€è¶…è¿‡ 1 ç§’çš„è¿æ¥ç»™æ–°çš„è¿æ¥å¤â½¤\nnet.ipv4.tcp_max_tw_buckets\nè¿™ä¸ªå€¼é»˜è®¤ä¸º 18000ï¼Œå½“ç³»ç»Ÿä¸­å¤„äº TIME_WAIT çš„è¿æ¥â¼€æ—¦è¶…è¿‡è¿™ä¸ªå€¼æ—¶ï¼Œç³»ç»Ÿå°±ä¼šå°†åâ¾¯çš„ TIME_WAIT è¿æ¥ çŠ¶æ€é‡ç½®\nç¨‹åºä¸­ä½¿â½¤ SO_LINGER ï¼Œåº”â½¤å¼ºåˆ¶ä½¿â½¤ RST å…³é—­ã€‚\nclose_wait ç›¸å…³ close_wait å¤šçš„åŸå›  ä¸€èˆ¬éƒ½æ˜¯ç¨‹åºé€»è¾‘é€ æˆï¼Œåœ¨clientå‘é€finè¿‡æ¥çš„æ—¶å€™ï¼Œè¿™è¾¹è¿›å…¥äº†close_waitçŠ¶æ€ï¼Œä½†æ˜¯å› ä¸ºç¨‹åºé€»è¾‘é—®é¢˜ï¼Œè¿Ÿè¿Ÿæ²¡æœ‰è°ƒç”¨close()ï¼Œæˆ–è€…shutdownå‡½æ•°è¿›è¡Œå…³é—­ï¼Œå¯¼è‡´close_waitè¶…å¤š\nå¦‚æœå·²ç»å»ºâ½´äº†è¿æ¥ï¼Œä½†æ˜¯å®¢æˆ·ç«¯çªç„¶å‡ºç°æ•…éšœäº†æ€ä¹ˆåŠ net.ipv4.tcp_keepalive_time=7200 #è¡¨ç¤ºä¿æ´»æ—¶é—´æ˜¯ 7200 ç§’ï¼ˆ2â¼©æ—¶ï¼‰ï¼Œä¹Ÿå°± 2 â¼©æ—¶å†…å¦‚æœæ²¡æœ‰ä»»ä½•è¿æ¥ç›¸å…³çš„æ´» åŠ¨ï¼Œåˆ™ä¼šå¯åŠ¨ä¿æ´»æœºåˆ¶ net.ipv4.tcp_keepalive_intvl=75 #è¡¨ç¤ºæ¯æ¬¡æ£€æµ‹é—´éš” 75 ç§’ net.ipv4.tcp_keepalive_probes=9 #è¡¨ç¤ºæ£€æµ‹ 9 æ¬¡â½†å“åº”ï¼Œè®¤ä¸ºå¯¹â½…æ˜¯ä¸å¯è¾¾çš„ï¼Œä»â½½ä¸­æ–­æœ¬æ¬¡çš„è¿æ¥ ä¸»è¦æ˜¯tcpçš„ä¿æ´»æœºåˆ¶ï¼Œå¦‚æœåœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œæ²¡æœ‰ä»»ä½•çš„è¿æ¥ç›¸å…³çš„æ´»åŠ¨ï¼Œtcpå°±ä¼šå¯åŠ¨ä¿æ´»æœºåˆ¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å‘é€ä¸€ä¸ªæ¢æµ‹åŒ…ï¼Œè¿™ä¸ªæ¢æµ‹åŒ…æ•°æ®é‡å¾ˆå°ï¼Œå¦‚æœè¿ç»­å‡ ä¸ªæ¢æµ‹åŒ…å‘è¿‡å»éƒ½æ²¡æœ‰ååº”ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºtcpè¿æ¥å·²ç»æ­»äº¡äº†\nå¼€å¯äº†tcpä¿æ´»æœºåˆ¶ä»¥åï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸‹å‡ ç§æƒ…å†µ\nå¯¹ç«¯ç¨‹åºæ­£å¸¸å·¥ä½œï¼Œå½“tcpä¿æ´»çš„æ¢æµ‹åŒ…åˆ°è¾¾å¯¹æ–¹ä»¥åï¼Œå¯¹æ–¹æ­£å¸¸å“åº”ï¼Œè¿™ä¸ªæ—¶å€™ä¿æ´»æœºåˆ¶å°±ä¼šè¢«é‡ç½® å¯¹ç«¯ç¨‹åºå¥”æºƒå¹¶é‡å¯ï¼Œå½“tcpä¿æ´»çš„æ¢æµ‹åŒ…åˆ°è¾¾ä»¥åï¼Œç”±äºå¯¹æ–¹æ²¡æœ‰ç›¸å…³çš„tcpè¿æ¥ä¿¡æ¯ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå‘é€rstæŠ¥æ–‡ç»™å¯¹æ–¹ï¼Œè¿™æ ·å¾ˆå¿«å°±å¯ä»¥å‘ç°tcpè¿æ¥å·²ç»é‡ç½®äº† å¦‚æœå¯¹æ–¹ä¸€ç›´å¥”æºƒï¼Œå½“tcpæŠ¥æ–‡ä¸€ç›´å‘é€ï¼Œå‘é€å‡ æ¬¡åæ²¡æœ‰åé¦ˆï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥è®¤ä¸ºtcpè¿æ¥å·²ç»æ­»äº¡ æœåŠ¡å™¨ä¸»åŠ¨å…³é—­ æœåŠ¡å™¨è°ƒç”¨close(),ä¸ç®¡ä»€ä¹ˆæ•°æ®ä¸€ç¼•å‘é€rstæŠ¥æ–‡è¿›è¡Œå¼ºåˆ¶å…³é—­ æœåŠ¡å™¨è°ƒç”¨shutdown() ï¼Œå¦‚æœæ˜¯æ­£å¸¸æ•°æ®è¿˜æ˜¯èµ°æ­£å¸¸æ•°æ®æ¥æ”¶æµç¨‹ï¼Œä¸€ç›´åˆ°æ•°æ®å‘é€å®Œæ¯•ï¼Œç„¶åå‘é€finæŠ¥æ–‡æ­£å¸¸å…³é—­\ntcpé‡ä¼  è¶…æ—¶é‡ä¼  æŒ‡çš„æ˜¯æˆ‘ä»¬åœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¼šè®¾å®šä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“è¶…è¿‡å®šæ—¶å™¨è®¾å®šçš„æ—¶é—´ï¼Œæˆ‘ä»¬åœ¨æ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„ackç¡®è®¤ç ä¹‹åå°±ä¼šè§¦å‘é‡ä¼ æœºåˆ¶\nè§¦å‘è¶…æ—¶é‡ä¼ æ¡ä»¶ æ•°æ®åŒ…ä¸¢å¤±ï¼Œå› ä¸ºæ•°æ®åŒ…ä¸¢å¤±ï¼Œæ‰€ä»¥Bæ— æ³•å‘é€ackç¡®è®¤ç ä¸‹å»ï¼ŒAæ— æ³•æ”¶åˆ°ACKç¡®è®¤ç ï¼Œæ— æ³•çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ”¶åˆ°æ•°æ®å°±ä¼šåœ¨ç‰¹å®šæ—¶é—´é—´éš”å†…ï¼Œè§¦å‘é‡ä¼ \nç¡®è®¤åº”ç­”ä¸¢å¤±\nè¶…æ—¶é‡ä¼ æ—¶é—´è®¾ç½®å¤šå°‘æœ€å¥½ RTT åŒ…çš„å¾€è¿”æ—¶é—´\næ—¶é—´è®¾ç½®çš„è¿‡é•¿è¿‡çŸ­å‘ç”Ÿçš„æƒ…å†µ\nå½“RTOè¾ƒå¤§æ—¶å€™ï¼Œé‡å‘å°±æ»¡ï¼Œä¸¢äº†è€åŠå¤©æ‰é‡å‘ï¼Œæ²¡æœ‰æ•ˆç‡ï¼Œæ€§èƒ½å·®\nå½“RTOè¾ƒå°æ—¶å€™ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ³¢åŠ¨å¤§ï¼Œç„¶åè®¾ç½®RTOåˆçŸ­ï¼Œè¿™ä¸ªæ—¶å€™è§¦å‘äº†é‡ä¼ ï¼Œä½†æ˜¯æ—§åŒ…å´å¾ˆå¿«æ¢å¤äº†ä¼ è¾“\næ‰€æœ‰ç»¼åˆä¸Šè¿°ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ RTOåº”è¯¥ç•¥å¤§äºRTT\nå¿«é€Ÿé‡ä¼  è¿™ä¸ªä¸æ˜¯ä»¥æ—¶é—´ä¸ºé©±åŠ¨ï¼Œè€Œæ˜¯ä»¥æ•°æ®ä¸ºé©±åŠ¨\nå¦‚ä¸Šå‘äº†1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5 å…±5ä»½æ•°æ®\n1å·æ•°æ®å‘è¿‡å»äº†ï¼Œè¿™ä¸ªæ—¶å€™ACKå˜æˆäº†2\n2å·æ•°æ®è¿™ä¸ªæ—¶å€™ä¸¢å¤±äº†ï¼Œ\n3å·æ•°æ®è¿™ä¸ªæ—¶å€™è¿›è¡Œäº†å‘é€ï¼Œä½†æ˜¯æ¥æ”¶ç«¯å›å¤ACKçš„æ—¶å€™ä¸ä¼šæ˜¯3è€Œä¼šè¿˜æ˜¯åŸæ¥ä¸¢åŒ…çš„é‚£ä¸ªACK2\n4å·æ•°æ®è¿™ä¸ªæ—¶å€™è¿›è¡Œäº†å‘é€ï¼Œè¿˜æ˜¯å‘é€ACK2\n5å·æ•°æ®è¿™ä¸ªæ—¶å€™è¿›è¡Œäº†å‘é€ï¼Œè¿˜æ˜¯å‘é€ACK2\nè¿™ä¸ªæ—¶å€™å‘é€ç«¯å‘ç°æœ‰3æ¬¡ç›¸åŒçš„ackç å°±ä¼šè§¦å‘é‡ä¼ ï¼Œè¿™ä¸ªæ˜¯seq2ä¼šåœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹å‰é‡ä¼ è¿‡å»äº†ï¼Œè¿™ä¸ªæ—¶å€™æ¥æ”¶ç«¯\nå‘ç°äº†seq2ï¼Œ3ï¼Œ4ï¼Œ5éƒ½æ”¶åˆ°äº†ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠACKè®¾ç½®æˆ6\nSACK è§£å†³å¿«é€Ÿé‡ä¼ åº”è¯¥é‡ä¼ æ‰€æœ‰è¿˜æ˜¯é‡ä¼ ä¸¢å¤±è€…é—®é¢˜\nSACKæ–¹æ³•[å¦‚æœèƒ½æ”¯æŒSACKï¼Œé‚£ä¹ˆå¿…é¡»åŒæ–¹éƒ½æ‰“å¼€]\nLeft Edge:ä»£è¡¨å·²æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªä¸è¿ç»­çš„ç¬¬ä¸€ä¸ªåºå·\nRight Edge:è¡¨ç¤ºå·²æ”¶åˆ°çš„ä¸è¿ç»­å—çš„æœ€åä¸€ä¸ªåºå·+1 å³å·¦é—­å³å¼€åŒºé—´ï¼Œé€šè¿‡ACKå’Œsackå‘é€æ–¹å°±èƒ½å¾ˆå¿«çš„ç¡®å®šæ¥æ”¶æ–¹æœ‰å“ªäº›æ•°æ®æ²¡æœ‰è¢«æ”¶åˆ° å¦‚æœä¸Šé¢è§¦å‘äº†é‡ä¼ ä¼šè¿™æ ·å¤„ç†\nç›´æ¥é‡ä¼ 300 -499ä¸¢å¤±çš„å—ï¼Œç„¶åæŠŠackå˜æˆ700å†æ¬¡è§¦å‘å¿«é€Ÿé‡ä¼ æŠŠ700 -899è¡¥ä¸Š\nDACK ä¸»è¦æ˜¯å‘Šè¯‰å‘é€æ–¹ï¼Œä¸»è¦é€šè¿‡SACKå‘Šè¯‰å‘é€æ–¹æœ‰å“ªäº›æ•°æ®è¢«é‡å¤æ¥å—äº†\nACK ä¸¢åŒ…\næ¥æ”¶æ–¹å‘é€ç»™å‘é€æ–¹çš„2ä¸ªackéƒ½ä¸¢å¤±äº†ï¼Œæ‰€ä»¥å‘é€æ–¹è¶…æ—¶åï¼Œé‡ä¼ äº†ç¬¬ä¸€ä¸ªæ•°æ®åŒ…3000 - 3499\næ¥æ”¶æ–¹å‘ç°æ•°æ®æ˜¯æ”¶åˆ°çš„æ˜¯é‡å¤æ•°æ®ï¼Œäºæ˜¯å›äº†ä¸€ä¸ªsack= 3000 - 3500 å‘Šè¯‰å‘é€æ–¹3000 - 3500çš„\næ•°æ®æ—©å°±è¢«æ¥å—äº†ï¼Œå› ä¸ºç°åœ¨ackå·²ç»åˆ°äº†4000 æ‰€ä»¥æ„å‘³ç€è¿™ä¸ªsackä»£è¡¨çš„æ˜¯dack\nè¿™æ ·å‘é€æ–¹å°±çŸ¥é“äº†æ•°æ®å…¶å®æ²¡æœ‰ä¸¢ï¼Œåªæ˜¯æ¥æ”¶æ–¹çš„ackç¡®è®¤æŠ¥æ–‡ä¸¢å¤±äº†\nç½‘ç»œå»¶è¿Ÿ\næ•°æ®åŒ… 1000- 1499 è¢«ç½‘ç»œå»¶è¿Ÿäº†ï¼Œå¯¼è‡´å‘é€æ–¹æ²¡æœ‰æ”¶åˆ°ack1500çš„ç¡®è®¤æŠ¥æ–‡\nè€Œåé¢æ”¶åˆ°äº†3ä¸ªç›¸åŒçš„ackæŠ¥æ–‡ï¼Œè§¦å‘äº†å¿«é€Ÿé‡ä¼ ï¼Œä½†æ˜¯åœ¨é‡ä¼ ä»¥åï¼Œç½‘ç»œå»¶è¿Ÿçš„1000 -1499ä¹ŸæŠµè¾¾äº†æ¥æ”¶æ–¹\næ‰€ä»¥æ¥æ”¶æ–¹å›äº†ä¸€ä¸ªack3000 å’Œsack 1000 -1500 æ‰€ä»¥è¿™ä¸ªæ—¶å€™sackä»£è¡¨çš„å°±æ˜¯dackï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé‡å¤çš„æŠ¥æ–‡\nè¿™æ ·å‘é€æ–¹å°±çŸ¥é“å¿«é€Ÿé‡ä¼ çš„åŸå› ä¸æ˜¯å‘æ•°æ®ä¸¢äº†ï¼Œä¹Ÿä¸æ˜¯ackä¸¢äº†ï¼Œåªæ˜¯ç½‘ç»œå»¶è¿Ÿäº†\nå¯è§dackæœ‰è¿™ä¹ˆå‡ ä¸ªå¥½å¤„\nå¯ä»¥è®©å‘é€æ–¹çŸ¥é“æ˜¯åŒ…ä¸¢äº† è¿˜æ˜¯æ¥æ”¶æ–¹çš„ackä¸¢äº† è¿˜æ˜¯å‘é€æ–¹çš„æ•°æ®åŒ…è¢«ç½‘ç»œå»¶è¿Ÿäº† å¯ä»¥çŸ¥é“ç½‘ç»œä¸­æ˜¯ä¸æ˜¯æŠŠå‘é€æ–¹çš„æ•°æ®åŒ…ç»™å¤åˆ¶äº† æ»‘åŠ¨çª—å£ æˆ‘ä»¬çŸ¥é“TCPæ¯å‘é€ä¸€ä¸ªæ•°æ®ï¼Œå°±ä¼šè¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ï¼Œå½“ä¸Šä¸€ä¸ªæ•°æ®åŒ…æ”¶åˆ°äº†åº”ç­”ï¼Œåœ¨å‘é€ä¸‹ä¸€ä¸ªï¼Œè¿™ä¸ªæ¨¡å¼æœ‰ç‚¹åƒ\nä¸¤ä¸ªäººèŠå¤©ï¼Œä½ å‘ä¸€å¥ï¼Œç„¶åæˆ‘ç»™ä½ ä¸ªackæŠ¥æ–‡ï¼Œæˆ‘å‘ä¸€å¥ï¼Œç„¶åä½ ç»™æˆ‘ä¸€ä¸ªackæŠ¥æ–‡ï¼Œè¿™æ ·å…¶å®æ•ˆç‡å¾ˆä½çš„ã€‚\nå¦‚æœä½ è¯´å®Œä¸€å¥è¯ï¼Œæˆ‘åœ¨å¤„ç†åˆ«çš„äº‹æƒ…ï¼Œæ²¡æœ‰åŠæ—¶ç»™ä½ å›å¤ackæŠ¥æ–‡ï¼Œé‚£ä¹ˆä½ å°±åªèƒ½å¹²ç­‰ç€ï¼Œä¸€ç›´ç­‰åˆ°æˆ‘å¤„ç†å®Œäº‹æƒ…ï¼Œ\tç„¶åç»™ä½ å›å¤ackç ï¼Œè¿™æ ·å¤„ç†çš„è¯æ•ˆç‡å¤ªä½äº†ï¼Œå¦‚æœæ˜¯è¿™ä¸ªé€»è¾‘ï¼Œé‚£ä¹ˆtcpåè®®ä¹Ÿå°±ä¸ç”¨åœ¨å®Œäº†\næ‰€ä»¥è¿™æ ·çš„ä¼ è¾“æ–¹å¼å¾ˆå¤§çš„å¼Šç«¯ï¼šå°±æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿ï¼Œç½‘ç»œçš„ååå°±è¶Šå¤§\nä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼ŒTCPå‘æ˜äº†ä¸€ä¸ªç‰›é€¼çš„æ¦‚å¿µï¼š****æ»‘åŠ¨çª—å£\nå¦‚æœæœ‰äº†æ»‘åŠ¨çª—å£ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŒ‡å®šçª—å£çš„å¤§å°ï¼Œçª—å£çš„å¤§å°æ— éœ€ç­‰å¾…å¯¹æ–¹çš„ç¡®è®¤åº”ç­”ï¼Œå°±å¯ä»¥ç»§ç»­å‘é€æ•°æ®çš„æœ€å¤§å€¼\nä¸Šé¢ack300 å³ä½¿ä¸¢äº†ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬æ”¶åˆ°äº†ack400 é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸º400ä¹‹å‰çš„æ•°æ®éƒ½æ”¶åˆ°äº†ï¼Œè¿™ç§æ–¹å¼æˆ‘ä»¬ç§°ä¸ºç´¯è®¡ç¡®è®¤\nçª—å£å¤§å°ç”±å“ªä¸€æ–¹å†³å®š tcpå¤´é‡Œé¢æœ‰ä¸ªå­—æ®µå«window ä¹Ÿå°±æ˜¯çª—å£å¤§å°\nè¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥å—æ•°æ®ï¼Œäºæ˜¯å‘é€æ–¹å°±é è¿™ä¸ªå­—æ®µæ¥çŸ¥é“æ¥æ”¶æ–¹èƒ½æ¥æ”¶å¤šå°‘æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶æ–¹æ¥æ”¶ä¸è¿‡æ¥\næ‰€ä»¥çª—å£çš„å¤§å°ï¼Œä¸€èˆ¬ç”±æ¥æ”¶æ–¹çª—å£çš„å¤§å°æ¥å†³å®š\nå‘é€æ–¹ï¼Œå‘é€çš„æ•°æ®ä¸èƒ½è¶…è¿‡æ¥æ”¶æ–¹çª—å£çš„å¤§å°ï¼Œå¦åˆ™æ¥æ”¶æ–¹å°±æ— æ³•æ¥å—æ•°æ®\nå‘é€çª—å£ SND.WND : è¡¨ç¤ºå‘é€çª—å£çš„å¤§å°,ç”±æ¥æ”¶çª—å£æ§åˆ¶\nSND.UNA : è¡¨ç¤ºå·²å‘é€ä½†æœªç¡®è®¤ackæŠ¥æ–‡çš„ç©ºé—´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä½ç½®\nSND.NET : è¡¨ç¤ºæœªå‘é€ä½†æ˜¯è¿˜åœ¨æ¥æ”¶çª—å£å¯å¤„ç†ç©ºé—´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä½ç½®\nå¯ç”¨çª—å£å¤§å° = SND.WND - (SND.NXT - SND.UNA)\nå‘é€ç«¯çª—å£å¤§å°æ€ä¹ˆæ§åˆ¶çš„ å–å†³äºæ¥æ”¶ç«¯çš„å¤§å°[rwnd]å’Œæ‹¥å¡çª—å£[cwnd]çš„å¤§å°\nå‘é€çª—å£ = min{rwnd,cwnd}\næ¥æ”¶çª—å£ RCV.NXT : å¸Œæœ›ä»å‘é€æ–¹å‘è¿‡æ¥çš„ä¸‹ä¸€ä¸ªå­—èŠ‚æ•°æ®çš„åºåˆ—å·\nRCV.WND : æ¥æ”¶çª—å£çš„å¤§å°ï¼Œä¼šé€šè¿‡tcpå¤´éƒ¨æŠ¥æ–‡é‡Œé¢çš„windowå­—æ®µï¼Œé€šçŸ¥å‘é€çª—å£å¤§å°\næ¥æ”¶çª—å£å¤§å°æ€ä¹ˆæ§åˆ¶çš„ æ¥æ”¶çª—å£çš„å¤§å°ç³»ç»Ÿï¼Œç½‘é€Ÿï¼Œæœªå¤„ç†æ•°æ®çš„å¤§å°éƒ½æœ‰å…³ç³»\nå‘é€çª—å£å¤§å°å’Œæ¥æ”¶çª—å£å¤§å°ä¸€æ ·å— ä¸å®Œå…¨ç›¸ç­‰ï¼Œä¸€èˆ¬æ¥æ”¶çª—å£ç•¥ç­‰äºå‘é€çª—å£\næµé‡æ§åˆ¶ å‘é€æ–¹ä¸æ˜¯æ— è„‘çš„ä¸€ç›´å‘é€æ•°æ®ç»™æ¥æ”¶æ–¹çš„ï¼Œä¹Ÿè¦è€ƒè™‘æ¥æ”¶æ–¹çš„æ¥æ”¶èƒ½åŠ›ã€‚\nå¦‚æœä¸€ç›´æ— è„‘çš„å‘æ•°æ®ç»™å¯¹æ–¹ï¼Œä½†å¯¹æ–¹å¤„ç†ä¸è¿‡æ¥ï¼Œå°±ä¼šè§¦å‘é‡ä¼ æœºåˆ¶ï¼Œä»è€Œå¯¼è‡´ç½‘ç»œæµé‡çš„æ— ç«¯æµªè´¹\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†æµé‡æ§åˆ¶\nå›ºå®šçª—å£å¤§å°åœºæ™¯ å‡è®¾æ¥æ”¶ç«¯å’Œå‘é€ç«¯çª—å£ç›¸åŒï¼Œéƒ½ä¸º200 å‡è®¾ä¸¤ä¸ªè®¾å¤‡åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éƒ½ä¿è¯çª—å£å¤§å°ä¸å˜ï¼Œä¸æ”¶å¤–ç•Œå½±å“ åŠ¨æ€å˜åŒ–çª—å£å¤§å°åœºæ™¯ å½“å‘é€æ–¹å˜æˆçª—å£å˜æˆ0çš„æ—¶å€™å…¶å®å‘é€æ–¹è¿˜ä¼šå®šæ—¶çš„å‘é€æ¢æµ‹æŠ¥æ–‡ï¼Œä»¥ä¾¿çŸ¥é“æ¥æ”¶æ–¹æ”¹å˜äº†çª—å£\nä¸¢åŒ…æƒ…å†µ å½“æœåŠ¡ç«¯ç³»ç»Ÿèµ„æºâ¾®å¸¸ç´§å¼ çš„æ—¶å€™ï¼Œæ“â¼¼ç³»ç»Ÿå¯èƒ½ä¼šç›´æ¥å‡å°‘äº†æ¥æ”¶ç¼“å†²åŒºâ¼¤â¼©ï¼Œè¿™æ—¶åº”â½¤ç¨‹åºâ¼œâ½†æ³•åŠæ—¶è¯»å–ç¼“ å­˜æ•°æ®ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±æœ‰ä¸¥á¯¿çš„äº‹æƒ…å‘â½£äº†ï¼Œä¼šå‡ºç°æ•°æ®åŒ…ä¸¢å¤±çš„ç°è±¡ã€‚\nä¸ºäº†é¿å…è¿™ç§æƒ…å†µ TCPè§„å®šä¸å…è®¸ç³»ç»Ÿæ”¶ç¼©ç¼“å­˜çš„æ—¶å€™åŒæ—¶å‡å°‘çª—å£å¤§å°ï¼Œè€Œæ˜¯é‡‡ç”¨å…ˆæ”¶ç¼©çª—å£ï¼Œè¿‡æ®µæ—¶é—´åœ¨å‡å°‘ç¼“å­˜çš„åŠæ³•\nçª—å£å…³é—­æ­»é”é—®é¢˜ å¦‚æœè§£å†³è¿™ç§æ­»é”é—®é¢˜ ä¸ºäº†è§£å†³è¿™ç§æ­»é”é—®é¢˜ï¼ŒTCPä¸ºæ¯ä¸ªè¿æ¥è®¾æœ‰ä¸ä¸€ä¸ªæŒç»­å®šæ—¶å™¨å¦‚æœå®šæ—¶å™¨è¶…æ—¶å°±ä¼šå‘é€çª—å£æ¢æµ‹æŠ¥æ–‡\nå¦‚æœæ¥æ”¶çª—â¼ä»ç„¶ä¸º 0ï¼Œé‚£ä¹ˆæ”¶åˆ°è¿™ä¸ªæŠ¥â½‚çš„â¼€â½…å°±ä¼šá¯¿æ–°å¯åŠ¨æŒç»­è®¡æ—¶å™¨ï¼› å¦‚æœæ¥æ”¶çª—â¼ä¸æ˜¯ 0ï¼Œé‚£ä¹ˆæ­»é”çš„å±€â¾¯å°±å¯ä»¥è¢«æ‰“ç ´äº†ã€‚ çª—â¼æ¢æµ‹çš„æ¬¡æ•°â¼€èˆ¬ä¸º 3 æ¬¡ï¼Œæ¯æ¬¡â¼¤çº¦ 30-60 ç§’ï¼ˆä¸åŒçš„å®ç°å¯èƒ½ä¼šä¸â¼€æ ·ï¼‰ã€‚å¦‚æœ 3 æ¬¡è¿‡åæ¥æ”¶çª—â¼è¿˜æ˜¯ 0 çš„ è¯ï¼Œæœ‰çš„ TCP å®ç°å°±ä¼šå‘ RST æŠ¥â½‚æ¥ä¸­æ–­è¿æ¥ã€‚\nç³Šæ¶‚çª—å£ç»¼åˆç—‡ äºæ˜¯ï¼Œè¦è§£å†³ç³Šæ¶‚çª—â¼ç»¼åˆç—‡ï¼Œå°±è§£å†³ä¸Šâ¾¯ä¸¤ä¸ªé—®é¢˜å°±å¯ä»¥äº†\nè®©æ¥æ”¶â½…ä¸é€šå‘Šâ¼©çª—â¼ç»™å‘é€â½… è®©å‘é€â½…é¿å…å‘é€â¼©æ•°æ® æ€ä¹ˆè®©æ¥æ”¶â½…ä¸é€šå‘Šâ¼©çª—â¼å‘¢ï¼Ÿ\næ¥æ”¶â½…é€šå¸¸çš„ç­–ç•¥\nå½“ã€Œçª—â¼â¼¤â¼©ã€â¼©äº min( MSSï¼Œç¼“å­˜ç©ºé—´/2 ) ï¼Œä¹Ÿå°±æ˜¯â¼©äº MSS ä¸ 1/2 ç¼“å­˜â¼¤â¼©ä¸­çš„æœ€â¼©å€¼æ—¶ï¼Œå°±ä¼šå‘å‘é€â½…é€š å‘Šçª—â¼ä¸º 0 ï¼Œä¹Ÿå°±é˜»â½Œäº†å‘é€â½…å†å‘æ•°æ®è¿‡æ¥ã€‚ ç­‰åˆ°æ¥æ”¶â½…å¤„ç†äº†â¼€äº›æ•°æ®åï¼Œçª—â¼â¼¤â¼© \u0026gt;= MSSï¼Œæˆ–è€…æ¥æ”¶â½…ç¼“å­˜ç©ºé—´æœ‰â¼€åŠå¯ä»¥ä½¿â½¤ï¼Œå°±å¯ä»¥æŠŠçª—â¼æ‰“å¼€è®©å‘ é€â½…å‘é€æ•°æ®è¿‡æ¥ã€‚\næ€ä¹ˆè®©å‘é€â½…é¿å…å‘é€â¼©æ•°æ®å‘¢ï¼Ÿ\nå‘é€æ–¹ç­–ç•¥\nä½¿â½¤ Nagle ç®—æ³•ï¼Œè¯¥ç®—æ³•çš„æ€è·¯æ˜¯å»¶æ—¶å¤„ç†ï¼Œå®ƒæ»¡â¾œä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸­çš„â¼€æ¡æ‰å¯ä»¥å‘é€æ•°æ®ï¼š\nè¦ç­‰åˆ°çª—â¼â¼¤â¼© \u0026gt;= MSS æˆ–æ˜¯ æ•°æ®â¼¤â¼© \u0026gt;= MSS æ”¶åˆ°ä¹‹å‰å‘é€æ•°æ®çš„ ack å›åŒ… æ‹¥å¡æ§åˆ¶ å‰é¢çš„æµé‡æ§åˆ¶ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å‘é€æ–¹åˆ°æ¥æ”¶æ–¹çš„ç¼“å­˜ï¼Œä½†æ˜¯ä¸çŸ¥é“ç½‘ç»œä¸­å‘ç”Ÿäº†ä»€ä¹ˆ\nä¸€èˆ¬æ¥è¯´ï¼Œè®¡ç®—æœºç½‘ç»œæ˜¯ä¸ªå…±äº«çš„ç¯å¢ƒï¼Œå› æ­¤ä¹Ÿæœ‰å¯èƒ½ä¼šå› ä¸ºå…¶ä»–ä¸»æœºä¹‹é—´çš„é€šä¿¡ï¼Œè€Œæ˜¯ç½‘ç»œå µå¡\nå¦‚æœåœ¨ç½‘ç»œå µå¡çš„æ—¶å€™ç»§ç»­å‘é€å¤§é‡çš„æ•°æ®åŒ…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å¯¼è‡´æ•°æ®åŒ…çš„æ—¶å»¶ï¼Œä¸¢å¤±ç­‰ï¼Œè¿™ä¸ªæ—¶å€™tcpå°±ä¼šé‡ä¼ æ•°æ®ï¼Œä½†æ˜¯ä¸€é‡ä¼ ï¼Œå°±ä¼šå¯¼è‡´ç½‘ç»œçš„è´Ÿæ‹…æ›´é‡ï¼Œäºæ˜¯å°±ä¼šå¯¼è‡´æ›´å¤§çš„å»¶è¿Ÿå’Œä¸¢åŒ…ï¼Œç”šè‡³è¿›å…¥æ¶æ€§å¾ªç¯\näºæ˜¯ç°åœ¨å°±æœ‰äº†æ‹¥å¡æ§åˆ¶æ‰‹æ®µï¼Œè¿™ä¸ªæ‰‹æ®µä¸»è¦æ§åˆ¶çš„æ˜¯æ§åˆ¶å‘é€æ–¹æ•°æ®å……æ»¡ç½‘ç»œ\nä¸ºäº†è®©å‘é€æ–¹æ§åˆ¶å‘é€æ•°æ®çš„é‡ï¼Œäºæ˜¯å°±æœ‰äº†æ‹¥å¡çª—å£çš„æ¦‚å¿µ\næ‹¥å¡çª—å£å’Œå‘é€çª—å£çš„å…³ç³» æ‹¥å¡çª—å£cwndæ˜¯å‘é€æ–¹ç»´æŠ¤çš„ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œä»–ä¼šæ ¹æ®ç½‘ç»œåŠ¨æ€å˜åŒ–\nå‰é¢æˆ‘ä»¬æåˆ°çš„swndå’Œrwndæ˜¯çº¦ç­‰äºçš„å…³ç³»ï¼Œé‚£ä¹ˆå‡å¦‚cwndæ¦‚å¿µä»¥åï¼Œæ­¤æ—¶å‘é€çª—å£çš„å€¼æ˜¯\nswnd = min(cwnd,rwnd)\næ‹¥å¡çª—å£çš„å˜åŒ–è§„åˆ™ åªè¦ç½‘ç»œä¸­æ²¡æœ‰å µå¡ï¼Œé‚£ä¹ˆå°±åŠ å¤§cwndçš„æ•°å€¼ å¦‚æœç½‘ç»œä¸­å‡ºç°äº†æ‹¥å¡ï¼Œcwndå°±å‡å°‘ æ€ä¹ˆçŸ¥é“å½“å‰ç½‘ç»œå‡ºç°äº†æ‹¥å¡ åªè¦å‘é€æ–¹åœ¨æ²¡æœ‰è§„å®šçš„æ—¶é—´å†…æ¥å—åˆ°ackç¡®è®¤ç ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œå°±è®¤ä¸ºç½‘ç»œä¸­å‡ºç°äº†æ‹¥å¡\næ‹¥å¡æ§åˆ¶æœ‰å“ªäº›ç®—æ³• æ…¢å¯åŠ¨ æ‹¥å¡é¿å… æ‹¥å¡å‘ç”Ÿ å¿«é€Ÿæ¢å¤ æ…¢å¯åŠ¨ æ…¢å¯åŠ¨çš„ç®—æ³•å°±æ˜¯ï¼Œå½“å‘é€æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªackï¼Œæ‹¥å¡çª—å£cwndçš„å¤§å°å°±åŠ 1\né‚£ä¹ˆæ…¢å¯åŠ¨ä»€ä¹ˆæ—¶å€™æ˜¯ä¸ªå¤´å‘¢ï¼Œ\næœ‰ä¸€ä¸ªå«æ…¢å¯åŠ¨çš„é—¨é™ssthresh\nå½“ cwnd \u0026lt; ssthresh æ—¶ä½¿ç”¨æ…¢å¯åŠ¨\nå½“ cwnd \u0026gt;= sssthresh æ—¶å¯åŠ¨æ‹¥å¡é¿å…\næ‹¥å¡é¿å… å®ƒçš„è§„åˆ™æ˜¯ï¼šæ¯å½“æ”¶åˆ°â¼€ä¸ª ACK æ—¶ï¼Œcwnd å¢åŠ  1/cwnd\næ‹¥å¡é¿å…ç®—æ³•å°±æ˜¯å°†åŸæœ¬æ…¢å¯åŠ¨ç®—æ³•çš„æŒ‡æ•°å¢â»“å˜æˆäº†çº¿æ€§å¢â»“ï¼Œè¿˜æ˜¯å¢â»“é˜¶æ®µï¼Œä½†æ˜¯å¢â»“ é€Ÿåº¦ç¼“æ…¢äº†â¼€äº›ã€‚ å°±è¿™ä¹ˆâ¼€ç›´å¢â»“ç€åï¼Œâ½¹ç»œå°±ä¼šæ…¢æ…¢è¿›â¼Šäº†æ‹¥å¡çš„çŠ¶å†µäº†ï¼Œäºæ˜¯å°±ä¼šå‡ºç°ä¸¢åŒ…ç°è±¡ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹ä¸¢å¤±çš„æ•°æ®åŒ…è¿› â¾á¯¿ä¼ ã€‚ å½“è§¦å‘äº†á¯¿ä¼ æœºåˆ¶ï¼Œä¹Ÿå°±è¿›â¼Šäº†æ‹¥å¡å‘â½£ç®—æ³•\næ‹¥å¡å‘ç”Ÿ å…¶å®è¿™ä¸ªæ—¶å€™å°±æ˜¯å†™çš„tcpé‡ä¼ æœºåˆ¶ä¸»è¦æ˜¯ä¸¤ç§\nè¶…æ—¶é‡ä¼ \nå› ä¸ºæƒ³é€”ä¸­çš„cwndä»12çªç„¶å˜åˆ°äº†1ï¼Œç„¶åå¼€å§‹æ…¢å¯åŠ¨ï¼Œå¯ä»¥çœ‹åˆ°æ­¤ç§æ–¹æ³•å¾ˆå®¹æ˜“é©¬ä¸Šå›åˆ°è§£æ”¾å‰ï¼Œæ–¹æ³•ä¹Ÿå¾ˆæ¿€è¿›ï¼Œå®¹æ˜“é€ æˆç½‘ç»œå¡é¡¿ï¼Œé‚£ä¹ˆå‘ç”Ÿè¿™ç§æƒ…å†µæˆ‘ä»¬è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•å‘¢ï¼Œå…¶å®æœ‰çš„ä¹Ÿå°±æ˜¯å‰é¢å†™çš„å¿«é€Ÿé‡ä¼ \nåœ¨æ”¶åˆ°3æ¬¡ç›¸åŒçš„ackç çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨è¶…æ—¶é‡ä¼ è¿˜æ²¡å‘ç”Ÿä¹‹å‰å°±é‡ä¼ æ•°æ®è¿‡å»ï¼Œè€Œä¸å¿…ç­‰åˆ°è¶…æ—¶é‡ä¼ \nè¿™ä¸ªæ—¶å€™tcpè®¤ä¸ºè¿™ä¸­æƒ…å†µä¹Ÿä¸æ˜¯å¾ˆä¸¥é‡é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®å‚æ•°\ncwnd = cwnd/2 ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ä¸ºåŸæ¥çš„â¼€åŠ ssthresh = cwnd è¿›â¼Šå¿«é€Ÿæ¢å¤ç®—æ³• å¿«é€Ÿæ¢å¤ ç”±äºè¿›å…¥å¿«é€Ÿæ¢å¤ä¹‹å‰ cwndå’Œssthreshå·²ç»è¿›è¡Œäº†æ›´æ–°\ncwnd = cwnd/2 ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ä¸ºåŸæ¥çš„â¼€åŠ\nssthresh = cwnd\nå¿«é€Ÿæ¢å¤ç®—æ³•å¦‚ä¸‹\næ‹¥å¡çª—å£ cwnd = ssthresh + 3 3çš„æ„æ€ä»£è¡¨ç¡®è®¤æœ‰3ä¸ªæ•°æ®åŒ…å·²ç»æ”¶åˆ°äº† é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ… å¦‚æœåœ¨æ”¶åˆ°é‡å¤çš„æ•°æ®åŒ…é‚£ä¹ˆcwnd + 1 å¦‚æœæ”¶åˆ°æ–°æ•°æ®çš„ack é‚£ä¹ˆå§cwnd è®¾ç½®æˆç¬¬ä¸€ä¸ªä¸çš„ssthreshçš„å€¼ï¼ŒåŸå› æ˜¯è¯¥ackå·²ç»ç¡®è®¤äº†æ–°çš„æ•°æ®ï¼Œè¯´æ˜ä»dackæ—¶å€™çš„æ•°æ®å·²ç»éƒ½æ”¶åˆ°äº†ï¼Œè¯¥æ¢å¤è¿‡ç¨‹å·²ç»ç»“æŸï¼Œé‚£ä¹ˆå°±å¯ä»¥æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€äº†ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†æ¬¡è¿›å…¥æ‹¥å¡é¿å…çŠ¶æ€ ç²˜åŒ… ç²˜åŒ…çš„é—®é¢˜æ˜¯ä¸çŸ¥é“æ¶ˆæ¯çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Œå¦‚æœçŸ¥é“è¾¹ç•Œåœ¨å“ªé‡Œå°±å¥½åŠäº†ã€‚æ‰€ä»¥æœ‰å¦‚ä¸‹3ç§æ–¹æ³•è§£å†³\nå›ºå®šé•¿åº¦ å°±æ˜¯è§„å®šæ¯ä¸€ä¸ªåŒ…å›ºå®šçš„é•¿åº¦ï¼Œæ¯”å¦‚20KBï¼Œå½“æ”¶åˆ°äº†20KBçš„æ•°æ®æ»¡äº†ä¹‹åï¼Œå°±è®¤ä¸ºæ˜¯ä¸€ä¸ªåŒ…,ä½†æ˜¯è¿™ç§æ–¹æ³•çµæ´»æ€§ä¸é«˜ï¼Œç”¨çš„å¾ˆå°‘\nç‰¹æ®Šå­—ç¬¦åšè¾¹ç•Œ æ¯”å¦‚åƒHTTPè¿™ç§ç›´æ¥åœ¨å°¾éƒ¨åŠ å›è½¦ï¼Œæ¢è¡Œæ¥ä½œä¸ºæ•°æ®çš„è¾¹ç•Œï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœç‰¹æ®Šå­—ç¬¦æ˜¯å†…å®¹ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹è¿™ä¸ªæ•°æ®åšç‰¹æ®Šå¤„ç†\nè‡ªå®šä¹‰æ¶ˆæ¯ç»“æ„ æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰æ¶ˆæ¯ç»“æ„ï¼Œç”±åŒ…å¤´ + æ•°æ®ç»„æˆ åœ¨åŒ…å¤´é‡Œé¢æœ‰ä¸€ä¸ªå­—æ®µæ˜¯ç”¨æ¥è¡¨ç¤ºæ•°æ®åŒ…çš„å¤§å°çš„ï¼Œå¦‚ä¸‹:\nstruct { int32 message_length; char message_data[]; } message; è¿™æ ·å½“å®¢æœç«¯å¯ä»¥å…ˆè§£æåŒ…å¤´é‡Œé¢æ¶ˆæ¯çš„é•¿åº¦ï¼Œç„¶ååœ¨è¯»æ»¡è¿™ä¸ªé•¿åº¦å¤§å°çš„æ•°æ®ï¼Œå°±å¯ä»¥è®¤ä¸ºæ”¶åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„åŒ…\nRST æ ‡è¯† æ”¶åˆ°RSTåº”ç”¨å±‚å¤„ç†æƒ…å†µ å¦‚æœåº”ç”¨å±‚å°è¯•å»è¯»ï¼Œæ¯”å¦‚ recv åº”ç”¨å±‚å°±ä¼šæ”¶åˆ° Connection reset by peer æ„æ€æ˜¯è¿æ¥è¢«é‡ç½® å¦‚æœåº”ç”¨å±‚å°è¯•å»å†™ï¼Œæ¯”å¦‚ send åº”ç”¨å±‚å°±ä¼šæ”¶åˆ° Broken pipe æ„æ€æ˜¯è¿™ä¸ªé€šé“å·²ç»åäº† RSTå‡ºç°çš„åœºæ™¯ RST ä¸€èˆ¬å‡ºç°åœ¨å¼‚å¸¸æƒ…å†µï¼Œä¸€èˆ¬ä¸º å¯¹ç«¯çš„ç«¯å£ä¸å¯ç”¨å’Œ socket æå‰å…³é—­\nç«¯å£ä¸å¯ç”¨ ç«¯å£æœªç›‘å¬\næœåŠ¡å™¨ Listenæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª sockæ”¾å…¥å…¨å±€çš„ å“ˆå¸Œè¡¨ä¸­ï¼Œå½“å®¢æœç«¯æ¥è¿æ¥çš„æ—¶å€™ï¼Œä¼šæ ¹æ® ipå’Œ ç«¯å£ä»è¿™ä¸ª hashè¡¨ä¸­å»è·å– sock\nç«¯å£æœªç›‘å¬ä¸€å®šä¼šå‘é€ RSTå— ä¸ä¸€å®šå› ä¸ºåœ¨çŸ¥é“æœåŠ¡å™¨æ²¡æœ‰ listenè¿‡ï¼Œä¸ä¼šç«‹é©¬å‘é€ RSTæŠ¥æ–‡ï¼Œè€Œæ˜¯ä¼šè¿›è¡Œ æ ¡éªŒå’Œæ£€æŸ¥,åªæœ‰åœ¨æ ¡éªŒå’Œæ²¡æœ‰é—®é¢˜çš„æ—¶å€™æ‰ä¼šå‘ RSTç»™å¯¹ç«¯\næ ¡éªŒå’Œå¯ä»¥éªŒè¯æ•°æ®ä»ç«¯åˆ°ç«¯æ˜¯å¦å‡ºç°äº†å¼‚å¸¸ï¼Œç”±å‘é€ç«¯è®¡ç®—ï¼Œç„¶åæ¥æ”¶ç«¯æ•ˆéªŒï¼Œè®¡ç®—èŒƒå›´è¦†ç›–æ•°æ®åŒ…çš„ tcpé¦–éƒ¨å’Œ tcpæ•°æ®\nä¸ºä»€ä¹ˆä¸€å®šè¦å…ˆè¿›è¡Œæ•ˆéªŒå’Œï¼Œé€šè¿‡ä»¥åæ‰å‘é€RST ä¸€èˆ¬æ ¡éªŒå’Œå‡ºç°äº†é—®é¢˜è¿™ä¸ªæ—¶å€™ä¸€èˆ¬éƒ½æ˜¯åŒ…è¢«ç¯¡æ”¹äº†ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ•°æ®ç´Šä¹±ä¼ªé€ çš„åŒ…\nåœ¨ç½‘ç»œçš„5å±‚åè®®ä¸­ï¼Œå¦‚æœå‡ºç°è¿™ä¸­é—®é¢˜ï¼Œä¸€èˆ¬çš„åšæ³•éƒ½æ˜¯ä¸¢å¼ƒï¼Œè€Œä¸æ˜¯å‚»ä¹ä¹çš„æ¢å¤ä¸€ä¸ªåŒ…ç»™å¯¹æ–¹\nå¦‚æœæ˜¯ TCPåè®®ï¼Œå› ä¸ºæ˜¯å¯é çš„ï¼Œæ‰€ä»¥ä¸¢äº†ä¹Ÿæ²¡æœ‰äº‹æƒ…ï¼Œå½“æ²¡æœ‰æ¥åˆ°å¯¹ç«¯çš„ ACKçš„æ—¶å€™ï¼Œä¼šé‡ä¼ \nå¦‚æœæ˜¯ UDPåè®®ï¼Œå› ä¸ºæ˜¯ä¸å¯é ä¼ è¾“çš„ï¼Œæ¥æ”¶ç«¯å·²ç»æ¥æ”¶äº†ä¸å¯é çš„è¿™ä¸­æƒ…å†µï¼Œé‚£ä¹ˆä¸¢äº†å°±ä¸¢äº†\nç¨‹åºå¯åŠ¨äº†ä½†æ˜¯å´©äº† è¿™ä¸ªå’Œç«¯å£æœªç›‘å¬å·®ä¸å¤šï¼Œå› ä¸ºç¨‹åºå´©äº†ï¼Œèµ„æºå°±ä¼šé‡Šæ”¾ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ CloseçŠ¶æ€ï¼Œé‡å¯äº†ä»¥åï¼Œå®¢æœç«¯æ–°çš„è¿æ¥è¿›æ¥çš„æ—¶å€™å»å…¨å±€çš„ hashè¡¨æ ¹æ® IPåœ°å€å’Œ ç«¯å£æŸ¥æ‰¾ï¼Œå´æ‰¾ä¸åˆ° Sockè¿™ä¸ªæ—¶å€™å¦‚æœæ ¡éªŒå’Œé€šè¿‡äº†ï¼Œé‚£ä¹ˆä¹Ÿä¼šå‘é€ RSTæŠ¥æ–‡è¿‡å»\nsocketæå‰å…³é—­ æœ¬ç«¯æå‰å…³é—­ å¦‚æœæœ¬ç«¯ socketæ¥æ”¶ç¼“å†²åŒºè¿˜æœ‰æ•°æ®ï¼Œæ­¤æ—¶æå‰ close() socket é‚£ä¹ˆæœ¬ç«¯ä¼šå…ˆæŠŠæ¥ æ”¶ç¼“å†²åŒºçš„æ•°æ®æ¸…ç©ºï¼Œç„¶åç»™è¿œç«¯ä¸€ä¸ª RST\nè¿œç«¯æå‰å…³é—­ è¿œç«¯å·²ç» close()è¿™ä¸ªæ—¶å€™æœ¬åœ°è¿˜å°è¯•ç»™è¿œç«¯å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™è¿œç«¯ä¼šç»™æœ¬ç«¯å›ä¸€ä¸ª RST\nå¤§å®¶çŸ¥é“ï¼ŒTCPæ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œæ„æ€æ˜¯å‘é€æ•°æ®çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥æ¥æ”¶æ•°æ®ã€‚\nClose()çš„å«ä¹‰æ˜¯ï¼Œæ­¤æ—¶è¦åŒæ—¶å…³é—­å‘é€å’Œæ¥æ”¶æ¶ˆæ¯çš„åŠŸèƒ½ã€‚\nå®¢æˆ·ç«¯æ‰§è¡Œ close()ï¼Œ æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šå‘å‡ºç¬¬ä¸€æ¬¡æŒ¥æ‰‹FINï¼Œç„¶åæœåŠ¡ç«¯å›ç¬¬äºŒæ¬¡æŒ¥æ‰‹ ACKã€‚å¦‚æœåœ¨ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ä¹‹é—´ï¼Œå¦‚æœæœåŠ¡æ–¹è¿˜å°è¯•ä¼ æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸ä»…ä¸æ”¶è¿™ä¸ªæ¶ˆæ¯ï¼Œè¿˜ä¼šå‘ä¸€ä¸ª RSTæ¶ˆæ¯åˆ°æœåŠ¡ç«¯ã€‚ç›´æ¥ç»“æŸæ‰è¿™æ¬¡è¿æ¥ã€‚\nRSTåŒ…ä¸¢äº†æ€ä¹ˆåŠ RSTä¸¢äº†ï¼Œé—®é¢˜ä¸å¤§ï¼Œæ¯”å¦‚è¯´ä¸Šæ–¹çš„å›¾ï¼ŒæœåŠ¡å™¨å‘äº† RSTä¹‹åï¼Œå°±è®¤ä¸ºæœåŠ¡å™¨è¿æ¥ä¸å¯ç”¨äº†\nå¦‚æœå‘é€ RSTä¹‹å‰ï¼Œå®¢æœç«¯å‘é€äº†æ•°æ®ï¼Œå®¢æœç«¯æ²¡æœ‰ç­‰åˆ° ACKç¡®è®¤ç ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šé‡å‘ï¼Œé‡å‘çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šè¿”å› RSTåŒ…\nå¦‚æœåœ¨å‘é€ RSTä¹‹å‰ï¼Œå®¢æœç«¯æ²¡æœ‰å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå› ä¸ºæœ‰ keepalive æœºåˆ¶ï¼Œä¼šå®šæœŸå‘é€æ¢æ´»åŒ…ï¼Œè¿™ç§æ•°æ®åˆ°äº†æœåŠ¡å™¨ï¼Œå¯ä»¥è§¦å‘ä¸€ä¸ª RSTåŒ…\næ”¶åˆ°RSTä¸€å®šä¼šç«¯å¼€å— ä¸ä¸€å®šä¼šç«¯å¼€ï¼Œå› ä¸ºåœ¨æ”¶åˆ° RSTä¹‹åï¼Œä¼šè¿›è¡Œæ£€æŸ¥ seqæ˜¯å¦åˆæ³•ï¼Œå…¶å®ä¹Ÿæ˜¯çœ‹è¿™ä¸ª seqæ˜¯ä¸æ˜¯åœ¨åˆæ³•çš„æ¥æ”¶èŒƒå›´å†…ï¼Œå¦‚æœä¸åœ¨å°±ä¸¢å¼ƒè¿™ä¸ª RSTåŒ…\nè‡³äºè¿™ä¸ªæ¥æ”¶çª—å£æ˜¯å•¥ï¼Œå¦‚ä¸‹å›¾\nä¸ºä»€ä¹ˆä¸€å®šè¦æ ¡éªŒåœ¨èŒƒå›´å†… å› ä¸ºå¦‚æœä¸æ ¡éªŒçš„è¯ï¼Œä¸æ€€å¥½æ„çš„ç¬¬ä¸‰æ–¹ä¼ªé€ äº† seqçš„åŒ…ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè®©å®¢æœç«¯æˆ–è€…æœåŠ¡æ–­å¼€è¿æ¥ï¼Œå¦‚æœæ•ˆéªŒçš„è¯æ¯•ç«Ÿå› ä¸ºçª—å£æ˜¯åœ¨ä¸æ–­å˜åŒ–çš„ï¼Œseqä¹Ÿåœ¨ä¸æ–­çš„å˜åŒ–ï¼Œæ‰€ä»¥åœ¨èŒƒå›´å†…çš„ seqå¾ˆéš¾è¢«ä¼ªé€ å‡ºæ¥\nsocket recvå’Œsend æƒ…å†µ å¦‚æœæ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™close å¦‚æœæ¥æ”¶ç¼“å†²åŒºè¿˜æœ‰æ•°æ®æœªè¯»ï¼Œä¼šå…ˆæŠŠæ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®æ¸…ç©ºï¼Œç„¶åç»™å¯¹ç«¯å‘é€ä¸€ä¸ª RST\nå¦‚æœæ¥æ”¶ç¼“å­˜åŒºæ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±ä¼šå‘é€ FINï¼Œå¼€å§‹æ­£å¸¸çš„å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹\nå¦‚æœå‘é€ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™close socket æ˜¯ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™å†…æ ¸ä¼šæŠŠæœ€åä¸€å—æ•°æ®çš„æ ‡è¯†ç½®ä½ FINï¼Œç„¶åå®‰é™çš„ç­‰å¾…å†…æ ¸æŠŠæ•°æ®éƒ½å‘å‡ºå»\nUDP udpæœ‰å‘é€ç¼“å†²åŒºå— udpä¹Ÿæ˜¯socketï¼Œ åªè¦æ˜¯socketå°±ä¼šæœ‰å‘å’Œæ”¶ä¸¤ä¸ªç¼“å†²åŒºï¼Œå’Œä»€ä¹ˆåè®®æ— å…³\nudpç”¨å‘é€ç¼“å†²åŒºå— ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¼šæŠŠæ•°æ®æ‹·è´åˆ°å‘é€ç¼“å­˜åŒºåç›´æ¥å‘é€\nä¸€äº›ç½‘ç»œå¼‚å¸¸å›ç­” åœ¨æ²¡æœ‰å¼€å¯ TCP keepaliveï¼Œä¸”åŒæ–¹ä¸€ç›´æ²¡æœ‰æ•°æ®äº¤äº’çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯çš„ã€Œä¸»æœºå´©æºƒã€äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚ å³ä½¿æ²¡æœ‰å¼€å¯ TCP keepaliveï¼Œä¸”åŒæ–¹ä¹Ÿæ²¡æœ‰æ•°æ®äº¤äº’çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå…¶ä¸­ä¸€æ–¹çš„è¿›ç¨‹å‘ç”Ÿäº†å´©æºƒï¼Œè¿™ä¸ªè¿‡ç¨‹æ“ä½œç³»ç»Ÿæ˜¯å¯ä»¥æ„ŸçŸ¥çš„åˆ°çš„ï¼Œäºæ˜¯å°±ä¼šå‘é€ FIN æŠ¥æ–‡ç»™å¯¹æ–¹ï¼Œç„¶åä¸å¯¹æ–¹è¿›è¡Œ TCP å››æ¬¡æŒ¥æ‰‹\nå¦‚æœæœ‰æ•°æ®ä¼ è¾“ï¼Œé‚£ä¹ˆå°±çš„åˆ†ä¸¤ç§æƒ…å†µ\nå®¢æˆ·ç«¯å®•æœºï¼Œç„¶åç«‹é©¬é‡å¯ã€‚\nåœ¨å®¢æˆ·å®•æœºçš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¸€ç›´æ¥ä¸åˆ° ACKç¡®è®¤ç ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè§¦å‘é‡ä¼ \nå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è¿›ç¨‹ç›‘å¬è¿™ä¸ª TCPæŠ¥æ–‡çš„ç›®æ ‡ç«¯å£å·ï¼Œç”±äºæ‰¾ä¸åˆ°ç›®æ ‡ç«¯å£å·ï¼Œé‚£ä¹ˆå®¢æœç«¯å°±ä¼šå‘é€ RSTåŒ…ï¼Œé‡ç½®æ”¹è¿æ¥\nå¦‚æœå®¢æˆ·ç«¯æœ‰è¿›ç¨‹ç›‘å¬è¿™ä¸ª TCPæŠ¥æ–‡ï¼Œè¿™ä¸ªæ—¶å€™é‡å¯ï¼Œä¹‹å‰çš„ TCPè¿æ¥çš„ socketç»“æ„ä½“æ•°æ®éƒ½ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯æ‰¾ä¸åˆ°è¯¥ TCPç›¸å…³çš„ socketæ•°æ®ï¼Œä¹Ÿä¼šå‘é€ RSTåŒ…\nå®¢æˆ·ç«¯å®•æœºï¼Œä¸€ç›´æ²¡æœ‰é‡å¯\næœåŠ¡å™¨å°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ æŠ¥æ–‡æœºåˆ¶ï¼Œä¸€èˆ¬ 15æ¬¡ï¼Œä¸è¿‡ tcpè¶…æ—¶é‡ä¼ ä¸æ­¢åŸºäº 15æ¬¡åˆ¤æ–­ï¼Œè¿˜ä¼šåŸºäºæœ€å¤§è¶…æ—¶æ—¶é—´æ¥åˆ¤å®šï¼Œä¹Ÿå°±æ˜¯å…ˆè¾¾åˆ°æœ€å¤§è¶…ä¼ æ¬¡æ•°æˆ–è€…æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œå°±ä¼šåˆ¤å®š TCPæœ‰é—®é¢˜ï¼Œå°±ä¼šåœæ­¢é‡ä¼ \n","permalink":"https://frog-game.github.io/posts/read/wangluozongjie/","summary":"tcp æ¡æ‰‹æŒ¥æ‰‹ åºåˆ—å·: åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™æœ‰è®¡ç®—æœºç”Ÿæˆçš„éšæœºæ•°å¹¶ä½œä¸ºåˆå§‹å€¼ï¼Œé€šè¿‡synåŒ…ä¼ ç»™æ¥æ”¶ç«¯ä¸»æœºï¼Œæ¯å‘ä¸€æ¬¡æ•°æ®ï¼Œå°±ç´¯åŠ ä¸€æ¬¡è¯¥æ•°æ®å­—èŠ‚æ•°çš„å¤§å°ï¼Œ","title":"ç½‘ç»œåº•å±‚æ€»ç»“"},{"content":" frog\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ åç§°ï¼š frog\u0026rsquo;s Blog ç½‘å€ï¼š https://frog-game.github.io/ æè¿° ä¸€ä¸ªè®°å½•ç”Ÿæ´»ï¼ŒæŠ€æœ¯çš„åšå®¢ ","permalink":"https://frog-game.github.io/links/","summary":"frog\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ åç§°ï¼š frog\u0026rsquo;s Blog ç½‘å€ï¼š https://frog-game.github.io/ æè¿° ä¸€ä¸ªè®°å½•ç”Ÿæ´»ï¼ŒæŠ€æœ¯çš„åšå®¢","title":"ğŸ¤å‹é“¾"},{"content":"å…³äºæˆ‘\nè‹±æ–‡å: frog èŒä¸š: ç å†œ è¿åŠ¨: è·‘æ­¥ã€ä¹’ä¹“çƒã€çˆ¬å±± ","permalink":"https://frog-game.github.io/about/","summary":"å…³äºæˆ‘ è‹±æ–‡å: frog èŒä¸š: ç å†œ è¿åŠ¨: è·‘æ­¥ã€ä¹’ä¹“çƒã€çˆ¬å±±","title":"ğŸ™‹ğŸ»â€â™‚ï¸å…³äº"}]